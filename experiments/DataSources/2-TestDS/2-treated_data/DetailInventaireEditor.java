package org.imogene.epicam.client.ui.editor ; public class DetailInventaireEditor extends Composite implements Editor<DetailInventaireProxy>, HasEditorDelegate<DetailInventaireProxy>, HasEditorErrors<DetailInventaireProxy> { interface Binder extends UiBinder<Widget, DetailInventaireEditor> { }  private static final Binder BINDER = GWT.create(Binder.class) ;  protected final EpicamRequestFactory requestFactory ;  private List<HandlerRegistration> registrations = new ArrayList<HandlerRegistration>() ;  private EditorDelegate<DetailInventaireProxy> delegate ;  private DetailInventaireProxy editedValue ;  //Not used by the editor private boolean hideButtons = false ;  @UiField @Ignore FieldGroupPanel descriptionSection ;  @UiField(provided = true) ImogSingleRelationBox<InventaireProxy> inventaire ;  private InventaireDataProvider inventaireDataProvider ;  @UiField(provided = true) ImogSingleRelationBox<CentreDiagTraitProxy> CDT ;  private CentreDiagTraitDataProvider cDTDataProvider ;  @UiField(provided = true) ImogSingleRelationBox<LotProxy> lot ;  private LotDataProvider lotDataProvider ;  @UiField ImogIntegerBox quantiteReelle ;  @UiField ImogIntegerBox quantiteTheorique ;  * Constructor * @param factory the application request factory * @param hideButtons true if the relation field buttons shall be hidden public DetailInventaireEditor(EpicamRequestFactory factory, boolean hideButtons) { this.requestFactory = factory ;  this.hideButtons = hideButtons ;  setRelationFields() ;  initWidget(BINDER.createAndBindUi(this)) ;  properties() ;  }  * Constructor * @param factory the application request factory public DetailInventaireEditor(EpicamRequestFactory factory) { this(factory, false) ;  }  * Sets the properties of the fields private void properties() { descriptionSection.setGroupTitle(NLS.constants() .detailInventaire_group_description()) ;  inventaire .setLabel(NLS.constants().detailInventaire_field_inventaire()) ;  // hidden field inventaire.setVisible(false) ;  CDT.setLabel(NLS.constants().detailInventaire_field_cDT()) ;  // the value of CDT affects the value of other fields CDT.notifyChanges(requestFactory.getEventBus()) ;  // hidden field CDT.setVisible(false) ;  lot.setLabel(NLS.constants().detailInventaire_field_lot()) ;  quantiteReelle.setLabel(NLS.constants() .detailInventaire_field_quantiteReelle()) ;  quantiteTheorique.setLabel(NLS.constants() .detailInventaire_field_quantiteTheorique()) ;  }  * Configures the widgets that manage relation fields private void setRelationFields() { inventaireDataProvider = new InventaireDataProvider(requestFactory) ;  if (hideButtons) // in popup, relation buttons hidden inventaire = new ImogSingleRelationBox<InventaireProxy>( inventaireDataProvider, EpicamRenderer.get(), true) ;  else {// in wrapper panel, relation buttons enabled  if (AccessManager.canCreateInventaire() && AccessManager.canEditInventaire()) inventaire = new ImogSingleRelationBox<InventaireProxy>( inventaireDataProvider, EpicamRenderer.get()) ;  else inventaire = new ImogSingleRelationBox<InventaireProxy>(false, inventaireDataProvider, EpicamRenderer.get()) ;  }  cDTDataProvider = new CentreDiagTraitDataProvider(requestFactory) ;  if (hideButtons) // in popup, relation buttons hidden CDT = new ImogSingleRelationBox<CentreDiagTraitProxy>( cDTDataProvider, EpicamRenderer.get(), true) ;  else {// in wrapper panel, relation buttons enabled  if (AccessManager.canCreateCentreDiagTrait() && AccessManager.canEditCentreDiagTrait()) CDT = new ImogSingleRelationBox<CentreDiagTraitProxy>( cDTDataProvider, EpicamRenderer.get()) ;  else CDT = new ImogSingleRelationBox<CentreDiagTraitProxy>(false, cDTDataProvider, EpicamRenderer.get()) ;  }  lotDataProvider = new LotDataProvider(requestFactory) ;  if (hideButtons) // in popup, relation buttons hidden lot = new ImogSingleRelationBox<LotProxy>(lotDataProvider, EpicamRenderer.get(), true) ;  else {// in wrapper panel, relation buttons enabled  if (AccessManager.canCreateLot() && AccessManager.canEditLot()) lot = new ImogSingleRelationBox<LotProxy>(lotDataProvider, EpicamRenderer.get()) ;  else lot = new ImogSingleRelationBox<LotProxy>(false, lotDataProvider, EpicamRenderer.get()) ;  }  }  * Sets the edition mode * @param isEdited true to enable the edition of the form public void setEdited(boolean isEdited) { if (isEdited) setFieldEditAccess() ;  else setFieldReadAccess() ;  // readonly field inventaire.setEdited(false) ;  CDT.setEdited(isEdited) ;  lot.setEdited(isEdited) ;  quantiteReelle.setEdited(isEdited) ;  // readonly field quantiteTheorique.setEdited(false) ;  }  * Configures the visibility of the fields  * in view mode depending on the user privileges private void setFieldReadAccess() { if (!AccessManager.canReadDetailInventaireDescription()) descriptionSection.setVisible(false) ;  }  * Configures the visibility of the fields  * in edit mode depending on the user privileges private void setFieldEditAccess() { if (!AccessManager.canEditDetailInventaireDescription()) descriptionSection.setVisible(false) ;  }  * Sets the Request Context for the List Editors. public void setRequestContextForListEditors(DetailInventaireRequest ctx) { }  * Manages editor updates when a field value changes private void setFieldValueChangeHandler() { registrations.add(requestFactory.getEventBus().addHandler( FieldValueChangeEvent.TYPE, new FieldValueChangeEvent.Handler() { @Override public void onValueChange(ImogField<?> field) { // field dependent visibility management computeVisibility(field, false) ;  if (field.equals(CDT)) { clearLotWidget() ;  getLotFilteredByCDT(CDT.getValue()) ;  }  }  } )) ;  }  * Computes the field visibility public void computeVisibility(ImogField<?> source, boolean allValidation) { }  * Filters the content of the RelationField Lot by the value of  * the RelationField CDT * @param cDT the value of  * the RelationField CDT  public void getLotFilteredByCDT(CentreDiagTraitProxy pCDT) { if (pCDT != null) { if (!hideButtons) lot.hideButtons(false) ;  lotDataProvider.setFilterCriteria(pCDT.getId(), "CDT.id") ;  }  else { lot.hideButtons(true) ;  lotDataProvider.setFilterCriteria(null) ;  }  }  * Setter to inject a Inventaire value * @param value the value to be injected into the editor * @param isLocked true if relation field shall be locked (non editable) public void setInventaire(InventaireProxy value, boolean isLocked) { inventaire.setLocked(isLocked) ;  inventaire.setValue(value) ;  }  private void clearInventaireWidget() { inventaire.clear() ;  }  * Setter to inject a CentreDiagTrait value * @param value the value to be injected into the editor * @param isLocked true if relation field shall be locked (non editable) public void setCDT(CentreDiagTraitProxy value, boolean isLocked) { CDT.setLocked(isLocked) ;  CDT.setValue(value) ;  // Field Lot depends on the value of field cDT clearLotWidget() ;  getLotFilteredByCDT(value) ;  }  private void clearCDTWidget() { CDT.clear() ;  }  * Setter to inject a Lot value * @param value the value to be injected into the editor * @param isLocked true if relation field shall be locked (non editable) public void setLot(LotProxy value, boolean isLocked) { lot.setLocked(isLocked) ;  lot.setValue(value) ;  }  private void clearLotWidget() { lot.clear() ;  }  * Configures the handlers of the widgets that manage relation fields private void setRelationHandlers() { inventaire.setViewClickHandler(new ClickHandler() { @Override public void onClick(ClickEvent event) { if (inventaire.getValue() != null) { RelationPopupPanel relationPopup = new RelationPopupPanel() ;  InventaireFormPanel form = new InventaireFormPanel( requestFactory, inventaire.getValue().getId(), relationPopup, "inventaire") ;  relationPopup.addWidget(form) ;  relationPopup.show() ;  }  }  } ) ;  inventaire.setAddClickHandler(new ClickHandler() { @Override public void onClick(ClickEvent event) { RelationPopupPanel relationPopup = new RelationPopupPanel() ;  InventaireFormPanel form = new InventaireFormPanel( requestFactory, null, relationPopup, "inventaire") ;  relationPopup.addWidget(form) ;  relationPopup.show() ;  }  } ) ;  registrations.add(requestFactory.getEventBus().addHandler( SaveInventaireEvent.TYPE, new SaveInventaireEvent.Handler() { @Override public void saveInventaire(InventaireProxy value) { inventaire.setValue(value) ;  }  @Override public void saveInventaire(InventaireProxy value, String initField) { if (initField.equals("inventaire")) inventaire.setValue(value, true) ;  }  } )) ;  CDT.setViewClickHandler(new ClickHandler() { @Override public void onClick(ClickEvent event) { if (CDT.getValue() != null) { RelationPopupPanel relationPopup = new RelationPopupPanel() ;  CentreDiagTraitFormPanel form = new CentreDiagTraitFormPanel( requestFactory, CDT.getValue().getId(), relationPopup, "CDT") ;  relationPopup.addWidget(form) ;  relationPopup.show() ;  }  }  } ) ;  CDT.setAddClickHandler(new ClickHandler() { @Override public void onClick(ClickEvent event) { RelationPopupPanel relationPopup = new RelationPopupPanel() ;  CentreDiagTraitFormPanel form = new CentreDiagTraitFormPanel( requestFactory, null, relationPopup, "CDT") ;  relationPopup.addWidget(form) ;  relationPopup.show() ;  }  } ) ;  registrations.add(requestFactory.getEventBus().addHandler( SaveCentreDiagTraitEvent.TYPE, new SaveCentreDiagTraitEvent.Handler() { @Override public void saveCentreDiagTrait(CentreDiagTraitProxy value) { CDT.setValue(value) ;  }  @Override public void saveCentreDiagTrait(CentreDiagTraitProxy value, String initField) { if (initField.equals("CDT")) CDT.setValue(value, true) ;  }  } )) ;  lot.setViewClickHandler(new ClickHandler() { @Override public void onClick(ClickEvent event) { if (lot.getValue() != null) { RelationPopupPanel relationPopup = new RelationPopupPanel() ;  LotFormPanel form = new LotFormPanel(requestFactory, lot .getValue().getId(), relationPopup, "lot") ;  relationPopup.addWidget(form) ;  relationPopup.show() ;  }  }  } ) ;  lot.setAddClickHandler(new ClickHandler() { @Override public void onClick(ClickEvent event) { RelationPopupPanel relationPopup = new RelationPopupPanel() ;  LotFormPanel form = new LotFormPanel(requestFactory, null, relationPopup, "lot") ;  CommonFieldUtil commonFieldUtil = CommonFieldUtil.get() ;  if (commonFieldUtil.getRegion() != null) form.setRegion(commonFieldUtil.getRegion(), true) ;  if (commonFieldUtil.getDistrict() != null) form.setDistrictSante(commonFieldUtil.getDistrict(), true) ;  if (commonFieldUtil.getCdt() != null) form.setCDT(commonFieldUtil.getCdt(), true) ;  relationPopup.addWidget(form) ;  relationPopup.show() ;  }  } ) ;  registrations.add(requestFactory.getEventBus().addHandler( SaveLotEvent.TYPE, new SaveLotEvent.Handler() { @Override public void saveLot(LotProxy value) { lot.setValue(value) ;  }  @Override public void saveLot(LotProxy value, String initField) { if (initField.equals("lot")) lot.setValue(value, true) ;  }  } )) ;  }  * Gets the DetailInventaireProxy that is edited in the Workflow * Not used by the editor * Temporary storage used to transmit the proxy to related entities * @return public DetailInventaireProxy getEditedValue() { return editedValue ;  }  * Sets the DetailInventaireProxy that is edited in the Workflow * Not used by the editor * Temporary storage used to transmit the proxy to related entities  * @param editedValue  public void setEditedValue(DetailInventaireProxy editedValue) { this.editedValue = editedValue ;  }  * public void raiseNotUniqueError(String field) { delegate.recordError(BaseNLS.messages().error_not_unique(), null, field) ;  }  * Validate fields values public void validateFields() { // cDT is a required field if (CDT.getValue() == null) delegate.recordError(BaseNLS.messages().error_required(), null, "cDT") ;  // lot is a required field if (lot.getValue() == null) delegate.recordError(BaseNLS.messages().error_required(), null, "lot") ;  // quantiteReelle is a required field if (quantiteReelle.getValueWithoutParseException() == null && quantiteReelle.isValid()) delegate.recordError(BaseNLS.messages().error_required(), null, "quantiteReelle") ;  // quantiteReelle shall be superior or equal to '0' if (quantiteReelle.getValueWithoutParseException() != null && !(quantiteReelle.getValueWithoutParseException() >= 0)) delegate.recordError( BaseNLS.messages() .error_min_num( NLS.constants() .detailInventaire_field_quantiteReelle_min()), null, "quantiteReelle") ;  // quantiteTheorique shall be superior or equal to '0' if (quantiteTheorique.getValueWithoutParseException() != null && !(quantiteTheorique.getValueWithoutParseException() >= 0)) delegate.recordError( BaseNLS.messages() .error_min_num( NLS.constants() .detailInventaire_field_quantiteTheorique_min()), null, "quantiteTheorique") ;  }  private void setAllLabelWith(String width) { inventaire.setLabelWidth(width) ;  CDT.setLabelWidth(width) ;  lot.setLabelWidth(width) ;  quantiteReelle.setLabelWidth(width) ;  quantiteTheorique.setLabelWidth(width) ;  }  private void setAllBoxWith(int width) { inventaire.setBoxWidth(width) ;  CDT.setBoxWidth(width) ;  lot.setBoxWidth(width) ;  }  @Override public void setDelegate(EditorDelegate<DetailInventaireProxy> delegate) { this.delegate = delegate ;  }  @Override public void showErrors(List<EditorError> errors) { if (errors != null && errors.size() > 0) { List<EditorError> cDTFieldErrors = new ArrayList<EditorError>() ;  List<EditorError> lotFieldErrors = new ArrayList<EditorError>() ;  List<EditorError> quantiteReelleFieldErrors = new ArrayList<EditorError>() ;  List<EditorError> quantiteTheoriqueFieldErrors = new ArrayList<EditorError>() ;  for (EditorError error : errors) { Object userData = error.getUserData() ;  if (userData != null && userData instanceof String) { String field = (String) userData ;  if (field.equals("cDT")) cDTFieldErrors.add(error) ;  if (field.equals("lot")) lotFieldErrors.add(error) ;  if (field.equals("quantiteReelle")) quantiteReelleFieldErrors.add(error) ;  if (field.equals("quantiteTheorique")) quantiteTheoriqueFieldErrors.add(error) ;  }  }  if (cDTFieldErrors.size() > 0) CDT.showErrors(cDTFieldErrors) ;  if (lotFieldErrors.size() > 0) lot.showErrors(lotFieldErrors) ;  if (quantiteReelleFieldErrors.size() > 0) quantiteReelle.showErrors(quantiteReelleFieldErrors) ;  if (quantiteTheoriqueFieldErrors.size() > 0) quantiteTheorique.showErrors(quantiteTheoriqueFieldErrors) ;  }  }  @Override protected void onUnload() { for (HandlerRegistration r : registrations) r.removeHandler() ;  registrations.clear() ;  super.onUnload() ;  }  @Override protected void onLoad() { setRelationHandlers() ;  setFieldValueChangeHandler() ;  super.onLoad() ;  } }