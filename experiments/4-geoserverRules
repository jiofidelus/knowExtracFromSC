
if(obj==null){returnfalse;
if(!(objinstanceofNamespaceInfo)){returnfalse;
if(prefix==null){
if(other.getPrefix()!=null)returnfalse;
else
if(!prefix.equals(other.getPrefix()))returnfalse;
if(uri==null){
if(other.getURI()!=null)returnfalse;
else
if(!uri.equals(other.getURI()))returnfalse;returntrue;}}
if(property==TYPE){Fragmentf=newFragment(id,"iconFragment",NewCachedLayerPage.this);TileLayerlayer=(TileLayer)itemModel.getObject();PackageResourceReferencelayerIcon=(PackageResourceReference)property.getPropertyValue(layer);f.add(newImage("layerIcon",layerIcon));returnf;
else
if(property==NAME){returnnameLink(id,itemModel);
else
if(property==ENABLED){TileLayerlayerInfo=(TileLayer)itemModel.getObject();booleanenabled=layerInfo.isEnabled();PackageResourceReferenceicon;
if(enabled){icon=GWCIconFactory.getEnabledIcon();
else{icon=GWCIconFactory.getDisabledIcon();
if(selection.isEmpty()){return;
ifthereissomethingtocancel,let'swarntheuseraboutwhat//couldgowrong,and
iftheuseraccepts,let'sdeletewhat'sneededdialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){privatestaticfinallongserialVersionUID=1L;@OverrideprotectedComponentgetContents(finalStringid){//showaconfirmationpanelforalltheobjectswehavetoremovefinalIntegerselectedLayerCount=selectedNames.size();IModel<String>model=newStringResourceModel("NewCachedLayerPage.confirmBulkConfig.message",BulkCachedLayerConfigurationLink.this).setParameters(newObject[]{selectedLayerCount.toString()});LabelconfirmLabel=newLabel(id,model);confirmLabel.setEscapeModelStrings(false);//allowsomehtmlinside,like//<b></b>,etcreturnconfirmLabel;
iftheselectionhasbeenclearedoutit'ssignadeletion//occurred,sorefreshthetableList<TileLayer>selection=table.getSelection();
if(selection.isEmpty()){updateBulkConfigLink();target.add(BulkCachedLayerConfigurationLink.this);target.add(table);
if(cropBounds.contains((com.vividsolutions.jts.geom.Envelope)coverageBounds)){returncoverage;
if(interpolation!=null){/*Operations.DEFAULT.interpolate(coverage,interpolation)*/finalParameterValueGroupparam=(ParameterValueGroup)PROCESSOR.getOperation("Interpolate").getParameters();param.parameter("Source").setValue(coverage);param.parameter("Type").setValue(interpolation);return(GridCoverage2D)((Interpolate)PROCESSOR.getOperation("Interpolate")).doOperation(param,hints);
if((params!=null)&&!params.isEmpty()){for(Iteratorp=params.keySet().iterator();p.hasNext();){finalStringparam=(String)p.next();
if(param.equalsIgnoreCase("BAND")){try{finalStringvalues=(String)params.get(param);
if(values.indexOf("/")>0){finalString[]minMaxRes=values.split("/");finalintmin=(int)Math.round(Double.parseDouble(minMaxRes[0]));finalintmax=(int)Math.round(Double.parseDouble(minMaxRes[1]));finaldoubleres=((minMaxRes.length>2)?Double.parseDouble(minMaxRes[2]):0.0);for(intv=min;v<=max;v++){finalStringkey=param.toLowerCase()+v;
if(dims.containsKey(key)){selectedBands.add(dims.get(key));
else{finalString[]bands=values.split(",");for(intv=0;v<bands.length;v++){finalStringkey=param.toLowerCase()+bands[v];
if(dims.containsKey(key)){selectedBands.add(dims.get(key));
if(selectedBands.size()==0){thrownewException("WRONGPARAMVALUES.");
if((bands!=null)&&(bands.length>0)){/*Operations.DEFAULT.selectSampleDimension(coverage,bands)*/finalParameterValueGroupparam=(ParameterValueGroup)PROCESSOR.getOperation("SelectSampleDimension").getParameters();param.parameter("Source").setValue(coverage);param.parameter("SampleDimensions").setValue(bands);//param.parameter("VisibleSampleDimension").setValue(bands);bandSelectedCoverage=((SelectSampleDimension)PROCESSOR.getOperation("SelectSampleDimension")).doOperation(param,hints);
else{bandSelectedCoverage=coverage;
if(limit<=0){return;
if(actual>limit){thrownewWcsException("Thisrequestistryingtogeneratetoomuchdata,"+"thelimitis"+formatBytes(limit)+"buttheactualamountofbytestobe"+"writtenintheoutputis"+formatBytes(actual));
if(limit<=0){return;
if(actual>limit){thrownewWcsException("Thisrequestistryingtoreadtoomuchdata,"+"thelimitis"+formatBytes(limit)+"buttheactualamountof"+"bytestobereadis"+formatBytes(actual));
ifthecoveragesizeexceedstheconfiguredlimits*/publicstaticvoidcheckInputLimits(WCSInfoinfo,CoverageInfometa,GridCoverage2DReaderreader,GridGeometry2DgridGeometry)throwsWcsException{//dowehavetocheckalimitatall?longlimit=info.getMaxInputMemory()*1024;
if(limit<=0){return;
ifnecessaryreprojectbacktotheoriginalCRSGeneralEnveloperequestedEnvelope=newGeneralEnvelope(gridGeometry.getEnvelope());finalCoordinateReferenceSystemrequestCRS=requestedEnvelope.getCoordinateReferenceSystem();finalCoordinateReferenceSystemnativeCRS=reader.getCoordinateReferenceSystem();
if(!CRS.equalsIgnoreMetadata(requestCRS,nativeCRS)){requestedEnvelope=CRS.transform(requestedEnvelope,nativeCRS);
ifwearestillreadinganything
if(!requestedEnvelope.isEmpty()){MathTransformcrsToGrid=meta.getGrid().getGridToCRS().inverse();GeneralEnveloperequestedGrid=CRS.transform(crsToGrid,requestedEnvelope);double[]spans=newdouble[requestedGrid.getDimension()];double[]resolutions=newdouble[requestedGrid.getDimension()];for(inti=0;i<spans.length;i++){spans[i]=requestedGrid.getSpan(i);resolutions[i]=requestedEnvelope.getSpan(i)/spans[i];
if(meta.getDimensions()!=null){for(CoverageDimensionInfodimension:meta.getDimensions()){intsize=guessSizeFromRange(dimension.getRange());
if(size==0){LOGGER.log(Level.INFO,"Failedtoguessthesizeofdimension"+dimension.getName()+",skippingthepre-readcheck");pixelSize=-1;break;
if(actual<0){//TODO:providesomemoreinfoabouttherequest?Itseemstobewe'dhaveto//logagainthefullrequest...unlesstherequestloggerstartsdumpingthethread//id,inthatcasewecanjustrefertothatandtelltheadmintoenable//therequestloggertodebugtheseissues?LOGGER.log(Level.INFO,"Warning,wecouldnotestimatetheamountofbytestobe"+"readfromthecoveragesourceforthecurrentrequest");
if(actual>limit){thrownewWcsException("Thisrequestistryingtoreadtoomuchdata,"+"thelimitis"+formatBytes(limit)+"buttheactualamountofbytes"+"tobereadis"+formatBytes(actual));
if(diff<=((int)Byte.MAX_VALUE-(int)Byte.MIN_VALUE)){return8;
else
if(diff<=((int)Short.MAX_VALUE-(int)Short.MIN_VALUE)){return16;
else
if(diff<=((double)Integer.MAX_VALUE-(double)Integer.MIN_VALUE)){return32;
else
if(diff<=((double)Float.MAX_VALUE-(double)Float.MIN_VALUE)){return32;
else{return64;
if(bytes<1024){returnbytes+"B";
else
if(bytes<1024*1024){returnnewDecimalFormat("#.##").format(bytes/1024.0)+"KB";
else{returnnewDecimalFormat("#.##").format(bytes/1024.0/1024.0)+"MB";
if(wcs.getOverviewPolicy()==null){hints.add(newHints(Hints.OVERVIEW_POLICY,OverviewPolicy.IGNORE));
else{hints.add(newHints(Hints.OVERVIEW_POLICY,wcs.getOverviewPolicy()));
if(request==null){returnnull;
if(!(filterinstanceofFilter)){filter=request.getKvp().get("CQL_FILTER");
if(filterinstanceofList){Listlist=(List)filter;
if(list.size()>0){filter=list.get(0);
if(!(filterinstanceofFilter)){filter=request.getKvp().get("FEATURE_ID");
if(filterinstanceofFilter){return(Filter)filter;
else{returnnull;
if(limit<=0){return;
if(actual>limit){thrownewWcsException("Thisrequestistryingtogeneratetoomuchdata,"+"thelimitis"+formatBytes(limit)+"buttheactualamountofbytestobe"+"writtenintheoutputis"+formatBytes(actual));
if(gpv.getDescriptor().getName().equals(pd.getName())){((ParameterValue)gpv).setValue(value);//leavereturnreadParameters;
if(iter.next().getModule().toString().matches("\\A[system-](.*)")){iter.remove();
if((beaninstanceofCacheProvider)&&!(beaninstanceofHzCacheProvider)){//Ifanotherextensiondoesthistoothenwe'reintroubleasonlythedefaultwillbe//used.LOGGER.log(Level.INFO,"hz-clustermoduleissupressingconflictingCacheProvider{0}",newObject[]{beanId});returntrue;
ifwetempvaluesareuseforconsecutiveviews.**@authorTimothyDeBock*/publicclassCreateComplexViewConsecutiveTestextendsAbstractTaskManagerTest{//configuretheseconstantsprivatestaticfinalStringDB_NAME="testsourcedb";privatestaticfinalStringTABLE_NAME="gw_beleid.grondwaterlichamen_new";privatestaticfinalStringVIEW_NAME="gw_beleid.vw_grondwaterlichamen_test";privatestaticfinalStringDEFINITION="select*from${table_name}wheregwllike'BL%'";privatestaticfinalStringDEFINITION_STEP2="selectdataengine_idfrom${table_name_step2}wheregwllike'BL%'";privatestaticfinalStringVIEW_NAME_STEP2="gw_beleid.vw_grondwaterlichamen_from_view";//attributesprivatestaticfinalStringATT_DB_NAME="db";privatestaticfinalStringATT_TABLE_NAME="table_name";privatestaticfinalStringATT_VIEW_NAME="view_name";privatestaticfinalStringATT_DEFINITION="definition";privatestaticfinalStringATT_DEFINITION_STEP2="definition_step2";privatestaticfinalStringATT_TABLE_NAME_STEP2="table_name_step2";privatestaticfinalStringATT_VIEW_NAME_STEP2="view_name_step2";@AutowiredprivateTaskManagerDaodao;@AutowiredprivateTaskManagerFactoryfac;@AutowiredprivateTaskManagerDataUtildataUtil;@AutowiredprivateTaskManagerTaskUtiltaskUtil;@AutowiredprivateBatchJobServicebjService;@AutowiredprivateLookupService<DbSource>dbSources;@AutowiredprivateSchedulerscheduler;privateConfigurationconfig;privateBatchbatch;@BeforepublicvoidsetupBatch(){config=fac.createConfiguration();config.setName("my_config");config.setWorkspace("some_ws");TasktaskOtherStepTwo=generateCreateViewTask("taskOther",ATT_VIEW_NAME_STEP2,ATT_DEFINITION_STEP2);dataUtil.addTaskToConfiguration(config,taskOtherStepTwo);TasktaskOtherStepOne=generateCreateViewTask("taskStep1",ATT_VIEW_NAME,ATT_DEFINITION);dataUtil.addTaskToConfiguration(config,taskOtherStepOne);config=dao.save(config);taskOtherStepOne=config.getTasks().get("taskStep1");taskOtherStepTwo=config.getTasks().get("taskOther");batch=fac.createBatch();batch.setName("my_batch_other");dataUtil.addBatchElement(batch,taskOtherStepOne);dataUtil.addBatchElement(batch,taskOtherStepTwo);batch=bjService.saveAndSchedule(batch);
if(md.storesUpperCaseIdentifiers()){schema=schema.toUpperCase();pattern=pattern.toUpperCase();
if("pipo".equals(u.getUserName())){assertTrue(u.isEnabled());found=true;
if("pipo".equals(u.getUserName())){assertTrue(u.isEnabled());found=true;
if("pipo".equals(u.getUserName())){assertFalse(u.isEnabled());found=true;
if("pipo".equals(u.getUserName())){found=true;
if(file.isDirectory()){returnnewDirectory(file);
if(newVFSWorker().canHandle(file)){returnnewArchive(file);
if(file.exists()){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Deletingfile"+file.getAbsolutePath());
if(!file.delete()){thrownewIOException("Unabletodelete"+file.getAbsolutePath());
if(fp.startsWith(dp)){Stringleft=fp.substring(dp.length());returnnewFile(dir.getFile().getName(),left).toString();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!getClass().isInstance(obj)&&!obj.getClass().isInstance(this)){returnfalse;
if(file==null){
if(other.file!=null)returnfalse;
else
if(!file.equals(other.file))returnfalse;returntrue;
if(storesinstanceofJSONArray){assertEquals(catalog.getStoresByWorkspace("sf",WMTSStoreInfo.class).size(),((JSONArray)stores).size());
else{assertEquals(1,catalog.getStoresByWorkspace("sf",WMTSStoreInfo.class).size());
if(pathInfo.indexOf("?")!=-1){queryString=pathInfo.substring(pathInfo.indexOf("?")+1);pathInfo=pathInfo.substring(0,pathInfo.indexOf("?"));
if(queryString!=null){request.setQueryString(queryString);
if(this.tasks==null){this.tasks=newLinkedList<Future<RenderedImage>>();
if(image==null){continue;
if(wmsConfiguration.getMaxRenderingSize()!=null&&gifAnimatedSize>=wmsConfiguration.getMaxRenderingSize()){dispose();thrownewIOException("Maxrenderingsizeexceed!");
if(images==null||images.size()==0){dispose();thrownewIOException("Emptylistofframes.");
if(this.tasks!=null)this.tasks.clear();this.tasks=null;}}/***FrameLoaderCallabletask.**@authorAlessio*/classFrameLoaderimplementsCallable<RenderedImage>{/**Thedefaultoutputformatforeachframe
ifnotspecifiedintherequest*/privatestaticfinalStringGIF_FORMAT="image/gif";privateGetMapRequestrequest;privateWebMapServicewms;privateWMSwmsConfiguration;privateStringaparam;privateStringavalue;/***Defaultconstructor.**@paramrequest*@paramwms*@paramwmsConfiguration*@paramaparam*@paramavalue*/publicFrameLoader(GetMapRequestrequest,WebMapServicewms,WMSwmsConfiguration,Stringaparam,Stringavalue){this.request=request;this.wms=wms;this.wmsConfiguration=wmsConfiguration;this.aparam=aparam;this.avalue=avalue.replaceAll("\\\\,",",");
if(response.getOutputFormats().contains(outFormat)){MapProducerCapabilitiescap=response.getCapabilities(outFormat);
if(cap!=null&&cap.getFramesMimeType()!=null){frameRequest.setFormat(cap.getFramesMimeType());
else{frameRequest.setFormat(GIF_FORMAT);
if(param.contains(":")){//goingtoreplacecompositeparamvaluesforeachframeintheKVPmapStringcompositeParamKey=param.split(":")[0].toUpperCase();StringsimpleParamKey=param.split(":")[1].toUpperCase();List<String>kvps=null;
if(rawKvp.get(compositeParamKey)!=null){kvps=KvpUtils.escapedTokens(rawKvp.get(compositeParamKey),';');//purgeoldvalueIterator<String>it=kvps.iterator();while(it.hasNext()){Stringk=it.next().toUpperCase();
if(k.toUpperCase().startsWith(simpleParamKey)){it.remove();
else{kvps=newArrayList<String>();
else{//justasimpleplainrequestparameter...replacingitontheKVPmap//purgeoldvalue
if(rawKvp.containsKey(param)){rawKvp.remove(param);
if(file.parent().parent().name().equals("wps")){returnfile.parent().name()+":"+baseName;
else{returnFilenameUtils.getBaseName(file.name());
if(name.contains(":")){name=name.replace(":",File.separator);
if(file==null){this.file=findFile(name,type,extension);
if(queryStringBuilder.length()==0){return"";
if(existingValues!=null&&combine.isPresent()){StringcombinedValue=combine.get().replace("$1",existingValues[0]);combinedValue=combinedValue.replace("$2",value);existingValues[0]=combinedValue;
else{parameters.put(rawName,newString[]{value});
if(rawName!=null){returnrawName;
if(updatedQueryString.isEmpty()){returngetRequestUri();
if(!process.isAvailable()){LOGGER.warning("GDALutilitiesarenotinthepath,skippingthetest");return;
if(!it.hasNext()){thrownewIllegalStateException("NoPNGImageWriterfound");
else{writer=(ImageWriter)it.next();
if(writer.getClass().getName().equals("com.sun.media.imageioimpl.plugins.png.CLibPNGImageWriter")){iwp.setCompressionMode(ImageWriteParam.MODE_EXPLICIT);iwp.setCompressionQuality(0.75f);//wecancontrolqualityhere
if(retval!=null){returnretval;
if(dimensionName.equals(ResourceInfo.TIME)){
if(resourceinstanceofFeatureTypeInfo){retval=featureNearestValueStrategyFactory.createNearestValueStrategy(newDate(),DimensionDefaultValueSetting.TIME_CURRENT);
else
if(resourceinstanceofCoverageInfo){retval=coverageNearestValueStrategyFactory.createNearestValueStrategy(newDate(),DimensionDefaultValueSetting.TIME_CURRENT);
else
if(dimensionName.equals(ResourceInfo.ELEVATION)){
if(resourceinstanceofFeatureTypeInfo){retval=featureElevationMinimumStrategy;
else
if(resourceinstanceofCoverageInfo){retval=coverageElevationMinimumStrategy;
else
if(dimensionName.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){
if(resourceinstanceofFeatureTypeInfo){retval=featureCustomDimensionMinimumStrategy;
else
if(resourceinstanceofCoverageInfo){retval=coverageCustomDimensionMinimumStrategy;
if(setting!=null&&setting.getStrategyType()!=null){
if(dimensionName.equals(ResourceInfo.TIME)){retval=getDefaultTimeStrategy(resource,setting);
else
if(dimensionName.equals(ResourceInfo.ELEVATION)){retval=getDefaultElevationStrategy(resource,setting);
else
if(dimensionName.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){retval=getDefaultCustomDimensionStrategy(resource,setting);
switch(getStrategyType){caseNEAREST:{DaterefDate;StringcapabilitiesValue=null;StringreferenceValue=setting.getReferenceValue();
if(referenceValue!=null){
if(referenceValue.equalsIgnoreCase(DimensionDefaultValueSetting.TIME_CURRENT)){refDate=newDate();capabilitiesValue=DimensionDefaultValueSetting.TIME_CURRENT;
else{try{refDate=newDate(DateUtil.parseDateTime(referenceValue));
if(resourceinstanceofFeatureTypeInfo){retval=featureNearestValueStrategyFactory.createNearestValueStrategy(refDate,capabilitiesValue);
else
if(resourceinstanceofCoverageInfo){retval=coverageNearestValueStrategyFactory.createNearestValueStrategy(refDate,capabilitiesValue);
else{thrownewServiceException("Noreferencevaluegivenfortimedimensiondefaultvalue'nearest'strategy");
if(resourceinstanceofFeatureTypeInfo){retval=featureTimeMinimumStrategy;
else
if(resourceinstanceofCoverageInfo){retval=coverageTimeMinimumStrategy;
if(resourceinstanceofFeatureTypeInfo){retval=featureTimeMaximumStrategy;
else
if(resourceinstanceofCoverageInfo){retval=coverageTimeMaximumStrategy;
if(referenceValue!=null){try{refDate=singleValue(timeParser.parse(referenceValue),newDate());
else{thrownewServiceException("Noreferencevaluegivenfortimedimensiondefaultvalue'fixed'strategy");
switch(setting.getStrategyType()){caseNEAREST:{NumberrefNumber;StringreferenceValue=setting.getReferenceValue();
if(referenceValue!=null){try{refNumber=Long.parseLong(referenceValue);
if(resourceinstanceofFeatureTypeInfo){retval=featureNearestValueStrategyFactory.createNearestValueStrategy(refNumber);
else
if(resourceinstanceofCoverageInfo){retval=coverageNearestValueStrategyFactory.createNearestValueStrategy(refNumber);
else{thrownewServiceException("Noreferencevaluegivenforelevationdimensiondefaultvalue'nearest'strategy");
if(resourceinstanceofFeatureTypeInfo){retval=featureElevationMinimumStrategy;
else
if(resourceinstanceofCoverageInfo){retval=coverageElevationMinimumStrategy;
if(resourceinstanceofFeatureTypeInfo){retval=featureElevationMaximumStrategy;
else
if(resourceinstanceofCoverageInfo){retval=coverageElevationMaximumStrategy;
if(referenceValue!=null){try{refNumber=singleValue(elevationParser.parse(referenceValue),newDate());
else{thrownewServiceException("Noreferencevaluegivenforelevationdimensiondefaultvalue'fixed'strategy");
if(parsed.size()==1){result=parsed.iterator().next();
else
if(parsed.size()>1){thrownewIllegalArgumentException("Dimensionreferencevaluemustbeasinglevalueorrange");
if(result==null){returndefaultValue;
else{returnresult;
switch(setting.getStrategyType()){caseNEAREST:{ObjectrefValue;referenceValue=setting.getReferenceValue();
if(referenceValue!=null){try{refValue=newDate(DateUtil.parseDateTime(referenceValue));
if(resourceinstanceofFeatureTypeInfo){retval=featureNearestValueStrategyFactory.createNearestValueStrategy(refValue);
else
if(resourceinstanceofCoverageInfo){retval=coverageNearestValueStrategyFactory.createNearestValueStrategy(refValue);
else{thrownewServiceException("Noreferencevaluegivenforcustomdimensiondefaultvalue'nearest'strategy");
if(resourceinstanceofFeatureTypeInfo){retval=featureCustomDimensionMinimumStrategy;
else
if(resourceinstanceofCoverageInfo){retval=coverageCustomDimensionMinimumStrategy;
if(resourceinstanceofFeatureTypeInfo){retval=featureCustomDimensionMaximumStrategy;
else
if(resourceinstanceofCoverageInfo){retval=coverageCustomDimensionMaximumStrategy;
if(referenceValue!=null){try{refValue=newDate(DateUtil.parseDateTime(referenceValue));
else{thrownewServiceException("Noreferencevaluegivenforcustomdimensiondefaultvalue'fixed'strategy");
if(layers==null)returnnull;LayerInforet=null;for(LayerInfolayer:layers){
if(layer!=null&&layer.getType()==PublishedType.RASTER){
if(ret==null){ret=layer;
else{LOGGER.warning("MultiplecoveragesfoundforNSName'"+encodedCoverageId+"':"+ret.prefixedName()+"isselected,"+layer.prefixedName()+"willbeignored");
iftheencodedidcouldnotbe*decoded.*/publicstaticList<LayerInfo>getLayers(Catalogcatalog,StringencodedResourceId){List<MapEntry<String,String>>decodedList=decode(encodedResourceId);
if(decodedList.isEmpty()){LOGGER.info("Couldnotdecodeid'"+encodedResourceId+"'");returnnull;
if(namespace==null||namespace.isEmpty()){LOGGER.info("Checkingcoveragename"+covName);LayerInfolayer=catalog.getLayerByName(covName);
if(layer!=null){LOGGER.info("-Collectinglayer"+layer.prefixedName());ret.add(layer);
else{LOGGER.info("-Ignoringlayer"+covName);
else{LOGGER.info("Checkingpair"+namespace+":"+covName);StringfullName=namespace+":"+covName;NamespaceInfonsInfo=catalog.getNamespaceByPrefix(namespace);
if(nsInfo!=null){LOGGER.info("-Namespacefound"+namespace);LayerInfolayer=catalog.getLayerByName(fullName);
if(layer!=null){LOGGER.info("-Collectinglayer"+layer.prefixedName());ret.add(layer);
else{LOGGER.info("-Ignoringlayer"+fullName);
else{LOGGER.info("-Namespacenotfound"+namespace);
iftheinputcouldnotbe*decoded;*/publicstaticList<MapEntry<String,String>>decode(StringqualifiedName){intlastPos=qualifiedName.lastIndexOf(DELIMITER);List<MapEntry<String,String>>ret=newArrayList<MapEntry<String,String>>();
if(lastPos==-1){ret.add(newMapEntry<String,String>(null,qualifiedName));returnret;
ifmissing**@paramimage*@paramctx*@return*/publicstaticJpegOrPngChoosergetFromMapContent(RenderedImageimage,WMSMapContentctx){JpegOrPngChooserchooser=(JpegOrPngChooser)ctx.getMetadata().get(JPEG_PNG_CHOOSER);
if(chooser==null){chooser=newJpegOrPngChooser(image);ctx.getMetadata().put(JPEG_PNG_CHOOSER,chooser);
ifthebestformattoencodetheimageisjpeg(theimageisrgb,orrgba*withoutanyactualtransparencyuse)**@paramrenderedImage*@paramrenderingHints*@return*/privatebooleanisBestFormatJpeg(RenderedImagerenderedImage){intnumBands=renderedImage.getSampleModel().getNumBands();
if(numBands==4||numBands==2){RenderingHintsrenderingHints=ImageUtilities.getRenderingHints(renderedImage);RenderedOpextremaOp=ExtremaDescriptor.create(renderedImage,null,1,1,false,1,renderingHints);double[][]extrema=(double[][])extremaOp.getProperty("Extrema");double[]mins=extrema[0];returnmins[mins.length-1]==255;//fullyopaque
else
if(renderedImage.getColorModel()instanceofIndexColorModel){//JPEGwouldstillcompressabitbetter,butinordertofigureout//
iftheimagehastransparencywe'dhavetoexpandtoRGBorroll//anewJAIimageopthatlooksforthetransparentpixels.Outofscopeforthemomentreturnfalse;
else{//otherwisesupportRGBorgrayreturn(numBands==3)||(numBands==1);
iftheJPEGformatwasthepreferredone*/publicbooleanisJpegPreferred(){returnjpegPreferred;}}
if{@codecommitted==false},thetransactionresultobjecttobe*sentbacktotheclientotherwise.*@paramcommittedtrue
ifthetransactionwassuccessful,false
ifthetransactionwasaborted*foranyreason*/voidafterTransaction(TransactionTyperequest,TransactionResponseTyperesult,booleancommitted);/***Aspectsgetscalledinaspecificorder.Stateyourpriority,thehigherthenumber,the*earlierthepluginwillbeprocessed.*/intgetPriority();}
if(getDriverClassName()==null){synchronized(this){
if(getDriverClassName()==null){initializeDataSource();
if(einstanceofSQLException){throw(SQLException)e;
if(Resources.exists(dbprops)){LOGGER.info("Configuringmonitoringdatabasefrom:"+dbprops.path());//attempttoconfiguretry{configureDataSource(dbprops,monitoringDir);
if(Resources.exists(dbprops)){try{configureDataSource(dbprops,monitoringDir);//secondaryfileworked,returnreturn;
if(Resources.exists(dbprops)){try{configureDataSource(dbprops,monitoringDir);//thirdfileworked,returnreturn;
else{//nodb.propertiesfile,useinternaldefaultconfigureDataSource(null,monitoringDir);
if(dbprops==null){dbprops=monitoringDir.get("db.properties");//useadefault,andcopythetemplateovertry(InputStreamin=getClass().getResourceAsStream("db.properties");OutputStreamout=dbprops.out()){IOUtils.copy(in,out);
else{try(InputStreamin=dbprops.in()){db.load(in);
if(db.containsKey("username")){setUsername(db.getProperty("username"));
if(db.containsKey("password")){setPassword(db.getProperty("password"));
if(LOGGER.isLoggable(Level.FINE)){StringBuffersb=newStringBuffer("Monitoringdatabaseconnectioninfo:\n");for(Map.Entrye:db.entrySet()){sb.append(e.getKey()).append("=").append(e.getValue()).append("\n");
ifthestyleisvalid.");
if(!url.endsWith("/")){url+='/';
if(url.endsWith("/")){url=url.substring(0,url.length()-1);
if(type!=null){thrownewRuntimeException("Thepreviouslockwasnotreleased:"+type);
if(controllerinstanceofAbstractCatalogController||controllerinstanceofAbstractGeoServerController){
if(controllerinstanceofCatalogReloadController||isWriteMethod(request.getMethod())){//thisrequiresafulllock,itaffectspartofGeoToolsthatarenotthreadsafelocker.lock(LockType.WRITE);
else{locker.lock(LockType.READ);
if(type!=null){locker.unlock();
if(list!=null){list.close();
if(fc==null)returnnull;
elsereturn(FeatureCollection)SecuredObjects.secure(fc,policy);
if(fc==null)returnnull;
elsereturn(FeatureCollection)SecuredObjects.secure(fc,policy);}}
if(response.getRawStatusCode()!=400){super.handleError(response);
if(checkTokenResponse.containsKey("error")){logger.debug("check_tokenreturnederror:"+checkTokenResponse.get("error"));thrownewInvalidTokenException(accessToken);
if(headers.getContentType()==null){headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
if(exceptions==null){//usedefaulthandleDefault(exception,request,charset,verbose);return;
if(JSONType.isJsonMimeType(exceptions)){//useJsonformatJSONType.handleJsonException(LOGGER,exception,request,charset,verbose,false);
else
if(JSONType.useJsonp(exceptions)){//useJsonPformatJSONType.handleJsonException(LOGGER,exception,request,charset,verbose,true);
else{handleDefault(exception,request,charset,verbose);
if("1.0.0".equals(request.getVersion())){handle1_0(exception,request.getHttpResponse());
else{super.handleServiceException(exception,request);
if((e.getCode()!=null)&&!e.getCode().equals("")){s.append("code=\""+ResponseUtils.encodeXML(e.getCode())+"\"");
if((e.getLocator()!=null)&&!e.getLocator().equals("")){s.append("locator=\""+ResponseUtils.encodeXML(e.getLocator())+"\"");
if(e.getMessage()!=null){s.append("\n"+tab+tab);OwsUtils.dumpExceptionMessages(e,s,true);
if(verboseExceptions){ByteArrayOutputStreamstackTrace=newByteArrayOutputStream();e.printStackTrace(newPrintStream(stackTrace));s.append("\nDetails:\n");s.append(ResponseUtils.encodeXML(newString(stackTrace.toByteArray())));
if(elements.length!=2){return"Invalidrule"+ruleKey+",theexpectedformatisservice.method=role1,role2,...";
if(ANY.equals(elements[0])){
if(!ANY.equals(elements[1])){return"Invalidrule"+ruleKey+",whennamespace"+"is*thenalsolayermustbe*.";
ifwecanselectasinglepixelvalueusingaWCSrequest*/@TestpublicvoidsliceLambert()throwsException{//checkwecanreaditasaTIFFanditissimilaretotheoriginaloneGridCoverage2DtargetCoverage=null,sourceCoverage=null;GridCoverageReadercoverageReader=null;try{//===slicingonYaxis//sourceCoverageInfocoverageInfo=this.getCatalog().getCoverageByName(LAMBERTMOSAIC.getLocalPart());coverageReader=coverageInfo.getGridCoverageReader(null,null);finalParameterValue<Boolean>useJAI=ImageMosaicFormat.USE_JAI_IMAGEREAD.createValue();useJAI.setValue(false);sourceCoverage=(GridCoverage2D)coverageReader.read(newGeneralParameterValue[]{useJAI});finalEnvelope2DsourceEnvelope=sourceCoverage.getEnvelope2D();//subsampleusingtheoriginalextensionMockHttpServletResponseresponse=getAsServletResponse("wcs?request=GetCoverage&service=WCS&version=2.0.1"+"&coverageId=wcs__lambert&&Format=application/custom"+"&subset=E,http://www.opengis.net/def/crs/EPSG/0/31300("+sourceEnvelope.x+","+(sourceEnvelope.x+25)+")"+"&subset=N,http://www.opengis.net/def/crs/EPSG/0/31300("+sourceEnvelope.y+","+(sourceEnvelope.y+25)+")");assertNotNull(response);targetCoverage=applicationContext.getBean(WCSResponseInterceptor.class).getLastResult();assertEquals((Object)sourceCoverage.getCoordinateReferenceSystem(),(Object)targetCoverage.getCoordinateReferenceSystem());assertTrue(targetCoverageinstanceofGranuleStack);GridCoverage2DfirstResult=((GranuleStack)targetCoverage).getGranules().get(0);//checksassertEquals(1,firstResult.getGridGeometry().getGridRange().getSpan(0));assertEquals(1,firstResult.getGridGeometry().getGridRange().getSpan(1));assertEquals(0,firstResult.getGridGeometry().getGridRange().getLow(0));assertEquals(1,firstResult.getGridGeometry().getGridRange().getLow(1));
if(coverageReader!=null){try{coverageReader.dispose();
if(targetCoverage!=null){try{CoverageCleanerCallback.disposeCoverage(targetCoverage);
if(sourceCoverage!=null){try{CoverageCleanerCallback.disposeCoverage(sourceCoverage);
if(listenerinstanceofINotificationCatalogListener){counter++;
if(listenerinstanceofINotificationTransactionListener){counter++;
if(CRS.getAxisOrder(request.getCrs())==AxisOrder.NORTH_EAST){try{bbox=newReferencedEnvelope(bbox.getMinY(),bbox.getMaxY(),bbox.getMinX(),bbox.getMaxX(),CRS.decode("EPSG:"+CRS.lookupEpsgCode(request.getCrs(),false)));origin=newPoint2D.Double(origin.getY(),origin.getX());
if(Double.isInfinite(d)||Double.isNaN(d)){returnd;
if(ignoredParameters.contains(paramName.toUpperCase())){continue;
if(it.hasNext()){sb.append('&');
if(!(objinstanceofMapKey)){returnfalse;
if(!(objinstanceofMetaTileKey)){returnfalse;
ifavailable**@paramkey*@paramrequest*/publicsynchronizedRenderedImagegetTile(MetaTileKeykey,GetMapRequestrequest){CacheElementce=(CacheElement)tileCache.get(key);
if(ce==null){returnnull;
if(CRS.getAxisOrder(request.getCrs())==AxisOrder.NORTH_EAST){bbox=newEnvelope(bbox.getMinY(),bbox.getMaxY(),bbox.getMinX(),bbox.getMaxX());
ifanythingchangeswejustwipeoutthecache.themapkey//containsastringwithpartofthemaprequestwherethelayer//nameisincluded,butwewouldhavetoparseitandconsider//alsothatthenamespacemaybemissinginthegetmaprequesttileCache.clear();
if(total==null){total=re;
else{total.expandToInclude(re);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Writingtiffimage...");
if(imageinstanceofPlanarImage){Mapproperties=gc.getProperties();
if(properties==null){properties=newHashMap();
if(property!=null){CoverageUtilities.setNoDataProperty(properties,property);gc=factory.create(gc.getName(),gc.getRenderedImage(),gc.getEnvelope(),gc.getSampleDimensions(),null,properties);
if(imageOutStream==null){thrownewServiceException("UnabletocreateImageOutputStream.");
if(LOGGER.isLoggable(Level.FINEST))LOGGER.log(Level.FINEST,"Unabletoproperlycloseoutputstream",e);
if(writer!=null)writer.dispose();
if(LOGGER.isLoggable(Level.FINEST))LOGGER.log(Level.FINEST,"Unabletoproperlydisposewriter",e);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Writingtiffimagedone!");
iftherearealready<code>queueSize</code>*requestsrunning.Unlike{@linkSimpleThreadBlocker}herethreadsthatgotblockedduetofull*queuewillbeawakeninpriorityorder,highesttolowest*/publicclassPriorityThreadBlockerimplementsThreadBlocker{staticfinalLoggerLOGGER=Logging.getLogger(PriorityThreadBlocker.class);privatefinalPriorityProviderpriorityProvider;privatefinalintmaxRunningRequests;//unliketheSimpleThreadBlockthisdoesnotcontaintherequeststhatwerefreedtogoonto//thenext//controllerorexecution,buttheonesblockedwaitingprivatefinalPriorityQueue<WaitToken>queue=newPriorityQueue<>();//Thisholdstherequestsactuallyrunningonthisblocker.Flowcontrollers//mightnotallbecalled
ifonefails,butallgeta"requestComplete"forcleanup,//soneedtoknow
ifthisblockerwascalledbefore,ornotprivatefinalSet<Request>runningQueue=newHashSet<>();publicPriorityThreadBlocker(intqueueSize,PriorityProviderpriorityProvider){this.maxRunningRequests=queueSize;this.priorityProvider=priorityProvider;
if(runningQueue.size()<maxRunningRequests){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.log(Level.FINER,"Runningrequestsat"+runningQueue.size()+",noblock");
else{intpriority=priorityProvider.getPriority(request);
if(LOGGER.isLoggable(Level.FINER)){LOGGER.log(Level.FINER,"Runningrequestsat"+runningQueue.size()+",Queuingrequestwith"+"priority"+priority);
ifthisrequestenteredthequeue,waitforthelatchtobereleased
if(token!=null){
if(timeout>0){result=token.latch.await(timeout,TimeUnit.MILLISECONDS);synchronized(this){//
iftimeoutout,justremovefromthequeue
if(!result){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.log(Level.FINER,"Requestwithpriority"+token.priority+"timedout,removing"+"from"+"queue");
if(!removed){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.log(Level.FINER,"Requestwasnotfoundinqueue,releasingnext");
if(runningQueue.size()<maxRunningRequests){releaseNext();
else{token.latch.await();result=true;
if(runningQueue.size()<maxRunningRequests){releaseNext();
if(token!=null){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.log(Level.FINER,"Releasingrequestwithpriority"+token.priority);
if(diff!=0){returndiff;
else{//incaseofsamepriority,firstcomefirstservedreturnLong.signum(this.created-o.created);
if(Character.isLowerCase(startChar)){
if(memberName.length()>1){returnCharacter.toUpperCase(startChar)+memberName.substring(1);
else{returnString.valueOf(Character.toUpperCase(startChar));
else{returnmemberName;
if(fieldName.length()>1){returnCharacter.toLowerCase(startChar)+fieldName.substring(1);
else{returnString.valueOf(Character.toLowerCase(startChar));
if(inputStream.available()==0){Utils.debug(LOGGER,"Echoparametersfileseemstobeempty.");returnnewArrayList<>();
if(echoParameters.get(i).getId().equals(echoParameter.getId())){echoParameters.set(i,echoParameter);exists=true;
if(!exists){echoParameters.add(echoParameter);
if(value!=null){output.writeAttribute(name,value.toString());
if(!qName.equalsIgnoreCase("EchoParameter")){return;
if(attributeValue==null){Utils.debug(LOGGER,"Echoparameterattribute%sisNULL.",attributeName);return;
if(config.isDefault()){error(newParamResourceModel("deleteError",getPage()).getString());addFeedbackPanels(target);return;
if(layer.getBlobStoreId()!=null){
if(ids.contains(layer.getBlobStoreId())){assignedLayers.add(layer.getName());
if(assignedLayers.size()>0){dialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){privatestaticfinallongserialVersionUID=5257987095800108993L;privateStringerror=null;@OverrideprotectedComponentgetContents(Stringid){StringBuildersb=newStringBuilder();sb.append(newParamResourceModel("confirmDeleteDialog.content",getPage()).getString());for(StringlayerName:assignedLayers){sb.append("\n&nbsp;&nbsp;");sb.append(escapeHtml(layerName));
if(error!=null){error(error);addFeedbackPanels(target);
else{target.add(blobStoresPanel);
else{try{GWC.get().removeBlobStores(ids);
if(property==BlobStoresProvider.ID){returnnewSimpleAjaxLink<BlobStoreInfo>(id,itemModel,property.getModel(itemModel)){privatestaticfinallongserialVersionUID=1L;@OverrideprotectedvoidonClick(AjaxRequestTargettarget){setResponsePage(newBlobStorePage(blobStore));
else
if(property==BlobStoresProvider.DEFAULT){
if(blobStore.isDefault()){returnnewIcon(id,CatalogIconFactory.ENABLED_ICON);
else{returnnewLabel(id,"");
else
if(property==BlobStoresProvider.ENABLED){
if(blobStore.isEnabled()){returnnewIcon(id,CatalogIconFactory.ENABLED_ICON);
else{returnnewLabel(id,"");
else
if(property==BlobStoresProvider.TYPE){returnnewLabel(id,BlobStoreTypes.getFromClass(blobStore.getClass()).toString());
if(domainSubset==null){domainSubset=Wcs11Factory.eINSTANCE.createDomainSubsetType();wcs111GetCoverage.setDomainSubset(domainSubset);
if("1.1.1".equals(version)){Encoderencoder=newEncoder(neworg.geotools.wcs.v1_1.WCSConfiguration());encoder.setIndenting(true);encoder.setOmitXMLDeclaration(true);//prefixissetto'null'
ifwedon'tdeclareitexplicitlyencoder.getNamespaces().declarePrefix("ows","http://www.opengis.net/ows/1.1");returnencoder.encodeAsString(wcs111GetCoverage,org.geotools.wcs.v1_1.WCS.GetCoverage);
else{Encoderencoder=newEncoder(newWCSConfiguration());encoder.setIndenting(true);encoder.setOmitXMLDeclaration(true);returnencoder.encodeAsString(getCoverageType,WCS.GetCoverage);
if(storeId!=null){StoreInfostore=getCatalog().getStore(storeId,StoreInfo.class);storeName.setDefaultModelObject(store.getName());
if(property==NewLayerPageProvider.NAME){returnnewLabel(id,property.getModel(itemModel));
else
if(property==NewLayerPageProvider.PUBLISHED){finalResourceresource=itemModel.getObject();finalCatalogIconFactoryicons=CatalogIconFactory.get();
if(resource.isPublished()){PackageResourceReferenceicon=icons.getEnabledIcon();Fragmentf=newFragment(id,"iconFragment",selectLayers);f.add(newImage("layerIcon",icon));returnf;
else{returnnewLabel(id);
else
if(property==NewLayerPageProvider.ACTION){finalResourceresource=itemModel.getObject();
if(resource.isPublished()){returnresourceChooserLink(id,itemModel,newParamResourceModel("publishAgain",this));
else{returnresourceChooserLink(id,itemModel,newParamResourceModel("publish",this));
else{thrownewIllegalArgumentException("Don'tknowofproperty"+property.getName());
if(storeId!=null){StoreInfostore=getCatalog().getStore(storeId,StoreInfo.class);updateSpecialFunctionPanels(store);
if(stores.getModelObject()!=null){StoreInfostore=(StoreInfo)stores.getModelObject();NewLayerPage.this.storeId=store.getId();provider.setStoreId(store.getId());storeName.setDefaultModelObject(store.getName());selectLayers.setVisible(true);//makesurewecanactuallylistthecontents,itmayhappen//thestoreisactuallyunreachable,inthatcasewe//wanttodisplayanerrormessagetry{provider.getItems();
else{selectLayers.setVisible(false);createTypeContainer.setVisible(false);
ifstoreisnota//DataStoreInfocreateSQLViewContainer.setVisible(false);createCascadedWFSStoredQueryContainer.setVisible(false);
if(storeinstanceofDataStoreInfo){try{DataAccess<?,?>da=((DataStoreInfo)store).getDataStore(null);
if(dainstanceofWrapper){try{da=((Wrapper)da).unwrap(DataAccess.class);
if(dainstanceofWFSDataStore){createCascadedWFSStoredQueryContainer.setVisible(((WFSDataStore)da).supportsStoredQueries());
if(storeinstanceofCoverageStoreInfo){createCoverageViewContainer.setVisible(true);
ifstoreisnota//resettodefaultfirst,toavoidthecontainerbeingdisplayed
ifstoreisnota//WMSStoreInfocreateWMSLayerImportContainer.setVisible(false);//WMSStoreInfocreateWMTSLayerImportContainer.setVisible(false);
if(storeinstanceofWMTSStoreInfo){try{WebMapTileServerwmts=((WMTSStoreInfo)store).getWebMapTileServer(null);createWMTSLayerImportContainer.setVisible(wmts!=null);
else
if(storeinstanceofWMSStoreInfo){try{WebMapServerwms=((WMSStoreInfo)store).getWebMapServer(null);createWMSLayerImportContainer.setVisible(wms!=null);
if(storeinstanceofDataStoreInfo){DataStoreInfodstore=(DataStoreInfo)store;expandedStore=getCatalog().getResourcePool().clone(dstore,true);
else
if(storeinstanceofCoverageStoreInfo){CoverageStoreInfocstore=(CoverageStoreInfo)store;expandedStore=getCatalog().getResourcePool().clone(cstore,true);
else
if(storeinstanceofWMSStoreInfo){WMSStoreInfowmsInfo=(WMSStoreInfo)store;expandedStore=getCatalog().getResourcePool().clone(wmsInfo,true);
else
if(storeinstanceofWMTSStoreInfo){WMTSStoreInfowmsInfo=(WMTSStoreInfo)store;expandedStore=getCatalog().getResourcePool().clone(wmsInfo,true);
if(expandedStoreinstanceofCoverageStoreInfo){CoverageInfoci=builder.buildCoverage(resource.getName().getLocalPart());returnbuilder.buildLayer(ci);
else
if(expandedStoreinstanceofDataStoreInfo){FeatureTypeInfofti=builder.buildFeatureType(resource.getName());returnbuilder.buildLayer(fti);
else
if(expandedStoreinstanceofWMTSStoreInfo){WMTSLayerInfowli=builder.buildWMTSLayer(resource.getLocalName());returnbuilder.buildLayer(wli);
else
if(expandedStoreinstanceofWMSStoreInfo){WMSLayerInfowli=builder.buildWMSLayer(resource.getLocalName());returnbuilder.buildLayer(wli);
if(expandedStore==null)thrownewIllegalArgumentException("Storeismissingfromconfiguration!");
elsethrownewIllegalArgumentException("Don'tknowhowtodealwiththisstore"+expandedStore);
ifnone*wasprovidedduringconstruction*/StringgetSelectedStoreId(){//theproviderisalwaysuptodatereturnprovider.getStoreId();
if(infoinstanceofToolLinkInfo){finalToolLinkInfotool=(ToolLinkInfo)info;link=newBookmarkablePageLink("theLink",tool.getComponentClass());
else{finalToolLinkExternalInfotool=(ToolLinkExternalInfo)info;link=newExternalLink("theLink",tool.getHref());
ifneededforspecificOWSusetoincludeadditionalmetadataforeachtypeofinformation.ThistypeshallnotberestrictedforaspecificOWStochangethemultiplicity(oroptionality)ofsomeelements.&lt;/documentation&gt;*&lt;/annotation&gt;*&lt;sequence&gt;*&lt;elementminOccurs="0"ref="ows:Title"/&gt;*&lt;elementminOccurs="0"ref="ows:Abstract"/&gt;*&lt;elementmaxOccurs="unbounded"minOccurs="0"ref="ows:Keywords"/&gt;*&lt;/sequence&gt;*&lt;/complexType&gt;**</code>*</pre>**@generated*/publicclassDescriptionTypeBindingextendsAbstractComplexBinding{Ows10Factoryowsfactory;publicDescriptionTypeBinding(Ows10Factoryowsfactory){this.owsfactory=owsfactory;
ifnone.*/protectedURLgetDefinitionsURL(){Stringcust_proj_file=System.getProperty(SYSTEM_DEFAULT_USER_PROJ_FILE);
if(cust_proj_file==null){GeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);
if(loader!=null){//NotavailableforSystemTestDataResourcecustom_proj=loader.get("user_projections/netcdf.projections.properties");
if(custom_proj.getType()==Type.RESOURCE){cust_proj_file=custom_proj.file().getAbsolutePath();
if(cust_proj_file!=null){Fileproj_file=newFile(cust_proj_file);
if(proj_file.exists()){URLurl=URLs.fileToUrl(proj_file);
if(url!=null){returnurl;
else{LOGGER.log(Level.SEVERE,"Hadtroublesconverting"+cust_proj_file+"toURL");
if(service==null){thrownewIllegalArgumentException("Provideduser/groupservicedoesnotexist:"+serviceName);
else{returnsecurityManager.loadUserGroupService(serviceName);
if(service==null){thrownewIllegalArgumentException("Provideduser/groupservicedoesnotexist:"+serviceName);
else
if(service.canCreateStore()){returnsecurityManager.loadUserGroupService(serviceName).createStore();
else{thrownewIOException("ProvidedUserGroupServiceisread-only.");
if(user==null){thrownewIllegalArgumentException("Providedusernamedoesnotexist:"+userName);
if(group==null){thrownewIllegalArgumentException("Providedgroupnamedoesnotexist:"+groupName);
ifaproblemis*encountered.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:attribute&gt;*&lt;/xsd:complexType&gt;**</code>*</pre>**@generated*/publicclassNativeTypeBindingextendsAbstractComplexBinding{WfsFactorywfsfactory;publicNativeTypeBinding(WfsFactorywfsfactory){this.wfsfactory=wfsfactory;
if(instance.getText()!=null&&instance.getText().length()!=0){nativ.setValue(instance.getText());
if(getNestedFilters().isEmpty()){/**Createmetadatafilter*/MetadataGeneratorgenerator=newMetadataGenerator();generator.setEntityId(authConfig.getEntityId());generator.setIncludeDiscoveryExtension(false);generator.setKeyManager(newEmptyKeyManager());generator.setRequestSigned(false);generator.setWantAssertionSigned(authConfig.getWantAssertionSigned());ExtendedMetadataem=newExtendedMetadata();em.setRequireLogoutRequestSigned(false);generator.setExtendedMetadata(em);MetadataGeneratorFiltermetadataGeneratorFilter=newMetadataGeneratorFilter(generator);/**Createmetadataprovider*/ParserPoolparserPool=context.getBean(ParserPool.class);HttpClientParamsclientParams=newHttpClientParams();clientParams.setSoTimeout(5000);HttpClienthttpClient=newHttpClient(clientParams);httpClient.getHttpConnectionManager().getParams().setConnectionTimeout(5000);HTTPMetadataProviderpro=newHTTPMetadataProvider(newTimer(true),httpClient,authConfig.getMetadataURL());pro.setParserPool(parserPool);/**UsethistopassmetadatastringStringxml=*"<?xmlversion=\"1.0\"?><EntityDescriptorxmlns=\"urn:oasis:names:tc:SAML:2.0:metadata\"entityID=\"https://app.onelogin.com/saml/metadata/575443\"><IDPSSODescriptorxmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"protocolSupportEnumeration=\"urn:oasis:names:tc:SAML:2.0:protocol\"><KeyDescriptoruse=\"signing\"><ds:KeyInfoxmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"><ds:X509Data><ds:X509Certificate>MIIEHTCCAwWgAwIBAgIUIYlArFxWB1C7BX6q/mFytCIYeI8wDQYJKoZIhvcNAQEFBQAwWjELMAkGA1UEBhMCVVMxEzARBgNVBAoMCmNvZGVzdHVkaW8xFTATBgNVBAsMDE9uZUxvZ2luIElkUDEfMB0GA1UEAwwWT25lTG9naW4gQWNjb3VudCA4ODk4ODAeFw0xNjA4MDMxMDUyNTNaFw0yMTA4MDQxMDUyNTNaMFoxCzAJBgNVBAYTAlVTMRMwEQYDVQQKDApjb2Rlc3R1ZGlvMRUwEwYDVQQLDAxPbmVMb2dpbiBJZFAxHzAdBgNVBAMMFk9uZUxvZ2luIEFjY291bnQgODg5ODgwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDWKHu+QvLa9BvqL6OoKKMVMBY0deHU6xqPAoatxiGlNIazoK8TPY5srjRX18W4aOb9In3zEulipGfNaQ0Avj/Jhi1UbS9lJMVNNODZ0dzfkJhIlpkGz7+totPf5P1BdUBTNk7OpguDLsb5DXKm5ZhGSDzMgGGNDNdOEZpJJ1zVjskUkmR2frea+ZcpMkNa9CB6Jf6d6oE2BNhW94d1F4N5KB0NbmFonzLa3N5vRHstM88DbFSOUM7N9SRf+8Jnviae7fcG12woE+25G4qB1wJ1rfIu9wL7JhiXLPA7FB4L4bRglXZsVin9sY93QyUmrv8kxNrtwLXnQopu0myfG3CXAgMBAAGjgdowgdcwDAYDVR0TAQH/BAIwADAdBgNVHQ4EFgQUvz2fdMwH1G1W8bbcAWN238szW34wgZcGA1UdIwSBjzCBjIAUvz2fdMwH1G1W8bbcAWN238szW36hXqRcMFoxCzAJBgNVBAYTAlVTMRMwEQYDVQQKDApjb2Rlc3R1ZGlvMRUwEwYDVQQLDAxPbmVMb2dpbiBJZFAxHzAdBgNVBAMMFk9uZUxvZ2luIEFjY291bnQgODg5ODiCFCGJQKxcVgdQuwV+qv5hcrQiGHiPMA4GA1UdDwEB/wQEAwIHgDANBgkqhkiG9w0BAQUFAAOCAQEANkaO/xJag1n93l+6/sblcG/1Oi3/hI19+lp0PU26kFtkrpzfjE4QugBgnGXkeJ/MU6abk650uh+7yLqkY15Gm9Lsk0XiH1k7vWWnQl12Yj0uwCY47baBLw0lMCl5vNaJcULicAM715W3d2oHptnhftePShyHHD69Z4e+UduuClbXjSxPNB9zTOsLYRVbrX+fIFm1AK8bWcmrH/jAuj7pWP7hRJdT3jG5N7LNb4th3Ojj47NksjaPo2nOuydZvyoL2CJ/E2qJeW78V6oqXCB3D/XVIWWdUmYMNNmXksT9MJCtZWvnV3OmdYbyZjOK2bJK7fbVgm/gwpeBSY+pquMGAA==</ds:X509Certificate></ds:X509Data></ds:KeyInfo></KeyDescriptor><SingleLogoutServiceBinding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect\"Location=\"https://codestudio-dev.onelogin.com/trust/saml2/http-redirect/slo/575443\"/><NameIDFormat>urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress</NameIDFormat><SingleSignOnServiceBinding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect\"Location=\"https://codestudio-dev.onelogin.com/trust/saml2/http-redirect/sso/575443\"/><SingleSignOnServiceBinding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST\"Location=\"https://codestudio-dev.onelogin.com/trust/saml2/http-post/sso/575443\"/><SingleSignOnServiceBinding=\"urn:oasis:names:tc:SAML:2.0:bindings:SOAP\"Location=\"https://codestudio-dev.onelogin.com/trust/saml2/soap/sso/575443\"/><SingleLogoutServiceLocation=\"https://codestudio-dev.onelogin.com/trust/saml2/http-redirect/slo/575443\"Binding=\"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect\"/></IDPSSODescriptor><ContactPersoncontactType=\"technical\"><SurName>Support</SurName><EmailAddress>support@onelogin.com</EmailAddress></ContactPerson></EntityDescriptor>"*;DocumentBuilderFactorydbf=DocumentBuilderFactory.newInstance();dbf.setNamespaceAware(true);DocumentBuilderdb=*dbf.newDocumentBuilder();Documentdoc=db.parse(newByteArrayInputStream(xml.getBytes("UTF-8")));**DOMMetadataProviderpro=newDOMMetadataProvider(doc.getDocumentElement());pro.setParserPool(parserPool);pro.initialize();*/ExtendedMetadataDelegateemd=newExtendedMetadataDelegate(pro,em);/**Setmetadataproviderandaddfiltertochain*/MetadataManagermetadata=context.getBean(MetadataManager.class);metadata.addMetadataProvider(emd);metadata.refreshMetadata();metadataGeneratorFilter.setManager(metadata);getNestedFilters().add(metadataGeneratorFilter);
else{LOGGER.log(Level.FINE,"Metadatafilteralreadyadded");
ifwegotthecorrecteventassertThat(messages.size(),is(1));List<CatalogEvent>layerGroupAddEvent=getMessagesForHandler(messages,CATALOG_ADD_EVENT_HANDLER_KEY,addEventHandler);assertThat(layerGroupAddEvent.size(),is(1));assertThat(layerGroupAddEvent.get(0).getSource(),instanceOf(LayerGroupInfo.class));LayerGroupInfolayerGroup=(LayerGroupInfo)layerGroupAddEvent.get(0).getSource();CatalogUtils.localizeLayerGroup(layerGroup,getCatalog());//checkingthepublishedlayergroupassertThat(layerGroup.getName(),is(TEST_LAYER_GROUP_NAME));List<PublishedInfo>content=layerGroup.getLayers();assertThat(content.size(),is(2));//checkingthatthelayergroupcontainsthecorrectlayersfor(PublishedInfoitem:content){assertThat(item,instanceOf(LayerInfo.class));LayerInfolayer=(LayerInfo)item;assertThat(layer.getName(),anyOf(is(MockData.ROAD_SEGMENTS.getLocalPart()),is(MockData.BRIDGES.getLocalPart())));FeatureTypeInforesource=(FeatureTypeInfo)layer.getResource();//checkthatthetransientcatalogvariablehasinitiatedproperlyassertThat(resource.getStore().getCatalog(),notNullValue());
if(layerGroup!=null){//thetestlayergroupexistssolet'sremoveitcatalog.remove(layerGroup);
if(backupFacade.getBackupExecutions().get(jobExecution.getId())!=null){this.backupExecution=backupFacade.getBackupExecutions().get(jobExecution.getId());
else{Longid=null;BackupExecutionAdapterbkp=null;for(Entry<Long,BackupExecutionAdapter>entry:backupFacade.getBackupExecutions().entrySet()){id=entry.getKey();bkp=entry.getValue();
if(bkp.getJobParameters().getLong(Backup.PARAM_TIME).equals(jobExecution.getJobParameters().getLong(Backup.PARAM_TIME))){break;
else{id=null;bkp=null;
if(bkp!=null){ResourcearchiveFile=bkp.getArchiveFile();booleanoverwrite=bkp.isOverwrite();List<String>options=bkp.getOptions();Filterfilter=bkp.getFilter();this.backupFacade.getBackupExecutions().remove(id);this.backupExecution=newBackupExecutionAdapter(jobExecution,backupFacade.getTotalNumberOfBackupSteps());this.backupExecution.setArchiveFile(archiveFile);this.backupExecution.setOverwrite(overwrite);this.backupExecution.setFilter(filter);this.backupExecution.getOptions().addAll(options);this.backupFacade.getBackupExecutions().put(jobExecution.getId(),this.backupExecution);
if(jobExecution.getStatus()!=BatchStatus.STOPPED){LOGGER.fine("ExecutionsStepSummaries:"+backupFacade.getJobOperator().getStepExecutionSummaries(executionId));LOGGER.fine("ExecutionsParameters:"+backupFacade.getJobOperator().getParameters(executionId));LOGGER.fine("ExecutionsSummary:"+backupFacade.getJobOperator().getSummary(executionId));
if(jobExecution.getStatus()==BatchStatus.COMPLETED){JobParametersjobParameters=backupExecution.getJobParameters();ResourcesourceFolder=Resources.fromURL(jobParameters.getString(Backup.PARAM_OUTPUT_FILE_PATH));//CleanupTemporaryResourcesStringcleanUpTempFolders=jobParameters.getString(Backup.PARAM_CLEANUP_TEMP);
if(cleanUpTempFolders!=null&&Boolean.parseBoolean(cleanUpTempFolders)&&sourceFolder!=null){
if(Resources.exists(sourceFolder)){try{
if(!sourceFolder.delete()){LOGGER.warning("ItwasnotpossibletocleanupTemporaryResources.PleasedoublecheckthatResourcesinsidetheTempGeoServerDataDirectoryhavebeenremoved.");
if(!bestEffort){this.backupExecution.addFailureExceptions(Arrays.asList(e));thrownewRuntimeException(e);
else{this.backupExecution.addWarningExceptions(Arrays.asList(e));
if(testSwitchToNewRole){form.submit("roles:addRole");tester.assertRenderedPage(NewRolePage.class);tester.clickLink("form:cancel");tester.assertRenderedPage(NewDataAccessRulePage.class);form=tester.newFormTester("form",false);
if(MockData.CITE_PREFIX.equals(rule.getRoot())&&MockData.STREAMS.getLocalPart().equals(rule.getLayer())&&AccessMode.READ.equals(rule.getAccessMode())){foundRule=rule;break;
if(s.equals(searchValue))returnindex;index++;
if(remoteClient==null){LOGGER.log(Level.SEVERE,"CannotexecuteRemoteProcess["+name+"]sincetheRemoteClientisnotavailable!");thrownewException("CannotexecuteRemoteProcess["+name+"]sincetheRemoteClientisnotavailable!");
if(listener!=null){listener.exceptionOccurred(e);
ifnecessary
if(exception!=null){LOGGER.log(Level.SEVERE,"TheRemoteServiceassociatedtotheProcesswithpId["+pid+"]rasiedanExeption",exception);thrownewProcessException(exception);
iftheProcesshasbeencancelled
if(listener!=null&&listener.isCanceled()){LOGGER.log(Level.WARNING,"TheRemoteServiceassociatedtotheProcesswithpId["+pid+"]hasbeencancelled");thrownewProcessException("TheRemoteServiceassociatedtotheProcesswithpId["+pid+"]hasbeencancelled");
if(pId.equals(pid)){listener.progress(progress.floatValue());
if(listener.isCanceled()){doneSignal.countDown();
if(pId.equals(pid)){listener.complete();try{this.outputs=(Map<String,Object>)outputs;
if(pId!=null&&pId.equals(pid)){listener.exceptionOccurred(cause);exception=cause;running=false;
else
if(metadata!=null){booleanmetadataIsEqual=true;for(Entry<String,Object>entry:metadata.entrySet()){
if(!this.metadata.containsKey(entry.getKey())||this.metadata.get(entry.getKey())!=entry.getValue()){metadataIsEqual=false;break;
if(metadataIsEqual){listener.exceptionOccurred(cause);exception=cause;running=false;
if(d!=null){returnd.toString();
ifcan't*convert.*/protectedParameter<?>param(Stringname,Objecto){
if(oinstanceofParameter){return(Parameter)o;
if(oinstanceofMap){Mapm=(Map)o;InternationalStringtitle=null,desc=null;booleanrequired=true;intmin=1,max=1;Objectsample=null;
if(m.containsKey("title")){title=newSimpleInternationalString((String)m.get("title"));
if(m.containsKey("description")){desc=newSimpleInternationalString((String)m.get("description"));
else{desc=title;
if(m.containsKey("required")){required=(Boolean)m.get("required");
if(m.containsKey("min")){min=(Integer)m.get("min");
if(m.containsKey("max")){max=(Integer)m.get("max");
if(sampleValue!=null&&sampleValue.length()>MAX_SAMPLE_LENGTH){sampleValue=sampleValue.substring(0,MAX_SAMPLE_LENGTH-3)+"...";
if(securityManager.isEncryptingUrlParams()){returncryptoMapper;
else{returnplainMapper;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;AccessLimitsother=(AccessLimits)obj;
if(mode==null){
if(other.mode!=null)returnfalse;
else
if(!mode.equals(other.mode))returnfalse;returntrue;}}
if((Boolean)getDefaultModelObject()){SortedSet<GeoServerRole>roles=GeoServerApplication.get().getSecurityManager().getActiveRoleService().getRolesForUser(object.getUsername());buffer.append("[");for(GeoServerRolerole:roles){buffer.append(role.getAuthority());buffer.append("");
if(buffer.length()>0){//removelastdelimiterbuffer.setLength(buffer.length()-1);
if("DescribeFeatureType".equalsIgnoreCase(operation.getId())){returntrue;
if(maxFeatures<=0){thrownewIllegalArgumentException("Themaxfeaturesretrievedbyaquerylayer"+"functionmustbeapositivenumber");
if(!isInitialized()){returnnull;
if(QUERY_SINGLE.equals(name)){returnnewQueryFunction(QUERY_SINGLE,catalog,args,fallback,true,1);
else
if(QUERY_COLLECTION.equals(name)){returnnewQueryFunction(QUERY_COLLECTION,catalog,args,fallback,false,maxFeatures);
else
if(COLLECT_GEOMETRIES.equals(name)){returnnewCollectGeometriesFunction(COLLECT_GEOMETRIES,args,fallback,maxCoordinates);
else{returnnull;
if(isInitialized()){returnfunctionNames;
else{returnCollections.emptyList();
if(catalog==null){LOGGER.log(Level.INFO,"Lookingforfunctionsbutthecatalogstill"+"hasnotbeensetintoQueryLayerFunctionFactory");returnfalse;
else{returntrue;
if(buildingsStyle==null){//undotherenameperformedinoneofthetestmethodsStyleInfosi=catalog.getStyleByName("BuildingsNew");
if(si!=null){si.setName(MockData.BUILDINGS.getLocalPart());catalog.save(si);
if(!isRootLayer){WMSInfoserviceInfo=WMS.get().getServiceInfo();List<AuthorityURLInfo>rootLayerAuthorities=serviceInfo.getAuthorityURLs();identifiersEditor.setBaseAuthorities(rootLayerAuthorities);
if(stale){stale=false;returntrue;
else{returnfalse;
if(link==null){link=newArrayList<LinkType>();
ifversionisnotprovided");
ifthewrongversionisrequested");
ifnolayerisrequested");
if"purge"issettofalsethis.getTestData().addWorkspace("shouldNotBeDeleted","http://snbd",getCatalog());
if(restoreExecution.getStatus()==BatchStatus.ABANDONED||restoreExecution.getStatus()==BatchStatus.FAILED||restoreExecution.getStatus()==BatchStatus.UNKNOWN){for(Throwableexception:restoreExecution.getAllFailureExceptions()){LOGGER.log(Level.INFO,"ERROR:"+exception.getLocalizedMessage(),exception);exception.printStackTrace();
if(nested!=null){cat.remove(nested);
if(lg.getBounds().getCoordinateReferenceSystem()instanceofGeographicCRS){//flipdoubletmp=minx;minx=miny;miny=tmp;tmp=maxx;maxx=maxy;maxy=tmp;
if(this.hints!=null&&this.hints.containsKey(Hints.GRID_COVERAGE_FACTORY)){finalObjectfactory=this.hints.get(Hints.GRID_COVERAGE_FACTORY);
if(factory!=null&&factoryinstanceofGridCoverageFactory){this.coverageFactory=(GridCoverageFactory)factory;
if(this.coverageFactory==null){this.coverageFactory=CoverageFactoryFinder.getGridCoverageFactory(this.hints);
if(parameters!=null){ggParameter=Arrays.stream(parameters).filter(parameter->parameter.getDescriptor().getName().equals(AbstractGridFormat.READ_GRIDGEOMETRY2D.getName())).findFirst();
if(ggParameter.isPresent()){ParameterValuevalue=(ParameterValue)ggParameter.get();requestedGridGeometry=(GridGeometry2D)value.getValue();ReferencedEnveloperequestedEnvelope=ReferencedEnvelope.reference(requestedGridGeometry.getEnvelope());ReferencedEnvelopedataEnvelope=ReferencedEnvelope.reference(handler.getOriginalEnvelope());
if(CRS.equalsIgnoreMetadata(requestedEnvelope,dataEnvelope)){
if(!requestedEnvelope.intersects((BoundingBox)dataEnvelope)){returnnull;
else{ReferencedEnvelopere84;try{re84=requestedEnvelope.transform(DefaultGeographicCRS.WGS84,true);ReferencedEnvelopede84=dataEnvelope.transform(DefaultGeographicCRS.WGS84,true);
if(!re84.intersects((BoundingBox)de84)){returnnull;
iftherequestedBBOXintersectsthe"+"dataone,continuing",e);
ifweareintheheterogeneouscase...it'saresampling//onesimilartoreprojection,pronetooff-by-oneissuesattheborders
if(!handler.isHomogeneousCoverages()){GridEnvelope2Drange=requestedGridGeometry.getGridRange2D();GridEnvelope2DexpandedRange=newGridEnvelope2D((int)range.getMinX()-HETEROGENEOUS_RASTER_GUTTER,(int)range.getMinY()-HETEROGENEOUS_RASTER_GUTTER,(int)range.getWidth()+HETEROGENEOUS_RASTER_GUTTER*2,(int)range.getHeight()+HETEROGENEOUS_RASTER_GUTTER*2);GridGeometry2DexpandedGG=newGridGeometry2D(expandedRange,requestedGridGeometry.getGridToCRS(),requestedGridGeometry.getCoordinateReferenceSystem());value.setValue(expandedGG);
ifBANDSparamhasbeendefinedArrayList<Integer>selectedBandIndices=newArrayList<Integer>();for(intm=0;m<coverageBandsSize;m++){selectedBandIndices.add(m);
if(parameters!=null){for(inti=0;i<parameters.length;i++){finalParameterValueparam=(ParameterValue)parameters[i];
if(AbstractGridFormat.BANDS.getName().equals(param.getDescriptor().getName())){int[]bandIndicesParam=(int[])param.getValue();
if(bandIndicesParam!=null){selectedBandIndices=newArrayList<Integer>();for(intbIdx=0;bIdx<bandIndicesParam.length;bIdx++){selectedBandIndices.add(bandIndicesParam[bIdx]);
if(!inputCoverages.containsKey(coverageName)){GridCoverage2DReaderreader=SingleGridCoverage2DReader.wrap(delegate,coverageName);//Removethiswhenremovingconstraints
if(checker==null){checker=newCoveragesConsistencyChecker(reader,canSupportHeterogeneousCoverages);
else{checker.checkConsistency(reader);
if(parameters!=null){//creatingacopyofparametersexcludingthebandsparameterfilteredParameters=Arrays.stream(parameters).filter(parameter->!parameter.getDescriptor().getName().equals(AbstractGridFormat.BANDS.getName())).toArray(GeneralParameterValue[]::new);
if(coverage==null){
if(handler.isHomogeneousCoverages()||handler.getEnvelopeCompositionType()==EnvelopeCompositionType.INTERSECTION){returnnull;
else{nonNullCoverages++;
if(dynamicAlphaSource==null&&hasDynamicAlpha(coverage,reader)){dynamicAlphaSource=coverage;
if(nonNullCoverages==0||inputCoverages.isEmpty()){returnnull;
if(nonNullCoverages<inputCoverages.size()){floatwidth,height;
if(requestedGridGeometry!=null){GridEnvelope2Drange=requestedGridGeometry.getGridRange2D();width=(float)range.getWidth();height=(float)range.getHeight();
else{GridCoverage2Dreference=inputCoverages.values().stream().filter(c->c!=null).findFirst().get();RenderedImageri=reference.getRenderedImage();width=ri.getWidth();height=ri.getHeight();
if(mBand==null){//CreateatemporaryCoverageBand,touselaterforSelectSampleDimension//operationsmBand=newCoverageBand();mBand.setInputCoverageBands(bands.get(selectedBandIndices.get(idx)).getInputCoverageBands());
if(idx+1<selectedBandIndices.size()&&bands.get(selectedBandIndices.get(idx+1)).getInputCoverageBands().get(0).getCoverageName().equals(coverageName)){//Samecoverage,additsbandstothepreviousArrayList<InputCoverageBand>groupBands=newArrayList<InputCoverageBand>();groupBands.addAll(mBand.getInputCoverageBands());groupBands.addAll(bands.get(selectedBandIndices.get(idx+1)).getInputCoverageBands());mBand.setInputCoverageBands(groupBands);
else{mergedBands.add(mBand);mBand=null;
if(bandString!=null&&!bandString.isEmpty()){bandIdx=Integer.parseInt(bandString);
if(dynamicAlphaSource!=null&&mergedBands.size()==1&&(bandIndices.size()==1||bandIndices.size()==3)){finalintalphaBandIndex=getAlphaBandIndex(coverage);addAlphaColorModelHint(localHints,bandIndices.size());bandIndices.add(alphaBandIndex);
if(resolutionChooser.visit(coverage)){transformationChoice=index;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Readcoverage"+coverageName+",resulthasenvelope"+coverage.getEnvelope2D());
if(coverages.size()>1){//dynamicalphabutmorethanonesourceHintslocalHints=newHints(hints);
if(dynamicAlphaSource!=null){intcurrentBandCount=countBands(coverages);//andtheoutputissuitableforgettinganalphaband
if(currentBandCount==1||currentBandCount==3){finalintalphaBandIndex=getAlphaBandIndex(dynamicAlphaSource);GridCoverage2DalphaBandCoverage=retainBands(Arrays.asList(alphaBandIndex),dynamicAlphaSource,hints);coverages.add(alphaBandCoverage);addAlphaColorModelHint(localHints,currentBandCount);
if(!handler.isHomogeneousCoverages()){param.parameter("transform_choice").setValue("index");param.parameter("coverage_idx").setValue(transformationChoice);
else{//optimizeout,noneedtodoabandmergeresult=coverages.get(0);
if(currentBandCount==3){ColorSpacecs=ColorSpace.getInstance(ColorSpace.CS_sRGB);int[]nBits={8,8,8,8};returnnewComponentColorModel(cs,nBits,true,false,Transparency.TRANSLUCENT,DataBuffer.TYPE_BYTE);
else
if(currentBandCount==1){ColorSpacecs=ColorSpace.getInstance(ColorSpace.CS_GRAY);int[]nBits={8,8};returnnewComponentColorModel(cs,nBits,true,false,Transparency.TRANSLUCENT,DataBuffer.TYPE_BYTE);
else{thrownewIllegalArgumentException("Cannotcreateacolormodelwithalpha"+"supportstartingwith"+currentBandCount+"bands");
if(!cm.hasAlpha()||cm.getNumComponents()==cm.getNumColorComponents()){thrownewIllegalArgumentException("Thesourcecoveragedoesnothaveanalphaband,cannotextractan"+"alphaband");
if(cm.getNumColorComponents()==1){//gray-alphareturn1;
else{//rgba/argbreturn3;
ifareaderaddedaalphachannelontheflyasaresultofareadparameter.Wewant*topreservethisalphachannelbecausetheusernevergotachancetoselectitspresencein*theoutput(e.g.footprintmanagementinmosaic)**@paramcoverage*@paramreader*@return*@throwsIOException*/privatebooleanhasDynamicAlpha(GridCoverage2Dcoverage,GridCoverage2DReaderreader)throwsIOException{//check
ifwehaveanalphabandinthecoveragetostatwith
if(coverage==null){returnfalse;
if(!dynamicCm.hasAlpha()||!hasAlphaBand(dynamicCm)){returnfalse;
ifwedidnothaveoneintheoriginallayoutImageLayoutreaderLayout=reader.getImageLayout();
if(readerLayout==null){returnfalse;
if(nativeCm==null||nativeCm.hasAlpha()){returnfalse;
if(!this.coverageName.equalsIgnoreCase(coverageName)){thrownewIllegalArgumentException("ThespecifiedcoverageNameisn'ttheoneofthiscoverageView");
if(readerinstanceofStructuredGridCoverage2DReader){returnnewStructuredCoverageViewReader((StructuredGridCoverage2DReader)reader,coverageView,coverageInfo,hints);
else{returnnewCoverageViewReader(reader,coverageView,coverageInfo,hints);
ifthedelegatereaderdoesn'thaveit//already
if(!checkIfDelegateReaderSupportsBands()){delegateFormatParams.add(AbstractGridFormat.BANDS);
ifthedelegatereadersupportbandsselection.*/privatebooleancheckIfDelegateReaderSupportsBands(){List<GeneralParameterDescriptor>parameters=delegate.getFormat().getReadParameters().getDescriptor().descriptors();for(GeneralParameterDescriptorparameterDescriptor:parameters){
if(parameterDescriptor.getName().equals(AbstractGridFormat.BANDS.getName())){returntrue;
ifandadminGroupisdefined,therolescontainROLE_ADMINISTRATOR*/@TestpublicvoidtestAdminGroup()throwsException{Assume.assumeTrue(LDAPTestUtils.initLdapServer(true,ldapServerUrl,basePath));((LDAPSecurityServiceConfig)config).setUserDnPattern("uid={0},ou=People");config.setAdminGroup("other");createAuthenticationProvider();Authenticationresult=authProvider.authenticate(authenticationOther);booleanfoundAdmin=false;for(GrantedAuthorityauthority:result.getAuthorities()){
if(authority.getAuthority().equalsIgnoreCase("ROLE_ADMINISTRATOR")){foundAdmin=true;
ifandgroupAdminGroupisdefined,therolescontainROLE_GROUP_ADMIN*/@TestpublicvoidtestGroupAdminGroup()throwsException{Assume.assumeTrue(LDAPTestUtils.initLdapServer(true,ldapServerUrl,basePath));((LDAPSecurityServiceConfig)config).setUserDnPattern("uid={0},ou=People");config.setGroupAdminGroup("other");createAuthenticationProvider();Authenticationresult=authProvider.authenticate(authenticationOther);booleanfoundAdmin=false;for(GrantedAuthorityauthority:result.getAuthorities()){
if(authority.getAuthority().equalsIgnoreCase("ROLE_GROUP_ADMIN")){foundAdmin=true;
ifthereisacoloninthepassword*/@TestpublicvoidtestColonPassword()throwsException{Assume.assumeTrue(LDAPTestUtils.initLdapServer(true,ldapServerUrl,basePath,"data3.ldif"));((LDAPSecurityServiceConfig)config).setUserDnPattern("uid={0},ou=People");createAuthenticationProvider();authentication=newUsernamePasswordAuthenticationToken("colon","da:da");Authenticationresult=authProvider.authenticate(authentication);assertEquals(2,result.getAuthorities().size());
if(ev==null){thrownewIllegalArgumentException("Incomingobjectisnull");
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(this.getClass()+"isunabletosynchronizetheincomingevent:"+ev);throwe;
ifargumentsarenull*/privatestaticGeoServerInfolocalizeGeoServerInfo(finalGeoServergeoServer,finalJMSGlobalModifyEventev)throwsIllegalAccessException,InvocationTargetException,NoSuchMethodException{
if(geoServer==null||ev==null)thrownewIllegalArgumentException("Wrongpassedargumentsarenull");finalGeoServerInfolocalObject=geoServer.getGlobal();//LOCALIZEwithlocalobjectsfinalGeoServerInfodeserGeoServerInfo=ev.getSource();//overwriteallmembersBeanUtils.copyProperties(localObject,deserGeoServerInfo);org.geoserver.cluster.impl.utils.BeanUtils.smartUpdate(localObject,ev.getPropertyNames(),ev.getNewValues());localObject.setCoverageAccess(localizeCoverageAccessInfo(geoServer,deserGeoServerInfo.getCoverageAccess()));//localizeJAIlocalObject.setJAI(localizeJAIInfo(geoServer,deserGeoServerInfo.getJAI()));//localizesettingslocalObject.setSettings(localizeSettingsInfo(geoServer,deserGeoServerInfo.getSettings()));//localObject.setContact(localizeContactInfo(geoServer,//deserGeoServerInfo.getContact()));returnlocalObject;
ifargumentsarenull*/privatestaticJAIInfolocalizeJAIInfo(finalGeoServergeoServer,finalJAIInfodeserInfo)throwsIllegalAccessException,InvocationTargetException{
if(geoServer==null||deserInfo==null)thrownewIllegalArgumentException("Wrongpassedargumentsarenull");//getlocalinstancefinalJAIInfoinfo=geoServer.getGlobal().getJAI();//temporarilystoretyleCachereferencefinalTileCachesunTyleCache=info.getTileCache();//overwriteallmembersBeanUtils.copyProperties(info,deserInfo);//settylecacheusingstoredreferenceinfo.setTileCache(sunTyleCache);returninfo;
ifargumentsarenull*/privatestaticSettingsInfolocalizeSettingsInfo(finalGeoServergeoServer,finalSettingsInfodeserInfo)throwsIllegalAccessException,InvocationTargetException{
if(geoServer==null||deserInfo==null)thrownewIllegalArgumentException("Wrongpassedargumentsarenull");//getlocalinstancefinalSettingsInfoinfo=geoServer.getSettings();//overwriteallmembersBeanUtils.copyProperties(info,deserInfo);finalWorkspaceInfoworkspace=info.getWorkspace();
if(workspace!=null){info.setWorkspace(CatalogUtils.localizeWorkspace(workspace,geoServer.getCatalog()));
if(contact!=null){info.setContact(localizeContactInfo(geoServer,contact));
ifargumentsarenull*/privatestaticContactInfolocalizeContactInfo(finalGeoServergeoServer,finalContactInfodeserInfo)throwsIllegalAccessException,InvocationTargetException{
if(geoServer==null||deserInfo==null)thrownewIllegalArgumentException("Wrongpassedargumentsarenull");//getlocalinstancefinalContactInfoinfo=geoServer.getGlobal().getSettings().getContact();//overwriteallmembersBeanUtils.copyProperties(info,deserInfo);returninfo;
ifargumentsarenull*/privatestaticCoverageAccessInfolocalizeCoverageAccessInfo(finalGeoServergeoServer,finalCoverageAccessInfodeserInfo)throwsIllegalAccessException,InvocationTargetException{
if(geoServer==null||deserInfo==null)thrownewIllegalArgumentException("Wrongpassedargumentsarenull");//getlocalinstancefinalCoverageAccessInfoinfo=geoServer.getGlobal().getCoverageAccess();//storelocalreferencefinalThreadPoolExecutorexecutor=info.getThreadPoolExecutor();//overwriteallmembersBeanUtils.copyProperties(info,deserInfo);//setthreadpoolusingstoredreferenceinfo.setThreadPoolExecutor(executor);returninfo;}}
if(sourceCoverage==null){thrownewIllegalStateException("Itseemsprepare()hasnotbeencalledorhasnotsucceed");
if(name==null){returnother.getName()==null?0:-1;
else
if(other.getName()==null){return1;
else{returnname.getURI().compareTo(other.getName().getURI());
if(getRoles()!=null&&getRoles().size()>0){pai.getRoles().addAll(getRoles());
if(validators!=null&&validators.size()>0){pai.getValidators().putAll(validators);
if(description!=null){des=description.toString(locale);
if(sp.getName().equals(fp.getName())){sp.setEnabled(fp.isEnabled());sp.setRoles(fp.getRoles());sp.setValidators(fp.getValidators());
if(o1instanceofDate){
if(o1instanceofDateRange){return((Date)o1).compareTo(((DateRange)o2).getMinValue());
else{return((Date)o1).compareTo((Date)o2);
else
if(o1instanceofDateRange){
if(o2instanceofDate){return((DateRange)o1).getMinValue().compareTo((Date)o2);
else{return((DateRange)o1).getMinValue().compareTo(((DateRange)o2).getMinValue());
if(o1instanceofDouble){
if(o2instanceofDouble){return((Double)o1).compareTo((Double)o2);
else
if(o2instanceofNumberRange){return((Double)o1).compareTo(((NumberRange<Double>)o2).getMinValue());
else
if(o1instanceofNumberRange){
if(o2instanceofNumberRange){return((NumberRange<Double>)o1).getMinValue().compareTo(((NumberRange<Double>)o2).getMinValue());
else{return((NumberRange<Double>)o1).getMinValue().compareTo((Double)o2);
if(dimensions!=null){metadataNames.addAll(Arrays.asList(dimensions));
ifthereaderhasatimedimension**@throwsIOException*/publicbooleanhasTime()throwsIOException{return"true".equalsIgnoreCase(reader.getMetadataValue(HAS_TIME_DOMAIN));
if(!hasTime()){Collections.emptySet();
if(!hasTime()){Collections.emptySet();
if(readerinstanceofStructuredGridCoverage2DReader){StructuredGridCoverage2DReadersr=(StructuredGridCoverage2DReader)reader;result=getDimensionValuesInRange("time",range,maxEntries,sr);
ifwegothere,theoptimizationdidnotwork,dothenormalpath
if(result==null){result=newTreeSet<Object>();TreeSet<Object>fullDomain=getElevationDomain();for(Objecto:fullDomain){
if(oinstanceofDate){
if(range.contains((Date)o)){result.add(o);
else
if(oinstanceofDateRange){
if(range.intersects((DateRange)o)){result.add(o);
if(timeOrRange.contains("/")){String[]splitted=timeOrRange.split("/");finalStringstrStart=splitted[0];finalStringstrEnd=splitted[1];
if(strStart!=null&&strStart.equals(strEnd)){returndf.parse(strStart);
else{Datestart=df.parse(strStart);Dateend=df.parse(strEnd);returnnewDateRange(start,end);
else{returndf.parse(timeOrRange);
ifit'sinthemin/maxform,asaDouble*otherwise**@paramval*/privateObjectparseNumberOrRange(Stringval){
if(val.contains("/")){String[]splitted=val.split("/");finalStringstrStart=splitted[0];finalStringstrEnd=splitted[1];
if(strStart.equals(strEnd)){returnDouble.parseDouble(strStart);
else{returnDouble.parseDouble(val);
if(!hasTime()){returnnull;
if(currentTime==null){returnnull;
if(!hasTime()){returnnull;
if(currentTime==null){returnnull;
ifthereaderhasaelevationdimension**@throwsIOException*/publicbooleanhasElevation()throwsIOException{return"true".equalsIgnoreCase(reader.getMetadataValue(HAS_ELEVATION_DOMAIN));
if(!hasElevation()){returnnull;
if(!hasElevation()){Collections.emptySet();
if(readerinstanceofStructuredGridCoverage2DReader){StructuredGridCoverage2DReadersr=(StructuredGridCoverage2DReader)reader;result=getDimensionValuesInRange("elevation",range,maxEntries,sr);
ifwegothere,theoptimizationdidnotwork,dothenormalpath
if(result==null){result=newTreeSet<Object>();TreeSet<Object>fullDomain=getElevationDomain();for(Objecto:fullDomain){
if(oinstanceofDouble){
if(range.contains((Number)o)){result.add(o);
else
if(oinstanceofNumberRange){
if(range.intersects((NumberRange)o)){result.add(o);
if(dimensionName.equalsIgnoreCase(descriptor.getName())&&descriptor.getEndAttribute()==null){GranuleSourcegs=sr.getGranules(name,true);finalQueryquery=newQuery(gs.getSchema().getName().getLocalPart());//TheNetCDFplug-ingetsacorruptedcache
ifweprovideapropertylist//query.setPropertyNames(Arrays.asList(descriptor.getStartAttribute()));finalPropertyNameattribute=FF.property(descriptor.getStartAttribute());finalPropertyIsBetweenrangeFilter=FF.between(attribute,FF.literal(range.getMinValue()),FF.literal(range.getMaxValue()));query.setFilter(rangeFilter);query.setMaxFeatures(maxEntries);query.setPropertyNames(newString[]{descriptor.getStartAttribute()});query.setHints(newHints(StructuredCoverageViewReader.QUERY_FIRST_BAND,true));FeatureCollectioncollection=gs.getGranules(query);//collectalluniquevalues(can'tdorangesnow,wedon'thaveamulti-attribute//uniquevisitor)UniqueVisitorvisitor=newUniqueVisitor(attribute);collection.accepts(visitor,null);TreeSet<Object>result=newTreeSet<>(visitor.getUnique());returnresult;
if(!hasElevation()){returnnull;
if(elevation==null){returnnull;
if(!hasElevation()){returnnull;
if(elevation==null){returnnull;
if(metadataNames.isEmpty()){returnCollections.emptyList();
if(name.startsWith("HAS_")&&name.endsWith("_DOMAIN")){Stringdimension=name.substring(4,name.length()-7);
if(names.contains(dimension+"_DOMAIN")&&!"TIME".equals(dimension)&&!"ELEVATION".equals(dimension)){result.add(dimension);
ifthereaderhasadimensionwiththegivenname**@throwsIOException*/publicbooleanhasDomain(Stringname)throwsIOException{Utilities.ensureNonNull("name",name);return"true".equalsIgnoreCase(reader.getMetadataValue("HAS_"+name.toUpperCase()+"_DOMAIN"));
ifwehaveanoptimizewaytogettheminimumStringminimum=reader.getMetadataValue(name.toUpperCase()+"_DOMAIN_MINIMUM");
if(minimum!=null){returnminimum;
if(domain.isEmpty()){returnnull;
else{returndomain.get(0);
ifthisdimensionhasarange(min/max)orjustadomain**@paramdomain*/publicbooleanhasRange(Stringdomain){returnmetadataNames.contains(domain+"_DOMAIN_MAXIMUM")&&metadataNames.contains(domain+"_DOMAIN_MINIMUM");
ifthisdimensionhasaresolution**@paramdomain*/publicbooleanhasResolution(Stringdomain){Utilities.ensureNonNull("name",domain);returnmetadataNames.contains(domain.toUpperCase()+"_DOMAIN_RESOLUTION");
if(typeName!=null){Class<?>type=Class.forName(typeName);
if(type==java.util.Date.class){result.addAll(newTimeParser().parse(value));
else
if(Number.class.isAssignableFrom(type)&&!value.contains(",")){result.add(parseNumberOrRange(value));
else{for(Stringelement:value.split(",")){result.add(Converters.convert(element,type));
else{result.add(value);
if(listener==null){listener=newNullProgressListener();
if(workspace!=null){ws=catalog.getWorkspaceByName(workspace);
if(ws==null){thrownewProcessException("Couldnotfindworkspace"+workspace);
else{ws=catalog.getDefaultWorkspace();
if(ws==null){thrownewProcessException("Thecatalogisempty,couldnotfindadefaultworkspace");
if(store!=null){
if(features!=null){storeInfo=catalog.getDataStoreByName(ws.getName(),store);
else
if(coverage!=null){storeInfo=catalog.getCoverageStoreByName(ws.getName(),store);
if(storeInfo==null){//mirroring"features!=null"below
if(features!=null){storeInfo=catalog.getDefaultDataStore(ws);
if(storeInfo==null){thrownewProcessException("Couldnotfindadefaultstoreinworkspace"+ws.getName());
else
if(coverage!=null){//sincethestoredoesn'texist,createit//mirroring"createanewcoveragestore"belowstoreInfo=cb.buildCoverageStore((store));add=true;LOGGER.info("Creatingstore"+store+"sinceitdidnotexist");
else
if(features!=null){storeInfo=catalog.getDefaultDataStore(ws);
if(storeInfo==null){thrownewProcessException("Couldnotfindadefaultstoreinworkspace"+ws.getName());
else
if(coverage!=null){//createanewcoveragestoreLOGGER.info("Auto-configuringcoveragestore:"+(name!=null?name:coverage.getName().toString()));storeInfo=cb.buildCoverageStore((name!=null?name:coverage.getName().toString()));add=true;store=(name!=null?name:coverage.getName().toString());
if(storeInfo==null){thrownewProcessException("Couldnotfindadefaultstoreinworkspace"+ws.getName());
ifanyStyleInfotargetStyle=null;
if(styleName!=null){targetStyle=catalog.getStyleByName(styleName);
if(targetStyle==null){thrownewProcessException("Couldnotfindstyle"+styleName);
if(features!=null){//check
ifthetargetlayerandthetargetfeaturetypearenot//alreadythere(thisisahalf-assedattemptaswedon'thave//anAPItellingushowthefeaturetypenamewillbechanged//byDataStore.createSchema(...),butbetterthanfullyimporting//thedataintothetargetstoretofindoutwecannotcreatethelayer...)StringtentativeTargetName=null;
if(name!=null){tentativeTargetName=ws.getName()+":"+name;
else{tentativeTargetName=ws.getName()+":"+features.getSchema().getTypeName();
if(catalog.getLayer(tentativeTargetName)!=null){thrownewProcessException("Targetlayer"+tentativeTargetName+"alreadyexists");
if(srs!=null){try{Integercode=CRS.lookupEpsgCode(srs,true);
if(code==null){thrownewWPSException("CouldnotfindaEPSGcodefor"+srs);
else{//checkwecanextractacodefromtheoriginaldataGeometryDescriptorgd=features.getSchema().getGeometryDescriptor();
if(gd==null){//dataisgeometryless,weneedafakeSRStargetSRSCode="EPSG:4326";srsHandling=ProjectionPolicy.FORCE_DECLARED;
else{CoordinateReferenceSystemnativeCrs=gd.getCoordinateReferenceSystem();
if(nativeCrs==null){thrownewProcessException("TheoriginaldatahasnonativeCRS,"+"youneedtospecifythesrsparameter");
else{try{Integercode=CRS.lookupEpsgCode(nativeCrs,true);
if(code==null){thrownewProcessException("CouldnotfindanEPSGcodefordata"+"nativespatialreferencesystem:"+nativeCrs);
else{targetSRSCode="EPSG:"+code;
ifnecessaryFeatureTypeInfotypeInfo=cb.buildFeatureType(targetType.getName());
if(targetSRSCode!=null){typeInfo.setSRS(targetSRSCode);
if(srsHandling!=null){typeInfo.setProjectionPolicy(srsHandling);
if(targetStyle!=null){layerInfo.setDefaultStyle(targetStyle);
else
if(coverage!=null){try{finalResourcedirectory=catalog.getResourceLoader().get(Paths.path("data",workspace,store));finalFilefile=File.createTempFile(store,".tif",directory.dir());((CoverageStoreInfo)storeInfo).setURL(file.toURL().toExternalForm());((CoverageStoreInfo)storeInfo).setType("GeoTIFF");//checkthetargetcrsCoordinateReferenceSystemcvCrs=coverage.getCoordinateReferenceSystem();StringtargetSRSCode=null;
if(srs!=null){try{Integercode=CRS.lookupEpsgCode(srs,true);
if(code==null){thrownewWPSException("CouldnotfindaEPSGcodefor"+srs);
else{//checkwecanextractacodefromtheoriginaldata
if(cvCrs==null){//dataisgeometryless,weneedafakeSRStargetSRSCode="EPSG:4326";srsHandling=ProjectionPolicy.FORCE_DECLARED;srs=DefaultGeographicCRS.WGS84;
else{CoordinateReferenceSystemnativeCrs=cvCrs;
if(nativeCrs==null){thrownewProcessException("TheoriginaldatahasnonativeCRS,"+"youneedtospecifythesrsparameter");
else{try{Integercode=CRS.lookupEpsgCode(nativeCrs,true);
if(code==null){thrownewProcessException("CouldnotfindanEPSGcodefordata"+"nativespatialreferencesystem:"+nativeCrs);
else{targetSRSCode="EPSG:"+code;srs=CRS.decode(targetSRSCode,true);
if(!tx.isIdentity()||!CRS.equalsIgnoreMetadata(cvCrs,srs)){coverage=WCSUtils.resample(coverage,cvCrs,srs,null,Interpolation.getInstance(Interpolation.INTERP_NEAREST));
if(add){catalog.add((CoverageStoreInfo)storeInfo);
else{catalog.save((CoverageStoreInfo)storeInfo);
if(reader==null){thrownewProcessException("Couldnotaquirereaderforcoverage.");
if(useJAIImageReadParam!=null){*customParameters.put(AbstractGridFormat.USE_JAI_IMAGEREAD.getName().toString(),Boolean.valueOf(useJAIImageReadParam));
ifthenameofthecoveragewasspecified
if(name!=null){cinfo.setName(name);
if(!add){//updatetheexistingCoverageInfoexisting=catalog.getCoverageByCoverageStore((CoverageStoreInfo)storeInfo,name!=null?name:coverage.getName().toString());
if(existing==null){//grabthefirst
ifthereisonlyoneList<CoverageInfo>coverages=catalog.getCoveragesByCoverageStore((CoverageStoreInfo)storeInfo);
if(coverages.size()==1){existing=coverages.get(0);
if(coverages.size()==0){//nocoveragesyetconfigured,changeaddflagandcontinueonadd=true;
else{//multiplecoverages,andonetoconfigurenotspecifiedthrownewProcessException("Unabletodeterminecoveragetoconfigure.");
if(existing!=null){cb.updateCoverage(existing,cinfo);catalog.save(existing);cinfo=existing;
ifsrsisnotknownorunset,transformto4326
if("UNKNOWN".equals(cinfo.getSRS())){//CoordinateReferenceSystemsourceCRS=//cinfo.getBoundingBox().getCoordinateReferenceSystem();//CoordinateReferenceSystemtargetCRS=CRS.decode("EPSG:4326",true);//ReferencedEnvelopere=cinfo.getBoundingBox().transform(targetCRS,true);cinfo.setSRS("EPSG:4326");//cinfo.setCRS(targetCRS);//cinfo.setBoundingBox(re);
if(add){catalog.add(cinfo);layerInfo=cb.buildLayer(cinfo);
if(styleName!=null&&targetStyle!=null){layerInfo.setDefaultStyle(targetStyle);
if(styleName!=null){StyleInfostyle=catalog.getStyleByName(styleName*);
if(style!=null){layerInfo.setDefaultStyle(style);
if(!layerInfo.getStyles().contains(style)){*layerInfo.getStyles().add(style);
else{LOGGER.warning("Clientspecifiedstyle'"+styleName+*"'butnosuchstyleexists.");
if(path!=null){layerInfo.setPath(path);
if(!catalog.validate(layerInfo,true).isValid()){valid=false;
else{catalog.save(cinfo);layerInfo=catalog.getLayerByName(cinfo.getName());
if(styleName!=null&&targetStyle!=null){layerInfo.setDefaultStyle(targetStyle);
if(name!=null){SimpleFeatureTypeBuildertb=newSimpleFeatureTypeBuilder();tb.init(sourceType);tb.setName(name);sourceType=tb.buildFeatureType();
if(targetType==null){//ouch,thenamewaschanged...wecanonlyguessnow...//trywiththetypicalOraclemanglingtargetType=ds.getSchema(sourceType.getTypeName().toUpperCase());
if(targetType==null){thrownewWPSException("Thetargetschemawascreated,butwithaname"+"thatwecannotrelatetotheoneweprovidedthedatastore.Cannotproceeedfurther");
else{//checkthelayerisnotalreadythereStringnewLayerName=storeInfo.getWorkspace().getName()+":"+targetType.getTypeName();LayerInfolayer=catalog.getLayerByName(newLayerName);//todo:weshouldnotreallyreachhereandknowbeforehandwhatthetargetType//nameis,but
ifwedoweshouldatleastgetawaytodropit
if(layer!=null){thrownewProcessException("Targetlayer"+newLayerName+"alreadyexistsinthecatalog");
if(!complete){t.rollback();
if(listener.isCanceled()){thrownewProcessException(listener.getTask().toString());
ifthetargetisa//shapefilestoreitwillmovethegeometryandnameitthe_geom//collectthesourcenamesSet<String>sourceNames=newHashSet<String>();for(AttributeDescriptorsd:sourceType.getAttributeDescriptors()){sourceNames.add(sd.getLocalName());
ifwehavebeenkissedbysheerluckandthenamesare//thesameMap<String,String>result=newHashMap<String,String>();for(Stringname:sourceNames){
if(targetType.getDescriptor(name)!=null){result.put(name,name);
if(td.getLocalName().equalsIgnoreCase(name)){result.put(name,td.getLocalName());break;
if(loName.startsWith(tdName)){result.put(name,td.getLocalName());break;
if(targetType.getGeometryDescriptor()!=null&&"the_geom".equals(targetType.getGeometryDescriptor().getLocalName())&&!"the_geom".equalsIgnoreCase(sourceType.getGeometryDescriptor().getLocalName())){result.put(sourceType.getGeometryDescriptor().getLocalName(),"the_geom");
if(!sourceNames.isEmpty()){LOGGER.warning("Couldnotmatchthefollowingattributes"+sourceNames+"tothetargetfeaturetypeones:"+targetType);
if(executionTime.getConvertedInput()!=null&&totalTime.getConvertedInput()!=null&&totalTime.getConvertedInput()!=0&&totalTime.getConvertedInput()<executionTime.getConvertedInput()){form.error(newParamResourceModel("totalTimeError",getPage()).getString());
if(list!=null&&list.equalsIgnoreCase("all")){//weneedtoaskthecoveragereaderwhichcoveragesareavailableList<String>coverages=getStoreCoverages(coverageStore);returnnewStringsList(coverages,"coverageName");
if(nameSpace==null){//couldnotfindthenamespaceassociatedwiththedesiredworkspacethrownewResourceNotFoundException(String.format("Namespacenotfoundforworkspace'%s'.",workspaceName));
if(list!=null&&list.equalsIgnoreCase("all")){//weneedtoaskthecoveragereaderofeachavailablecoveragestorewhichcoverages//areavailableList<String>coverages=catalog.getCoverageStores().stream().flatMap(store->getStoreCoverages(store).stream()).collect(Collectors.toList());returnnewStringsList(coverages,"coverageName");
if(!optCoverage.isPresent()){thrownewResourceNotFoundException(String.format("Nosuchcoverage:%s,%s,%s",workspaceName,storeName,coverageName));
if(nameSpace==null){//couldnotfindthenamespaceassociatedwiththedesiredworkspacethrownewResourceNotFoundException(String.format("Namespacenotfoundforworkspace'%s'.",workspaceName));
if(storeName==null){uriComponents=builder.path("/workspaces/{workspaceName}/coverages/{coverageName}").buildAndExpand(workspaceName,storeName,coverageName);
else{uriComponents=builder.path("/workspaces/{workspaceName}/coveragestores/{storeName}/coverages/{coverageName}").buildAndExpand(workspaceName,storeName,coverageName);
if(c==null){thrownewRestException(String.format("Coverage'%s'notfound.",coverageName),HttpStatus.NOT_FOUND);
if(recurse){//byrecurseweclearoutallthelayersthatpublicthisresourcefor(LayerInfol:layers){catalog.remove(l);LOGGER.info("DELETElayer"+l.getName());
else{
if(!layers.isEmpty()){thrownewRestException("coveragereferencedbylayer(s)",HttpStatus.FORBIDDEN);
if(coverage==null){thrownewResourceNotFoundException(String.format("Nosuchcoverage:%s,%s",workspaceName,coverageName));
if(original==null){thrownewResourceNotFoundException("Nosuchcoveragestore:"+workspaceName+","+storeName);
if(coverage.getStore()==null){CoverageStoreInfods=catalog.getCoverageStoreByName(workspace,coverageStoreName);coverage.setStore(ds);
if(nativeCoverageName==null){nativeCoverageName=coverage.getNativeName();
if(!isNew){//Configuringapartiallydefinedcoveragebuilder.initCoverage(coverage,nativeCoverageName);
else{//Configuringabrandnewcoverage(onlynamehasbeenspecified)StringspecifiedName=coverage.getName();coverage=builder.buildCoverageByName(nativeCoverageName,specifiedName);
if(ns!=null&&!ns.getPrefix().equals(workspace)){//TODO:changethisoncethetwocanbedifferentandweuntienamespace//fromworkspaceLOGGER.warning("Namespace:"+ns.getPrefix()+"doesnotmatchworkspace:"+workspace+",overriding.");ns=null;
if(ns==null){//inferfromworkspacens=catalog.getNamespaceByPrefix(workspace);coverage.setNamespace(ns);
if(workspace==null||coveragestore==null||coverage==null){returnnull;
if(cs==null){returnnull;
if(objinstanceofNamespaceInfo){NamespaceInfons=(NamespaceInfo)obj;converter.encodeLink("/namespaces/"+converter.encode(ns.getPrefix()),writer);
if(objinstanceofCoverageStoreInfo){CoverageStoreInfocs=(CoverageStoreInfo)obj;converter.encodeLink("/workspaces/"+converter.encode(cs.getWorkspace().getName())+"/coveragestores/"+converter.encode(cs.getName()),writer);
ifweareinthecontextofagetcapabilitiesrequest
if(gwcOperation!=null&&gwcOperation.equalsIgnoreCase("GetCapabilities")){//thisisagetcapabilitiesrequest,weneedtocheck
ifweareinthecontextof//virtualservicereturngetNoPrefixedNameIfVirtualService();
ifthisavirtualservicerequestWorkspaceInfolocalWorkspace=LocalWorkspace.get();
if(localWorkspace!=null){//yesthisisavirtualservicerequestsoremovingtheworkspaceprefixreturnCatalogConfiguration.removeWorkspacePrefix(info.getName(),catalog);
ifthefollowingconditionsapply:**<ul>*<li>Cachingforthislayerisenabledbyconfiguration*<li>Itsbacking{@linkLayerInfo}or{@linkLayerGroupInfo}isenabledandnoterrored(as*per{@linkLayerInfo#enabled()}{@linkLayerGroupInfo}*<li>Thelayerisnoterrored({@link#getConfigErrorMessage()==null}*</ul>**Thelayerisenabledbyconfigurationif:the{@codeGWC.enabled}metadatapropertyissetto*{@codetrue}init'scorresponding{@linkLayerInfo}or{@linkLayerGroupInfo}{@link*MetadataMap},orthere'sno{@codeGWC.enabled}propertysetatallbuttheglobal{@link*GWCConfig#isCacheLayersByDefault()}is{@codetrue}.**@seeorg.geowebcache.layer.TileLayer#isEnabled()*/@OverridepublicbooleanisEnabled(){finalbooleantileLayerInfoEnabled=info.isEnabled();
if(!tileLayerInfoEnabled){returnfalse;
if(getConfigErrorMessage()!=null){
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("Layer"+getName()+"isnotenabledduetoconfigerror:"+getConfigErrorMessage());
if(layerInfo!=null){geoserverLayerEnabled=layerInfo.enabled();
else{//LayerGroupInfohasnoenabledproperty,soassumetruegeoserverLayerEnabled=true;
if(getLayerInfo()==null){LayerGroupInfogroupInfo=getLayerGroupInfo();try{ReferencedEnvelopebounds=groupInfo.getBounds();booleanlenient=true;latLongBbox=bounds.transform(wgs84LonFirst,lenient);
else{ResourceInforesourceInfo=getResourceInfo();latLongBbox=resourceInfo.getLatLonBoundingBox();
if(null==latLongBbox){latLongBbox=newReferencedEnvelope(wgs84LonFirst);
if(null==latLongBbox.getCoordinateReferenceSystem()){ReferencedEnvelopetmp=newReferencedEnvelope(wgs84LonFirst);tmp.init(latLongBbox.getMinX(),latLongBbox.getMaxX(),latLongBbox.getMinY(),latLongBbox.getMaxY());latLongBbox=tmp;
ifit'sbackedbya{@link*LayerGroupInfo}instead*@deprecatedusegetPublishedInfoinstead*/@DeprecatedpublicLayerInfogetLayerInfo(){PublishedInfoinfo=getPublishedInfo();
if(infoinstanceofLayerInfo){return(LayerInfo)info;
if(publishedInfo==null){synchronized(this){
if(publishedInfo==null){//see
ifit'salayeroralayergroupPublishedInfowork=catalog.getLayer(publishedId);
if(work==null){work=catalog.getLayerGroup(publishedId);
if(work!=null){TileLayerInfoUtil.checkAutomaticStyles(work,info);
else{thrownewIllegalStateException("Couldnotlocatealayerorlayergroupwithid"+publishedId+"withinGeoServerconfiguration,theGWCconfigurationseemstobeoutofsynch");
ifit'sbackedbya{@link*LayerInfo}instead*@deprecatedusegetPublishedInfoinstead*/@DeprecatedpublicLayerGroupInfogetLayerGroupInfo(){PublishedInfoinfo=getPublishedInfo();
if(infoinstanceofLayerGroupInfo){return(LayerGroupInfo)info;
if(resourceInfo!=null){title=resourceInfo.getTitle();description=resourceInfo.getAbstract();keywords=newArrayList<>();for(KeywordInfokw:resourceInfo.getKeywords()){keywords.add(kw.getValue());
else{LayerGroupInfolg=getLayerGroupInfo();
if(lg!=null){
if(lg!=null){
if(lg.getTitle()!=null){title=lg.getTitle();
if(lg.getAbstract()!=null){description=lg.getAbstract();
ifthistilelayerisbackedbya{@link*LayerGroupInfo}.**<p>Asthedefaultstyleisalwayscached,itsnameisnotstoredaspartofthistilelayer's*{@linkGeoServerTileLayerInfo}.Insteadit's'live'andretrievedfromthecurrent{@link*LayerInfo}everytimethismethodisinvoked.**@seeorg.geowebcache.layer.TileLayer#getStyles()*/@OverridepublicStringgetStyles(){LayerGroupInfolayerGroupInfo=getLayerGroupInfo();
if(layerGroupInfo!=null){//there'snosuchthingasdefaultstyleforalayergroupreturnnull;
if(defaultStyle==null){setConfigErrorMessage("UnderlyingGeoSeverLayerhasnodefaultstyle");returnnull;
if(mimeType==null){mimeType=getMimeTypes().get(0);
if(featureCount!=null){wmsParams.put("FEATURE_COUNT",featureCount);
if(fullParameters.isEmpty()){fullParameters=getDefaultParameterFilters();
if(mime==null){mime=formats.get(0);
else{
if(!formats.contains(mime)){thrownewIllegalArgumentException(mime.getFormat()+"isnotasupportedformatfor"+getName());
if(gridSubset==null){thrownewIllegalArgumentException("Requestedgridsetnotfound:"+tileGridSetId);
ifnecessarygridSubset.checkCoverage(gridLoc);ConveyorTilereturnTile;intmetaX;intmetaY;
if(mime.supportsTiling()){metaX=info.getMetaTilingX();metaY=info.getMetaTilingY();
else{metaX=metaY=1;
if(listeners!=null){listeners.sendTileRequested(this,tile);
if(tryCache&&tryCacheFetch(tile)){returnfinalizeTile(tile);
if(tryCache&&tryCacheFetch(tile)){LOGGER.finest("-->"+Thread.currentThread().getName()+"returnscachehitfor"+Arrays.toString(metaTile.getMetaGridPos()));
else{LOGGER.finer("-->"+Thread.currentThread().getName()+"submittinggetMaprequestformetagridlocation"+Arrays.toString(metaTile.getMetaGridPos())+"on"+metaTile);WebMapmap;try{longrequestTime=System.currentTimeMillis();map=dispatchGetMap(tile,metaTile);checkNotNull(map,"DidnotobtainaWebMapfromGeoServer'sDispatcher");metaTile.setWebMap(map);saveTiles(metaTile,tile,requestTime);
if(lock!=null){lock.release();
if(metaTile!=null){tileIndex=metaTile.getMetaGridPos();metaKey.append("gsmeta_");
else{tileIndex=tile.getTileIndex();metaKey.append("tile_");
if(tile.getParametersId()!=null){metaKey.append("_").append(tile.getParametersId());
if(!(mapinstanceofWebMap)){thrownewIllegalStateException("Expected:RenderedImageMap,got"+map);
if(filteredParams.isEmpty()){filteredParams=getDefaultParameterFilters();
if(expireCache!=GWCVars.CACHE_DISABLE_CACHE){try{returntile.retrieve(expireCache*1000L);
if(tile.getStatus()==0&&!tile.getError()){tile.setStatus(200);
if(tile.servletResp!=null){setExpirationHeader(tile.servletResp,(int)tile.getTileIndex()[2]);setTileIndexHeader(tile);
if(!gridSubset.shouldCacheAtZoom(zLevel)){
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("Ignoringseedcallontile"+tile+"asit'soutsidethecacheablezoomlevelrange");
if(!tile.getMimeType().supportsTiling()){metaX=metaY=1;
if(this.subSets==null){ReferencedEnvelopelatLongBbox=getLatLonBbox();try{this.subSets=getGrids(latLongBbox,gridSetBroker);
if(it.next().getGridSetName().equals(gridSetId)){it.remove();break;
if(cachedGridSets.size()==0){returnCollections.emptyMap();
if(gridSet==null){LOGGER.info("NoGWCGridSetnamed'"+gridSetId+"'exists.");continue;
if(null==extent){try{SRSsrs=gridSet.getSrs();try{extent=getBounds(srs);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,msg,cantComputeBounds);
else{LOGGER.warning(msg);
if(getLayerInfo()!=null){//projectionpolicyfortheseboundsarealreadytakencareofbythegeoserver//configurationtry{nativeBounds=getLayerInfo().getResource().boundingBox();
else{nativeBounds=getLayerGroupInfo().getBounds();
if(null==targetAov){Stringmsg="Can'tcomputetilelayerboudsoutofresourcenativeboundsforCRS"+srs;LOGGER.log(Level.WARNING,msg,e);thrownewIllegalArgumentException(msg,e);
if(info.getExpireClients()>0){returninfo.getExpireClients();
if(layerInfo!=null){returngetLayerMaxAge(layerInfo);
if(layerGroupInfo!=null){returngetGroupMaxAge(layerGroupInfo);
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"FoundaGeoServerTileLayerthatisnotbaseoneither"+"LayerInfoorLayerGroupInfo,settingitsmaxageto0");
if(piinstanceofLayerInfo){piAge=getLayerMaxAge((LayerInfo)pi);
else
if(piinstanceofLayerGroupInfo){piAge=getGroupMaxAge((LayerGroupInfo)pi);
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"FoundaPublishedInfothatisnorLayerInfonor"+"LayerGroupInfo,settingitsmaxageto0:"+pi);
if(enabled!=null&&enabled.toString().equalsIgnoreCase("true")){IntegermaxAge=metadata.get(ResourceInfo.CACHE_AGE_MAX,Integer.class);
if(maxAge!=null){returnmaxAge;
else{return0;
if(info.getExpireCacheList()!=null){ExpirationRulematchedRule=null;for(ExpirationRulerule:info.getExpireCacheList()){
if(zoomLevel>=rule.getMinZoom()){matchedRule=rule;
else{//ExpirationRulesshouldbezoomlevelascendingbreak;
if(matchedRule!=null){returnmatchedRule.getExpiration();
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,e.getMessage(),e);
if(layerInfo!=null){//thisisanormallayergsMetadataLinks=layerInfo.getResource().getMetadataLinks();
else{//thisisalayergroupgsMetadataLinks=newArrayList<>();for(LayerInfolayer:Iterables.filter(getLayerGroupInfo().getLayers(),LayerInfo.class)){//gettingmetadataofalllayersofthelayergroupList<MetadataLinkInfo>metadataLinksLayer=layer.getResource().getMetadataLinks();
if(metadataLinksLayer!=null){gsMetadataLinks.addAll(metadataLinksLayer);
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("ErroraddinglayermetadataURL.");
if(layerInfo==null){returnCollections.emptyMap();
if(styleInfo==null){continue;
if(legendInfo!=null){StringbaseUrl=baseUrl();gwcLegendInfo.withStyleName(styleInfo.getName()).withWidth(legendInfo.getWidth()).withHeight(legendInfo.getHeight()).withFormat(legendInfo.getFormat()).withMinScale(scalesDenominator.getMinimum()).withMaxScale(scalesDenominator.getMaximum()).withCompleteUrl(buildURL(baseUrl,legendInfo.getOnlineResource(),null,URLMangler.URLType.RESOURCE));legends.put(styleInfo.prefixedName(),gwcLegendInfo.build());
else{intfinalWidth=GetLegendGraphicRequest.DEFAULT_WIDTH;intfinalHeight=GetLegendGraphicRequest.DEFAULT_HEIGHT;StringfinalFormat=GetLegendGraphicRequest.DEFAULT_FORMAT;try{Dimensiondimension=getLegendSample().getLegendURLSize(styleInfo);
if(dimension!=null){finalWidth=(int)dimension.getWidth();finalHeight=(int)dimension.getHeight();
if(null==getWms().getLegendGraphicOutputFormat(finalFormat)){
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("Defaultlegendformat("+finalFormat+")isnotsupported(jainotavailable?),can'taddLegendURLelement");
if(!styleInfo.getName().equals(layerInfo.getDefaultStyle().getName())){params.put("style",styleInfo.getName());
if(legendSample==null){//noneedforsynchronizationthebeanisalwaysthesamelegendSample=GeoServerExtensions.bean(LegendSample.class);
if(wms==null){//noneedforsynchronizationthebeanisalwaysthesamewms=GeoServerExtensions.bean(WMS.class);
ifaOWSservicewastargetedRequestowsRequest=Dispatcher.REQUEST.get();
if(owsRequest!=null){//retrievethebaseURLfromthedispatcherrequestreturnRequestUtils.baseURL(Dispatcher.REQUEST.get().getHttpRequest());
ifaRESTend-pointwastargetedRequestInforestRequest=RequestInfo.get();
if(restRequest!=null){//retrievethebaseURLfromRESTrequestreturnrestRequest.getBaseURL();
ifaclientdoesnotsupportcookiesthisclasscannotwork*properlyandwillstartaccumulatingqueueswithjustoneiteminside.Asaworkaroundwhentoo*manyqueuesareaccumulatedascanstartsthatpurgesallqueuesthatareemptyandhavenotbeen*touchedwithinagivenamountoftime:theideaisthatapastthattimewe'reassumingthe*clientisnomoreworkingactivelyagainsttheserverandthequeuecanthusberemoved.**@authorAndreaAime-OpenGeo*@authorJuanMarin,OpenGeo*/publicclassUserConcurrentFlowControllerextendsQueueController{staticfinalLoggerLOGGER=Logging.getLogger(ControlFlowCallback.class);/***ThreadlocalholdingthecurrentrequestqueueidTODO:considerhavingausermapin{@link*Request}instead*/staticThreadLocal<String>QUEUE_ID=newThreadLocal<String>();CookieKeyGeneratorkeyGenerator=newCookieKeyGenerator();/**Lasttimewe'veperformedaqueuecleanup*/longlastCleanup=System.currentTimeMillis();/**Numberofqueuesatwhichwestartlookingforpurgingstaleones*/intmaxQueues=100;/**Timeittakesforaninactivequeuetobeconsideredstale*/intmaxAge=10000;/***BuildsaUserFlowControllerthatwilltriggerstalequeueexpirationonce100queueshave*beenaccumulatedand**@paramqueueSizethemaximumamountofperuserconcurrentrequests*/publicUserConcurrentFlowController(intqueueSize){this(queueSize,100,10000);
if(queueId!=null){BlockingQueue<Request>queue=queues.get(queueId);
if(queue!=null)queue.remove(request);
ifwehavethatqueuealready,otherwisegenerateitTimedBlockingQueuequeue=null;queue=queues.get(queueId);
if(queue==null){queue=newTimedBlockingQueue(queueSize,true);queues.put(queueId,queue);
if(timeout>0){retval=queue.offer(request,timeout,TimeUnit.MILLISECONDS);
else{queue.put(request);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("UserFlowController("+queueSize+","+queueId+")queuesize"+queue.size());LOGGER.fine("UserFlowController("+queueSize+","+queueId+")totalqueues"+queues.size());
ifnecessary
if((queues.size()>maxQueues&&(now-lastCleanup)>(maxAge/10))||(now-lastCleanup)>maxAge){intcleanupCount=0;synchronized(queues){for(Stringkey:queues.keySet()){TimedBlockingQueuetbq=queues.get(key);
if(now-tbq.lastModified>maxAge&&tbq.size()==0){queues.remove(key);cleanupCount++;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("UserFlowController("+queueSize+")purged"+cleanupCount+"stalequeues");
ifthestreamisalreadyclosedtheninvokingthismethodhasnoeffect.**@throwsRuntimeException
ifanI/Oerroroccurs*/@Overridepublicvoidclose();}
if(featureinstanceofGridCoverage2D){GridCoverage2Dcoverage=(GridCoverage2D)feature;val=evaluate(coverage,arg0);
if(val!=null){returnval;
if(prop!=null&&propinstanceofPAMDataset){finalPAMDatasetdataset=(PAMDataset)prop;//NeedtoplaywithchannelselectiontodealwithdifferentrasterbandsfinalPAMRasterBandband=dataset.getPAMRasterBand().get(0);
if(band!=null){finalStringvalue=pamParser.getMetadataValue(band,"STATISTICS_"+statName.toUpperCase());returnDouble.parseDouble(value);
ifmandatorycontentnotpresent//orturnedoff
if(metadataURL==null||ids==null||ids.isEmpty()||createExtendedCapabilities!=null&&!createExtendedCapabilities){return;
if(mediaType!=null){tx.start("inspire_common:MediaType");tx.chars(mediaType);tx.end("inspire_common:MediaType");
if(id.getMetadataURL()!=null){tx.start("inspire_dls:SpatialDataSetIdentifier",atts("metadataURL",id.getMetadataURL()));
else{tx.start("inspire_dls:SpatialDataSetIdentifier");
if(id.getNamespace()!=null){tx.start("inspire_common:Namespace");tx.chars(id.getNamespace());tx.end("inspire_common:Namespace");
if(rule.getFilter()!=null){Filterfilter=rule.getFilter();filterCopy=copy(filter);
if(symcopy!=null)symArray.add(symcopy);
if(STRICT&&!copy.equals(rule)){thrownewIllegalStateException("WasunabletoduplicateprovidedRule:"+rule);
if(element==null){thrownewNullPointerException("elementmustnotbenull");
if(resolverProvider==null){synchronized(this){
if(resolverProvider==null){resolverProvider=GeoServerExtensions.bean(EntityResolverProvider.class);
if(!matcher.matches()){LOGGER.severe("Ratelimitingrulevaluesshouldbeexpressedas<rate</<unit>[;<delay>s],"+"whereunitcanbes,m,hord.Thisoneisinvalid:"+value);returnnull;
if(userDelay!=null){delay=Integer.parseInt(userDelay)*1000;
if("ip.blacklist".equals(key)||"ip.whitelist".equals(key)||"ows.priority.http".equals(key)){continue;
else{
if(!key.startsWith("user.ows")&&!key.startsWith("ip.ows")){
if(tokenizer.countTokens()==1){queueSize=Integer.parseInt(value);
else{queueSize=Integer.parseInt(tokenizer.nextToken());
if("timeout".equalsIgnoreCase(key)){timeout=queueSize*1000;continue;
if("ows.global".equalsIgnoreCase(key)){controller=newGlobalFlowController(queueSize,buildBlocker(queueSize,priorityProvider));
else
if("ows".equals(keys[0])){//todo:check,
ifpossible,
iftheservice,methodandoutputformatactuallyexistThreadBlockerthreadBlocker=buildBlocker(queueSize,priorityProvider);
if(keys.length>=4){controller=newBasicOWSController(keys[1],keys[2],keys[3],queueSize,threadBlocker);
else
if(keys.length==3){controller=newBasicOWSController(keys[1],keys[2],queueSize,threadBlocker);
else
if(keys.length==2){controller=newBasicOWSController(keys[1],queueSize,threadBlocker);
else
if("user".equals(keys[0])){
if(keys.length==1){controller=newUserConcurrentFlowController(queueSize);
else
if("ows".equals(keys[1])){controller=newRateControllerBuilder(){@OverrideprotectedKeyGeneratorbuildKeyGenerator(String[]keys,Stringvalue){returnnewCookieKeyGenerator();
else
if("ip".equals(keys[0])){
if(keys.length==1){controller=newIpFlowController(queueSize);
else
if(keys.length>1&&"ows".equals(keys[1])){controller=newRateControllerBuilder(){@OverrideprotectedKeyGeneratorbuildKeyGenerator(String[]keys,Stringvalue){returnnewIpKeyGenerator();
else
if(keys.length>1){
if(!"blacklist".equals(keys[1])&&!"whitelist".equals(keys[1])){Stringip=key.substring("ip.".length());controller=newSingleIpFlowController(queueSize,ip);
if(controller==null){LOGGER.severe("Couldnotparsecontrol-flowrule:'"+okey+"="+value);
else{LOGGER.info("Loadedcontrol-flowrule:"+key+"="+value);newControllers.add(controller);
ifno(valid)configurationwasfound*/privatePriorityProvidergetPriorityProvider(Propertiesp){for(Objectokey:p.keySet()){Stringkey=((String)okey).trim();Stringvalue=(String)p.get(okey);//isitapriorityspecification?
if("ows.priority.http".equals(key)){Stringerror="";try{String[]splitValue=value.trim().split("\\s*,\\s*");
if(splitValue.length==2&&splitValue[0].length()>0){StringhttpHeaderName=splitValue[0];intdefaultPriority=Integer.parseInt(splitValue[1]);LOGGER.info("FoundOWSpriorityspecification"+key+"="+value);returnnewHttpHeaderPriorityProvider(httpHeaderName,defaultPriority);
if(priorityProvider!=null){returnnewPriorityThreadBlocker(queueSize,priorityProvider);
else{returnnewSimpleThreadBlocker(queueSize);
if(loader!=null){Resourcecontrolflow=loader.get(PROPERTYFILENAME);configurationFiles.add(controlflow);
else
if(this.configFile!=null&&this.configFile.getResource()!=null){configurationFiles.add(this.configFile.getResource());
if(loader!=null){for(Resourcecontrolflow:getFileLocations()){ResourcetargetDir=Files.asResource(resourceLoader.findOrCreateDirectory(Paths.convert(loader.getBaseDirectory(),controlflow.parent().dir())));Resources.copy(controlflow.file(),targetDir);
else
if(this.configFile!=null&&this.configFile.getResource()!=null){Resources.copy(this.configFile.getFile(),Files.asResource(resourceLoader.getBaseDirectory()));
else
if(this.configFile!=null&&this.configFile.getProperties()!=null){FilecontrolFlowConfigurationFile=Resources.file(resourceLoader.get(PROPERTYFILENAME),true);OutputStreamout=Files.out(controlFlowConfigurationFile);try{this.configFile.getProperties().store(out,"");
if(Resources.exists(controlflow)){configFile=newPropertyFileWatcher(controlflow);
if(!selector.allowProcess(name)){it.remove();
if(selector.allowProcess(name)){returndelegate.create(name);
else{returnnull;
if(selector.allowProcess(name)){returndelegate.getDescription(name);
else{returnnull;
if(selector.allowProcess(name)){returndelegate.getParameterInfo(name);
else{returnnull;
if(selector.allowProcess(name)){returndelegate.getResultInfo(name,parameters);
else{returnnull;
if(selector.allowProcess(name)){returndelegate.getTitle(name);
else{returnnull;
if(selector.allowProcess(name)){returndelegate.getVersion(name);
else{returnnull;
if(selector.allowProcess(name)){returndelegate.supportsProgress(name);
else{returnfalse;
if("nioLock".equals(choices.get(i))){nioLockIndex=i;break;
iftheCacheProviderisGuavaCacheProvidertester.assertComponent("form:cachingOptionsPanel:container:configs:blobstores:container:caches",DropDownChoice.class);@SuppressWarnings("unchecked")DropDownChoice<String>choice=(DropDownChoice<String>)tester.getComponentFromLastRenderedPage("form:cachingOptionsPanel:container:configs:blobstores:container:caches");assertTrue(choice.getChoices().get(0).equalsIgnoreCase(GuavaCacheProvider.class.toString()));//EnsurethattheotherfieldsareenabledComponentcomp1=tester.getComponentFromLastRenderedPage("form:cachingOptionsPanel:container:configs:blobstores:container:cacheConfContainer:hardMemoryLimit");Componentcomp2=tester.getComponentFromLastRenderedPage("form:cachingOptionsPanel:container:configs:blobstores:container:cacheConfContainer:concurrencyLevel");assertTrue(comp1.isEnabled());assertTrue(comp2.isEnabled());//Selectionoftheformtestsform=tester.newFormTester("form");form.setValue("cachingOptionsPanel:container:configs:blobstores:container:persistenceEnabled",true);form.setValue("cachingOptionsPanel:container:configs:blobstores:container:cacheConfContainer:hardMemoryLimit",1+"");form.setValue("cachingOptionsPanel:container:configs:blobstores:container:cacheConfContainer:concurrencyLevel",1+"");//Checkthatthepageiscorrectlyrenderedtester.assertRenderedPage(GWCSettingsPage.class);//Savethechangesform.submit("submit");//Checknoexceptionhasbeenthrowntester.assertNoErrorMessage();//ChecktheGWCConfigconfig=gwc.getConfig();assertTrue(config.isPersistenceEnabled());assertEquals(config.getCacheConfigurations().get(GuavaCacheProvider.class.toString()).getConcurrencyLevel(),1);assertEquals(config.getCacheConfigurations().get(GuavaCacheProvider.class.toString()).getHardMemoryLimit(),1);//Startthepagetester.startPage(newGWCSettingsPage());//Ensurethepageiscorrectlyrenderedtester.assertRenderedPage(GWCSettingsPage.class);//Selectionoftheformtestsform=tester.newFormTester("form");form.setValue("cachingOptionsPanel:container:configs:blobstores:innerCachingEnabled",false);//Savethechangesform.submit("submit");//Startthepagetester.startPage(newGWCSettingsPage());//Ensurethepageiscorrectlyrenderedtester.assertRenderedPage(GWCSettingsPage.class);Resultres=tester.isVisible("form:cachingOptionsPanel:container:configs:blobstores:container:persistenceEnabled");assertTrue(res.wasFailed());//ChecktheGWCConfigconfig=gwc.getConfig();assertFalse(config.isInnerCachingEnabled());
if(compress){in=newLZFInputStream(in);
if(DEBUG){ByteArrayOutputStreamtmp=newByteArrayOutputStream();ByteStreams.copy(in,tmp);System.err.println("Read:"+tmp.toString());System.err.flush();in=newByteArrayInputStream(tmp.toByteArray());
if(compress){out=newLZFOutputStream(serialOutput);
if(DEBUG){out=newTeeOutputStream(out,System.out);
if(id!=null&&id.length()==0){id=null;
if(name!=null&&name.length()==0){name=null;
if(name==null){//nameismandatorythrownewRestException("Layernamenotprovided",HttpStatus.BAD_REQUEST);
if(id!=null){layer=catalog.getLayer(id);
if(layer==null){layerGroup=catalog.getLayerGroup(id);
if(layerGroup==null){thrownewRestException("NoGeoServerLayerorLayerGroupexistswithid'"+id+"'",HttpStatus.BAD_REQUEST);
else{layer=catalog.getLayerByName(name);
if(layer==null){layerGroup=catalog.getLayerGroupByName(name);
if(layerGroup==null){thrownewRestException("GeoServerLayerorLayerGroup'"+name+"'notfound",HttpStatus.NOT_FOUND);
if(id!=null&&!name.equals(actualName)){thrownewRestException("Layerwithid'"+id+"'foundbutnamedoesnotmatch:'"+name+"'/'"+actualName+"'",HttpStatus.BAD_REQUEST);
if(layer!=null){tileLayer=newGeoServerTileLayer(layer,gridsets,info);
else{tileLayer=newGeoServerTileLayer(layerGroup,gridsets,info);
if(sysProperty==null||!Boolean.valueOf(sysProperty)){GeoServerEnvironmentgenv=newGeoServerEnvironment();LOGGER.info("GeoServerEnvironment="+GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION);assertTrue(!GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION);
if(dispatcher==null){synchronized(this){
if(dispatcher==null){dispatcher=super.getDispatcher();
if(event==null){thrownewNullArgumentException("Incomingobjectisnull");
if(eventinstanceofCatalogPostModifyEvent){finalCatalogPostModifyEventpostModEv=((CatalogPostModifyEvent)event);producer.disable();postModify(catalog,postModEv);
else{//incomingobjectnotrecognized
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe("Unrecognizedeventtype");returnfalse;
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(this.getClass()+"isunabletosynchronizetheincomingevent:"+event);throwe;
if(infoinstanceofLayerGroupInfo){finalLayerGroupInfolocalizedObject=CatalogUtils.localizeLayerGroup((LayerGroupInfo)info,catalog);catalog.firePostModified(ModificationProxy.unwrap(localizedObject),modifyEv.getPropertyNames(),modifyEv.getOldValues(),modifyEv.getNewValues());
else
if(infoinstanceofLayerInfo){finalLayerInfolocalizedObject=CatalogUtils.localizeLayer((LayerInfo)info,catalog);catalog.firePostModified(ModificationProxy.unwrap(localizedObject),modifyEv.getPropertyNames(),modifyEv.getOldValues(),modifyEv.getNewValues());
else
if(infoinstanceofMapInfo){finalMapInfolocalizedObject=CatalogUtils.localizeMapInfo((MapInfo)info,catalog);catalog.firePostModified(ModificationProxy.unwrap(localizedObject),modifyEv.getPropertyNames(),modifyEv.getOldValues(),modifyEv.getNewValues());
else
if(infoinstanceofNamespaceInfo){finalNamespaceInfolocalizedObject=CatalogUtils.localizeNamespace((NamespaceInfo)info,catalog);catalog.firePostModified(ModificationProxy.unwrap(localizedObject),modifyEv.getPropertyNames(),modifyEv.getOldValues(),modifyEv.getNewValues());
else
if(infoinstanceofStoreInfo){finalStoreInfolocalizedObject=CatalogUtils.localizeStore((StoreInfo)info,catalog);catalog.firePostModified(ModificationProxy.unwrap(localizedObject),modifyEv.getPropertyNames(),modifyEv.getOldValues(),modifyEv.getNewValues());
else
if(infoinstanceofResourceInfo){finalResourceInfolocalizedObject=CatalogUtils.localizeResource((ResourceInfo)info,catalog);catalog.firePostModified(ModificationProxy.unwrap(localizedObject),modifyEv.getPropertyNames(),modifyEv.getOldValues(),modifyEv.getNewValues());
else
if(infoinstanceofStyleInfo){finalStyleInfolocalizedObject=CatalogUtils.localizeStyle((StyleInfo)info,catalog);catalog.firePostModified(ModificationProxy.unwrap(localizedObject),modifyEv.getPropertyNames(),modifyEv.getOldValues(),modifyEv.getNewValues());
else
if(infoinstanceofWorkspaceInfo){finalWorkspaceInfolocalizedObject=CatalogUtils.localizeWorkspace((WorkspaceInfo)info,catalog);catalog.firePostModified(ModificationProxy.unwrap(localizedObject),modifyEv.getPropertyNames(),modifyEv.getOldValues(),modifyEv.getNewValues());
else
if(infoinstanceofCatalogInfo){
if(LOGGER.isLoggable(java.util.logging.Level.WARNING)){LOGGER.warning("info-ID:"+info.getId()+"toString:"+info.toString());
else{
if(LOGGER.isLoggable(java.util.logging.Level.WARNING)){LOGGER.warning("info-ID:"+info.getId()+"toString:"+info.toString());
if(id.equalsIgnoreCase("getLegendGraphic")){finalObject[]params=operation.getParameters();
if(params!=null&&params.length>0&&params[0]instanceofGetLegendGraphicRequest){finalGetLegendGraphicRequestgetLegendRequest=(GetLegendGraphicRequest)params[0];try{for(LegendRequestlegend:getLegendRequest.getLegends()){ProcessFunctiontransformation=getDynamicColorMapTransformation(legend);
if(transformation!=null){LayerInfolayer=legend.getLayerInfo();
if(layer!=null&&layer.getResource()instanceofCoverageInfo){CoverageInfocoverageInfo=(CoverageInfo)layer.getResource();List<CoverageDimensionInfo>dimensions=coverageInfo.getDimensions();Stringunit="";
if(dimensions!=null&&!dimensions.isEmpty()){CoverageDimensionInfodimensionInfo=dimensions.get(0);unit=dimensionInfo.getUnit();
if(unit==null){unit="";
if(style!=null){legend.setStyle(style);
ifany.**@paramstyles*/privateProcessFunctiongetDynamicColorMapTransformation(LegendRequestlegendRequest){
if(legendRequest.getStyle()!=null){finalStylestyle=legendRequest.getStyle();finalFeatureTypeStyle[]featureTypeStyles=style.featureTypeStyles().toArray(newFeatureTypeStyle[0]);for(FeatureTypeStylefeatureTypeStyle:featureTypeStyles){//GettingthemaintransformationExpressiontransformation=featureTypeStyle.getTransformation();
if(transformationinstanceofProcessFunction){finalProcessFunctionprocessFunction=(ProcessFunction)transformation;finalStringprocessName=processFunction.getName();//CheckingwhethertheprocessFunctionisaDynamicColorMapProcess
if(processName.equals(DynamicColorMapProcess.NAME)||processName.equals("ras:"+DynamicColorMapProcess.NAME)){returnprocessFunction;
if(paramValueinstanceofColorMap){cm=(ColorMap)paramValue;
else{
if("opacity".equals(key)&&paramValue!=null){opacity=((Number)paramValue).doubleValue();
if(cm!=null){StyleBuildersb=newStyleBuilder();RasterSymbolizerrs=sb.createRasterSymbolizer(cm,opacity);returnsb.createStyle(rs);
if(coverage!=null){RasterCleaner.addCoverage(coverage);
ifpresent**@paramdimensions*@parammetadata*@paramreadParameters*@paramparameterDescriptors*@parammap*@throwsIOException*/privateGeneralParameterValue[]parseCustomDomains(finalReaderDimensionsAccessordimensions,finalMetadataMapmetadata,GeneralParameterValue[]readParameters,finalList<GeneralParameterDescriptor>parameterDescriptors,finalMap<String,Object>map)throwsIOException{List<String>customDomains=newArrayList(dimensions.getCustomDomains());
if(customDomains!=null&&customDomains.size()>0){Set<String>params=map.keySet();for(StringparamName:params){
if(paramName.regionMatches(true,0,"dim_",0,4)){Stringname=paramName.substring(4);//Gettingthedimensionname=caseInsensitiveLookup(customDomains,name);
if(name!=null){finalDimensionInfocustomInfo=metadata.get(ResourceInfo.CUSTOM_DIMENSION_PREFIX+name,DimensionInfo.class);
if(dimensions.hasDomain(name)&&customInfo!=null&&customInfo.isEnabled()){finalArrayList<String>val=newArrayList<String>(1);Stringvalue=(String)map.get(paramName);
if(value.indexOf(",")>0){String[]elements=value.split(",");val.addAll(Arrays.asList(elements));
else{val.add(value);
ifpresent.**@parammetadatatheelevationInfometadataobject*@paramreadParametersthereadParameterstobeset*@paramparameterDescriptorsthereader'sparameterdescriptors*@parammaptherequest'sparameters*@returntheupdatedparameterset*@throwsParseException*/privateGeneralParameterValue[]parseElevationParameter(finalMetadataMapmetadata,GeneralParameterValue[]readParameters,finalList<GeneralParameterDescriptor>parameterDescriptors,finalMap<String,Object>map){finalDimensionInfoelevationInfo=metadata.get(ResourceInfo.ELEVATION,DimensionInfo.class);
if(elevationInfo!=null&&elevationInfo.isEnabled()){//handle"current"Set<String>params=map.keySet();for(Stringparam:params){
if(param.equalsIgnoreCase("elevation")){readParameters=CoverageUtils.mergeParameter(parameterDescriptors,readParameters,Double.valueOf((String)map.get(param)),"ELEVATION","Elevation");break;
ifpresent.**@parammetadatathetimeInfometadataobject*@paramreadParametersthereadParameterstobeset*@paramparameterDescriptorsthereader'sparameterdescriptors*@parammaptherequest'sparameters*@returntheupdatedparameterset*@throwsParseException*/privateGeneralParameterValue[]parseTimeParameter(finalMetadataMapmetadata,GeneralParameterValue[]readParameters,finalList<GeneralParameterDescriptor>parameterDescriptors,finalMap<String,Object>map)throwsParseException{finalDimensionInfotimeInfo=metadata.get(ResourceInfo.TIME,DimensionInfo.class);
if(timeInfo!=null&&timeInfo.isEnabled()){finalSet<String>params=map.keySet();for(Stringparam:params){
if(param.equalsIgnoreCase("time")){//passdowntheparametersreadParameters=CoverageUtils.mergeParameter(parameterDescriptors,readParameters,parser.parse((String)map.get(param)),"TIME","Time");break;
if(name.equalsIgnoreCase(s)){returns;
if(target.equals(Range.class)&&source.equals(String.class)){returnnewConverter(){public<T>Tconvert(Objectsource,Class<T>target)throwsException{StringsRange=(String)source;Matcherm=RANGE_PATTERN.matcher(sRange);
if(!m.matches())returnnull;return(T)parseRangeInternal(m,sRange);
if(m.groupCount()!=4){thrownewIllegalStateException("Rangereturnedwronggroupcount("+sRange+"):"+m.groupCount());
if(m.group(2)!=null){min=newDouble(m.group(2));
if(m.group(3)!=null){max=newDouble(m.group(3));
if(m.group(1).equals("("))inclmin=false;
else
if(m.group(1).equals("["))inclmin=true;
elsethrownewIllegalArgumentException("Badmindelimiter("+sRange+")");booleaninclmax;
if(m.group(4).equals(")"))inclmax=false;
else
if(m.group(4).equals("]"))inclmax=true;
elsethrownewIllegalArgumentException("Badmaxdelimiter("+sRange+")");
if(min!=null&&max!=null&&min>max)thrownewIllegalArgumentException("Badmin/maxrelation("+sRange+")");returnnewRange<Double>(min,inclmin,max,inclmax);
if(!m.matches())thrownewIllegalArgumentException("Badrangedefinition'"+sRangeList+"'");//fetcheverysinglerangem=RANGE_PATTERN.matcher(sRangeList);List<Range<Double>>ret=newArrayList<Range<Double>>();while(m.find()){Range<Double>range=parseRangeInternal(m,sRangeList);ret.add(range);
if(dimensionCollection==null){thrownewServiceException("Nodimensioncollectiongiven,cannotselectdefaultvaluefordimensionbasedonattribute"+dimension.getAttribute());
if(sf.getAttribute(indexProp).equals(value)){returntrue;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(format("%s-Publishingevent%s",nodeId(),e));
if(!(member.localMember())){expectedAcks++;
if(countDown!=null){countDown.decrementAndGet();StringoriginAddr=null;MemberpublishingMember=message.getPublishingMember();
if(publishingMember!=null){InetSocketAddresssocketAddress=publishingMember.getSocketAddress();
if(socketAddress!=null){originAddr=addressString(socketAddress);
if(remainingAcks<=0){return;
if(!(eventinstanceofConfigChangeEvent)){return;
if(CatalogInfo.class.isAssignableFrom(clazz)){processCatalogEvent(ce);
else{processGeoServerConfigEvent(ce);
switch(t){caseADD:subj=getCatalogInfo(cat,id,clazz);notifyMethod=CatalogListener.class.getMethod("handleAddEvent",CatalogAddEvent.class);evt=newCatalogAddEventImpl();break;caseMODIFY:subj=getCatalogInfo(cat,id,clazz);notifyMethod=CatalogListener.class.getMethod("handlePostModifyEvent",CatalogPostModifyEvent.class);evt=newCatalogPostModifyEventImpl();break;caseREMOVE:notifyMethod=CatalogListener.class.getMethod("handleRemoveEvent",CatalogRemoveEvent.class);evt=newCatalogRemoveEventImpl();RemovedObjectProxyproxy=newRemovedObjectProxy(id,name,clazz,nativeName);
if(ResourceInfo.class.isAssignableFrom(clazz)&&event.getStoreId()!=null){proxy.addCatalogCollaborator("store",cat.getStore(event.getStoreId(),StoreInfo.class));
if(subj==null){//can'thappen
iftype==DELETE
if(subj==null){Stringmessage=format("%s-Errorprocessingevent%s:objectnotfoundincatalog",nodeId(),event);LOGGER.warning(message);return;
if(l!=this&&isStarted()){notifyMethod.invoke(l,evt);
if(GeoServerInfo.class.isAssignableFrom(clazz)){subj=gs.getGlobal();notifyMethod=ConfigurationListener.class.getMethod("handlePostGlobalChange",GeoServerInfo.class);
else
if(SettingsInfo.class.isAssignableFrom(clazz)){WorkspaceInfows=ce.getWorkspaceId()!=null?cat.getWorkspace(ce.getWorkspaceId()):null;subj=ws!=null?gs.getSettings(ws):gs.getSettings();notifyMethod=ConfigurationListener.class.getMethod("handleSettingsPostModified",SettingsInfo.class);
else
if(LoggingInfo.class.isAssignableFrom(clazz)){subj=gs.getLogging();notifyMethod=ConfigurationListener.class.getMethod("handlePostLoggingChange",LoggingInfo.class);
else
if(ServiceInfo.class.isAssignableFrom(clazz)){subj=gs.getService(id,(Class<ServiceInfo>)clazz);notifyMethod=ConfigurationListener.class.getMethod("handlePostServiceChange",ServiceInfo.class);
else{thrownewIllegalStateException("Unknowneventtype"+clazz);
if(l!=this)notifyMethod.invoke(l,subj);
if(WorkspaceInfo.class.isAssignableFrom(clazz)){subj=cat.getWorkspace(id);
else
if(NamespaceInfo.class.isAssignableFrom(clazz)){subj=cat.getNamespace(id);
else
if(StoreInfo.class.isAssignableFrom(clazz)){subj=cat.getStore(id,(Class<StoreInfo>)clazz);
else
if(ResourceInfo.class.isAssignableFrom(clazz)){subj=cat.getResource(id,(Class<ResourceInfo>)clazz);
else
if(LayerInfo.class.isAssignableFrom(clazz)){subj=cat.getLayer(id);
else
if(StyleInfo.class.isAssignableFrom(clazz)){subj=cat.getStyle(id);
else
if(LayerGroupInfo.class.isAssignableFrom(clazz)){subj=cat.getLayerGroup(id);
ifavailableIdentifieridentifier=feature.getIdentifier();
if(identifier!=null){jsonWriter.key("id").value(identifier.getID());
iftheprovidedfeaturehasno*geometryattribute.*/privatePropertyencodeGeometry(Featurefeature){//getfeaturegeometryattributedescriptionGeometryDescriptorgeometryType=feature.getType().getGeometryDescriptor();PropertygeometryAttribute=null;Geometrygeometry=null;
if(geometryType!=null){//extractCRSinformationfromthegeometryattributedescriptionCoordinateReferenceSystemcrs=geometryType.getCoordinateReferenceSystem();//weletthesetAxisOrdermethodhandletheNULLcasejsonWriter.setAxisOrder(CRS.getAxisOrder(crs));
if(crs!=null){//storethefoundCRS,thismaybeusefulfortheinvokerthis.crs=crs;
else{//thisfeatureseemstonothaveageometry,writethedefaultaxisorderjsonWriter.setAxisOrder(CRS.AxisOrder.EAST_NORTH);
if(geometry!=null){//thefeaturehasageometrysoencodeitjsonWriter.writeGeom(geometry);//storethatwefoundageometry,thismaybeusefulfortheinvokergeometryFound=true;
else{//nogeometryjustwriteaNULLvaluejsonWriter.value(null);
if(geometryAttribute!=null&&property.equals(geometryAttribute)){//ignorethegeometryattributethatshouldhavebeenencodedalreadycontinue;
if(propertiesWithSameType==null){//firsttimeweseeapropertyfothistypepropertiesWithSameType=newArrayList<>();index.put(property.getType(),propertiesWithSameType);
if(multipleType==null){//simpleJSONobjectsproperties.forEach(this::encodeProperty);
else{//possiblechainedfeaturesthatneedtobeencodedasalistList<Feature>chainedFeatures=getChainedFeatures(properties);
if(chainedFeatures==null||chainedFeatures.isEmpty()){//nochainedfeaturesjustencodeeachpropertyproperties.forEach(this::encodeProperty);
else{//chainedfeaturessoweneedtoencodethechainedfeaturesasanarrayencodeChainedFeatures(multipleType.getName().getLocalPart(),chainedFeatures);
ifapropertytypeshouldappearmultipletimesorbeencodedasalist.*/privatePropertyDescriptorisMultipleType(PropertyTypeparentType,PropertyTypetype){
if(!(parentTypeinstanceofComplexType)){//onlypropertiesthatbelongtoacomplextypecanbechainedfeaturesreturnnull;
if(descriptor.getType().equals(type)){//foundourtypefoundType=descriptor;
ifthefoundtypecanappearmultiplestimeisnotachainedfeature
if(foundType==null){returnnull;
if(foundType.getMaxOccurs()>1){//thistypecanappearmorethanoncesoitshouldnotbeencodedasalistreturnfoundType;
ifthispropertiesarenotchained*features.*/privateList<Feature>getChainedFeatures(List<Property>properties){List<Feature>features=newArrayList<>();for(Propertyproperty:properties){
if(!(propertyinstanceofComplexAttribute)){//onlythechainingofcomplexfeaturesissupportedreturnnull;
if(subProperties.size()>1){//morethanonepropertymeansthatthisarenotchainedfeaturesreturnnull;
if(!(subPropertyinstanceofFeature)){//
iftheonlypropertyisnotafeaturethisarenochainedfeaturesreturnnull;
if*anothertyeofattributeisusedanexceptionwillbethrow.*/privatevoidencodeProperty(Propertyproperty){
if(propertyinstanceofComplexAttribute){//check
ifwehaveasimplecontentComplexAttributecomplexAttribute=(ComplexAttribute)property;ObjectsimpleValue=getSimpleContent(complexAttribute);
if(simpleValue!=null){encodeSimpleAttribute(complexAttribute.getName().getLocalPart(),simpleValue);
else{//weneedtoencodeacomplexattributeencodeComplexAttribute((ComplexAttribute)property);
else
if(propertyinstanceofAttribute){//check
ifwehaveafeatureorlistoffeatures(chainedfeatures)List<Feature>features=getFeatures((Attribute)property);
if(features!=null){encodeChainedFeatures(property.getName().getLocalPart(),features);
else{//weneedtoencodeasimpleattributeencodeSimpleAttribute((Attribute)property);
else{//unsupportedattributetypeprovided,thiswillunlikelyhappenthrownewRuntimeException(String.format("Invalidproperty'%s'oftype'%s',only'Attribute'and'ComplexAttribute'propertiestypesaresupported.",property.getName(),property.getClass().getCanonicalName()));
if(valueinstanceofFeature){//featurefoundreturnitinasingletonlistreturnCollections.singletonList((Feature)value);
if(!(valueinstanceofCollection)){//notafeatureorlistoffeaturesreturnnull;
if(collection.isEmpty()){//wecannotbesurethatthisisalistoffeaturesreturnCollections.emptyList();
if(!(getElementAt(collection,0)instanceofFeature)){//listdoesn'tcontainfeaturesreturnnull;
if(!(objectinstanceofFeature)){//notafeaturethisisamixedcollectionthrownewRuntimeException(String.format("Unabletohandleattribute'%s'.",attribute));
ifnosimplecontentispresent.*/privateObjectgetSimpleContent(ComplexAttributeproperty){Collection<Property>properties=property.getProperties();
if(properties.isEmpty()||properties.size()>1){//nopropertiesormorethanpropertymeannosimplecontentreturnnull;
if(simpleContent==null){//simplecontentisNULLendextractionherereturnnull;
if(name==null||!name.getLocalPart().equals("simpleContent")){//notasimplecontentnodereturnnull;
if(valueinstanceofNumber||valueinstanceofString||valueinstanceofCharacter){//theextractvalueisasimpleJavatypereturnvalue;
ifageometrywasfoundduringthefeaturescollectionsencoding.*/publicbooleangeometryFound(){returngeometryFound;
ifonewasfoundduringthefeaturescollectionsencoding.*/publicCoordinateReferenceSystemfoundCrs(){returncrs;
if*userhasnotfilledincontactdetails.*/StringgetOnlineResource();/***Providerwebsite(usedfordefaultcontactinformation,orserviceproviderinformation
if*userhasnotfilledincontactdetails.**@paramonlineResourceProviderwebsite*/voidsetOnlineResource(StringonlineResource);/***TheurlofaproxyinfrontoftheGeoServerinstance.**<p>ThisvalueisusedwhenareferencebacktotheGeoServerinstancemustbemadeina*response.*/StringgetProxyBaseUrl();/**SetsTheurlofaproxyinfrontoftheGeoServerinstance.*/voidsetProxyBaseUrl(StringproxyBaseUrl);/**Thebaseurltousewhenincludingareferencetoanxmlschemadocumentinaresponse.*/StringgetSchemaBaseUrl();/***Setsthebaseurltousewhenincludingareferencetoanxmlschemadocumentinaresponse.*/voidsetSchemaBaseUrl(StringschemaBaseUrl);/***SetsindentlevelforXMLoutput,causingoutputtobemoreverbose.**<p>ThensettofalseGeoServerwillalsotakestepsotostripoutsomeformatingandproduce*morecondensedoutput.*/booleanisVerbose();/***SetsindentlevelforXMLoutput,causingoutputtobemoreverbose.**<p>ThensettofalseGeoServerwillalsotakestepsotostripoutsomeformatingandproduce*morecondensedoutput.*/voidsetVerbose(booleanverbose);/***Verbosityflagforexceptions.**<p>WhensetGeoServerwillincludefullstacktracesforexceptions.*/booleanisVerboseExceptions();/**Setsverbosityflagforexceptions.*/voidsetVerboseExceptions(booleanverboseExceptions);/**Amapofmetadataforservices.*/MetadataMapgetMetadata();/***Clientpropertiesforservices.**<p>Thesevaluesaretransient,andnotpersistent.*/Map<Object,Object>getClientProperties();/**IftruelocalworkspaceshouldkeepthenamespaceprefixesingetCapabilitiesetc...*/booleanisLocalWorkspaceIncludesPrefix();/***SetwhetherornotalocalworkspaceshouldkeepnamespaceprefixesinthegetCapabilities*etc...**@paramincludePrefix
iftruethentheprefixeswillbekept,defaultbehaviouristoremove*it.*/voidsetLocalWorkspaceIncludesPrefix(booleanincludePrefix);}
if(computedMimeType==null||computedMimeType.isEmpty()){StringcomputedMimeType=ogr2OgrOutputFormat.getMimeType(null,operation);
if(of.getGeoserverFormat()!=null&&!of.getGeoserverFormat().isEmpty()){computedMimeType=computedMimeType+";subtype="+of.getGeoserverFormat();
if(of.getType()==null){//Binaryisdefaulttypeppio=newOgrBinaryPPIO(computedMimeType,of.getFileExtension(),ogr2OgrOutputFormat,operation);
else{
switch(of.getType()){caseBINARY:ppio=newOgrBinaryPPIO(computedMimeType,of.getFileExtension(),ogr2OgrOutputFormat,operation);break;caseTEXT:ppio=newOgrCDataPPIO(computedMimeType,of.getFileExtension(),ogr2OgrOutputFormat,operation);break;caseXML:ppio=newOgrXMLPPIO(computedMimeType,of.getFileExtension(),ogr2OgrOutputFormat,operation);break;default:break;
if(ppio!=null){ogrParams.add(ppio);
if(parentDirectory==null){//getthedirectoryformtheURIURIfileLocation=repoModel.getObject().getLocation();
if(fileLocation!=null&&"file".equals(fileLocation.getScheme())){Pathfile=Paths.get(fileLocation);parentDirectory=file.normalize().getParent().toString();
if(repoModel!=null){repoModel.detach();
if(kvp.containsKey(COLORSCALERANGE)){StringscaleRangeSpec=(String)rawKvp.get(COLORSCALERANGE);NumberRange<Double>range=parseColorScaleRange(scaleRangeSpec);EnvFunction.setLocalValue(PaletteParser.RANGE_MIN,range.getMinimum());EnvFunction.setLocalValue(PaletteParser.RANGE_MAX,range.getMaximum());
if(kvp.containsKey(OPACITY)){Stringstr=(String)rawKvp.get(OPACITY);Integervalue=Converters.convert(str,Integer.class);
if((value==null&&str!=null&&!str.trim().isEmpty())||(value!=null&&(value<0||value>100))){thrownewServiceException("Expectedaintvaluebetween0and100forOPACITYbutfound'"+str+"'instead",ServiceException.INVALID_PARAMETER_VALUE,"OPACITY");
if(kvp.containsKey(ANIMATION)){Stringstr=(String)rawKvp.get(ANIMATION);Booleananimate=Converters.convert(str,Boolean.class);
if((animate==null&&str!=null&&!str.trim().isEmpty())){thrownewServiceException("ExpectedabooleanvalueforANIMATIONbutfound'"+str+"'instead",ServiceException.INVALID_PARAMETER_VALUE,"ANIMATION");
if(animate){Stringformat=(String)rawKvp.get("format");
if(!gifResponse.getOutputFormats().contains(format)){thrownewServiceException("Animationissupportedonlywithimage/gifoutputformat",ServiceException.INVALID_PARAMETER_VALUE,"format");
else
if(!GIFMapResponse.IMAGE_GIF_SUBTYPE_ANIMATED.equals(format)){//
switchtoanimatedmoderawKvp.put("format",GIFMapResponse.IMAGE_GIF_SUBTYPE_ANIMATED);kvp.put("format",GIFMapResponse.IMAGE_GIF_SUBTYPE_ANIMATED);
if(kvp.containsKey(ncWmsParameter)){Stringstr=(String)rawKvp.get(ncWmsParameter);Objectvalue=Converters.convert(str,targetClass);
if(value==null&&str!=null&&!str.trim().isEmpty()){thrownewServiceException("Expectedavalueoftype"+targetClass.getSimpleName()+"for"+ncWmsParameter+"butfound'"+str+"'instead",ServiceException.INVALID_PARAMETER_VALUE,ncWmsParameter);
if(elements.length!=2){thrownewServiceException(COLORSCALERANGE+"mustbespecifiedas'min,max'whereminandmaxarenumbers",ServiceException.INVALID_PARAMETER_VALUE,COLORSCALERANGE);
if(asynchService==null){//createafixedsizepool.Ifweallowadeltabetweencoreandmax//thepoolwillcreatenewthreadsonly
ifthequeueisfull,butthelinkedqueue//neverisasynchService=newThreadPoolExecutor(maxAsynchronousProcesses,maxAsynchronousProcesses,0L,TimeUnit.MILLISECONDS,newLinkedBlockingQueue<Runnable>());
else{asynchService.setCorePoolSize(maxAsynchronousProcesses);asynchService.setMaximumPoolSize(maxAsynchronousProcesses);
if(synchService==null){//createafixedsizepool.Ifweallowadeltabetweencoreandmax//thepoolwillcreatenewthreadsonly
ifthequeueisfull,butthelinkedqueue//neverissynchService=newThreadPoolExecutor(maxSynchronousProcesses,maxSynchronousProcesses,0L,TimeUnit.MILLISECONDS,newLinkedBlockingQueue<Runnable>());
else{synchService.setCorePoolSize(maxSynchronousProcesses);synchService.setMaximumPoolSize(maxSynchronousProcesses);
if(eventinstanceofContextRefreshedEvent){
if(eventinstanceofContextClosedEvent){synchService.shutdownNow();asynchService.shutdownNow();
if(pf==null){thrownewWPSException("Nosuchprocess:"+processName);
if(background){future=asynchService.submit(callable);
else{future=synchService.submit(callable);
if(future==null){returnnull;
if(timeout<=0){result=future.get();
else{result=future.get(timeout,TimeUnit.MILLISECONDS);
if(einstanceofExecutionException&&e.getCause()instanceofException){e=(Exception)e.getCause();
if(einstanceofProcessException){throw(ProcessException)e;
else
if(einstanceofWPSException){throw(WPSException)e;
else{thrownewProcessException("Processexecution"+executionId+"failed",e);
if(!timedOut){//we'redoneexecutions.remove(executionId);
if(future!=null){future.cancel(true);
if(pf==null){thrownewWPSException("Nosuchprocess:"+processName);
if(dataAccessinstanceofSolrDataStore){returntrue;
else{returnfalse;
if(configuration!=null){SolrDataStoredataStore=(SolrDataStore)dataAccess;dataStore.setSolrConfigurations(configuration);
if(event.getSource()instanceofFeatureTypeInfo){FeatureTypeInfoft=(FeatureTypeInfo)event.getSource();Serializableconfig=ft.getMetadata().get(SolrLayerConfiguration.KEY);
if(configinstanceofSolrLayerConfiguration){updateSolrConfiguration(ft,(SolrLayerConfiguration)config);
ifthelayerisaSOLRone
if(event.getSource()instanceofFeatureTypeInfo){FeatureTypeInfoft=(FeatureTypeInfo)event.getSource();Serializableconfig=ft.getMetadata().get(SolrLayerConfiguration.KEY);
if(configinstanceofSolrLayerConfiguration){SolrLayerConfigurationslc=(SolrLayerConfiguration)config;//godirectlytotheresourcepooltoavoidsecuritywrapperstry{DataAccess<?extendsFeatureType,?extendsFeature>dataStore=catalog.getResourcePool().getDataStore(ft.getStore());
if(dataStoreinstanceofSolrDataStore){SolrDataStoresolr=(SolrDataStore)dataStore;solr.getSolrConfigurations().remove(slc.getLayerName());
ifthelayerisaSOLRone
if(event.getSource()instanceofFeatureTypeInfo){FeatureTypeInfoft=(FeatureTypeInfo)event.getSource();Serializableconfig=ft.getMetadata().get(SolrLayerConfiguration.KEY);
if(configinstanceofSolrLayerConfiguration){SolrLayerConfigurationslc=(SolrLayerConfiguration)config;
if(!ft.getName().equals(slc.getLayerName())){updateSolrConfiguration(ft,slc);
if(dataStoreinstanceofSolrDataStore){SolrDataStoresolr=(SolrDataStore)dataStore;solr.getSolrConfigurations().remove(slc.getLayerName());slc.setLayerName(ft.getName());solr.setSolrConfigurations(slc);
if("line".equalsIgnoreCase(type)){LineSymbolizerls=styleFactory.createLineSymbolizer();ls.setStroke(styleFactory.createStroke(filterFactory.literal(color),filterFactory.literal(2)));sym=ls;
else
if("polygon".equalsIgnoreCase(type)){PolygonSymbolizerps=styleFactory.createPolygonSymbolizer();ps.setFill(styleFactory.createFill(filterFactory.literal(color)));sym=ps;
else
if("raster".equalsIgnoreCase(type)){RasterSymbolizerrs=styleFactory.createRasterSymbolizer();sym=rs;
else{Markmark=styleFactory.createMark();mark.setFill(styleFactory.createFill(filterFactory.literal(color)));PointSymbolizerps=styleFactory.createPointSymbolizer();ps.setGraphic(styleFactory.createDefaultGraphic());ps.getGraphic().graphicalSymbols().add(mark);sym=ps;
if(color==null){returndef;
if(syminstanceofPointSymbolizer){props.put("type","point");
else
if(syminstanceofLineSymbolizer){props.put("type","line");
else
if(syminstanceofPolygonSymbolizer){props.put("type","polygon");
else
if(syminstanceofRasterSymbolizer){props.put("type","raster");
ifGeoServerEnvParametrizationisenabled!
if(gsEnvironment==null||!GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){capabilitiesURL.getFormComponent().add(newWMSCapabilitiesURLValidator());
iftheprocessfailssomehowtheoriginal"info"doesnotend*upwithanidset*/WMSStoreInfoexpandedStore=getCatalog().getResourcePool().clone(info,true);WMSStoreInfosavedStore=getCatalog().getFactory().createWebMapServer();//GR:thisshouldn'tfail,theCatalog.save(StoreInfo)APIdoesnotdeclareanyactionin//caseofafailure!...strange,whyasavecan'tfail?//Still,becautiousandwrapitinatry/catchblocksothepagedoesnotblowuptry{//GeoServerEnvsubstitution;validatefirstgetCatalog().validate(expandedStore,false).throwIfInvalid();//GeoServerEnvsubstitution;forceto*AVOID*resolvingenvplaceholders...savedStore=getCatalog().getResourcePool().clone(info,false);//...andsavegetCatalog().save(savedStore);
if(user!=null&&user.length()>0&&pwd!=null&&pwd.length()>0){client.setUser(user);client.setPassword(pwd);
if(provider!=null){EntityResolverentityResolver=provider.getEntityResolver();
if(entityResolver!=null){hints.put(XMLHandlerHints.ENTITY_RESOLVER,entityResolver);
if(message==null)thrownewNullPointerException("Messagecannotbenull");
if(argument==null)thrownewNullPointerException(message+"cannotbenull");
if(legendOptions!=null&&legendOptions.get("layout")!=null){try{layout=LegendLayout.valueOf(((String)legendOptions.get("layout")).toUpperCase());
if(legendOptions!=null&&legendOptions.get("grouplayout")!=null){try{layout=LegendLayout.valueOf(((String)legendOptions.get("grouplayout")).toUpperCase());
if(legendOptions!=null&&legendOptions.get("columnheight")!=null){try{columnheight=Integer.parseInt((String)legendOptions.get("columnheight"));
if(legendOptions!=null&&legendOptions.get("rowwidth")!=null){try{rowwidth=Integer.parseInt((String)legendOptions.get("rowwidth"));
if(legendOptions!=null&&legendOptions.get("columns")!=null){try{columns=Integer.parseInt((String)legendOptions.get("columns"));
if(legendOptions!=null&&legendOptions.get("rows")!=null){try{rows=Integer.parseInt((String)legendOptions.get("rows"));
if(legendOptions==null)returnDEFAULT_FONT;StringlegendFontName=LegendUtils.DEFAULT_FONT_NAME;
if(legendOptions.get("fontName")!=null){legendFontName=(String)legendOptions.get("fontName");
if(legendOptions.get("fontStyle")!=null){StringlegendFontFamily_=(String)legendOptions.get("fontStyle");
if(legendFontFamily_.equalsIgnoreCase("italic")){legendFontFamily=Font.ITALIC;
else
if(legendFontFamily_.equalsIgnoreCase("bold")){legendFontFamily=Font.BOLD;
if(legendOptions.get("fontSize")!=null){try{legendFontSize=Integer.valueOf((String)legendOptions.get("fontSize"));
if(dpi!=standardDpi){doublescaleFactor=dpi/standardDpi;legendFontSize=(int)Math.ceil(legendFontSize*scaleFactor);
if(legendFontFamily==LegendUtils.DEFAULT_FONT_TYPE&&legendFontName.equalsIgnoreCase(LegendUtils.DEFAULT_FONT_NAME)&&(legendFontSize==LegendUtils.DEFAULT_FONT_SIZE||legendFontSize<=0))returnDEFAULT_FONT;returnnewFont(legendFontName,legendFontFamily,legendFontSize);
if(color==null){//returnthedefaultreturnDEFAULT_FONT_COLOR;
if(LOGGER.isLoggable(Level.WARNING))LOGGER.warning("Couldnotdecodelabelcolor:"+color+",defaultto"+DEFAULT_FONT_COLOR.toString());returnDEFAULT_FONT_COLOR;
ifthegraphicsshouldbetextantialiasing**@paramreqthe{@linkGetLegendGraphicRequest}fromwhichtoextractfontantialiasing*information.*@returntrue
ifthefontAntiAliasingissettoon*/publicstaticbooleanisFontAntiAliasing(finalGetLegendGraphicRequestreq){
if(req.getLegendOptions().get("fontAntiAliasing")instanceofString){StringaaVal=(String)req.getLegendOptions().get("fontAntiAliasing");
if(aaVal.equalsIgnoreCase("on")||aaVal.equalsIgnoreCase("true")||aaVal.equalsIgnoreCase("yes")||aaVal.equalsIgnoreCase("1")){returntrue;
ifnobgcolorwerepassed.*/publicstaticColorgetBackgroundColor(finalGetLegendGraphicRequestreq){ensureNotNull(req,"GetLegendGraphicRequestre");finalMap<String,Object>legendOptions=req.getLegendOptions();
if(legendOptions==null)returnDEFAULT_BG_COLOR;Objectclr=legendOptions.get("bgColor");
if(clrinstanceofColor){return(Color)clr;
else
if(clr==null){//returnthedefaultreturnDEFAULT_BG_COLOR;
ifsomethingbadhappens.*@throwsIllegalArgumentException*@throwsMissingResourceException*/publicstaticdoublegetOpacity(finalColorMapEntryentry)throwsIllegalArgumentException,MissingResourceException{ensureNotNull(entry,"ColorMapEntry");////////Asstatedin<a//href="https://portal.opengeospatial.org/files/?artifact_id=1188">//OGCStyled-LayerDescriptorReport(OGC02-070)version//1.0.0.</a>://"Notallsystemscansupportopacityincolormaps.Thedefault//opacityis1.0(fullyopaque)."//////Expressionopacity=entry.getOpacity();DoubleopacityValue=null;
if(opacity!=null)opacityValue=opacity.evaluate(null,Double.class);
elsereturn1.0;
if(opacityValue==null&&opacityinstanceofLiteral){StringopacityExp=opacity.evaluate(null,String.class);opacity=ExpressionExtractor.extractCqlExpressions(opacityExp);opacityValue=opacity.evaluate(null,Double.class);
if((opacityValue.doubleValue()-1)>0||opacityValue.doubleValue()<0){thrownewIllegalArgumentException(Errors.format(ErrorKeys.ILLEGAL_ARGUMENT_$2,"Opacity",opacityValue));
if(hex.startsWith("0x")){hex=hex.substring(2);
if(!hex.startsWith("#")){hex="#"+hex;
if(colorString!=null&&colorString.startsWith("${")){color=ExpressionExtractor.extractCqlExpressions(colorString);colorString=color.evaluate(null,String.class);
if(quantityString==null&&quantityinstanceofLiteral){StringquantityExp=quantity.evaluate(null,String.class);quantity=ExpressionExtractor.extractCqlExpressions(quantityExp);quantityString=quantity.evaluate(null,Double.class);
ifany,intheordertheyappear*/finalList<Rule>ruleList=newArrayList<Rule>();//getapplicablerulesatthecurrentscalefor(inti=0;i<ftStyles.length;i++){FeatureTypeStylefts=ftStyles[i];Rule[]rules=fts.getRules();for(intj=0;j<rules.length;j++){Ruler=rules[j];
if(isWithInScale(r,scaleDenominator)){ruleList.add(r);/**I'mcommentedthisoutsinceIguessithasnosense*forproducingthelegend,sincewhetherornottherule*hasan
elsefilter,thelegendisdrawnonly
ifthe*scaledenominatorliesinsidetherule'sscalerange.
if(r.hasElseFilter()){ruleList.add(r);
ifarulecanbetriggeredatthecurrentscalelevel**@paramrTherule*@paramscaleDenominatorthescaledenominatortocheck
ifitisbetweentherule'sscale*range.-1meansthatitallwaysis.*@returntrue
ifthescaleiscompatiblewiththerulesettings*/publicstaticbooleanisWithInScale(finalRuler,finaldoublescaleDenominator){return(scaleDenominator==-1)||(((r.getMinScaleDenominator()-BufferedImageLegendGraphicBuilder.TOLERANCE)<=scaleDenominator)&&((r.getMaxScaleDenominator()+BufferedImageLegendGraphicBuilder.TOLERANCE)>scaleDenominator));
if((label.indexOf("\n")!=-1)||(label.indexOf("\\n")!=-1)){//thisisalabelWITHline-breaks...weneedtofigureoutit'sheight*and*//width,andthenadjustthelegendsizeaccordinglyRectangle2Dbounds=newRectangle2D.Double(0,0,0,0);ArrayList<Integer>lineHeight=newArrayList<Integer>();//fourbackslashes..."\\"->'\',so"\\\\n"->'\'+'\'+'n'finalStringrealLabel=label.replaceAll("\\\\n","\n");StringTokenizerst=newStringTokenizer(realLabel,"\n\r\f");while(st.hasMoreElements()){finalStringtoken=st.nextToken();Rectangle2DthisLineBounds=g.getFontMetrics().getStringBounds(token,g);//
ifthisisdirectlyaddedasthisLineBounds.getHeight(),thentherearerounding//errors//becausewecanonlyDRAWfontsatdiscreteintegercoords.finalintthisLineHeight=(int)Math.ceil(thisLineBounds.getHeight());bounds.add(0,thisLineHeight+bounds.getHeight());bounds.add(thisLineBounds.getWidth(),0);lineHeight.add((int)Math.ceil(thisLineBounds.getHeight()));
else{//thisisatraditional'regular-old'label.Justfigurethe//sizeandactaccordingly.intheight=(int)Math.ceil(g.getFontMetrics().getStringBounds(label,g).getHeight());intwidth=(int)Math.ceil(g.getFontMetrics().getStringBounds(label,g).getWidth());renderedLabel=newBufferedImage(width,height,BufferedImage.TYPE_INT_ARGB);Graphics2Drlg=renderedLabel.createGraphics();rlg.setColor(labelColor);rlg.setFont(g.getFont());rlg.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,g.getRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING));rlg.drawString(label,0,height-rlg.getFontMetrics().getDescent());rlg.dispose();
if(right==null&&center==null)returnleft;
if(left==null)thrownewNullPointerException("Leftimagecannotbenull");inttotalHeight=(int)(Math.max(left.getHeight(),Math.max((center!=null?center.getHeight():Double.NEGATIVE_INFINITY),right!=null?right.getHeight():0))+0.5);finalinttotalWidth=(int)(left.getWidth()+(center!=null?center.getWidth():0)+(right!=null?right.getWidth():0)+2*dx+0.5);finalBufferedImagefinalImage=ImageUtils.createImage(totalWidth,totalHeight,(IndexColorModel)null,transparent);finalGraphics2DfinalGraphics=ImageUtils.prepareTransparency(transparent,backgroundColor,finalImage,hintsMap);//placetheleftelementintoffsetX=0;finalGraphics.drawImage(left,offsetX,0,null);///placethecentralelementoffsetX=(int)(left.getWidth()+dx+0.5);
if(center!=null){finalGraphics.drawImage(center,offsetX,0,null);offsetX+=(int)(center.getWidth()+dx+0.5);
if(right!=null){finalGraphics.drawImage(right,offsetX,0,null);
iftheprovided{@linkFeatureType}containsacoverageasperusedbythe{@link*StreamingRenderer}.**@paramlayera{@linkFeatureType}tocheck
ifitcontainsagrid.*@return<code>true</code>
ifthislayercontainsagridcoverage,<code>false</code>*otherwise.*/publicstaticbooleancheckGridLayer(finalFeatureTypelayer){
if(!(layerinstanceofSimpleFeatureType))returnfalse;booleanfound=false;finalCollection<PropertyDescriptor>descriptors=layer.getDescriptors();for(PropertyDescriptordescriptor:descriptors){//getthetypefinalPropertyTypetype=descriptor.getType();
if(type.getBinding().isAssignableFrom(GridCoverage2D.class)||type.getBinding().isAssignableFrom(GridCoverage2DReader.class)){found=true;break;
iftheprovidedstylecontainsatleastone{@linkRasterSymbolizer}*/publicstaticbooleancheckRasterSymbolizer(finalStylestyle){for(FeatureTypeStylefts:style.featureTypeStyles()){for(Ruler:fts.rules()){for(Symbolizers:r.symbolizers()){
if(sinstanceofRasterSymbolizer){returntrue;
if(rule.equalsIgnoreCase(rules[r].getName())){sldRule=rules[r];
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(newStringBuffer("foundrequestedrule:").append(rule).toString());
ifit'savailable,butfall-backto'name'finalDescriptiondescription=rule.getDescription();Stringlabel="";
if(description!=null&&description.getTitle()!=null){finalInternationalStringtitle=description.getTitle();
if(req.getLocale()!=null){label=title.toString(req.getLocale());
else{label=title.toString();
else
if(rule.getName()!=null){label=rule.getName();
if(requestinstanceofGetFeatureType){returnnewWFS11((EObject)request);
else
if(requestinstanceofnet.opengis.wfs20.GetFeatureType){returnnewWFS20((EObject)request);
elseassertXpathCount(0,"//xsd:complexType",doc);assertXpathCount(0,"//xsd:element",doc);
if(getSession().getAuthentication()==null||!getSession().getAuthentication().isAuthenticated())model=newResourceModel("UnauthorizedPage.loginRequired");
elsemodel=newResourceModel("UnauthorizedPage.insufficientPrivileges");add(newLabel("unauthorizedMessage",model));}}
ifinferredcharsetofXMLdocumentisnotsupportedby*currentJVM.*/publicstaticReadergetCharsetAwareReader(InputStreamistream,EncodingInfoencInfo)throwsIOException,UnsupportedCharsetException{RewindableInputStreamstream;stream=newRewindableInputStream(istream,false);////Phase1.Readingfirstfourbytesanddeterminingencodingscheme.finalbyte[]b4=newbyte[4];intcount=0;for(;count<4;count++){intb=stream.read();
if(-1!=b){b4[count]=(byte)b;
else{break;
if(LOGGER.isLoggable(Level.FINER)){//Suchnumberofconcatenatingstringsmakesmesick.//ButusingStringBufferwillmakethisuglier,not?LOGGER.finer("First4bytesofXMLdocare:"+Integer.toHexString((int)b4[0]&0xff).toUpperCase()+"('"+(char)b4[0]+"')"+Integer.toHexString((int)b4[1]&0xff).toUpperCase()+"('"+(char)b4[1]+"')"+Integer.toHexString((int)b4[2]&0xff).toUpperCase()+"('"+(char)b4[2]+"')"+Integer.toHexString((int)b4[3]&0xff).toUpperCase()+"('"+(char)b4[3]+"')");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Charsetdetectionphase1.Inferredencoding:"+encInfo.toString());
if(hasBOM&&ENCODING.equals("UTF-8")){//ignorefirstthreebytes...stream.skip(3);
ifpresent.*/
if((count>1)&&(ENCODING.equals("UTF-16LE")||ENCODING.equals("UTF-16BE"))){intb0=b4[0]&0xFF;intb1=b4[1]&0xFF;
if(((b0==0xFF)&&(b1==0xFE))||((b0==0xFE)&&(b1==0xFF))){//ignorefirsttwobytes...stream.skip(2);
if("ISO-10646-UCS-4".equals(ENCODING)){
if(null!=isBigEndian){booleanisBE=isBigEndian.booleanValue();
if(isBE){reader=newUCSReader(stream,UCSReader.UCS4BE);
else{reader=newUCSReader(stream,UCSReader.UCS4LE);
else{//Fatalerror,UCSReaderwillfailtodecodethisproperlyStrings="UnsupportedbyteorderforISO-10646-UCS-4encoding.";thrownewUnsupportedCharsetException(s);
if(null==reader){reader=newInputStreamReader(stream,ENCODING);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Charsetdetectionphase2.CharsetinXMLdeclaration"+"is`"+declEncoding+"`.");
ifpossible,creatingnewoneonly
if*declaredcharsetnamediffersfromguessedone*/
if((null!=declEncoding)&&!declEncoding.equals(ENCODING)){/**IbelievethatforUCS-2encodingdefaultUTF-16reader*(whichisalreadycreatedatthistime)shouldsuffice*inmostcases.Though,wecanalwaysconstructanew*UCSReaderinstance,
ifIamwronghere.*/
if(!declEncoding.equals("ISO-10646-UCS-2")){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Declaredcharsetdiffersfrominferredone."+"TryingtoconstructInputStreamReaderfor`"+declEncoding+"`.");
ifcharsetnameisnotspecified*@throwsUnsupportedEncodingExceptionincaseswhenspecifiedcharsetisnotsupportedby*platformorduetoinvalidbyteorderfor<code>ISO-10646-UCS-2|4</code>charsets.*/publicstaticReadercreateReader(InputStreamistream,EncodingInfoencInfo)throwsIllegalArgumentException,UnsupportedEncodingException{Stringcharset=encInfo.getEncoding();BooleanisBigEndian=encInfo.isBigEndian();//WeMUSTknowencoding(infact,charset)name,andasEncodingInfo//havenon-argconstructor,its`getEncoding`canreturnnull.
if(null==charset){Strings="NameofthecharsetmustnotbeNULL!";thrownewIllegalArgumentException(s);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Tryingtocreatereaderbasingonexistingcharset"+"information:`"+encInfo+"`.");
if("ISO-10646-UCS-4".equals(charset)){
if(null!=isBigEndian){booleanisBE=isBigEndian.booleanValue();
if(isBE){reader=newUCSReader(istream,UCSReader.UCS4BE);
else{reader=newUCSReader(istream,UCSReader.UCS4LE);
else{//Fatalerror,UCSReaderwillfailtodecodethisproperlyStrings="UnsupportedbyteorderforISO-10646-UCS-4encoding.";thrownewUnsupportedEncodingException(s);
else
if("ISO-10646-UCS-2".equals(charset)){
if(null!=isBigEndian){booleanisBE=isBigEndian.booleanValue();
if(isBE){reader=newUCSReader(istream,UCSReader.UCS4BE);
else{reader=newUCSReader(istream,UCSReader.UCS4LE);
else{//CannotconstructUCSReaderwithoutbyteorderinfoStrings="ByteordermustbespecifiedforISO-10646-UCS-2.";thrownewUnsupportedEncodingException(s);
else{reader=newInputStreamReader(istream,charset);
if(count<2){returnnewEncodingInfo("UTF-8",null);
if((b0==0xFE)&&(b1==0xFF)){//UTF-16,big-endianreturnnewEncodingInfo("UTF-16BE",newBoolean(true),true);
if((b0==0xFF)&&(b1==0xFE)){//UTF-16,little-endianreturnnewEncodingInfo("UTF-16LE",newBoolean(false),true);
ifwedon'thaveenoughbytestomakea//gooddeterminationoftheencoding
if(count<3){returnnewEncodingInfo("UTF-8",null);
if((b0==0xEF)&&(b1==0xBB)&&(b2==0xBF)){returnnewEncodingInfo("UTF-8",null,true);
ifwedon'thaveenoughbytestomakea//gooddeterminationoftheencoding
if(count<4){returnnewEncodingInfo("UTF-8",null);
if((b0==0x00)&&(b1==0x00)&&(b2==0x00)&&(b3==0x3C)){//UCS-4,bigendian(1234)returnnewEncodingInfo("ISO-10646-UCS-4",newBoolean(true));
if((b0==0x3C)&&(b1==0x00)&&(b2==0x00)&&(b3==0x00)){//UCS-4,littleendian(4321)returnnewEncodingInfo("ISO-10646-UCS-4",newBoolean(false));
if((b0==0x00)&&(b1==0x00)&&(b2==0x3C)&&(b3==0x00)){//UCS-4,unusualoctetorder(2143)//REVISIT:Whatshouldthisbe?(Currentlythiswouldbe//anexception:)returnnewEncodingInfo("ISO-10646-UCS-4",null);
if((b0==0x00)&&(b1==0x3C)&&(b2==0x00)&&(b3==0x00)){//UCS-4,unusualoctectorder(3412)//REVISIT:Whatshouldthisbe?returnnewEncodingInfo("ISO-10646-UCS-4",null);
if((b0==0x00)&&(b1==0x3C)&&(b2==0x00)&&(b3==0x3F)){//UTF-16,big-endian,noBOM//(orcouldturnouttobeUCS-2...//REVISIT:Whatshouldthisbe?returnnewEncodingInfo("UTF-16BE",newBoolean(true));
if((b0==0x3C)&&(b1==0x00)&&(b2==0x3F)&&(b3==0x00)){//UTF-16,little-endian,noBOM//(orcouldturnouttobeUCS-2...returnnewEncodingInfo("UTF-16LE",newBoolean(false));
if((b0==0x4C)&&(b1==0x6F)&&(b2==0xA7)&&(b3==0x94)){//EBCDIC//alaxerces1,returnCP037insteadofEBCDICherereturnnewEncodingInfo("CP037",null);
ifanIOErrorisencounteredthennullshallbe*returned.**@paramreaderThischaracterstreamissupposedtocontainXMLdata(i.e.itshouldstart*withvalidXMLdeclaration).*@returnTheencodingspecifiedinthexmlheaderreadfromthesuppliedcharacterstream.*/protectedstaticStringgetXmlEncoding(Readerreader){try{StringWritersw=newStringWriter(MAX_XMLDECL_SIZE);intc;intcount=0;for(;(6>count)&&(-1!=(c=reader.read()));count++){sw.write(c);
if((6>count)||(!"<?xml".equals(sw.toString()))){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Invalid(?)XMLdeclaration:"+sw.toString()+".");
if(m.find()){Stringresult=m.group(1);returnresult;
else{returnnull;
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("FailedtoextractcharsetinfofromXML"+"declarationduetoIOException:"+e.getMessage());
if*userhasnotfilledincontactdetails.**@deprecateduse{@link#getSettings()}*/StringgetOnlineResource();/***Providerwebsite(usedfordefaultcontactinformation,orserviceproviderinformation
if*userhasnotfilledincontactdetails.**@paramonlineResourceProviderwebsite*/voidsetOnlineResource(StringonlineResource);/***TheurlofaproxyinfrontoftheGeoServerinstance.**<p>ThisvalueisusedwhenareferencebacktotheGeoServerinstancemustbemadeina*response.**@uml.propertyname="proxyBaseUrl"*@deprecateduse{@link#getSettings()}*/StringgetProxyBaseUrl();/***SetsTheurlofaproxyinfrontoftheGeoServerinstance.**@uml.propertyname="proxyBaseUrl"*@deprecateduse{@link#getSettings()}*/voidsetProxyBaseUrl(StringproxyBaseUrl);/***Thebaseurltousewhenincludingareferencetoanxmlschemadocumentinaresponse.**@uml.propertyname="schemaBaseUrl"*@deprecateduse{@link#getSettings()}*/StringgetSchemaBaseUrl();/***Setsthebaseurltousewhenincludingareferencetoanxmlschemadocumentinaresponse.**@uml.propertyname="schemaBaseUrl"*@deprecateduse{@link#getSettings()}*/voidsetSchemaBaseUrl(StringschemaBaseUrl);/***SetsindentlevelforXMLoutput,causingoutputtobemoreverbose.**<p>ThensettofalseGeoServerwillalsotakestepsotostripoutsomeformatingandproduce*morecondensedoutput.**@uml.propertyname="verbose"*@deprecateduse{@link#getSettings()}*/booleanisVerbose();/***SetsindentlevelforXMLoutput,causingoutputtobemoreverbose.**<p>ThensettofalseGeoServerwillalsotakestepsotostripoutsomeformatingandproduce*morecondensedoutput.**@uml.propertyname="verbose"*@deprecateduse{@link#getSettings()}*/voidsetVerbose(booleanverbose);/***Verbosityflagforexceptions.**<p>WhensetGeoServerwillincludefullstacktracesforexceptions.**@uml.propertyname="verboseExceptions"*@deprecateduse{@link#getSettings()}*/booleanisVerboseExceptions();/***SettheXMLerrorhandlingmodefortheserver.**@seeResourceErrorHandling*/voidsetResourceErrorHandling(ResourceErrorHandlingmode);/**GettheXMLerrorhandlingmodefortheserver.*/ResourceErrorHandlinggetResourceErrorHandling();/***Setsverbosityflagforexceptions.**@uml.propertyname="verboseExceptions"*@deprecateduse{@link#getSettings()}*/voidsetVerboseExceptions(booleanverboseExceptions);/***Theupdatesequence.**<p>Thisvalueisusedbyvariousogcservicestotrackchangestoacapabilitiesdocument.*/longgetUpdateSequence();/**Setstheupdatesequence.*/voidsetUpdateSequence(longupdateSequence);/**Thesizeofthecacheforfeaturetypeobjects.*/intgetFeatureTypeCacheSize();/**Setsthesizeofthecacheforfeaturetypeobjects.*/voidsetFeatureTypeCacheSize(intfeatureTypeCacheSize);/**Flagdetermining
ifaccesstoservicesshouldoccuronlythrough"virtualservices".*/BooleanisGlobalServices();/**Setstheflagforcingaccesstoservicesonlythroughvirtualservices.*/voidsetGlobalServices(BooleanglobalServices);/**SetsloggingbuffersizeofincomingXMLPostRequestsforWFS,WMS,...*/voidsetXmlPostRequestLogBufferSize(IntegerrequestBufferSize);/**GetslogbuffersizeofXMLPostRequestforWFS,WMS,...*/IntegergetXmlPostRequestLogBufferSize();/***IftrueitenablesevaluationofXMLentitiescontainedinXMLfilesreceivedinaservice*(WMS,WFS,...)request.DefaultisFALSE.Enablingthisfeatureisasecurityrisk.*/voidsetXmlExternalEntitiesEnabled(BooleanxmlExternalEntitiesEnabled);/***IftrueitenablesevaluationofXMLentitiescontainedinXMLfilesreceivedinaservice*(WMS,WFS,...)request.DefaultisFALSE.Enablingthisfeatureisasecurityrisk.*/BooleanisXmlExternalEntitiesEnabled();/***Nameoflockproviderusedforresourceaccess.**@returnnameofspringbeantouseaslockprovider*/publicStringgetLockProviderName();/***Setsthenameofthe{@linkLockProvider}touseforresoruceaccess.**<p>Thefollowingspringbeannamesareinitiallyprovidedwiththeapplication:**<ul>*<li>nullLockProvider*<li>memoryLockProvider*<li>fileLockProvider*</ul>**@paramlockProviderNameNameoflockproviderusedforresourceaccess.*/publicvoidsetLockProviderName(StringlockProviderName);/***Amapofmetadataforservices.**@uml.propertyname="metadata"*/MetadataMapgetMetadata();/***Clientpropertiesforservices.**<p>Thesevaluesaretransient,andnotpersistent.*/Map<Object,Object>getClientProperties();/**Disposestheglobalconfigurationobject.*/voiddispose();/**WebUIModechoices*/publicenumWebUIMode{/**LetGeoServerdeterminethebestmode.*/DEFAULT,/***Alwaysredirecttopersistpagestate(preventdoublesubmitproblembutdoesn'tsupport*clustering)*/REDIRECT,/***Neverredirecttopersistpagestate(supportsclusteringbutdoesn'tpreventdouble*submitproblem)*/DO_NOT_REDIRECT};/***GettheWebUIMode**@returntheWebUIMode*/publicWebUIModegetWebUIMode();/***SettheWebUIMode**@parammode*/publicvoidsetWebUIMode(WebUIModemode);}
ifotherwiseconfigured,inthefoldersetupin*WPSINfo.outputStorageDirectory**@authorAndreaAime-GeoSolutions*/publicclassDefaultProcessArtifactsStoreimplementsProcessArtifactsStore{ResourceStorestore;publicvoidsetResourceStore(ResourceStorestore){this.store=store;
if(type==ArtifactType.Request){result=store.get(Paths.path(executionId,"request.dat"));
else
if(type==ArtifactType.Response){result=store.get(Paths.path(executionId,"response.xml"));
else
if(type==ArtifactType.Output){result=store.get(Paths.path(executionId,"out",name));
else{result=store.get(Paths.path(executionId,"tmp",name));
if(r.getType()==Type.DIRECTORY){result.add(r);
if(count==delayAfterFeatures){try{Thread.sleep(delaySeconds*1000L);
if(delaySeconds>0&&resultinstanceofFeatureCollectionResponse){FeatureCollectionResponsefeatureCollectionResponse=(FeatureCollectionResponse)result;List<FeatureCollection>collections=featureCollectionResponse.getFeatures();List<FeatureCollection>wrappers=collections.stream().map(fc->newDelayFeatureCollection((SimpleFeatureCollection)fc)).collect(Collectors.toList());featureCollectionResponse.setFeatures(wrappers);
if(GeoServerPreAuthenticatedCompositeUserNameFilter.thisinstanceofAuthenticationCachingFilter&&currentPosition==0){StringcacheKey=authenticateFromCache((AuthenticationCachingFilter)GeoServerPreAuthenticatedCompositeUserNameFilter.this,(HttpServletRequest)request);
if(cacheKey!=null)request.setAttribute(CACHE_KEY_ATTRIBUTE,cacheKey);
if(nestedFilters==null||currentPosition==nestedFilters.size()){AuthenticationpostAuthentication=SecurityContextHolder.getContext().getAuthentication();StringcacheKey=(String)request.getAttribute(CACHE_KEY_ATTRIBUTE);
if(postAuthentication!=null&&cacheKey!=null){IntegeridleSecs=(Integer)request.getAttribute(CACHE_KEY_IDLE_SECS);IntegerliveSecs=(Integer)request.getAttribute(CACHE_KEY_LIVE_SECS);getSecurityManager().getAuthenticationCache().put(getName(),cacheKey,postAuthentication,idleSecs,liveSecs);
else{currentPosition++;FilternextFilter=nestedFilters.get(currentPosition-1);nextFilter.doFilter(request,response,this);
if(nestedFilters==null||nestedFilters.size()==0){chain.doFilter(request,response);return;
if(GeoServerAuthenticationProvider.class==serviceClass&&prov.getAuthenticationProviderClass()!=null){
if(prov.getAuthenticationProviderClass().getName().equals(className))returnprov;
if(GeoServerUserGroupService.class==serviceClass&&prov.getUserGroupServiceClass()!=null){
if(prov.getUserGroupServiceClass().getName().equals(className))returnprov;
if(GeoServerRoleService.class==serviceClass&&prov.getRoleServiceClass()!=null){
if(prov.getRoleServiceClass().getName().equals(className))returnprov;
if(PasswordValidator.class==serviceClass&&prov.getPasswordValidatorClass()!=null){
if(prov.getPasswordValidatorClass().getName().equals(className))returnprov;
if(GeoServerSecurityFilter.class==serviceClass&&prov.getFilterClass()!=null){
if(prov.getFilterClass().getName().equals(className))returnprov;
if(MasterPasswordProvider.class==serviceClass&&prov.getMasterPasswordProviderClass()!=null){
if(prov.getMasterPasswordProviderClass().getName().equals(className)){returnprov;
ifthisproviderisavailable.**<p>Thisdefaultimplementationreturns<code>true</code>,subclassesshouldoverrideincases*whereameaningfulcheckcanbemade...forinstancecheckingforajdbcdriver,etc...*/publicbooleanisAvailable(){returntrue;
ifthe{@linkGeoServerRoleService}implementationisnotthreadsafe.*/publicbooleanroleServiceNeedsLockProtection(){returnfalse;
ifthe{@linkGeoServerUserGroupService}implementationisnotthreadsafe.*/publicbooleanuserGroupServiceNeedsLockProtection(){returnfalse;
if(currentShouldSetProperty!=null){System.setProperty(XFrameOptionsFilter.GEOSERVER_XFRAME_SHOULD_SET_POLICY,currentShouldSetProperty);
if(currentShouldSetProperty!=null){System.setProperty(XFrameOptionsFilter.GEOSERVER_XFRAME_POLICY,currentShouldSetProperty);
if(cacheConcurrencyLevel>1){returncacheConcurrencyLevel;
else{returndefaultCacheConcurrencyLevel;
if(cacheMaximumSize>0){returncacheMaximumSize;
else{returndefaultCacheMaximumSize;
if(cacheExpirationTime>0){returncacheExpirationTime;
else{returndefaultCacheExpirationTime;
if(writeQuery==Query.ALL){((SimpleFeatureStore)storeDelegate).modifyFeatures(names,values,filter);return;
else
if(writeQuery.getFilter()==Filter.EXCLUDE||writeQuery.getPropertyNames()==Query.NO_NAMES){throwunsupportedOperation();
if(writeQuery.getPropertyNames()==Query.ALL_NAMES){//itwasjustamatteroffiltering.((SimpleFeatureStore)storeDelegate).modifyFeatures(names,values,mixed.getFilter());
else{//getthewritableattributesetSet<String>queryNames=newHashSet<String>(Arrays.asList(writeQuery.getPropertyNames()));//checktheupdatefieldsfor(inti=0;i<names.length;i++){
if(!queryNames.contains(names[i])){StringtypeName=getSchema().getName().getLocalPart();
if(policy.getResponse()==Response.CHALLENGE){throwSecureCatalogImpl.unauthorizedAccess(typeName);
else{thrownewUnsupportedOperationException("Tryingtowriteonthewriteprotectedattribute"+names[i]);
if(choice.toUpperCase().contains(ucInput)){result.add(choice);
if((context!=null)&&(context.getWms()==null)){//NoneedtotransformWFSKML.createMarshaller().marshal(kml,output);
else{Transformertransformer=templates.newTransformer();JAXBSourcesource=newJAXBSource(createMarshaller(),kml);transformer.transform(source,newStreamResult(output));
if(context!=null){context.closeIterators();
if(isNotEmpty(fileName)==false)throwcreateSecurityException(FILENAME_REQUIRED);
if(msecs!=0&&msecs<1000)throwcreateSecurityException(CHECK_INTERVAL_INVALID);
if
iffilenameisabsoluteandnotinstandardroledirectorytry{
if(file.isAbsolute()&&!file.getCanonicalPath().startsWith(manager.role().get(config.getName()).dir().getCanonicalPath()+File.separator))return;//fileinsecuritysubdir,check
ifrolesexists
if(manager.loadRoleService(config.getName()).getRoleCount()>0){throwcreateSecurityException(ROLE_SERVICE_NOT_EMPTY_$1,config.getName());
if
iffilenameisabsoluteandnotinstandardroledirectorytry{
if(file.isAbsolute()&&!file.getCanonicalPath().startsWith(manager.userGroup().get(config.getName()).file().getCanonicalPath()+File.separator))return;//fileinsecuritysubdir,check
ifrolesexistsGeoServerUserGroupServiceservice=manager.loadUserGroupService(config.getName());
if(service.getGroupCount()>0||service.getUserCount()>0){throwcreateSecurityException(USERGROUP_SERVICE_NOT_EMPTY_$1,config.getName());
ifthefileexistsorcanbecreated*/@OverridepublicvoidvalidateAddRoleService(SecurityRoleServiceConfigconfig)throwsSecurityConfigException{super.validateAddRoleService(config);XMLRoleServiceConfigxmlConfig=(XMLRoleServiceConfig)config;Filefile=newFile(xmlConfig.getFileName());
if(checkFile(file)==false)throwcreateSecurityException(FILE_CREATE_FAILED_$1,file.getPath());
ifthefileexistsorcanbecreated*/@OverridepublicvoidvalidateAddUserGroupService(SecurityUserGroupServiceConfigconfig)throwsSecurityConfigException{super.validateAddUserGroupService(config);XMLUserGroupServiceConfigxmlConfig=(XMLUserGroupServiceConfig)config;Filefile=newFile(xmlConfig.getFileName());
if(checkFile(file)==false)throwcreateSecurityException(FILE_CREATE_FAILED_$1,file.getPath());
if(old.getFileName().equals(modified.getFileName())==false)throwcreateSecurityException(FILENAME_CHANGE_INVALID_$2,old.getFileName(),modified.getFileName());
if(old.getFileName().equals(modified.getFileName())==false)throwcreateSecurityException(FILENAME_CHANGE_INVALID_$2,old.getFileName(),modified.getFileName());
if(isNotEmpty(config.getUserGroupServiceName())==false){throwcreateSecurityException(USERGROUP_SERVICE_REQUIRED);
if(request.isSecure()){chain.doFilter(request,response);return;
if(httpRequest.getQueryString()!=null){for(StringkvpString:httpRequest.getQueryString().split("&")){String[]kvpArray=kvpString.split("=");
if(kvpArray==null||kvpArray.length!=2){LOGGER.warning("Unknownqueryparameter:"+kvpString);continue;
if(LOGGER.isLoggable(Level.INFO))LOGGER.info("Redirecting"+httpRequest.getRequestURL()+"to"+redirectURL);((HttpServletResponse)response).sendRedirect(redirectURL);}}
if(rules.size()==0){returnnull;
if((requestedCRS!=null)&&!CRS.equalsIgnoreMetadata(dataCRS,requestedCRS)){
if(dataCRS.getCoordinateSystem().getDimension()==3&&requestedCRS.getCoordinateSystem().getDimension()==2){queryEnvelope=JTS.transformTo3D(queryEnvelope,dataCRS,true,10);
else{queryEnvelope=queryEnvelope.transform(dataCRS,true);
if(filter!=null){getFInfoFilter=ff.and(getFInfoFilter,filter);
ifwecanincludetherulefiltersaswell,
iftoomanywe'lldothemin//memoryFilterpostFilter=Filter.INCLUDE;FilterrulesFilters=buildRulesFilter(ff,rules);
if(!(featureSource.getSchema()instanceofSimpleFeatureType)||!(rulesFiltersinstanceofOr)||(rulesFiltersinstanceofOr&&((Or)rulesFilters).getChildren().size()<=20)){getFInfoFilter=ff.and(getFInfoFilter,rulesFilters);
else{postFilter=rulesFilters;
if(viewParams!=null&&viewParams.size()>0){q.setHints(newHints(Hints.VIRTUAL_TABLE_PARAMETERS,viewParams));
ifweneedtoreproject
if(!wms.isFeaturesReprojectionDisabled()){//reprojectthefeaturestotherequestCRS,thiswaycomplexfeaturewillalsobe//reprojectedq.setCoordinateSystemReproject(requestedCRS);
ifwecouldnotincludetherulesfilterintothequery,postprocessin//memory
if(!Filter.INCLUDE.equals(postFilter)){match=newFilteringFeatureCollection(match,postFilter);
if(buffer<=0){IntegerlayerBuffer=null;finalLayerInfolayerInfo=layer.getLayerInfo();
if(layerInfo!=null){//itisalocallayerlayerBuffer=layerInfo.getMetadata().get(LayerInfo.BUFFER,Integer.class);
if(layerBuffer!=null&&layerBuffer>0){radius=layerBuffer;
else{//estimatetheradiusgiventhecurrentlyactiverulesMetaBufferEstimatorestimator=newMetaBufferEstimator();for(Rulerule:rules){rule.accept(estimator);
if(estimatedRadius<MIN_BUFFER_SIZE){radius=MIN_BUFFER_SIZE;
else{radius=estimatedRadius;
else{radius=buffer;
if(maxRadius>0&&radius>maxRadius){radius=maxRadius;
if(rule.getFilter()==null||rule.isElseFilter())returnFilter.INCLUDE;filters.add(rule.getFilter());
if(sq.getReturnFeatureType()!=null){for(QNameqName:sq.getReturnFeatureType()){
if(qName.getNamespaceURI()!=null&&qName.getPrefix()!=null){encoder.getNamespaces().declarePrefix(qName.getPrefix(),qName.getNamespaceURI());
if(object!=null&&object.booleanValue()){expanded.add(resource.path());
if(resource.parent()!=null){resource.parent().addListener(this);
else{expanded.remove(resource.path());
if(resource.parent()!=null){resource.parent().removeListener(this);
if(event.getKind()==ResourceNotification.Kind.ENTRY_DELETE&&event.getPath().equals(resource.name())){//cleanupdeletedresourcesexpanded.remove(resource.path());
if(crs!=null){Integercode;try{code=CRS.lookupEpsgCode(crs,false);
if(code!=null){builder.append("@").append(code);
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("UnabletoparsethespecifiedCRSdueto"+e.getMessage());
if(fileExt!=null&&fileExt.trim().length()>0){builder.append(fileExt);
if(options!=null&&options.trim().length()>0){builder.append("?").append(options);
if(dimensionName.equals(ResourceInfo.TIME)){retval=dimAccessor.getMaxTime();
else
if(dimensionName.equals(ResourceInfo.ELEVATION)){retval=dimAccessor.getMaxElevation();
else
if(dimensionName.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){StringcustDimName=dimensionName.substring(ResourceInfo.CUSTOM_DIMENSION_PREFIX.length());//see
ifwehaveanoptimizewaytogettheminimumStringmaximum=reader.getMetadataValue(custDimName.toUpperCase()+"_DOMAIN_MAXIMUM");
if(maximum!=null){retval=maximum;
else{//ok,getthefulldomainthenList<String>domain=dimAccessor.getDomain(custDimName);
if(domain.isEmpty()){retval=null;
else{//Justalexical(string)sort.//Shouldwebepreparedfornumericanddatevalues?Collections.sort(domain);retval=domain.get(domain.size()-1);
if(params.length==0)returnnewNewRolePage(getSecurityManager().getActiveRoleService().getName()).setReturnPage(page);
elsereturnnewNewRolePage((String)params[0]).setReturnPage(page);
if(params.length==0){returnnewEditRolePage(getSecurityManager().getActiveRoleService().getName(),GeoServerRole.ADMIN_ROLE).setReturnPage(page);
if(params.length==1)returnnewEditRolePage(getSecurityManager().getActiveRoleService().getName(),(GeoServerRole)params[0]).setReturnPage(page);
elsereturnnewEditRolePage((String)params[0],(GeoServerRole)params[1]).setReturnPage(page);
if(RoleListProvider.ParentPropertyName.equals(prop.getName())){parentProp=prop;break;
if(listener.isCanceled()){thrownewProcessDismissedException(listener);
if(name.endsWith("_DOMAIN_MINIMUM")||name.endsWith("_DOMAIN_MAXIMUM")||name.endsWith("_DOMAIN")){StringdimensionName=name.substring(0,name.indexOf("_DOMAIN"));DimensionDescriptordescriptor=dimensionDescriptors.get(dimensionName);
if(descriptor!=null){Objectstart=feature.getAttribute(descriptor.getStartAttribute());Objectend=null;
if(descriptor.getEndAttribute()!=null){end=feature.getAttribute(descriptor.getEndAttribute());
if(dimensionName.equalsIgnoreCase("TIME")){start=formatter.format((Date)start);
if(end!=null){end=formatter.format((Date)end);
if(name.endsWith("_DOMAIN_MINIMUM")){returnString.valueOf(start);
if(name.endsWith("_DOMAIN_MAXIMUM")){
if(end!=null){returnString.valueOf(end);
else{returnString.valueOf(start);
if(name.endsWith("_DOMAIN")){
if(end!=null){returnstart+"/"+end;
else{returnString.valueOf(start);
if(closeinstanceofRetypingIterator){((RetypingIterator)close).close();
if(causeinstanceofRuntimeException){throw(RuntimeException)cause;
if(set!=null){returnnewGWCZoomContext(set);
else{returnnull;
if(level<0)returnDouble.POSITIVE_INFINITY;
if(level>=gridset.getNumLevels())return0;returngridset.getGrid(level).getScaleDenominator();
if(level>=gridset.getNumLevels()-1){return0;
iflength<=0,return<code>null</code>*/publicchar[]getRandomPassword(intlength){
if(length<=0)returnnull;char[]buff=newchar[length];getRandomPassword(buff);returnbuff;
if(index<0)index+=PRINTABLE_ALPHABET.length;buff[i]=PRINTABLE_ALPHABET[index];
if(index<0)index+=PRINTABLE_ALPHABET.length;buff[i]=(byte)PRINTABLE_ALPHABET[index];
if(config.getType()==Type.UNDEFINED){InputStreamconf=getClass().getResourceAsStream("default-config.yaml");IOUtils.copy(conf,config.out());
if(!Resources.canRead(config)){LOG.warning("Printingmodulemissingitsconfiguration.Anyactionsittakeswillfail.");return;
ifthisisnotawms1.3.0request
if(!WMS.VERSION_1_3_0.equals(requestVersion)){return;
ifmandatorycontentnotpresent//orturnedoff
if(metadataURL==null||createExtendedCapabilities!=null&&!createExtendedCapabilities){return;
if(context.getId().longValue()==id){found=true;
if(cataloginstanceofLocalWorkspaceCatalog){LocalWorkspaceCataloglwCatalog=(LocalWorkspaceCatalog)catalog;lwCatalog.setGeoServer(this);
if(LocalWorkspace.get()!=null){settings=getSettings(LocalWorkspace.get());
if(facade.getSettings(workspace)!=null){thrownewIllegalArgumentException("Settingsalreadyexistforworkspace'"+workspace.getName()+"'");
if(workspace==null){thrownewIllegalArgumentException("Settingsmustbepartofaworkspace");
if(factoryinstanceofApplicationContextAware){((ApplicationContextAware)factory).setApplicationContext(context);
if(service.getId()!=null&&facade.getService(service.getId(),ServiceInfo.class)!=null){thrownewIllegalArgumentException("servicewithid'"+service.getId()+"'alreadyexists");
if(workspace!=null){
if(facade.getServiceByName(service.getName(),workspace,ServiceInfo.class)!=null){thrownewIllegalArgumentException("servicewithname'"+service.getName()+"'alreadyexistsinworkspace'"+workspace.getName()+"'");
if(service==null){LOGGER.log(Level.SEVERE,"Couldnotlocateserviceoftype"+clazz+",localworkspaceis"+ws);
if(catalog!=null)catalog.dispose();
if(facade!=null)facade.dispose();
if(newCatalog!=null){dispose();//reloadcatalog,makesurewereloadtheunderlyingcatalog,notanywrappersCatalogcatalog=getCatalog();
if(cataloginstanceofWrapper){catalog=((Wrapper)getCatalog()).unwrap(Catalog.class);
else{loader.reload();
if(maxTotalTime>0&&maxTotalTime<maxExecutionTime){LOGGER.log(Level.WARNING,"Themaximumtotalqueuingandexecutiontimeallowedforprocessesis"+"lessthanthemaximumallowedexecutiontime");
if(isExpired()){returntrue;
else{returnsuper.isCanceled();
if(isExpired()){thrownewProcessDismissedException(this);
iftheexecutionwentbeyondtheallowedmaxtime*/publicbooleanisExpired(){booleanmaxExecutionTimeExceeded=maxExecutionTime>0&&startTime>0&&(System.currentTimeMillis()-startTime)>maxExecutionTime;booleanmaxTotalTimeExceeded=maxTotalTime>0&&(System.currentTimeMillis()-queuedTime)>maxTotalTime;returnmaxExecutionTimeExceeded||maxTotalTimeExceeded;
if(resource==null){returnname;
if(resource==null){thrownewNullPointerException("Layernamemustnotbesetwithoutanunderlyingresource");
if(resource==null){thrownewNullPointerException("UnabletogetLayerenabledflagwithoutanunderlyingresource");
if(resource==null){thrownewNullPointerException("Layerenabledflagmustnotbesetwithoutanunderlyingresource");
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofLayerInfo))returnfalse;finalLayerInfoother=(LayerInfo)obj;
if(defaultStyle==null){
if(other.getDefaultStyle()!=null)returnfalse;
else
if(!defaultStyle.equals(other.getDefaultStyle()))returnfalse;
if(id==null){
if(other.getId()!=null)returnfalse;
else
if(!id.equals(other.getId()))returnfalse;
if(legend==null){
if(other.getLegend()!=null)returnfalse;
else
if(!legend.equals(other.getLegend()))returnfalse;//TODO:addbackwhenresource/publishsplitisinplace//
if(name==null){//
if(other.getName()!=null)//returnfalse;//
else
if(!name.equals(other.getName()))//returnfalse;
if(path==null){
if(other.getPath()!=null)returnfalse;
else
if(!path.equals(other.getPath()))returnfalse;
if(resource==null){
if(other.getResource()!=null)returnfalse;
else
if(!resource.equals(other.getResource()))returnfalse;
if(styles==null){
if(other.getStyles()!=null)returnfalse;
else
if(!styles.equals(other.getStyles()))returnfalse;
if(type==null){
if(other.getType()!=null)returnfalse;
else
if(!type.equals(other.getType()))returnfalse;
if(attribution==null){
if(other.getAttribution()!=null)returnfalse;
else
if(!attribution.equals(other.getAttribution()))returnfalse;
if(authorityURLs==null){
if(other.getAuthorityURLs()!=null)returnfalse;
else
if(!authorityURLs.equals(other.getAuthorityURLs()))returnfalse;
if(identifiers==null){
if(other.getIdentifiers()!=null)returnfalse;
else
if(!identifiers.equals(other.getIdentifiers()))returnfalse;returntrue;
if(resource==null){thrownewNullPointerException("UnabletogetLayeradvertisedflagwithoutanunderlyingresource");
if(resource==null){thrownewNullPointerException("Layeradvertisedflagmustnotbesetwithoutanunderlyingresource");
if(expressionCount>=4){beforeColor=getParameters().get(3).evaluate(feature,String.class);
if(expressionCount>=5){afterColor=getParameters().get(4).evaluate(feature,String.class);
if(expressionCount>=6){Booleanlog=getParameters().get(5).evaluate(feature,Boolean.class);
if(log!=null){logarithmic=log;
if(expressionCount>=7){Integernc=getParameters().get(6).evaluate(feature,Integer.class);
if(nc!=null){numColors=nc;
if(numColors<1||numColors>254){thrownewInvalidParameterException("Numberofcolorsmustbecomprisedbetween1and254");
if(!colorMap.startsWith(GradientColorMapGenerator.RGB_INLINEVALUE_MARKER)&&!colorMap.startsWith(GradientColorMapGenerator.RGBA_INLINEVALUE_MARKER)&&!colorMap.startsWith(GradientColorMapGenerator.HEX_INLINEVALUE_MARKER)){GeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);colorMap=colorMap.replace('\\','/');Stringpath=Paths.path("styles","ramps",colorMap+".svg");xmlFile=loader.get(path);
if(xmlFile.getType()!=Type.RESOURCE){thrownewIllegalArgumentException("ThespecifiedcolorMapdonotexistinthestyles/rampsfolder\n"+"Checkthat"+path+"existsandisan.svgfile");
if(xmlFile!=null){generator=GradientColorMapGenerator.getColorMapGenerator(xmlFile.file());
else{generator=GradientColorMapGenerator.getColorMapGenerator(colorMap);
if(!logarithmic){cm=generator.generateColorMap(min,max);
if(numColors<MAX_PALETTE_COLORS){cm=sampleColorMap(numColors,min,max,cm,Function.identity(),numColors<MAX_PALETTE_COLORS);
else{
if(min<=0){thrownewInvalidParameterException("Minrangevaluemustbepositiveinlogscalemode");
if(LOGGER.isLoggable(Level.FINE)){finalSLDTransformertx=newSLDTransformer();tx.setIndentation(2);Stringsld=tx.transform(cm);LOGGER.fine("GeneratedColormap:\n"+sld);
if(useIntervals){mapValue=v+step;
if(useIntervals){cm.setType(ColorMap.TYPE_INTERVALS);cm.addColorMapEntry(entryForValue(max,Double.POSITIVE_INFINITY,lcm,icm));//aftercolor
else{cm.addColorMapEntry(entryForValue(max,quantityMapper.apply(max),lcm,icm));//aftercolor
if(alpha<255){entry.setOpacity(FF.literal(alpha/255.));
if(!isValidDataset(ci)){thrownewIllegalArgumentException("Specifiedcovearge"+ci.prefixedName()+"isnotavalidEOdataset");
ifthespecifiedcoverageisavaliddataset,e.g.,ithasthedatasetflagenabled*andtimedimension,andhasastructuredgridcoveragereaderbackingit**@paramci*/publicbooleanisValidDataset(CoverageInfoci){Booleandataset=ci.getMetadata().get(WCSEOMetadata.DATASET.key,Boolean.class);DimensionInfotime=ci.getMetadata().get(ResourceInfo.TIME,DimensionInfo.class);try{GridCoverageReaderreader=ci.getGridCoverageReader(null,GeoTools.getDefaultHints());booleanstructured=readerinstanceofStructuredGridCoverage2DReader;returndataset!=null&&dataset&&time!=null&&time.isEnabled()&&structured;
ifnotfound,or
ifnotacoverage*/publicCoverageInfogetDatasetCoverage(StringdatasetId){
if(!datasetId.endsWith(DATASET_SUFFIX)){LOGGER.fine("Invaliddatasetid"+datasetId+"itdoesnotendwith"+DATASET_SUFFIX);returnnull;
if(layer==null){LOGGER.fine("Invaliddatasetid"+datasetId+"doesnotmatchanypublisheddataset");returnnull;
if(!isValidDataset(ci)){LOGGER.fine("Invaliddatasetid"+datasetId+"doesnotmatchanypublisheddataset");returnnull;
ifthesyntaxisincorrect,*thecoveragedoesnotexist,orit'snotadataset*/publicCoverageInfogetGranuleCoverage(StringgranuleId){//doesithavetheexpectedlexicalstructure?
if(!granuleId.contains(GRANULE_SEPARATOR)){returnnull;
if(splitted.length!=2){returnnull;
if(li==null){returnnull;
if(isValidDataset(ci)){returnci;
else{returnnull;
if(!granuleId.contains(GRANULE_SEPARATOR)){thrownewIllegalArgumentException("Notavalidgranuleid:"+granuleId);
if(splitted.length!=2){thrownewIllegalArgumentException("Notavalidgranuleid:"+granuleId);
ifthisisa3DtestandneedsaparticularWKTparser*/publicAppSchemaTestOracleSetup(Map<String,File>propertyFiles,booleanis3D)throwsException{configureFixture();Stringparser;
if(is3D){//use3Dparser//
ifSC4OUserisdifferentfromthedatabaseuser,itwillbespecified//else,usethecurrentdatabaseuserStringuser=System.getProperty("SC4OUser");
if(user==null){user=fixture.getProperty("user");
else{parser=DEFAULT_PARSER;//defaultwktparserprocedure,doesnotsupport3D
ifexistsbuf.append("CALLDROP_TABLE_OR_VIEW('").append(tableName).append("')\n");//createthetablebuf.append("CREATETABLE").append(tableName).append("(");//+pkeyintsize=schema.getAttributeCount()+1;String[]fieldNames=newString[size];List<String>createParams=newArrayList<String>();intj=0;Stringtype;Stringfield;intspatialIndexCounter=0;for(PropertyDescriptordesc:schema.getDescriptors()){field=desc.getName().toString().toUpperCase();fieldNames[j]=field;
if(descinstanceofGeometryDescriptor){type="SDO_GEOMETRY";//Updatespatialindexintsrid=getSrid(((GeometryType)desc.getType()));spatialIndex.append("DELETEFROMuser_sdo_geom_metadataWHEREtable_name='").append(tableName).append("'\n");spatialIndex.append("Insertintouser_sdo_geom_metadata").append("(TABLE_NAME,COLUMN_NAME,DIMINFO,SRID)").append("values('").append(tableName).append("','").append(field).append("',MDSYS.SDO_DIM_ARRAY(MDSYS.SDO_DIM_ELEMENT('X',140.962,144.909,0.00001),").append("MDSYS.SDO_DIM_ELEMENT('Y',-38.858,-33.98,0.00001)").append(//support3dindex((GeometryDescriptor)desc).getCoordinateReferenceSystem()!=null&&((GeometryDescriptor)desc).getCoordinateReferenceSystem().getCoordinateSystem().getDimension()==3?",MDSYS.SDO_DIM_ELEMENT('Z',-100000,100000,1)),":"),").append(srid).append(")\n");//ensureit's<=30characterstoavoidOracleexceptionStringindexName=(tableName.length()<=26?tableName:tableName.substring(0,26))+"_IDX";
if(spatialIndexCounter>0){//toavoidduplicateindexnamewhenthereare>1geometryinthesame//tableindexName+=spatialIndexCounter;
else{type=Classes.getShortName(desc.getType().getBinding());
if(type.equalsIgnoreCase("String")){type="NVARCHAR2(250)";
else
if(type.equalsIgnoreCase("Double")){type="NUMBER";
if(valueinstanceofGeometry){//usewktwritertoconvertgeometrytostring,sothirddimensioncan//besupported
ifpresent.Geometrygeom=(Geometry)value;value=newWKTWriter(geom.getCoordinate().z==Double.NaN?2:3).write(geom);
if(value==null||value.toString().equalsIgnoreCase("null")){values[valueIndex]="null";
else
if(prop.getType()instanceofGeometryType){intsrid=getSrid(((GeometryType)prop.getType()));StringBuffergeomValue=newStringBuffer(parser+"('");geomValue.append(value).append("'");
if(srid>-1){//attachsridgeomValue.append(",").append(srid);
else
if(prop.getType().getBinding().getSimpleName().equalsIgnoreCase("DATE")){values[valueIndex]="TO_DATE('"+value+"','yyyy-MM-dd')";
else{values[valueIndex]="'"+value+"'";
if(buf.length()>0){this.sql=buf.toString();
if(i<cr.length-1){xml+="";
if(i<cr.length-1){xml+="";
if(i<cr.length-1){xml+="";
if(monitorConfig.getBboxMode()!=MonitorConfig.BboxMode.NONE){data.setBbox(getBBox(request));
if(getCopyField().getConvertedInput()!=null){getTypeField().getModel().setObject(config.getTasks().get(getCopyField().getConvertedInput()).getType());target.add(getTypeField());
if(jdbcConfig.isJndi())validateJNDI(jdbcConfig);
elsevalidateJDBC(jdbcConfig);
if(jdbcConfig.isJndi())validateJNDI(jdbcConfig);
elsevalidateJDBC(jdbcConfig);
if(config.isCreatingTables()){
if(isNotEmpty(config.getPropertyFileNameDDL())==false)throwcreateSecurityException(DDL_FILE_REQUIRED);
if(isNotEmpty(fileName)){
if(defaultDDL.equals(fileName)==false){//notthedefaultpropertyfileFilefile=newFile(fileName);
if(checkFile(file)==false){throwcreateSecurityException(DDL_FILE_INVALID,fileName);
if(isNotEmpty(fileName)==false){//dmlfileisrequiredthrowcreateSecurityException(DML_FILE_REQUIRED);
if(defaultDML.equals(fileName)==false){//notthedefaultpropertyfileFilefile=newFile(fileName);
if(checkFile(file)==false){throwcreateSecurityException(DML_FILE_INVALID,fileName);
if(isNotEmpty(config.getJndiName())==false)throwcreateSecurityException(JNDINAME_REQUIRED);
if(isNotEmpty(config.getDriverClassName())==false)throwcreateSecurityException(DRIVER_CLASSNAME_REQUIRED);
if(isNotEmpty(config.getUserName())==false)throwcreateSecurityException(USERNAME_REQUIRED);
if(isNotEmpty(config.getConnectURL())==false)throwcreateSecurityException(JDBCURL_REQUIRED);try{Class.forName(config.getDriverClassName());
if(isNotEmpty(jdbcConfig.getDriverClassName())==false)throwcreateSecurityException(DRIVER_CLASSNAME_REQUIRED);
if(isNotEmpty(jdbcConfig.getConnectURL())==false)throwcreateSecurityException(JDBCURL_REQUIRED);try{Class.forName(jdbcConfig.getDriverClassName());
if(candidate.supportsVersion(version)){LOGGER.log(Level.FINE,"Chosencandidate:"+candidate.getDescription());returncandidate.newInstance(writer);
if(registry==null){registry=newFactoryCreator(Arrays.asList(newClass<?>[]{DXFWriter.class}));
if(levelComparison!=0){returnlevelComparison;
ifarecalledinthewrong*order(whichisproduceMap->getContentType->writeTo)**@authorGabrielRoldan*@authorSimoneGiannecchini,GeoSolutions*@version$Id$*/publicinterfaceGetMapOutputFormat{/***Asksthismapproducertocreateamapimageforthepassed{@linkPlainWMSMapContext},which*containsenoughinformationfordoingsuchaprocess.**@parammapContent*@throwsServiceExceptionsomethinggoeswrong*/publicWebMapproduceMap(WMSMapContentmapContent)throwsServiceException,IOException;/***Returnsthelistofcontenttypealiasesforthisoutputformat,thataretheonestobeused*asFormatelementsintheGetCapabilitiesdocument.**<p>AliasesareusedtoeasythetaskofwritingaGetMaprequest,(forexample,totype*&outputformat=svginsteadofthefull&outputformat=image/svg+xml)**@returnthealiasesamapofthecontenttypethismapproducercreatescontenttypecanbe*askedbythroughaGetMaprequest.*/publicSet<String>getOutputFormatNames();/**Returnsthemimetypegeneratedbytheformat*/publicStringgetMimeType();/***Returnsthecapabilitiesforthespecifiedformat**@paramformat*/publicMapProducerCapabilitiesgetCapabilities(Stringformat);}
if(v==null){returnOptional.empty();
if(NetCDFUtilities.isNC4CAvailable()){message+="\nc_inq_libvers:"+Nc4Version();
if(ugStore!=null)ugStore.load();
if(roleStore!=null)roleStore.load();
if(!service.tablesAlreadyCreated()){service.createTables();
if(!service.tablesAlreadyCreated()){service.createTables();
if(newFile(f.getParentFile(),basename+".shp").exists()||newFile(f.getParentFile(),basename+".properties").exists()){returntrue;
if("sample_image".equals(basename)){returntrue;
if(!files.isEmpty()){DataFormatformat=format();
if(format==null){thrownewIllegalArgumentException("Unabletodetermineformatformosaicfiles");
if(!(formatinstanceofRasterFormat)){thrownewIllegalArgumentException("Mosaicdirectorymustcontainonlyrasterfiles");
if(formatinstanceofGridFormat){Granuleg=newGranule(super.newSpatialFile(f,format));//processthegranuletry{AbstractGridCoverage2DReaderr=((GridFormat)format).gridReader(g);try{//gettheenvelopeGridCoverage2Dcov=r.read(null);g.setEnvelope(cov.getEnvelope2D());g.setGrid(cov.getGridGeometry());cov.dispose(false);//computetimestampg.setTimestamp(timeHandler.computeTimestamp(g));returng;
if(r!=null){r.dispose();
if(dataDir.exists()){XSLTTestSupport.deleteDirectory(dataDir);
if(groupFilter!=null){List<LayerGroupInfo>filtered=newArrayList<LayerGroupInfo>(groups.size());for(LayerGroupInfogroup:groups){
if(groupFilter.accept(group)){filtered.add(group);
if(di==null){thrownewIllegalArgumentException("Couldnotfinda"+storeName+"storeinthe"+workspaceName+"workspace");
if(property==AttributesProvider.NAME){Fragmentf=newFragment(id,"nameFragment",NewFeatureTypePage.this);f.add(editAttributeLink(itemModel));returnf;
else
if(property==AttributesProvider.BINDING){returnnewLabel(id,AttributeDescription.getLocalizedName(att.getBinding()));
else
if(property==AttributesProvider.CRS){
if(att.getBinding()!=null&&Geometry.class.isAssignableFrom(att.getBinding())){try{IntegerepsgCode=CRS.lookupEpsgCode(att.getCrs(),false);returnnewLabel(id,"EPSG:"+epsgCode);
else{returnnewLabel(id,"");
else
if(property==AttributesProvider.SIZE){
if(att.getBinding()!=null&&String.class.equals(att.getBinding())){returnnewLabel(id,String.valueOf(att.getSize()));
else{returnnewLabel(id,"");
else
if(property==AttributesProvider.UPDOWN){returnupDownFragment(id,att);
if(Arrays.asList(ds.getTypeNames()).contains(name)){error(newParamResourceModel("duplicateTypeName",this,dsInfo.getName(),name).getString());return;
if(attributesProvider.getAttributes().size()==0){error(newParamResourceModel("noAttributes",this).getString());return;
if(att.getSize()>0){builder.length(att.getSize());
if(Geometry.class.isAssignableFrom(att.getBinding())){builder.add(att.getName(),att.getBinding(),att.getCrs());
else{builder.add(att.getName(),att.getBinding());
if(attributesProvider.isFirst(attribute)){upDown.add(newPlaceholderLink("up"));
else{ImageAjaxLink<Void>upLink=newImageAjaxLink<Void>("up",newPackageResourceReference(getClass(),"../../img/icons/silk/arrow_up.png")){@OverrideprotectedvoidonClick(AjaxRequestTargettarget){attributesProvider.moveUp(attribute);target.add(form);
if(attributesProvider.isLast(attribute)){upDown.add(newPlaceholderLink("down"));
else{ImageAjaxLink<Void>downLink=newImageAjaxLink<Void>("down",newPackageResourceReference(getClass(),"../../img/icons/silk/arrow_down.png")){@OverrideprotectedvoidonClick(AjaxRequestTargettarget){attributesProvider.moveDown(attribute);target.add(form);
if(objinstanceofFeatureTypeInfo){FeatureTypeInfofti=(FeatureTypeInfo)obj;for(Stringst:getSupportedTypes()){
if(fti.getStore().getType().equals(st)){canHandle=true;break;
if(target.getLatestVersion().equals(target.getNextVersion())){target.getService().delete(target.getNextVersion());
if(!target.getLatestVersion().equals(target.getNextVersion())){target.getService().delete(target.getLatestVersion());
if(!target.getLatestVersion().equals(target.getNextVersion())){target.getService().delete(target.getNextVersion());
if(newBackupRestorePanel.size()>0){newBackupRestorePanel.remove("backupResource");
if(!exec.isRunning()){try{
if(exec.getAllFailureExceptions()!=null&&!exec.getAllFailureExceptions().isEmpty()){getSession().error(exec.getAllFailureExceptions().get(0));setResponsePage(BackupRestoreDataPage.class);
else
if(exec.isStopping()){//donothing
else{PageParameterspp=newPageParameters();pp.add("id",exec.getId());pp.add("clazz",BackupExecutionAdapter.class.getSimpleName());setResponsePage(BackupRestorePage.class,pp);
if(self.equals(component)&&method.getDeclaringClass().equals(org.apache.wicket.behavior.IBehaviorListener.class)&&method.getName().equals("onRequest")){returntrue;
if(archiveFile==null||archiveFile.getType()==Type.DIRECTORY||FilenameUtils.getExtension(archiveFile.name()).isEmpty()){thrownewException("BackupArchiveFileisMandatoryandshouldnotbeaDirectoryorURI.");
if(ws!=null){filter=ECQL.toFilter("name='"+ws.getName()+"'");
if(backupOptBestEffort){hints.add(newHints(newHints.OptionKey(Backup.PARAM_BEST_EFFORT_MODE),Backup.PARAM_BEST_EFFORT_MODE));
if(backupOptCleanTemp){hints.add(newHints(newHints.OptionKey(Backup.PARAM_CLEANUP_TEMP),Backup.PARAM_CLEANUP_TEMP));
if(jobid!=null){try{BackupRestoreWebUtils.backupFacade().stopExecution(jobid);setResponsePage(BackupRestoreDataPage.class);
if(!exec.isRunning()){try{
if(exec.getAllFailureExceptions()!=null&&!exec.getAllFailureExceptions().isEmpty()){getSession().error(exec.getAllFailureExceptions().get(0));setResponsePage(BackupRestoreDataPage.class);
else
if(exec.isStopping()){//donothing
else{PageParameterspp=newPageParameters();pp.add("id",exec.getId());pp.add("clazz",RestoreExecutionAdapter.class.getSimpleName());setResponsePage(BackupRestorePage.class,pp);
if(self.equals(component)&&method.getDeclaringClass().equals(org.apache.wicket.behavior.IBehaviorListener.class)&&method.getName().equals("onRequest")){returntrue;
if(archiveFile==null||!Resources.exists(archiveFile)||archiveFile.getType()==Type.DIRECTORY||FilenameUtils.getExtension(archiveFile.name()).isEmpty()){thrownewException("RestoreArchiveFileisMandatory,mustexistsandshouldnotbeaDirectoryorURI.");
if(ws!=null){filter=ECQL.toFilter("name='"+ws.getName()+"'");
if(restoreOptDryRun){hints.add(newHints(newHints.OptionKey(Backup.PARAM_DRY_RUN_MODE),Backup.PARAM_DRY_RUN_MODE));
if(restoreOptBestEffort){hints.add(newHints(newHints.OptionKey(Backup.PARAM_BEST_EFFORT_MODE),Backup.PARAM_BEST_EFFORT_MODE));
if(restoreOptCleanTemp){hints.add(newHints(newHints.OptionKey(Backup.PARAM_CLEANUP_TEMP),Backup.PARAM_CLEANUP_TEMP));
if(jobid!=null){try{BackupRestoreWebUtils.backupFacade().stopExecution(jobid);setResponsePage(BackupRestoreDataPage.class);
if(metadata==null){metadata=newHashMap<Object,Object>();
if(messages!=null){messages.clear();
if(messages==null){messages=newArrayList<LogRecord>();
if(messages==null){retval=Collections.emptyList();
else{retval=Collections.unmodifiableList(messages);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;ImportTaskother=(ImportTask)obj;
if(context==null){
if(other.context!=null)returnfalse;
else
if(!context.equals(other.context))returnfalse;
if(id!=other.id)returnfalse;returntrue;}}
if(layerInfo==null){thrownewResourceNotFoundException("Nosuchlayer:"+layerName);
if(layerInfo!=null&&layerInfo.getResource()instanceofFeatureTypeInfo){finalList<Rule>rules=this.generateClassifiedSLD(layerName,property,method,intervals,intervalsForUnique,open,colorRamp,startColor,endColor,midColor,reverse,normalize);RulesListjsonRules=null;
if(rules!=null)jsonRules=generateRulesList(layerName,rules);
if(jsonRules!=null){returnwrapObject(jsonRules,RulesList.class);
else{thrownewInvalidRules();
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"ExceptionoccurredwhiletransformintheRule"+e.getLocalizedMessage(),e);
ifthereisthefeatureTypeparam*/
if(property!=null&&property.length()>0){/*FirsttrytofindasaFeatureType*/try{LayerInfolayerInfo=catalog.getLayerByName(layerName);
if(layerInfo!=null){ResourceInfoobj=layerInfo.getResource();/*Check
ifit'sfeaturetypeorcoverage*/
if(objinstanceofFeatureTypeInfo){finalFeatureTypeftType=((FeatureTypeInfo)obj).getFeatureType();finalFeatureCollectionftCollection=((FeatureTypeInfo)obj).getFeatureSource(newNullProgressListener(),null).getFeatures();List<Rule>rules=null;Class<?>propertyType=ftType.getDescriptor(property).getType().getBinding();
if("equalInterval".equals(method)){rules=builder.equalIntervalClassification(ftCollection,property,propertyType,Integer.parseInt(intervals),Boolean.parseBoolean(open),normalize);
else
if("uniqueInterval".equals(method)){rules=builder.uniqueIntervalClassification(ftCollection,property,propertyType,Integer.parseInt(intervalsForUnique),normalize);
else
if("quantile".equals(method)){rules=builder.quantileClassification(ftCollection,property,propertyType,Integer.parseInt(intervals),Boolean.parseBoolean(open),normalize);
else
if("jenks".equals(method)){rules=builder.jenksClassification(ftCollection,property,propertyType,Integer.parseInt(intervals),Boolean.parseBoolean(open),normalize);
if(colorRamp!=null&&colorRamp.length()>0){ColorRampramp=null;
if(colorRamp.equalsIgnoreCase("random"))ramp=newRandomColorRamp();
else
if(colorRamp.equalsIgnoreCase("red"))ramp=newRedColorRamp();
else
if(colorRamp.equalsIgnoreCase("blue"))ramp=newBlueColorRamp();
else
if(colorRamp.equalsIgnoreCase("jet"))ramp=newJetColorRamp();
else
if(colorRamp.equalsIgnoreCase("gray"))ramp=newGrayColorRamp();
else
if(colorRamp.equalsIgnoreCase("custom")){ColorstartColorDecoded=(startColor!=null?Color.decode(startColor):null);ColorendColorDecoded=(endColor!=null?Color.decode(endColor):null);ColormidColorDecoded=(midColor!=null?Color.decode(midColor):null);
if(startColorDecoded!=null&&endColorDecoded!=null){CustomColorRamptramp=newCustomColorRamp();tramp.setStartColor(startColorDecoded);tramp.setEndColor(endColorDecoded);
if(midColorDecoded!=null)tramp.setMid(midColorDecoded);ramp=tramp;
if(geomT==LineString.class||geomT==MultiLineString.class){builder.lineStyle(rules,ramp,reverse);
else
if(geomT==Point.class||geomT==MultiPoint.class){builder.pointStyle(rules,ramp,reverse);
else
if(geomT==MultiPolygon.class||geomT==Polygon.class){builder.polygonStyle(rules,ramp,reverse);
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"Thefollowingexceptionhasoccurred"+e.getLocalizedMessage(),e);
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"Thefollowingexceptionhasoccurred"+e.getLocalizedMessage(),e);
if(!rule.isEmpty()&&!rule.isNullObject()&&!rule.isArray()){writer.startNode("Rule");for(Objectkey:rule.keySet()){writer.startNode((String)key);writeChild(writer,rule.get(key));writer.endNode();
if(objectinstanceofJSONObject&&!((JSONObject)object).isArray()){for(Objectkey:((JSONObject)object).keySet()){finalObjectobj=((JSONObject)object).get(key);
if(objinstanceofJSONArray){for(inti=0;i<((JSONArray)obj).size();i++){finalJSONObjectchild=(JSONObject)((JSONArray)obj).get(i);writer.startNode((String)key);for(ObjectcKey:child.keySet()){writeKey(writer,child,(String)cKey);
else{writeKey(writer,(JSONObject)object,(String)key);
else
if(objectinstanceofJSONArray){for(inti=0;i<((JSONArray)object).size();i++){finalObjectchild=((JSONArray)object).get(i);
if(childinstanceofJSONObject){for(Objectkey:((JSONObject)child).keySet()){
if(((JSONObject)child).get(key)instanceofString)writer.addAttribute((String)key,(String)((JSONObject)child).get(key));
elsewriteChild(writer,((JSONObject)child).get(key));
else{writeChild(writer,child);
else{writer.setValue(object.toString());
if(key.startsWith("@")){writer.addAttribute(key.substring(1),(String)child.get(key));
else
if(key.startsWith("#")){writer.setValue((String)child.get(key));
else{writer.startNode(key);writeChild(writer,child.get(key));writer.endNode();
if{@codeo}isnotoftheexpectedtype*/publicvoidencode(Objecto)throwsIllegalArgumentException{
if(!(oinstanceofGetCapabilitiesRequest)){thrownewIllegalArgumentException();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(newStringBuffer("producingacapabilitiesdocumentfor").append(request).toString());
if(onlineResource==null||onlineResource.trim().length()==0){StringrequestBaseUrl=request.getBaseUrl();onlineResource=buildURL(requestBaseUrl,null,null,URLType.SERVICE);
else{try{newURL(onlineResource);
if(keywords!=null){for(KeywordInfokw:keywords){AttributesImplatts=newAttributesImpl();
if(kw.getVocabulary()!=null){atts.addAttribute("","vocabulary","vocabulary","",kw.getVocabulary());
if(metadataURLs==null){return;
if(dataURLs==null){return;
if(format.getOutputFormatNames().contains(format.getMimeType())){formats.add(format.getMimeType());
else{
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("Mapoutputformat"+format.getMimeType()+"("+format.getClass()+")"+"does"+"notincludemimetypeinoutputformatnames.Willbeexcludedfrom"+"capabilitiesdocument.");
if(sortedFormats.contains("image/png")){sortedFormats.remove("image/png");sortedFormats.add(0,"image/png");
if(getUrl!=null){start("Get");element("OnlineResource",null,orAtts);end("Get");
if(postUrl!=null){orAtts.setAttribute(1,"","href","xlink:href","",postUrl);start("Post");element("OnlineResource",null,orAtts);end("Post");
if(JSONType.isJsonpEnabled()){element("Format","JSONP");
ifthereareatleast*acommonone,asneededbythespec:"<i>TherootLayerelementshallincludeasequence*ofzeroormore&lt;SRS&gt;elementslistingallSRSesthatarecommontoallsubsidiary*layers.UseasingleSRSelementwithemptycontent(likeso:"&lt;SRS&gt;&lt;/SRS&gt;")*
ifthereisnocommonSRS."</i>**<p>Bytheotherhand,thissearchisalsousedtocollectothewholelatlonbbox,as*statedbythespec:<i>"TheboundingboxmetadatainCapabilitiesXMLspecifytheminimum*enclosingrectangleforthelayerasawhole."</i>**@taskTODO:managethisdifferentlywhenwehavethelayerlistoftheWMSservice*decoupledfromthefeaturetypesconfiguredfortheserverinstance.(Thisinvolves*nestedlayers,gridcoverages,etc)*/privatevoidhandleLayers(){start("Layer");//askforenabledandadvertisedtostartwithFilterfilter;{Filterenabled=equal("enabled",Boolean.TRUE);Filteradvertised=equal("advertised",Boolean.TRUE);filter=and(enabled,advertised);
ifanamespacefilterhasbeensetfilter=addNameSpaceFilterIfNeed(filter,"resource.namespace.prefix");finalCatalogcatalog=wmsConfig.getCatalog();
if(StringUtils.isBlank(serviceInfo.getRootLayerTitle())){element("Title",serviceInfo.getTitle());
else{element("Title",serviceInfo.getRootLayerTitle());
if(StringUtils.isBlank(serviceInfo.getRootLayerAbstract())){element("Abstract",serviceInfo.getAbstract());
else{element("Abstract",serviceInfo.getRootLayerAbstract());
if(srsList!=null){srs.addAll(srsList);
ifneededlgFilter=addNameSpaceFilterIfNeed(lgFilter,"workspace.name");//handlerootboundingboxList<LayerGroupInfo>layerGroups;List<LayerInfo>layers;SortBylgOrder=asc("name");SortByorder=asc("name");try(CloseableIterator<LayerGroupInfo>lgIter=catalog.list(LayerGroupInfo.class,lgFilter,null,null,lgOrder);CloseableIterator<LayerInfo>iter=catalog.list(LayerInfo.class,filter,null,null,order)){layerGroups=Lists.newArrayList(lgIter);layers=Lists.newArrayList(iter);
if(nameSpacePrefix==null){returnfilter;
if(epsgCodes.isEmpty()){comment("AllsupportedEPSGprojections:");capabilitiesCrsIdentifiers=newLinkedHashSet<String>();for(Stringcode:CRS.getSupportedCodes("AUTO")){
if("WGS84(DD)".equals(code))continue;capabilitiesCrsIdentifiers.add("AUTO:"+code);
else{comment("LimitedlistofEPSGprojections:");capabilitiesCrsIdentifiers=newLinkedHashSet<String>(epsgCodes);
if(!"WGS84(DD)".equals(code)){currentSRS=qualifySRS(code);element("CRS",currentSRS);
ifitisnotalreadyprefixed.*/privateStringqualifySRS(Stringsrs){
if(srs.indexOf(':')==-1){srs=EPSG+srs;
if(expandEnvelopeToContain(world,latlonBbox,layer.getResource().getLatLonBoundingBox())){//ourenvelopealreadycontainstheworldbreak;
if(referencedEnvelope==null){//noboundsavailablemoveoncontinue;
if(!CRS.equalsIgnoreMetadata(referencedEnvelope,DefaultGeographicCRS.WGS84)){try{//weneedtoreprojecttheenvelopetolat/lonreferencedEnvelope=referencedEnvelope.transform(DefaultGeographicCRS.WGS84,true);
if(expandEnvelopeToContain(world,latlonBbox,referencedEnvelope)){//ourenvelopealreadycontainstheworldbreak;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("SummarizedLatLonBBoxis"+latlonBbox);
if(resourceEnvelope!=null){envelope.expandToInclude(resourceEnvelope);
if(layersAlreadyProcessed.contains(layer)||!isExposable(layer)){continue;
if(path!=null&&path.length()>0&&!"/".equals(path)){nestedLayers.add(layer);continue;
if(wmsExposable){doHandleLayer(layer);
if(skipping){LOGGER.log(Level.WARNING,"Errorwritingmetadata;skippinglayer:"+layer.getName(),e);reset();
else{thrownewServiceException("Erroroccurredtryingtowriteoutmetadataforlayer:"+layer.getName(),e);
if(!layer.enabled()){returnfalse;
if(cascadedHopCount!=null){qatts.addAttribute("","cascaded","cascaded","",String.valueOf(cascadedHopCount));
if(bbox!=null){handleBBox(bbox,crs);handleAdditionalBBox(bbox,crs,layer);
if(layer.getType()==PublishedType.VECTOR){dimensionHelper.handleVectorLayerDimensions(layer);
else
if(layer.getType()==PublishedType.RASTER){dimensionHelper.handleRasterLayerDimensions(layer);
else
if(layer.getType()==PublishedType.WMTS){dimensionHelper.handleWMTSLayerDimensions(layer);
if(scaleDenominators.getMinimum()!=0.0){element("MinScaleDenominator",String.valueOf(scaleDenominators.getMinimum()));
if(scaleDenominators.getMaximum()!=Double.POSITIVE_INFINITY){element("MaxScaleDenominator",String.valueOf(scaleDenominators.getMaximum()));
if(layer.getResource()instanceofWMSLayerInfo){//donothingforthemoment,wemaywanttolistthesetofcascadednamedstyles//inthefuture(whenweaddsupportforthat)
else{//addthelayerstylestart("Style");StyleInfodefaultStyle=layer.getDefaultStyle();
if(defaultStyle==null){thrownewNullPointerException("Layer"+layer.getName()+"hasnodefaultstyle");
if(styles!=null){for(StyleInfostyleInfo:styles){start("Style");handleCommonStyleElements(styleInfo);handleLegendURL(layer,styleInfo.getLegend(),styleInfo,styleInfo);end("Style");
if(ftStyle.getDescription()!=null){//PMT:WMScapabilitiesrequiresatleastatitle,//
ifdescription'stitleisnull,usethename//fortitle.
if(ftStyle.getDescription().getTitle()!=null){element("Title",ftStyle.getDescription().getTitle());
else{element("Title",defaultStyle.prefixedName());
else{element("Title",defaultStyle.prefixedName());
if(is!=null){element(element,is.toString());
if(layerGroups==null){returnlayersAlreadyProcessed;
if(skipping){
if(group!=null){LOGGER.log(Level.WARNING,"Skippinglayergroup"+group.getName()+"asitscapsdocumentelementfailedtogenerate",e);
else{LOGGER.log(Level.WARNING,"Skippinganulllayergroupduringcapsduringcapsdocumentgeneration",e);
else{thrownewServiceException("Erroroccurredtryingtowriteoutmetadataforlayergroup:"+group.getName(),e);
if(piinstanceofLayerGroupInfo){result.remove(pi);
if(!LayerGroupInfo.Mode.CONTAINER.equals(layerGroup.getMode())){element("Name",layerName);
if(StringUtils.isEmpty(layerGroup.getTitle())){element("Title",layerName);
else{element("Title",layerGroup.getTitle());
if(StringUtils.isEmpty(layerGroup.getAbstract())){element("Abstract","Layer-Grouptypelayer:"+layerName);
else{element("Abstract",layerGroup.getAbstract());
if(LayerGroupInfo.Mode.EO.equals(layerGroup.getMode())){LayerInforootLayer=layerGroup.getRootLayer();//handledimensions
if(rootLayer.getType()==PublishedType.VECTOR){dimensionHelper.handleVectorLayerDimensions(rootLayer);
else
if(rootLayer.getType()==PublishedType.RASTER){dimensionHelper.handleRasterLayerDimensions(rootLayer);
if(metadataLinks==null||metadataLinks.isEmpty()){//Aggregatedmetadatalinks(seeGEOS-4500)Set<MetadataLinkInfo>aggregatedLinks=newHashSet<MetadataLinkInfo>();for(LayerInfolayer:Iterables.filter(layerGroup.getLayers(),LayerInfo.class)){List<MetadataLinkInfo>metadataLinksLayer=layer.getResource().getMetadataLinks();
if(metadataLinksLayer!=null){aggregatedLinks.addAll(metadataLinksLayer);
if(LayerGroupInfo.Mode.OPAQUE_CONTAINER.equals(layerGroup.getMode())){//justhidethelayersinthegrouplayersAlreadyProcessed.addAll(layerGroup.layers());
else
if(!LayerGroupInfo.Mode.SINGLE.equals(layerGroup.getMode())){for(PublishedInfochild:layerGroup.getLayers()){
if(childinstanceofLayerInfo){LayerInfolayer=(LayerInfo)child;
if(isExposable(layer)){handleLayer((LayerInfo)child);layersAlreadyProcessed.add((LayerInfo)child);
else{handleLayerGroup((LayerGroupInfo)child,layersAlreadyProcessed);
if(attribution!=null){Stringtitle=attribution.getTitle();Stringurl=attribution.getHref();StringlogoURL=attribution.getLogoURL();StringlogoType=attribution.getLogoType();intlogoWidth=attribution.getLogoWidth();intlogoHeight=attribution.getLogoHeight();booleantitleGood=(title!=null),urlGood=(url!=null),logoGood=(logoURL!=null&&logoType!=null&&logoWidth>0&&logoHeight>0);
if(titleGood||urlGood||logoGood){start("Attribution");
if(titleGood)element("Title",title);
if(urlGood){AttributesImplurlAttributes=newAttributesImpl();urlAttributes.addAttribute("","xmlns:xlink","xmlns:xlink","",XLINK_NS);urlAttributes.addAttribute(XLINK_NS,"type","xlink:type","","simple");urlAttributes.addAttribute(XLINK_NS,"href","xlink:href","",url);element("OnlineResource",null,urlAttributes);
if(logoGood){AttributesImpllogoAttributes=newAttributesImpl();logoAttributes.addAttribute("","","height","",""+logoHeight);logoAttributes.addAttribute("","","width","",""+logoWidth);start("LogoURL",logoAttributes);element("Format",logoType);AttributesImplurlAttributes=newAttributesImpl();urlAttributes.addAttribute("","xmlns:xlink","xmlns:xlink","",XLINK_NS);urlAttributes.addAttribute(XLINK_NS,"type","xlink:type","","simple");urlAttributes.addAttribute(XLINK_NS,"href","xlink:href","",logoURL);element("OnlineResource",null,urlAttributes);end("LogoURL");
ifany,ortotheproper*GetLegendGraphicoperation
ifanURLwasnotsupplied.**<p>ItiscommonpracticetosupplyaURLtoaWMSaccesiblelegendgraphicwhenitis*difficulttocreateadynamiclegendforalayer.**@paramlayerNameThenameofthelayer.*@paramlegendTheuserspecifiedlegendurl.Ifnulladefaulturlpointingbacktothe*GetLegendGraphicoperationwillbeautomaticallycreated.*@paramstyleThestyelforthelayer.*@paramsampleStyleThestyeltouseforsamplesizing.*/protectedvoidhandleLegendURL(LayerInfolayer,LegendInfolegend,StyleInfostyle,StyleInfosampleStyle){
if(legend!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("usingusersuppliedlegendURL");
if(styleWs!=null){legendUrl=buildURL(request.getBaseUrl(),appendPath("styles",styleWs.getName(),legend.getOnlineResource()),null,URLType.RESOURCE);
else{legendUrl=buildURL(request.getBaseUrl(),appendPath("styles",legend.getOnlineResource()),null,URLType.RESOURCE);
else{intlegendWidth=GetLegendGraphicRequest.DEFAULT_WIDTH;intlegendHeight=GetLegendGraphicRequest.DEFAULT_HEIGHT;
if(sampleStyle!=null){//delegatetolegendSamplethecalculusofproperlegendsizefor//thegivenstyleDimensiondimension;try{dimension=legendSample.getLegendURLSize(sampleStyle);
if(dimension!=null){legendWidth=(int)dimension.getWidth();legendHeight=(int)dimension.getHeight();
if(null==wmsConfig.getLegendGraphicOutputFormat(defaultFormat)){
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning(newStringBuffer("Defaultlegendformat(").append(defaultFormat).append(")isnotsupported(jainotavailable?),can'taddLegendURLelement").toString());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AddingGetLegendGraphiccallasLegendURL");
if(style!=null){params.put("style",style.getName());
if(crs!=null&&CRS.getAxisOrder(crs)==AxisOrder.NORTH_EAST){Stringtmp=minx;minx=miny;miny=tmp;tmp=maxx;maxx=maxy;maxy=tmp;
if(serviceInfo.isBBOXForEachCRS()&&!serviceInfo.getSRS().isEmpty()){//outputboundingboxforeachsupportedservicesrsfor(Stringsrs:serviceInfo.getSRS()){srs=qualifySRS(srs);
if(crs!=null&&srs.equals(crs)){continue;//alreadydidthisone
if(handler==null){//Stillnoluck.ReporttheoriginalissueLOGGER.warning(String.format("Unabletotransformboundingboxfor'%s'layer"+"to%s",layer!=null?layer.getName():"root",srs));
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,e.getLocalizedMessage(),e);
else{ReferencedEnvelopetbbox=handler.transformEnvelope(bbox,targetCrs);handleBBox(tbbox,srs);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,e1.getLocalizedMessage(),e1);
if(authorityURLs==null||authorityURLs.isEmpty()){return;
if(name==null||href==null){LOGGER.warning("IgnoringAuthorityURL,name:"+name+",href:"+href);continue;
if(identifiers==null||identifiers.isEmpty()){return;
if(authority==null||id==null){LOGGER.warning("IgnoringlayerIdentifier,authority:"+authority+",identifier:"+id);continue;
ifthestyleisvalid.*/publicabstractList<Exception>validate(Objectinput,Versionversion,EntityResolverentityResolver)throwsIOException;/**Returnstheformatmimetypeforthespecifiedversion.*/publicabstractStringmimeType(Versionversion);/***Returnstheformatversionforthespecifiedmimetype.**<p>Thismethodshouldonlybeoverridenbyformatsthatsupportmultipleversions.The*defaultimplementationjustreturns1.0.0.*/publicVersionversionForMimeType(StringmimeType){returnnewVersion("1.0.0");
if(inputinstanceofReader){return(Reader)input;
if(inputinstanceofInputStream){returnnewInputStreamReader((InputStream)input);
if(inputinstanceofString){returnnewStringReader((String)input);
if(inputinstanceofURL){returnnewInputStreamReader(((URL)input).openStream());
if(inputinstanceofFile){returnnewFileReader((File)input);
if(inputinstanceofResource){returntoReader(((Resource)input).in());
iflocatedinpublicfolderofthe*webapplication**@authoraaime*/publicclassFileHiderServletextendsHttpServlet{protectedvoiddoGet(HttpServletRequestrequest,HttpServletResponseresponse)throwsServletException,IOException{response.sendError(404);}}
ifnoneisfound*/publicstaticGetMapOutputFormatfindMapProducer(finalStringoutputFormat,finalApplicationContextapplicationContext){finalCollection<GetMapOutputFormat>producers;producers=WMSExtensions.findMapProducers(applicationContext);returnfindMapProducer(outputFormat,producers);
if(caseInsensitiveFormats.contains(outputFormat)){returnproducer;
if(format.getContentType().startsWith(outputFormat)){returnformat;
iftheywereactuallysortedbysubject,hereistheexpectedidentifierorderassertEquals("urn:uuid:9a669547-b69b-469f-a11f-2d875366bbdc",values.get(0));assertEquals("urn:uuid:88247b56-4cbc-4df9-9860-db3f8042e357",values.get(1));assertEquals("urn:uuid:94bc9c83-97f6-4b40-9eb8-a8e8787a5c63",values.get(2));
if(settings!=null){initializeFromSettings(settings);
ifneeded*/protectedvoidinitializeGlobalAttributes(){copyGlobalAttribute();addGlobalAttributesFromSettings();
if(globalAttributes!=null){for(NetCDFSettingsContainer.GlobalAttributeatt:globalAttributes){
if(att.getKey().equalsIgnoreCase(NetCDFUtilities.CONVENTIONS)){writer.addGroupAttribute(null,newAttribute(NetCDFUtilities.COORD_SYS_BUILDER,NetCDFUtilities.COORD_SYS_BUILDER_CONVENTION));
ifenabled*/protectedvoidcopyGlobalAttribute(){//CopyglobalattributesfromsourceNetCDF
if(copyGlobalAttributes){try(NetcdfDatasetsource=getSourceNetcdfDataset(sampleGranule)){
if(source!=null){for(Attributeatt:source.getGlobalAttributes()){writer.addGroupAttribute(null,att);
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("FailedtocopyfromsourceNetCDF:"+e.getMessage());
ifitdoesnothaveone.*/protectedNetcdfDatasetgetSourceNetcdfDataset(GridCoverage2Dgranule){URLsourceUrl=(URL)granule.getProperty(GridCoverage2DReader.SOURCE_URL_PROPERTY);
if(sourceUrl!=null){try{returnNetCDFUtilities.getDataset(sourceUrl);
if(NetCDFUtilities.NETCDF4_MIMETYPE.equalsIgnoreCase(outputFormat)){version=NetcdfFileWriter.Version.netcdf4_classic;
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Requestedoutputformat"+outputFormat+"isn't"+NetCDFUtilities.NETCDF4_MIMETYPE+"\nFallbacktoVersion3");
if(version==NetcdfFileWriter.Version.netcdf4_classic){
if(!NetCDFUtilities.isNC4CAvailable()){thrownewIOException(NetCDFUtilities.NC4_ERROR_MESSAGE);
if(keys!=null&&!keys.isEmpty()&&keys.contains(WCS20GetCoverageResponse.COVERAGE_ID_PARAM)){StringcoverageId=encodingParameters.get(WCS20GetCoverageResponse.COVERAGE_ID_PARAM);
if(coverageId!=null){GeoServergeoserver=GeoServerExtensions.bean(GeoServer.class);MetadataMapmap=null;
if(geoserver!=null){CataloggsCatalog=geoserver.getCatalog();LayerInfoinfo=NCNameResourceCodec.getCoverage(gsCatalog,coverageId);
if(info!=null){map=info.getResource().getMetadata();
if(map!=null&&!map.isEmpty()&&map.containsKey(NetCDFSettingsContainer.NETCDFOUT_KEY)){NetCDFLayerSettingsContainersettings=map.get(NetCDFSettingsContainer.NETCDFOUT_KEY,NetCDFLayerSettingsContainer.class);returnsettings;
if(level==null||(level<0||level>9)){
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("NetCDF4compressionLevelnotintheproperrange[0,9]:"+level+"\nProceedingwithdefaultvalue:"+NetCDFSettingsContainer.DEFAULT_COMPRESSION);
if(value==null){Set<String>dimensions=crsWriter.getCoordinatesDimensionNames();//Coordinatesdimensions(lon/lat)aren'ttakenintoaccount//forvaluesupdate.Donotwarn
iftheyaremissing
if(dimensions!=null&&!dimensions.contains(dimensionName)&&LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("NoDimensionsavailablewiththespecifiedname:"+dimensionName);
else{dimension.getDimensionValues().addValue(value);
if(dimensionName.equalsIgnoreCase("TIME")||dimensionName.equalsIgnoreCase("ELEVATION")){//SpecialmanagementforTIMEandELEVATIONdimensions//wewillputthesedimensionlowercaseforNetCDFnamesdimensionName=dimensionName.toLowerCase();
if(isRange){
if(boundDimension==null){boundDimension=writer.addDimension(null,NetCDFUtilities.BOUNDARY_DIMENSION,2);
ifneeded
if(NetCDFUtilities.isATime(dim.getDatatype())){//Specialmanagementfortimes.WeusetheNetCDFconventionofdefiningtimes//startingfrom//anorigin.RightnowweusetheLinuxEPOCHwriter.addVariableAttribute(var,newAttribute(NetCDFUtilities.UNITS,NetCDFUtilities.TIME_ORIGIN));
else{writer.addVariableAttribute(var,newAttribute(NetCDFUtilities.UNITS,dim.getSymbol()));
if(isRange){finalList<Dimension>boundsDimensions=newArrayList<Dimension>();boundsDimensions.add(netcdfDimension);boundsDimensions.add(boundDimension);finalStringboundName=dimensionName+NetCDFUtilities.BOUNDS_SUFFIX;writer.addVariableAttribute(var,newAttribute(NetCDFUtilities.BOUNDS,boundName));writer.addVariable(null,boundName,NetCDFUtilities.getNetCDFDataType(dim.getDatatype()),boundsDimensions);
if(outDataType==null){//ThismayhappenforNONEdataPackingoutDataType=NetCDFUtilities.transcodeImageDataType(dataType);
ifLayerNameandLayerUOMarecompliant*/protectedbooleancheckCompliant(Variablevar){//CheckintheVariable
if(var==null){//Variableisnotpresentreturnfalse;
if(unit==null){//Nounitdefinedreturnfalse;
if(parserBean==null||parserBean.getParser()==null){//Unabletocheck
ifitiscf-compliantreturnfalse;
if(e!=null){Stringcanonical=e.getCanonicalUnits();StringdefinedUnit=unit.getStringValue();
if(canonical.equalsIgnoreCase(definedUnit)){validUOM=true;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Canonicalunitandspecifiedunitareequal."+"Proceedingwithstandard_nameset");
else{booleanparseable=false;try{ucar.units.UnitucarUnit=SUF.parse(definedUnit);ucar.units.UnitcanonicalUnit=SUF.parse(canonical);
if(ucarUnit.isCompatible(canonicalUnit)){validUOM=true;parseable=true;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Canonicalunitandspecifiedunitarecompatible."+"Proceedingwithstandard_nameset");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(e1.getLocalizedMessage());
if(!parseable){
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Thespecifiedunit"+definedUnit+"can'tbeconvertedtoa"+"UCARunitsoitdoesn'tallowtodefineastandardname");
ifthereadpixelisnoDataandapplytheunitConversion(ifneeded)anddataPacking*(ifneeded).**@paramx*@paramy*@paramimageDataType*@paramnetCDFDataType*@paramdata*@parammatrix*@parammatrixIndex*/protectedvoidsetPixel(intx,inty,DataTypeimageDataType,DataTypenetCDFDataType,RandomIterdata,Arraymatrix,IndexmatrixIndex,DataPacking.DataPackerdataPacker,DoublenoDataValue,UnitConverterunitConverter,intbandIdx){//Readthedata,check
ifnodataandconvertit
ifneededintsample;booleanvalidSample;
switch(imageDataType){caseBYTE:caseSHORT:caseINT:sample=data.getSample(x,y,bandIdx);validSample=!isNaN(sample,noDataValue);
if(unitConverter!=null&&validSample){sample=(int)unitConverter.convert(sample);
if(dataPacker!=null){sample=dataPacker.pack((double)sample);
if(unitConverter!=null&&validSample){sampleFloat=(float)unitConverter.convert(sampleFloat);
if(dataPacker!=null){sample=validSample?dataPacker.pack(sampleFloat):dataPacker.getReservedValue();setIntegerSample(netCDFDataType,matrix,matrixIndex,sample);
else{matrix.setFloat(matrixIndex,sampleFloat);
if(unitConverter!=null&&validSample){sampleDouble=unitConverter.convert(sampleDouble);
if(dataPacker!=null){sample=validSample?dataPacker.pack(sampleDouble):dataPacker.getReservedValue();setIntegerSample(netCDFDataType,matrix,matrixIndex,sample);
else{matrix.setDouble(matrixIndex,sampleDouble);
switch(netCDFDataType){caseBYTE:matrix.setByte(matrixIndex,(byte)sample);break;caseSHORT:matrix.setShort(matrixIndex,(short)sample);break;caseINT:matrix.setInt(matrixIndex,sample);break;
if(Double.isNaN(noDataValue)){returnDouble.isNaN(sampleValue);
if(coverageDimension!=null){//Latandlondoesn'thaveaCoveragedimensionfinalStringdimensionName=manager.getName();//GetthecurrentvalueforthatdimensionforthiscoveragefinalObjectval=properties.get(dimensionName);//Getallthevaluesforthatdimension,lookingfortheone//whichmatchesthecoverage'sone//TODO:Improvethissearch.Makeitmoresmart/performantfinalSet<Object>values=(Set<Object>)manager.getDimensionValues().getValues();finalIterator<Object>it=values.iterator();while(it.hasNext()){Objectvalue=it.next();
if(value.equals(val)){indexing[i++]=dimElement;dimElement=0;break;
if(extraVariables!=null){List<NetCDFSettingsContainer.ExtraVariable>scalarExtraVariables=newArrayList<>();for(NetCDFSettingsContainer.ExtraVariableextra:extraVariables){
if(extra.getDimensions().isEmpty()){scalarExtraVariables.add(extra);
else{for(intdimensionIndex=0;dimensionIndex<dimName.length;dimensionIndex++){//sideeffectofthisconditionistoskipextravariables//withmultipleoutputdimensions(unsupported)
if(extra.getDimensions().equals(dimName[dimensionIndex])){nonscalarExtraVariables.add(newExtraVariableRecord(extra,dimensionIndex));break;
if(!scalarExtraVariables.isEmpty()){try(NetcdfDatasetsource=getSourceNetcdfDataset(sampleGranule)){for(NetCDFSettingsContainer.ExtraVariableextra:scalarExtraVariables){writer.write(writer.findVariable(extra.getOutput()),source.findVariable(extra.getSource()).read());
if(kind==notify.getKind()){checked=true;
if(objectinstanceofRestWrapper){object=((RestWrapper<?>)object).getObject();
if(objectinstanceofStyleInfo){StyleInfostyle=(StyleInfo)object;//optimization,
iftherequestedformatisthesameasthenativeformat//ofthestyle,streamthefiledirectlyfromthedisk,otherwiseencode//thestyleintherequestedformat
if(handler.getFormat().equalsIgnoreCase(style.getFormat())){copyDefinition(style,outputMessage.getBody());return;
if(!getInfo().getServiceLevel().getOps().contains(WFSInfo.Operation.TRANSACTION_UPDATE)){thrownewWFSException(element,"TransactionUpdatesupportisnotenabled");
if(property.getValue()==null){StringpropertyName=property.getName().getLocalPart();AttributeDescriptorattributeType=null;PropertyDescriptorpd=featureType.getDescriptor(propertyName);
if(pdinstanceofAttributeDescriptor){attributeType=(AttributeDescriptor)pd;
if((attributeType!=null)&&(attributeType.getMinOccurs()>0)){Stringmsg="Property'"+attributeType.getLocalName()+"'ismandatorybutnovaluespecified.";thrownewWFSException(element,msg,"MissingParameterValue");
if(name.getPrefix()!=null&&!"".equals(name.getPrefix())){propertyName=ff.property(name.getPrefix()+":"+name.getLocalPart());
else{propertyName=ff.property(name.getLocalPart());
if(descriptor==null){
if(getInfo().isCiteCompliant()){//wasitacommonGMLpropertythatwedon'thavebackingstoragefor?Stringnamespace=name.getNamespaceURI();Classbinding=GML_PROPERTIES_BINDINGS.get(name.getLocalPart());
if(GML_NAMESPACES.contains(namespace)&&binding!=null){//thehackishere,CITEtestswantustoreportthatupdatingwithan//un-parseableKMLpoint//isaninvalidvaluevalidateValue(element,property,binding);//
iftheabovedidnotthrow,thenmoveonwiththeusualbehavior
if(value==null//parsedasnull||(valueinstanceofString&&((String)value).trim().isEmpty())//asanemptystring||(valueinstanceofMap&&((Map)value).isEmpty())//ortheusualmapthattheparsercreates){return;
ifthedatastoremachinerywillbeabletoconvertObjectconverted=Converters.convert(value,binding);
if(converted==null){StringpropertyName=property.getName().getLocalPart();WFSExceptione=newWFSException(element,"Invalidvalueforproperty"+propertyName,WFSException.INVALID_VALUE);e.setLocator(propertyName);throwe;
if(store==null){thrownewWFSException(request,"CouldnotlocateFeatureStorefor'"+elementName+"'");
if(filter!=null){filter=WFSReprojectionUtil.normalizeFilterCRS(filter,store.getSchema(),declaredCRS);
else{filter=Filter.INCLUDE;
if(properties.isEmpty()){return;
ifgeometry,itmaybenecessarytoreprojectittothenativeCRSbefore//update
if(values[j]instanceofGeometry){Geometrygeometry=(Geometry)values[j];//getthesourcecrs,checkthegeometryitselffirst.Ifnotset,assume//thedefaultoneCoordinateReferenceSystemsource=null;
if(geometry.getUserData()instanceofCoordinateReferenceSystem){source=(CoordinateReferenceSystem)geometry.getUserData();
else{geometry.setUserData(declaredCRS);source=declaredCRS;
ifthegeometryhasaCRSotherthanthedefaultoneCoordinateReferenceSystemtarget=null;
if(types[j]instanceofGeometryDescriptor){target=((GeometryDescriptor)types[j]).getCoordinateReferenceSystem();
if(getInfo().isCiteCompliant())JTS.checkCoordinatesRange(geometry,source!=null?source:target);//
ifwehaveasourceandtargetandtheyarenotequal,do//thereprojection,otherwisejustupdatethevalueasis
if(source!=null&&target!=null&&!CRS.equalsIgnoreMetadata(source,target)){try{//TODO:thiscodeshouldbesharedwiththecode//fromReprojectingFeatureCollection--JDMathTransformtx=CRS.findMathTransform(source,target,true);GeometryCoordinateSequenceTransformergtx=newGeometryCoordinateSequenceTransformer();gtx.setMathTransform(tx);values[j]=gtx.transform(geometry);
if((request.getLockId()!=null)&&storeinstanceofFeatureLocking&&(request.isReleaseActionSome())){SimpleFeatureLockinglocking;locking=(SimpleFeatureLocking)store;locking.unLockFeatures(filter);
if(!fids.isEmpty()){LOGGER.finer("PostprocessupdateforboundaryupdateandfeatureValidation");Set<FeatureId>featureIds=newHashSet<FeatureId>();FilterFactory2ff=CommonFactoryFinder.getFilterFactory2(GeoTools.getDefaultHints());for(Iterator<FeatureId>f=fids.iterator();f.hasNext();){//createnewFeatureIdswithoutanypossibleversioninformationinorderto//queryforthelatestversionfeatureIds.add(ff.featureId(f.next().getID()));
if(name.endsWith("[1]")){returnname.substring(0,name.length()-3);
if(queries.isEmpty()){thrownewWFSException(request,"Noqueryspecified");
if(WFSInfo.Version.V_20.compareTo(request.getVersion())>=0&&request.isLockRequest()&&request.isResultTypeHits()){thrownewWFSException("GetFeatureWithLockcannotbeusedwithresulttype'hits'",ServiceException.INVALID_PARAMETER_VALUE,"resultType");
if(request.isQueryTypeNamesUnset()){expandTypeNames(request,queries,getFeatureById,getCatalog());
if(request.isLockRequest()){LockFeatureRequestlockRequest=request.createLockRequest();lockRequest.setExpiry(request.getExpiry());lockRequest.setHandle(request.getHandle());
if(request.isLockActionSome()){lockRequest.setLockActionSome();
else{lockRequest.setLockActionAll();
if(request.isLockActionSome()){FilterlockedFeatureFilter=toFeatureIdFilter(response.getLockedFeatures());for(Queryquery:queries){Filterfilter=query.getFilter();
if(filter==null||filter==Filter.INCLUDE){query.setFilter(lockedFeatureFilter);
else{Filterjoined=Predicates.and(filter,lockedFeatureFilter);query.setFilter(joined);
ifwearefailing://-
ifwefailtoaquireallthelockswewillneedtofailand//itteratethroughthetheFeatureSourcestoreleasethelocks//BigIntegerbi=request.getMaxFeatures();
if(bi==null){request.setMaxFeatures(BigInteger.valueOf(Integer.MAX_VALUE));
ifthisisonlyaHITSrequestANDthewfssettingflag//hitsIgnoreMaxFeaturesisset,thensetthemaxFeaturestobethe//maximumsupportedvaluefromgeotools.Thisiscurrently//themaximumvalueofjava.lang.Integer.MAX_VALUEsoitisimpossible//toreturnmorethenthisvalueeven
iftherearematchingvalues//withouteitherchanginggeotoolstousealongorpagingtheresults.
if(wfs.isHitsIgnoreMaxFeatures()&&request.isResultTypeHits()){maxFeatures=org.geotools.data.Query.DEFAULT_MAX;
if(request.getViewParams()!=null&&request.getViewParams().size()>0){viewParams=request.getViewParams();
if(totalOffset==-1&&request.getVersion().startsWith("2")&&(wfs.isCiteCompliant()||(request.getMaxFeatures()!=null&&request.getMaxFeatures().longValue()>0&&request.isResultTypeHits()))){//StrictcompliancewiththeWFS2.0specrequiresstartindextodefaulttozero.//Thisisnotenforcedbecausestartindextriggerssortingandreducesperformance.//TheCITEtestsforWFS2.0donotyetexist;theCITEcompliancesettingistaken//asarequestforstrict(er)compliancewiththeWFS2.0spec.//SeeGEOS-5085.totalOffset=0;
if(!query.getAliases().isEmpty()){
if(query.getAliases().size()!=query.getTypeNames().size()){thrownewWFSException(request,String.format("Queryspecifies%dtypenamesand%d"+"aliases,mustbeequal",query.getTypeNames().size(),query.getAliases().size()));
if(filter==null&&metas.size()>1){thrownewWFSException(request,"Joinquerymustspecifyafilter");
if(filter!=null){
if(meta.getFeatureType()instanceofSimpleFeatureType){
if(metas.size()>1){//sanitizealiases,theymustnotconflictwithfeaturetypenames//norwiththeirattributesquery=AliasedQuery.fixAliases(metas,query);//thefiltermighthavebeenrewrittenfilter=query.getFilter();//thejoinextractingvisitorcannothandlenegatedfilters,//thesimplifierhandlesmostcommoncaseremovingthenegation,//e.g.,not(a<10)->a>=10filter=SimplifyingFilterVisitor.simplify(filter);//join,needtoseparatethejoiningfilterfromotherfiltersJoinExtractingVisitorextractor=newJoinExtractingVisitor(metas,query.getAliases());extractor.setQueriedTypes(query.getTypeNames());filter.accept(extractor,null);primaryAlias=extractor.getPrimaryAlias();primaryMeta=extractor.getPrimaryFeatureType();metas=extractor.getFeatureTypes();primaryTypeName=newQName(primaryMeta.getNamespace().getURI(),primaryMeta.getName());joins=extractor.getJoins();
if(joins.size()!=metas.size()-1){thrownewWFSException(request,String.format("Queryspecified%dtypesbut%d"+"joinfilterswerefound",metas.size(),extractor.getJoins().size()));
if(!isValidJoinFilter(join.getJoinFilter())){thrownewWFSException(request,"Unabletoperformjoinwithspecifiedjoinfilter:"+filter);
if(join.getFilter()!=null){validateFilter(join.getFilter(),query,metas.get(j),request);
if(filter!=null){validateFilter(filter,query,primaryMeta,request);
else{validateFilter(filter,query,meta,request);
else{BBOXNamespaceSettingVisitorfilterVisitor=newBBOXNamespaceSettingVisitor(ns);filter.accept(filterVisitor,null);
if(!propertyNames.isEmpty()){metaPropNames=newArrayList<PropertyName>();for(Iteratoriter=propertyNames.iterator();iter.hasNext();){PropertyNamepropName=createPropertyName((String)iter.next(),ns);
if(propName.evaluate(meta.getFeatureType())==null){Stringmesg="Requestedproperty:"+propName+"is"+"notavailable"+"for"+meta.getPrefixedName()+".";
if(meta.getFeatureType()instanceofSimpleFeatureType){List<AttributeTypeInfo>atts=meta.attributes();ListattNames=newArrayList(atts.size());for(AttributeTypeInfoatt:atts){attNames.add(att.getName());
ifweneedtoforcefeatureboundscomputation,wehavetoload//allofthegeometries,butwe'llhavetoremovetheminthe//returnedfeaturetype
if(wfs.isFeatureBounding()){metaAllPropNames=addGeometryProperties(meta,metaPropNames);
else{metaAllPropNames=metaPropNames;
ifnot//requested),//ie.thosewithminOccurs>0//onlydothisforsimplefeatures,complexmandatoryfeaturesare//handledbyapp-schema
if(meta.getFeatureType()instanceofSimpleFeatureType){metaAllPropNames=DataUtilities.addMandatoryProperties((SimpleFeatureType)meta.getFeatureType(),metaAllPropNames);metaPropNames=DataUtilities.addMandatoryProperties((SimpleFeatureType)meta.getFeatureType(),metaPropNames);
ifpresentList<SortBy>sortBy=query.getSortBy();
if(sortBy!=null&&!sortBy.isEmpty()&&meta.getFeatureType()instanceofSimpleFeatureType){validateSortBy(sortBy,meta,request);
if(joins!=null){hints=newHints(ResourcePool.JOINS,joins);
if(metaMaxFeatures>0&&metaMaxFeatures<queryMaxFeatures){queryMaxFeatures=metaMaxFeatures;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Queryis"+query+"\nTogt2:"+gtQuery);
if(!callbacks.isEmpty()){for(GetFeatureCallbackcallback:callbacks){callback.beforeQuerying(context);
if(gtQuery!=context.getQuery()&&LOGGER.isLoggable(Level.FINE)){LOGGER.fine("QueryafterGetFeatureCallbackchanges:"+source);
if(!(meta.getFeatureType()instanceofSimpleFeatureType)){features.getSchema().getUserData().put("targetCrs",query.getSrsName());features.getSchema().getUserData().put("targetVersion",request.getVersion());
if(!calculateSize){//
ifoffsetwasspecifiedandwehavemorequeriesleftinthisrequest//thenwe//mustcalculatesizeinordertoadjusttheoffsetcalculateSize=offset>0&&i<queries.size()-1;
if(calculateSize){size=features.size();
iftheyareunsetwecanusethesizewe//calculatedaboveisNumberMatchedSkipped=meta.getSkipNumberMatched()&&!request.isResultTypeHits();
if(!isNumberMatchedSkipped){
if(calculateSize&&(queryMaxFeatures==Integer.MAX_VALUE||size<queryMaxFeatures)&&offset<=0){totalCountExecutors.add(newCountExecutor(size));
else{org.geotools.data.QueryqTotal=toDataQuery(query,filter,0,Integer.MAX_VALUE,source,request,allPropNames.get(0),viewParam,joins,primaryTypeName,primaryAlias);totalCountExecutors.add(newCountExecutor(source,qTotal));
ifoffsetispresentweneedtocheckthesizeofthisreturnedfeature//collection//andadjusttheoffsetforthenextfeaturecollectionaccordingly
if(offset>0){
if(size>0){//featuresreturned,offsetcanbesettozerooffset=0;
else{//nofeaturesmighthavebeenbecauseoftheoffsetthatwasspecified,//check//thesizeofthesamequerybutwithnooffsetorg.geotools.data.Queryq2=toDataQuery(query,filter,0,queryMaxFeatures,source,request,allPropNames.get(0),viewParam,joins,primaryTypeName,primaryAlias);//intsize2=getFeatures(request,source,q2).size();intsize2=source.getCount(q2);
if(size2>0){//adjusttheoffsetforthenextqueryoffset=Math.max(0,offset-size2);
if(features.getSchema()instanceofSimpleFeatureType&&metaPropNames!=null&&metaPropNames.size()<allPropNames.get(0).size()){String[]residualNames=newString[metaPropNames.size()];Iterator<PropertyName>it=metaPropNames.iterator();intj=0;while(it.hasNext()){residualNames[j]=it.next().getPropertyName();j++;
if(i==request.getQuery().size()-1){////DJB:dontcalculatefeaturecount
ifyoudonthaveto.The//MaxFeatureReaderwilltakecareofthelastiteration//maxFeatures-=features.getCount();//
ifthefeaturesultsshouldbeaddedhereforlater//encoding
ifitwasalockrequest.maybeafterensuringthelock//succeed?results.add(features);
ifonewasset,or
ifitsimplyset//toGetFeature,whichisthedefault
if(query.getHandle()!=null&&(e.getLocator()==null||"GetFeature".equalsIgnoreCase(e.getLocator()))){e.setLocator(query.getHandle());
if(isNumberMatchedSkipped){totalCount=BigInteger.valueOf(-1);
else
if(count<maxFeatures&&calculateSize&&totalOffset==0){//optimization:
ifcount<maxfeaturesthentotalcount==count//can'tusethisoptimizationforv2totalCount=BigInteger.valueOf(count);
else{//ok,inthiscasewe'reforcedtorunthequeriestodiscovertheactualtotal//count//Wedosolazily,notalloutputformatsneedit,leveragingthefactthat//BigInteger//isnotfinaltowrapitinalazyloadingproxyEnhancerenhancer=newEnhancer();enhancer.setSuperclass(BigInteger.class);enhancer.setCallback(newLazyLoader(){@OverridepublicObjectloadObject()throwsException{longtotalCount=0;for(CountExecutorq:totalCountExecutors){intresult=q.getCount();//
ifthecountisunknownforone,wedon'tknowthetotal,//period
if(result==-1){totalCount=-1;break;
else{totalCount+=result;
if(lockedFeatures==null||lockedFeatures.isEmpty()){returnFilter.EXCLUDE;
if(!q.getTypeNames().isEmpty())continue;
if(q.getFilter()!=null){TypeNameExtractingVisitorv=newTypeNameExtractingVisitor(catalog);q.getFilter().accept(v,null);q.getTypeNames().addAll(v.getTypeNames());
if(q.getTypeNames().isEmpty()){
if(getFeatureById){//byspec,a404shouldbereturnedinthiscasethrownewWFSException(request,"Couldnotfindfeaturewithspecifiedid",WFSException.NOT_FOUND);
else{Stringmsg="Nofeaturetypesspecified";thrownewWFSException(request,msg,ServiceException.INVALID_PARAMETER_VALUE);
ifasingleGetFeatureByIdstoredquerywasfound*(asadifferentGMLencodingisrequiredinthatcase)**@paramrequest*@return*/protectedbooleanprocessStoredQueries(GetFeatureRequestrequest){Listqueries=request.getAdaptedQueries();booleanfoundGetFeatureById=expandStoredQueries(request,queries,storedQueryProvider);returnqueries.size()==1&&foundGetFeatureById;
if(objinstanceofStoredQueryType){
if(storedQueryProvider==null){thrownewWFSException(request,"Storedquerynotsupported");
if(storedQuery==null){WFSExceptionexception=newWFSException(request,"Storedquery'"+storedQueryId+"'doesnot"+"exist.",ServiceException.INVALID_PARAMETER_VALUE);exception.setLocator("STOREDQUERY_ID");throwexception;
if(offset>0||count<Integer.MAX_VALUE){//pagedrequest,setthevaluesofpreviousandnext//gettheRequestthreadlocalsinceweneedtoknowabouttherequest,whetheritis//GETorPOSTsomekvpinformation
iftheformerRequestreq=Dispatcher.REQUEST.get();//grabtheoriginalkvpparams
ifthisisaGETrequest//forPOST,donothing,maketheclientpostthesamecontent//TODO:trytoencodetherequestasbestwecaninaGETrequest,onlyissueshould//bethefilterandencodingitproperty...especiallyforjoinsthatmightbe//tricky,anditalsomaycausetherequesttobetoolargeforagetrequest//TODO:figureoutwhatthespecsaysaboutthis...Map<String,String>kvp=null;
if(req.isGet()){kvp=newKvpMap(req.getRawKvp());
else{//generatekvpmapfromrequestobjectkvp=buildKvpFromRequest(request);
if(request.isResultTypeHits()&&(request.getVersion()==null||request.getVersion().startsWith("2"))){kvp=newKvpMap(kvp);kvp.put("RESULTTYPE","results");kvp.put("STARTINDEX","0");
if(offset>0&&!(request.isResultTypeHits()&&request.getVersion().startsWith("2"))){//previous//previousoffsetcalculatedasthecurrentoffset-maxFeatures,or0
ifthisisa//negativevalueintprevOffset=Math.max(offset-maxFeatures,0);kvp.put("startIndex",String.valueOf(prevOffset));//previouscountshouldbecurrentoffset-previousOffsetkvp.put("count",String.valueOf(offset-prevOffset));result.setPrevious(buildURL(request.getBaseUrl(),"wfs",kvp,URLType.SERVICE));
ifweareattheend.ButalwaysdoinWFS2.0HITS//(ie.arereturninglessresultsthanrequested)
if(request.isResultTypeHits()&&request.getVersion().startsWith("2")){result.setNext(buildURL(request.getBaseUrl(),"wfs",kvp,URLType.SERVICE));
else
if(count>0&&offset>-1&&maxFeatures<=count){kvp.put("startIndex",String.valueOf(offset>0?offset+count:count));kvp.put("count",String.valueOf(maxFeatures));result.setNext(buildURL(request.getBaseUrl(),"wfs",kvp,URLType.SERVICE));
if(q.getSrsName()!=null){kvp.put("SRSNAME",q.getSrsName().toString());
if(queries.size()>1){for(inti=1;i<queries.size();i++){encodeQueryAsKvp(queries.get(i),typeNames,propertyName,aliases,filter,true);
if(propertyName!=null){kvp.put("PROPERTYNAME",propertyName.toString());
if(aliases!=null){kvp.put("ALIASES",aliases.toString());
if(filter!=null){kvp.put("FILTER",filter.toString());
if(useDelim){typeNames.append("(");
if(useDelim){typeNames.append(")");
if(propertyName!=null){
if(useDelim){propertyName.append("(");
if(useDelim){propertyName.append(")");
if(aliases!=null){
if(useDelim){aliases.append("(");
if(useDelim){aliases.append(")");
if(filter!=null){//TODO:checkthelengthoftheencodedfilterandensureitdoesnotputusoverthe//edgeofthelimitforaGETrequestFilterf=q.getFilter();
if(useDelim){filter.append("(");
if(useDelim){filter.append(")");
if(maxFeatures<=0){maxFeatures=org.geotools.data.Query.DEFAULT_MAX;
if(filter==null){filter=Filter.INCLUDE;
else{//Gentlemen,wecanrebuildit.Wehavethetechnology!SimplifyingFilterVisitorvisitor=newSimplifyingFilterVisitor();filter=(Filter)filter.accept(visitor,null);
if(declaredCRS!=null){transformedFilter=WFSReprojectionUtil.normalizeFilterCRS(filter,source.getSchema(),declaredCRS);
if(isGmlBoundedBy(expression)){//envelopeofthedefaultgeometryreturnfilterFactory.function("boundedBy",filterFactory.property(""));
else{returnsuper.visit(expression,extraData);
ifboundedByis//usedwe//needto
switchtoanintersectsfilterExpressionexpression1=filter.getExpression1();
if(expression1instanceofPropertyName&&isGmlBoundedBy((PropertyName)expression1)){ReferencedEnvelopebounds=ReferencedEnvelope.reference(filter.getBounds());Polygonpolygon=JTS.toGeometry(bounds);FunctionboundedBy=filterFactory.function("boundedBy",filterFactory.property(""));returnfilterFactory.intersects(boundedBy,filterFactory.literal(polygon));
if(primaryAlias!=null){dataQuery.setAlias(primaryAlias);
if(srsName!=null){try{target=CRS.decode(srsName.toString());
else{target=declaredCRS;
ifthecrsarenotequal,thenreproject
if(target!=null&&declaredCRS!=null&&!CRS.equalsIgnoreMetadata(crs,target)){dataQuery.setCoordinateSystemReproject(target);
if(sortBy!=null){dataQuery.setSortBy(sortBy.toArray(newSortBy[sortBy.size()]));
if(featureVersion!=null){dataQuery.setVersion(featureVersion);
if(offset>-1){dataQuery.setStartIndex(offset);
if(traverseXlinkDepth!=null){//TODO:makethisanintegerinthemodel,andhavehteNumericKvpParser//handle'*'asmaxvalueIntegerdepth=traverseXlinkDepth(traverseXlinkDepth);//setthedepthasahintonthequeryhints.put(Hints.ASSOCIATION_TRAVERSAL_DEPTH,depth);
if(resolveTimeOut!=null){hints.put(Hints.RESOLVE_TIMEOUT,resolveTimeOut.intValue());
if(!xlinkProperties.isEmpty()){for(Iteratorx=xlinkProperties.iterator();x.hasNext();){XlinkPropertyNameTypexlinkProperty=(XlinkPropertyNameType)x.next();IntegerxlinkDepth=traverseXlinkDepth(xlinkProperty.getTraverseXlinkDepth());//setthedepthandpropertyashintsonthequeryhints.put(Hints.ASSOCIATION_TRAVERSAL_DEPTH,xlinkDepth);PropertyNamexlinkPropertyName=filterFactory.property(xlinkProperty.getValue());hints.put(Hints.ASSOCIATION_PROPERTY,xlinkPropertyName);dataQuery.setHints(hints);//TODO:supportmultiplepropertiesbreak;
ifpossiblehints.put(Hints.JTS_COORDINATE_SEQUENCE_FACTORY,newLiteCoordinateSequenceFactory());//checkforsqlviewparameters
if(viewParams!=null){hints.put(Hints.VIRTUAL_TABLE_PARAMETERS,viewParams);
ifspecified
if(joins!=null){dataQuery.getJoins().addAll(joins);
if("*".equals(raw)){//TODO:JD:notsurewhatthisvalueshouldbe?ithinkit//mightbereportedintehacapabilitisdocument,using//INteger.MAX_VALUEwillresultinstackoverflow...fornow//wejustuse10traverseXlinkDepth=newInteger(2);
else{//notwildcardcase,throworiginalexceptionthrownfe;
if(meta==null){Stringmsg="Couldnotlocate"+name+"incatalog.";thrownewWFSException(request,msg,"InvalidParameterValue").locator("typeName");
if(featureTypes.size()==1){//nonjoinpropNames.get(0).addAll(query.getPropertyNames());returnpropNames;
if(propName.startsWith(featureType.getPrefixedName()+"/")){propNames.get(j).add(propName.substring((featureType.getPrefixedName()+"/").length()));continueO;
if(propName.startsWith(featureType.getName()+"/")){propNames.get(j).add(propName.substring((featureType.getName()+"/").length()));continueO;
if(propName.startsWith(alias+"/")){propNames.get(j).add(propName.substring((alias+"/").length()));continueO;
if(name.evaluate(featureType)==null){thrownewWFSException(request,"Illegalpropertyname:"+name.getPropertyName()+"forfeaturetype"+meta.prefixedName(),"InvalidParameterValue");
if(name.evaluate(featureType)==null&&!isGmlBoundedBy(name)){thrownewWFSException(request,"Illegalpropertyname:"+name.getPropertyName()+"forfeaturetype"+meta.prefixedName(),"InvalidParameterValue");
if(filter.getExpression1()instanceofPropertyName){name=(PropertyName)filter.getExpression1();
else
if(filter.getExpression2()instanceofPropertyName){name=(PropertyName)filter.getExpression2();
if(name!=null){//checkagainstfeatauretypetomakesureits//ageometrictypeAttributeDescriptoratt=(AttributeDescriptor)name.evaluate(featureType);
if(!(attinstanceofGeometryDescriptor)&&!isGmlBoundedBy(name)){thrownewWFSException(request,"Property"+name+"isnotgeometricinfeaturetype"+meta.prefixedName(),"InvalidParameterValue");
if(wfs.isCiteCompliant()){
if(query.getSrsName()!=null){finalQueryfquery=query;fvisitor=newAbstractFilterVisitor(){publicObjectvisit(BBOXfilter,Objectdata){
if(filter.getSRS()!=null&&!fquery.getSrsName().toString().equals(filter.getSRS())){//backprojectboundingboxintogeographiccoordinatesCoordinateReferenceSystemgeo=DefaultGeographicCRS.WGS84;GeneralEnvelopee=newGeneralEnvelope(newdouble[]{filter.getMinX(),filter.getMinY()},newdouble[]{filter.getMaxX(),filter.getMaxY()});CoordinateReferenceSystemcrs=null;try{crs=CRS.decode(filter.getSRS());e.setCoordinateReferenceSystem(crs);e=CRS.transform(e,geo);
if(e.getMinimum(0)<valid.getWestBoundLongitude()||e.getMinimum(0)>valid.getEastBoundLongitude()||e.getMaximum(0)<valid.getWestBoundLongitude()||e.getMaximum(0)>valid.getEastBoundLongitude()||e.getMinimum(1)<valid.getSouthBoundLatitude()||e.getMinimum(1)>valid.getNorthBoundLatitude()||e.getMaximum(1)<valid.getSouthBoundLatitude()||e.getMaximum(1)>valid.getNorthBoundLatitude()){thrownewWFSException(request,"boundingboxoutofvalidrangeofcrs","InvalidParameterValue");
if(wfs.isCiteCompliant()){fvisitor=newAbstractFilterVisitor(){@OverrideprotectedObjectvisit(BinaryComparisonOperatorfilter,Objectdata){Expressionex1=filter.getExpression1();Expressionex2=filter.getExpression2();
if(ex1instanceofPropertyName){checkNonSpatial((PropertyName)ex1);
if(ex2instanceofPropertyName){checkNonSpatial((PropertyName)ex2);
if(adinstanceofGeometryDescriptor||isGmlBoundedBy(pn)){thrownewWFSException(request,"Cannotuseaspatialpropertyinaalphanumericbinary"+"comparison");
if(idx>1&&propertyName.indexOf(":")<propertyName.length()-1){String[]split=propertyName.split("\\:");Stringprefix=split[0];StringlocalName=split[1];
if(!"boundedBy".equals(localName)){returnfalse;
if(name.getNamespaceContext()==null&&"gml".equals(prefix)){returntrue;
if(meta.getMaxFeatures()>0){maxFeatures=Math.min(maxFeatures,meta.getMaxFeatures());
if(path.contains("/")){returnfilterFactory.property(path,namespaceContext);
else{
if(path.contains(":")){inti=path.indexOf(":");returnfilterFactory.property(newNameImpl(namespaceContext.getURI(path.substring(0,i)),path.substring(i+1)));
else{returnfilterFactory.property(path);
if(meta.getFeatureType().getDescriptor(ati.getName())instanceofGeometryDescriptor&&!properties.contains(propName)){properties.add(propName);
ifgdal_translateisinthepath.**@paramgdalTranslate*/@OverridepublicvoidsetExecutable(StringgdalTranslate){this.gdalTranslateExecutable=gdalTranslate;
if(environment!=null){this.environment.clear();this.environment.putAll(environment);
if(format==null){thrownewIllegalArgumentException("Noformatprovided");
if(format.getMimeType()!=null){formatsByMimeType.put(format.getMimeType().toUpperCase(),format);
if(formats==null||formats.isEmpty()){thrownewIllegalArgumentException("Noformatsprovided");
if(format!=null){addFormatInternal(format);
if(format.isSingleFile()){
if(format.getMimeType()!=null){mimeType=format.getMimeType();
else{//useadefaultbinaryblobmimeType="application/octet-stream";
else{mimeType="application/zip";
if(format.isSingleFile()){
if(format.getFileExtension()!=null){extension=format.getFileExtension();
else{//defaultto.binextension="bin";
else{extension="zip";
if(extension.charAt(0)=='.'){extension=extension.substring(1);
if(format==null){//trytolookitupbymimetypeformat=formatsByMimeType.get(outputFormat.toUpperCase());
if(format==null){thrownewWcsException("Unknownoutputformat:"+outputFormat);
if(format.isSingleFile()){try(FileInputStreamfis=newFileInputStream(outputFile)){org.apache.commons.io.IOUtils.copy(fis,output);
else{//scantheoutputdirectoryandzipitalltry(ZipOutputStreamzipOut=newZipOutputStream(output)){IOUtils.zipDirectory(tempGDAL,zipOut,null);zipOut.finish();
if(wcsService!=null&&wcsService.isLatLon()){writerParams.parameter(GeoTiffFormat.RETAIN_AXES_ORDER.getName().toString()).setValue(true);
if(writer!=null)writer.write(coverage,(GeneralParameterValue[])writerParams.values().toArray(newGeneralParameterValue[1]));
if(writer!=null)writer.dispose();
if(localName.equals("GetCapabilities")){LOGGER.finer("foundcapabilitiesstart.");for(inti=0,n=atts.getLength();i<n;i++){
if(atts.getLocalName(i).equals("version")){Stringversion=atts.getValue(i);request.setVersion(version);
else
if(atts.getLocalName(i).equals("service")){//okWMSisimplicit
else
if(atts.getLocalName(i).equals("updateSequence")){request.setUpdateSequence(atts.getValue(i));
if(ad.getLocalName().equalsIgnoreCase("product_id")){granuleForeignKey=ad.getLocalName();
if(granuleForeignKey==null){thrownewIllegalStateException("Couldnotlocateacolumnnamed'product'_idintable'granule'");
ifnecessary
if(addJoins&&hasOutputProperty(query,OpenSearchAccess.QUICKLOOK_PROPERTY_NAME,false)){Filterfilter=FF.equal(FF.property("id"),FF.property("quicklook.tid"),true);Joinjoin=newJoin("product_thumb",filter);join.setAlias("quicklook");result.getJoins().add(join);
if(metadataValueinstanceofSimpleFeature){SimpleFeaturequicklookFeature=(SimpleFeature)metadataValue;AttributeBuilderab=newAttributeBuilder(CommonFactoryFinder.getFeatureFactory(null));ab.setDescriptor((AttributeDescriptor)schema.getDescriptor(OpenSearchAccess.QUICKLOOK_PROPERTY_NAME));Attributeattribute=ab.buildSimple(null,quicklookFeature.getAttribute("thumb"));builder.append(OpenSearchAccess.QUICKLOOK_PROPERTY_NAME,attribute);
if(OpenSearchAccess.GRANULES.equals(name.getLocalPart())){finalStringtableName="granule";modifySecondaryTable(mappedFilter,value,tableName,id->FF.equal(FF.property("product_id"),FF.literal(id),true),(id,granulesStore)->{SimpleFeatureCollectiongranules=(SimpleFeatureCollection)value;SimpleFeatureBuilderfb=newSimpleFeatureBuilder(granulesStore.getSchema());ListFeatureCollectionmappedGranules=newListFeatureCollection(granulesStore.getSchema());granules.accepts(f->{SimpleFeaturesf=(SimpleFeature)f;for(AttributeDescriptorad:granulesStore.getSchema().getAttributeDescriptors()){fb.set(ad.getLocalName(),sf.getAttribute(ad.getLocalName()));
if(StringUtils.hasLength(getUserPropertyName())==false){thrownewIOException("Userpropertynameisunset");
if(set.isEmpty())returnnull;
if(set.size()>1){StringBufferbuff=newStringBuffer();for(GeoServerUseruser:set){buff.append(user.getUsername()).append(",");
if(user.isEnabled()==false){LOGGER.info("Founduser"+user.getUsername()+"forkey"+key+",butthisuserisdisabled");returnnull;
if(service.canCreateStore()==false)thrownewIOException("Cannotsynchronizeareadonlyusergroupservice");intcounter=0;GeoServerUserGroupStorestore=service.createStore();store.load();for(GeoServerUseruser:store.getUsers()){Stringvalue=user.getProperties().getProperty(getUserPropertyName());
if(StringUtils.hasLength(value)==false){user.getProperties().put(getUserPropertyName(),createAuthKey());try{store.updateUser(user);counter++;
if(catalog.getResourcePool().getFeatureTypeAttributeCache().containsKey(featureTypeId)){List<AttributeTypeInfo>attributesList=catalog.getResourcePool().getFeatureTypeAttributeCache().get(featureTypeId);assertNull("attributescleared",attributesList);
if(catalog.getResourcePool().getDataStoreCache().containsKey(dataStoreId)){DataAccessdataStore=catalog.getResourcePool().getDataStoreCache().get(dataStoreId);List<Name>names=dataStore.getNames();assertTrue(names.contains(name));
if(catalog.getResourcePool().getFeatureTypeAttributeCache().containsKey(featureTypeId)){List<AttributeTypeInfo>attributesList=catalog.getResourcePool().getFeatureTypeAttributeCache().get(featureTypeId);assertNull("attributescleared",attributesList);
if(catalog.getResourcePool().getDataStoreCache().containsKey(dataStoreId)){DataAccessdataStore=catalog.getResourcePool().getDataStoreCache().get(dataStoreId);List<Name>names=dataStore.getNames();assertTrue(names.contains(name));
if(object.equalsIgnoreCase(STATS)){returnnewParamResourceModel("JAIEXTPanel."+STATS,null,"").getString();
else
if(object.equalsIgnoreCase(OPERATION_CONST)){returnnewParamResourceModel("JAIEXTPanel."+OPERATION_CONST,null,"").getString();
else
if(object.equalsIgnoreCase(ALGEBRIC)){returnnewParamResourceModel("JAIEXTPanel."+ALGEBRIC,null,"").getString();
else{returnobject;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCacheEvictiontaskrunning");LOGGER.fine("Cacheentries#:"+cache.size());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCacheEvictiontaskcompleted");LOGGER.fine("Cacheentries#:"+cache.size());
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("AuthenticationCacheInitializedwith"+maxEntries+"MaxEntries,"+timeToIdleSeconds+"secondsidletime,"+timeToLiveSeconds+"secondstimetoliveand"+concurrencyLevel+"concurrencylevel");
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("AuthenticationCacheEvictionTaskcreatedtorunevery"+cleanUpSeconds+"seconds");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCacheremovingallentries");LOGGER.fine("Cacheentries#:"+cache.size());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCacheremovedallentries");LOGGER.fine("Cacheentries#:"+cache.size());
if(filterName==null)return;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCacheremovingallentriesfor"+filterName);LOGGER.fine("Cacheentries#:"+cache.size());
if(filterName.equals(key.getFilterName()))toBeRemoved.add(key);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCacheremoved"+toBeRemoved.size()+"entriesfor"+filterName);LOGGER.fine("Cacheentries#:"+cache.size());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCacheremoving"+filterName+","+cacheKey+"entry");LOGGER.fine("Cacheentries#:"+cache.size());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCacheremoved"+filterName+","+cacheKey+"entry");LOGGER.fine("Cacheentries#:"+cache.size());
if(entry==null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCachehasnoentryfor"+filterName+","+cacheKey);
if(entry.hasExpired(currentTime)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Entryhasexpired");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCachefoundanentryfor"+filterName+","+cacheKey);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCacheaddingnewentryfor"+filterName+","+cacheKey);LOGGER.fine("Cacheentries#:"+cache.size());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCacheaddednewentryfor"+filterName+","+cacheKey);LOGGER.fine("Cacheentries#:"+cache.size());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCacheaddingnewentryfor"+filterName+","+cacheKey);LOGGER.fine("Cacheentries#:"+cache.size());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AuthenticationCacheaddednewentryfor"+filterName+","+cacheKey);LOGGER.fine("Cacheentries#:"+cache.size());
if(filterRole(role)!=null){delegateAsStore().addRole(role);
if(filterRole(role)!=null){delegateAsStore().updateRole(role);
if(filterRole(role)!=null){returndelegateAsStore().removeRole(role);
if(filterRole(role)!=null&&!filterGroup(groupname)){delegateAsStore().associateRoleToGroup(role,groupname);
if(filterRole(role)!=null&&!filterGroup(groupname)){delegateAsStore().disAssociateRoleFromGroup(role,groupname);
if(filterRole(role)!=null&&!filterUser(username)){delegateAsStore().associateRoleToUser(role,username);
if(filterRole(role)!=null&&!filterUser(username)){delegateAsStore().disAssociateRoleFromUser(role,username);
if(filterRole(role)!=null&&filterRole(parentRole)!=null){delegateAsStore().setParentRole(role,parentRole);
if(!(infoinstanceofDataStoreInfo)){//onlydatastoressupposedatthistime,TODO:fixthisreturnCollections.emptySet();
if(factory==null){LOGGER.warning("Couldnotfindfactoryforstore:"+info+".Unabletoencrypt"+"connectionparameters.");returnCollections.emptySet();
iffactoryreturnsnoinfononeedtocontinue
if(factory.getParametersInfo()==null){returnCollections.emptySet();
if(toEncrypt!=null){returntoEncrypt;
if(toEncrypt!=null){returntoEncrypt;
if(info!=null&&info.getConnectionParameters()!=null){toEncrypt=newHashSet<String>(3);for(Paramp:factory.getParametersInfo()){
if(p.isPassword()){toEncrypt.add(p.getName());
if(encoderName!=null){GeoServerPasswordEncoderpwEncoder=securityManager.loadPasswordEncoder(encoderName);
if(pwEncoder!=null){Stringprefix=pwEncoder.getPrefix();
if(value.startsWith(prefix+GeoServerPasswordEncoder.PREFIX_DELIMTER)){thrownewRuntimeException("Cannotencodeapasswordwithprefix:"+prefix+GeoServerPasswordEncoder.PREFIX_DELIMTER);
else{LOGGER.warning("Encryptiondisabled,nopasswordencoderset");
if(info.getConnectionParameters()!=null){for(Stringkey:info.getConnectionParameters().keySet()){
if(encryptedFields.contains(key)){Stringvalue=(String)info.getConnectionParameters().get(key);
if(value!=null){info.getConnectionParameters().put(key,decode(value,encoders));
if(encoder.isReversible()==false)continue;//shouldnothappen
if(encoder.isResponsibleForEncoding(value)){returnencoder.decode(value);
if(name.startsWith(prefix)){name=name.substring(prefix.length());
if(q!=null&&q.getFilter()!=null){Filterunmapped=GranuleStoreViewFilterVisitor.unmapIdentifiers(q.getFilter(),coverageView.getName());renamedQuery.setFilter(unmapped);
if(queriesCoverages.add(coverageName)){renamedQuery.setTypeName(coverageName);SimpleFeatureCollectioncollection=reader.getGranules(coverageName,readOnly).getGranules(renamedQuery);collections.add(collection);
if(returnOnlyFirst){break;
if(collections.size()==0){thrownewIllegalStateException("Unexpected,thereisnotasinglebandinthedefinition?");
else{//needtocompositethecollectionsSimpleFeatureTypeschema=collections.get(0).getSchema();result=newCompositeFeatureCollection(collections,schema);//cannotuseasimpleretyperhere,allfeaturesneedauniquefeatureidSimpleFeatureTypeBuildertb=newSimpleFeatureTypeBuilder();tb.init(schema);tb.setName(coverageView.getName());returnnewRetypingFeatureCollection(result,tb.buildFeatureType()){@OverridepublicSimpleFeatureIteratorfeatures(){returnnewRetypingIterator(delegate.features(),target){@OverridepublicSimpleFeaturenext(){SimpleFeaturenext=delegate.next();builder.init(next);StringnewId=coverageView.getName()+"."+next.getID();returnbuilder.buildFeature(newId);
ifweneedtodisposeitornot//Doesnothing,thecatalogshouldbedisposedbytheuser
if(storeinstanceofCoverageStoreInfo){((CoverageStoreInfo)store).setURL(uri.toString());
else{try{store.getConnectionParameters().put("url",uri.toURL());
if(createLayer){finalStoreInfo_store=catalog.getStoreByName(ws,layerName.getLocalPart(),StoreInfo.class);finalCoverageInfo_resource=catalog.getResourceByName(layerName,CoverageInfo.class);createStore=_store==null;createResource=_resource==null;
if(createStore){store=isShapeFile?catalogFac.createDataStore():catalogFac.createCoverageStore();store.setWorkspace(ws);store.setName(layerName.getLocalPart());
if(isShapeFile){store.getConnectionParameters().put("url",url);
else{
if(url==null){((CoverageStoreInfo)store).setType(determineFormatFromScheme(uri.getScheme()));
else{
if(url.getProtocol().equalsIgnoreCase("file")){((CoverageStoreInfo)store).setType(GridFormatFinder.findFormat(Resources.fromURL(uri.toString()).toString()).getName());
else{((CoverageStoreInfo)store).setType(GridFormatFinder.findFormat(url).getName());
else{store=unwrap(_store,StoreInfo.class);
if(createResource){builder.setStore(store);try{
if(isShapeFile){resource=builder.buildFeatureType(((ShapefileDataStore)((DataStoreInfo)store).getDataStore(null)).getFeatureSource());builder.setupBounds(resource);
else{resource=builder.buildCoverage();
if(createStore){catalog.remove(store);
else{resource=unwrap(_resource,CoverageInfo.class);
else{layer=null;resource=null;store=null;createStore=false;createResource=false;
if(createResource){ResourceInfoeditResource=catalog.getResource(resource.getId(),ResourceInfo.class);editResource.setAdvertised(true);catalog.save(editResource);
if(createLayer){catalog.remove(layer);
if(createResource){catalog.remove(resource);
if(createStore){catalog.remove(store);
if(oinstanceofWrapper){return((Wrapper)o).unwrap(clazz);
else{returno;
if(ImportContextProvider.ID==property){PageParameterspp=newPageParameters();pp.add("id",property.getModel(itemModel).getObject());returnnewSimpleBookmarkableLink(id,ImportPage.class,property.getModel(itemModel),pp);
else
if(ImportContextProvider.CREATED==property||ImportContextProvider.UPDATED==property){Datedate=(Date)property.getModel(itemModel).getObject();Stringpretty=PRETTY_TIME.format(date);returnnewLabel(id,pretty);
ifyouuselessthan256colorsinyourpaletteInverterIwill*accordinglysetthetransparentpixeltothefirstavailablepositioninthepaletteInverter,*whichispalette_size.Ifyouuse256colorsnotransparencywillbeusedfortheimagewe*generate.**<p><strong>Beaware</strong>thatIrfanViewdoesnotalwaysreportcorrectlythesizeofthe*paletteitexports.Bereadytomanuallycorrectthenumberofcolorsreported.**<p>HereisanexplanationofwhataJASCpalfileshouldlooklike:**<p><ahref="http://www.cryer.co.uk/filetypes/p/pal.htm">JASCPALfile</a>**<p>andhereisalistofotherpossibleformatswecouldparse(inthefuture
ifwehavetimeor*someonepaysforit:-))**<p><ahref="http://www.pl32.com/forum/viewtopic.php?t=873">alternativePALfileformats</a>**@authorSimoneGiannecchini*/classPALFileLoader{protectedstaticfinalLoggerLOGGER=org.geotools.util.logging.Logging.getLogger("it.geosolutions.inversecolormap.PALFileLoader");/**Sizeofthecolormapwe'lluse.*/protectedintmapsize;/**Finalindexcolormodel.*/protectedIndexColorModelindexColorModel;/***{@linkPALFileLoader}constructorthatacceptaresource.**<p>NotethatthetransparentIndexpixelshouldnotexceedthelastzero-basedindexavailable*forthecolormapweareagoingtocreate.Ifthishappenswemightgetverybadbehaviour.*Notealsothat
ifwesetthisparameterto-1we'llgetanopaque{@linkIndexColorModel}.**@paramfilePathtotheaplettefile.*@paramtransparentIndextransparentpixelindex(zero-based).*/publicPALFileLoader(Resourcefile){
if(file.getType()!=Type.RESOURCE)thrownewIllegalArgumentException("Theprovidedfiledoesnotexist.");BufferedReaderreader=null;try{reader=newBufferedReader(newInputStreamReader(file.in()));//headerbooleanloadNext=false;Stringtemp=reader.readLine().trim();
if(temp.equalsIgnoreCase("JASC-PAL")){
if(LOGGER.isLoggable(Level.FINE))LOGGER.fine("Foundheaderinpalettefile");loadNext=true;
if(loadNext){temp=reader.readLine().trim();
if(temp.equalsIgnoreCase("0100")){
if(LOGGER.isLoggable(Level.FINE))LOGGER.fine("Foundversioninpalettefile");loadNext=true;
if(loadNext)temp=reader.readLine().trim();this.mapsize=Integer.parseInt(temp);
if(mapsize>256||mapsize<=0)thrownewIllegalArgumentException("Theprovidednumberofcolorsisinvalid");//loadvariouscolorsfinalbytecolorMap[][]=newbyte[3][mapsize<256?mapsize+1:mapsize];for(inti=0;i<mapsize;i++){//getthelinetemp=reader.readLine().trim();
if(temp.startsWith("#"))temp="0x"+temp.substring(1);
if(temp.startsWith("0x")||temp.startsWith("0X")){finalColorcolor=Color.decode(temp);colorMap[0][i]=(byte)color.getRed();colorMap[1][i]=(byte)color.getGreen();colorMap[2][i]=(byte)color.getBlue();
else{//tokenizeitfinalStringTokenizertokenizer=newStringTokenizer(temp,"",false);intnumComponents=0;while(tokenizer.hasMoreTokens()){
if(numComponents>=3)thrownewIllegalArgumentException("Thenumberofcomponentsinonethecolorisgreaterthan3!");colorMap[numComponents++][i]=(byte)Integer.parseInt(tokenizer.nextToken());
if(numComponents!=3)thrownewIllegalArgumentException("Thenumberofcomponentsinonethecolorisinvalid!");
if(mapsize<256)this.indexColorModel=newIndexColorModel(8,mapsize+1,colorMap[0],colorMap[1],colorMap[2],mapsize);
elsethis.indexColorModel=newIndexColorModel(8,mapsize,colorMap[0],colorMap[1],colorMap[2]);
if(reader!=null)try{reader.close();
if(!TURBO_JPEG_LIB_AVAILABLE){
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("Theturbojpegencoderisnotavailable,checkthenativelibsinstallation");
else{
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("Theturbojpegencoderisavailableforusage");
if(DISABLE_TURBO){
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("Theturbojpegencoderhasbeenexplicitlydisabled");
if(!TURBO_JPEG_LIB_AVAILABLE||DISABLE_TURBO){
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Abouttofallbackonstandardlibaslibjpeg-turbiisnotavailable");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AbouttowriteaJPEGimageusinglibjpeg-turbo");
if(iw!=null){iw.dispose();
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.log(Level.FINEST,e.getLocalizedMessage(),e);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("WritingaJPEGdone!!!");
if(appContext!=null){appContext.publishEvent(newContextLoadedEvent(appContext));
switch(elementSet){caseBRIEF:returnMetaDataDescriptor.BRIEF_ELEMENTS;caseSUMMARY:returnMetaDataDescriptor.SUMMARY_ELEMENTS;default:returnnull;
if(filter!=null&&!Filter.INCLUDE.equals(filter)){query.setFilter((Filter)filter.accept(newMDQueryableFilterVisitor(),null));
if(sortBy!=null&&sortBy.length>0){for(inti=0;i<sortBy.length;i++){SortBysb=sortBy[i];
if(!SortBy.NATURAL_ORDER.equals(sb)&&!SortBy.REVERSE_ORDER.equals(sb)){sortBy[i]=newSortByImpl(MDQueryableFilterVisitor.property(sb.getPropertyName()),sb.getSortOrder());
if(INSTANCE==null){INSTANCE=GeoServerExtensions.bean(MetaDataDescriptor.class);
if(INSTANCE==null){INSTANCE=newMetaDataDescriptor();
ifthelayeridisprovidedandnotfoundinthecatalog*/@TestpublicvoidtestPutBadId()throwsException{finalStringlayerName=getLayerId(MockData.BASIC_POLYGONS);finalStringurl="gwc/rest/layers/"+layerName+".xml";MockHttpServletResponseresponse=putLayer(url,"badId",layerName);assertThat(response,hasProperty("status",equalTo(HttpServletResponse.SC_BAD_REQUEST)));assertThat(response,hasProperty("contentAsString",containsString("NoGeoServerLayerorLayerGroupexistswithid'badId'")));assertThat(response,hasProperty("contentType",startsWith("text/plain")));
ifthelayeridisnotprovided,thelayernameis,but*nosuchlayerisfoundinthe{@linkCatalog}*/@TestpublicvoidtestPutNoIdBadLayerName()throwsException{finalStringurl="gwc/rest/layers/badLayerName.xml";MockHttpServletResponseresponse=putLayer(url,"","badLayerName");assertThat(response,hasProperty("status",equalTo(HttpServletResponse.SC_NOT_FOUND)));assertThat(response,hasProperty("contentAsString",containsString("GeoServerLayerorLayerGroup'badLayerName'notfound")));assertThat(response,hasProperty("contentType",startsWith("text/plain")));
if(filterinstanceofFloatParameterFilter)floatFilter=(FloatParameterFilter)filter;
if(filterinstanceofStringParameterFilter)stringFilter=(StringParameterFilter)filter;
if(filterinstanceofStyleParameterFilter)styleFilter=(StyleParameterFilter)filter;
if(filterinstanceofFloatParameterFilter)floatFilter=(FloatParameterFilter)filter;
if(filterinstanceofStyleParameterFilter)styleFilter=(StyleParameterFilter)filter;
if(object==null)returnnull;Classclazz=object.getClass();//foreachsupportedInfotype,logawarning
iftheobjecttobesecuredisalready//secured.Ifthishappens,//itcouldleadtoaStackOverflowError
iftheobjectisre-wrapped,overtime,overand//overagian.
if(CoverageInfo.class.isAssignableFrom(clazz))returnnewSecuredCoverageInfo(logIfSecured((CoverageInfo)object),policy);
else
if(CoverageStoreInfo.class.isAssignableFrom(clazz))returnnewSecuredCoverageStoreInfo(logIfSecured((CoverageStoreInfo)object),policy);
else
if(DataStoreInfo.class.isAssignableFrom(clazz))returnnewSecuredDataStoreInfo(logIfSecured((DataStoreInfo)object),policy);
else
if(FeatureTypeInfo.class.isAssignableFrom(clazz))returnnewSecuredFeatureTypeInfo(logIfSecured((FeatureTypeInfo)object),policy);
else
if(LayerInfo.class.isAssignableFrom(clazz))returnnewSecuredLayerInfo(logIfSecured((LayerInfo)object),policy);
else
if(WMSLayerInfo.class.isAssignableFrom(clazz))returnnewSecuredWMSLayerInfo(logIfSecured((WMSLayerInfo)object),policy);
else
if(WMTSLayerInfo.class.isAssignableFrom(clazz))returnnewSecuredWMTSLayerInfo(logIfSecured((WMTSLayerInfo)object),policy);
elsethrownewIllegalArgumentException("Don'tknowhowtowrap"+object);
iftheInfoobjectisalreadywrappedwithaSecureddecorator.This*methodisonlyintendedtologasituationwhereaCatalogInfoobjectisbeingsecured,but*isalreadysecured.Repeatedcallstothiswillkeepaddingadditionalwrapperlayersandmay*eventuallycauseaStackOverflowError.Theloggeneratedismerelytoaidinfindingthereal*issue,asopposedtomaskingithere.**@paramobject{@linkWMTSLayerInfo}tocheck.*@returnTheoriginalobjecttobechecked.*/privateWMTSLayerInfologIfSecured(WMTSLayerInfoobject){WMTSLayerInfounwrapped=ModificationProxy.unwrap(object);
if(unwrappedinstanceofSecuredWMTSLayerInfo){logDoubleWrap(unwrapped,object);
iftheInfoobjectisalreadywrappedwithaSecureddecorator.This*methodisonlyintendedtologasituationwhereaCatalogInfoobjectisbeingsecured,but*isalreadysecured.Repeatedcallstothiswillkeepaddingadditionalwrapperlayersandmay*eventuallycauseaStackOverflowError.Theloggeneratedismerelytoaidinfindingthereal*issue,asopposedtomaskingithere.**@paramobject{@linkWMSLayerInfo}tocheck.*@returnTheoriginalobjecttobechecked.*/privateWMSLayerInfologIfSecured(WMSLayerInfoobject){WMSLayerInfounwrapped=ModificationProxy.unwrap(object);
if(unwrappedinstanceofSecuredWMSLayerInfo){logDoubleWrap(unwrapped,object);
iftheInfoobjectisalreadywrappedwithaSecureddecorator.This*methodisonlyintendedtologasituationwhereaCatalogInfoobjectisbeingsecured,but*isalreadysecured.Repeatedcallstothiswillkeepaddingadditionalwrapperlayersandmay*eventuallycauseaStackOverflowError.Theloggeneratedismerelytoaidinfindingthereal*issue,asopposedtomaskingithere.**@paramobject{@linkLayerInfo}tocheck.*@returnTheoriginalobjecttobechecked.*/privateLayerInfologIfSecured(LayerInfoobject){LayerInfounwrapped=ModificationProxy.unwrap(object);
if(unwrappedinstanceofSecuredLayerInfo){logDoubleWrap(unwrapped,object);
iftheInfoobjectisalreadywrappedwithaSecureddecorator.This*methodisonlyintendedtologasituationwhereaCatalogInfoobjectisbeingsecured,but*isalreadysecured.Repeatedcallstothiswillkeepaddingadditionalwrapperlayersandmay*eventuallycauseaStackOverflowError.Theloggeneratedismerelytoaidinfindingthereal*issue,asopposedtomaskingithere.**@paramobject{@linkFeatureTypeInfo}tocheck.*@returnTheoriginalobjecttobechecked.*/privateFeatureTypeInfologIfSecured(FeatureTypeInfoobject){FeatureTypeInfounwrapped=ModificationProxy.unwrap(object);
if(unwrappedinstanceofSecuredFeatureTypeInfo){logDoubleWrap(unwrapped,object);
iftheInfoobjectisalreadywrappedwithaSecureddecorator.This*methodisonlyintendedtologasituationwhereaCatalogInfoobjectisbeingsecured,but*isalreadysecured.Repeatedcallstothiswillkeepaddingadditionalwrapperlayersandmay*eventuallycauseaStackOverflowError.Theloggeneratedismerelytoaidinfindingthereal*issue,asopposedtomaskingithere.**@paramobject{@linkCoverageStoreInfo}tocheck.*@returnTheoriginalobjecttobechecked.*/privateCoverageStoreInfologIfSecured(CoverageStoreInfoobject){CoverageStoreInfounwrapped=ModificationProxy.unwrap(object);
if(unwrappedinstanceofSecuredCoverageStoreInfo){logDoubleWrap(unwrapped,object);
iftheInfoobjectisalreadywrappedwithaSecureddecorator.This*methodisonlyintendedtologasituationwhereaCatalogInfoobjectisbeingsecured,but*isalreadysecured.Repeatedcallstothiswillkeepaddingadditionalwrapperlayersandmay*eventuallycauseaStackOverflowError.Theloggeneratedismerelytoaidinfindingthereal*issue,asopposedtomaskingithere.**@paramobject{@linkCoverageInfo}tocheck.*@returnTheoriginalobjecttobechecked.*/privateCoverageInfologIfSecured(CoverageInfoobject){CoverageInfounwrapped=ModificationProxy.unwrap(object);
if(unwrappedinstanceofSecuredDataStoreInfo){logDoubleWrap(unwrapped,object);
iftheInfoobjectisalreadywrappedwithaSecureddecorator.This*methodisonlyintendedtologasituationwhereaCatalogInfoobjectisbeingsecured,but*isalreadysecured.Repeatedcallstothiswillkeepaddingadditionalwrapperlayersandmay*eventuallycauseaStackOverflowError.Theloggeneratedismerelytoaidinfindingthereal*issue,asopposedtomaskingithere.**@paramobject{@linkDataStoreInfo}tocheck.*@returnTheoriginalobjecttobechecked.*/privateDataStoreInfologIfSecured(DataStoreInfoobject){DataStoreInfounwrapped=ModificationProxy.unwrap(object);
if(unwrappedinstanceofSecuredDataStoreInfo){logDoubleWrap(unwrapped,object);
if(createLayer){Stringschema=SqlUtil.schema(table.getTableName());StringdbName=schema==null?db.getName():(db.getName()+"_"+schema);finalDataStoreInfo_store=catalog.getStoreByName(ws,dbName,DataStoreInfo.class);finalFeatureTypeInfo_resource=catalog.getResourceByName(layerName,FeatureTypeInfo.class);createStore=_store==null;createResource=_resource==null;
if(createStore){store=catalogFac.createDataStore();store.setWorkspace(ws);store.setName(dbName);store.getConnectionParameters().put(JDBCDataStoreFactory.NAMESPACE.getName(),ns.getURI());store.getConnectionParameters().putAll(db.getParameters());
if(schema!=null){store.getConnectionParameters().put(JDBCDataStoreFactory.SCHEMA.getName(),schema);
else{store=unwrap(_store,DataStoreInfo.class);
if(createResource){builder.setStore(store);try{resource=builder.buildFeatureType(newNameImpl(SqlUtil.notQualified(table.getTableName())));builder.setupBounds(resource);
if(createStore){catalog.remove(store);
else{resource=unwrap(_resource,FeatureTypeInfo.class);
if(createStore){catalog.remove(store);
if(createResource){catalog.remove(resource);
else{layer=null;resource=null;store=null;createStore=false;createResource=false;
if(createLayer){ResourceInfoeditResource=catalog.getResource(resource.getId(),ResourceInfo.class);editResource.setAdvertised(true);catalog.save(editResource);
if(createLayer){catalog.remove(layer);
if(createResource){catalog.remove(resource);
if(createStore){catalog.remove(store);
if(catalog.getResourcesByStore(store,ResourceInfo.class).isEmpty()){catalog.remove(store);
if(oinstanceofWrapper){return((Wrapper)o).unwrap(clazz);
else{returno;
if(scope!=-1){value=context.getAttribute(name,scope);
else{value=NOT_FOUND;
if(start==this){synchronized(context){intscope=context.getAttributesScope(name);
if(scope==-1){scope=ScriptContext.ENGINE_SCOPE;
else{start.put(name,this,value);
if(scope!=-1){context.removeAttribute(name,scope);
if(bindings!=null){list.ensureCapacity(bindings.size());for(Stringkey:bindings.keySet()){list.add(key);
if(proto.equals(this)){has=true;break;
if(maximumSizeMB!=defaultMaxSizeMB){manager.setMaximumSizeMB(defaultMaxSizeMB);
if(formatinstanceofUnknownFormat){thrownewWPSException("CouldnotfindtheGeoTIFFGT2format,pleasecheckit'sintheclasspath");
if(encodingParameters!=null&&!encodingParameters.isEmpty()){for(StringencodingParam:encodingParameters.keySet()){
if(!SUPPORTED_PARAMS.contains(encodingParam)){
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("Thespecifiedparameterwillbeignored:"+encodingParam+"Supportedparametersareinthelist:"+SUPPORTED_PARAMS_LIST);
if(writeParams!=null){//InnerTilingSettings
if(encodingParameters.containsKey(TILE_WIDTH_KEY)&&encodingParameters.containsKey(TILE_HEIGHT_KEY)){StringtileWidth=(String)encodingParameters.get(TILE_WIDTH_KEY);StringtileHeight=(String)encodingParameters.get(TILE_HEIGHT_KEY);try{inttw=Integer.parseInt(tileWidth);intth=Integer.parseInt(tileHeight);writeParams.setTilingMode(ImageWriteParam.MODE_EXPLICIT);writeParams.setTiling(tw,th);
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Specifiedtilingparametersarenotvalid.tileWidth="+tileWidth+"tileHeight="+tileHeight);
if(encodingParameters.containsKey(COMPRESSION_KEY)){StringcompressionType=(String)encodingParameters.get(COMPRESSION_KEY);writeParams.setCompressionMode(ImageWriteParam.MODE_EXPLICIT);writeParams.setCompressionType(compressionType);
if(encodingParameters.containsKey(QUALITY_KEY)){StringcompressionQuality=(String)encodingParameters.get(QUALITY_KEY);try{writeParams.setCompressionQuality(Float.parseFloat(compressionQuality));
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Specifiedqualityisnotvalid(itshouldbeintherange[0,1])."+"compressionQuality="+compressionQuality);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofGMLInfo))returnfalse;finalGMLInfoother=(GMLInfo)obj;
if(srsNameStyle==null){
if(other.getSrsNameStyle()!=null)returnfalse;
else
if(!srsNameStyle.equals(other.getSrsNameStyle()))returnfalse;returntrue;
if(!(oinstanceofConfigEntry)){returnfalse;
if(o==this){returntrue;
if(restricted.equals(key)){returntrue;
ifthepasswordisnotvalid*/voidvalidatePassword(char[]password)throwsPasswordPolicyException;}
if(rawKvp.containsKey("distributedSearch")){
if("true".equalsIgnoreCase(ds)){DistributedSearchTypedst=Csw20Factory.eINSTANCE.createDistributedSearchType();
if(hopCount!=null){dst.setHopCount(hopCount);
else{dst.setHopCount(2);
if(typeNamesString==null){thrownewServiceException("MandatoryparametertypeNamesismissing",ServiceException.MISSING_PARAMETER_VALUE,"typeNames");
if(namespaces==null){//byspec,"NAMSPACE,Ifnotincluded,allqualifiednamesareindefaultnamespace"StringoutputSchema=(String)kvp.get("outputSchema");
if(outputSchema==null||descriptors.get(outputSchema)==null){outputSchema=CSW.NAMESPACE;
if(elementSet!=null){ElementSetNameTypeesn=Csw20Factory.eINSTANCE.createElementSetNameType();esn.setValue(elementSet);esn.setTypeNames(typeNames);query.setElementSetName(esn);
if(elementNamesString!=null){List<QName>elementNames=resolver.parseQNames(elementNamesString,namespaces);query.getElementName().addAll(elementNames);
if(kvp.get(CONSTRAINT)!=null){query.setConstraint(factory.createQueryConstraintType());Objectlanguage=kvp.get(CONSTRAINTLANGUAGE);Stringconstraint=(String)kvp.get(CONSTRAINT);
if(CQL_TEXT.equals(language)||language==null){Filterfilter=null;try{filter=CQL.toFilter(constraint);
else
if(FILTER.equals(language)){try{Parserparser=newParser(newOGCConfiguration());parser.setFailOnValidationError(true);parser.setValidating(true);parser.setEntityResolver(resolverProvider.getEntityResolver());parser.getNamespaces().declarePrefix("ogc",OGC.NAMESPACE);Filterfilter=(Filter)parser.parse(newStringReader(constraint));query.getConstraint().setFilter(filter);query.getConstraint().setVersion("1.1.0");
else{thrownewServiceException("Invalidconstraintlanguage:"+language+",validvaluesare"+CQL_TEXT+"and"+FILTER,ServiceException.INVALID_PARAMETER_VALUE,CONSTRAINTLANGUAGE);
ifwehavetosorttherequest
if(kvp.get("SORTBY")!=null){query.setSortBy((SortBy[])kvp.get("SORTBY"));
iftheObjectisnotencodeable.*/publicvoidencode(Objecto)throwsIllegalArgumentException{//try{
if(!(oinstanceofDescribeCoverageType)){thrownewIllegalArgumentException(newStringBuilder("NotaGetCapabilitiesType:").append(o).toString());
if(request.getCoverage()==null||request.getCoverage().size()==0){skipMisconfiguredThisTime=skipMisconfigured;coverages=catalog.getCoverages();
else{skipMisconfiguredThisTime=false;//NEVERskiplayerswhentheuserrequestedspecificonescoverages=newArrayList<CoverageInfo>();for(Iteratorit=request.getCoverage().iterator();it.hasNext();){StringcoverageId=(String)it.next();//checkthecoverageisknownLayerInfolayer=catalog.getLayerByName(coverageId);
if(layer==null||layer.getType()!=PublishedType.RASTER){thrownewWcsException("Couldnotfindthespecifiedcoverage:"+coverageId,WcsExceptionCode.InvalidParameterValue,"coverage");
if(skipMisconfiguredThisTime){reset();
else{thrownewRuntimeException("Unexpectederroroccurredduringdescribecoveragexmlencoding",e);
if((mdl.getAbout()!=null)&&(mdl.getAbout()!="")){attributes.addAttribute("","about","about","",mdl.getAbout());
if((mdl.getMetadataType()!=null)&&(mdl.getMetadataType()!="")){attributes.addAttribute("","metadataType","metadataType","",mdl.getMetadataType());
if((linkType!=null)&&(linkType!="")){attributes.addAttribute("","xlink:type","xlink:type","",linkType);
if((mdl.getContent()!=null)&&(mdl.getContent()!="")){attributes.addAttribute("","xlink:href","xlink:href","",ResponseUtils.proxifyMetadataLink(mdl,request.getBaseUrl()));
if(attributes.getLength()>0){element("wcs:metadataLink",null,attributes);
if(csinfo==null)thrownewWcsException("Unabletoacquirecoveragestoreresourceforcoverage:"+ci.getName());GridCoverage2DReaderreader=null;try{reader=(GridCoverage2DReader)ci.getGridCoverageReader(null,GeoTools.getDefaultHints());
if(reader==null)thrownewWcsException("Unabletoacquireareaderforthiscoveragewithformat:"+csinfo.getFormat().getName());
if(referencedEnvelope!=null){AttributesImplattributes=newAttributesImpl();attributes.addAttribute("","srsName","srsName","",/*"WGS84(DD)"*/"urn:ogc:def:crs:OGC:1.3:CRS84");start("wcs:lonLatEnvelope",attributes);finalStringminCP=referencedEnvelope.getMinX()+""+referencedEnvelope.getMinY();finalStringmaxCP=referencedEnvelope.getMaxX()+""+referencedEnvelope.getMaxY();element("gml:pos",minCP);element("gml:pos",maxCP);//arewegoingtoreporttime?DimensionInfotimeInfo=ci.getMetadata().get(ResourceInfo.TIME,DimensionInfo.class);
if(timeInfo!=null&&timeInfo.isEnabled()){ReaderDimensionsAccessordimensions=newReaderDimensionsAccessor(reader);SimpleDateFormatformat=dimensions.getTimeFormat();element("gml:timePosition",format.format(dimensions.getMinTime()));element("gml:timePosition",format.format(dimensions.getMaxTime()));
if(kwords!=null){for(Iteratorit=kwords.iterator();it.hasNext();){element("wcs:keyword",it.next().toString());
if(csinfo==null)thrownewWcsException("Unabletoacquirecoveragestoreresourceforcoverage:"+ci.getName());GridCoverage2DReaderreader=null;try{reader=(GridCoverage2DReader)ci.getGridCoverageReader(null,GeoTools.getDefaultHints());
if(reader==null){thrownewWcsException("Unabletoacquireareaderforthiscoveragewithformat:"+csinfo.getFormat().getName());
if(timeInfo!=null&&timeInfo.isEnabled()){handleTemporalDomain(ci,timeInfo,dimensions);
if(referencedEnvelope!=null){AttributesImplattributes=newAttributesImpl();attributes.addAttribute("","srsName","srsName","",srsName);finalStringminCP=referencedEnvelope.getMinX()+""+referencedEnvelope.getMinY();finalStringmaxCP=referencedEnvelope.getMaxX()+""+referencedEnvelope.getMaxY();StringminTime=null;StringmaxTime=null;
if(timeInfo!=null&&timeInfo.isEnabled()){SimpleDateFormattimeFormat=dimensions.getTimeFormat();minTime=timeFormat.format(dimensions.getMinTime());maxTime=timeFormat.format(dimensions.getMaxTime());
if(minTime!=null&&maxTime!=null){start("gml:EnvelopeWithTimePeriod",attributes);element("gml:pos",minCP);element("gml:pos",maxCP);element("gml:timePosition",minTime);element("gml:timePosition",maxTime);end("gml:EnvelopeWithTimePeriod");
else{start("gml:Envelope",attributes);element("gml:pos",minCP);element("gml:pos",maxCP);end("gml:Envelope");
if(timeInfo.getPresentation()==DimensionPresentation.LIST){for(Objectitem:dimensions.getTimeDomain()){
if(iteminstanceofDate){element("gml:timePosition",timeFormat.format((Date)item));
else{DateRangerange=(DateRange)item;start("wcs:timePeriod");StringminTime=timeFormat.format(range.getMinValue());StringmaxTime=timeFormat.format(range.getMaxValue());element("wcs:beginPosition",minTime);element("wcs:endPosition",maxTime);end("wcs:timePeriod");
else{StringminTime=timeFormat.format(dimensions.getMinTime());StringmaxTime=timeFormat.format(dimensions.getMaxTime());start("wcs:timePeriod");element("wcs:beginPosition",minTime);element("wcs:endPosition",maxTime);
if(timeInfo.getPresentation()==DimensionPresentation.DISCRETE_INTERVAL){BigDecimalresolution=timeInfo.getResolution();
if(resolution==null){resolution=newBigDecimal(dimensions.getMaxTime().getTime()-dimensions.getMinTime().getTime());
if(gridToCRS.getSourceDimensions()>r){lowers+=(gridRange.getLow(r)+"");uppers+=(gridRange.getHigh(r)+"");
else{lowers+=(0+"");uppers+=(0+"");
if(numSampleDimensions>1){start("wcs:interval");element("wcs:min","1");element("wcs:max",String.valueOf(numSampleDimensions));end("wcs:interval");
else{element("wcs:singleValue","1");
if(elevationInfo!=null&&elevationInfo.isEnabled()){GridCoverage2DReaderreader=null;try{reader=(GridCoverage2DReader)ci.getGridCoverageReader(null,GeoTools.getDefaultHints());
if(reader==null){thrownewWcsException("Unabletoacquireareaderforthiscoveragewithformat:"+ci.getStore().getFormat().getName());
if(dimensions.hasElevation()){//wecanonlyreportvaluesoneatatimehere,thereisnointervalconceptstart("wcs:axisDescription");start("wcs:AxisDescription");element("wcs:name","ELEVATION");element("wcs:label","ELEVATION");start("wcs:values");TreeSet<Object>rawElevations=dimensions.getElevationDomain();//wecannotexposeranges,so
ifwefindthem,weturntheminto//theirmidpointTreeSet<Double>elevations=newTreeSet<Double>();for(Objectraw:rawElevations){
if(rawinstanceofDouble){elevations.add((Double)raw);
else{NumberRange<Double>range=(NumberRange<Double>)raw;doublemidValue=(range.getMinimum()+range.getMaximum())/2;elevations.add(midValue);
if(ci.getRequestSRS()!=null)supportedCRSs.addAll(ci.getRequestSRS());
if(ci.getResponseSRS()!=null)supportedCRSs.addAll(ci.getResponseSRS());start("wcs:supportedCRSs");for(Iteratorit=supportedCRSs.iterator();it.hasNext();){StringcrsName=(String)it.next();CoordinateReferenceSystemcrs=CRS.decode(crsName,true);//element("requestResponseCRSs",urnIdentifier(crs));element("wcs:requestResponseCRSs",CRS.lookupIdentifier(crs,false));
if(ci.getDefaultInterpolationMethod()!=null){finalAttributesImplattributes=newAttributesImpl();attributes.addAttribute("","default","default","",ci.getDefaultInterpolationMethod());start("wcs:supportedInterpolations",attributes);
else{start("wcs:supportedInterpolations");
if(/*converted*/method!=null)element("wcs:interpolationMethod",/*converted*/method);
if("gml".equals(geometryEncoding)){tx.setGeometryEncoding(GeoRSSTransformerBase.GeometryEncoding.GML);
else
if("latlong".equals(geometryEncoding)){tx.setGeometryEncoding(GeoRSSTransformerBase.GeometryEncoding.LATLONG);
else{tx.setGeometryEncoding(GeoRSSTransformerBase.GeometryEncoding.SIMPLE);
if(store!=null){JDBCRoleStorejdbcStore=(JDBCRoleStore)store;JDBCTestSupport.dropExistingTables(jdbcStore,jdbcStore.getConnection());store.store();
if("h2".equalsIgnoreCase(getFixtureId()))returnsuper.createTestData();returnnewLiveDbmsDataSecurity(getFixtureId());
if(r.getNativeBoundingBox()!=null){r.setNativeBoundingBox(r.getNativeBoundingBox().transform(target,true));
if(transform==null){//computethereprojectiontransformCoordinateReferenceSystemsource=this.source;
if(source==null){//trytodeterminesourcecrsfromdatasource=oldFeature.getType().getCoordinateReferenceSystem();
if(source==null){thrownewIllegalStateException("Unabletodeterminesourceprojection");
if(g!=null){feature.setDefaultGeometry(JTS.transform(g,transform));
if(uid==null){thrownewOWS20Exception("Missingmandatoryuidparameter",OWS20Exception.OWSExceptionCode.MissingParameterValue,"uid");
ifrequired
if(parentIdRequired&&apr.getParentId()==null){thrownewOWS20Exception("MissingmandatoryparentIdparameter",OWS20Exception.OWSExceptionCode.MissingParameterValue,"parentId");
ifthecontentlengthis*unknown.**@author"AlessioFabiani-alessio.fabiani@geo-solutions.it"*/abstractclassLimitedOutputStreamextendsFilterOutputStream{/**Themaximumsizeofanitem,inbytes.*/privatelongsizeMax;/**Thecurrentnumberofbytes.*/privatelongcount;/**Whetherthisstreamisalreadyclosed.*/privatebooleanclosed;/***Createsanewinstance.**@parampOutTheinputstream,whichshallbelimited.*@parampSizeMaxThelimit;nomorethanthisnumberofbytesshallbereturnedbythesource*stream.*/publicLimitedOutputStream(OutputStreampOut,longpSizeMax){super(pOut);sizeMax=pSizeMax;
if(count>sizeMax){raiseError(sizeMax,count);
ifanI/Oerroroccurs.*@seejava.io.FilterInputStream#in*/publicvoidwrite(intb)throwsIOException{out.write(b);count++;checkLimit();
ifanI/Oerroroccurs.*@seejava.io.FilterInputStream#in*/publicvoidwrite(byte[]b,intoff,intlen)throwsIOException{out.write(b,off,len);
if(len>0){count+=len;checkLimit();
ifthestreamisclosed,otherwisefalse.*@throwsIOExceptionAnI/Oerroroccurred.*/publicbooleanisClosed()throwsIOException{returnclosed;
ifanI/Oerroroccurs.*@seejava.io.FilterInputStream#in*/publicvoidclose()throwsIOException{closed=true;super.close();}}
if(delegate!=null){returndelegate.getId();
ifthis{@linkJobExecution}indicatesthatitisrunning.Itshouldbenotedthatthis*doesnotnecessarilymeanthatithasbeenpersistedassuchyet.**@returntrue
iftheendtimeisnull*/publicbooleanisRunning(){returndelegate.isRunning();
ifthis{@linkJobExecution}indicatesthatithasbeensignalledtostop.**@returntrue
ifthestatusis{@linkBatchStatus#STOPPING}*/publicbooleanisStopping(){returndelegate.isStopping();
if(sql.startsWith("CALL")){StringformattedSP="{"+sql+"}";this.run(formattedSP);continue;
ifanypropertyisnull?Weassumenull<(notnull)
if(p1==null)returnp2!=null?-1:0;
else
if(p2==null)return1;returnnewStringBuffer(p1.toString()).reverse().toString().compareTo(newStringBuffer(p2.toString()).reverse().toString());
if(batch.getId()!=null){
if(batch.getLatestBatchRun()!=null){returnbatch.getLatestBatchRun().getStart();
if(batch.getId()!=null){
if(batch.getLatestBatchRun()!=null){returnbatch.getLatestBatchRun().getStatus();
if(configurationModel==null){list=TaskManagerBeans.get().getDao().getViewableBatches();
else{
if(configurationModel.getObject().getId()!=null){TaskManagerBeans.get().getDao().loadLatestBatchRuns(configurationModel.getObject());
ifappropriate.**@parampathResourcepathusedaslockkey*/publicResource.Lockacquire(Stringpath);}
if(objectinstanceofQuery){monitor.query((Query)object,visitor);
else{List<RequestData>requests;
if(objectinstanceofList){requests=(List<RequestData>)object;
else{requests=Collections.singletonList((RequestData)object);
if(options.containsKey("opacity")){try{opacity=Float.valueOf(options.get("opacity"))/100f;opacity=Math.max(Math.min(opacity,1f),0f);
if(logo!=null){CompositeoldComposite=g2D.getComposite();g2D.setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_OVER,opacity));AffineTransformtx=AffineTransform.getTranslateInstance(paintArea.getX(),paintArea.getY());tx.scale(paintArea.getWidth()/logo.getWidth(),paintArea.getHeight()/logo.getHeight());g2D.drawImage(logo,tx,null);g2D.setComposite(oldComposite);
if(url.getProtocol()==null||url.getProtocol().equals("file")){Filefile=loader.url(imageURL);
if(file.exists()){url=URLs.fileToUrl(file);
ifwecanfinditinthelayoutsdirectoryResourcelayouts=loader.get("layouts");
if(layouts.getType()==Resource.Type.DIRECTORY){Resourceimage=layouts.get(imageURL);
if(image.getType()==Resource.Type.RESOURCE){url=URLs.fileToUrl(image.file());
if(url==null){//alsocheckfromtherootofthedatadir(backwardscompatibility)Resourceimage=loader.get(imageURL);
if(image.getType()==Resource.Type.RESOURCE){url=URLs.fileToUrl(image.file());
if(url==null){returnnull;
if(entry==null||entry.isExpired()){logo=ImageIO.read(url);
if(url.getProtocol().equals("file")){entry=newLogoCacheEntry(logo,newFile(url.getFile()));logoCache.put(url,entry);
else{logo=entry.getLogo();
if(DEBUG){finalFiletempDir=newFile(GeoServerExtensions.getProperty("user.home"),".geoserver");
if(!tempDir.exists()){
if(!tempDir.mkdir())LOGGER.severe("Unabletocreatedebugdir,exitingapplication!!!");DEBUG=false;DEBUG_DIR=null;
else{DEBUG_DIR=tempDir.getAbsolutePath();LOGGER.fine("MetatileMapOutputFormatdebugdir"+DEBUG_DIR);
ifthepaletteInverterisnotprovided,ora*indexedimageotherwise.Subclassesmayoverridethismethodshouldtheyneedaspecialkind*ofimage**@paramwidththewidthoftheimagetocreate.*@paramheighttheheightoftheimagetocreate.*@parampaletteInverteran{@linkIndexColorModel}
iftheimageistobeindexed,or<code>*null</code>otherwise.*@returnanimageofsize<code>widthxheight</code>appropriateforthegivencolormodel,*
ifany,andtobeusedasatransparentimageornotdependingonthe<code>transparent*</code>parameter.*/publicstaticBufferedImagecreateImage(finalintwidth,intheight,finalIndexColorModelpalette,finalbooleantransparent){//WARNING:wheneverthismethodischanged,changegetDrawingSurfaceMemoryUse//accordingly
if(palette!=null){//unfortunatelywecan'tusepackedrastersbecauselinerendering//getscompletely//broken,seeGEOS-1312(https://osgeo-org.atlassian.net/browse/GEOS-1312)//finalWritableRasterraster=//palette.createCompatibleWritableRaster(width,height);finalWritableRasterraster=Raster.createInterleavedRaster(palette.getTransferType(),width,height,1,null);returnnewBufferedImage(palette,raster,false,null);
if(transparent){returnnewBufferedImage(width,height,BufferedImage.TYPE_4BYTE_ABGR);
if(height==0){height=1;
iftheimageisnottransparent(loadtestingshowsthis//imagesetupisthefastesttodrawandencodeonreturnnewBufferedImage(width,height,BufferedImage.TYPE_3BYTE_BGR);
if(palette!=null){returnmemory;
if(transparent){returnmemory*4;
ifitsnottransparent.*@parampreparedImagetheimageforwhichtocreatethegraphics.*@paramextraHintsanoptionalmapofextrarenderinghintstoapplytothe{@link*Graphics2D},otherthan{@linkRenderingHints#KEY_ANTIALIASING}.*@returna{@linkGraphics2D}for<code>preparedImage</code>withtransparentbackground
if*<code>transparent==true</code>orwiththebackgroundpaintedwith<code>bgColor</code>*otherwise.*/publicstaticGraphics2DprepareTransparency(finalbooleantransparent,finalColorbgColor,finalRenderedImagepreparedImage,finalMap<RenderingHints.Key,Object>extraHints){finalGraphics2Dgraphic;
if(preparedImageinstanceofBufferedImage){graphic=((BufferedImage)preparedImage).createGraphics();
else
if(preparedImageinstanceofTiledImage){graphic=((TiledImage)preparedImage).createGraphics();
else
if(preparedImageinstanceofVolatileImage){graphic=((VolatileImage)preparedImage).createGraphics();
else{thrownewServiceException("Unrecognizedback-endimagetype");
if(extraHints==null){hintsMap=newHashMap<RenderingHints.Key,Object>();
else{hintsMap=newHashMap<RenderingHints.Key,Object>(extraHints);
if(transparent){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("settingtotransparent");
else{graphic.setColor(bgColor);graphic.fillRect(0,0,preparedImage.getWidth(),preparedImage.getHeight());
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("MethodforceIndexed8Bitmaskcalled");LOGGER.finer("invColorMapisnull?"+(invColorMap==null));//checkimagetypeStringtype="RI";
if(originalImageinstanceofPlanarImage){type="PI";
else
if(originalImageinstanceofBufferedImage){type="BI";
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("OriginalImagetype"+type);LOGGER.finer("OriginalImageinfo:"+originalImage.toString());
ifitisbitmaskornot./////////////////////////////////////////////////////////////////////
if((cminstanceofIndexColorModel)&&dataTypeByte){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("ImagehasIndexColorModelandtypebyte!");
if(icm.getTransparency()!=Transparency.TRANSLUCENT){////////Theimageisindexedon8bitsandthecolormodeliseither//opaqueorbitmask.WEdonothavetodoanything.//////image=originalImage;
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("ImagehasTransparency!=TRANSLUCENT,donothing");
else{
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("ImagehasTransparencyTRANSLUCENT,forceBitmaskIndexColorModel");
if(DEBUG){writeRenderedImage(image,"indexed8translucent");
else{
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Imagehasgenericcolormodeland/ortype");
if(invColorMap!=null){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("WehaveaninvColorMap");
if(DEBUG){writeRenderedImage(image,"invColorMap");
else{
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("WedonothaveaninvColorMap");
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Makingsurewestartfromacomponentcolormodel");
if(DEBUG){writeRenderedImage(image,"forceComponentColorModel");
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("CustomPaletteBuilder[subsx="+subsx+",subsy="+subsy+"]");LOGGER.finer("InputImageis:"+image.toString());
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("ComputedPalette:"+paletteRepresentation(cpb.getIndexColorModel()));
if(DEBUG){writeRenderedImage(image,"buildPalette");
if(DEBUG_DIR==null)thrownewNullPointerException("Unabletowritetheprovidedcoverageinthedebugdirectory");
if(DEBUG==false)thrownewIllegalStateException("Unabletowritetheprovidedcoveragesincewearenotindebugmode");try{ImageIO.write(raster,"tiff",newFile(DEBUG_DIR,fileName+".tiff"));
if(inputinstanceofString){returndecode(newByteArrayInputStream(((String)input).getBytes()));
if(resolver==null){returnunmarshaller.unmarshal(input);
else{//setuptheentityresolverfinalSAXParserFactorysaxParserFactory=SAXParserFactory.newInstance();saxParserFactory.setNamespaceAware(true);finalXMLReaderreader=saxParserFactory.newSAXParser().getXMLReader();reader.setEntityResolver(resolver);finalSAXSourcesaxSource=newSAXSource(reader,newInputSource(input));returnunmarshaller.unmarshal(saxSource);
if((key!=null)&&keyinstanceofString){return((String)key).toUpperCase();
if(otherinstanceofCaseInsensitiveMap){returnother;
if(dtdLocation!=null){sb.append("standalone=\"no\"");
if(dtdLocation!=null){StringfullDtdLocation=buildSchemaURL(baseURL(request.getHttpRequest()),dtdLocation);sb.append("<!DOCTYPEServiceExceptionReportSYSTEM\""+fullDtdLocation+"\">");
if((schemaLocation!=null)&&(dtdLocation==null)){StringfullSchemaLocation=buildSchemaURL(baseURL(request.getHttpRequest()),schemaLocation);sb.append("xmlns=\"http://www.opengis.net/ogc\"");sb.append("xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"");sb.append("xsi:schemaLocation=\"http://www.opengis.net/ogc"+fullSchemaLocation+"\"");
if((exception.getCode()!=null)&&!exception.getCode().equals("")){sb.append("code=\""+ResponseUtils.encodeXML(exception.getCode())+"\"");
if((exception.getLocator()!=null)&&!exception.getLocator().equals("")){sb.append("locator=\""+ResponseUtils.encodeXML(exception.getLocator())+"\"");
if((exception.getMessage()!=null)){sb.append("\n"+tab+tab);OwsUtils.dumpExceptionMessages(exception,sb,true);
if(geoServer.getSettings().isVerboseExceptions()){ByteArrayOutputStreamstackTrace=newByteArrayOutputStream();exception.printStackTrace(newPrintStream(stackTrace));sb.append("\nDetails:\n");sb.append(ResponseUtils.encodeXML(newString(stackTrace.toByteArray())));
if(forwardedFor!=null){req.addHeader("X-Forwarded-For",forwardedFor);
if(aggregatedBounds!=null){LookAtla=lookAtFactory.buildLookAt(aggregatedBounds,lookAtOptions,false);container.setAbstractView(la);
if(layerInfo.getDescription()!=null&&layerInfo.getDescription().length()>0){nl.setDescription(layerInfo.getDescription());
if(formatOptions.get(VISIBLE_KEY)!=null){booleanvisible=Boolean.parseBoolean(formatOptions.get(VISIBLE_KEY).toString());nl.setVisibility(visible);
else{nl.setVisibility(true);
if(requestBox!=null){LookAtla=lookAtFactory.buildLookAt(requestBox,lookAtOptions,false);nl.setAbstractView(la);
if(formatOptions.get(REFRESH_KEY)!=null){StringrefreshValue=formatOptions.get(REFRESH_KEY).toString();
if(refreshValue.equalsIgnoreCase("expires")){url.setRefreshMode(RefreshMode.ON_EXPIRE);
else{intinterval=Integer.parseInt(refreshValue);url.setRefreshInterval(interval);url.setRefreshMode(RefreshMode.ON_INTERVAL);
ifnotfound*/publicstaticAccessModegetByAlias(Stringalias){for(AccessModemode:AccessMode.values()){
if(mode.alias.equals(alias))returnmode;
if(encoding!=null){cfg.setDefaultEncoding(encoding);
if(templateName!=null){template=tryLoadTemplate(configuration,templateName);
if(template==null)template=tryLoadTemplate(configuration,templateName+".ftl");
if(template==null&&requestInfo!=null){//couldnotfindatemplateboundtotheclassdirectly,searchbytheresource//beingrequestedStringpagePath=requestInfo.getPagePath();Stringr=pagePath.substring(pagePath.lastIndexOf('/')+1);//trimtrailingslash
if(r.equals("")){pagePath=pagePath.substring(0,pagePath.length()-1);r=pagePath.substring(pagePath.lastIndexOf('/')+1);
if(i!=-1){r=r.substring(0,i);
if(template==null){template=tryLoadTemplate(configuration,clazz.getSimpleName().toLowerCase()+".ftl");
if(template==null){for(Class<?>interfaze:clazz.getInterfaces()){template=tryLoadTemplate(configuration,interfaze.getSimpleName()+".ftl");
if(template!=null)break;
if(clazz.getSuperclass()==Object.class){break;
if(template!=null){templateName=template.getName();
else{//useafallbacktemplateName="Object.ftl";
ifit'snotfound.Ifthetemplateexistsbutit*containssyntaxerrorsanexceptionwillbethrowninstead**@paramconfigurationThetemplateconfiguration.*@paramtemplateNameThenameofthetemplatetoload.*/protectedTemplatetryLoadTemplate(Configurationconfiguration,StringtemplateName){try{returnconfiguration.getTemplate(templateName);
iftheobjectisnull.*@paramquietOnNotFoundThevalueofthequietOnNotFoundparameter*@return*///TODO:Removethisonceallreferenceshavebeenremoved(shouldjustuse//ResourceNotFoundExceptions)protected<T>RestWrapper<T>wrapObject(Tobject,Class<T>clazz,StringerrorMessage,BooleanquietOnNotFound){errorMessage=quietOnNotFound!=null&&quietOnNotFound?"":errorMessage;
if(object==null){thrownewRestException(errorMessage,HttpStatus.NOT_FOUND);
if(!(inputMessageinstanceofRestHttpInputWrapper)){returnnewRestHttpInputWrapper(inputMessage,this);
switchandpagesubmitworkflowfunctionproperly**@authorNielsCharlier*/publicclassPublishedConfigurationPanel<TextendsPublishedInfo>extendsPanel{privatestaticfinallongserialVersionUID=4881474189619124359L;publicPublishedConfigurationPanel(Stringid,IModel<?extendsT>model){super(id,model);
if(configinstanceofCasAuthenticationFilterConfig){validateCASFilterConfig((CasAuthenticationFilterConfig)config);
else{super.validateFilterConfig(config);
if(StringUtils.hasLength(casConfig.getUrlInCasLogoutPage())){try{newURL(casConfig.getUrlInCasLogoutPage());
if(StringUtils.hasLength(casConfig.getCasServerUrlPrefix())==false)throwcreateFilterException(CasFilterConfigException.CAS_SERVER_URL_REQUIRED);try{newURL(casConfig.getCasServerUrlPrefix());
if(StringUtils.hasLength(casConfig.getProxyCallbackUrlPrefix())){URLcallBackUrl=null;try{callBackUrl=newURL(casConfig.getProxyCallbackUrlPrefix());
if("https".equalsIgnoreCase(callBackUrl.getProtocol())==false)throwcreateFilterException(CasFilterConfigException.CAS_PROXYCALLBACK_NOT_HTTPS);
if(store==null){thrownewRuntimeException("AttemptedtocreateaJDBCStatusStorewithanulldatastore");
if(storeSchema==null){LOGGER.fine("creatingnewDBtableforstatuses");statuses.createSchema(schema);storeSchema=lookupStatusSchema();
if(!actual.getTypeName().equals(expected.getTypeName())){mappingRequired=true;
if(!expectedName.equals(actualName)){mappingRequired=true;
if(!expectedType.isAssignableFrom(actualDescriptor.getType().getBinding())){mappingRequired=true;
if(mappingRequired){returndefinitions;
else{returnnull;
if(typeName.equalsIgnoreCase(STATUS)){returnstatuses.getSchema(typeName);
if(mappingDefinitions!=null){source=TransformFactory.transform(source,newNameImpl(STATUS),mappingDefinitions);
ifthefeatureexistsdeleteitFilterfilter=ECQL.toFilter(PROCESS_ID+"='"+status.getExecutionId()+"'");store.removeFeatures(filter);store.addFeatures(featureCollection);transaction.commit();committed=true;
if(!committed){try{transaction.rollback();
if(ret==0){returnret;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("adding"+f);
if(request!=null){builder.set(REQUEST,serializeRequest(request));
if(exception!=null){builder.set(EXCEPTION_CLASS,exception.getClass().getName());builder.set(EXCEPTION_MESSAGE,exception.getMessage());StackTraceElement[]stackTrace=exception.getStackTrace();StringBufferbuf=newStringBuffer();for(StackTraceElementel:stackTrace){buf.append(el.getClassName()).append(STACKTRACESEPERATOR);buf.append(el.getFileName()).append(STACKTRACESEPERATOR);buf.append(el.getMethodName()).append(STACKTRACESEPERATOR);buf.append(el.getLineNumber());buf.append("\n");
if(f==null){returnnull;
if(p.getValue()!=null){attrs.put(p.getName().toString(),p.getValue());
if(attrs.containsKey(REQUEST)){ExecuteTyperequest=buildRequest(attrs);status.setRequest(request);
if(attrs.containsKey(EXCEPTION_MESSAGE)){status.setException(buildException(attrs,status));
if(attrs.containsKey(COMPLETION)){status.setCompletionTime((Date)attrs.get(COMPLETION));
if(attrs.containsKey(LASTUPDATE)){status.setLastUpdated((Date)attrs.get(LASTUPDATE));
ifwecanrebuildtheexceptiontry{Constructor<?>con=this.getClass().getClassLoader().loadClass((String)attrs.get(EXCEPTION_CLASS)).getConstructor(String.class);exc=(Exception)con.newInstance(message);
if(hasUserGroupStore(userGroupServiceName)==false){thrownewIllegalStateException("Newusernotpossibleforreadonlyservice");
if(hasRoleStore(getSecurityManager().getActiveRoleService().getName())){gaStore=getRoleStore(getSecurityManager().getActiveRoleService().getName());gaStore=newRoleStoreValidationWrapper(gaStore);for(GeoServerRolerole:rolePalette.getSelectedRoles()){gaStore.associateRoleToUser(role,user.getUsername());
if(pfinstanceofVectorProcessFactory||(pfinstanceofDelegatingProcessFactory&&((DelegatingProcessFactory)pf).getInnermostDelegate()instanceofVectorProcessFactory)){returnnull;
if(pfinstanceofDeprecatedProcessFactory){//stripoutallthe"gs"processesSet<Name>disabled=newHashSet();for(Namen:pf.getNames()){
if("gs".equals(n.getNamespaceURI())){disabled.add(n);
if(onlineTestId!=null){//
iftest
ifrunninginonlinemode,needtousedbparamsonlineTestId=onlineTestId.trim().toLowerCase();Map<String,File>propertyFiles=newHashMap<String,File>();propertyFiles.put(propertiesFile.getName(),dir);AbstractReferenceDataSetupsetup;
if(onlineTestId.equals("oracle")){//oraclemapping=mapping.replaceAll(DS_PARAMETERS,Matcher.quoteReplacement(AppSchemaTestOracleSetup.DB_PARAMS));setup=AppSchemaTestOracleSetup.getInstance(propertyFiles);
else{//postgismapping=mapping.replaceAll(DS_PARAMETERS,Matcher.quoteReplacement(AppSchemaTestPostgisSetup.DB_PARAMS));setup=AppSchemaTestPostgisSetup.getInstance(propertyFiles);
if(eventinstanceofCatalogModifyEvent)returntrue;
elsereturnfalse;
ifInMemorycachingisenabledfinalCacheConfigContainerWrappercacheConfigContainer=newCacheConfigContainerWrapper("cacheConfContainer",gwcConfigModel.getObject().getCacheProviderClass(),gwcConfigModel);cacheConfigContainer.setOutputMarkupId(true);//AvoidPersistencecheckboxIModel<Boolean>persistenceEnabled=newPropertyModel<Boolean>(gwcConfigModel,"persistenceEnabled");finalCheckBoxpersistenceEnabledChoice=newCheckBox("persistenceEnabled",persistenceEnabled);booleanvisible=innerCachingEnabledChoice.getModelObject()==null?false:innerCachingEnabledChoice.getModelObject();container.setVisible(visible);//ChoicebetweenthevariousCacheobjectsfinalDropDownChoice<String>choice;finalConfigurableBlobStorestore=GeoServerExtensions.bean(ConfigurableBlobStore.class);
if(store!=null){finalMap<String,String>cacheProviders=store.getCacheProvidersNames();finalIModel<String>providerClass=newPropertyModel<String>(gwcConfigModel,"cacheProviderClass");ChoiceRenderer<String>renderer=newCacheProviderRenderer(cacheProviders);choice=newDropDownChoice<String>("caches",providerClass,newArrayList<String>(cacheProviders.keySet()),renderer);choice.add(newAjaxFormComponentUpdatingBehavior("change"){@OverrideprotectedvoidonUpdate(AjaxRequestTargettarget){ConfigurableBlobStorestore=GeoServerExtensions.bean(ConfigurableBlobStore.class);StringcacheClass=providerClass.getObject();booleanimmutable=false;
if(store!=null){immutable=store.getCacheProviders().get(cacheClass).isImmutable();
if(!immutable){
if(!gwcConfigModel.getObject().getCacheConfigurations().containsKey(cacheClass)){gwcConfigModel.getObject().getCacheConfigurations().put(cacheClass,newCacheConfiguration());
else{choice=newDropDownChoice<String>("caches",newArrayList<String>());
if(store!=null){store.clearCache();
if(store!=null){CacheStatisticsstats=store.getCacheStatistics();longhitCount=stats.getHitCount();longmissCount=stats.getMissCount();longtotal=stats.getRequestCount();doublehitRate=stats.getHitRate();doublemissRate=stats.getMissRate();longevicted=stats.getEvictionCount();doublecurrentMem=stats.getCurrentMemoryOccupation();longbyteToMb=1024*1024;doubleactualSize=((long)(100*(stats.getActualSize()*1.0d)/byteToMb))/100d;doubletotalSize=((long)(100*(stats.getTotalSize()*1.0d)/byteToMb))/100d;//Ifaparameterisnotcorrect,Unavailableisusedvalues.put(KEY_MISS_RATE,missRate>=0?missRate+"%":"Unavailable");values.put(KEY_HIT_RATE,hitRate>=0?hitRate+"%":"Unavailable");values.put(KEY_EVICTED,evicted>=0?evicted+"":"Unavailable");values.put(KEY_TOTAL_COUNT,total>=0?total+"":"Unavailable");values.put(KEY_MISS_COUNT,missCount>=0?missCount+"":"Unavailable");values.put(KEY_HIT_COUNT,hitCount>=0?hitCount+"":"Unavailable");values.put(KEY_CURRENT_MEM,currentMem>=0?currentMem+"%":"Unavailable");values.put(KEY_SIZE,currentMem>=0&&actualSize>=0?actualSize+"/"+totalSize+"Mb":"Unavailable");
ifthevalueisnull,orlessorequalto0**@authorNicolaLagomarsiniGeosolutions*/staticclassMinimumLongValidatorimplementsIValidator<Long>{privateStringerrorKey;publicMinimumLongValidator(Stringerror){this.errorKey=error;
if(iv==null||iv.getValue()<=0){ValidationErrorerror=newValidationError();error.setMessage(newParamResourceModel(errorKey,null,"").getObject());iv.error(error);
iftheconcurrencyLevelisnull,orlessthan*orequalto0**@authorNicolaLagomarsiniGeosolutions*/staticclassMinimumConcurrencyValidatorimplementsIValidator<Integer>{@Overridepublicvoidvalidate(IValidatable<Integer>iv){
if(iv==null||iv.getValue()<=0){ValidationErrorerror=newValidationError();error.setMessage(newParamResourceModel("BlobStorePanel.invalidConcurrency",null,"").getObject());iv.error(error);
if(store!=null){//weusethecurrentcacheacceptedevictionpoliciesCacheProvidercache=store.getCacheProviders().get(key);evictionPolicies=cache.getSupportedPolicies();
if*itisnotavailable.*/privatestaticSetsupportedFormats;/***ReturnsthesetofsupportedformatsbytheavailableJAIlibrary,ortheemptyset
ifnot*available.**@returnSet&lt;String&gt;oftheMIMEtypestheavailableJAIlibrarysupports,ortheempty*set
ifitisnotavailable.*/publicstaticSetgetSupportedFormats(){
if(supportedFormats==null){String[]mimeTypes=null;try{mimeTypes=ImageIO.getWriterMIMETypes();
ifJAIisnotpresent,sopleasedonot//delete,orwegetreallynastymessagesongetCapsforwms.
if(mimeTypes==null){LOGGER.info("Jainotfound?Shouldbealwaysthere");supportedFormats=Collections.EMPTY_SET;
else{supportedFormats=newHashSet();ListformatsList=Arrays.asList(mimeTypes);for(Iteratorit=formatsList.iterator();it.hasNext();){StringcurFormat=it.next().toString();
if(!curFormat.equals("")){//DJB:checktosee
iftheJAIformathasbeentestedtowork!
if(testedFormats.contains(curFormat)){supportedFormats.add(curFormat);
if(LOGGER.isLoggable(Level.CONFIG)){StringBuffersb=newStringBuffer("SupportedJAIMapResponse'sMIMETypes:[");for(Iteratorit=supportedFormats.iterator();it.hasNext();){sb.append(it.next());
if(it.hasNext()){sb.append(",");
ifJAIisavailable*@see#getSupportedFormats()*/publicstaticbooleanisJaiAvailable(){returngetSupportedFormats().size()>0;
iftheimagewritingto<code>outStream</code>fails.*@throwsIllegalArgumentException
if<code>format</code>isnotasupportedoutputformatfor*theinstalledJAIlibrary.*/publicstaticvoidencode(Stringformat,BufferedImageimage,OutputStreamoutStream)throwsIOException{
if(format.equalsIgnoreCase("jpeg")){format="image/jpeg";
if(!it.hasNext()){thrownewIllegalArgumentException("Formatnotsupported:"+format);
if(format.equalsIgnoreCase("image/jpeg")){param.setCompressionMode(ImageWriteParam.MODE_EXPLICIT);param.setCompressionQuality(0.9f);//DJB:onlydothisforjpegs-pngfreakswhenyoudothis!meta=writer.getDefaultStreamMetadata(param);//WritableRasterraster=image.getRaster();//WritableRasternewRaster=raster.createWritableChild(0,0,//image.getWidth(),image.getHeight(),0,0,newint[]{0,1,2});//createaColorModelthatrepresentstheoneoftheARGBexceptthealpha//channel://DirectColorModelcm=(DirectColorModel)image.getColorModel();//DirectColorModelnewCM=newDirectColorModel(cm.getPixelSize(),//cm.getRedMask(),cm.getGreenMask(),cm.getBlueMask());//nowcreatethenewbufferthatisusedotwritetheimage://BufferedImagergbBuffer=newBufferedImage(newCM,newRaster,false,null);BufferedImagecurImage=newBufferedImage(image.getWidth(),image.getHeight(),BufferedImage.TYPE_3BYTE_BGR);Graphics2Dg=(Graphics2D)curImage.createGraphics();g.drawImage(image,0,0,null);image=curImage;ioutstream=ImageIOExt.createImageOutputStream(image,outStream);writer.setOutput(ioutstream);writer.write(image);ioutstream.close();writer.dispose();return;
if(wait){while(getCommandQueue(id).size()>0){Thread.sleep(10);
if(queue==null){queue=newLinkedBlockingQueue<MonkeyProcess.Command>();commands.put(id,queue);
if(wait){while(getCommandQueue(id).size()>0){Thread.sleep(10);
if(wait){while(getCommandQueue(id).size()>0){Thread.sleep(10);
if(command.type==CommandType.Exit){listener.progress(100f);listener.complete();commands.remove(id);return(SimpleFeatureCollection)command.value;
else
if(command.type==CommandType.SetProgress){floatprogress=((Number)command.value).floatValue();listener.progress(progress);listener.setTask(newSimpleInternationalString("Currentlyat"+progress));
else
if(command.type==CommandType.Wait){longwait=((Number)command.value).longValue();Thread.sleep(wait);
else{ProcessExceptionexception=(ProcessException)command.value;listener.exceptionOccurred(exception);throwexception;
if(entry.getValue().size()>0){thrownewIllegalStateException("Thecommandqueueisnotclean,queue"+entry.getKey()+"stillhascommandsin:"+entry.getValue());
if(watcher.isStale()){try{config=(ClusterConfig)watcher.read();
ifthequerywasaGetFeatureByIdthenwehavetowriteoutasingle//feature//withoutthefeaturecollectionwrapper
if(results.isGetFeatureById()){List<FeatureCollection>features=results.getFeatures();Featurenext=DataUtilities.first(features.get(0));
if(next==null){thrownewWFSException((EObject)null,"Nofeaturematchingtherequestedidfound",WFSException.NOT_FOUND);
else{encoder.encode(next,GML.AbstractFeature,output);
else{encoder.encode(results.unadapt(FeatureCollectionType.class),WFS.FeatureCollection,output);
if(gml!=null){gml.setNumDecimals(numDecimals);
if(workspaceName!=null&&catalog.getWorkspaceByName(workspaceName)==null){thrownewResourceNotFoundException("Workspace"+workspaceName+"notfound");
if(workspaceName!=null&&catalog.getWorkspaceByName(workspaceName)==null){thrownewResourceNotFoundException("Workspace"+workspaceName+"notfound");
if(layerGroupInfo==null){thrownewResourceNotFoundException("Nosuchlayergroup"+layerGroupName+(workspaceName==null?"":"inworkspace"+workspaceName));
if(workspaceName!=null&&catalog.getWorkspaceByName(workspaceName)==null){thrownewResourceNotFoundException("Workspace"+workspaceName+"notfound");
if(lg.getLayers().isEmpty()){thrownewRestException("layergroupmustnotbeempty",HttpStatus.BAD_REQUEST);
if(lg.getBounds()==null){LOGGER.fine("Autocalculatinglayergroupbounds");newCatalogBuilder(catalog).calculateLayerGroupBounds(lg);
if(workspaceName!=null){lg.setWorkspace(catalog.getWorkspaceByName(workspaceName));
if(lg.getMode()==null){LOGGER.fine("SettinglayergroupmodeSINGLE");lg.setMode(LayerGroupInfo.Mode.SINGLE);
if(workspaceName!=null&&catalog.getWorkspaceByName(workspaceName)==null){thrownewResourceNotFoundException("Workspace"+workspaceName+"notfound");
if(lg.getName()!=null&&!lg.getName().equals(original.getName())){thrownewRestException("Can'tchangenameofalayergroup",HttpStatus.FORBIDDEN);
if(lg.getWorkspace()!=null){
if(!lg.getWorkspace().equals(original.getWorkspace())){thrownewRestException("Can'tchangetheworkspaceofalayergroup,instead"+"DELETEfromexistingworkspaceandPOSTtonewworkspace",HttpStatus.FORBIDDEN);
if(workspaceName!=null&&catalog.getWorkspaceByName(workspaceName)==null){thrownewResourceNotFoundException("Workspace"+workspaceName+"notfound");
if(layerGroup==null){returnnull;
if(objinstanceofStyleInfo){StringBuilderlink=newStringBuilder();
if(prefix!=null){link.append("/workspaces/").append(converter.encode(prefix));
if(objinstanceofLayerInfo){converter.encodeLink("/workspaces/"+prefix+"/layers/"+converter.encode(ref),writer);
else
if(objinstanceofLayerGroupInfo){LayerGroupInfolg=(LayerGroupInfo)obj;
if(lg.getWorkspace()!=null){converter.encodeLink("/workspaces/"+lg.getWorkspace().getName()+"/layergroups/"+converter.encode(ref),writer);
else{converter.encodeLink("/layergroups/"+converter.encode(ref),writer);
if(properties==null){try{properties=model.toMap();
if(info!=null){props.put("name",info.getName());props.put("prefixedName",info.prefixedName());
if(info!=null){props.put("name",info.getName());
if(info.getWorkspace()!=null){props.put("workspace",info.getWorkspace().getName());
if(m_Algorithm.execute(taskMonitor,newGTOutputFactory())){returncreateReturnMapFromOutputObjects();
else{//
iftheexecutionwascanceled,wereturnnullreturnnull;
iftheoutputobjectisalayeroratable,wereturn//theinnerGeoToolsobject
if(outputObjectinstanceofIDataObject){IDataObjectdataObject=(IDataObject)outputObject;Objectwrapped=dataObject.getBaseDataObject();
if(wrappedinstanceofFeatureSource){results.put(output.getName(),((FeatureSource)wrapped).getFeatures());
else
if(wrappedinstanceofGridCoverage2D){results.put(output.getName(),wrapped);
else{results.put(output.getName(),wrapped);
else{results.put(output.getName(),outputObject);
if(SEXTANTE_GRID_CELL_SIZE.equals(sKey)||SEXTANTE_GRID_ENVELOPE.equals(sKey)){//thesetwoparameterswemadeuptoexposetheGridExtent,we'lldealwiththem//latercontinue;
if(paramValueinstanceofFeatureCollection){GTVectorLayerlayer=newGTVectorLayer();layer.create(DataUtilities.source((FeatureCollection)paramValue));param.setParameterValue(layer);
else
if(paramValueinstanceofGridCoverage2D){GTRasterLayerlayer=newGTRasterLayer();gridExtendRequired=true;layer.create(paramValue);param.setParameterValue(layer);
else{param.setParameterValue(paramValue);
if(outputinstanceofOutputRasterLayer){gridExtendRequired=true;
ifnecessary
if(gridExtendRequired){//getthecellsizedoublecellSize=Double.NaN;
if(input.get(SEXTANTE_GRID_CELL_SIZE)!=null){cellSize=(Double)input.get(SEXTANTE_GRID_CELL_SIZE);
else{for(StringsKey:input.keySet()){Objectvalue=paramSet.getParameter(sKey).getParameterValueAsObject();
if(valueinstanceofGTRasterLayer){cellSize=((GTRasterLayer)value).getLayerCellSize();return;
if(Double.isNaN(cellSize)){thrownewGeoAlgorithmExecutionException(SEXTANTE_GRID_CELL_SIZE+"parametercouldnotbederivedfrominputs,andisnotavailableamong");
if(input.get(SEXTANTE_GRID_ENVELOPE)!=null){envelope=(Envelope)input.get(SEXTANTE_GRID_ENVELOPE);
else{for(StringsKey:input.keySet()){Objectvalue=paramSet.getParameter(sKey).getParameterValueAsObject();
if(valueinstanceofGTRasterLayer){AnalysisExtentge=((GTRasterLayer)value).getLayerGridExtent();Envelopegenv=newEnvelope(ge.getXMin(),ge.getXMax(),ge.getYMin(),ge.getYMax());
if(envelope==null){envelope=genv;
else{envelope.expandToInclude(genv);
if(envelope==null){
if(Double.isNaN(cellSize)){thrownewGeoAlgorithmExecutionException(SEXTANTE_GRID_ENVELOPE+"parametercouldnotbederivedfrominputs,andisnotavailableamong");
ifrunninginonlinemode*/privateStringonlineTestId;/**SchemaCatalogtoworkwithAppSchemaValidatorfortestrequestsvalidation.*/privateSchemaCatalogcatalog;/***True
ifrunning3Donlinetest.OnlymattersforOracle,sinceaspecialwktparseris*needed.*/privatebooleanis3D=false;/**Constructorwiththedefaultnamespaces,schemadirectory,andcatalogfile.*/publicAbstractAppSchemaMockData(){this(NAMESPACES);
if(!propertiesFiles.isEmpty()){try{createTablesInTestDatabase();
if(catalogLocation!=null){URLresolvedCatalogLocation=getClass().getResource(TEST_DATA+catalogLocation);
if(resolvedCatalogLocation==null){thrownewRuntimeException("Testcataloglocationmustberelativetotest-datadirectory!");
if(resourceFile.exists()){try{//theresourceisafilesoreadfromitreturnnewFileInputStream(resourceFile);
else{//consideringtheresourcetobeanapp-schematestdataresourcereturnAppSchemaDataAccessTest.class.getResourceAsStream(TEST_DATA+resource);
iffileNamecontains*directorypatheg,dir1/dir2/file.xml,thefullpathwillbeusedtolocatetheresource.*Afterwhichthedirectorywillbeignored.**@paramnamespacePrefixnamespaceprefixoftheWFSfeaturetype*@paramtypeNamelocalnameoftheWFSfeaturetype*@paramfileNameshortnameofthefileintest-datatocopy*@paramdatamockdatarootdirectory*/privatevoidcopyFileToFeatureTypeDir(StringnamespacePrefix,StringtypeName,StringfileName){InputStreaminput=openResource(fileName);copy(input,"featureTypes"+"/"+getDataStoreName(namespacePrefix,typeName)+"/"+fileName.substring(fileName.lastIndexOf("/")+1,fileName.length()));
if(writer!=null){try{writer.close();
if(params.get(KEY_ALIAS)!=null)writer.write("<alias>"+params.get(KEY_ALIAS)+"</alias>");writer.write("<SRS>"+params.get(KEY_SRS_NUMBER)+"</SRS>");//thismocktypemayhavewrongSRScomparedtotheactualoneinthepropertyfiles...//let'sconfigureSRShandlingnottoaltertheoriginalone,andhave4326usedonly//forcapabilitieswriter.write("<SRSHandling>"+params.get(KEY_SRS_HANDLINGS)+"</SRSHandling>");writer.write("<title>"+typeName+"</title>");writer.write("<abstract>abstractabout"+typeName+"</abstract>");writer.write("<numDecimalsvalue=\"8\"/>");writer.write("<keywords>"+typeName+"</keywords>");EnvelopellEnvelope=(Envelope)params.get(KEY_LL_ENVELOPE);
if(llEnvelope==null)llEnvelope=DEFAULT_ENVELOPE;writer.write("<latLonBoundingBoxdynamic=\"false\"minx=\""+llEnvelope.getMinX()+"\"miny=\""+llEnvelope.getMinY()+"\"maxx=\""+llEnvelope.getMaxX()+"\"maxy=\""+llEnvelope.getMaxY()+"\"/>");EnvelopenativeEnvelope=(Envelope)params.get(KEY_NATIVE_ENVELOPE);
if(nativeEnvelope!=null)writer.write("<nativeBBoxdynamic=\"false\"minx=\""+nativeEnvelope.getMinX()+"\"miny=\""+nativeEnvelope.getMinY()+"\"maxx=\""+nativeEnvelope.getMaxX()+"\"maxy=\""+nativeEnvelope.getMaxY()+"\"/>");Stringstyle=(String)params.get(KEY_STYLE);
if(style==null)style="Default";writer.write("<stylesdefault=\""+style+"\"/>");writer.write("</featureType>");writer.flush();writer.close();
ifmappingFileNamecontainsdirectory,eg,dir1/dir2/file.xml,wewillignorethe//directoryfromhereonaddDataStore(dataStoreName,namespacePrefix,buildAppSchemaDatastoreParams(namespacePrefix,typeName,mappingFileName.substring(mappingFileName.lastIndexOf("/")+1,mappingFileName.length()),featureTypesBaseDir,dataStoreName));
if(isOracleOnlineTest()){
if(is3D){setup=AppSchemaTestOracleSetup.get3DInstance(propertiesFiles);
else{setup=AppSchemaTestOracleSetup.getInstance(propertiesFiles);
else
if(isPostgisOnlineTest()){setup=AppSchemaTestPostgisSetup.getInstance(propertiesFiles);//Runthesqlscriptthroughsetupsetup.setUp();setup.tearDown();
if(onlineTestId!=null){onlineTestId=onlineTestId.toLowerCase().trim();//specialhandlingforrunningapp-schema-testwithonlinemodetry{//newcontentwithmodifieddataStore"parameters"tagStringnewContent=modifyOnlineMappingFileContent(mappingFileName);copy(newContent,"featureTypes/"+getDataStoreName(namespacePrefix,typeName)+"/"+mappingFileName.substring(mappingFileName.lastIndexOf("/")+1,mappingFileName.length()));for(StringpropertyFileName:supportFileNames){
if(propertyFileName.endsWith(".xml")){//alsoupdatethedatastore"parameters"forsupportingmappingfilesnewContent=modifyOnlineMappingFileContent(propertyFileName);copy(newContent,"featureTypes/"+getDataStoreName(namespacePrefix,typeName)+"/"+propertyFileName.substring(propertyFileName.lastIndexOf("/")+1,propertyFileName.length()));
else{copyFileToFeatureTypeDir(namespacePrefix,typeName,propertyFileName);
if(propertyFileName.endsWith(".properties")){//extractthefilename
ifneededFilefile=newFile(propertyFileName);
if(file.exists()){//extractthefilenamepropertyFileName=file.getName();
else{copyFileToFeatureTypeDir(namespacePrefix,typeName,mappingFileName);for(StringpropertyFileName:supportFileNames){copyFileToFeatureTypeDir(namespacePrefix,typeName,propertyFileName);
if(!parametersStartFound||(parametersStartFound&&parametersEndFound)){//before<parameters>orafter</parameters>
if(!parametersStartFound){//lookforstarttag
if(line.trim().equals("<parameters>")){parametersStartFound=true;//copy<parameters>withnewdbparams
if(isOracle){content.append(AppSchemaTestOracleSetup.DB_PARAMS);
else{content.append(AppSchemaTestPostgisSetup.DB_PARAMS);
else{//copycontentcontent.append(line);
else
if(line.trim().startsWith("<sourceType>")){//makeeverythinguppercaseduetoOracleDialectnotwrappingtheminquotesline=line.trim();StringsourceTypeTag="<sourceType>";content.append(sourceTypeTag);StringtableName=line.substring(line.indexOf(sourceTypeTag)+sourceTypeTag.length(),line.indexOf("</sourceType>"));content.append(tableName.toUpperCase());content.append("</sourceType>");content.append("\n");
else{content.append(line);
else{//
elseskip<parameters>contentanddonothing//lookforendtag
if(line.trim().equals("</parameters>")){parametersEndFound=true;
ifthestyleisglobal.*/WorkspaceInfogetWorkspace();/**Setstheworkspacethestyleispartof.*/voidsetWorkspace(WorkspaceInfoworkspace);/***Thesldversionofthestyle.**@deprecateduse{@link#getFormatVersion()}*/VersiongetSLDVersion();/***Setsthesldversionofthestyle.**@deprecateduse{@link#setFormatVersion(Version)}*/voidsetSLDVersion(Versionv);/**Thestylinglanguage/formatforthestyle,forexample:"sld"*/StringgetFormat();/**Setsthestylingformatforthestyle,forexample:"sld"*/voidsetFormat(Stringformat);/**Theversionofthestyleformat.*/VersiongetFormatVersion();/**Setstheversionofthestyleformat.*/voidsetFormatVersion(Versionversion);/**Thenameofthefilethestyleoriginatesfrom.*/StringgetFilename();/**Setsthenameofthefilethestyleoriginatedfrom.*/voidsetFilename(StringfileName);/**Thestyleobject.*/StylegetStyle()throwsIOException;/**Thefullsldobject(whichcontainsthestyle).*/StyledLayerDescriptorgetSLD()throwsIOException;/**TheLegendforthestyle.*/LegendInfogetLegend();/**SetstheLegendforthestyle.*/voidsetLegend(LegendInfolegend);/***Thederivedprefixedname.**<p>Ifaworkspaceissetthismethodreturns:**<pre>*getWorkspace().getName()+":"+getName();*</pre>**Otherwiseitsimplyreturns:**<pre>getName()</pre>*/StringprefixedName();}
if(property==ConfigProvider.NAME){Stringkey=(String)ConfigProvider.NAME.getModel(itemModel).getObject();
if(ConfigEntry.isRestricted(key)){returnnewLabel(id,key);
else
if(property==ConfigProvider.VALUE){Stringvalue=(String)ConfigProvider.VALUE.getModel(itemModel).getObject();Labellabel=newLabel(id,value);returnlabel;
else
if(property==ConfigProvider.REMOVELINK){Stringkey=(String)ConfigProvider.NAME.getModel(itemModel).getObject();
if(ConfigEntry.isRestricted(key)){returnnewLabel(id,"-");
ifconfiguration==null,justforuniqueconstraint@ColumnprivateStringnameNoConfig;@ManyToOne@JoinColumn(name="configuration",nullable=true)privateConfigurationImplconfiguration;@ColumnprivateStringdescription;@Column(nullable=true)privateStringfrequency;@Column(nullable=false)privateBooleanenabled=true;@Column(nullable=false)privateLongremoveStamp=0L;@OneToMany(targetEntity=BatchRunImpl.class,mappedBy="batch",cascade=CascadeType.ALL)@OrderBy("id")privateList<BatchRun>batchRuns=newArrayList<BatchRun>();@TransientprivateBatchRunlatestBatchRun;@OverridepublicLonggetId(){returnid;
if(configuration==null){this.nameNoConfig=name;
if(configuration==null){nameNoConfig=name;
else{nameNoConfig=null;
if(name.equals(item.getModelObject().getName()))returnitem.getModelObject();
if(name.equals(item.getModelObject().getName()))tester.clickLink(item.getPageRelativePath()+":"+FIRST_COLUM_PATH);
if(name.equals(item.getModelObject().getName()))tester.executeAjaxEvent(item.getPageRelativePath()+":"+CHECKBOX_PATH,"click");
if(serviceNames.length==0){StringselectAllPath=basePanelId+":table:listContainer:selectAllContainer:selectAll";tester.assertComponent(selectAllPath,CheckBox.class);FormComponentselectAllPathComponent=(FormComponent)tester.getComponentFromLastRenderedPage(selectAllPath);setFormComponentValue(selectAllPathComponent,"true");tester.executeAjaxEvent(selectAllPath,"click");
else{DataView<SecurityNamedServiceConfig>dataview=(DataView<SecurityNamedServiceConfig>)testPage.get(basePanelId+":table:listContainer:items");List<String>nameList=Arrays.asList(serviceNames);Iterator<Item<SecurityNamedServiceConfig>>it=getDataView().getItems();while(it.hasNext()){Item<SecurityNamedServiceConfig>item=it.next();
if(nameList.contains(item.getModelObject().getName())){StringcheckBoxPath=item.getPageRelativePath()+":"+CHECKBOX_PATH;tester.assertComponent(checkBoxPath,CheckBox.class);FormComponentcheckBoxPathComponent=(FormComponent)tester.getComponentFromLastRenderedPage(checkBoxPath);setFormComponentValue(checkBoxPathComponent,"true");testPage.get(checkBoxPath).setDefaultModelObject(true);tester.executeAjaxEvent(checkBoxPath,"click");
if(clazz.isInstance(list.getList().get(i))){toClick=i;break;
if(link.isEnabled()){tester.executeAjaxEvent(link,"click");
if(request.getTraverseXlinkDepth()!=null){Integerdepth=GetFeature.traverseXlinkDepth(request.getTraverseXlinkDepth());hints.put(Hints.ASSOCIATION_TRAVERSAL_DEPTH,depth);
if(dsinstanceofGmlObjectStore){try{Objectobj=((GmlObjectStore)ds).getGmlObject(id,hints);
if(obj!=null){returnobj;
if(transformInfoName==null){//weneedtoreturnalltransformstry{returnwrapList(repository.getAllTransforms(),TransformInfo.class);
if(transformInfo==null){transformInfo=newTransformInfo();transformInfo.setName(transformInfoName);transformInfo.setSourceFormat(sourceFormat);transformInfo.setOutputFormat(outputFormat);transformInfo.setOutputMimeType(outputMimeType);transformInfo.setFileExtension(fileExtension);transformInfo.setXslt(transformInfoName+".xslt");validate(transformInfo);saveTransFormInfo(transformInfo);
if(info.getSourceFormat()==null){thrownewRestException("Thetransformationmusthaveasourceformat",HttpStatus.BAD_REQUEST);
if(info.getOutputFormat()==null){thrownewRestException("Thetransformationmusthaveanoutputformat",HttpStatus.BAD_REQUEST);
if(transformInfo==null){thrownewResourceNotFoundException(String.format("Transform'%s'infonotfound.",transformInfoName));
if(transform==null){thrownewResourceNotFoundException(String.format("Transform'%s'XSLTnotfound.",transformInfoName));
if(ft!=null){resolved.setFeatureType(ModificationProxy.unwrap(ft));
if(reader.hasMoreChildren()){while(reader.hasMoreChildren()){reader.moveDown();ref=reader.getValue();reader.moveUp();
else{ref=reader.getValue();
if(result==null){result=catalog.getFeatureTypeByName(ref);
if(!meta.isEnabled()){//Don'tcountlocksfromdisableddatastores.continue;
if(storeinstanceofDataStore){LockingManagerlockingManager=((DataStore)store).getLockingManager();
if(lockingManager!=null){//wecan'tactually*count*locksrightnow?//count+=lockingManager.getLockSet().size();
if(!meta.isEnabled()){//Don'tcountconnectionsfromdisableddatastores.continue;
if(useDirectoryChooser){file=newDirectoryParamPanel("url",newPropertyModel(model,"URL"),newResourceModel("url","URL"),true);
else{file=newFileParamPanel("url",newPropertyModel(model,"URL"),newResourceModel("url","URL"),true);
if(fileExtensions!=null&&fileExtensions.length>0){file.setFileFilter(newModel(newExtensionFileFilter(fileExtensions)));
if(clientInfo==null){clientInfo=newProperties();
if(property==DataAccessRuleProvider.RULEKEY){returneditRuleLink(id,itemModel,property);
if(property==DataAccessRuleProvider.ROLES){returnnewLabel(id,property.getModel(itemModel));
iftheyarenotpresentintheCatalogandstartlisteningtoCatalog*events.**@paramcatalog*@paramresourceLoader*@throwsIOException*/publicEoStyleCatalogListener(Catalogcatalog,GeoServerResourceLoaderresourceLoader)throwsIOException{this.catalog=catalog;this.resourceLoader=resourceLoader;initializeStyles();catalog.addListener(this);
iftheyarenotpresentintheCatalog**@throwsIOException*/privatevoidinitializeStyles()throwsIOException{for(inti=0;i<EO_STYLE_NAMES.length;i++){Stringname=EO_STYLE_NAMES[i];
if(catalog.getStyleByName(name)==null){initializeStyle(name,name+".sld");
ifnecessaryResourceres=resourceLoader.get(Paths.path("styles",sld));
if(!Resources.exists(res)){IOUtils.copy(EoStyleCatalogListener.class.getResourceAsStream(sld),res.out());
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,e.getMessage(),e);
if(event.getSource()instanceofStyleInfo){//whenthiseventhasbeenfiredthestylehasalreadybeenremovedtry{//trytofind
ifarequiredstylehasbeendeletedandrecreateitinitializeStyles();
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,e.getMessage(),e);
if(event.getSource()instanceofStyleInfo){StyleInfostyle=(StyleInfo)event.getSource();for(StringstyleName:EO_STYLE_NAMES){
if(styleName.equals(style.getName())){thrownewCatalogException("Style"+styleName+"isusedbymoduleWMS-EOandisread-only");
if(providedCount!=COUNT_UNSET){returnprovidedCount;
else{//makesurewegetacountbygettingafeaturecolleciton//FeatureSource.getCount(...)canreturn-1returnsource.getFeatures(query).size();
if(event==null){thrownewIllegalArgumentException("Incomingobjectisnull");
if(eventinstanceofCatalogModifyEvent){finalCatalogModifyEventmodifyEv=((CatalogModifyEvent)event);producer.disable();JMSCatalogModifyEventHandler.modify(catalog,modifyEv);
else{//incomingobjectnotrecognized
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe("Unrecognizedeventtype");returnfalse;
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(this.getClass()+"isunabletosynchronizetheincomingevent:"+event);throwe;
ifnameischangedStringname=getOldName(catalog,modifyEv);
if(infoinstanceofLayerGroupInfo){//check
ifnameischanged
if(name==null){//nameisunchangedname=((LayerGroupInfo)info).getName();
if(localObject==null){thrownewCatalogException("Unabletolocate"+info+"named:"+name+"locally.");
else
if(infoinstanceofLayerInfo){//check
ifnameischanged
if(name==null){//nameisunchangedname=((LayerInfo)info).getName();
if(localObject==null){thrownewCatalogException("Unabletolocate"+info+"named:"+name+"locally.");
else
if(infoinstanceofMapInfo){//check
ifnameischanged
if(name==null){//nameisunchangedname=((MapInfo)info).getName();
if(localObject==null){thrownewCatalogException("Unabletolocate"+info+"named:"+name+"locally.");
else
if(infoinstanceofNamespaceInfo){finalStringuri;finalObjecturiObj=getOldValue(catalog,modifyEv,"uRI");
if(uriObj!=null){uri=uriObj.toString();
else{//uriisunchangeduri=((NamespaceInfo)info).getURI();
if(localObject==null){thrownewCatalogException("Unabletolocate"+info+"uri:"+uri+"locally.");
else
if(infoinstanceofStoreInfo){//check
ifnameischanged
if(name==null){//nameisunchangedname=((StoreInfo)info).getName();
ifworkspaceischangedfinalWorkspaceInfoworkspace;finalObjectobjWorkpsace=getOldValue(catalog,modifyEv,"workspace");
if(objWorkpsace!=null){workspace=(WorkspaceInfo)objWorkpsace;
else{//workspaceisunchangedworkspace=((StoreInfo)info).getWorkspace();
if(infoinstanceofCoverageStoreInfo){localObject=catalog.getStoreByName(workspace,name,CoverageStoreInfo.class);
else
if(infoinstanceofDataStoreInfo){localObject=catalog.getStoreByName(workspace,name,DataStoreInfo.class);
else
if(infoinstanceofWMSStoreInfo){localObject=catalog.getStoreByName(workspace,name,WMSStoreInfo.class);
else{thrownewIllegalArgumentException("Unabletoprovidelocalizationforthepassedinstance");
if(localObject==null){thrownewCatalogException("Unabletolocate"+info+"named:"+name+"locally.");
else
if(infoinstanceofResourceInfo){//check
ifnameischanged
if(name==null){//nameisunchangedname=((ResourceInfo)info).getName();
ifnamespaceischangedfinalNamespaceInfonamespace;finalObjectobjWorkpsace=getOldValue(catalog,modifyEv,"namespace");
if(objWorkpsace!=null){namespace=(NamespaceInfo)objWorkpsace;
else{//workspaceisunchangednamespace=((ResourceInfo)info).getNamespace();
if(infoinstanceofCoverageInfo){//coveragelocalObject=catalog.getCoverageByName(namespace,name);
else
if(infoinstanceofFeatureTypeInfo){//featurelocalObject=catalog.getFeatureTypeByName(namespace,name);
else
if(infoinstanceofWMSLayerInfo){//wmslayerlocalObject=catalog.getResourceByName(namespace,name,WMSLayerInfo.class);
else{thrownewIllegalArgumentException("Unabletoprovidelocalizationforthepassedinstance");
if(localObject==null){thrownewCatalogException("Unabletolocate"+info+"named:"+name+"locally.");
else
if(infoinstanceofStyleInfo){//check
ifnameischanged
if(name==null){//nameisunchangedname=((StyleInfo)info).getName();
if(localObject==null){thrownewCatalogException("Unabletolocate"+info+"named:"+name+"locally.");
ifthestylefilewasprovided
if(modifyEvinstanceofStyleModifyEvent){StyleModifyEventstyleModifyEvent=(StyleModifyEvent)modifyEv;byte[]fileContent=styleModifyEvent.getFile();
if(fileContent!=null&&fileContent.length!=0){//updatethestylefileusingtheoldstyleStyleInfooldStyle=catalog.getStyleByName(name);try{catalog.getResourcePool().writeStyle(oldStyle,newByteArrayInputStream(fileContent));
else
if(infoinstanceofWorkspaceInfo){//check
ifnameischanged
if(name==null){//nameisunchangedname=((WorkspaceInfo)info).getName();
if(localObject==null){thrownewCatalogException("Unabletolocate"+info+"named:"+name+"locally.");
else
if(infoinstanceofCatalogInfo){//changedefaultworkspaceinthehandledcatalog/***Thispieceofcodewasextractedfrom:{@link*org.geoserver.catalog.NamespaceWorkspaceConsistencyListener#handleModifyEvent(CatalogModifyEvent)}*/finalList<String>properties=modifyEv.getPropertyNames();
if(properties.contains("defaultNamespace")){finalNamespaceInfonewDefault=(NamespaceInfo)modifyEv.getNewValues().get(properties.indexOf("defaultNamespace"));
if(newDefault!=null){finalWorkspaceInfows=catalog.getWorkspaceByName(newDefault.getPrefix());
if(ws!=null&&!catalog.getDefaultWorkspace().equals(ws)){catalog.setDefaultWorkspace(ws);
else
if(properties.contains("defaultWorkspace")){finalWorkspaceInfonewDefault=(WorkspaceInfo)modifyEv.getNewValues().get(properties.indexOf("defaultWorkspace"));
if(newDefault!=null){finalNamespaceInfons=catalog.getNamespaceByPrefix(newDefault.getName());
if(ns!=null&&!catalog.getDefaultNamespace().equals(ns)){catalog.setDefaultNamespace(ns);
else{
if(LOGGER.isLoggable(java.util.logging.Level.WARNING)){LOGGER.warning("info-ID:"+info.getId()+"toString:"+info.toString());
ifnameisnotchangedornotexistsat*all*/privatestaticStringgetOldName(finalCatalogcatalog,finalCatalogModifyEventev){//trytogettheoldvalueforthenamefinalObjectname=getOldValue(catalog,ev,"name");//checkreturnandreturnastringrepresentationofthenameornullreturnname!=null?name.toString():null;
ifnameisnot*changedornotexistsatall*/privatestaticObjectgetOldValue(finalCatalogcatalog,finalCatalogModifyEventev,finalStringoldProp){finalCatalogInfoservice=ev.getSource();
if(service==null){thrownewIllegalArgumentException("passedserviceisnull");
ifnameischangedfinalList<String>props=ev.getPropertyNames();finalintindex=props.indexOf(oldProp);
if(index!=-1){finalList<Object>oldValues=ev.getOldValues();//searchtheServiceusingtheoldnamereturnoldValues.get(index);
else{returnnull;
if(lg==null){error(newParamResourceModel("LayerGroupEditPage.notFound",this,groupName).getString());doReturn(LayerGroupPage.class);return;
if(!isAuthenticatedAsAdmin()){Formf=(Form)get("form");//globallayergroupsonlyeditablebyfulladmin
if(lg.getWorkspace()==null){//disableallformcomponentsbutcancelf.visitChildren((component,visit)->{
if(!(componentinstanceofAbstractLink&&"cancel".equals(component.getId()))){component.setEnabled(false);
if(debugMode){print(page,true,true);
ifthetextchangesinGeoserverApplication.properties...//butIstillwanttoassertthereasonforfailureistheexpectedone..assertTrue(e.getMessage().startsWith("Can'tfindthefactory"));
if(service==null){thrownewIOException("Unkownuser/groupservice:"+getUserGroupServiceName());
if(StringUtils.hasLength(getUserGroupServiceName())==false){thrownewIOException("User/GroupServiceNameisunset");
if(getSecurityManager()==null){thrownewIOException("Securitymanagerisunset");
if(!this.parameters.containsKey(paramName)){this.parameters.put(paramName,getDefaultParamValue(paramName));
ifwebadminshouldencrypturlparameters.*/publicbooleanisEncryptingUrlParams(){returnencryptingUrlParams;
if(target!=null){
if(allowEnvParametrization&&gsEnvironment!=null&&GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){target.setConfigPasswordEncrypterName((String)gsEnvironment.resolveValue(configPasswordEncrypterName));target.setRoleServiceName((String)gsEnvironment.resolveValue(roleServiceName));
if(values==null){return;
if("typeName".equals(property)){property="typeNames";
if((m==1)&&(n>1)){//applysinglevaluetoallqueriesEMFUtils.set(query,property,values.get(0));return;
if(m>n){
if(n==0){//makesamesize,withemptyobjectsfor(inti=0;i<m;i++){query.add(req.createQuery().getAdaptee());
else
if(n==1){//clonesingleobjectuptoEObjectq=(EObject)query.get(0);for(inti=1;i<m;i++){query.add(EMFUtils.clone(q,req.getFactory()));
else{//illegalStringmsg="Specified"+m+""+property+"for"+n+"queries.";thrownewWFSException(request,msg);
if(m<n){//filltherestwithnullsListnewValues=newArrayList<>();newValues.addAll(values);for(inti=0;i<n-m;i++){newValues.add(null);
if(!(reqinstanceofLockFeatureRequest.WFS20)){thrownewWFSException(req,"StoredqueriesonlysupportedinWFS2.0+");
if(sq==null){WFSExceptionexception=newWFSException(req,"Nosuchstoredquery:"+storedQueryId,ServiceException.INVALID_PARAMETER_VALUE);exception.setLocator("STOREDQUERY_ID");throwexception;
iftheykeepstoredqueriesaround)wewill//have//toabstractstoredqueryawaywitharequestobjectadapterWfs20Factoryfactory=(Wfs20Factory)req.getFactory();StoredQueryTypestoredQuery=factory.createStoredQueryType();storedQuery.setId(storedQueryId.toString());//lookforparametersinthekvpmapfor(ParameterExpressionTypep:sq.getQuery().getParameter()){
if(kvp.containsKey(p.getName())){ParameterTypeparam=factory.createParameterType();param.setName(p.getName());param.setValue(kvp.get(p.getName()).toString());storedQuery.getParameter().add(param);
ifany,mustincludethefollowingacknowledgment:*"Thisproductincludessoftwaredevelopedbythe*ApacheSoftwareFoundation(http://www.apache.org/)."*Alternately,thisacknowledgmentmayappearinthesoftwareitself,*
ifandwhereversuchthird-partyacknowledgmentsnormallyappear.**4.Thenames"Xerces"and"ApacheSoftwareFoundation"must*notbeusedtoendorseorpromoteproductsderivedfromthis*softwarewithoutpriorwrittenpermission.Forwritten*permission,pleasecontactapache@apache.org.**5.Productsderivedfromthissoftwaremaynotbecalled"Apache",*normay"Apache"appearintheirname,withoutpriorwritten*permissionoftheApacheSoftwareFoundation.**THISSOFTWAREISPROVIDED``ASIS''ANDANYEXPRESSEDORIMPLIED*WARRANTIES,INCLUDING,BUTNOTLIMITEDTO,THEIMPLIEDWARRANTIES*OFMERCHANTABILITYANDFITNESSFORAPARTICULARPURPOSEARE*DISCLAIMED.INNOEVENTSHALLTHEAPACHESOFTWAREFOUNDATIONOR*ITSCONTRIBUTORSBELIABLEFORANYDIRECT,INDIRECT,INCIDENTAL,*SPECIAL,EXEMPLARY,ORCONSEQUENTIALDAMAGES(INCLUDING,BUTNOT*LIMITEDTO,PROCUREMENTOFSUBSTITUTEGOODSORSERVICES;LOSSOF*USE,DATA,ORPROFITS;ORBUSINESSINTERRUPTION)HOWEVERCAUSEDAND*ONANYTHEORYOFLIABILITY,WHETHERINCONTRACT,STRICTLIABILITY,*ORTORT(INCLUDINGNEGLIGENCEOROTHERWISE)ARISINGINANYWAYOUT*OFTHEUSEOFTHISSOFTWARE,EVENIFADVISEDOFTHEPOSSIBILITYOF*SUCHDAMAGE.*====================================================================**Thissoftwareconsistsofvoluntarycontributionsmadebymany*individualsonbehalfoftheApacheSoftwareFoundationandwas*originallybasedonsoftwarecopyright(c)1999,International*BusinessMachines,Inc.,http://www.apache.org.Formore*informationontheApacheSoftwareFoundation,pleasesee*<http://www.apache.org/>.*///packageorg.apache.xerces.impl.io;packageorg.geoserver.ows.util;importjava.io.IOException;importjava.io.InputStream;importjava.io.Reader;/***ReaderforUCS-2andUCS-4encodings.(morepreciselyISO-10646-UCS-(2|4)encodings).**<p>ThisvariantismodifiedtohandlesupplementaryUnicodecodepointscorrectly.Thoughthis*requiredalotofnewcodeanddefinitelyreducedtheperfomancecomparingtooriginalversion.I*triedmybesttopreserveexsitingcodeandcommentswheneveritwaspossible.Iperformedsome*basictests,butnottoothoroughones,sosomebugsmaystillnestinthecode.-AK**@authorNeilGraham,IBM*@version$Id$*/publicclassUCSReaderextendsReader{////Constants///***Defaultbytebuffersize(8192,largerthanthatofASCIIReadersinceit'sreasonableto*surmisethattheaverageUCS-4-encodedfileshouldbe4timesaslargeastheaverage*ASCII-encodedfile).*/publicstaticfinalintDEFAULT_BUFFER_SIZE=8192;/***Startingsizeoftheinternalcharbuffer.Internalcharbufferismaintainedtoholdexcess*charsthatmayleftfrompreviousreadoperationwhenworkingwithUCS-4data(neverusedfor*UCS-2).*/publicstaticfinalintCHAR_BUFFER_INITIAL_SIZE=1024;publicstaticfinalshortUCS2LE=1;publicstaticfinalshortUCS2BE=2;publicstaticfinalshortUCS4LE=4;publicstaticfinalshortUCS4BE=8;/**Theminimumvalueofasupplementarycodepoint.*/publicstaticfinalintMIN_SUPPLEMENTARY_CODE_POINT=0x010000;/**TheminimumvalueofaUnicodecodepoint.*/publicstaticfinalintMIN_CODE_POINT=0x000000;/**ThemaximumvalueofaUnicodecodepoint.*/publicstaticfinalintMAX_CODE_POINT=0x10ffff;////Data///**Inputstream.*/protectedInputStreamfInputStream;/**Bytebuffer.*/protectedbyte[]fBuffer;/**whatkindofdatawe'redealingwith*/protectedshortfEncoding;/***Storesaforereador"excess"charactersthatmayappearduring<code>read</code>methods*invocationduetothefactthatoneinputUCS-4supplementarycharacterresultsintwooutput*Java<code>char</code>`s-highsurrogateandlowsurrogatecodeunits.Becauseofthat,
if*<code>read()</code>methodencounterssupplementarycodepointintheinputstream,it*returnsUTF-16-encodedhighsurrogatecodeunitandstoreslowsurrogateinbuffer.When*callednexttime,<code>read()</code>willreturnthislowsurrogate,insteadofreadingmore*bytesfromthe<code>InputStream</code>.Similarly
if<code>read(char[],int,int)</code>is*invokedtoread,forexample,10charsintospecifiedbuffer,and4ofthemturnouttobe*supplementaryUnicodecharacters,eachwrittenastwochars,thenweenduphaving4excess*charsthatwecannotimmediatelyreturnorpushbacktotheinputstream.Soweneedtostore*theminthebufferawaitingfurther<code>read</code>invocations.Notethatcharbuffer*functionslikeastack,i.e.charsandsurrogatepairsarestoredinreverseorder.*/protectedchar[]fCharBuf;/**CountofJavacharscurrentlybeingstoredininthe<code>fCharBuf</code>array.*/protectedintfCharCount;////Constructors///***Constructsan<code>ISO-10646-UCS-(2|4)</code>readerfromthespecifiedinputstreamusing*defaultbuffersize.TheEndiannessandexactinputencoding(<code>UCS-2</code>or<code>*UCS-4</code>)alsoshouldbeknowninadvance.**@paraminputStreaminputstreamwithUCS-2|4encodeddata*@paramencodingOneofUCS2LE,UCS2BE,UCS4LEorUCS4BE.*/publicUCSReader(InputStreaminputStream,shortencoding){this(inputStream,DEFAULT_BUFFER_SIZE,encoding);
if*youplantotoreadUCS-4withthisclass.*@paramencodingOneofUCS2LE,UCS2BE,UCS4LEorUCS4BE*/publicUCSReader(InputStreaminputStream,intsize,shortencoding){fInputStream=inputStream;fBuffer=newbyte[size];fEncoding=encoding;fCharBuf=newchar[CHAR_BUFFER_INITIAL_SIZE];fCharCount=0;
if(0!=fCharCount){fCharCount--;return((int)fCharBuf[fCharCount])&0xFFFF;
if(b0==0xff){return-1;
if(b1==0xff){return-1;
if(fEncoding>=4){//UCS-4intb2=fInputStream.read()&0xff;//3rdbyte
if(b2==0xff){return-1;
if(b3==0xff){return-1;
if(UCS4BE==fEncoding){codepoint=((b0<<24)+(b1<<16)+(b2<<8)+b3);
else{codepoint=((b3<<24)+(b2<<16)+(b1<<8)+b0);
ifinvalidoneisencountered.*/
if(!isSupplementaryCodePoint(codepoint)){returncodepoint;
else{intcp1=(codepoint-0x10000)&0xFFFFF;inthighSurrogate=0xD800+(cp1>>>10);//">>"shouldworktoo//SavinglowsurrogateforfutureusefCharBuf[fCharCount]=(char)(0xDC00+(cp1&0x3FF));//lowsurrogatecodeunitwillbereturnedduringnextcallreturnhighSurrogate;
else{//UCS-2
if(fEncoding==UCS2BE){return(b0<<8)+b1;
else{return(b1<<8)+b0;
ifyouknowforsurethatyour*<code>UCS-4</code>inputdoesnotcontainanysupplementarycodepointsyouprobablyshould*useoriginal<code>UCSReader</code>classfromXercesteam(<code>*org.apache.xerces.impl.io.UCSReader</code>).-AK**@paramchDestinationbuffer*@paramoffsetOffsetatwhichtostartstoringcharacters*@paramlengthMaximumnumberofcharacterstoread*@returnThenumberofcharactersread,or<code>-1</code>
iftheendofthestreamhasbeen*reached.Notethatthisisnotanumberof<code>UCS-4</code>charactersread,but*insteadnumberof<code>UTF-16</code>codeunits.Thesetwoareequalonly
iftherewere*nosupplementaryUnicodecodepointsamongreadchars.*@exceptionIOExceptionIfanI/Oerroroccurs*/publicintread(char[]ch,intoffset,intlength)throwsIOException{/**Thebehaviorofthismethodis_intended_tobelikethis:**1.Incase
ifweareworkingwithUCS-2data,`readUCS2`method*handlesthestuff.**2.ForUCS-4datamethodfirstlooks
ifthereissomedatastoredin*theinternalcharacterbuffer(fCharBuf).Usuallythisdatais*leftfrompreviousreadingoperation
iftherewereany*supplementaryUnicode(ISO-10646)characters.**3.Ifbufferholdssomething,thesecharsareputdirectlyinpassed*`ch`buffer(maximum`length`ofthem).**4.Ifcharbufferendsandmoredatacanbeputinto`ch`,*thentheyarereadfromtheunderlyingbytestream.**5.Methodtriestoreadmaximumpossiblenumberofbytesfrom*InputStream,as
ifallreadcodepointswerefromBMP(Basic*MultilingualPlane).**6.ReadUCS-4charactersareencodedtoUTF-16(whichisnativeJava*encoding)antputinto`ch`array.**7.Itispossiblethatweendupwithmorecharsthanwecan*currentlyputintopassedbufferduetothefactthat*supplementaryUnicodecharactersareencodedinto_two_Java*char'seach.Inthissituationexcesscharsarestoredinthe*internalcharbuffer(inreverseorder,i.e.thosereadlast*areatthebeginningofthe`fCharBuf`).Theyareusuallypicked*upduringnextcall(s)tooneofthe`read`methods.*/
if((0>offset)||(offset>ch.length)||(0>length)||((offset+length)>ch.length)||(0>(offset+length))){thrownewIndexOutOfBoundsException();
else
if(0==length){return0;
if(fEncoding<4){returnreadUCS2(ch,offset,length);
if(0!=fCharCount){ch[offset+charsRead]=fCharBuf[--fCharCount];charsRead++;
else{break;
if(0!=(length-charsRead)){/**Eachoutputchar(twoforsupplementarycharacters)willrequire*ustoread4inputbytes.Butaswecannotpredicthowmany*supplementarycharswewillencounter,soweshouldtrytoread*maximumpossiblenumber.*/intbyteLength=(length-charsRead)<<2;
if(byteLength>fBuffer.length){byteLength=fBuffer.length;
if(-1==count){return(0==charsRead)?(-1):charsRead;
else{//tryandmakecountbeamultipleofthenumberofbyteswe're//lookingfor(simplyreading1to3bytesfrominputstreamto//ensurethelastcodepointiscomplete)//thislooksugly,butitavoidsan
ifatanyrate...intnumToRead=((4-(count&3))&3);for(inti=0;i<numToRead;i++){intcharRead=fInputStream.read();
if(charRead==-1){//endofinput;somethinglikelywentwrong!Padbuffer//withzeros.for(intj=i;j<numToRead;j++)fBuffer[count+j]=0;break;
else{fBuffer[count+i]=(byte)charRead;
if(UCS4BE==fEncoding){codepoint=((b0<<24)+(b1<<16)+(b2<<8)+b3);
else{codepoint=((b3<<24)+(b2<<16)+(b1<<8)+b0);
if(!isSupplementaryCodePoint(codepoint)){ch[offset+charsCount]=(char)codepoint;charsCount++;
else{//Checking
ifwecanputanother2charsinbuffer.
if(2<=(length-charsCount)){intcp1=(codepoint-0x10000)&0xFFFFF;ch[offset+charsCount]=(char)(0xD800+(cp1>>>10));ch[offset+charsCount+1]=(char)(0xDC00+(cp1&0x3FF));charsCount+=2;
else{break;//ENDfor
if(UCS4BE==fEncoding){codepoint=((b0<<24)+(b1<<16)+(b2<<8)+b3);
else{codepoint=((b3<<24)+(b2<<16)+(b1<<8)+b0);
ifweneedtoincreasebuffersize
if(2>(fCharBuf.length-k)){char[]newBuf=newchar[fCharBuf.length<<1];System.arraycopy(fCharBuf,0,newBuf,0,fCharBuf.length);fCharBuf=newBuf;
if(!isSupplementaryCodePoint(codepoint)){fCharBuf[fCharCount++]=(char)codepoint;
else{intcp1=(codepoint-0x10000)&0xFFFFF;//Inthiscasestorelowsurrogatecodeunitfirst,sothat//itcanbereadbackafterhighone.fCharBuf[fCharCount++]=(char)(0xDC00+((char)cp1&0x3FF));fCharBuf[fCharCount++]=(char)(0xD800+(cp1>>>10));
if(-1==count)ELSE
if(0!=(length-charsRead))returncharsRead;
iftheendofthestreamhasbeen*reached*@exceptionIOExceptionIfanI/Oerroroccurs*/protectedintreadUCS2(char[]ch,intoffset,intlength)throwsIOException{intbyteLength=length<<1;
if(byteLength>fBuffer.length){byteLength=fBuffer.length;
if(count==-1){return-1;
if(numToRead!=0){count++;intcharRead=fInputStream.read();
if(charRead==-1){//endofinput;somethinglikelywent//wrong!Padbufferwithnulls.fBuffer[count]=0;
else{fBuffer[count]=(byte)charRead;
if(fEncoding==UCS2BE){ch[offset+i]=(char)((b0<<8)+b1);
else{ch[offset+i]=(char)((b1<<8)+b0);
if((bytesSkipped&(charWidth|1))==0){returnbytesSkipped>>>charWidth;
ifthenextread()isguaranteednottoblockforinput,falseotherwise.Note*thatreturningfalsedoesnotguaranteethatthenextreadwillblock.*@exceptionIOExceptionIfanI/Oerroroccurs*/publicbooleanready()throwsIOException{returnfalse;
ifsomeotherI/O*erroroccurs*/publicvoidmark(intreadAheadLimit)throwsIOException{fInputStream.mark(readAheadLimit);
ifthemarkhasbeen*invalidated,or
ifthestreamdoesnotsupportreset(),or
ifsomeotherI/Oerroroccurs*/publicvoidreset()throwsIOException{fInputStream.reset();
if(4>fEncoding){return"ISO-10646-UCS-2";
else{return"ISO-10646-UCS-4";
ifyouthinkthatwouldbebetter.**@return<code>LITTLE_ENDIAN</code>or<code>BIG_ENDIAN</code>dependingonbyteorderof*currentencodingofthisstream.*/publicStringgetByteOrder(){
if((1==fEncoding)||(4==fEncoding)){return"LITTLE_ENDIAN";
else{return"BIG_ENDIAN";
ifthespecifiedcharacterisintheUnicodesupplementary*characterrange;<code>false</code>otherwise.*/protectedbooleanisSupplementaryCodePoint(intcodePoint){return(codePoint>=MIN_SUPPLEMENTARY_CODE_POINT)&&(codePoint<=MAX_CODE_POINT);}}//classUCSReader
if(script==null){thrownewNullPointerException("Nullscript");
if(filename==null){filename="<UnknownSource>";
if(name==null){thrownewNullPointerException("Methodnameisnull");
if(thisObj==null){thisObj=getGlobal();
else{
if(!(thisObjinstanceofScriptable)){thisObj=Context.toObject(thisObj,getGlobal());
if(!(methodObjinstanceofFunction)){thrownewNoSuchMethodException("Nosuchmethod:"+name);
if(scope==null){scope=getGlobal();
if(meta!=null){FeatureTypefeatureType=meta.getFeatureType();//gothrougheachattribute,performingvarioushackstomakemakesurethings//cocherfor(PropertyDescriptorpd:featureType.getDescriptors()){
if(pdinstanceofAttributeDescriptor){AttributeDescriptorattributeType=(AttributeDescriptor)pd;Stringname=attributeType.getLocalName();Classtype=attributeType.getType().getBinding();
if("boundedBy".equals(name)){NodeboundedByNode=node.getChild("boundedBy");//hack1:
ifboundedByisintheparsetreehasaboundingboxandthe//attribute//needsapolygon,convert
if(boundedByNode.getValue()instanceofEnvelope){Envelopebounds=(Envelope)boundedByNode.getValue();
if(type.isAssignableFrom(Polygon.class)){Polygonpolygon=polygon(bounds);boundedByNode.setValue(polygon);
else
if(type.isAssignableFrom(MultiPolygon.class)){MultiPolygonmultiPolygon=geometryFactory.createMultiPolygon(newPolygon[]{polygon(bounds)});boundedByNode.setValue(multiPolygon);
ifanobjectis*aninstanceoftheprovidedinputclass.**<p>Userscancallthisfunctionusingthe{@linkPredicates}class:**<p>Predicates.isInstanceOf(Classclazz);**@authorNicolaLagomarsinigeosolutions*/publicclassIsInstanceOfimplementsVolatileFunction,Function{/**Functionnameandrelatedparameters*/publicstaticFunctionNameNAME=newFunctionNameImpl("isInstanceOf",Boolean.class,FunctionNameImpl.parameter("class",Class.class));/**Functionparameters*/privateList<Expression>parameters;/**Fallbackvalueusedasdefault*/privateLiteralfallback;publicIsInstanceOf(){this.parameters=newArrayList<Expression>();this.fallback=null;
if(parameters==null){thrownewNullPointerException("parameterrequired");
if(parameters.size()!=1){thrownewIllegalArgumentException("isInstanceOf(class)requiresoneparameteronly");
if(clazz!=null){
if(clazz==Object.class){result=true;
else{//Otherwisethefunctionchecks
iftheclassisaninstanceofthe//inputclassresult=clazz.isAssignableFrom(object.getClass());
if(params==null||params.size()==0){return"IsInstanceOf([INVALID])";
else{return"IsInstanceOf("+params.get(0)+")";
if((name.startsWith("get")||name.startsWith("is")||COMMON_DERIVED_PROPERTIES.contains(name))&&params.length==0){getters.put(gp(method),method);
else
if(name.startsWith("set")&&params.length==1){setters.put(name.substring(3),method);
if(methods.size()==0)methods=EMPTY;
if(getters.size()==0)getters=EMPTY;
if(setters.size()==0)setters=EMPTY;
if(key.equals("Resource")){properties.add(0,key);
else{properties.add(key);
ifitdoesnotexist.*/publicMethodsetter(Stringproperty,Classtype){Collection<Method>methods=setters.get(property);for(Methodsetter:methods){
if(type==null){returnsetter;
else{Classtarget=setter.getParameterTypes()[0];
if(target.isAssignableFrom(type)||(target.isPrimitive()&&type==wrapper(target))||(type.isPrimitive()&&target==wrapper(type))){returnsetter;
if(!lax.equals(property)){returnsetter(lax,type);
ifitdoesnotexist.*/publicMethodgetter(Stringproperty,Classtype){Collection<Method>methods=getters.get(property);
if(methods!=null){for(Methodgetter:methods){
if(type==null){returngetter;
else{Classtarget=getter.getReturnType();
if(type.isAssignableFrom(target)||(target.isPrimitive()&&type==wrapper(target))||(type.isPrimitive()&&target==wrapper(type))){returngetter;
if(!lax.equals(property)){returngetter(lax,type);
if(boolean.class==primitive){returnBoolean.class;
if(char.class==primitive){returnCharacter.class;
if(byte.class==primitive){returnByte.class;
if(short.class==primitive){returnShort.class;
if(int.class==primitive){returnInteger.class;
if(long.class==primitive){returnLong.class;
if(float.class==primitive){returnFloat.class;
if(double.class==primitive){returnDouble.class;
if(results.isEmpty()){returnnull;
else{returnresults.iterator().next();
if(COMMON_DERIVED_PROPERTIES.contains(name)){returnname;
if(aps!=null&&!aps.contains(this.samlAuthenticationProvider)){securityManager.getProviders().add(this.samlAuthenticationProvider);
if(filterChain.getRequestChainByName("samlSSOChain")==null){RequestFilterChainsamlChain=newConstantFilterChain(SAMLProcessingFilter.FILTER_URL+"/**");samlChain.setFilterNames("samlWebSSOProcessingFilter");samlChain.setName("samlSSOChain");filterChain.getRequestChains().add(0,samlChain);
if(filterChain.getRequestChainByName("samlLogoutChain")==null){RequestFilterChainsamlChain=newConstantFilterChain(SAMLLogoutProcessingFilter.FILTER_URL+"/**");samlChain.setFilterNames("samlLogoutProcessingFilter");samlChain.setName("samlLogoutChain");filterChain.getRequestChains().add(0,samlChain);
if(filterChain.getRequestChainByName("samlLogout")==null){RequestFilterChainsamlChain=newConstantFilterChain(SAMLLogoutFilter.FILTER_URL+"/**");samlChain.setFilterNames("samlLogoutFilter");samlChain.setName("samlLogout");filterChain.getRequestChains().add(0,samlChain);
if(s!=null){gs.remove(s);
ifnoerrorhasbeenfoundtester.assertNoErrorMessage();//GetGeoServerobjectforretrievingthesettingsassociatedtotheworkspaceGeoServergs=getGeoServer();assertNotNull(gs.getSettings(citeWorkspace));//Reloadthepagetester.startPage(newWorkspaceEditPage(citeWorkspace));tester.assertRenderedPage(WorkspaceEditPage.class);//CQLexpressionStringexpression="stringTemplate(path,'(\\w{4})_(\\w{7})_(\\d{3})_(\\d{4})(\\d{2})(\\d{2})T(\\d{7})_(\\d{2})\\.(\\w{4})',"+"'/${1}/${4}/${5}/${6}/${0}')";//SettherootdirectoryFormTesterform2=tester.newFormTester("form");form2.setValue("settings:settingsContainer:otherSettings:extensions:0:content:ecqlexp",expression);form2.submit();//Check
ifnoerrorhasbeenfoundtester.assertNoErrorMessage();//Control
ifthedefinedroothasbeencorrectlysetassertEquals(gs.getSettings(citeWorkspace).getMetadata().get(RESTUploadECQLPathMapper.EXPRESSION_KEY,String.class),expression);
ifnoerrorhasbeenfoundtester.assertNoErrorMessage();//Control
ifthedefinedroothasbeencorrectlysetassertEquals(gs.getGlobal().getSettings().getMetadata().get(RESTUploadECQLPathMapper.EXPRESSION_KEY,String.class),expression);}}
if(event==null){thrownewNullArgumentException("IncomingeventisNULL.");
switch(event.getEventType()){caseMODIFIED:handleModifiedSettings(event);break;caseADDED:handleAddedSettings(event);break;caseREMOVED:handleRemovedSettings(event);break;
ifnotsettingswerefoundthismeansthatauserjustdeletedthisworkspace//ordeletedthisworkspacesettingsonthisGeoServerinstanceorthatapreviously//synchronizationproblemhappened
if(settingsInfo==null){thrownewIllegalArgumentException(String.format("Nosettingsforworkspace'%s'foundonthisinstance.",workspace.getName()));
iftheworkspaceassociated//withthissettingsdoesn'texistsorthissettingsalreadyexists//GeoServerwillcomplainaboutitwithaproperexceptiongeoServer.add(event.getSource());
ifpropertyisrequired*/publicbooleanisRequired(){returnrequired;
ifkeydoesn'texist*/publicCatalogStoreMappingElementgetElement(Stringkey){returnmappingElements.get(key);
if(element.getValue().isRequired()||paths.contains(element.getKey())){mapping.mappingElements.put(element.getKey(),element.getValue());
ifthekeystartswith@italsodefinestheIDelementand
ifthekeystartswith$itisa*requiredproperty.*/publicstaticCatalogStoreMappingparse(Map<String,String>mappingSource){CatalogStoreMappingmapping=newCatalogStoreMapping();for(Map.Entry<String,String>mappingEntry:mappingSource.entrySet()){Stringkey=mappingEntry.getKey();booleanrequired=false;booleanid=false;intsplitIndex=-1;
if("$".equals(key.substring(0,1))){key=key.substring(1);required=true;
if("@".equals(key.substring(0,1))){key=key.substring(1);id=true;
if(key.contains("%.")){splitIndex=StringUtils.countMatches(key.substring(0,key.indexOf("%.")),".");key=key.replace("%.",".");
if(element==null){element=newCatalogStoreMappingElement(key);mapping.mappingElements.put(key,element);
if(id){mapping.identifier=element;
if(sourceExpr!=null&&sourceExpr.trim().length()>0){try{expression=CQL.toExpression(sourceExpr,ff);
if(coverageA==null||coverageB==null){StringcoveragesNull=coverageA==null?(coverageB==null?"coverageAandcoverageB":"coverageA"):"coverageB";thrownewProcessException(Errors.format(ErrorKeys.NULL_ARGUMENT_$1,coveragesNull));
if(!CRS.equalsIgnoreMetadata(crsA,crsB)){MathTransformmathTransform=null;try{mathTransform=CRS.findMathTransform(crsA,crsB);
if(mathTransform!=null&&!mathTransform.isIdentity()){thrownewProcessException(MISMATCHING_CRS_MESSAGE);
if(!envA.equals(envB)){thrownewProcessException(MISMATCHING_ENVELOPE_MESSAGE);
if(gridRangeA.getSpan(0)!=gridRangeB.getSpan(0)||gridRangeA.getSpan(1)!=gridRangeB.getSpan(1)){thrownewProcessException(MISMATCHING_GRID_MESSAGE);
if(csi==null){getSession().error(newParamResourceModel("CoverageStoreEditPage.notFound",this,storeName,wsName).getString());doReturn(StorePage.class);return;
if(store==null){thrownewIllegalArgumentException("Cannotfindcoveragestore"+storeId);
if(store.getId()!=null){//storeid==nullmeansthestoreisnotpartofcatalog,forgouniquenesscheckStringworkspaceId=store.getWorkspace().getId();workspacePanel.getFormComponent().add(newCheckExistingResourcesInWorkspaceValidator(store.getId(),workspaceId));
if(null==info.getType()){thrownewIllegalArgumentException("Coveragetypehasnotbeenset");
if(info.isEnabled()){//store'senabled,makesureitworksLOGGER.finer("Store"+info.getName()+"isenabled,verifyingfactoryavailability"+"beforesavingit...");AbstractGridFormatgridFormat=resourcePool.getGridCoverageFormat(info);
if(gridFormat==null){thrownewIllegalArgumentException("NogridformatfoundcapableofconnectingtotheprovidedURL."+"Tosavethestoredisableit,andchecktherequiredlibrariesareinplace");
else{//store'sdisabled,noneedtocheckforavailabilitydoSaveStore(info);doReturn(StorePage.class);
if(accepted){doReturn(StorePage.class);
if(close==null)return;try{closeIterator(close);
if(close!=null){close.close();
iftheiteratorwasworkingoffaFilethentheinputstreamshouldbe*closed.**<p>Subclassmustcallsuper.close(close)toallowthelistofopeniteratorstobe*adjusted.**@paramcloseIterator,willnotbe<code>null</code>*/protectedabstractvoidcloseIterator(Iterator<F>close);/***Closeanyoutstandingresourcesreleasedbythisresources.**<p>Thismethodshouldbeusedwithgreatcaution,itishoweveravailabletoallowtheuseof*theResourceCollectionwithalgorthimsthatareunawareoftheneedtocloseiteratorsafter*use.**<p>ExampleofusinganormalCollectionsutilitymethod:**<pre>*<code>*Collections.sort(collection);*collection.purge();*</code>*</pre>*/@SuppressWarnings("unchecked")publicvoidpurge(){for(Iteratori=open.iterator();i.hasNext();){Objectresource=i.next();
if(resourceinstanceofIterator){IteratorresourceIterator=(Iterator)resource;try{closeIterator(resourceIterator);
ifthe<tt>clear</tt>methodisnotsupportedbythis*collection.*/publicvoidclear(){Iterator<F>e=iterator();try{while(e.hasNext()){e.next();e.remove();
ifthiscollectioncontainsthespecifiedelement.<tt></tt>.**<p>Thisimplementationiteratesovertheelementsinthecollection,checkingeachelementin*turnforequalitywiththespecifiedelement.**@paramoobjecttobecheckedforcontainmentinthiscollection.*@return<tt>true</tt>
ifthiscollectioncontainsthespecifiedelement.*/publicbooleancontains(Objecto){Iterator<F>e=null;try{e=iterator();
if(o==null){while(e.hasNext())
if(e.next()==null)returntrue;
else{while(e.hasNext())
if(o.equals(e.next()))returntrue;
ifthiscollectioncontainsalloftheelementsinthespecified*collection.**<p>**@paramccollectiontobecheckedforcontainmentinthiscollection.*@return<tt>true</tt>
ifthiscollectioncontainsalloftheelementsinthespecified*collection.*@throwsNullPointerException
ifthespecifiedcollectionisnull.*@see#contains(Object)*/publicbooleancontainsAll(Collection<?>c){Iterator<?>e=c.iterator();try{while(e.hasNext())
if(!contains(e.next()))returnfalse;returntrue;
ifthiscollectioncontainsnoelements.*/publicbooleanisEmpty(){Iterator<F>iterator=iterator();try{return!iterator.hasNext();
if(a.length<size){a=(T2[])java.lang.reflect.Array.newInstance(a.getClass().getComponentType(),size);
if(a.length>size)a[size]=null;returna;
if(progress==null)progress=newNullProgressListener();try{floatsize=size();floatposition=0;progress.started();for(iterator=iterator();!progress.isCanceled()&&iterator.hasNext();){
if(size>0)progress.progress(position++/size);try{Featurefeature=(Feature)iterator.next();visitor.visit(feature);
if(fi!=null){fi.close();
if(bounds==null){bounds=re;
else{bounds.expandToInclude(re);
if(fi!=null){fi.close();
ifrequiredsettingsmissing@TestpublicvoidtestNoMetadataUrl()throwsException{finalServiceInfoserviceInfo=getServiceInfo();finalMetadataMapmetadata=serviceInfo.getMetadata();clearInspireMetadata(metadata);metadata.put(CREATE_EXTENDED_CAPABILITIES.key,true);metadata.put(SERVICE_METADATA_TYPE.key,getMetadataType());metadata.put(LANGUAGE.key,getLanguage());getGeoServer().save(serviceInfo);finalDocumentdom=getAsDOM(getGetCapabilitiesRequestPath());finalNodeListnodeList=dom.getElementsByTagNameNS(getInspireNameSpace(),"ExtendedCapabilities");assertEquals("NumberofINSPIREExtendedCapabilitieselements",0,nodeList.getLength());
iftheotherrequiredsettingsexistanddon't
iftheydon't@TestpublicvoidtestCreateExtCapMissingWithRequiredSettings()throwsException{finalServiceInfoserviceInfo=getServiceInfo();finalMetadataMapmetadata=serviceInfo.getMetadata();clearInspireMetadata(metadata);metadata.put(SERVICE_METADATA_URL.key,getMetadataUrl());metadata.put(SERVICE_METADATA_TYPE.key,getMetadataType());metadata.put(LANGUAGE.key,getLanguage());getGeoServer().save(serviceInfo);finalDocumentdom=getAsDOM(getGetCapabilitiesRequestPath());NodeListnodeList=dom.getElementsByTagNameNS(getInspireNameSpace(),"ExtendedCapabilities");assertEquals("NumberofINSPIREExtendedCapabilitieselements",1,nodeList.getLength());
if(iteratorinstanceofCloseableIterator){//don'tknowhowtoforcewickettoclosetheiterator,letsreturn//acopy.Shouldn'tbemuchoverheadaswe'repagingtry{returnLists.newArrayList(iterator).iterator();
else{returniterator;
if(workspace==null){filter=super.getFilter();
else{filter=ff.and(super.getFilter(),ff.equal(ff.property("resource.store.workspace.id"),ff.literal(workspace.getId()),true));
if(sort!=null){
if(propertyinstanceofBeanProperty){finalStringsortProperty=((BeanProperty<LayerInfo>)property).getPropertyPath();sortOrder=sortBy(sortProperty,sort.isAscending());
if(NAME==property){returnnewSimpleAjaxLink<String>(id,(IModel<String>)model){privatestaticfinallongserialVersionUID=-2968338284881141281L;@OverrideprotectedvoidonClick(AjaxRequestTargettarget){LayerInfolayer=(LayerInfo)itemModel.getObject();handleLayer(layer,target);
else{returnnewLabel(id,model);
if(insert==null){insert=conn.prepareStatement("INSERTINTOresources(name,parent,content)VALUES(?,?,?)");
if(rs.next()){returnrs.getInt(1);
else{thrownewIllegalStateException("Couldnotaddtestfile"+name);
if(rs.next()){returnrs.getInt(1);
else{thrownewIllegalStateException("Couldnotaddtestdirectory"+name);
ifthe//databaseisempty.JdbcDataSourceds=newJdbcDataSource();ds.setURL("jdbc:h2:mem:test");try(ConnectiontestConn=ds.getConnection()){try(ResultSetrs=testConn.getMetaData().getTables(null,null,null,newString[]{"TABLE"})){booleanresult=false;while(rs.next()){result=true;//System.out.printf("%s\n",rs.getString("TABLE_NAME"));
ifpossible)**@authorAndreaAime-GeoSolutions*/publicclassCollectGeometriesFunctionextendsFunctionImpl{longmaxCoordinates;publicCollectGeometriesFunction(Namename,List<Expression>args,Literalfallback,longmaxCoordinates){functionName=newFunctionNameImpl(name,args!=null?args.size():-1);setName(name.getLocalPart());setFallbackValue(fallback);setParameters(args);this.maxCoordinates=maxCoordinates;
if(args.size()!=1){thrownewIllegalArgumentException("CollectGeometriesfunctionrequiresasingle"+"argument,acollectionofgeometries");
if(geometries==null||geometries.size()==0){returnnewGeometryCollection(null,newGeometryFactory());
if(problematicObject!=null){setupPanel(Collections.singletonList(problematicObject));tester.assertRenderedPage(FormTestPage.class);tester.assertNoErrorMessage();assertTrue(labelTextForProblematicObjects().matches(getProblematicObjectRegExp()));tester.assertInvisible("form:panel:removedObjects");tester.assertVisible("form:panel:problematicObjects");
if(removeableObject!=null&&problematicObject!=null){List<T>objects=newArrayList<T>();objects.add(removeableObject);objects.add(problematicObject);setupPanel(objects);tester.assertRenderedPage(FormTestPage.class);tester.assertNoErrorMessage();assertTrue(labelTextForRemovedObjects().matches(getRemoveableObjectRegExp()));assertTrue(labelTextForProblematicObjects().matches(getProblematicObjectRegExp()));tester.assertVisible("form:panel:removedObjects");tester.assertVisible("form:panel:problematicObjects");
ifnolockisownedlocker.unlock();
if(!GeoServerUnlockablePage.class.isAssignableFrom(requestTarget)){LockTypetype=locker.getCurrentLock();
if(type!=null||requestTarget==null){return;
if(type==null){//lockreadmode,itwillbeupgradedtowriteassoon//asawriteoperationonthecatalogisattemptedlockTaken=locker.tryLock(LockType.READ);
iftheconfigurationislockedandthepageissafe...
if(cycle!=null&&!lockTaken){cycle.setResponsePage(ServerBusyPage.class);
iftherequestedtilehasalreadybeencomputed,
ifso,*it'llencodeandreturnthatone,otherwiseit'llbuildametatile,splitit,andfinallyencode*justtherequestedtile,puttingtheothersinthetilecache.**@authorAndreaAime-TOPP*@authorSimoneGiannecchini-GeoSolutions*/publicfinalclassMetatileMapOutputFormatimplementsGetMapOutputFormat{/**Aloggerforthisclass.*/privatestaticfinalLoggerLOGGER=Logging.getLogger(MetatileMapOutputFormat.class);/**Smallnumberfordoubleequalitycomparison*/publicstaticfinaldoubleEPS=1E-6;/***Thisvariableisusefortestingpurposesinordertoforcethis{@linkGridCoverageRenderer}*todumpimagesatvariousstepsonthedisk.*/privatestaticbooleanDEBUG=Boolean.valueOf(GeoServerExtensions.getProperty("org.geoserver.wms.map.MetatileMapOutputFormat.debug"));privatestaticStringDEBUG_DIR;static{
if(DEBUG){finalFiletempDir=newFile(GeoServerExtensions.getProperty("user.home"),".geoserver");
if(!tempDir.exists()){
if(!tempDir.mkdir())LOGGER.severe("Unabletocreatedebugdir,exitingapplication!!!");DEBUG=false;DEBUG_DIR=null;
else{DEBUG_DIR=tempDir.getAbsolutePath();LOGGER.fine("MetatileMapOutputFormatdebugdir"+DEBUG_DIR);
if(DEBUG_DIR==null)thrownewNullPointerException("Unabletowritetheprovidedcoverageinthedebugdirectory");
if(DEBUG==false)thrownewIllegalStateException("Unabletowritetheprovidedcoveragesincewearenotindebugmode");try{ImageIO.write(raster,"tiff",newFile(DEBUG_DIR,fileName+".tiff"));
if(tileCache==null){tileCache=(QuickTileCache)GeoServerExtensions.bean("metaTileCache");
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Lookedformetatile"+key.metaTileCoords.x+","+key.metaTileCoords.y+"incache:"+((tile!=null)?"hit!":"miss"));
if(tile==null){//computethemeta-tile
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Buildingmetatile"+key.metaTileCoords.x+","+key.metaTileCoords.y+"ofsizew="+key.getTileSize()*key.getMetaFactor()+",h="+key.getTileSize()*key.getMetaFactor()+"withmetatilignfactor"+key.getMetaFactor());
iftherequesthasthetiledhint,is256x256image,andtherawdelegateisaraster*one**@paramrequest*@paramdelegate*/publicstaticbooleanisRequestTiled(GetMapRequestrequest,GetMapOutputFormatdelegate){booleantiled=request.isTiled();Point2DtilesOrigin=request.getTilesOrigin();intwidth=request.getWidth();intheight=request.getHeight();
if(tiled&&tilesOrigin!=null&&width==256&&height==256&&delegateinstanceofRenderedImageMapOutputFormat){returntrue;
if(metaTileinstanceofPlanarImage){type=1;
else
if(metaTileinstanceofBufferedImage){type=2;
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Metatiletype"+type);
if(DEBUG){writeRenderedImage(metaTile,"metaTile");
switch(type){case0://RENDEREDIMAGE
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("MetatilesplitonRenderedImage");
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("MetatilesplitonPlanarImage");
if(wTile.getMinX()!=0||wTile.getMinY()!=0){tile=newBufferedImage(pImage.getColorModel(),(WritableRaster)wTile.createWritableTranslatedChild(0,0),pImage.getColorModel().isAlphaPremultiplied(),null);
else{tile=newBufferedImage(pImage.getColorModel(),wTile,pImage.getColorModel().isAlphaPremultiplied(),null);
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("MetatilesplitonBufferedImage");
if(DEBUG){writeRenderedImage(tile,"tile"+i+"-"+j);
ifnecessary/possibleRasterCleaner.addImage(metaTile);
if(exceptions==null){//usedefaultsuper.handleServiceException(exception,request);return;
if(JSONType.isJsonMimeType(exceptions)){//useJsonformatJSONType.handleJsonException(LOGGER,exception,request,charset,verbose,false);
else
if(JSONType.useJsonp(exceptions)){//useJsonPformatJSONType.handleJsonException(LOGGER,exception,request,charset,verbose,true);
else{super.handleServiceException(exception,request);
if(code==null){exception.setCode(WFSException.NO_APPLICABLE_CODE);
if(WFSException.OPERATION_PROCESSING_FAILED.equals(code)){response.setStatus(500);
else
if(WFSException.NOT_FOUND.equals(code)){response.setStatus(404);
else
if(WFSException.LOCK_HAS_EXPIRED.equals(code)){response.setStatus(403);
else{//allothercodesuse400response.setStatus(400);
ifnotset.*@uml.propertyname="latLonBoundingBox"*/ReferencedEnvelopegetLatLonBoundingBox();/***Setstheboundsoftheresourceinlat/lon.**@paramThelat/lonbounds.*@uml.propertyname="latLonBoundingBox"*/voidsetLatLonBoundingBox(ReferencedEnvelopebox);/***Returnstheboundsoftheresourceinthenativecrs.**<p>Thisvaluerepresentsa"fixedvalue"andisnotcalulatedontheunderlyingdataset.**@returnTheboundsoftheresourceinnativecrs.,or<code>null</code>
ifnotset.*@uml.propertyname="boundingBox"*/ReferencedEnvelopegetNativeBoundingBox();/***Setstheboundsoftheresourceinthenativecrs.**@paramThenativecrsbounds.*@uml.propertyname="boundingBox"*/voidsetNativeBoundingBox(ReferencedEnvelopebox);/***ReturnstheboundsoftheresourceinitsdeclaredCRS.**<p>Thisvalueisderivedfrom{@link#getNativeBoundingBox()},{@link#getCRS()},and{@link*#getProjectionPolicy()}.Inthecasewherethenativeboundingboxisunset,{@link*#getLatLonBoundingBox()}shouldbereprojectedto{@link#getCRS()}.Ifthereprojection*fails,nullshouldbereturned.Soclientscallingthismethodshouldbepreparedtohandle*null.**@throwsExceptionIftheboundingboxcannotbecalculated.*/ReferencedEnvelopeboundingBox()throwsException;/***Returnstheidentifierofcoordinatereferencesystemoftheresource.**<p>Srscanbeinmultipleforms,examples:**<ol>*</ol>**@returnAcrsidentifier,or<code>null</code>
ifnotset.*@uml.propertyname="sRS"*/StringgetSRS();/***Setstheidentifiercoordinatereferencesystemoftheresource.**@paramcrsTheidentifierofcordinatereferencesystem.*@uml.propertyname="sRS"*/voidsetSRS(Stringsrs);/**Thenativecoordinatereferencesystemobjectoftheresource.*/CoordinateReferenceSystemgetNativeCRS();/**Setsthenativecoordinatereferencesystemobjectoftheresource.*/voidsetNativeCRS(CoordinateReferenceSystemnativeCRS);/***Thecoordinatereferencesystemobjectfortheresource.**<p>Thisobjectisderivedfrom{@link#getSRS()}.*/CoordinateReferenceSystemgetCRS();/***Thepolicythatshouldbeusedwiththenativeprojectionoftheresourcewithrespecttothe*declareprojection.*/ProjectionPolicygetProjectionPolicy();/***Setsthepolicythatshouldbeusedwiththenativeprojectionoftheresourcewithrespect*tothedeclareprojection.*/voidsetProjectionPolicy(ProjectionPolicypolicy);/***Apersistentmapofmetadata.**<p>Datainthismapisintendedtobepersisted.Commoncaseofuseistohaveservices*associatevariousbitsofdatawithaparticularresource.Anexamplemightincludecaching*information.**<p>Thekeyvaluesofthismapareoftype{@linkString}andvaluesareoftype{@link*Serializable}.**@uml.propertyname="metadata"*/MetadataMapgetMetadata();/***Aflagindicating
iftheresourceisenabledornot.**@uml.propertyname="enabled"*/booleanisEnabled();/***DerivedpropertyindicatingwhetherboththisResourceInfoanditsStoreInfoareenabled.**<p>Notethisisaderivedpropertyandhencenotpartofthemodel.Consideritequalto*{@codegetStore()!=null&&getStore().isEnabled()&&this.isEnabled()}**@returnthechainedenabledstatusconsideringthisobjectandit'sStoreInfoparent*@see#getStore()*@seeStoreInfo#isEnabled()*/booleanenabled();/***Setstheenabledflagfortheresource.**@uml.propertyname="enabled"*/voidsetEnabled(booleanenabled);/***Thestoretheresourceisapartof.**@uml.propertyname="store"*@uml.associationEndinverse="resourceInfo:org.geoserver.catalog.StoreInfo"*/StoreInfogetStore();/***Setsthestoretheresourceisapartof.**@paramstoreThestoretoset.*@uml.propertyname="store"*/voidsetStore(StoreInfostore);/***Createsanadapterfortheresource.**<p>**@paramadapterClassTheclassoftheadapter.*@paramhintsHintstousewhencreatingtheadapter.*@returnTheadapter,anintsanceofadapterClass,or<code>null</code>.*/<TextendsObject>TgetAdapter(Class<T>adapterClass,Map<?,?>hints);/***Thehandletotheliveresource.**<p>ThismethoddoesI/Oandispotentiallyblocking.The<tt>listener</tt>isusedtoreport*theprogressofobtainingtheresourceandtoreportanywarnings/errorsthatoccurduring.**@uml.propertyname="resource"*@uml.associationEndinverse="resourceInfo:org.geoserver.catalog.Resource"*///ResourcegetResource(ProgressListenerlistener)throwsIOException;/***Returnstrue
iftheresourceexistenceshouldbeadvertised(truebydefault,unless*otherwiseset)*/booleanisAdvertised();/***Settotrue
iftheresourceshouldbeadvertised,falseotherwise**@paramadvertised*/voidsetAdvertised(booleanadvertised);}
ifitsina!DOCTYPE,removethe!DOCTYPEtag.");
if(validateSchema){//copyPOSTtoafile//maketempfiletemp=File.createTempFile("getMapPost","xml");FileOutputStreamfos=newFileOutputStream(temp);BufferedOutputStreamout=newBufferedOutputStream(fos);intc;while(-1!=(c=xml.read())){out.write(c);
if(entityResolver!=null){db.setEntityResolver(entityResolver);
if(!(nodeNameEqual(nodeGetMap,"getmap"))){
if(nodeNameEqual(nodeGetMap,"StyledLayerDescriptor"))//oopsy!!itsaSLDPOST//withgetparameters!{
if(validateSchema){validateSchemaSLD(temp,getMapRequest);
if(validateSchema){validateSchemaGETMAP(temp,getMapRequest);
if(wmsVersion==null){thrownewException("GetMapXMLparser-couldntfindattribute'version'inGetMaptag");
if(temp!=null){temp.delete();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(newStringBuffer("readingrequest:").append(getMapRequest).toString());
if(slCount==0){thrownewServiceException("SLDdocumentcontainsnolayers");
if(null==layerName){thrownewServiceException("AUserLayerwithoutlayernamewaspassed");
if((slinstanceofUserLayer)&&((((UserLayer)sl)).getInlineFeatureDatastore()!=null)){//SPECIALCASE-wemakethetemporaryversionUserLayerul=((UserLayer)sl);CoordinateReferenceSystemcrs=(getMapRequest.getCrs()==null)?DefaultGeographicCRS.WGS84:getMapRequest.getCrs();currLayer=initializeInlineFeatureLayer(ul,crs);addStyles(wms,getMapRequest,currLayer,styledLayers[i],layers,styles,filters);
else{LayerGroupInfolayerGroup=getWMS().getLayerGroupByName(layerName);
if(layerGroup!=null){List<LayerInfo>layerGroupLayers=layerGroup.layers();List<StyleInfo>layerGroupStyles=layerGroup.getStyles();for(intj=0;j<layerGroupStyles.size();j++){StyleInfosi=layerGroupStyles.get(j);LayerInfolayer=layerGroupLayers.get(j);currLayer=newMapLayerInfo(layer);
if(si!=null){currLayer.setStyle(si.getStyle());
else{LayerInfolayerInfo=getWMS().getLayerByName(layerName);
if(layerInfo==null){thrownewServiceException("Layernotfound:"+layerName);
if(currLayer==null){return;//protection
if(layerinstanceofNamedLayer){ftcs=((NamedLayer)layer).getLayerFeatureConstraints();layerStyles=((NamedLayer)layer).getStyles();
if(shouldUseLayerStyle(layerStyles,currLayer)){layerStyles=newStyle[]{currLayer.getStyle()};
else
if(layerinstanceofUserLayer){ftcs=((UserLayer)layer).getLayerFeatureConstraints();layerStyles=((UserLayer)layer).getUserStyles();
if(ftcs!=null){FeatureTypeConstraintftc;finalintlength=ftcs.length;for(intt=0;t<length;t++){ftc=ftcs[t];
if(ftc.getFeatureTypeName()!=null){Stringftc_name=ftc.getFeatureTypeName();//takenfromliterendererbooleanmatches;try{finalFeatureTypecurrSchema=currLayer.getFeature().getFeatureType();matches=currSchema.getName().getLocalPart().equalsIgnoreCase(ftc_name)||FeatureTypes.isDecendedFrom(currSchema,null,ftc_name);
if(!matches){continue;//thislayerisfilteredout
if(ftc.getFilter()!=null){filters.add(ftc.getFilter());
if((layerStyles==null)||(layerStyles.length==0)){layers.add(currLayer);styles.add(currLayer.getDefaultStyle());return;
if(layerStyles[t]instanceofNamedStyle){layers.add(currLayer);StringstyleName=((NamedStyle)layerStyles[t]).getName();s=wms.getStyleByName(styleName);
if(s==null){thrownewServiceException("couldntfindstylenamed'"+styleName+"'");
else{
if(wms.isDynamicStylingDisabled()){thrownewServiceException("Dynamicstyleusageisforbidden");
ifweshouldusethestylefromthelayerinfoorfromthegivenset*ofstylesfromtherequest.**@paramlayerStyles*@paramcurrLayer*/privatestaticbooleanshouldUseLayerStyle(Style[]layerStyles,MapLayerInfocurrLayer){booleannoSldLayerStyles=(layerStyles==null||layerStyles.length==0);booleanlayerHasStyle=currLayer.getStyle()!=null;booleanshouldUseLayerStyle=noSldLayerStyles&&layerHasStyle;returnshouldUseLayerStyle;
iftheydidn'tputan"srsName"ontheirgeometryintheir//inlinefeature?//Iguessweshouldassumetheymeantheirgeometrytoexistinthe//outputSRSofthe//requestthey'remaking.
if(ul.getInlineFeatureType().getCoordinateReferenceSystem()==null){LOGGER.warning("NoCRSsetoninlinefeaturesdefaultgeometry."+"AssumingtherequestorhastheirinlinefeaturesintheboundingboxCRS.");SimpleFeatureTypecurrFt=ul.getInlineFeatureType();Queryq=newQuery(currFt.getTypeName(),Filter.INCLUDE);FeatureReader<SimpleFeatureType,SimpleFeature>ilReader;ilReader=inlineDatastore.getFeatureReader(q,Transaction.AUTO_COMMIT);ForceCoordinateSystemFeatureReaderreader=newForceCoordinateSystemFeatureReader(ilReader,requestCrs);MemoryDataStorereTypedDS=newMemoryDataStore(reader);source=reTypedDS.getFeatureSource(reTypedDS.getTypeNames()[0]);
else{source=inlineDatastore.getFeatureSource(inlineDatastore.getTypeNames()[0]);
if(bboxNode==null){thrownewException("GetMapXMLparser-couldntfindnode'BoundingBox'inGetMaptag");
if(coordList.size()!=2){thrownewException("GetMapXMLparser-node'BoundingBox'inGetMaptagshouldhave2coordinatesinit");
if(srsNode!=null){Stringsrs=srsNode.getNodeValue();StringepsgCode=srs.substring(srs.indexOf('#')+1);epsgCode="EPSG:"+epsgCode;try{CoordinateReferenceSystemmapcrs=CRS.decode(epsgCode);getMapRequest.setCrs(mapcrs);getMapRequest.setSRS(epsgCode);
if(outputNode==null){thrownewException("GetMapXMLparser-couldntfindnode'Output'inGetMaptag");
if(format==null){thrownewException("GetMapXMLparser-couldntfindnode'Format'inGetMap/Outputtag");
if(trans!=null){
if(trans.equalsIgnoreCase("false")||trans.equalsIgnoreCase("0")){getMapRequest.setTransparent(false);
else{getMapRequest.setTransparent(true);
if(bufferValue==null){//fallbackonthealiasgetNodeValue(outputNode,"Radius");
if(bufferValue!=null){getMapRequest.setBuffer(Integer.parseInt(bufferValue));
if(bgColor!=null){getMapRequest.setBgColor(Color.decode(bgColor));
if(sizeNode==null){thrownewException("GetMapXMLparser-couldntfindnode'Size'inGetMap/Outputtag");
if(width==null){thrownewException("GetMapXMLparser-couldntfindnode'Width'inGetMap/Output/Sizetag");
if(height==null){thrownewException("GetMapXMLparser-couldntfindnode'Height'inGetMap/Output/Sizetag");
if((child==null)||(child.getNodeType()!=Node.ELEMENT_NODE)){continue;
if(childName==null){childName=child.getNodeName();
if(childName.equalsIgnoreCase(wantedChildName)){returnchild;
if((child==null)||(child.getNodeType()!=Node.ELEMENT_NODE)){continue;
if(childName==null){childName=child.getNodeName();
if(childName.equalsIgnoreCase(wantedChildName)){returnchild.getChildNodes().item(0).getNodeValue();
ifthisnodeisnamed"name".Ignorescaseandnamespaces.**@paramn*@paramname*/publicbooleannodeNameEqual(Noden,Stringname){
if(n.getNodeName().equalsIgnoreCase(name)){returntrue;
if(idx==-1){returnfalse;
if(nname.substring(idx+1).equalsIgnoreCase(name)){returntrue;
ifthexmlstartswithStyledLayerDescriptorDon'tuseona*GetMap.**@paramf*@paramgetMapRequest*@throwsServiceException*/publicvoidvalidateSchemaSLD(Filef,GetMapRequestgetMapRequest)throwsException{SLDValidatorvalidator=newSLDValidator();Listerrors=null;try{FileInputStreamin=null;try{in=newFileInputStream(f);errors=validator.validateSLD(in);
if(in!=null){in.close();
if(errors.size()!=0){in=newFileInputStream(f);thrownewServiceException(SLDValidator.getErrorMessage(in,errors));
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,msg,e);
ifthexmlstartswithGetMapDon'tuseonaSLD.**@paramf*@paramgetMapRequest*@throwsServiceException*/publicvoidvalidateSchemaGETMAP(Filef,GetMapRequestgetMapRequest)throwsException{GETMAPValidatorvalidator=newGETMAPValidator();Listerrors=null;try{FileInputStreamin=null;try{in=newFileInputStream(f);errors=validator.validateGETMAP(in);
if(in!=null){in.close();
if(errors.size()!=0){in=newFileInputStream(f);thrownewServiceException(GETMAPValidator.getErrorMessage(in,errors));
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,msg,e);
if(mosaicRoot.exists()){FileUtils.deleteDirectory(mosaicRoot);
ifwecanrunthetestsAssume.assumeTrue(GdalTestUtil.isGdalAvailable());//thecoverageresponsedelegategdalCovRespDelegate=newGdalCoverageResponseDelegate(newGeoServerImpl(),newGdalWrapperFactory());//adddefaultformatsfor(Formatformat:GdalConfigurator.DEFAULT.getFormats()){gdalCovRespDelegate.addFormat(format);
if(tempFile!=null){tempFile.delete();
if(tempFile!=null){tempFile.delete();
if(applicationStatus.isEmpty()){thrownewRestException("Nosuchmodule:"+target,HttpStatus.NOT_FOUND);
if(objinstanceofList){//weexpectListofModuleStatusList<?>list=(List<?>)obj;SimpleHashhash=newSimpleHash();hash.put("values",newCollectionModel(list,newBeansWrapper(){publicTemplateModelwrap(Objectobject)throwsTemplateModelException{
if(objectinstanceofModuleStatus){ModuleStatusstatus=(ModuleStatus)object;SimpleHashhash=newSimpleHash();hash.put("module",status.getModule());hash.put("name",status.getName());hash.put("isAvailable",Boolean.toString(status.isAvailable()));hash.put("isEnabled",Boolean.toString(status.isEnabled()));status.getComponent().ifPresent(component->hash.put("component",component));status.getVersion().ifPresent(version->hash.put("version",version));//Makesuretoescapethestring,otherwisestrange//charsherewillborktheXMLparserlaterstatus.getMessage().ifPresent(message->{StringnoControlChars=message.replaceAll("\u001b","ESC").replaceAll("\u0008","BACK").replaceAll("\u0007","BELL");Stringescaped=StringEscapeUtils.escapeXml(noControlChars).replaceAll("\n","<br/>");hash.put("message",escaped);});returnhash;
if(schemaLocationParts[i].equals(namespace)){assertTrue(schemaLocationParts[i+1].equals(url));
if(mediaType==null){assertEquals("NumberofMediaTypeelements",0,nodeList.getLength());
else{assertEquals("NumberofMediaTypeelements",1,nodeList.getLength());assertEquals("MediaType",mediaType,((Element)nodeList.item(0)).getFirstChild().getNodeValue());
if(expectedNamespace==null){assertEquals("NumberofNamespaceelementsforidentifierwithcode"+code,0,nodeList.getLength());
else{assertEquals("NumberofNamespaceelementsforidentifierwithcode"+code,1,nodeList.getLength());StringactualNamespace=((Element)nodeList.item(0)).getFirstChild().getNodeValue();assertEquals("Namespaceforidentifierwithcode"+code,expectedNamespace,actualNamespace);
if(expectedMetadataUrl==null){expectedMetadataUrl="";
if(scaleFactor<=0){thrownewWCS20Exception("Invalidscalefactor",WCS20Exception.WCS20ExceptionCode.InvalidScaleFactor,String.valueOf(scaleFactor));
ifwedon'tscale
if(scaleFactor==1){//NOSCALINGdoweneedinterpolation?
if(interpolationinstanceofInterpolationNearest){returnsourceGC;
else{//interpolatecoverage
ifrequestedandnotnearest!!!!finalOperationoperation=CoverageProcessor.getInstance().getOperation("Warp");finalParameterValueGroupparameters=operation.getParameters();parameters.parameter("Source").setValue(sourceGC);parameters.parameter("warp").setValue(newWarpAffine(AffineTransform.getScaleInstance(1,1)));//identityparameters.parameter("interpolation").setValue(interpolation);parameters.parameter("backgroundValues").setValue(CoverageUtilities.getBackgroundValues(sourceGC));//TODOcheckand//improvereturn(GridCoverage2D)CoverageProcessor.getInstance(hints).doOperation(parameters,hints);
if(sizeY==sourceGE.width&&sizeX==sourceGE.height){//NOSCALINGdoweneedinterpolation?
if(interpolationinstanceofInterpolationNearest){returnsourceGC;
else{//interpolatecoverage
ifrequestedandnotnearest!!!!finalOperationoperation=CoverageProcessor.getInstance().getOperation("Warp");finalParameterValueGroupparameters=operation.getParameters();parameters.parameter("Source").setValue(sourceGC);parameters.parameter("warp").setValue(newWarpAffine(AffineTransform.getScaleInstance(1,1)));//identityparameters.parameter("interpolation").setValue(interpolation);parameters.parameter("backgroundValues").setValue(CoverageUtilities.getBackgroundValues(sourceGC));//TODOcheckand//improvereturn(GridCoverage2D)CoverageProcessor.getInstance().doOperation(parameters,hints);
if(axisName.equals("http://www.opengis.net/def/axis/OGC/1/i")||axisName.equals("i")){xExtent=axisExtentType;
else
if(axisName.equals("http://www.opengis.net/def/axis/OGC/1/j")||axisName.equals("j")){yExtent=axisExtentType;
else{//TODOremovewhensupportingTIMEandELEVATIONthrownewWCS20Exception("ScaleAxisUndefined",WCS20Exception.WCS20ExceptionCode.ScaleAxisUndefined,axisName);
if(xExtent==null){thrownewWCS20Exception("Missingextentalongi",WCS20Exception.WCS20ExceptionCode.InvalidExtent,"Null");
if(yExtent==null){thrownewWCS20Exception("Missingextentalongj",WCS20Exception.WCS20ExceptionCode.InvalidExtent,"Null");
if(minx>=maxx){thrownewWCS20Exception("InvalidExtentfordimension:"+targetAxisExtentElements.get(0).getAxis(),WCS20Exception.WCS20ExceptionCode.InvalidExtent,String.valueOf(maxx));
if(miny>=maxy){thrownewWCS20Exception("InvalidExtentfordimension:"+targetAxisExtentElements.get(1).getAxis(),WCS20Exception.WCS20ExceptionCode.InvalidExtent,String.valueOf(maxy));
if(destinationRectangle.equals(sourceGE)){//NOSCALINGdoweneedinterpolation?
if(interpolationinstanceofInterpolationNearest){returnsourceGC;
else{//interpolatecoverage
ifrequestedandnotnearest!!!!finalOperationoperation=CoverageProcessor.getInstance().getOperation("Warp");finalParameterValueGroupparameters=operation.getParameters();parameters.parameter("Source").setValue(sourceGC);parameters.parameter("warp").setValue(newWarpAffine(AffineTransform.getScaleInstance(1,1)));//identityparameters.parameter("interpolation").setValue(interpolation);parameters.parameter("backgroundValues").setValue(CoverageUtilities.getBackgroundValues(sourceGC));//TODOcheckand//improvereturn(GridCoverage2D)CoverageProcessor.getInstance(hints).doOperation(parameters,hints);
if(scaleFactorX==1.0&&scaleFactorY==1.0){//NOSCALINGdoweneedinterpolation?
if(interpolationinstanceofInterpolationNearest){returnsourceGC;
else{//interpolatecoverage
ifrequestedandnotnearest!!!!finalOperationoperation=CoverageProcessor.getInstance().getOperation("Warp");finalParameterValueGroupparameters=operation.getParameters();parameters.parameter("Source").setValue(sourceGC);parameters.parameter("warp").setValue(newWarpAffine(AffineTransform.getScaleInstance(1,1)));//identityparameters.parameter("interpolation").setValue(interpolation);parameters.parameter("backgroundValues").setValue(CoverageUtilities.getBackgroundValues(sourceGC));//TODOcheckand//improvereturn(GridCoverage2D)CoverageProcessor.getInstance(hints).doOperation(parameters,hints);
if(scaling!=null){
if(scaling.getScaleAxesByFactor()!=null){returnScaleAxesByFactor;
if(scaling.getScaleByFactor()!=null){returnScaleByFactor;
if(scaling.getScaleToExtent()!=null){returnScaleToExtent;
if(scaling.getScaleToSize()!=null){returnScaleToSize;
if(scaling.getScaleToSize()!=null){finalScaleToSizeTypescaleType=scaling.getScaleToSize();finalEList<TargetAxisSizeType>targetAxisSizeElements=scaleType.getTargetAxisSize();TargetAxisSizeTypexSize=null,ySize=null;for(TargetAxisSizeTypeaxisSizeType:targetAxisSizeElements){finalStringaxisName=axisSizeType.getAxis();
if(axisName.equals("http://www.opengis.net/def/axis/OGC/1/i")||axisName.equals("i")){xSize=axisSizeType;
else
if(axisName.equals("http://www.opengis.net/def/axis/OGC/1/j")||axisName.equals("j")){ySize=axisSizeType;
else{//TODOremovewhensupportingTIMEandELEVATIONthrownewWCS20Exception("ScaleAxisUndefined",WCS20Exception.WCS20ExceptionCode.ScaleAxisUndefined,axisName);
if(sizeX<=0){thrownewWCS20Exception("Invalidtargetsize",WCS20Exception.WCS20ExceptionCode.InvalidExtent,Integer.toString(sizeX));
if(sizeY<=0){thrownewWCS20Exception("Invalidtargetsize",WCS20Exception.WCS20ExceptionCode.InvalidExtent,Integer.toString(sizeY));
else
if(scaling.getScaleToExtent()!=null){ScaleToExtentTypeste=scaling.getScaleToExtent();TargetAxisExtentTypexSize=null,ySize=null;for(TargetAxisExtentTypeaxisSizeType:ste.getTargetAxisExtent()){finalStringaxisName=axisSizeType.getAxis();
if(axisName.equals("http://www.opengis.net/def/axis/OGC/1/i")||axisName.equals("i")){xSize=axisSizeType;
else
if(axisName.equals("http://www.opengis.net/def/axis/OGC/1/j")||axisName.equals("j")){ySize=axisSizeType;
else{//TODOremovewhensupportingTIMEandELEVATIONthrownewWCS20Exception("ScaleAxisUndefined",WCS20Exception.WCS20ExceptionCode.ScaleAxisUndefined,axisName);
if(sizeX<=0){thrownewWCS20Exception("Invalidtargetextent,highisgreaterthanlow",WCS20Exception.WCS20ExceptionCode.InvalidExtent,Integer.toString((int)xSize.getHigh()));
if(sizeY<=0){thrownewWCS20Exception("Invalidtargetextent,highisgreaterthanlow",WCS20Exception.WCS20ExceptionCode.InvalidExtent,Integer.toString((int)ySize.getHigh()));
else{thrownewIllegalArgumentException("targesizecannotbecomputedfromthistypeofscaling:"+getPolicy(scaling));
switch(policy){caseScaleByFactor:finalScaleByFactorTypescaleByFactorType=scaling.getScaleByFactor();doublescaleFactor=scaleByFactorType.getScaleFactor();returnnewdouble[]{scaleFactor,scaleFactor};caseScaleAxesByFactor:finalScaleAxisByFactorTypescaleType=scaling.getScaleAxesByFactor();finalEList<ScaleAxisType>targetAxisScaleElements=scaleType.getScaleAxis();ScaleAxisTypexScale=null,yScale=null;for(ScaleAxisTypescaleAxisType:targetAxisScaleElements){finalStringaxisName=scaleAxisType.getAxis();
if(axisName.equals("http://www.opengis.net/def/axis/OGC/1/i")||axisName.equals("i")){xScale=scaleAxisType;
else
if(axisName.equals("http://www.opengis.net/def/axis/OGC/1/j")||axisName.equals("j")){yScale=scaleAxisType;
else{//TODOremovewhensupportingTIMEandELEVATIONthrownewWCS20Exception("ScaleAxisUndefined",WCS20Exception.WCS20ExceptionCode.ScaleAxisUndefined,axisName);
if(xScale==null){thrownewWCS20Exception("Missingscalefactoralongi",WCS20Exception.WCS20ExceptionCode.InvalidScaleFactor,"Null");
if(yScale==null){thrownewWCS20Exception("Missingscalefactoralongj",WCS20Exception.WCS20ExceptionCode.InvalidScaleFactor,"Null");
if(scaleFactorX<=0){thrownewWCS20Exception("Invalidscalefactor",WCS20Exception.WCS20ExceptionCode.InvalidScaleFactor,Double.toString(scaleFactorX));
if(scaleFactorY<=0){thrownewWCS20Exception("Invalidscalefactor",WCS20Exception.WCS20ExceptionCode.InvalidScaleFactor,Double.toString(scaleFactorY));
if(hints!=null&&hints.containsKey(GetCoverage.PRE_APPLIED_SCALE)){Double[]preAppliedScale=(Double[])hints.get(GetCoverage.PRE_APPLIED_SCALE);
if(preAppliedScale!=null){scaleFactors[0]=scaleFactors[0]*preAppliedScale[0];scaleFactors[1]=scaleFactors[1]*preAppliedScale[1];
if(!ImageUtilities.isMediaLibAvailable()){//Ifmedialibaccelerationisnotavailable,thetestisnotneededAssert.assertTrue(true);return;
ifenabledPalettep;Collectionjaiext;Objectfactory;booleanisJAIExtEnabled=ImageWorker.isJaiExtEnabled();
if(isJAIExtEnabled){tester.assertComponent("form:jaiext",JAIEXTPanel.class);tester.assertComponent("form:jaiext:jaiextOps",Palette.class);p=(Palette)tester.getComponentFromLastRenderedPage("form:jaiext:jaiextOps");jaiext=p.getChoices();assertNotNull(jaiext);//JAIchoicesassertTrue(!jaiext.contains("Warp"));
else{tester.assertInvisible("form:jaiext");
if(isJAIExtEnabled){Assert.assertTrue(info.isAllowNativeWarp());//Ensurethefactoryiscorrectlyregisteredfactory=info.getJAI().getOperationRegistry().getFactory(RenderedRegistryMode.MODE_NAME,"Warp");Assert.assertTrue(factoryinstanceofMlibWarpRIF);
else{Assert.assertFalse(info.isAllowNativeWarp());factory=info.getJAI().getOperationRegistry().getFactory(RenderedRegistryMode.MODE_NAME,"Warp");Assert.assertTrue(factoryinstanceofWarpRIF);
if(isJAIExtEnabled){tester.assertComponent("form:jaiext",JAIEXTPanel.class);tester.assertComponent("form:jaiext:jaiextOps",Palette.class);p=(Palette)tester.getComponentFromLastRenderedPage("form:jaiext:jaiextOps");jaiext=p.getChoices();assertNotNull(jaiext);//JAIchoicesassertTrue(!jaiext.contains("Warp"));
if(wrappedinstanceofSimpleFeatureLocking){returnnewRetypingFeatureLocking((SimpleFeatureLocking)wrapped,map);
else
if(wrappedinstanceofSimpleFeatureStore){returnnewRetypingFeatureStore((SimpleFeatureStore)wrapped,map);
else{returnnewRetypingFeatureSource(wrapped,map);
if(typeMap.getOriginalName().equals(originalName)){//renamereturntypeMap.getName();
else
if(typeMap.getName().equals(originalName)){//hidereturnnull;
else{returnoriginalName;
if(typeMap.getOriginalName().equals(original)){returntypeMap.featureType;
else{returnsuper.transformFeatureType(original);
if(wrapper!=null){wrapped.removeFeatureListener(wrapper);listeners.remove(listener);
ifweusethistoshaveattributestoo,butthisis//notinthescopenowreturnwrapped.getBounds();
ifweusethistoshaveattributestoo,butthisis//notinthescopenowreturnwrapped.getBounds(store.retypeQuery(query,typeMap));
if(query.getTypeName()==null){query=newQuery(query);((Query)query).setTypeName(typeMap.getName());
else
if(!typeMap.getName().equals(query.getTypeName())){thrownewIOException("Cannotquerythisfeaturesourcewith"+query.getTypeName()+"sinceitservesonly"+typeMap.getName());
ifthequeryspecifiesasubsetofpropertynamesweneedtotakethatinto//accountSimpleFeatureTypetarget=typeMap.getFeatureType(query);returnnewRetypingFeatureCollection(wrapped.getFeatures(store.retypeQuery(query,typeMap)),target);
if(geoServer!=null){BooleanexternalEntitiesEnabled=geoServer.getGlobal().isXmlExternalEntitiesEnabled();
if(externalEntitiesEnabled!=null&&externalEntitiesEnabled){//XMLparserwilltrytoresolveentitiesreturnnull;
if(layerName==null){returnwrapList(newArrayList(),ArrayList.class);
if(type!=null){
if(type.equalsIgnoreCase(COLORMAP_TYPE.INTERVALS.toString())){colormapType=ColorMap.TYPE_INTERVALS;
else
if(type.equalsIgnoreCase(COLORMAP_TYPE.VALUES.toString())){colormapType=ColorMap.TYPE_VALUES;
if(min==max)min=min-Double.MIN_VALUE;LayerInfolayerInfo=catalog.getLayerByName(layerName);
if(layerInfo!=null){ResourceInfoobj=layerInfo.getResource();/*Check
ifit'sfeaturetypeorcoverage*/
if(objinstanceofCoverageInfo){CoverageInfocvInfo;cvInfo=(CoverageInfo)obj;StyleInfodefaultStyle=layerInfo.getDefaultStyle();RasterSymbolizerrasterSymbolizer=getRasterSymbolizer(defaultStyle);
if(rasterSymbolizer==null){thrownewInvalidSymbolizer();
if(classes>0){finalString[]labels=newString[classes+1];finaldouble[]quantities=newdouble[classes+1];ColorRampcolorRamp=null;quantities[0]=min-DEFAULT_MIN_DECREMENT;
if(colorMapType==ColorMap.TYPE_INTERVALS){max=max+DEFAULT_MIN_DECREMENT;min=min+DEFAULT_MIN_DECREMENT;
switch(ramp){caseRED:colorRamp=newRedColorRamp();break;caseBLUE:colorRamp=newBlueColorRamp();break;caseGRAY:colorRamp=newGrayColorRamp();break;caseJET:colorRamp=newJetColorRamp();break;caseRANDOM:colorRamp=newRandomColorRamp();break;caseCUSTOM:colorRamp=newCustomColorRamp();CustomColorRampcustomRamp=(CustomColorRamp)colorRamp;
if(startColor!=null){customRamp.setStartColor(Color.decode(startColor));
if(endColor!=null){customRamp.setEndColor(Color.decode(endColor));
if(midColor!=null){customRamp.setMid(Color.decode(midColor));
else{returndefaultStyle.getStyle();
if(syminstanceofRasterSymbolizer){rasterSymbolizer=(RasterSymbolizer)sym;break;
if(rasterSymbolizer!=null)break;
if(rasterSymbolizer!=null)break;
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"Thefollowingexceptionhasoccurred"+e.getLocalizedMessage(),e);returnnull;
if(slicePoint!=null){selectedValues.add(slicePoint);returntrue;
if(l!=null&&h!=null){
if(l>h){throwInvalidRangeException(low,high);
if(slicePoint!=null){selectedValues.add(slicePoint);returntrue;
if(l!=null&&h!=null){
if(l>h){throwInvalidRangeException(low,high);
if(slicePoint!=null){selectedValues.add(slicePoint);returntrue;
if(l!=null&&h!=null){
if(l.compareTo(h)>0){throwInvalidRangeException(low,high);
ifimpossible.**@paramtext*/publicstaticDoubleparseAsDouble(Stringtext){try{finalDoubleslicePoint=XML_CONVERTER.parseDouble(text);returnslicePoint;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(text+"can'tbeparsedasanDouble.");
ifimpossible.**@paramtext*/publicstaticNumberRange<Double>parseAsDoubleRange(Stringtext){try{
if(text.contains("/")){String[]range=text.split("/");
if(range.length==2){Stringmin=range[0];Stringmax=range[1];finalDoubleminValue=XML_CONVERTER.parseDouble(min);finalDoublemaxValue=XML_CONVERTER.parseDouble(max);returnnewNumberRange<Double>(Double.class,minValue,maxValue);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(text+"can'tbeparsedasanDouble.");
ifimpossible.**@paramtext*/publicIntegerparseAsInteger(Stringtext){try{finalIntegerslicePoint=XML_CONVERTER.parseInt(text);returnslicePoint;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(text+"can'tbeparsedasanInteger.");
ifimpossible.**@paramtext*/publicstaticDateparseAsDate(Stringtext){try{finalDateslicePoint=XML_CONVERTER.parseDateTime(text).getTime();
if(slicePoint!=null){returnslicePoint;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(text+"can'tbeparsedasatime");
if(domainDatatype.endsWith("Timestamp")||domainDatatype.endsWith("Date")){setAsDate(slicePointS,selectedValues);
else
if(domainDatatype.endsWith("Integer")){setAsInteger(slicePointS,selectedValues);
else
if(domainDatatype.endsWith("Double")){setAsDouble(slicePointS,selectedValues);
else
if(domainDatatype.endsWith("String")){selectedValues.add(slicePointS);
if(domainDatatype.endsWith("Timestamp")||domainDatatype.endsWith("Date")){setAsDateRange(low,high,selectedValues);
else
if(domainDatatype.endsWith("Integer")){setAsIntegerRange(low,high,selectedValues);
else
if(domainDatatype.endsWith("Double")){setAsDoubleRange(low,high,selectedValues);
else
if(domainDatatype.endsWith("String")){selectedValues.add(low+"/"+high);//TODOCheckme
if(iteminstanceofNumber){Doublenumber=(Double)item;results.add(number);
else
if(iteminstanceofNumberRange){NumberRangerange=(NumberRange)item;results.add(range.getMinimum());results.add(range.getMaximum());
else{thrownewIllegalArgumentException("Thespecifieddomainsetdoesn'tcontainNumberorNumberRangeinstances");
if(!hasNext()){thrownewNoSuchElementException();
if(keywords!=null){for(KeywordInfokw:keywords){values.add(kw.getValue());
if(nativeBox==null){//backprojectfromlatlontry{nativeBox=getLatLonBoundingBox().transform(declaredCRS,true);
if(!CRS.equalsIgnoreMetadata(declaredCRS,nativeCRS)&&php==ProjectionPolicy.REPROJECT_TO_DECLARED){result=nativeBox.transform(declaredCRS,true);
else
if(php==ProjectionPolicy.FORCE_DECLARED){result=ReferencedEnvelope.create((Envelope)nativeBox,declaredCRS);
else{result=nativeBox;
if(getSRS()==null){returnnull;
if(this.advertised!=null){returnadvertised;
if(md==null){returntrue;
if(metadataAdvertised==null){metadataAdvertised=true;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofResourceInfo))returnfalse;finalResourceInfoother=(ResourceInfo)obj;
if(id==null){
if(other.getId()!=null)returnfalse;
else
if(!id.equals(other.getId()))returnfalse;
if(_abstract==null){
if(other.getAbstract()!=null)returnfalse;
else
if(!_abstract.equals(other.getAbstract()))returnfalse;
if(alias==null){
if(other.getAlias()!=null)returnfalse;
else
if(!alias.equals(other.getAlias()))returnfalse;
if(description==null){
if(other.getDescription()!=null)returnfalse;
else
if(!description.equals(other.getDescription()))returnfalse;
if(enabled!=other.isEnabled())returnfalse;
if(keywords==null){
if(other.getKeywords()!=null)returnfalse;
else
if(!keywords.equals(other.getKeywords()))returnfalse;
if(latLonBoundingBox==null){
if(other.getLatLonBoundingBox()!=null)returnfalse;
else
if(!latLonBoundingBox.equals(other.getLatLonBoundingBox()))returnfalse;
if(metadataLinks==null){
if(other.getMetadataLinks()!=null)returnfalse;
else
if(!metadataLinks.equals(other.getMetadataLinks()))returnfalse;
if(name==null){
if(other.getName()!=null)returnfalse;
else
if(!name.equals(other.getName()))returnfalse;
if(namespace==null){
if(other.getNamespace()!=null)returnfalse;
else
if(!namespace.equals(other.getNamespace()))returnfalse;
if(nativeBoundingBox==null){
if(other.getNativeBoundingBox()!=null)returnfalse;
else
if(!nativeBoundingBox.equals(other.getNativeBoundingBox()))returnfalse;
if(nativeCRS==null){
if(other.getNativeCRS()!=null)returnfalse;
else
if(!CRS.equalsIgnoreMetadata(nativeCRS,other.getNativeCRS()))returnfalse;
if(nativeName==null){
if(other.getNativeName()!=null)returnfalse;
else
if(!nativeName.equals(other.getNativeName()))returnfalse;
if(projectionPolicy==null){
if(other.getProjectionPolicy()!=null)returnfalse;
else
if(!projectionPolicy.equals(other.getProjectionPolicy()))returnfalse;
if(srs==null){
if(other.getSRS()!=null)returnfalse;
else
if(!srs.equals(other.getSRS()))returnfalse;
if(store==null){
if(other.getStore()!=null)returnfalse;
else
if(!store.equals(other.getStore()))returnfalse;
if(title==null){
if(other.getTitle()!=null)returnfalse;
else
if(!title.equals(other.getTitle()))returnfalse;returntrue;}}
ifrequiredsettingsmissing@TestpublicvoidtestNoMetadataUrl()throwsException{finalServiceInfoserviceInfo=getGeoServer().getService(WFSInfo.class);finalMetadataMapmetadata=serviceInfo.getMetadata();clearInspireMetadata(metadata);metadata.put(CREATE_EXTENDED_CAPABILITIES.key,true);metadata.put(SERVICE_METADATA_TYPE.key,"application/vnd.iso.19139+xml");metadata.put(LANGUAGE.key,"fre");metadata.put(SPATIAL_DATASET_IDENTIFIER_TYPE.key,"one,http://www.geoserver.org/one;two,http://www.geoserver.org/two,http://metadata.geoserver.org/id?two");getGeoServer().save(serviceInfo);finalDocumentdom=getAsDOM(WFS_2_0_0_GETCAPREQUEST);finalNodeListnodeList=dom.getElementsByTagNameNS(DLS_NAMESPACE,"ExtendedCapabilities");assertEquals("NumberofINSPIREExtendedCapabilitieselements",0,nodeList.getLength());
iftheotherrequiredsettingsexistanddon't
iftheydon't@TestpublicvoidtestCreateExtCapMissingWithRequiredSettings()throwsException{finalServiceInfoserviceInfo=getGeoServer().getService(WFSInfo.class);finalMetadataMapmetadata=serviceInfo.getMetadata();clearInspireMetadata(metadata);metadata.put(SERVICE_METADATA_URL.key,"http://foo.com?bar=baz");metadata.put(SERVICE_METADATA_TYPE.key,"application/vnd.iso.19139+xml");metadata.put(LANGUAGE.key,"fre");metadata.put(SPATIAL_DATASET_IDENTIFIER_TYPE.key,"one,http://www.geoserver.org/one");getGeoServer().save(serviceInfo);finalDocumentdom=getAsDOM(WFS_2_0_0_GETCAPREQUEST);NodeListnodeList=dom.getElementsByTagNameNS(DLS_NAMESPACE,"ExtendedCapabilities");assertEquals("NumberofINSPIREExtendedCapabilitieselements",1,nodeList.getLength());
if(backupExecution.getStatus()==BatchStatus.ABANDONED||backupExecution.getStatus()==BatchStatus.FAILED||backupExecution.getStatus()==BatchStatus.UNKNOWN){for(Throwableexception:backupExecution.getAllFailureExceptions()){LOGGER.log(Level.INFO,"ERROR:"+exception.getLocalizedMessage(),exception);exception.printStackTrace();
ifthereisatleastonetoolaround**@authorAndreaAime-GeoSolutions*/publicclassEmptyPageLinksAuthorizerextendsDefaultPageAuthorizer{List<Class>linkClasses=Collections.emptyList();publicList<Class>getLinkClasses(){returnlinkClasses;
ifnotadminjustsayno
if(!super.isAccessAllowed(componentClass,authentication)){returnfalse;
ifthereisdemoaroundGeoServerApplicationapp=GeoServerApplication.get();for(Class<?>linkClass:linkClasses){
if(app.getBeansOfType(linkClass).size()>0){returntrue;
iftheexceptionisnotforaparticularservice.*/publicOWS20ServiceExceptionHandler(){super(Collections.EMPTY_LIST);
iftheexceptionisforaparticularservice.**@paramservicesListofservicesthishandlerhandlesexceptionsfor.*/publicOWS20ServiceExceptionHandler(Listservices){super(services);
iftheexceptionisforaparticularservice.**@paramservicesListofservicesthishandlerhandlesexceptionsfor.*/publicOWS20ServiceExceptionHandler(Serviceservice){super(Arrays.asList(service));
if(useServiceVersion&&request.getServiceDescriptor()!=null){version=request.getServiceDescriptor().getVersion().toString();
if(!request.isSOAP()){//therewillalreadybeaSOAPmimetyperesponse.setContentType("application/xml");
if(exceptioninstanceofOWS20Exception){ows2ex=(OWS20Exception)exception;
else
if(exception.getCause()!=null&&exception.getCause()instanceofOWS20Exception){ows2ex=(OWS20Exception)exception.getCause();
else{//trytoinfer
ifit'sastandardexceptionStringcode=exception.getCode();OWSExceptionCodeexCode=OWS20Exception.OWSExceptionCode.getByCode(code);
if(exCode!=null){ows2ex=newOWS20Exception(exception.getMessage(),exception,exCode,exception.getLocator());
else{ows2ex=newOWS20Exception(exception.getMessage(),exception,OWSExceptionCode.NoApplicableCode,exception.getLocator());
if(ows2ex.getHttpCode()!=null){response.setStatus(ows2ex.getHttpCode());
if(force200httpcode){response.setStatus(200);
if(exception.getCode()!=null){e.setExceptionCode(exception.getCode());
else{//setadefaulte.setExceptionCode("NoApplicableCode");
if(verboseExceptions){//addtheentirestacktrace//exception.sb.append("\nDetails:\n");ByteArrayOutputStreamtrace=newByteArrayOutputStream();exception.printStackTrace(newPrintStream(trace));sb.append(newString(trace.toByteArray()));
if(secMgr.listFilters().contains(testFilterName2)){SecurityFilterConfigconfig=secMgr.loadFilterConfig(testFilterName2);secMgr.removeFilter(config);
if(rs==J2EERoleSource.Header){request.addHeader("roles",derivedRole+";"+rootRole);
if(rs==J2EERoleSource.J2EE){
if(true){request.addUserRole(derivedRole);
if(false){request.addUserRole(rootRole);
if(true){request.addUserRole(derivedRole);
if(false){request.addUserRole(rootRole);
if(rs.equals(PreAuthenticatedUserNameRoleSource.Header)){request.addHeader("roles",derivedRole+";"+rootRole);
if(rs==J2EERoleSource.Header){request.addHeader("roles",derivedRole+";"+rootRole);
if(rs==J2EERoleSource.J2EE){
if(true){request.addUserRole(derivedRole);
if(false){request.addUserRole(rootRole);
if(rs==J2EERoleSource.J2EE){
if(false){request.addUserRole(derivedRole);
if(false){request.addUserRole(rootRole);
if(masksLayer!=null){addEoStyles(masksLayer,DEFAULT_BITMASK_STYLE);
if(masksLayer!=null){layerGroup.getLayers().add(masksLayer);layerGroup.getStyles().add(masksLayer.getDefaultStyle());
if(paramsLayer!=null){layerGroup.getLayers().add(paramsLayer);layerGroup.getStyles().add(paramsLayer.getDefaultStyle());
if(datastorePropertiesFile.exists()){PropertiesdatastoreProperties=loadProperties(datastorePropertiesFile);StringSPIClass=datastoreProperties.getProperty("SPI");return(DataStoreFactorySpi)Class.forName(SPIClass).newInstance();
else{returnnewShapefileDataStoreFactory();
if(JDBCDataStoreFactory.DBTYPE.key.equals(param.key)){dbType=(String)param.getDefaultValue();
if(dbType==null){
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,"dbtypeparameternotfoundindataStoreFactory"+dataStoreFactory+",usingdefault.");
if(datastorePropertiesFile.exists()){PropertiesdatastoreProperties=loadProperties(datastorePropertiesFile);Map<String,Serializable>params=Utils.createDataStoreParamsFromPropertiesFile(datastoreProperties,dataStoreFactory);StringdbType=getDbType(dataStoreFactory);params.put("dbtype",dbType);
if("h2".equals(dbType)){StringdbParameter=(String)params.get("database");//
ifthereferenceisrelative,weneedtobuildtheabsolutepath
if(!newFile(dbParameter).isAbsolute()){FileactualPath=newFile(dir,dbParameter).getCanonicalFile();params.put("database",actualPath.getAbsolutePath());
else{//shpstoreFileshpFile=newFile(dir,dir.getName()+".shp");Map<String,Serializable>params=newHashMap<String,Serializable>();//TODOisthereabetterwaytoconvertapathtoaURL?//URLs.fileToUrl(file)doesn'twork(GeoServersavesanemptyurl)params.put(ShapefileDataStoreFactory.URLP.key,"file://"+shpFile.getAbsolutePath());params.put(ShapefileDataStoreFactory.MEMORY_MAPPED.key,true);//TODOotherparams?//params.put(ShapefileDataStoreFactory.DBFTIMEZONE.key,Utils.UTC_TIME_ZONE);returnparams;
if(ws==null){ws=catalog.getDefaultWorkspace();
if(!foundTime){thrownewIllegalArgumentException("UnabletoenableTIMEdimensiononoutlinelayer:"+layerName);
if(!success){
if(layer!=null){catalog.remove(layer);
if(featureType!=null){catalog.remove(featureType);
if(store!=null){catalog.remove(store);
if(defaultStyle!=null){layer.setDefaultStyle(defaultStyle);
else{
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,"EOStylenotfound:"+defaultStyleName);
if(style!=null){layer.getStyles().add(style);
else{
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,"EOStylenotfound:"+styleName);
if(LOGGER.isLoggable(Level.INFO)){LOGGER.log(Level.INFO,msg,e);
if(StringUtils.isEmpty(url)){returnnull;
if(checkDimensions){
if(!dimensionsPresent){//rollback:deletestorecatalog.remove(store);thrownewIllegalArgumentException("Thelayer'"+name+"'couldnotbecreated:nodimensionsfound");
if(reader==null){thrownewRuntimeException("Unabletoacquirereaderforthiscoverageinfo:"+ci.getName());
if(LOGGER.isLoggable(Level.FINE)){booleanhasRange=ra.hasRange(domain);booleanhasResolution=ra.hasResolution(domain);LOGGER.fine(ci.getName()+":found"+domain+"dimension(hasRange:"+hasRange+",hasResolution:"+hasResolution+")");
if(Boolean.parseBoolean(elev)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(ci.getName()+":foundELEVATIONdimension");
if(Boolean.parseBoolean(time)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(ci.getName()+":foundTIMEdimension");
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.log(Level.SEVERE,"Failedtoaccesscoveragereadercustomdimensions",e);
if(pinstanceofLayerGroupInfo){delete(group);
else{delete((LayerInfo)p);
if(ResourceInfo.TIME.equalsIgnoreCase(dd.getName())){timeDimension=true;key=ResourceInfo.TIME;units=DimensionInfo.TIME_UNITS;
else
if(ResourceInfo.ELEVATION.equalsIgnoreCase(dd.getName())){key=ResourceInfo.ELEVATION;units=DimensionInfo.ELEVATION_UNITS;symbol=DimensionInfo.ELEVATION_UNIT_SYMBOL;
else{key=ResourceInfo.CUSTOM_DIMENSION_PREFIX+dd.getName();
if(templateLoader!=null){for(Stringtemplate:templates){finalObjectftl=templateLoader.findTemplateSource(template);
if(ftl!=null&&ftlinstanceofFile){ResourcetemplateResource=Files.asResource((File)ftl);
if(Resources.exists(templateResource)){finalStringrelative=rootDataDir.dir().toURI().relativize(templateResource.file().toURI()).getPath();ResourcetargetFtl=Resources.fromPath(relative,base.parent());
if(!targetFtl.parent().dir().exists()){targetFtl.parent().dir().mkdirs();
if(IS_OGR_AVAILABLE==null){try{Fileprops=newFile("./src/test/resources/ogr2ogr.properties");Propertiesp=newProperties();p.load(newFileInputStream(props));OGR2OGR=p.getProperty("ogr2ogr");//assumeit'sinthepath
ifthepropertyfilehasn'tbeenconfigured
if(OGR2OGR==null)OGR2OGR="ogr2ogr";GDAL_DATA=p.getProperty("gdalData");OGRWrapperogr=newOGRWrapper(OGR2OGR,Collections.singletonMap("GDAL_DATA",GDAL_DATA));IS_OGR_AVAILABLE=ogr.isAvailable();
if(isOgrAvailable())returnOGR2OGR;
elsereturnnull;
if(isOgrAvailable())returnGDAL_DATA;
elsereturnnull;}}
ifthealiasdoesnotexist**@paramalias*@throwsIOException*/KeygetKey(Stringalias)throwsIOException;/***Getsthekeyforencryptingpasswordsstoredinconfigurationfiles,maybe<code>null</code>**@throwsIOException*/byte[]getConfigPasswordKey()throwsIOException;/***Checks
ifasuchakeyisavailablewithoutpresentingthekeyitself**@throwsIOException*/booleanhasConfigPasswordKey()throwsIOException;/***Testitthekeystorecontainsaalias**@paramalias*@throwsIOException*/booleancontainsAlias(Stringalias)throwsIOException;/***Returnsthekeyfora{@linkorg.geoserver.security.GeoServerUserGroupService}serviceName.*Needed
iftheserviceusessymmetricpasswordencryption**<p>maybe<code>null</code>**@paramserviceName*@throwsIOException*/byte[]getUserGroupKey(StringserviceName)throwsIOException;/***Checks
ifasuchakeyisavailablewithoutpresentingthekeyitself**@throwsIOException*/booleanhasUserGroupKey(StringserviceName)throwsIOException;/***Getsthe{@linkSecretKey}objectforthisalias<code>null</code>
ifthealiasdoesnot*exist**@paramname*@throwsIOException
ifthekeyexistsbuthasthewrongtype*/SecretKeygetSecretKey(Stringname)throwsIOException;/***Getsthe{@linkSecretKey}objectforthisalias<code>null</code>
ifthealiasdoesnot*exist**@paramname*@throwsIOException
ifthekeyexistsbuthasthewrongtype*/PublicKeygetPublicKey(Stringname)throwsIOException;/***Getsthe{@linkPrivateKey}objectforthisalias<code>null</code>
ifthealiasdoesnot*exist**@paramname*@throwsIOException
ifthekeyexistsbuthasthewrongtype*/PrivateKeygetPrivateKey(Stringname)throwsIOException;/***@paramserviceNamefora{@linkorg.geoserver.security.GeoServerUserGroupService}*@returnthefollowingString{@link#USERGROUP_PREFIX}+serviceName+{@value*#USERGROUP_POSTFIX}*/StringaliasForGroupService(StringserviceName);/***Tests
ifthepasswordisthekeystorepassword**@parampassword*@throwsIOException*/booleanisKeyStorePassword(char[]password)throwsIOException;/***Adds/replacesa{@linkSecretKey}withitsalias**@paramalias*@paramkey*/voidsetSecretKey(Stringalias,char[]key)throwsIOException;/***Setsasecretforthenameofa{@linkorg.geoserver.security.GeoServerUserGroupService}**@paramserviceName*@parampassword*@throwsIOException*/voidsetUserGroupKey(StringserviceName,char[]password)throwsIOException;/***Removeakeybelongingtothealias**@paramalias*@throwsIOException*/voidremoveKey(Stringalias)throwsIOException;/***Storesthekeystoreto{@link#ks}**@throwsIOException*/voidstoreKeyStore()throwsIOException;/***Preparesamasterpasswordchange.Thenewpasswordisusedtoencryptthe{@linkKeyStore}*andeach{@linkEntry};**<p>Thenewpasswordisassumedtobealreadyvalidatedbythe{@linkPasswordValidator}named*{@linkPasswordValidator#MASTERPASSWORD_NAME}**<p>Anewkeystorenamed{@link#PREPARED_FILE_NAME}iscreated.Allkeysare-encryptedwith*thenewpasswordandstoredinthenewkeystore.**@paramoldPassword*@paramnewPassword*@throwsIOException*/voidprepareForMasterPasswordChange(char[]oldPassword,char[]newPassword)throwsIOException;/**Abortsthemasterpasswordchangebyremovingthefilenamed{@link#PREPARED_FILE_NAME}*/voidabortMasterPasswordChange();/***
if{@link#DEFAULT_FILE_NAME}and{@link#PREPARED_FILE_NAME}exist,thismethodchecks
if*{@link#PREPARED_FILE_NAME}canbeusedwithnew{@link*MasterPasswordProvider#getMasterPassword()}method.**<p>YES:replacetheoldkeystorewiththenewone**<p>NO:Donothing,logtheproblemandusetheoldconfigurationAreasonmaybethatthenew*masterpasswordisnotproperlyinjectedatstartup**@throwsIOException*/voidcommitMasterPasswordChange()throwsIOException;}
ifthevalidatorisunset,thatis,doesnothavevalidconfigurationtooperate*onto.Inthiscaseanyattempttorunavalidationwillbeignoredsilently*/publicbooleanisUnset();}
if(noDuplicates){//noduplicatevaluesshouldbeincludedSet<Object>values=reader.readWithoutDuplicates(getDimensionName(),filter,dataType);returnnewArrayList<>(values);
if(inputTempFile!=null){inputTempFile.delete();
if(reader!=null){reader.dispose();
if(reader!=null){reader.dispose();
if(gc!=null){CoverageCleanerCallback.disposeCoverage(gc);
if(inputReader!=null){inputReader.dispose();
if(outputReader!=null){outputReader.dispose();
if(writer!=null){writer.dispose();
if(gc!=null){CoverageCleanerCallback.disposeCoverage(gc);
if(croppedGC!=null){CoverageCleanerCallback.disposeCoverage(croppedGC);
if(outputTempFile!=null){outputTempFile.delete();
if(model.getOpenSearchAccessStoreId()!=null){this.backend=getCatalog().getDataStore(model.getOpenSearchAccessStoreId());
if(recordsPerPage!=null&&maximum!=null&&records>maximum){form.error(newParamResourceModel("recordsGreaterThanMaximum",form,records,maximum));
if(backend!=null){info.setOpenSearchAccessStoreId(backend.getId());
else{info.setOpenSearchAccessStoreId(null);
if(previous!=null){assertTrue(curr.compareTo(previous)>=0);
if(workspace!=null){expectedOperationUrl="http://localhost:8080/geoserver/"+workspace+"/wps";
if(sourceinstanceofCatalogEvent){finalCatalogEventev=(CatalogEvent)source;
if(LOGGER.isLoggable(Level.FINE)){finalCatalogInfoinfo=ev.getSource();LOGGER.fine("IncomingmessageeventoftypeCatalogEvent:"+info.getId());
else{thrownewJMSException("Unabletodeserializethefollowingobject:\n"+s);
if(!(eventinstanceofCatalogModifyEvent)){//notamodifyeventsonothingtodoreturnevent;
if(!(valueinstanceofCatalog)){//notapropertyoftypecatalogindexes.add(i);
ifweneedtodoanything
if(indexes.size()==totalProperties){//nopropertiesoftypecatalog,wecanusetheoriginaleventreturnevent;
if((urlString==null)){PrintWriterout=response.getWriter();StringBufferurlInfo=request.getRequestURL();
if(urlInfo.indexOf("?")!=-1){urlInfo.delete(urlInfo.indexOf("?"),urlInfo.length());
if(checkURL()==true){");out.print("document.frm.action=\"");out.print(urlInfo.toString());out.print("\";\n");out.println("document.frm.target=\"_blank\";");out.println("document.frm.submit();");out.println("}");out.println("}");out.println("functioncheckURL(){");out.println("
if(document.frm.url.value==\"\"){");out.println("alert(\"PleasegiveURLbeforeyousumbitthisform!\");");out.println("returnfalse;");out.println("
else{");out.println("returntrue;");out.println("}");out.println("}");out.println("functionclearRequest(){");out.println("document.frm.body.value=\"\";");out.println("}");out.println("</script>");out.println("<body>");out.println("<formname=\"frm\"action=\"JavaScript:doNothing()\"method=\"POST\">");out.println("<tablealign=\"center\"cellspacing=\"2\"cellpadding=\"2\"border=\"0\">");out.println("<tr>");out.println("<td><b>URL:</b></td>");out.print("<td><inputname=\"url\"value=\"");out.print(geoserverUrl);out.print("/wfs/GetFeature\"size=\"70\"MAXLENGTH=\"100\"/></td>\n");out.println("</tr>");out.println("<tr>");out.println("<td><b>Request:</b></td>");out.println("<td><textareacols=\"60\"rows=\"24\"name=\"body\"></textarea></td>");out.println("</tr>");out.println("</table>");out.println("<tablealign=\"center\">");out.println("<tr>");out.println("<td><inputtype=\"button\"value=\"Clear\"onclick=\"clearRequest()\"></td>");out.println("<td><inputtype=\"button\"value=\"Submit\"onclick=\"sendRequest()\"></td>");out.println("<td></td>");out.println("</tr>");out.println("</table>");out.println("</form>");out.println("</body>");out.println("</html>");out.close();
else{response.setContentType("application/xml");BufferedReaderxmlIn=null;PrintWriterxmlOut=null;StringBuffersbf=newStringBuffer();Stringresp=null;try{URLu=newURL(urlString);validateURL(request,urlString,getProxyBaseURL());java.net.HttpURLConnectionacon=(java.net.HttpURLConnection)u.openConnection();acon.setAllowUserInteraction(false);
if(!doGet){//System.out.println("settopost");acon.setRequestMethod("POST");acon.setRequestProperty("Content-Type","application/xml");
else{//System.out.println("settoget");acon.setRequestMethod("GET");
iftherewasauthenticationinfointherequest,//PassitalongthewaytothetargetURL//DJB:appliedpatchinGEOS-335StringauthHeader=request.getHeader("Authorization");Stringusername=request.getParameter("username");
if((username!=null)&&!username.trim().equals("")){Stringpassword=request.getParameter("password");Stringup=username+":"+password;byte[]encoded=Base64.encodeBase64(up.getBytes());authHeader="Basic"+newString(encoded);
if(authHeader!=null){acon.setRequestProperty("Authorization",authHeader);
if(!doGet){xmlOut=newPrintWriter(newBufferedWriter(newOutputStreamWriter(acon.getOutputStream())));xmlOut=newjava.io.PrintWriter(acon.getOutputStream());xmlOut.write(requestString);xmlOut.flush();
if(acon.getResponseCode()>=400){//Constructthefullresponsebeforewriting,sothatwedon'tthrowan//exceptionpartwaythrough.StringBuilderresponseContent=newStringBuilder();responseContent.append("<?xmlversion=\"1.0\"encoding=\"UTF-8\"?>\n");responseContent.append("<servlet-exception>\n");responseContent.append("HTTPresponse:");responseContent.append(acon.getResponseCode());responseContent.append("\n");
if(acon.getResponseMessage()!=null){responseContent.append(URLDecoder.decode(acon.getResponseMessage(),"UTF-8"));
else{//xmlIn=newBufferedReader(newInputStreamReader(//acon.getInputStream()));//Stringline;//System.out.println("gotencodingfromacon:"//+acon.getContentType());response.setContentType(acon.getContentType());response.setHeader("Content-disposition",acon.getHeaderField("Content-disposition"));OutputStreamoutput=response.getOutputStream();intc;InputStreamin=acon.getInputStream();while((c=in.read())!=-1)output.write(c);in.close();output.close();
if(xmlIn!=null){xmlIn.close();
if(xmlOut!=null){xmlOut.close();
if(geoServer!=null){geoServer.getGlobal().getSettings().getProxyBaseUrl();
if(proxyBase!=null){
if(!url.startsWith(proxyBase)){thrownewIllegalArgumentException("Invalidurlrequested,thedemorequestsshouldbehitting:"+proxyBase);
else{//usetherequestedurlthen,andremovetheTestWfsPortStringrequestedUrl=request.getRequestURL().toString();//thisshouldnothappen,butlet'snotmakeitanopenproxy
ifitdoes
if(!requestedUrl.endsWith(TEST_WFS_POST_PATH)){thrownewIllegalStateException("Unepected,theTestWfsPostwasaccessedbyapathnotendingwithTestWfsPost:"+requestedUrl);
if(!url.startsWith(base)){thrownewIllegalArgumentException("Invalidurlrequested,thedemorequestsshouldbehitting:"+base);
if(manager==null){manager=GeoServerExtensions.bean(ProcessAccessManager.class);
if(manager==null){manager=newDefaultProcessAccessManager(GeoServerExtensions.bean(WpsAccessRuleDAO.class));
if(exceptionText==null||exceptionText.size()==0)returnmsg;StringBuffersb=newStringBuffer(msg);for(Iteratorit=exceptionText.iterator();it.hasNext();){StringextraMessage=(String)it.next();sb.append(NEW_LINE).append(extraMessage);
if(Resources.exists(wr)&&Resources.exists(nr)){byte[]contents=wr.getContents();byte[]nrContents=nr.getContents();returnnewWorkspaceContents(rd,contents,nrContents);
else{LOGGER.warning("Ignoringworkspacedirectory"+rd.path());returnnull;
if(Resources.exists(r)&&Resources.exists(lr)){byte[]contents=r.getContents();byte[]lrContents=lr.getContents();returnnewLayerContents(rd,contents,lrContents);
else{LOGGER.warning("Ignoring"+resourceType+"directory"+rd.path());returnnull;
if(LOGGER.isLoggable(Level.INFO)){Stringtype=ftinstanceofCoverageInfo?"coverage":ftinstanceofFeatureTypeInfo?"featuretype":"resource";LOGGER.info("Loaded"+type+"'"+lc.resource.name()+"',"+(ft.isEnabled()?"enabled":"disabled"));
if(beaninstanceofCatalog){//ensurethisisnotawrapperbuttherealdeal
if(beaninstanceofWrapper&&((Wrapper)bean).isWrapperFor(Catalog.class)){returnbean;
if(beaninstanceofGeoServer){geoserver=(GeoServer)bean;try{XStreamPersisterxp=xpf.createXMLPersister();xp.setCatalog(geoserver.getCatalog());loadGeoServer(geoserver,xp);//loadinitializersloadInitializers(geoserver);
if(catalog.getStyleByName(StyleInfo.DEFAULT_POINT)==null){initializeStyle(catalog,StyleInfo.DEFAULT_POINT,"default_point.sld");
if(catalog.getStyleByName(StyleInfo.DEFAULT_LINE)==null){initializeStyle(catalog,StyleInfo.DEFAULT_LINE,"default_line.sld");
if(catalog.getStyleByName(StyleInfo.DEFAULT_POLYGON)==null){initializeStyle(catalog,StyleInfo.DEFAULT_POLYGON,"default_polygon.sld");
if(catalog.getStyleByName(StyleInfo.DEFAULT_RASTER)==null){initializeStyle(catalog,StyleInfo.DEFAULT_RASTER,"default_raster.sld");
if(catalog.getStyleByName(StyleInfo.DEFAULT_GENERIC)==null){initializeStyle(catalog,StyleInfo.DEFAULT_GENERIC,"default_generic.sld");
ifnecessaryResourcestyleResource=resourceLoader.get(Paths.path("styles",sld));
if(!Resources.exists(styleResource)){IOUtils.copy(GeoServerLoader.class.getResourceAsStream(sld),styleResource.out());
if(cataloginstanceofWrapper){catalog=((Wrapper)geoserver.getCatalog()).unwrap(Catalog.class);
ifitexistsassumewearedealingwith//anolddatadirectoryResourcef=resourceLoader.get("catalog.xml");
if(!Resources.exists(f)){//assume2.xstyledatadirectoryCatalogImplcatalog2=(CatalogImpl)readCatalog(xp);//maketoremovetheoldresourcepoolcataloglistener((CatalogImpl)catalog).sync(catalog2);
else{//importoldstylecatalog,registerthepersisternowsothatwestart//withanewversionofthecatalogCatalogImplcatalog2=(CatalogImpl)readLegacyCatalog(f,xp);((CatalogImpl)catalog).sync(catalog2);
if(Resources.exists(f)){try{GeoServerInfoglobal=depersist(xp,f,GeoServerInfo.class);finalResourceErrorHandlingresourceErrorHandling=global.getResourceErrorHandling();returnresourceErrorHandling!=null&&!ResourceErrorHandling.SKIP_MISCONFIGURED_LAYERS.equals(resourceErrorHandling);
ifwereallyneedtoverifystoresonstartupbooleancheckStores=checkStoresOnStartup(xp);
if(!checkStores){catalog.setExtendedValidation(false);
if(Resources.exists(workspaces)){//doafirstquickscanoverallworkspaces,settingthedefaultResourcedws=workspaces.get("default.xml");WorkspaceInfodefaultWorkspace=null;
if(Resources.exists(dws)){try{defaultWorkspace=depersist(xp,dws,WorkspaceInfo.class);LOGGER.info("Loadeddefaultworkspace"+defaultWorkspace.getName());
else{LOGGER.warning("Nodefaultworkspacewasfound.");
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Loadedworkspace'"+ws.getName()+"'");
if(defaultWorkspace!=null){
if(ws.getName().equals(defaultWorkspace.getName())){catalog.setDefaultWorkspace(ws);
if(ns!=null){catalog.setDefaultNamespace(ns);
else{//createthedefault.xmlfiledefaultWorkspace=catalog.getDefaultWorkspace();
if(defaultWorkspace!=null){try{persist(xp,defaultWorkspace,dws);
if(styles!=null){loadStyles(styles,catalog,xp);
if(Resources.exists(f)){returnnewStoreContents(f,f.getContents());
if(Resources.exists(f)){returnnewStoreContents(f,f.getContents());
if(Resources.exists(f)){returnnewStoreContents(f,f.getContents());
if(Resources.exists(f)){returnnewStoreContents(f,f.getContents());
if(!isConfigDirectory(sd)){LOGGER.warning("Ignoringstoredirectory'"+sd.name()+"'");
if("datastore.xml".equals(resourceName)){loadDataStore(storeContents,catalog,xp,checkStores);
else
if("coveragestore.xml".equals(resourceName)){loadCoverageStore(storeContents,catalog,xp);
else
if("wmsstore.xml".equals(resourceName)){loadWmsStore(storeContents,catalog,xp);
else
if("wmtsstore.xml".equals(resourceName)){loadWmtsStore(storeContents,catalog,xp);
else
if(!isConfigDirectory(storeContents.resource)){LOGGER.warning("Ignoringstoredirectory'"+storeContents.resource.name()+"'");continue;
if(layergroups!=null){loadLayerGroups(layergroups,catalog,xp);
else{LOGGER.warning("No'workspaces'directoryfound,unabletoloadanystores.");
if(layergroups!=null){loadLayerGroups(layergroups,catalog,xp);
if(!checkStores){catalog.setExtendedValidation(true);
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Loadedcoveragestore'"+cs.getName()+"',"+(cs.isEnabled()?"enabled":"disabled"));
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Loadeddatastore'"+ds.getName()+"',"+(ds.isEnabled()?"enabled":"disabled"));
if(checkStores&&ds.isEnabled()){//connecttothedatastoretodetermine
ifweshoulddisableittry{ds.getDataStore(null);
if(!legacy){catalog2.addListener(cp);catalog2.addListener(rp);
if(!legacy){catalog2.removeListener(cp);catalog2.removeListener(rp);
if(!legacy){//copyfilesfromoldfeaturetypedirectoriestonewResourcefeatureTypesDir=resourceLoader.get("featureTypes");
if(featureTypesDir!=null){LegacyCatalogReadercreader=newLegacyCatalogReader();creader.read(f);Map<String,Map<String,Object>>dataStores=creader.dataStores();for(ResourcefeatureTypeDir:featureTypesDir.list()){
if(featureTypeDir.getType()!=Type.DIRECTORY){continue;
if(!Resources.exists(featureTypeInfo)){continue;
if(dataStore==null){continue;
if(destFeatureTypeDir!=null){//copyallthefilesoverfor(Resourcefile:featureTypeDir.list()){
if(file.getType()==Type.RESOURCE&&!featureTypeInfo.equals(file)){IOUtils.copy(file.in(),destFeatureTypeDir.get(file.name()).out());
ifitexistsassumewearedealingwith//anolddatadirectoryResourcef=resourceLoader.get("services.xml");
if(!Resources.exists(f)){//assume2.xstylef=resourceLoader.get("global.xml");
if(Resources.exists(f)){try{GeoServerInfoglobal=depersist(xp,f,GeoServerInfo.class);geoServer.setGlobal(global);
if(Resources.exists(f)){try{LoggingInfologging=depersist(xp,f,LoggingInfo.class);geoServer.setLogging(logging);
if(Resources.exists(workspaces)){for(Resourcedir:workspaces.list()){
if(dir.getType()!=Type.DIRECTORY)continue;f=dir.get("settings.xml");
if(Resources.exists(f)){try{SettingsInfosettings=depersist(xp,f,SettingsInfo.class);geoServer.add(settings);
if(workspaces!=null){for(Resourcedir:workspaces.list()){
if(dir.getType()!=Type.DIRECTORY)continue;loadServices(dir,false,loaders,geoServer);
else{//addlistenernowasaconverterwhichwillconvertfromtheoldstyle//datadirectorytothenewGeoServerConfigPersisterp=newGeoServerConfigPersister(resourceLoader,xp);geoServer.addListener(p);//importoldstyleservices.xmlnewLegacyConfigurationImporter(geoServer).imprt(resourceLoader.getBaseDirectory());geoServer.removeListener(p);//renametheservices.xmlfilef.renameTo(f.parent().get("services.xml.old"));
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Loadedstyle'"+s.getName()+"'");
if(lg.getLayers()==null||lg.getLayers().size()==0){LOGGER.warning("Skippingemptylayergroup'"+lg.getName()+"',itisinvalid");continue;
if(!global&&s.getWorkspace()==null)continue;geoServer.add(s);LOGGER.info("Loadedservice'"+s.getId()+"',"+(s.isEnabled()?"enabled":"disabled"));
if(Resources.exists(directory)){LOGGER.log(Level.SEVERE,"Failedtoloadtheserviceconfigurationindirectory:"+directory+"withloaderfor"+l.getServiceClass(),t);
else{LOGGER.log(Level.SEVERE,"Failedtoloadtherootserviceconfigurationwithloaderfor"+l.getServiceClass(),t);
if(LayerInfo.class.isAssignableFrom(type)){return(IConverter<C>)newLayerInfoConverter();
else
if(StyleInfo.class.isAssignableFrom(type)){return(IConverter<C>)newStyleInfoConverter();
else{returnsuper.getConverter(type);
if(!isAuthenticatedAsAdmin()){wsChoice.setNullValid(false);wsChoice.setRequired(true);
if(crs!=null){//ensuretheboundscalculatedintermsoftheuserspecifiedcrsnewCatalogBuilder(getCatalog()).calculateLayerGroupBounds(lg,crs);
else{//calculatefromscratchnewCatalogBuilder(getCatalog()).calculateLayerGroupBounds(lg);
if(layerGroupName!=null){CoverageStoreNewPagecoverageStoreCreator=newCoverageStoreNewPage(newImageMosaicFormat().getName()){protectedvoidonSuccessfulSave(org.geoserver.catalog.CoverageStoreInfoinfo,org.geoserver.catalog.Catalogcatalog,org.geoserver.catalog.CoverageStoreInfosavedStore){EoCoverageSelectorPagepage=newEoCoverageSelectorPage(EoLayerGroupAbstractPage.this,layerGroupName,savedStore.getId());setResponsePage(page);};};setResponsePage(coverageStoreCreator);
else{dialog.showInfo(target,null,newParamResourceModel("layerInfoTitle",EoLayerGroupAbstractPage.this),newParamResourceModel("provideGroupName",EoLayerGroupAbstractPage.this));
if(layerGroupName!=null){EoCoverageSelectorPagepage=newEoCoverageSelectorPage(EoLayerGroupAbstractPage.this,layerGroupName);setResponsePage(page);
else{dialog.showInfo(target,null,newParamResourceModel("layerInfoTitle",EoLayerGroupAbstractPage.this),newParamResourceModel("provideGroupName",EoLayerGroupAbstractPage.this));
if(!nameAvailable){info(newParamResourceModel("provideGroupName",EoLayerGroupAbstractPage.this).getString());
else{//informtheuseraboutpossiblelayerrenames
if(isLayerRenameRequired(groupName)){info(newParamResourceModel("layerRenameWarning",EoLayerGroupAbstractPage.this,groupName).getString());
if(name.getDefaultModelObject()==null||"".equals(name.getDefaultModelObject())){info(newParamResourceModel("provideGroupName",this).getString());
ifwealreadyhaveanoutlinelayer,falseotherwise**@paramitems*/privatebooleanoutlinesPresent(List<EoLayerGroupEntry>items){for(EoLayerGroupEntryentry:items){
if(entry.getLayerType()==EoLayerType.COVERAGE_OUTLINE){returntrue;
if(!expectedName.equals(entry.getLayer().getName())){returntrue;
if(groupName==null||"".equals(groupName.trim())){error("Pleasegivenanametothelayergrupbeforeaddinglayersintoit");returnnull;
if(lgEntryPanel.getEntries().size()==0){error((String)newParamResourceModel("oneLayerMinimum",getPage()).getObject());return;
if(piinstanceofLayerInfo){LayerInfoli=getCatalog().getLayer(pi.getId());StringexpectedName=lg.getName()+"_"+entry.getLayerSubName();StringactualName=li.getName();
if(!expectedName.equals(actualName)){ResourceInforesource=li.getResource();li.setName(expectedName);resource.setName(expectedName);getCatalog().save(resource);getCatalog().save(li);
if(validateLayerGroupContents(lg)){onSubmit(lg);
if(!(entry.getLayer()instanceofLayerInfo)){error(newParamResourceModel("nestedLayerGroupInvalid",this));
else{EoLayerTypetype=entry.getLayerType();//countbandandbrowselayers
switch(type){caseBAND_COVERAGE:bandsCount++;break;caseBROWSE_IMAGE:browseCount++;browseLayer=(LayerInfo)entry.getLayer();browseLayerStyle=entry.getStyle();break;default:break;
if(!checkDimensions(entry)){valid=false;
if(browseCount!=1){error(newParamResourceModel("invalidBrowseCount",this,browseCount).getString());valid=false;
if(bandsCount>1){error(newParamResourceModel("invalidBandsCount",this,bandsCount).getString());valid=false;
if(valid){//setthelayerrootlg.setRootLayer(browseLayer);lg.setRootLayerStyle(browseLayerStyle);lg.setMode(Mode.EO);
if(!timeAvaiable){error(newParamResourceModel("EoLayerGroupError.invalidLayer",null,layer.getName()).getString());returnfalse;
else
if(entry.getLayerType()!=EoLayerType.BAND_COVERAGE){returntrue;
if(elevationDimension!=null&&elevationDimension.isEnabled()){returntrue;
if(key!=null&&key.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){DimensionInfodi=metadata.get(key,DimensionInfo.class);
if(di!=null&&di.isEnabled()){returntrue;
if(other!=null&&(layerGroupId==null||!other.getId().equals(layerGroupId))){iv.error(newValidationError("duplicateGroupNameError").setVariable("name",name));
ifglobal.*/WorkspaceInfogetWorkspace();/**Getrootlayer.*/LayerInfogetRootLayer();/**Setrootlayer.*/voidsetRootLayer(LayerInforootLayer);/**Getrootlayerstyle.*/StyleInfogetRootLayerStyle();/**Setrootlayerstyle.*/voidsetRootLayerStyle(StyleInfostyle);/**Thelayersandlayergroupsinthegroup.*/List<PublishedInfo>getLayers();/***Thestylesforthelayersinthegroup.**<p>Thislistisa1-1correspondenceto{@link#getLayers()}.*/List<StyleInfo>getStyles();/***/List<LayerInfo>layers();/***/List<StyleInfo>styles();/**Theboundsforthebasemap.*/ReferencedEnvelopegetBounds();/**Setstheboundsforthebasemap.*/voidsetBounds(ReferencedEnvelopebounds);/**Setstheworkspace.*/voidsetWorkspace(WorkspaceInfoworkspace);/***Acollectionofmetadatalinksfortheresource.**@uml.propertyname="metadataLinks"*@seeMetadataLinkInfo*/List<MetadataLinkInfo>getMetadataLinks();/***Returnthekeywordsassociatedwiththislayergroup.Ifnokeywordsareavailableanempty*listshouldbereturned.**@returnanonNULLlistcontainingthekeywordsassociatedwiththislayergroup*/defaultList<KeywordInfo>getKeywords(){returnnewArrayList<>();
if(lg==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofLayerGroupInfo))returnfalse;LayerGroupInfoother=(LayerGroupInfo)obj;
if(lg.getBounds()==null){
if(other.getBounds()!=null)returnfalse;
else
if(!lg.getBounds().equals(other.getBounds()))returnfalse;
if(lg.getId()==null){
if(other.getId()!=null)returnfalse;
else
if(!lg.getId().equals(other.getId()))returnfalse;
if(lg.getLayers()==null){
if(other.getLayers()!=null)returnfalse;
else
if(!lg.getLayers().equals(other.getLayers()))returnfalse;
if(lg.getMetadata()==null){
if(other.getMetadata()!=null)returnfalse;
else
if(!lg.getMetadata().equals(other.getMetadata()))returnfalse;
if(lg.getName()==null){
if(other.getName()!=null)returnfalse;
else
if(!lg.getName().equals(other.getName()))returnfalse;
if(lg.getMode()==null){
if(other.getMode()!=null)returnfalse;
else
if(!lg.getMode().equals(other.getMode()))returnfalse;
if(lg.getTitle()==null){
if(other.getTitle()!=null){returnfalse;
else
if(!lg.getTitle().equals(other.getTitle()))returnfalse;
if(lg.getAbstract()==null){
if(other.getAbstract()!=null){returnfalse;
else
if(!lg.getAbstract().equals(other.getAbstract()))returnfalse;
if(lg.getWorkspace()==null){
if(other.getWorkspace()!=null)returnfalse;
else
if(!lg.getWorkspace().equals(other.getWorkspace()))returnfalse;List<StyleInfo>styles=canonicalStyles(lg.getStyles(),lg.getLayers());List<StyleInfo>otherStyles=canonicalStyles(other.getStyles(),other.getLayers());
if(styles==null){
if(otherStyles!=null)returnfalse;
else
if(!styles.equals(otherStyles))returnfalse;
if(lg.getAuthorityURLs()==null){
if(other.getAuthorityURLs()!=null)returnfalse;
else
if(!lg.getAuthorityURLs().equals(other.getAuthorityURLs()))returnfalse;
if(lg.getIdentifiers()==null){
if(other.getIdentifiers()!=null)returnfalse;
else
if(!lg.getIdentifiers().equals(other.getIdentifiers()))returnfalse;
if(lg.getRootLayer()==null){
if(other.getRootLayer()!=null)returnfalse;
else
if(!lg.getRootLayer().equals(other.getRootLayer()))returnfalse;
if(lg.getRootLayerStyle()==null){
if(other.getRootLayerStyle()!=null)returnfalse;
else
if(!lg.getRootLayerStyle().equals(other.getRootLayerStyle()))returnfalse;
if(lg.getAttribution()==null){
if(other.getAttribution()!=null)returnfalse;
else
if(!lg.getAttribution().equals(other.getAttribution()))returnfalse;
if(lg.getMetadataLinks()==null){
if(other.getMetadataLinks()!=null)returnfalse;
else
if(!lg.getMetadataLinks().equals(other.getMetadataLinks()))returnfalse;
if(!lg.isQueryDisabled()==other.isQueryDisabled())returnfalse;returntrue;
if(styles==null||styles.isEmpty()){returnnull;
if(s!=null){allNull=false;break;
if(allNull){returnnull;
if(styles.size()==layers.size()){returnstyles;
if(requestinstanceofLockFeatureType){returnnewWFS11((EObject)request);
else
if(requestinstanceofnet.opengis.wfs20.LockFeatureType){returnnewWFS20((EObject)request);
ifitreceivesa*GetFeatureInforequestbutdoesnotsupportit.</i>*/@TestpublicvoidtestQueryNonQueryableLayer()throwsException{//HACK:faketheWMSfacadetoinformthelayerisnonqueryable.Lookslikewewouldneed//aLayerInfo.isQueryable()propertyfinalWMSwms=(WMS)applicationContext.getBean("wms");GetFeatureInfoKvpReaderreader=(GetFeatureInfoKvpReader)applicationContext.getBean("getFeatureInfoKvpReader");try{WMSfakeWMS=newWMS(wms.getGeoServer()){@OverridepublicbooleanisQueryable(LayerInfolayer){
if("Forests".equals(layer.getName())){returnfalse;
ifitwasn'tthatwesaythemax//bufferat50//intheWMSconfigurationdom=getAsDOM(base+"&i=85&j=230&buffer=300");XMLAssert.assertXpathEvaluatesTo("1","count(/html/body/table/tr/td[starts-with(.,'BasicPolygons.')])",dom);XMLAssert.assertXpathEvaluatesTo("1","count(/html/body/table/tr/td[.='BasicPolygons.1107531493630'])",dom);
ifmorethanonelayeris//selectedassertTrue(result.indexOf("<styletype=\"text/css\">")>0);
iftheformatisnotknown,insteadofreturningthe*textformatasinhttps://osgeo-org.atlassian.net/browse/GEOS-1924*/@TestpublicvoidtestUknownFormat()throwsException{Stringlayer=MockData.FORESTS.getPrefix()+":"+MockData.FORESTS.getLocalPart();Stringrequest="wms?version=1.3.0&bbox=-0.002,-0.002,0.002,0.002&styles=&format=jpeg&info_format=unknown/format&request=GetFeatureInfo&layers="+layer+"&query_layers="+layer+"&width=20&height=20&i=10&j=10";Documentdoc=dom(get(request),true);//print(doc);XMLAssert.assertXpathEvaluatesTo("1","count(//ogc:ServiceExceptionReport/ogc:ServiceException)",doc);XMLAssert.assertXpathEvaluatesTo("InvalidFormat","/ogc:ServiceExceptionReport/ogc:ServiceException/@code",doc);XMLAssert.assertXpathEvaluatesTo("info_format","/ogc:ServiceExceptionReport/ogc:ServiceException/@locator",doc);
if(srs==null||"UNKNOWN".equals(srs))returnnull;try{returnCRS.decode(srs);
if(namespace==null){thrownewResourceNotFoundException("Nosuchnamespace:'"+namespaceName+"'found");
ifonedoesnotalreadyexists,wecanremovethisoncewegettoapoint//wherenamespaceisjustanattributeonalayer,andnotacontainingelement
if(catalog.getWorkspaceByName(namespace.getPrefix())==null){WorkspaceInfows=catalog.getFactory().createWorkspace();ws.setName(namespace.getPrefix());ws.setIsolated(namespace.isIsolated());catalog.add(ws);
if("default".equals(prefix)){catalog.setDefaultNamespace(namespace);
else{//namemustexistNamespaceInfonsi=catalog.getNamespaceByPrefix(prefix);
if(nsi==null){thrownewRestException("Can'tchangeanonexistantnamespace("+prefix+")",HttpStatus.NOT_FOUND);
if(infoName!=null&&!prefix.equals(infoName)){thrownewRestException("Can'tchangenameofnamespace",HttpStatus.FORBIDDEN);
if(prefix.equals("default")){thrownewRestException("Can'tdeletethedefaultnamespace",HttpStatus.METHOD_NOT_ALLOWED);
if(ns==null){thrownewRestException("Namespace'"+prefix+"'notfound",HttpStatus.NOT_FOUND);
if(!catalog.getResourcesByNamespace(ns,ResourceInfo.class).isEmpty()){thrownewRestException("Namespacenotempty",HttpStatus.UNAUTHORIZED);
if(properties==null){try{properties=model.toMap();
if(def.equals(namespace)){properties.put("isDefault",Boolean.TRUE);
else{properties.put("isDefault",Boolean.FALSE);
if(prefix==null){returnnull;
if(objinstanceofNamespaceInfo){converter.encodeLink("/namespaces/"+converter.encode(ref),writer);
ifnot*otherwiseexplicitlyidentifiedwithinaquery*ortransactionrequest.TheSRSmaybeindicated*usingeithertheEPSGform(EPSG:posccode)or*theURLformdefinedinsubclause4.3.2of*refernce[2].*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:element&gt;*&lt;xsd:elementmaxOccurs="unbounded"minOccurs="0"*name="OtherSRS"type="xsd:anyURI"&gt;*&lt;xsd:annotation&gt;*&lt;xsd:documentation&gt;*TheOtherSRSelementisusedtoindicateother*supportedSRSswithinqueryandtransaction*operations.AsupportedSRSmeansthatthe*WFSsupportsthetransformationofspatial*propertiesbetweentheOtherSRSandtheinternal*storageSRS.Theeffectsofsuchtransformations*mustbeconsideredwhendetermininganddeclaring*theguaranteeddataaccuracy.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:element&gt;*&lt;/xsd:sequence&gt;*&lt;xsd:elementname="NoSRS"&gt;*&lt;xsd:complexType/&gt;*&lt;/xsd:element&gt;*&lt;/xsd:choice&gt;*&lt;xsd:elementminOccurs="0"name="Operations"type="wfs:OperationsType"/&gt;*&lt;xsd:elementminOccurs="0"name="OutputFormats"type="wfs:OutputFormatListType"/&gt;*&lt;xsd:elementmaxOccurs="unbounded"minOccurs="1"ref="ows:WGS84BoundingBox"/&gt;*&lt;xsd:elementmaxOccurs="unbounded"minOccurs="0"*name="MetadataURL"type="wfs:MetadataURLType"/&gt;*&lt;/xsd:sequence&gt;*&lt;/xsd:complexType&gt;**</code>*</pre>**@generated*/publicclassFeatureTypeTypeBindingextendsAbstractComplexBinding{WfsFactorywfsfactory;publicFeatureTypeTypeBinding(WfsFactorywfsfactory){this.wfsfactory=wfsfactory;
ifcreatingastoreis*notsupported.**<p>Implementationsthatdonotsupportastoreshouldensurethat{@link#canCreateStore()}*returns<code>false</code>.*/GeoServerUserGroupStorecreateStore()throwsIOException;/***Registerfornotificationsonload**@paramlistener*/voidregisterUserGroupLoadedListener(UserGroupLoadedListenerlistener);/***Unregisterfornotificationsonstore/load**@paramlistener*/voidunregisterUserGroupLoadedListener(UserGroupLoadedListenerlistener);/***Returnsthethegroupobject,null
ifnotfound**@paramgroupname*@returnnull
ifgroupnotfound*@throwsDataAccessException*/GeoServerUserGroupgetGroupByGroupname(Stringgroupname)throwsIOException;/***Returnsthetheuserobject,null
ifnotfound**@paramusername*@returnnull
ifusernotfound*@throwsDataAccessException*/GeoServerUsergetUserByUsername(Stringusername)throwsIOException;/***Createauserobject.Implementationscanusesubclassesof{@linkGeoServerUser}**@paramusername*@parampassword*@paramisEnabled*/GeoServerUsercreateUserObject(Stringusername,Stringpassword,booleanisEnabled)throwsIOException;/***Createauserobject.Implementationscanuseclassesimplementing{@linkGeoServerUserGroup}**@paramgroupname*@parampassword*@paramisEnabled*/GeoServerUserGroupcreateGroupObject(Stringgroupname,booleanisEnabled)throwsIOException;/***Returnsthelistofusers.**@returnacollectionwhichcannotbemodified*/SortedSet<GeoServerUser>getUsers()throwsIOException;/***ReturnsthelistofGeoserverUserGroups.**@returnacollectionwhichcannotbemodified*/SortedSet<GeoServerUserGroup>getUserGroups()throwsIOException;/***getusersforagroup**@paramgroup*@returnacollectionwhichcannotbemodified*/SortedSet<GeoServerUser>getUsersForGroup(GeoServerUserGroupgroup)throwsIOException;/***getthegroupsforauser,animplementationnotsupportingusergroupsreturnsanempty*collection**@paramuser*@returnacollectionwhichcannotbemodified*/SortedSet<GeoServerUserGroup>getGroupsForUser(GeoServerUseruser)throwsIOException;/**loadfrombackendstore.Onsuccess,a{@linkUserGroupLoadedEvent}shouldbetriggered*/voidload()throwsIOException;/***@returntheSpringnameofthe{@linkGeoServerPasswordEncoder}object.mandatory,defaultis*{@linkGeoServerDigestPasswordEncoder#BeanName}.*/StringgetPasswordEncoderName();/***@returnthenameofthe{@linkPasswordValidator}object.mandatory,defaultis{@link*PasswordValidator#DEFAULT_NAME}Validatorscanbeloadedusing{@link*GeoServerSecurityManager#loadPasswordValidator(String)}*/StringgetPasswordValidatorName();/**@returnthenumberofusers*/intgetUserCount()throwsIOException;/**@returnthenumberofgroups*/intgetGroupCount()throwsIOException;/***Returnsasetof{@linkGeoServerUser}objectshavingthespecifiedproperty**@parampropname*@throwsIOException*/SortedSet<GeoServerUser>getUsersHavingProperty(Stringpropname)throwsIOException;/***Returnsthenumberof{@linkGeoServerUser}objectshavingthespecifiedproperty**@parampropname*@throwsIOException*/intgetUserCountHavingProperty(Stringpropname)throwsIOException;/***Returnsasetof{@linkGeoServerUser}objectsNOThavingthespecifiedproperty**@parampropname*@throwsIOException*/SortedSet<GeoServerUser>getUsersNotHavingProperty(Stringpropname)throwsIOException;/***Returnsthenumberof{@linkGeoServerUser}objectsNOThavingthespecifiedproperty**@parampropname*@throwsIOException*/intgetUserCountNotHavingProperty(Stringpropname)throwsIOException;/***Returnsasetof{@linkGeoServerUser}objectshavingthepropertywiththespecifiedvalue**@parampropname*@parampropvalue*@throwsIOException*/SortedSet<GeoServerUser>getUsersHavingPropertyValue(Stringpropname,Stringpropvalue)throwsIOException;/***Returnsthenumberof{@linkGeoServerUser}objectshavingthepropertywiththespecified*value**@parampropname*@parampropvalue*@throwsIOException*/intgetUserCountHavingPropertyValue(Stringpropname,Stringpropvalue)throwsIOException;}
if(filePath==null){thrownewIllegalArgumentException("Nameofafilecannotbenull.");
if(content==null){thrownewIllegalArgumentException("Contentofafilecannotbenull.");
if(filePath==null){thrownewIllegalArgumentException("Nameofafilecannotbenull.");
if(checkFileExists(filePath)){thrownewIllegalArgumentException("Thefilealreadyexists");
if(!getS3Client().doesBucketExist(rootFolder)){getS3Client().createBucket(rootFolder);
if(scratchFile.exists()){scratchFile.delete();
if(filePath==null){thrownewIllegalArgumentException("Nameofafilecannotbenull.");
if(checkFileExists(filePath)){try{getS3Client().deleteObject(rootFolder,filePath);
else{returnfalse;
if(filePath==null){thrownewIllegalArgumentException("Nameofafilecannotbenull.");
if(index<0){returnnewFileReferenceImpl(this,filePath,filePath);
if(matcher.matches()){try{set.add(Integer.parseInt(matcher.group(1)));
if(endpoint==null){thrownewIllegalArgumentException("Theendpointisrequired,addaproperty:alias.s3.endpoint");
if(user==null){thrownewIllegalArgumentException("Theuserisrequired,addaproperty:alias.s3.user");
if(password==null){thrownewIllegalArgumentException("Thepasswordisrequired,addaproperty:alias.s3.password");
if(rootFolder==null){thrownewIllegalStateException("Therootfolderisrequired,addaproperty:alias.s3.rootfolder");
if(!endpoint.endsWith("/")){endpoint=endpoint+"/";
if(oinstanceofRuleMap){Map<String,String>ruleMap=(Map<String,String>)o;for(Map.Entry<String,String>entry:ruleMap.entrySet()){ElementruleElement=newElement(RULEELEMENT);ruleElement.setAttribute(RESOURCEATTR,entry.getKey());ruleElement.setText(entry.getValue());elem.getChildren().add(ruleElement);
else{thrownewIllegalArgumentException();
if(tableNameModel.getObject()!=null){ObjectcurrentTableName=tableNameModel.getObject();choices.add(String.valueOf(currentTableName));
if(this.sessionPoolFactory==null){finalISessionPoolFactorysessionFac=SessionPoolFactory.getInstance();this.sessionPoolFactory=sessionFac;
if(!inline){outputDirectory=getOutputDirectory(data);outputFile=newFile(outputDirectory,inputFile.getName());substitutions.put("output",outputFile);
ifnotinline,replaceinputswithoutput
if(!inline){List<String>names=getReplacementTargetNames(data);FileinputParent=inputFile.getParentFile();for(Stringname:names){Fileoutput=newFile(outputDirectory,name);Fileinput=newFile(inputParent,name);
if(output.exists()){//usesatomicrenameon*nix,deleteandcopyonWindowsIOUtils.rename(output,input);
else
if(input.exists()){input.delete();
if(outputDirectory!=null){FileUtils.deleteQuietly(outputDirectory);
if(result!=0){LOGGER.log(Level.SEVERE,"Failedtoexecutecommand"+cmd.toString()+"\nStandardoutputis:\n"+os.toString()+"\nStandarderroris:\n"+es.toString());returnfalse;
if(inline){cmd.addArgument("${input}",false);
else{
if(isOutputAfterInput()){cmd.addArgument("${input}",false);cmd.addArgument("${output}",false);
else{cmd.addArgument("${output}",false);cmd.addArgument("${input}",false);
ifthecommandlinemanipulatestheinputfiledirectly*/protectedbooleanisInline(){returnfalse;
ifinthecommandlinetheoutputfilecomesaftertheinputone.Thedefault*implementationreturnstrue*/protectedbooleanisOutputAfterInput(){returntrue;
if(!tempFile.mkdir()){thrownewIOException("Couldnotcreateworkdirectory"+tempFile.getAbsolutePath());
if(SystemUtils.IS_OS_WINDOWS){name=name+".exe";
if(systemPath==null){systemPath=System.getenv("path");
if(systemPath==null){thrownewIOException("Pathisnotset,cannotlocate"+name);
if(file.exists()&&file.isFile()&&file.canExecute()){returnfile;
if(isJsonFormat(operation)){returnBaseRequest.JSON_MIME;
else
if(isYamlFormat(operation)){returnBaseRequest.YAML_MIME;
else
if(isXMLFormat(operation)){returnBaseRequest.XML_MIME;
else{thrownewServiceException("Unknownformatrequested"+getFormat(operation));
if(isYamlFormat(operation)){YAMLFactoryfactory=newYAMLFactory();mapper=newObjectMapper(factory);mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);mapper.configure(SerializationFeature.WRITE_ENUMS_USING_TO_STRING,true);
else
if(isXMLFormat(operation)){mapper=newXmlMapper();//usingacustomannotationintrospectortosetthedesirednamespacemapper.setAnnotationIntrospector(newJacksonXmlAnnotationIntrospector(){@OverridepublicStringfindNamespace(Annotatedann){Stringns=super.findNamespace(ann);
if(ns==null||ns.isEmpty()){return"http://www.opengis.net/wfs/3.0";
else{returnns;
else{mapper=newObjectMapper();mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
if(validators!=null){for(IValidator<T>validator:validators){textField.add(validator);
if(BackupRestoreExecutionsProvider.ID==property){PageParameterspp=newPageParameters();pp.add("id",property.getModel(itemModel).getObject());pp.add("clazz",getType().getSimpleName());returnnewSimpleBookmarkableLink(id,BackupRestorePage.class,property.getModel(itemModel),pp);
else
if(BackupRestoreExecutionsProvider.STARTED==property){Datedate=(Date)property.getModel(itemModel).getObject();Stringpretty=PRETTY_TIME.format(date);returnnewLabel(id,pretty);
else
if(BackupRestoreExecutionsProvider.STARTED==property){Datedate=(Date)property.getModel(itemModel).getObject();Stringpretty=PRETTY_TIME.format(date);returnnewLabel(id,pretty);
else
if(BackupRestoreExecutionsProvider.ARCHIVEFILE==property){Stringpretty=((Resource)property.getModel(itemModel).getObject()).name();returnnewLabel(id,pretty);
if(!thereAreWorkspaces){super.error((String)newResourceModel("NewDataPage.noWorkspacesErrorMessage").getObject());
if(dataStores==null){finalIterator<DataAccessFactory>availableDataStores;availableDataStores=DataStoreUtils.getAvailableDataStoreFactories().iterator();Map<String,DataAccessFactory>storeNames=newHashMap<String,DataAccessFactory>();while(availableDataStores.hasNext()){DataAccessFactoryfactory=availableDataStores.next();
if(factory.getDisplayName()!=null){storeNames.put(factory.getDisplayName(),factory);
if(coverages==null){Format[]availableFormats=GridFormatFinder.getFormatArray();Map<String,Format>formatNames=newHashMap<String,Format>();for(Formatformat:availableFormats){formatNames.put(format.getName(),format);
if(value!=null&&!value.isEmpty()){String[]selectedRoles=value.split(";");//Checkrolesstringfor(Stringrole:selectedRoles){
if(availableRoles.contains(role)){checkedRoles.add(role);
if(value!=null&&valueinstanceofList){Listroles=(List)value;roleStr=StringUtils.join(roles.toArray(),";");
if(!roleStr.isEmpty()){roleStr=roleStr+";";
if(configs==null){configs=newArrayList<AggregateTypeConfiguration>();configModel.setObject(configs);
if(property==ConfigurationListProvider.NAME){returneditLink(id,itemModel);
else
if(property==ConfigurationListProvider.SOURCES){returnnewLabel(id,property.getModel(itemModel));
else
if(property==ConfigurationListProvider.REMOVE){returnremoveLink(id,itemModel);
else{returnnull;
if(isJAIExtEnabled){je=info.getJAIEXTInfo();
if(!isJAIExtEnabled){jaiExtPanel.setVisible(false);
if(!PackageUtil.isCodecLibAvailable()){encoders.remove(PngEncoderType.NATIVE);
if(!encoders.contains(editor.getModelObject())){editor.setModelObject(PngEncoderType.PNGJ);
if(container!=null&&contained!=null){contained.containerGroups.add(container);
if(containers!=null){containers.remove(data);
if(groups==null){returnCollections.emptyList();
if(id==null){returnCollections.emptyList();
if(summary==null){returnCollections.emptyList();
if(!groups.contains(lg)){
if(lg.getMode()!=LayerGroupInfo.Mode.SINGLE){groups.add(lg);
if(obj==this){returntrue;
if(!(objinstanceofLayerGroupSummary)){returnfalse;
if(workspace==null){returnnewString[]{name};
else{returnnewString[]{workspace,name};
if(workspace==null){returnname;
else{returnworkspace+":"+name;
if(event.getSource()instanceofLayerGroupInfo){LayerGroupInfolg=(LayerGroupInfo)event.getSource();addGroupInfo(lg);registerContainedGroups(lg);
if(event.getSource()instanceofLayerGroupInfo){LayerGroupInfolg=(LayerGroupInfo)event.getSource();clearGroupInfo(lg);
if(sourceinstanceofLayerGroupInfo){LayerGroupInfolg=(LayerGroupInfo)event.getSource();//wasthelayergrouprenamed,moved,oritscontentschanged?intnameIdx=event.getPropertyNames().indexOf("name");
if(nameIdx!=-1){StringnewName=(String)event.getNewValues().get(nameIdx);updateGroupName(lg.getId(),newName);
if(wsIdx!=-1){WorkspaceInfonewWorkspace=(WorkspaceInfo)event.getNewValues().get(wsIdx);updateGroupWorkspace(lg.getId(),newWorkspace);
if(layerIdx!=-1){List<PublishedInfo>oldLayers=(List<PublishedInfo>)event.getOldValues().get(layerIdx);List<PublishedInfo>newLayers=(List<PublishedInfo>)event.getNewValues().get(layerIdx);updateContainedLayers(groupCache.get(lg.getId()),oldLayers,newLayers);
if(modeIdx!=-1){ModenewMode=(Mode)event.getNewValues().get(modeIdx);updateGroupMode(lg.getId(),newMode);
else
if(sourceinstanceofWorkspaceInfo){intnameIdx=event.getPropertyNames().indexOf("name");
if(nameIdx!=-1){StringoldName=(String)event.getOldValues().get(nameIdx);StringnewName=(String)event.getNewValues().get(nameIdx);updateWorkspaceNames(oldName,newName);
if(removedinstanceofLayerInfo){StringresourceId=((LayerInfo)removed).getResource().getId();Set<LayerGroupSummary>containers=resourceContainmentCache.get(resourceId);
if(containers!=null){synchronized(resourceId){containers.remove(groupSummary);
if(containers.isEmpty()){resourceContainmentCache.remove(resourceId,containers);
else{LayerGroupInfochild=(LayerGroupInfo)removed;LayerGroupSummarysummary=groupCache.get(child.getId());
if(summary!=null){summary.containerGroups.remove(groupSummary);
if(addedinstanceofLayerInfo){StringresourceId=((LayerInfo)added).getResource().getId();synchronized(resourceId){Set<LayerGroupSummary>containers=resourceContainmentCache.computeIfAbsent(resourceId,CONCURRENT_SET_BUILDER);containers.add(groupSummary);
else{LayerGroupInfochild=(LayerGroupInfo)added;LayerGroupSummarysummary=groupCache.get(child.getId());
if(summary!=null){summary.containerGroups.add(groupSummary);
if(summary!=null){summary.workspace=newWorkspace==null?null:newWorkspace.getName();
if(summary!=null){summary.name=newName;
if(formatQuantity){Stringvalue=formatQuantity(quantity,digits,unit);rule=value+""+symbol+"x";
else{rule=Double.toString(quantity)+""+symbol+"x";
if(label!=null){hasLabel=true;super.add(newTextManager(label,vAling,hAlign,bkgColor,requestedDimension,labelFont,labelFontColor,fontAntiAliasing,borderColor));
elsesuper.add(null);
if(previousCME==null)leftEdge=true;
elseleftEdge=false;ColorpreviousColor;
if(!leftEdge){previousColor=LegendUtils.color(previousCME);finaldoubleopacity=LegendUtils.getOpacity(previousCME);previousColor=newColor(previousColor.getRed(),previousColor.getGreen(),previousColor.getBlue(),(int)(255*opacity+0.5));
else{previousColor=null;
if(formatQuantity){rule="";lastRuleText="";
if(opacity>0){StringformattedQuantity=formatQuantity(quantity,digits,unit);
if(leftEdge){rule=formattedQuantity+">=x";lastRuleText="";
else{rule=formattedQuantity+"";lastRuleText=formattedQuantity+"<=x";
else{finalStringformattedQuantity=Double.toString(quantity);
if(leftEdge){rule=formattedQuantity+">=x";lastRuleText="";
else{rule=formattedQuantity+"=x";lastRuleText=formattedQuantity+"<=x";
if(label!=null){hasLabel=true;super.add(newTextManager(label,vAling,hAlign,bkgColor,requestedDimension,labelFont,labelFontColor,leftEdge,borderColor));
else{super.add(null);
if(previousCME==null)leftEdge=true;
elseleftEdge=false;Colorcolor=LegendUtils.color(currentCME);finaldoubleopacity=LegendUtils.getOpacity(currentCME);color=newColor(color.getRed(),color.getGreen(),color.getBlue(),(int)(255*opacity));super.add(newColorManager.SimpleColorManager(color,opacity,requestedDimension,borderColor));Stringlabel=currentCME.getLabel();doublequantity1=leftEdge?LegendUtils.getQuantity(currentCME):LegendUtils.getQuantity(previousCME);doublequantity2=LegendUtils.getQuantity(currentCME);//AddedvariationforDynamicColorMapStringruleText;Stringsymbol1=null,symbol2=null;
if(leftEdge)symbol1="<";
else{symbol1="<=";symbol2="<";
if(formatQuantity){ruleText="";
if(opacity>0){Stringvalue1=formatQuantity(quantity1,digits,unit);Stringvalue2=formatQuantity(quantity2,digits,unit);
if(leftEdge){ruleText="x"+symbol1+value1;
else
if(Double.isInfinite(quantity2)){ruleText=value1+symbol1+"x";
else{ruleText=value1+symbol1+"x"+symbol2+value2;
else{finalStringvalue1=Double.toString(quantity1);finalStringvalue2=Double.toString(quantity2);
if(leftEdge){ruleText="x"+symbol1+value1;
else
if(Double.isInfinite(quantity2)){ruleText=value1+symbol1+"x";
else{ruleText=value1+symbol1+"x"+symbol2+value2;
if(label!=null){hasLabel=true;super.add(newTextManager(label,vAling,hAlign,bkgColor,requestedDimension,labelFont,labelFontColor,leftEdge,borderColor));
elsesuper.add(null);
if(fontAntiAliasing)graphics.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_ON);//Halign==centervAlign==bottomfinaldoubleminx=clipBox.getMinX();finaldoubleminy=clipBox.getMinY();finaldoublew=clipBox.getWidth();finaldoubleh=clipBox.getHeight();finalDimensiondimension=getPreferredDimension(graphics);//wheredowedraw?finalintxText;
switch(hAlign){caseCENTERED:xText=(int)(minx+(w-dimension.getWidth())/2.0+0.5);break;caseLEFT:xText=(int)(minx+0.5);break;caseRIGHT:xText=(int)(minx+(w-dimension.getWidth())+0.5);break;caseJUSTIFIED:thrownewUnsupportedOperationException("Unsupported");default:thrownewIllegalStateException("Unsupportedhorizontalalignment"+hAlign);
switch(vAlign){caseBOTTOM:yText=(int)(miny+h-graphics.getFontMetrics().getDescent()+0.5);break;caseTOP:yText=(int)(miny+graphics.getFontMetrics().getHeight()+0.5);break;caseMIDDLE:yText=(int)(miny+(h+graphics.getFontMetrics().getHeight())/2+0.5);break;default:thrownewIllegalStateException("Unsupportedverticalalignment"+vAlign);
if(bkgOpacity>0){//OPAQUEfinalColoroldColor=graphics.getColor();finalColornewColor=newColor(bkgColor.getRed(),bkgColor.getGreen(),bkgColor.getBlue(),(int)(255*bkgOpacity+0.5));graphics.setColor(newColor);graphics.fill(clipBox);//makebkgColorcustomizablegraphics.setColor(borderColor);
if(completeBorder){finalintminx=(int)(clipBox.getMinX()+0.5);finalintminy=(int)(clipBox.getMinY()+0.5);finalintw=(int)(clipBox.getWidth()+0.5)-1;finalinth=(int)(clipBox.getHeight()+0.5)-1;graphics.draw(newRectangle2D.Double(minx,miny,w,h));
else{//TRANSPARENTfinalColoroldColor=graphics.getColor();//whitebackgroundgraphics.setColor(Color.white);graphics.fill(clipBox);//nowtheredcrossgraphics.setColor(Color.RED);finalintminx=(int)(clipBox.getMinX()+0.5);finalintminy=(int)(clipBox.getMinY()+0.5);finalintmaxx=(int)(minx+clipBox.getWidth()-1+0.5);finalintmaxy=(int)(miny+clipBox.getHeight()-1+0.5);graphics.drawLine(minx,miny,maxx,maxy);graphics.drawLine(minx,maxy,maxx,miny);graphics.setColor(borderColor);
if(completeBorder){finalintw=(int)(clipBox.getWidth()+0.5)-1;finalinth=(int)(clipBox.getHeight()+0.5)-1;graphics.draw(newRectangle2D.Double(minx,miny,w,h));
if(previousColor==null)leftEdge=true;
if(!leftEdge){//rectangleforthegradientfinalRectangle2D.DoublerectLegend=newRectangle2D.Double(minx,miny,w,h/2);//gradientpaintfinalPaintoldPaint=graphics.getPaint();finalGradientPaintpaint=newGradientPaint((float)minx,(float)miny,previousColor,(float)minx,(float)(miny+h/2),bkgColor);//dothemagicgraphics.setPaint(paint);graphics.fill(rectLegend);//restorepaintgraphics.setPaint(oldPaint);
if(completeBorder){finalColoroldColor=graphics.getColor();//makebkgColorcustomizablegraphics.setColor(borderColor);finalintminx_=(int)(clipBox.getMinX()+0.5);finalintmaxx=(int)(minx+clipBox.getWidth()+0.5)-1;finalintmaxy=(int)(miny+clipBox.getHeight()+0.5)-1;graphics.drawLine(minx_,maxy,maxx,maxy);//restorebkgColorgraphics.setColor(oldColor);
if(validators!=null){for(IValidator<?superString>validator:validators){textField.add(validator);
if(input!=null&&!input.equals("")){file=newFile(input);
if(caller!=null){classTemplateLoader=newClassTemplateLoader(caller,"");
if(ft==null){return;//thrownewIllegalArgumentException("Nofeaturetypenamed"+featureType.getName()+//"incatalog");
if(c==null){return;//thrownewIllegalArgumentException("Nocoveragenamed"+coverageName+"in//catalog");
if(resource!=null){//firstcheckrelativetosetresourcetemplate=dd.findSuppResourceFile(resource,path);
if(template==null){//nexttryrelativetothestoretemplate=dd.findSuppStoreFile(resource.getStore(),path);
if(template==null){//nexttryrelativetotheworkspacetemplate=dd.findSuppWorkspaceFile(resource.getStore().getWorkspace(),path);
if(template==null){//tryglobalsupplementaryfilestemplate=dd.findSuppWorkspacesFile(resource.getStore().getWorkspace(),path);
if(template!=null){returntemplate;
if(template!=null){returntemplate;
if(template!=null){returntemplate;
if(classTemplateLoader!=null){Objectsource=classTemplateLoader.findTemplateSource(path);//wrapthesourceinasourcethatmaintainstheorignialpath
if(source!=null){returnnewClassTemplateSource(path,source);
if(featureType!=null){baseDirName="featureTypes";Stringname=featureType.getTypeName();Stringnamespace=featureType.getName().getNamespaceURI();FeatureTypeInfoftInfo=null;
if(catalog!=null&&namespace!=null){NamespaceInfonsInfo=catalog.getNamespaceByURI(namespace);
if(nsInfo!=null){ftInfo=catalog.getFeatureTypeByName(nsInfo.getPrefix(),name);
if(catalog!=null&&ftInfo==null){ftInfo=catalog.getFeatureTypeByName(name);
if(ftInfo!=null){Stringmetadata=ftInfo.getMetadata().get("dirName",String.class);
if(metadata!=null){dirName=metadata;
else{dirName=ftInfo.getNamespace().getPrefix()+"_"+ftInfo.getName();
else{dirName=null;//unavaialble
else
if(coverageName!=null){baseDirName="coverages";CoverageInfocoverageInfo=catalog.getCoverageByName(coverageName);dirName=coverageInfo.getMetadata().get("dirName",String.class);
else{baseDirName="featureTypes";dirName="";
if(template!=null){returntemplate;
if(featureType!=null){NamespaceInfonsInfo=null;
if(featureType.getName().getNamespaceURI()!=null){nsInfo=catalog.getNamespaceByURI(featureType.getName().getNamespaceURI());
if(nsInfo!=null){//trylookingupthetemplateinthedefaultlocationfortheparticular//namespaces//undertemplates/<namespace>template=(File)fileTemplateLoader.findTemplateSource("templates"+File.separator+nsInfo.getPrefix()+File.separator+path);
if(template!=null)returntemplate;//next,tryrelativetofeatureTypesorcoveragesdirectory,asappropriatetemplate=(File)fileTemplateLoader.findTemplateSource(baseDirName+File.separator+path);
if(template!=null){returntemplate;
ifthefeaturetypeisnotfound,andhappenswhenever//thefeaturetypeisaremoteone//Noproblem,wejustgoon,therewon'tbeanyspecifictemplateforit
if(sourceinstanceofFile){//loadedfromfilereturnfileTemplateLoader.getLastModified(source);
else{//loadedfromclassClassTemplateSourcewrapper=(ClassTemplateSource)source;returnclassTemplateLoader.getLastModified(wrapper.source);
if(sourceinstanceofFile){//loadedfromfilereturnfileTemplateLoader.getReader(source,encoding);
else{//gettehresourcefortherawsourceasuseitrightawayClassTemplateSourcewrapper=(ClassTemplateSource)source;returnclassTemplateLoader.getReader(wrapper.source,encoding);
if(sourceinstanceofFile){fileTemplateLoader.closeTemplateSource(source);
else{ClassTemplateSourcewrapper=(ClassTemplateSource)source;//closetherawsourceclassTemplateLoader.closeTemplateSource(wrapper.source);//cleanupwrapper.path=null;wrapper.source=null;
if(!Resources.exists(res)){IOUtils.copy(getClass().getResourceAsStream("/taskManager-applicationContext.xml"),res.out());
if(config!=null)this.name=config.getName();
if(splitTargetTableName.length==2){assertFalse(tableExists(TARGETDB_NAME,splitTargetTableName[0],"_temp%"));assertTrue(tableExists(TARGETDB_NAME,splitTargetTableName[0],splitTargetTableName[1]));
else{assertFalse(tableExists(TARGETDB_NAME,null,"_temp%"));assertTrue(tableExists(TARGETDB_NAME,null,TARGET_TABLE_NAME));
if(splitTargetTableName.length==2){assertFalse(tableExists(TARGETDB_NAME,splitTargetTableName[0],splitTargetTableName[1]));
else{assertFalse(tableExists(TARGETDB_NAME,null,TARGET_TABLE_NAME));
if(split.length==2){assertFalse(tableExists(TARGETDB_NAME,split[0],"_temp%"));assertTrue(tableExists(TARGETDB_NAME,split[0],split[1]));
else{assertFalse(tableExists(TARGETDB_NAME,null,"_temp%"));assertTrue(tableExists(TARGETDB_NAME,null,TARGET_TABLE_FROM_VIEW_NAME));
if(numberOfColumnsTarget==5){assertEquals(2,numberOfindexesTarget);assertEquals("shape",getColumnName(TARGETDB_NAME,TARGET_TABLE_FROM_VIEW_NAME,3));
else{assertEquals(1,numberOfindexesTarget);
if(split.length==2){assertFalse(tableExists(TARGETDB_NAME,split[0],split[1]));
else{assertFalse(tableExists(TARGETDB_NAME,null,TARGET_TABLE_NAME));
ifitexists.**@throwsSchedulerException*@throwsSQLException*/@TestpublicvoidtestCopyViewWithGeneratedIdColumn()throwsSchedulerException,SQLException{dataUtil.setConfigurationAttribute(config,ATT_SOURCE_DB,SOURCEDB_NAME);dataUtil.setConfigurationAttribute(config,ATT_TARGET_DB,TARGETDB_NAME);dataUtil.setConfigurationAttribute(config,ATT_TABLE_NAME,VIEW_W_GENERATED_ID);dataUtil.setConfigurationAttribute(config,ATT_TARGET_TABLE_NAME,TARGET_TABLE_FROM_VIEW_NAME);config=dao.save(config);Triggertrigger=TriggerBuilder.newTrigger().forJob(batch.getId().toString()).startNow().build();scheduler.scheduleJob(trigger);while(scheduler.getTriggerState(trigger.getKey())!=TriggerState.NONE){//waitingtobedone.
if(split.length==2){assertFalse(tableExists(TARGETDB_NAME,split[0],"_temp%"));assertTrue(tableExists(TARGETDB_NAME,split[0],split[1]));
else{assertFalse(tableExists(TARGETDB_NAME,null,"_temp%"));assertTrue(tableExists(TARGETDB_NAME,null,TARGET_TABLE_FROM_VIEW_NAME));
if(split.length==2){assertFalse(tableExists(TARGETDB_NAME,split[0],split[1]));
else{assertFalse(tableExists(TARGETDB_NAME,null,TARGET_TABLE_NAME));
if(split.length==2){assertFalse(tableExists(TARGETDB_PG_NAME,split[0],"_temp%"));assertTrue(tableExists(TARGETDB_PG_NAME,split[0],split[1]));
else{assertFalse(tableExists(TARGETDB_PG_NAME,null,"_temp%"));assertTrue(tableExists(TARGETDB_PG_NAME,null,TARGET_TABLE_CAMELCASE_NAME));
if(split.length==2){assertFalse(tableExists(TARGETDB_PG_NAME,split[0],split[1]));
else{assertFalse(tableExists(TARGETDB_PG_NAME,null,TARGET_TABLE_NAME));
ifitdoesn'texist.**@throwsSchedulerException*@throwsSQLException*/@TestpublicvoidtestTableInNewSchema()throwsSchedulerException,SQLException{dataUtil.setConfigurationAttribute(config,ATT_SOURCE_DB,SOURCEDB_NAME);dataUtil.setConfigurationAttribute(config,ATT_TARGET_DB,TARGETDB_NAME);dataUtil.setConfigurationAttribute(config,ATT_TABLE_NAME,TABLE_NAME);dataUtil.setConfigurationAttribute(config,ATT_TARGET_TABLE_NAME,TARGET_TABLE_NAME_NEW_SCHEMA);config=dao.save(config);Triggertrigger=TriggerBuilder.newTrigger().forJob(batch.getId().toString()).startNow().build();scheduler.scheduleJob(trigger);while(scheduler.getTriggerState(trigger.getKey())!=TriggerState.NONE){}String[]splitTargetTableName=TARGET_TABLE_NAME_NEW_SCHEMA.split("\\.",2);
if(splitTargetTableName.length==2){assertFalse(tableExists(TARGETDB_NAME,splitTargetTableName[0],"_temp%"));assertTrue(tableExists(TARGETDB_NAME,splitTargetTableName[0],splitTargetTableName[1]));
else{assertFalse(tableExists(TARGETDB_NAME,null,"_temp%"));assertTrue(tableExists(TARGETDB_NAME,null,TARGET_TABLE_NAME_NEW_SCHEMA));
if(splitTargetTableName.length==2){assertFalse(tableExists(TARGETDB_NAME,splitTargetTableName[0],splitTargetTableName[1]));
else{assertFalse(tableExists(TARGETDB_NAME,null,TARGET_TABLE_NAME_NEW_SCHEMA));
if(metaData.storesUpperCaseIdentifiers()){rs=metaData.getIndexInfo(null,null,tableName.toUpperCase(),false,false);
else{rs=metaData.getIndexInfo(null,null,tableName,false,false);
if(md.storesUpperCaseIdentifiers()){rs=md.getTables(null,schema.toUpperCase(),pattern.toUpperCase(),newString[]{"TABLE"});
else{rs=md.getTables(null,schema,pattern,newString[]{"TABLE"});
if(count==null){count=newInteger(1);
else{count=newInteger(count+1);
if(filter!=null){request.setFilter(filter);
ifwedon'tfindit//finalLayerInfolinfo=NCNameResourceCodec.getCoverage(catalog,request.getCoverageId());
if(linfo==null){thrownewWCS20Exception("Couldnotlocatecoverage"+request.getCoverageId(),WCS20Exception.WCS20ExceptionCode.NoSuchCoverage,"coverageId");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("ExecutingGetCoveragerequestoncoverage:"+linfo.toString());
if(request.getFormat()==null){try{StringnativeFormat=mimeMapper.mapNativeFormat(cinfo);request.setFormat(nativeFormat);
ifIcanuseoverviewsanddosubsamplingfinalHintshints=GeoTools.getDefaultHints();hints.add(WCSUtils.getReaderHints(wcs));hints.add(newRenderingHints(JAI.KEY_BORDER_EXTENDER,BorderExtender.createInstance(BorderExtender.BORDER_COPY)));//hints.add(new//RenderingHints(JAI.KEY_REPLACE_INDEX_COLOR_MODEL,Boolean.FALSE));//TODOcheck//interpolation//getareaderforthiscoveragefinalGridCoverage2DReaderreader=(GridCoverage2DReader)cinfo.getGridCoverageReader(newDefaultProgressListener(),hints);WCSDimensionsSubsetHelperhelper=parseGridCoverageRequest(cinfo,reader,request,extensions);GridCoverageRequestgcr=helper.getGridCoverageRequest();//TODOconsiderdealingwiththeFormatinstanceinsteadofaStringparsingorcheck//againstWCSUtils.isSupportedMDOutputFormat(String).finalGridCoverageFactorycoverageFactory=CoverageFactoryFinder.getGridCoverageFactory(hints);
if(readerinstanceofStructuredGridCoverage2DReader&&formatSupportMDOutput(request.getFormat())){//SplitthemainrequestintoaListofrequestsinordertoreadmorecoveragesto//bestackedfinalSet<GridCoverageRequest>requests=helper.splitRequestToSet();
if(requests==null||requests.isEmpty()){thrownewIllegalArgumentException("Splittingrequestsreturnednothing");
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Splittingrequestgenerated"+requests.size()+"subrequests");
iftheestimatedsizeisgreaterthanthatofthemaximumoutputmemory//Limitcheckisperformedonlywhenthelimitisdefined
if(outputLimit>0&&estimatedSize>outputLimit){thrownewWcsException("Thisrequestistryingtogeneratetoomuchdata,"+"thelimitis"+formatBytes(outputLimit)+"buttheestimatedamountofbytestobe"+"writtenintheoutputis"+formatBytes(estimatedSize));
else{//IncrementalSizenotusedcoverage=setupCoverage(helper,gcr,request,reader,hints,extensions,null,null,null,coverageFactory);
if(coverage!=null){CoverageCleanerCallback.addCoverages(coverage);
if(coverages==null||coverages.isEmpty()){thrownewIllegalStateException("Unabletoreadacoverageforthecurrentrequest"+coverageType.toString());
if(wcs.isLatLon()&&enforceLatLonAxesOrder){coverage=enforceLatLongOrder(coverage,hints,gridCoverageRequest.getOutputCRS());
if(incrementalOutputSize==null){WCSUtils.checkOutputLimits(wcs,coverage.getGridGeometry().getGridRange2D(),coverage.getRenderedImage().getSampleModel());
else{//Checkforeachcoverageadded
ifthetotalcoveragedimensionexceedsthemaximum//limit//IfthesizeisexceededanexceptionisthrownincrementalOutputSize.addSize(coverage);
if(readerinstanceofStructuredGridCoverage2DReader&&coverageDimensions!=null){//SettingdimensionsaspropertiesMapmap=coverage.getProperties();
if(map==null){map=newHashMap();
if(sampleDimensions!=null&&sampleDimensions.length>0){coverage=GridCoverageWrapper.wrapCoverage(coverage,coverage,sampleDimensions,null,true);
if(!(extensions==null||extensions.size()==0||!extensions.containsKey("Scaling"))){finalExtensionItemTypeextensionItem=extensions.get("Scaling");assertextensionItem!=null;//getscalingscaling=(ScalingType)extensionItem.getObjectContent();
if(scaling==null){thrownewIllegalStateException("ScalingextensioncontainedanullScalingType");
if(coverageinstanceofGridCoverageWrapper){for(GridSampleDimensiondimension:coverage.getSampleDimensions()){dimensions.add(dimension);
if(coverages.size()==1){returnfirst;
if(crsinstanceofGeographicCRS||mapProjectioninstanceofMercator){doubleoffset;
if(crsinstanceofGeographicCRS){offset=360;
else{offset=computeMercatorWorldSpan(crs,mapProjection);
if(Math.abs(c.getEnvelope().getMinimum(0)+offset-first.getEnvelope().getMaximum(0))<EPS){GridCoverage2Ddisplaced=displaceCoverage(coverages.get(1),offset);coverages.set(i,displaced);
if(extensions==null||extensions.size()==0||!extensions.containsKey(WCS20Const.OVERVIEW_POLICY_EXTENSION)){//NOextensionathandreturnnull;
if(extensionItem.getName().equals(WCS20Const.OVERVIEW_POLICY_EXTENSION)){StringoverviewPolicy=extensionItem.getSimpleContent();//checks
if(overviewPolicy==null){thrownewWCS20Exception(WCS20Const.OVERVIEW_POLICY_EXTENSION+"wasnull",WCS20ExceptionCode.MissingParameterValue,"null");
if(epsgCode!=null&&epsgCode>0){//finalCRSCoordinateReferenceSystemfinalCRS=latLonCRSFactory.createCoordinateReferenceSystem(SRS_STARTER+epsgCode);
if(CRS.getAxisOrder(outputCRS).equals(CRS.getAxisOrder(finalCRS))){returncoverage;
if(epsgCode!=null&&epsgCode>0){CoordinateReferenceSystemoriginalCRS=latLonCRSFactory.createCoordinateReferenceSystem(SRS_STARTER+epsgCode);return!CRS.getAxisOrder(originalCRS).equals(CRS.getAxisOrder(outputCRS));
ifthisisanaxiswelikefinalintindex=envelopeDimensionsMapper.getAxisIndex(envelope,axisLabel);
if(index==0||index==1){//foundit!interpolation=axesInterpolations.get(axisLabel).getInterpolation();break;
iftherequestisadatelinecrossingone,itwillreturntwo*instead**@paramcinfo*@paramreader*@paramhints*/privateList<GridCoverage2D>readCoverage(WCSDimensionsSubsetHelperhelper,GridCoverageRequestrequest,GridCoverage2DReaderreader,Hintshints,ImageSizeRecorderincrementalInputSize,finalScalingTypescaling,finaldouble[]preAppliedScale)throwsException{CoverageInfocinfo=helper.getCoverageInfo();WCSEnveloperequestedEnvelope=helper.getRequestedEnvelope();//checksInterpolationspatialInterpolation=request.getSpatialInterpolation();Utilities.ensureNonNull("interpolation",spatialInterpolation);////check
ifweneedtoreprojectthesubsetenvelopebacktocoverageCRS////thisdoesnotmeanweneedtoreprojectthecoverageattheend//astheoutputCrscanbedifferentfromthesubsetCrs////getsourcecrsfinalCoordinateReferenceSystemcoverageCRS=reader.getCoordinateReferenceSystem();WCSEnvelopesubset=request.getSpatialSubset();List<GridCoverage2D>result=newArrayList<GridCoverage2D>();List<GeneralEnvelope>readEnvelopes=newArrayList<GeneralEnvelope>();
if(subset.isCrossingDateline()){GeneralEnvelope[]envelopes=subset.getNormalizedEnvelopes();addEnvelopes(envelopes[0],readEnvelopes,coverageCRS);addEnvelopes(envelopes[1],readEnvelopes,coverageCRS);
else{addEnvelopes(subset,readEnvelopes,coverageCRS);
ifapreviousreadalreadycoveredthisenvelope,readers//canreturnmorethanweaskedGridCoverage2Dcov=null;BoundingBoxreadBoundingBox=newEnvelope2D(readEnvelope);for(GridCoverage2Dgc:readCoverages){Envelope2Dgce=gc.getEnvelope2D();
if(gce.contains(readBoundingBox)){cov=gc;break;
if(cov==null){cov=readCoverage(cinfo,request,reader,hints,incrementalInputSize,spatialInterpolation,coverageCRS,readEnvelope,requestedEnvelope,scaling,preAppliedScale);
if(cov==null){continue;
if(covEnvelope.contains(readBoundingBox)&&(covEnvelope.getWidth()>readBoundingBox.getWidth()||covEnvelope.getHeight()>readBoundingBox.getHeight())){GridCoverage2Dcropped=cropOnEnvelope(cov,readEnvelope);result.add(cropped);
else{result.add(cov);
if(handler==null){readEnvelopes.add(newGeneralEnvelope(envelope));
else{List<ReferencedEnvelope>queryEnvelopes=handler.getQueryEnvelopes();for(ReferencedEnvelopeqe:queryEnvelopes){readEnvelopes.add(newGeneralEnvelope(qe));
if(!CRS.equalsIgnoreMetadata(subset.getCoordinateReferenceSystem(),coverageCRS)){subset=CRS.transform(subset,coverageCRS);
if(request.getTemporalSubset()!=null){List<GeneralParameterDescriptor>descriptors=readParametersDescriptor.getDescriptor().descriptors();List<Object>times=newArrayList<Object>();times.add(request.getTemporalSubset());readParameters=CoverageUtils.mergeParameter(descriptors,readParameters,times,"TIME","Time");
if(request.getElevationSubset()!=null){List<GeneralParameterDescriptor>descriptors=readParametersDescriptor.getDescriptor().descriptors();List<Object>elevations=newArrayList<Object>();elevations.add(request.getElevationSubset());readParameters=CoverageUtils.mergeParameter(descriptors,readParameters,elevations,"ELEVATION","Elevation");
if(request.getFilter()!=null){List<GeneralParameterDescriptor>descriptors=readParametersDescriptor.getDescriptor().descriptors();readParameters=CoverageUtils.mergeParameter(descriptors,readParameters,request.getFilter(),"Filter");
if(request.getSortBy()!=null){List<GeneralParameterDescriptor>descriptors=readParametersDescriptor.getDescriptor().descriptors();StringsortBySpec=request.getSortBy().stream().map(sb->sb.getPropertyName().getPropertyName()+""+sb.getSortOrder().name().charAt(0)).collect(Collectors.joining(","));readParameters=CoverageUtils.mergeParameter(descriptors,readParameters,sortBySpec,"SORTING");
if(request.getDimensionsSubset()!=null&&!request.getDimensionsSubset().isEmpty()){finalList<GeneralParameterDescriptor>descriptors=newArrayList<GeneralParameterDescriptor>(readParametersDescriptor.getDescriptor().descriptors());Set<ParameterDescriptor<List>>dynamicParameters=reader.getDynamicParameters();descriptors.addAll(dynamicParameters);Map<String,List<Object>>dimensionsSubset=request.getDimensionsSubset();Set<String>dimensionKeys=dimensionsSubset.keySet();for(Stringkey:dimensionKeys){List<Object>dimValues=dimensionsSubset.get(key);readParameters=CoverageUtils.mergeParameter(descriptors,readParameters,dimValues,key);
if(sameCRS){//weshouldnotbereprojecting//let'screateasubsettingGG2D(Takingoverviewsandrequestedscalingintoaccount)MathTransformtransform=getMathTransform(reader,requestedEnvelope!=null?requestedEnvelope:subset,request,PixelInCell.CELL_CENTER,scaling);readGG=newGridGeometry2D(PixelInCell.CELL_CENTER,transform,subset,hints);
else{//wearereprojecting,let'saddagutterinrasterspace.////Weneedtoinvestigatemuchmoreandalsoweneed//todothisonlywhenneeded//////addgutterbyincreasingsizeof10pixelseachsideRectanglerasterRange=CRS.transform(reader.getOriginalGridToWorld(PixelInCell.CELL_CORNER).inverse(),subset).toRectangle2D().getBounds();rasterRange.setBounds(rasterRange.x-10,rasterRange.y-10,rasterRange.width+20,rasterRange.height+20);rasterRange=rasterRange.intersection((GridEnvelope2D)reader.getOriginalGridRange());//makesureweareinit//readreadGG=newGridGeometry2D(newGridEnvelope2D(rasterRange),PixelInCell.CELL_CENTER,reader.getOriginalGridToWorld(PixelInCell.CELL_CENTER),coverageCRS,hints);
if(hints!=null){readHints.putAll(hints);
if(request.getOverviewPolicy()!=null){readHints.add(newHints(Hints.OVERVIEW_POLICY,request.getOverviewPolicy()));
if(coverage!=null){//checklimitsagain
if(incrementalInputSize==null){WCSUtils.checkInputLimits(wcs,coverage);
else{//Checkforeachcoverageadded
ifthetotalcoveragedimensionexceedsthemaximum//limit//IfthesizeisexceededanexceptionisthrownincrementalInputSize.addSize(coverage);
if(scaling!=null){MathTransformcmt=coverage.getGridGeometry().getGridToCRS();MathTransformrmt=reader.getOriginalGridToWorld(PixelInCell.CELL_CENTER);
if(!(cmtinstanceofAffineTransform2D)||!(rmtinstanceofAffineTransform2D)){LOGGER.log(Level.FINE,"Cannotcheck
ifthereturnedcoverage"+"matchedtherequestedresolutionduetoanonaffine"+"gridtoworldbackingit");
else{AffineTransform2Dcat=(AffineTransform2D)cmt;AffineTransform2Drat=(AffineTransform2D)rmt;preAppliedScale[0]=cat.getScaleX()/rat.getScaleX();preAppliedScale[1]=cat.getScaleY()/rat.getScaleY();
ifthereisnoscaling,theoverviewpolicy//isgoingtobetakencareofwhensendingdatatotheimagereader(failingtodo//sowillcauseOOMorgettheprocessingthreadblockedforalongtimebecause//thereaderisnomoreallowedtousesubsampling)ScalingPolicyscalingPolicy=scaling==null?null:ScalingPolicy.getPolicy(scaling);
if(scalingPolicy==null||scalingPolicy==ScalingPolicy.DoNothing){returnreader.getOriginalGridToWorld(pixelInCell);
if(policy==ScalingPolicy.ScaleToSize||policy==ScalingPolicy.ScaleToExtent){int[]scalingSize=ScalingPolicy.getTargetSize(scaling);//Gettingtherequestedresolution(usingenvelopeandrequestedscaleSize)finalGridToEnvelopeMappermapper=newGridToEnvelopeMapper(newGridEnvelope2D(0,0,scalingSize[0],scalingSize[1]),subset);AffineTransformscalingTransform=mapper.createAffineTransform();requestedResolution[0]=XAffineTransform.getScaleX0(scalingTransform);requestedResolution[1]=XAffineTransform.getScaleY0(scalingTransform);
else{//OnlyscaleFactorsbasedwillbehandledheredouble[]scalingFactors=ScalingPolicy.getScaleFactors(scaling);requestedResolution[0]=nativeResX/scalingFactors[0];requestedResolution[1]=nativeResY/scalingFactors[1];
if(extensions==null||extensions.size()==0||!extensions.containsKey(identifier)){//NOextensionathandreturndefaultCRS;
if(extensionItem.getName().equals(identifier)){//getURIStringcrsName=extensionItem.getSimpleContent();//checks
if(crsName==null){thrownewWCS20Exception(identifier+"wasnull",WCS20ExceptionCode.NotACrs,"null");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Extractingextensionsfromprovidedrequest");
if(extension!=null){finalEList<ExtensionItemType>extensions=extension.getContents();for(finalExtensionItemTypeextensionItem:extensions){finalStringextensionName=extensionItem.getName();
if(extensionName==null||extensionName.length()<=0){thrownewWCS20Exception("Nullextension");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Parsingextension"+extensionName);
if(extensionName.equals("subsettingCrs")){parsedExtensions.put("subsettingCrs",extensionItem);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AddedextensionsubsettingCrs");
else
if(extensionName.equals("outputCrs")){parsedExtensions.put("outputCrs",extensionItem);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AddedextensionoutputCrs");
else
if(extensionName.equals("Scaling")){parsedExtensions.put("Scaling",extensionItem);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AddedextensionScaling");
else
if(extensionName.equals("Interpolation")){parsedExtensions.put("Interpolation",extensionItem);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AddedextensionInterpolation");
else
if(extensionName.equals("rangeSubset")||extensionName.equals("RangeSubset")){parsedExtensions.put("rangeSubset",extensionItem);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AddedextensionrangeSubset");
else
if(extensionName.equals(WCS20Const.OVERVIEW_POLICY_EXTENSION)){parsedExtensions.put(WCS20Const.OVERVIEW_POLICY_EXTENSION,extensionItem);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AddedextensionoverviewPolicy");
else
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Noextensionsfoundinprovidedrequest");
ifnospecified
if(extensions==null||extensions.size()==0||!extensions.containsKey("Interpolation")){//NOINTERPOLATIONreturnreturnValue;
if(interpolationType.getInterpolationMethod()!=null){InterpolationMethodTypemethod=interpolationType.getInterpolationMethod();InterpolationPolicypolicy=InterpolationPolicy.getPolicy(method);for(StringaxisName:axesNames){returnValue.put(axisName,policy);
else
if(interpolationType.getInterpolationAxes()!=null){//makesurewedon'tsetthingstwicefinalList<String>foundAxes=newArrayList<String>();finalInterpolationAxesTypeaxes=interpolationType.getInterpolationAxes();for(InterpolationAxisTypeaxisInterpolation:axes.getInterpolationAxis()){//parseinterpolationfinalStringmethod=axisInterpolation.getInterpolationMethod();finalInterpolationPolicypolicy=InterpolationPolicy.getPolicy(method);//parseaxisfinalStringaxis=axisInterpolation.getAxis();//getlabelfromaxis//TODOsynonymsreductionintindex=axis.lastIndexOf("/");finalStringaxisLabel=(index>=0?axis.substring(index+1,axis.length()):axis);//didwealreadysetthisinterpolation?
if(foundAxes.contains(axisLabel)){thrownewWCS20Exception("Duplicatedaxis",WCS20Exception.WCS20ExceptionCode.InvalidAxisLabel,axisLabel);
if(!returnValue.containsKey(axisLabel)){thrownewWCS20Exception("InvalidaxesURI",WCS20Exception.WCS20ExceptionCode.NoSuchAxis,axisLabel);
if(returnValue.containsKey("Long")){lon=returnValue.get("Long");
if(returnValue.containsKey("Lat")){lat=returnValue.get("Lat");
if(lat!=lon){thrownewWCS20Exception("Wedon'tsupportdifferentinterpolationsonLat,Lon",WCS20Exception.WCS20ExceptionCode.InterpolationMethodNotSupported,"");
ifwereallyneedtodoanything
if(CRS.equalsIgnoreMetadata(coverage.getCoordinateReferenceSystem2D(),targetCRS)){returncoverage;
if(extensions==null||extensions.size()==0||!extensions.containsKey("rangeSubset")){//NOsubsettingreturncoverage;
if(rangeComponent==null){finalRangeIntervalTyperangeInterval=rangeItem.getRangeInterval();finalStringstartRangeComponent=rangeInterval.getStartComponent();finalStringendRangeComponent=rangeInterval.getEndComponent();
if(!bandsNames.contains(startRangeComponent)){thrownewWCS20Exception("InvalidBandName",WCS20Exception.WCS20ExceptionCode.NoSuchField,rangeComponent);
if(!bandsNames.contains(endRangeComponent)){thrownewWCS20Exception("InvalidBandName",WCS20Exception.WCS20ExceptionCode.NoSuchField,rangeComponent);
if(sdinstanceofGridSampleDimension){finalGridSampleDimensionband=(GridSampleDimension)sd;finalStringname=band.getDescription().toString();
if(name.equals(startRangeComponent)){returnValue.add(startRangeComponent);add=true;
else
if(name.equals(endRangeComponent)){returnValue.add(endRangeComponent);add=false;
else
if(add){returnValue.add(name);
if(add){thrownewIllegalStateException("Unabletocloserangeinbandidentifiers");
else{
if(bandsNames.contains(rangeComponent)){returnValue.add(rangeComponent);
else{thrownewWCS20Exception("InvalidBandName",WCS20Exception.WCS20ExceptionCode.NoSuchField,rangeComponent);
if(returnValue.isEmpty()){returncoverage;
if(coverage.getNumSampleDimensions()<indexes.length){//okweareenlargingthenumberofbands,let'scheckthefinalsizeWCSUtils.checkOutputLimits(wcs,coverage,indexes);
if(subset!=null){
if(subset.isCrossingDateline()){Envelope2DcoverageEnvelope=coverage.getEnvelope2D();GeneralEnvelope[]normalizedEnvelopes=subset.getNormalizedEnvelopes();for(inti=0;i<normalizedEnvelopes.length;i++){GeneralEnvelopege=normalizedEnvelopes[i];
if(ge.intersects(coverageEnvelope,false)){GridCoverage2Dcropped=cropOnEnvelope(coverage,ge);result.add(cropped);
else{GridCoverage2Dcropped=cropOnEnvelope(coverage,subset);result.add(cropped);
if(!CRS.equalsIgnoreMetadata(subsettingCRS,sourceCRS)){cropEnvelope=CRS.transform(cropEnvelope,sourceCRS);
iftheyareset**@paramcoveragetheinput{@linkGridCoverage2D}*@paramspatialInterpolationtherequested{@linkInterpolation}*@paramextensionsthelistofWCSextensionstodrawinfofrom*@paramhintsaninstanceof{@linkHints}toapply*@returnascaledversionoftheinput{@linkGridCoverage2D}accordingtowhatisspecified*inthelistofextensions.Itmightbethesourcecoverageitself
ifnooperationswhere*tobeapplied.*/privateGridCoverage2DhandleScaling(GridCoverage2Dcoverage,ScalingTypescaling,InterpolationspatialInterpolation,doublepreAppliedScale[],Hintshints){//checksUtilities.ensureNonNull("interpolation",spatialInterpolation);//lookforscalingextension
if(scaling==null){//NOSCALINGdoweneedinterpolation?
if(spatialInterpolationinstanceofInterpolationNearest){returncoverage;
else{//interpolatecoverage
ifrequestedandnotnearest!!!!finalOperationoperation=CoverageProcessor.getInstance().getOperation("Warp");finalParameterValueGroupparameters=operation.getParameters();parameters.parameter("Source").setValue(coverage);parameters.parameter("warp").setValue(newWarpAffine(AffineTransform.getScaleInstance(1,1)));//identityparameters.parameter("interpolation").setValue(spatialInterpolation!=null?spatialInterpolation:InterpolationPolicy.getDefaultPolicy().getInterpolation());parameters.parameter("backgroundValues").setValue(CoverageUtilities.getBackgroundValues(coverage));//TODOcheckandimprovereturn(GridCoverage2D)CoverageProcessor.getInstance().doOperation(parameters,hints);
ifsomepreScalingasbeenapplied//Thismayoccurwhendealingwithoverviews
if(!Double.isNaN(preAppliedScale[0])&&!Double.isNaN(preAppliedScale[1])){finalDouble[]scale=newDouble[]{preAppliedScale[0],preAppliedScale[1]};hints.add(newHints(GetCoverage.PRE_APPLIED_SCALE,scale));
ifnotdisabled**@paramGridCoverage2D*/publicvoidaddSize(GridCoverage2Dcoverage){incrementalSize+=getCoverageSize(coverage.getGridGeometry().getGridRange2D(),coverage.getRenderedImage().getSampleModel());isSizeExceeded();
if(limit>0&&incrementalSize>limit){thrownewWcsException("Thisrequestistryingto"+(input?"read":"generate")+"toomuchdata,thelimitis"+formatBytes(limit)+"buttheactualamountofbytestobe"+(input?"read":"written")+"is"+formatBytes(incrementalSize));
if(bytes<1024){returnbytes+"B";
else
if(bytes<1024*1024){returnnewDecimalFormat("#.##").format(bytes/1024.0)+"KB";
else{returnnewDecimalFormat("#.##").format(bytes/1024.0/1024.0)+"MB";
if(inputStream.available()==0){return;
if(valueA==null){assertThat(valueB,nullValue());
else{assertThat(valueB,notNullValue());assertThat(valueA,is(valueB));
if(schema==null||schema.toString().trim().isEmpty()){bean.setSchema(null);
else{bean.setSchema(schema.toString().trim());
if(getByteCount()>maxSize){thrownewWPSException("Exceededmaximuminputsizeof"+maxSize+"byteswhilereadinginput"+inputId,"NoApplicableCode",inputId);
ifvalid,*otherwisefallbackto(geoserver-root)/logs/geoserver.logasdefault.*/Stringlocation=GeoServerExtensions.getProperty(LoggingUtils.GEOSERVER_LOG_LOCATION);
if(location==null){location=getGeoServerApplication().getGeoServer().getLogging().getLocation();
if(location==null){GeoServerResourceLoaderloader=getGeoServerApplication().getResourceLoader();logFile=loader.get("logs").get("geoserver.log").file();location=logFile.getAbsolutePath();
else{logFile=newFile(location);
if(!logFile.isAbsolute()){//locatethegeoserver.logfileGeoServerDataDirectorydd=getGeoServerApplication().getBeanOfType(GeoServerDataDirectory.class);logFile=dd.get(Paths.convert(logFile.getPath())).file();
if(!logFile.exists()){error("CouldnotfindtheGeoServerlogfile:"+logFile.getAbsolutePath());
if(params.getNamedKeys().contains(LINES)){
if(params.get(LINES).toInt()>0){lines=params.get(LINES).toInt();
if(!logFile.exists()){return"";
if(lineList.size()>LogPage.this.lines){lineList.removeFirst();
if(br!=null){try{br.close();
ifit'saDOT-positive
ifit'saDASH-negative
ifit'saEMPTY*/publicdoublegetLength(){
switch(type){caseDASH:returnlength;caseEMPTY:return-length;default:return0.0;
if(IS_GEOFENCE_AVAILABLE==null){IS_GEOFENCE_AVAILABLE=isGeoFenceAvailable();
if(IS_GEOFENCE_AVAILABLE){super.runTest();
else{System.out.println("Skippingtestin"+getClass().getSimpleName()+"asGeoFenceserviceisdown:"+"inordertorunthistestyouneedtheservicestoberunningonport9191");//TODO:useAssumewhenusingjunit>=3
if(ds==null)returnnull;
else
if(policy.level==AccessLevel.METADATA)throwSecureCatalogImpl.unauthorizedAccess(this.getName());
elsereturn(DataAccess<?extendsFeatureType,?extendsFeature>)SecuredObjects.secure(ds,policy);}}
if(g==null||g.isEmpty()){returnEMPTY;
if(defaultGeometry==null){return;
if(objectinstanceofGeometry){continue;
else{Namename=p.getName();
if(name.getLocalPart().equalsIgnoreCase("name")||name.getLocalPart().equalsIgnoreCase("geographicalName")){nameStr=p.getValue().toString();
else
if(name.getLocalPart().equalsIgnoreCase("description")){descriptionStr=p.getValue().toString();
else
if(name.getLocalPart().equalsIgnoreCase("comment")){commentStr=p.getValue().toString();
if(goinstanceofMultiLineString){intnrls=((MultiLineString)go).getNumGeometries();for(intli=0;li<nrls;li++){Geometryls=((MultiLineString)go).getGeometryN(li);RteTyperte=toRte((LineString)ls);
if(nameStr!=null)rte.setName(nameStr);
if(commentStr!=null)rte.setCmt(commentStr);
if(descriptionStr!=null)rte.setDesc(descriptionStr);gpxType.getRte().add(rte);
else
if(goinstanceofLineString){RteTyperte=toRte((LineString)go);
if(nameStr!=null)rte.setName(nameStr);
if(commentStr!=null)rte.setCmt(commentStr);
if(descriptionStr!=null)rte.setDesc(descriptionStr);gpxType.getRte().add(rte);
else
if(goinstanceofMultiPoint){intnrpt=((MultiPoint)go).getNumGeometries();for(intpi=0;pi<nrpt;pi++){Geometrypt=((MultiPoint)go).getGeometryN(pi);WptTypewpt=toWpt((Point)pt);
if(nameStr!=null)wpt.setName(nameStr);
if(commentStr!=null)wpt.setCmt(commentStr);
if(descriptionStr!=null)wpt.setDesc(descriptionStr);gpxType.getWpt().add(wpt);
else
if(goinstanceofPoint){WptTypewpt=toWpt((Point)go);
if(nameStr!=null)wpt.setName(nameStr);
if(commentStr!=null)wpt.setCmt(commentStr);
if(descriptionStr!=null)wpt.setDesc(descriptionStr);gpxType.getWpt().add(wpt);
else{//nousefulgeometry,nofeature!return;
if(!(objinstanceofMyServiceInfo)){returnfalse;
if(foo==null){
if(other.foo!=null){returnfalse;
else{
if(!foo.equals(other.foo)){returnfalse;
if(ext!=null&&ext.length()>0)link=link+"."+ext;//encodeasrelativeorabsolutedependingonthelinktype
if(link.startsWith("/")){//absolute,encodefrom"root"returnpg.servletURI(link);
else{//encodeasrelativereturnpg.pageURI(link);
if(_store1==null){_store1=newConfigStore(dataDir);
if(_store2==null){_store2=newConfigStore(dataDir);
if(_repoManager1==null){_repoManager1=spy(newRepositoryManager());_repoManager1.init(store1(),dataDir);_repoManager1.setCatalog(mock(Catalog.class,RETURNS_DEEP_STUBS));
if(_repoManager2==null){_repoManager2=spy(newRepositoryManager());_repoManager2.init(store2(),dataDir);_repoManager2.setCatalog(mock(Catalog.class,RETURNS_DEEP_STUBS));
if(formats[i].getName().equals(type)){format=formats[i];break;
if(format==null){thrownewIOException("Cannothandleformat:"+type);
else{returnformat;
if(key.equalsIgnoreCase(descr.getName().toString())){returnval;
if(format.getName().equals(type)){returnformat;
if(format.getDescription().equals(description)){returnformat;
if(!list.contains(formats[i].getDescription())){list.add(formats[i].getDescription());
if(!list.contains(formats[i])){list.add(formats[i]);
if(params!=null){Listlist=params.values();Iteratorit=list.iterator();ParameterDescriptordescr=null;ParameterValueval=null;Stringkey;Objectvalue;while(it.hasNext()){val=(ParameterValue)it.next();descr=(ParameterDescriptor)val.getDescriptor();key=descr.getName().toString();value=null;
if(val.getValue()!=null){//Requiredparamsmayhavenicesamplevalues//
if("values_palette".equalsIgnoreCase(key)){value=val.getValue();
else{value=val.getValue().toString();
if(value==null){//ornotvalue="";
if(value!=null){defaults.put(key,value);
if(value!=null){map.put(key,value);
if(CRS.equalsIgnoreMetadata(sourceCRS,DefaultGeographicCRS.WGS84)){returnnewGeneralEnvelope(envelope);
if(!CRS.equalsIgnoreMetadata(sourceCRS,targetCRS)){targetEnvelope=CRS.transform(envelope,targetCRS);
else{targetEnvelope=newGeneralEnvelope(envelope);
if(home!=null){hf=newFile(home);
if(hf!=null&&hf.exists()){USER_HOME=hf;
ifthefileisarelativereferenceintothedatadir
if(selection!=null){FilerelativeToDataDir=loader.url(selection.getPath());
if(relativeToDataDir!=null){selection=relativeToDataDir;
if(selection!=null&&selection.exists()){for(Fileroot:roots){
if(isSubfile(root,selection.getAbsoluteFile())){selectionRoot=root;break;
ifthefileisnotpartoftheknownsearchpaths,giveup//and
switchbacktothedatadirectory
if(selectionRoot==null){selectionRoot=dataDirectory;file=newModel<File>(selectionRoot);
else{
if(!selection.isDirectory()){file=newModel<File>(selection.getParentFile());
else{file=newModel<File>(selection);
else{selectionRoot=dataDirectory;file=newModel<File>(selectionRoot);
if(file.isDirectory()){directoryClicked(file,target);
else
if(file.isFile()){fileClicked(file,target);
if(selection==null||"".equals(selection.getPath()))returnfalse;
if(selection.equals(root))returntrue;returnisSubfile(root,selection.getParentFile());
ifyoudon'twantfixedheightwithoverflow,*andtoavalidCSSmeasure
ifyouwantitinstead.Defaultvalueis"25em"**@paramheight*/publicvoidsetFileTableHeight(Stringheight){fileTable.setTableHeight(height);
else{//path=curr.getName()+"/"+path;//
if(f==USER_HOME){returnnewParamResourceModel("userHome",component).getString();
else{GeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);
if(f.equals(loader.getBaseDirectory())){returnnewParamResourceModel("dataDirectory",component).getString();
if(displayName!=null&&!displayName.trim().isEmpty()){returndisplayName.trim();
if((rawList==null||rawList.trim().equals(""))){returnCollections.EMPTY_LIST;
else
if(rawList.equals("*")){//handlesexplicitunconstrainedcasereturnCollections.EMPTY_LIST;
if(len>0){Stringfirst=(String)list.get(0);
if(first.startsWith("(")){list.set(0,first.substring(1));
if(last.endsWith(")")){list.set(len-1,last.substring(0,last.length()-1));
ifthelistisunspecified(ie.isnull)orisunconstrained(ie.is''),then*themethodreturnsanemptylist.**@paramrawListThetokenizedstring.*@paramtokenizerThedelimeterforthestringtokens.*@returnAlistofthetokenizedstring.*@seeTokenizer*/publicstaticListreadFlat(finalStringrawList,finalTokenizertokenizer){returntokenizer.readFlat(rawList);
ifthelistisunspecified(ie.isnull)orisunconstrained(ie.is''),*thenthemethodreturnsanemptylist.**<p>Ifpossible,usethemethodversionthatreceivesawellknown{@link#readFlat(String,*org.geoserver.ows.util.KvpUtils.Tokenizer)Tokenizer},astheremightbespecialcasesto*catchout,likeforthe{@link#OUTER_DELIMETERouterdelimiter"()"}.Ifthismethod*delimiterargumentdoesnotmatchawellknownTokenizer,it'lluseasimplestring*tokenizationbasedonsplittingoutthestringswiththerawpassedindelimiter.**@paramrawListThetokenizedstring.*@paramdelimiterThedelimeterforthestringtokens.*@returnAlistofthetokenizedstring.*@see#readFlat(String,org.geoserver.ows.util.KvpUtils.Tokenizer)*/publicstaticListreadFlat(StringrawList,Stringdelimiter){Tokenizerdelim;
if(KEYWORD_DELIMITER.getRegExp().equals(delimiter)){delim=KEYWORD_DELIMITER;
else
if(VALUE_DELIMITER.getRegExp().equals(delimiter)){delim=VALUE_DELIMITER;
else
if(OUTER_DELIMETER.getRegExp().equals(delimiter)){delim=OUTER_DELIMETER;
else
if(INNER_DELIMETER.getRegExp().equals(delimiter)){delim=INNER_DELIMETER;
else
if(CQL_DELIMITER.getRegExp().equals(delimiter)){delim=CQL_DELIMITER;
else{LOGGER.fine("Usingnotawellknownkvptokenizationdelimiter:"+delimiter);delim=newTokenizer(delimiter);
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("readingnested:"+rawList);
if(rawList==null){
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("foundimplicitallrequested");
else
if(rawList.equals("*")){
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("foundexplicitallrequested");
else{
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("foundexplicitrequested");
if(rawList.startsWith("(")){
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("readingcomplexlist");
else{
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("readingsimplelist");
if(raw!=null){try{clean=java.net.URLDecoder.decode(raw,"UTF-8");
else{return"";
if(kvp==null){returnnull;
if(entry.getValue()instanceofString){value=trim((String)entry.getValue());
else
if(entry.getValue()instanceofString[]){String[]values=(String[])entry.getValue();//weuseasetsothatmerevaluerepetition(acommonerrorforwhichtheOWSspec//leavestheserveruptodecidewhattodo)doesnotcausetheresulttobea//String[]LinkedHashSet<String>normalized=newLinkedHashSet<String>();for(Stringv:values){v=trim(v);
if(v!=null){normalized.add(v);
if(normalized.size()==0){value=null;
else
if(normalized.size()==1){value=normalized.iterator().next();
else{value=(String[])normalized.toArray(newString[normalized.size()]);
if(value!=null){value=value.trim();
if(parser!=null){try{
if(entry.getValue()instanceofString){Stringvalue=(String)entry.getValue();parsed=parser.parse(value);
else{String[]values=(String[])entry.getValue();List<Object>result=newArrayList<Object>();for(Stringv:values){result.add(parser.parse(v));
iftheparserwasfoundandnoexceptionis//thrown(parsed!=null)Ifso(==null)itis//untouched(remainsaString)
if(parsed!=null){entry.setValue(parsed);
if(parser.getService()!=null&&!parser.getService().equalsIgnoreCase(service)){p.remove();
else
if(parser.getVersion()!=null&&!parser.getVersion().toString().equals(version)){p.remove();
else
if(parser.getRequest()!=null&&!parser.getRequest().equalsIgnoreCase(request)){p.remove();
ifmorethanonecandidateparserisfound*/publicstaticKvpParserfindParser(finalStringkey,finalStringservice,finalStringrequest,finalStringversion,Collection<KvpParser>parsers){//findtheparserforthiskeyvaluepairKvpParserparser=null;finalIterator<KvpParser>pitr=parsers.iterator();while(pitr.hasNext()){KvpParsercandidate=pitr.next();
if(key.equalsIgnoreCase(candidate.getKey())){
if(parser==null){parser=candidate;
else{//
iftargetservicematches,itisaclosermatchStringtrgService=candidate.getService();
if(trgService!=null&&trgService.equalsIgnoreCase(service)){//determine
ifthisparsermorecloselymatchestherequestStringcurService=parser.getService();
if(curService==null){parser=candidate;
else{//bothmatch,filterbyversionVersioncurVersion=parser.getVersion();VersiontrgVersion=candidate.getVersion();
if(trgVersion!=null){
if(curVersion==null&&trgVersion.toString().equals(version)){parser=candidate;
else{
if(curVersion==null){//ambiguous,unabletomatchthrownewIllegalStateException("Multiplekvpparsers:"+parser+","+candidate);
iftheselectedparserthrowsanexception*@throwsIllegalStateException
ifmorethanonecandidateparserisfound*/publicstaticObjectparseKey(finalStringkey,finalStringvalue,finalStringservice,finalStringrequest,finalStringversion,List<KvpParser>parsers)throwsException{//findtheparserforthiskeyvaluepairKvpParserparser=findParser(key,service,request,version,parsers);
if(parser==null){returnnull;
if*multipledifferentvaluesarefound**@paramkvpmapofkeyvaluepairs*@paramkeykeyusedtolookupasinglevalue*/publicstaticStringgetSingleValue(Mapkvp,Stringkey){Objectvalue=kvp.get(key);
if(value==null){returnnull;
else
if(valueinstanceofString){return(String)value;
else{String[]strings=(String[])value;
if(strings.length==0){returnnull;
if(!result.equals(strings[i])){thrownewServiceException("Singlevalueexpectedforrequestparameter"+key+"butinsteadfound:"+Arrays.toString(strings),ServiceException.INVALID_PARAMETER_VALUE,key);
if(index==-1){returnCollections.EMPTY_MAP;
if(idx>0){keyValuePair=newString[2];keyValuePair[0]=token.substring(0,idx);keyValuePair[1]=token.substring(idx+1);
else{keyValuePair=newString[1];keyValuePair[0]=token;
if(keyValuePair.length>1){//replaceanyequalsor&characterstry{//
ifthisonedoesnotworkfirstcheck
iftheurlencodedcontentisreally//properlyencoded.Ihadgoodsuccesswiththis://http://meyerweb.com/eric/tools/dencoder/keyValuePair[1]=URLDecoder.decode(keyValuePair[1],"ISO-8859-1");
if(result.get(key)==null){result.put(key,value);
else{String[]array;ObjectoldValue=result.get(key);
if(oldValueinstanceofString){array=newString[2];array[0]=(String)oldValue;array[1]=value;
else{String[]oldArray=(String[])oldValue;array=newString[oldArray.length+1];System.arraycopy(oldArray,0,array,0,oldArray.length);array[oldArray.length]=value;
if(s==null){thrownewIllegalArgumentException("TheStringtoparsemaynotbenull.");
if(separator=='\\'){thrownewIllegalArgumentException("Theseparatormaynotbeabackslash.");
if(maxTokens<=0){maxTokens=Integer.MAX_VALUE;
if(c==separator&&!escaped&&tokenCount<maxTokens){ret.add(sb.toString());sb.setLength(0);tokenCount++;
else{
if(escaped){escaped=false;sb.append('\\');sb.append(c);
else
if(c=='\\'){escaped=true;
else{sb.append(c);
if(escaped){thrownewIllegalStateException("ThespecifiedStringendswithanincompleteescapesequence.");
if(s==null){thrownewIllegalArgumentException("TheStringtounescapemaynotbenull.");
if(escaped){escaped=false;sb.append(c);
else
if(c=='\\'){escaped=true;
else{sb.append(c);
if(escaped){thrownewIllegalArgumentException("ThespecifiedStringendswithanincompleteescapesequence.");
if(entry.getKey()instanceofString){
if(paramname.equalsIgnoreCase((String)entry.getKey())){Objectobj=entry.getValue();value=objinstanceofString?(String)obj:(objinstanceofString[])?((String[])obj)[0].toLowerCase():value;
if(entry.getValue()==null)options.remove(entry.getKey());
elseoptions.put(entry.getKey(),entry.getValue());
if(o==null){returnnull;
else
if(oinstanceofString){return(String)o;
else{String[]values=(String[])o;
if(values.length>=0){returnvalues[0];
else{returnnull;
if(fail)Assert.fail("NoException");
if(fail)Assert.fail("NoException");fail=true;try{helper.getAncestors("node1");
if(fail)Assert.fail("NoException");fail=true;try{helper.getChildren("node1");
if(fail)Assert.fail("NoException");fail=true;try{helper.getDescendants("node1");
if(fail)Assert.fail("NoException");
if(fail)Assert.fail("NoException");helper.getChildren("node1");//okfail=true;try{helper.getDescendants("node1");
if(fail)Assert.fail("NoException");}}
if(of.getGeoserverFormat()!=null&&!of.getGeoserverFormat().isEmpty()){computedMimeType=computedMimeType+";subtype="+of.getGeoserverFormat();
if(of.getType()==null){//binaryisthedefaulttypeppio=newGdalBinaryPPIO(of.getGeoserverFormat(),delegate,computedMimeType);
else{
switch(of.getType()){caseBINARY:ppio=newGdalBinaryPPIO(of.getGeoserverFormat(),delegate,computedMimeType);break;caseTEXT:ppio=newGdalCDataPPIO(of.getGeoserverFormat(),delegate,computedMimeType);break;caseXML:ppio=newGdalXMLPPIO(of.getGeoserverFormat(),delegate);break;default:break;
if(ppio!=null){gdalParams.add(ppio);
if(props.length>1){for(inti=0;i<props.length-1&&object!=null;i++){object=get(object,props[i]);
if(object==null){thrownewNullPointerException("Property'"+property+"'isnullforobject"+object);
else{s=setter(object.getClass(),property,value!=null?value.getClass():null);
if(s==null){thrownewIllegalArgumentException("Nosuchproperty'"+property+"'forobject"+object);
if(properties==null){properties=newClassProperties(clazz);classPropertiesCache.put(clazz,properties);
ifnotfound.*/publicstaticMethodsetter(Classclazz,Stringproperty,Classtype){returnclassProperties(clazz).setter(property,type);
ifanobjecthasaspecifiedproperty.**@paramobjectThetargetobject.*@parampropertyThepropertytolookup.*@returnTrue
ifthepropertyexists,otherwisefalse.*/publicstaticbooleanhas(Objectobject,Stringproperty){returngetter(object.getClass(),property,null)!=null;
if(g==null){thrownewIllegalArgumentException("Nosuchproperty'"+prop+"'forobject"+result);
if(!(oinstanceofMap)){thrownewIllegalArgumentException("Property"+property+"isnotamap");
if(o==null){thrownewNullPointerException("Property"+property+"isnull");
ifnotfound.*/publicstaticMethodgetter(Classclazz,Stringproperty,Classtype){returnclassProperties(clazz).getter(property,type);
ifitcouldnotbefound..*/publicstatic<T>Tproperty(Objectobject,Stringproperty,Class<T>type){Methodgetter=getter(object.getClass(),property,type);
if(getter!=null){try{returntype.cast(getter.invoke(object,(Object[])null));
ifitcouldnotbefound.*/publicstaticMethodmethod(Classclazz,Stringname){returnclassProperties(clazz).method(name);
if((parameter!=null)&&type.isAssignableFrom(parameter.getClass())){return(T)parameter;
if(message!=null&&!"".equals(message)){
if(xmlEscape)s.append(ResponseUtils.encodeXML(message));
elses.append(message);
if(exinstanceofServiceException){for(Iteratort=((ServiceException)ex).getExceptionText().iterator();t.hasNext();){s.append("\n");Stringmsg=(String)t.next();
if(!lastMessage.equals(msg)){
if(xmlEscape)s.append(ResponseUtils.encodeXML(msg));
elses.append(msg);lastMessage=msg;
if(cause!=null&&cause.getMessage()!=null&&!"".equals(cause.getMessage()))s.append("\n");
ifsomeonedidtheverystupidthingofsetting//thecauseastheexceptionitself(Ionlyfoundthissituationonce,but...)
if(ex==cause||cause==null)break;
elseex=cause;
if(getter==null){continue;//shouldnotreallyhappen
if(setter==null&&!(Collection.class.isAssignableFrom(type)||Map.class.isAssignableFrom(type))){//readonlycontinue;
if(newValue==null){continue;//TODO:makethisaflagwhethertooverwritewithnullvalues
if(setter==null){
if(Collection.class.isAssignableFrom(type)){updateCollectionProperty(target,(Collection)newValue,getter);
else
if(Map.class.isAssignableFrom(type)){updateMapProperty(target,(Map)newValue,getter);
if(g==null){continue;
ifthisisacollectionoramap
if(!(Map.class.isAssignableFrom(type)||Collection.class.isAssignableFrom(type))){continue;
ifthereisalsoasetteraswellMethods=properties.setter(property,null);
if(s==null){continue;
ifthegetterreturnsnull,callthesettertry{Objectvalue=g.invoke(object,null);
if(value==null){//firstattempttoinstantiatethetypedirectlyincasethemethoddeclares//anoninterfaceorabstractclass
if(!type.isInterface()){try{value=type.getConstructor().newInstance();
if(value==null){
if(Map.class.isAssignableFrom(type)){value=newHashMap();
else
if(List.class.isAssignableFrom(type)){value=newArrayList();
else
if(Set.class.isAssignableFrom(type)){value=newHashSet();
else{thrownewRuntimeException("Unknowncollectiontype:"+type.getName());
ifsetterisnull.*/staticvoidupdateCollectionProperty(Objectobject,CollectionnewValue,Methodgetter)throwsException{CollectionoldValue=(Collection)getter.invoke(object,null);
if(oldValue!=null){oldValue.clear();oldValue.addAll(newValue);
ifsetterisnull.*/staticvoidupdateMapProperty(Objectobject,MapnewValue,Methodgetter)throwsException{MapoldValue=(Map)getter.invoke(object,null);
if(oldValue!=null){oldValue.clear();oldValue.putAll(newValue);
if(rs.wasNull())returnnull;returni;
if(rs.wasNull())returnnull;returnb;
if(i++>0)builder.append(",");builder.append(field.fieldExpression);
if(i++>0)builder.append(",");assign.appendAssignment(builder);
if(i++>0)builder.append(",");builder.append(assign.getField().getFieldName());
if(i++>0)builder.append(",");builder.append("?");assign.addAsParameter(builder);
if(rs.next()){assert(rs.isLast());Map<String,Object>result=newHashMap<String,Object>();for(inti=0;i<fields.length;i++){result.put(fields[i].getFieldName(),fields[i].getValue(rs));
else{returnnull;
if(stmt.executeUpdate()<=0){returnnull;
if(rs.next()){assert(rs.isLast());InputStreamis=field.getValue(rs);returnis==null?null:newClosingInputStreamWrapper(is,c);
else{closeConnection=true;returnnull;
if(closeConnection){try{c.close();
if(execute==null){execute=resources.getStoredRequestObject(status.getExecutionId());
if(execute==null){thrownewWPSException("Couldnotlocatetheoriginalrequestforexecutionid:"+status.getExecutionId());
else{ExecuteResponseBuilderbuilder=newExecuteResponseBuilder(execute,ctx,status);returnbuilder.build();
if(configinstanceofJDBCUserGroupServiceConfig){JDBCUserGroupServiceConfigjdbcConfig=(JDBCUserGroupServiceConfig)config;StringfileNameDML=jdbcConfig.getPropertyFileNameDML();Resourcefile=checkORCreateJDBCPropertyFile(fileNameDML,getConfigRoot(),DEFAULT_DML_FILE);dmlProps=Util.loadUniversal(file.in());StringfileNameDDL=jdbcConfig.getPropertyFileNameDDL();
if(fileNameDDL!=null&&fileNameDDL.length()>0){file=checkORCreateJDBCPropertyFile(fileNameDDL,getConfigRoot(),DEFAULT_DDL_FILE);ddlProps=Util.loadUniversal(file.in());createTablesIfRequired((JDBCSecurityServiceConfig)config);
if(enc.getEncodingType()==PasswordEncodingType.ENCRYPT){KeyStoreProviderprov=getSecurityManager().getKeyStoreProvider();Stringalias=prov.aliasForGroupService(name);
if(prov.containsAlias(alias)==false){prov.setUserGroupKey(name,getSecurityManager().getRandomPassworddProvider().getRandomPasswordWithDefaultLength());prov.storeKeyStore();
if(rs.next()){Stringpassword=rs.getString(1);StringenabledString=rs.getString(2);booleanisEnabled=convertFromString(enabledString);u=createUserObject(username,password,isEnabled);ps2=getDMLStatement("userprops.selectForUser",con);ps2.setString(1,username);rs2=ps2.executeQuery();while(rs2.next()){StringpropName=rs2.getString(1);ObjectpropValue=rs2.getObject(2);u.getProperties().put(propName,propValue==null?"":propValue);
if(rs.next()){StringenabledString=rs.getString(1);booleanisEnabled=convertFromString(enabledString);g=createGroupObject(groupname,isEnabled);
if(u!=null){u.getProperties().put(propName,propValue==null?"":propValue);
if(u!=null){u.getProperties().put(propName,propValue==null?"":propValue);
if(user==null)thrownewUsernameNotFoundException(userNotFoundMessage(username));RoleCalculatorcalculator=newRoleCalculator(this,getSecurityManager().getActiveRoleService());user.setAuthorities(calculator.calculateRoles(user));
if(StringUtils.hasLength(propname)==false)returnemptyUsers;Connectioncon=null;PreparedStatementps=null;ResultSetrs=null;Map<String,GeoServerUser>map=newHashMap<String,GeoServerUser>();try{con=getConnection();ps=getDMLStatement("user.usersHavingProperty",con);ps.setString(1,propname);rs=ps.executeQuery();while(rs.next()){Stringusername=rs.getString(1);Stringpassword=rs.getString(2);StringenabledString=rs.getString(3);booleanisEnabled=convertFromString(enabledString);GeoServerUseru=createUserObject(username,password,isEnabled);map.put(username,u);
if(u!=null){u.getProperties().put(propName,propValue==null?"":propValue);
if(StringUtils.hasLength(propname)==false)return0;Connectioncon=null;PreparedStatementps=null;ResultSetrs=null;intcount;try{con=getConnection();ps=getDMLStatement("userprops.userCountHavingProperty",con);ps.setString(1,propname);rs=ps.executeQuery();rs.next();count=rs.getInt(1);
if(StringUtils.hasLength(propname)==false)returnemptyUsers;Connectioncon=null;PreparedStatementps=null;ResultSetrs=null;Map<String,GeoServerUser>map=newHashMap<String,GeoServerUser>();try{con=getConnection();ps=getDMLStatement("user.usersNotHavingProperty",con);ps.setString(1,propname);rs=ps.executeQuery();while(rs.next()){Stringusername=rs.getString(1);Stringpassword=rs.getString(2);StringenabledString=rs.getString(3);booleanisEnabled=convertFromString(enabledString);GeoServerUseru=createUserObject(username,password,isEnabled);map.put(username,u);
if(u!=null){u.getProperties().put(propName,propValue==null?"":propValue);
if(StringUtils.hasLength(propname)==false)returngetUserCount();Connectioncon=null;PreparedStatementps=null;ResultSetrs=null;intcount;try{con=getConnection();ps=getDMLStatement("userprops.userCountNotHavingProperty",con);ps.setString(1,propname);rs=ps.executeQuery();rs.next();count=rs.getInt(1);
if(StringUtils.hasLength(propname)==false)returnemptyUsers;
if(StringUtils.hasLength(propvalue)==false)returnemptyUsers;Connectioncon=null;PreparedStatementps=null;ResultSetrs=null;Map<String,GeoServerUser>map=newHashMap<String,GeoServerUser>();try{con=getConnection();ps=getDMLStatement("user.usersHavingPropertyValue",con);ps.setString(1,propname);ps.setString(2,propvalue);rs=ps.executeQuery();while(rs.next()){Stringusername=rs.getString(1);Stringpassword=rs.getString(2);StringenabledString=rs.getString(3);booleanisEnabled=convertFromString(enabledString);GeoServerUseru=createUserObject(username,password,isEnabled);map.put(username,u);
if(u!=null){u.getProperties().put(propName,propValue==null?"":propValue);
if(StringUtils.hasLength(propname)==false)return0;
if(StringUtils.hasLength(propvalue)==false)return0;Connectioncon=null;PreparedStatementps=null;ResultSetrs=null;intcount;try{con=getConnection();ps=getDMLStatement("userprops.userCountHavingPropertyValue",con);ps.setString(1,propname);ps.setString(2,propvalue);rs=ps.executeQuery();rs.next();count=rs.getInt(1);
if(property==RemotesProvider.NAME){returnnameLink(id,itemModel);
else
if(property==RemotesProvider.URL){Stringlocation=(String)RemotesProvider.URL.getModel(itemModel).getObject();Labellabel=newLabel(id,location);//label.add(newSimpleAttributeModifier("style","word-wrap:break-word;"));returnlabel;
else
if(property==RemotesProvider.PINGLINK){returnnewRemotePingLink(id,model);
else
if(property==RemotesProvider.REMOVELINK){returnremoveLink(id,itemModel);
if(headinstanceofSymRef){headTarget=((SymRef)head).getTarget();
else{headTarget=head.getObjectId().toString();
if(whitelistedMasks==null){this.whitelistedAddressMatchers=null;
if(this.getWhitelistedMasks()!=null&&this.whitelistedAddressMatchers==null){this.whitelistedAddressMatchers=whitelistedMasks.stream().map(mask->newIpAddressMatcher(mask)).collect(Collectors.toList());
if(clone!=null){
if(allowEnvParametrization&&gsEnvironment!=null&&GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){List<String>resolvedMasks=newArrayList<>();for(Stringmask:whitelistedMasks){Stringresolved=(String)gsEnvironment.resolveValue(mask);
if(resolved!=null){Arrays.stream(resolved.split("\\s*,\\s*")).filter(s->s!=null&&!s.trim().isEmpty()).forEach(s->resolvedMasks.add(s));
iftheuserhasadminrightstoanyworkspace.**@authorJustinDeoliveira,OpenGeo*/publicclassWorkspaceAdminComponentAuthorizerextendsAdminComponentAuthorizer{privatestaticfinalLoggerLOGGER=Logging.getLogger(WorkspaceAdminComponentAuthorizer.class);@OverridepublicbooleanisAccessAllowed(Class<?>componentClass,Authenticationauthentication){//
iffulladmingrantaccess
if(super.isAccessAllowed(componentClass,authentication)){returntrue;
ifnotauthenticateddenyaccess
if(authentication==null||!authentication.isAuthenticated()){returnfalse;
if(isWorkspaceAdmin(authentication)){returntrue;
ifthecurrentuserhasanyadminprivilegeonatleastoneworkspace.*/booleanisWorkspaceAdmin(Authenticationauthentication){Catalogcatalog=getSecurityManager().getCatalog();//thesecurecatalogbuildsandownstheResourceAccessManagerSecureCatalogImplsecureCatalog=GeoServerApplication.get().getBeanOfType(SecureCatalogImpl.class);ResourceAccessManagermanager=secureCatalog.getResourceAccessManager();
if(manager!=null){for(WorkspaceInfoworkspace:catalog.getWorkspaces()){WorkspaceAccessLimitsaccessLimits=manager.getAccessLimits(authentication,workspace);
if(accessLimits!=null&&accessLimits.isAdminable()){returntrue;
if(ldapConfig.getUserDnPattern()!=null){authenticator.setUserDnPatterns(newString[]{ldapConfig.getUserDnPattern()});
if(ugServiceName!=null){//uselocalusergroupserviceforloadingauthoritiesGeoServerUserGroupServiceugService;try{ugService=securityManager.loadUserGroupService(ugServiceName);authPopulator=newUserDetailsServiceLdapAuthoritiesPopulator(ugService);provider=newLdapAuthenticationProvider(authenticator,authPopulator);
if(authPopulator==null){//fallbacktolookinguprolesviaLDAPserver,choosing//betweendefaultandbindingpopulator
if(ldapConfig.isBindBeforeGroupSearch()){authPopulator=newBindingLdapAuthoritiesPopulator(ldapContext,ldapConfig.getGroupSearchBase());
if(ldapConfig.getGroupSearchFilter()!=null){((BindingLdapAuthoritiesPopulator)authPopulator).setGroupSearchFilter(ldapConfig.getGroupSearchFilter());
else{ldapContext.setAnonymousReadOnly(true);authPopulator=newDefaultLdapAuthoritiesPopulator(ldapContext,ldapConfig.getGroupSearchBase());
if(ldapConfig.getGroupSearchFilter()!=null){((DefaultLdapAuthoritiesPopulator)authPopulator).setGroupSearchFilter(ldapConfig.getGroupSearchFilter());
if(styleId==null)returnnull;
elsereturnGeoServerApplication.get().getCatalog().getStyle(styleId);
if(style==null)styleId=null;
elsestyleId=style.getId();
if(layerType==EoLayerType.BAND_COVERAGE){layerSubName="bands";
else
if(layerType==EoLayerType.BROWSE_IMAGE){layerSubName="browse";
else{layerSubName=layer.getName();
if(layerGroupName!=null){Stringprefix=layerGroupName+"_";
if(layerSubName.startsWith(prefix)){layerSubName=layerSubName.substring(prefix.length());
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;EoLayerGroupEntryother=(EoLayerGroupEntry)obj;
if(layerId==null){
if(other.layerId!=null)returnfalse;
else
if(!layerId.equals(other.layerId))returnfalse;
if(layerSubName==null){
if(other.layerSubName!=null)returnfalse;
else
if(!layerSubName.equals(other.layerSubName))returnfalse;
if(layerType!=other.layerType)returnfalse;
if(styleId==null){
if(other.styleId!=null)returnfalse;
else
if(!styleId.equals(other.styleId))returnfalse;returntrue;}}
ifthelayerhasonlyasinglefeaturetype.</td></tr>*<tr><td>RULE</td><td>Optional</td><td>Ruleofstyletoproducelegendgraphicfor,
ifapplicable.Inthecasethatastylehasmultiplerulesbutnospecificruleisselected,thenthemapserverisobligatedtoproduceagraphicthatisrepresentativeofalloftherulesofthestyle.Alistofrulesseparatedbycommascanbeusedtospecifyrulesforsinglelayersofalayergroup.Tospecifyruleonlyforsomelayersleaveemptythenotoverriddenonesinthelist(ex.rule1,,rule3,rule4tonotspecifyruleforlayer2).</td></tr>*<tr><td>SCALE</td><td>Optional</td><td>InthecasethataRULEisnotspecifiedforastyle,thisparametermayassisttheserverinselectingamoreappropriaterepresentativegraphicbyeliminatinginternalrulesthatareoutof-scope.Thisvalueisastandardizedscaledenominator,definedinSection10.2</td></tr>*<tr><td>SLD</td><td>Optional</td><td>ThisparameterspecifiesareferencetoanexternalSLDdocument.ItworksinthesamewayastheSLD=parameteroftheWMSGetMapoperation.</td></tr>*<tr><td>SLD_BODY</td><td>Optional</td><td>ThisparameterallowsanSLDdocumenttobeincludeddirectlyinanHTTP-GETrequest.ItworksinthesamewayastheSLD_BODY=parameteroftheWMSGetMapoperation.</td></tr>*<tr><td>FORMAT</td><td>Required</td><td>ThisgivestheMIMEtypeofthefileformatinwhichtoreturnthelegendgraphic.AllowedvaluesarethesameasfortheFORMAT=parameteroftheWMSGetMaprequest.</td></tr>*<tr><td>WIDTH</td><td>Optional</td><td>Thisgivesahintforthewidthofthereturnedgraphicinpixels.Vector-graphicscanusethisvalueasahintforthelevelofdetailtoinclude.</td></tr>*<tr><td>HEIGHT</td><td>Optional</td><td>Thisgivesahintfortheheightofthereturnedgraphicinpixels.</td></tr>*<tr><td>LANGUAGE</td><td>Optional</td><td>Permitstohaveinternationalizedtextinlegendoutput.</td></tr>*<tr><td>EXCEPTIONS</td><td>Optional</td><td>ThisgivestheMIMEtypeoftheformatinwhichtoreturnexceptions.AllowedvaluesarethesameasfortheEXCEPTIONS=parameteroftheWMSGetMaprequest.</td></tr>*<tr><td>TRANSPARENT</td><td>Optional</td><td><code>true</code>
ifthelegendimagebackgroundshouldbetransparent.Defaultsto<code>false</code>.</td></tr>*</table>*</pre>**<p>There'salsoacustom{@codeSTRICT}parameterthatdefaultsto{@codetrue}andcontrols*whetherthemandatoryparametersaretobechecked.Thisisusefulmainlytobeableof*requestingalegendgraphicfornolayerinparticular,sotheLAYERparametercanbeomitted.**<p>TheGetLegendGraphicoperationitselfisoptionalforanSLD-enabledWMS.Itprovidesa*generalmechanismforacquiringlegendsymbols,beyondtheLegendURLreferenceofWMS*Capabilities.ServerssupportingtheGetLegendGraphiccallmightcodeLegendURLreferencesas*GetLegendGraphicforinterfaceconsistency.Vendorspecificparametersmaybeaddedto*GetLegendGraphicrequestsandalloftheusualOGC-interfaceoptionsandrulesapply.NoXML-POST*methodforGetLegendGraphicispresentlydefined.**<p>Inadditiontotheofficialparameters{@link#getLegendOptions()}isusedtorefiningthe*appearanceofofthegeneratedlegend.**<p>Finallyasadatastructure{@linkGetLegendGraphic}isusedtocollectadditionalcontext.*Renderingenvironment{@link#getEnv()}and{@link#locale}.LayerInfoconfigurationsettingsare*availableusingmethodslike{@link#getTitle(Name)}.**@authorGabrielRoldan*@version$Id$*/publicclassGetLegendGraphicRequestextendsWMSRequest{/**Legendoptiontoenablefeaturecountmatching*/publicstaticfinalStringCOUNT_MATCHED_KEY="countMatched";/***DetailscollectedforanindividualLegendGraphicincludinglayer,title,styleandoptional*legendgraphic.**<p>ThisinformationisparsedfromtheGetLegendGraphicRequestandsupplementedwithlayer*andstyleconfigurationasrequired.Thisinformationisprovidedasadatastructurein*ordertoavoidduplicatinglogicinGetLegendGraphicKvpReaderand*BufferedImageLegendGraphicBuild.**<p>LegendRequestactsassimpledataobjectwithequalityderivedfromlayername(enoughtto*allowittobehavewellinaList).NotethatLegendRequestisspecifictoasingle{@link*GetLegendGraphicRequest}andshouldnotbecached.Itrepresentsthestateofthesystemat*thetimeofparsing.**@authorJodyGarnett(Boundless)*/publicclassLegendRequest{privateStringlayer;privateNamelayerName;privateFeatureTypefeatureType;privateStringstyleName;privateStringtitle;/**Optionalruleusedtorefinepresentationofstyle*/privateStringrule;/**Styledeterimedfromareviewofrequestparameters*/privateStylestyle;/**Optionallegendinfo(fromlayerinfoorstyleinfo)*/privateLegendInfolegendInfo;/**Optionallayerinfo(ifavailable)*/privateLayerInfolayerInfo;/**Optionallayergroupinfo(ifavailable)*/privateLayerGroupInfolayerGroupInfo;/**LegendRequestforastyle,noassociatedfeatureType.*/publicLegendRequest(){this.layer="";this.featureType=null;this.layerName=newNameImpl("");
if(featureType==null){thrownewNullPointerException("FeatureTyperequiredforLegendRequest");
ifempty*/publicStringgetRule(){
if("".equals(rule)){returnnull;
ifnotprovided.**<p>Wechooseatitlewiththefollowingpriority:**<ul>*<li>LayerTitle*<li>LayerName-oftenobtainedfromnativeresourcename*</ul>**@returnlayertitle
ifprovided,orlayernameasadefault*/publicStringgetTitle(){
if(title==null||"".equals(title)){title=getLayerName().getLocalPart();
ifnotprovided.*ThisstylecanbeacquiredbyevaluatingtheSTYLEparameter,whichprovidesoneofthe*layer'snamedstyles,theSLDparameter,whichprovidesaURLforanexternalSLD*document,ortheSLD_BODYparameter,whichprovidestheSLDbodyintherequestbody.*/publicStylegetStyle(){returnstyle;
ifnoWIDTHparameterwaspassed*/publicstaticfinalintDEFAULT_WIDTH=20;/**defaultlegendgraphicheight,inpixels,toapply
ifnoWIDTHparameterwaspassed*/publicstaticfinalintDEFAULT_HEIGHT=20;/***Thedefaultimageformatinwhichtoproducealegendgraphic.Notreallyusedwhen*performinguserrequests,sinceFORMATisamandatoryparameter,butbynowservesasa*defaultforexpressingLegendURLlayerattributeinGetCapabilities.*/publicstaticfinalStringDEFAULT_FORMAT="image/png";/**Thefeaturetype(s)oftherequestedLAYER(s)*/privateList<LegendRequest>legends=newArrayList<LegendRequest>();/***shouldholdFEATURETYPEparametervalue,thoughnotusedbynow,sinceGeoServerWMSstill*doesnotsupportsnestedlayersandlayershasonlyasinglefeaturetype.Thisshouldchange*inthefuture.*/privateStringfeatureType;/***holdsthestandarizedscaledenominatorpassedastheSCALEparametervalue,or<code>-1.0*</code>
ifnotprovided*/privatedoublescale=-1d;/***themimetypeofthefileformatinwhichtoreturnthelegendgraphic,asrequestedbythe*FORMATrequestparametervalue.*/privateStringformat;/***thewidthinpixelsofthereturnedgraphic,or<code>DEFAULT_WIDTH</code>
ifnotprovided*/privateintwidth=DEFAULT_WIDTH;/***theheightinpixelsofthereturnedgraphic,or<code>DEFAULT_HEIGHT</code>
ifnotprovided*/privateintheight=DEFAULT_HEIGHT;/**mimetypeoftheformatinwhichtoreturnexceptionsinformation.*/privateStringexceptionsFormat=GetMapRequest.SE_XML;/***holdsthegeoserver-specificgetLegendGraphicoptionsforcontrollingthingslikethelabel*font,labelfontstyle,labelfontantialiasing,etc.*/privateMap<String,Object>legendOptions;/**Whetherthelegendgraphicbackgroundshallbetransparentornot.*/privatebooleantransparent;privatebooleanstrict=true;/**Optionallocaletobeusedfortextinoutput.*/privateLocalelocale;/**Containstheparsedkvpitems*/privateMap<String,Object>kvp;privateWMSwms;/***CreatesanewGetLegendGraphicRequestobject.**@paramwmsTheWMSconfigurationobject.*/publicGetLegendGraphicRequest(){super("GetLegendGraphic");
if(featureTypeName.equals(legend.getLayerName())){returnlegend;
if(layer==null){this.legends.add(newLegendRequest());
else{this.legends.add(newLegendRequest(layer));
if(!s.hasNext()){break;//nomorestyles
if(!s.hasNext()){break;//nomorestyles
else*meansfalse.*<li><code>forceLabels</code>:"on"meanslabelswillalwaysbedrawn,even
ifonlyonerule*isavailable."off"meanslabelswillneverbedrawn,even
ifmultiplerulesare*available.*<li><code>forceTitles</code>:"off"meanstitleswillneverbedrawn,even
ifmultiple*layersareavailable.*<li><code>minSymbolSize</code>:anumberdefiningtheminimumsizetoberenderedfora*symbol(defaultsto3).*</ul>**@returnMap<String,Object>*/@SuppressWarnings("unchecked")publicMap<String,Object>getLegendOptions(){return(Map<String,Object>)(legendOptions==null?Collections.emptyMap():legendOptions);
ifthebackgroundof*thelegendgraphictoreturnshallbetransparentornot.**<p>Ifthe<code>TRANSPARENT</code>parameterisnotspecified,thispropertydefaultsto*<code>false</code>.**@returnwhetherthelegendgraphicbackgroundshallbetransparentornot*/publicbooleanisTransparent(){returntransparent;
ifavalueispresentbutcannotbe*convertedtothetargettypeanexceptionwillbethrown*/public<T>TgetLegendOption(Stringkey,Class<T>optionClass){
if(legendOptions==null){returnnull;
if(value==null){returnnull;
if(converted==null){thrownewServiceException("Invalidsyntaxforoption"+key+",cannotbeconveredtoa"+optionClass.getSimpleName());
ifthepartmatchestheprovidedname**@paramname*@return*/publicbooleanmatches(Stringname);
if(value!=null&&value<min){thrownewRestException("Invalidparameter"+name+",shouldbeatleast"+min,HttpStatus.BAD_REQUEST);
if(value!=null&&value>max){thrownewRestException("Invalidparameter"+name+",shouldbeatmost"+max,HttpStatus.BAD_REQUEST);
if(offset!=null){validateMin(offset,0,"offset");query.setStartIndex(offset);
if(limit!=null){validateMin(limit,0,"limit");validateMax(limit,maximumRecordsPerPage,"limit");query.setMaxFeatures(limit);
else{query.setMaxFeatures(maximumRecordsPerPage);
if(feature==null){thrownewResourceNotFoundException("Couldnotfindacollectionnamed'"+collectionName+"'");
if(pd.getMaxOccurs()>1||OpenSearchAccess.METADATA_PROPERTY_NAME.equals(propertyName)||OpenSearchAccess.QUICKLOOK_PROPERTY_NAME.equals(propertyName)||"htmlDescription".equalsIgnoreCase(propertyName.getLocalPart())||"id".equals(propertyName.getLocalPart())){continue;
if(OpenSearchAccess.EO_NAMESPACE.equals(uri)){prefix="eo";
else{for(ProductClasspc:ProductClass.values()){
if(pc.getNamespace().equals(uri)){prefix=pc.getPrefix();break;
if(prefix!=null){mappedName=prefix+":"+name.getLocalPart();
else{mappedName=name.getLocalPart();
if(linkProperties!=null){links=linkProperties.stream().map(p->(SimpleFeature)p).sorted(LinkFeatureComparator.INSTANCE).map(sf->{Stringoffering=(String)sf.getAttribute("offering");Stringmethod=(String)sf.getAttribute("method");Stringcode=(String)sf.getAttribute("code");Stringtype=(String)sf.getAttribute("type");Stringhref=(String)sf.getAttribute("href");returnnewOgcLink(offering,method,code,type,href);}).collect(Collectors.toList());
if(links.isEmpty()&&notFoundOnEmpty){thrownewResourceNotFoundException();
if(p!=null){Objectvalue=p.getValue();
if(value!=null){fb.set(ad.getLocalName(),value);
if(("eo:identifier".equals(ad.getLocalName())||"eop:identifier".equals(ad.getLocalName()))&&valueinstanceofString){identifier=(String)value;
ifsuccessful,revert*otherwise,andfinallycloseit**@paramstore*@paramfeatureStoreConsumer*@throwsIOException*/protectedvoidrunTransactionOnStore(FeatureStorestore,IOConsumer<FeatureStore>featureStoreConsumer)throwsIOException{try(Transactiont=newDefaultTransaction()){store.setTransaction(t);try{featureStoreConsumer.accept(store);t.commit();
if(ignoredAttributes.contains(sourceName)){continue;
if(pd==null){thrownewRestException("Unexpectedattributefound:'"+sourceName+"'",HttpStatus.BAD_REQUEST);
switch(split.length){case1:
if("geometry".equals(sourceName)){returnnewNameImpl(defaultNamespace,"footprint");
else{returnnewNameImpl(defaultNamespace,sourceName);
if("eo".equals(prefix)){namespaceURI=OpenSearchAccess.EO_NAMESPACE;
else{for(OpenSearchAccess.ProductClasspc:OpenSearchAccess.ProductClass.values()){
if(prefix.equals(pc.getPrefix())){namespaceURI=pc.getNamespace();
if(namespaceURI==null){thrownewRestException("Unrecognizedattributeprefixinproperty"+sourceName,HttpStatus.BAD_REQUEST);
if(zp.matches(name)){part=zp;break;
if(part!=null){result.put(part,IOUtils.toByteArray(zis));
else{LOGGER.warning("Ignoringun-recognizedentryinzipfile:"+name);
if(pg.getFactoryClass().getName().equals("org.geoserver.wps.DeprecatedProcessFactory")){assertFalse(pg.isEnabled());found1=true;
if(pg.getFilteredProcesses()!=null){for(Objectopi:pg.getFilteredProcesses()){assertTrue(opiinstanceofProcessInfo);
if(pg.getFactoryClass().getName().equals("org.geoserver.wps.jts.SpringBeanProcessFactory")){assertTrue(pg.isEnabled());assertEquals(pg.getFilteredProcesses().get(0).getName().toString(),"gs:GeorectifyCoverage");assertEquals(pg.getFilteredProcesses().get(1).getName().toString(),"gs:GetFullCoverage");assertEquals(pg.getFilteredProcesses().get(2).getName().toString(),"gs:Import");found2=true;
iftheworkspacewascorrectlyretrievedfromthecatalogitshouldhavethename//propertyavailabletry{assertTrue(wpsInfo.getWorkspace().getName().equals("wps-load-test-workspace-name"));
if(resource.name().isEmpty()){returnnull;
else{returnnewResourceNode(resource.parent(),expandedStates);
if(name.isEmpty()){return"/";
else{returnname;
if(isLeaf()){returnnull;
else{returnexpandedStates.getResourceExpandedState(resource);
if(path.isEmpty()){return"/";
else{returnpath;
if(i==0&&resource.parent()!=null){i=resource.parent().name().compareTo(other.resource.parent().name());
if(requestinstanceofTransactionType){returnnewWFS11((EObject)request);
else
if(requestinstanceofnet.opengis.wfs20.TransactionType){returnnewWFS20((EObject)request);
if(elinstanceofDeleteElementType){list.add(newDelete.WFS11(el));
else
if(elinstanceofInsertElementType){list.add(newInsert.WFS11(el));
else
if(elinstanceofUpdateElementType){list.add(newUpdate.WFS11(el));
else
if(elinstanceofNativeType){list.add(newNative.WFS11(el));
else{thrownewIllegalArgumentException("Unrecognizedtransactionelement:"+el);
if(elementinstanceofInsert){tx.getInsert().add(((Insert)element).getAdaptee());
else
if(elementinstanceofUpdate){tx.getUpdate().add(((Update)element).getAdaptee());
else
if(elementinstanceofDelete){tx.getDelete().add(((Delete)element).getAdaptee());
if(requestinstanceofWFS11){return(TransactionType)request.getAdaptee();
if(teinstanceofDelete){tx.getDelete().add(Delete.WFS11.unadapt((Delete)te));
if(teinstanceofUpdate){tx.getUpdate().add(Update.WFS11.unadapt((Update)te));
if(teinstanceofInsert){tx.getInsert().add(Insert.WFS11.unadapt((Insert)te));
if(teinstanceofNative){tx.getNative().add(Native.WFS11.unadapt((Native)te));
if(elinstanceofDeleteType){list.add(newDelete.WFS20(el));
else
if(elinstanceofInsertType){list.add(newInsert.WFS20(el));
else
if(elinstanceofUpdateType){list.add(newUpdate.WFS20(el));
else
if(elinstanceofReplaceType){list.add(newReplace.WFS20(el));
else
if(elinstanceofnet.opengis.wfs20.NativeType){list.add(newNative.WFS20(el));
else{thrownewIllegalArgumentException("Unrecognizedtransactionelement:"+el);
if(s!=null){gs.remove(s);
ifthecreatedworkspaceandnamespaceshouldbeconsideredisolated*/privatevoidcreateWorkspace(Stringprefix,StringnamespaceUri,booleanisolated){Catalogcatalog=getCatalog();//createthenamespaceNamespaceInfoImplnamespace=newNamespaceInfoImpl();namespace.setPrefix(prefix);namespace.setURI(namespaceUri);namespace.setIsolated(isolated);catalog.add(namespace);//createtheworkspaceWorkspaceInfoImplworkspace=newWorkspaceInfoImpl();workspace.setName(prefix);workspace.setIsolated(isolated);catalog.add(workspace);
iftheworkspaceshouldbeisolated,otherwisefalse*/privatevoidupdateWorkspace(StringoriginalName,Stringname,Stringnamespace,booleanisolated){//makesuretheformisinitiatedWorkspaceInfooriginalWorkspace=getCatalog().getWorkspaceByName(originalName);tester.startPage(newWorkspaceEditPage(originalWorkspace));//gettheworkspacecreationformFormTesterform=tester.newFormTester("form");//filltheformwiththeprovidedvaluesform.setValue("name",name);form.setValue("uri",namespace);form.setValue("isolated",isolated);//submittheformform.submit();}}
if(filterGroup(it.next())){it.remove();
if(role==delegate.getAdminRole()){returnnull;
ifyouwanttouseDTDvalidationforthesetests//(bypassingfalseasthesecondparamtogetAsDOM())//BUG:Currently,thisdoesn'tseemtoactuallyvalidatethedocument,although//'validation'fails
iftheDTDismissing//GeoServerInfoglobal=getGeoServer().getGlobal();//global.setProxyBaseUrl("src/test/resources/geoserver");//getGeoServer().save(global);Documentdoc=getAsDOM("wms?service=WMS&request=getCapabilities&version=1.3.0",true);assertXpathEvaluatesTo("0","count(//wms:Attribution)",doc);//AddattributiontooneofthelayersLayerInfopoints=getCatalog().getLayerByName(MockData.POINTS.getLocalPart());AttributionInfoattr=points.getAttribution();attr.setTitle("PointProvider");getCatalog().save(points);doc=getAsDOM("wms?service=WMS&request=getCapabilities&version=1.3.0",true);assertXpathEvaluatesTo("1","count(//wms:Attribution)",doc);assertXpathEvaluatesTo("1","count(//wms:Attribution/wms:Title)",doc);//Addhreftosamelayerattr=points.getAttribution();attr.setHref("http://example.com/points/provider");getCatalog().save(points);doc=getAsDOM("wms?service=WMS&request=getCapabilities&version=1.3.0",true);//print(doc);assertXpathEvaluatesTo("1","count(//wms:Attribution)",doc);assertXpathEvaluatesTo("1","count(//wms:Attribution/wms:Title)",doc);assertXpathEvaluatesTo("1","count(//wms:Attribution/wms:OnlineResource)",doc);//Addlogotosamelayerattr=points.getAttribution();attr.setLogoURL("http://example.com/points/logo");attr.setLogoType("image/logo");attr.setLogoHeight(50);attr.setLogoWidth(50);getCatalog().save(points);doc=getAsDOM("wms?service=WMS&request=getCapabilities&version=1.3.0",true);//print(doc);assertXpathEvaluatesTo("1","count(//wms:Attribution)",doc);assertXpathEvaluatesTo("1","count(//wms:Attribution/wms:Title)",doc);assertXpathEvaluatesTo("1","count(//wms:Attribution/wms:LogoURL)",doc);
if(globalLayerGroup!=null){catalog.remove(globalLayerGroup);
if(Proxy.isProxyClass(layerGroup.getClass())){//wehaveaproxyweneedtogetridoftheproxyModificationProxyproxy=(ModificationProxy)Proxy.getInvocationHandler(layerGroup);proxy.commit();layerGroup=(LayerGroupInfo)proxy.getProxyObject();
if(workspace==null){returngetCatalog().getLayerGroupByName(layerGroupName);
if(filter==Filter.INCLUDE){returnthis;
else{returnsuper.subCollection(filter);
if(exceptioninstanceofOWS20Exception){OWS20Exceptionex=(OWS20Exception)exception;
if(ex.getHttpCode()!=null){response.setStatus(ex.getHttpCode());
else{response.setStatus(500);
else{OWS20Exception.OWSExceptionCodecode=OWS20Exception.OWSExceptionCode.getByCode(exception.getCode());
if(code!=null){response.setStatus(code.getHttpCode());
else{response.setStatus(500);
if(geoServer.getSettings().isVerboseExceptions()){ByteArrayOutputStreamstackTrace=newByteArrayOutputStream();e.printStackTrace(newPrintStream(stackTrace));sb.append("\nDetails:\n");sb.append(newString(stackTrace.toByteArray()));
if(useComma){String[]parts=value.split(",(?![^()]*+\\))");declarations=Arrays.asList(parts);
else{declarations=(List<String>)newFlatKvpParser("",String.class).parse(value);
if(!decl.startsWith("xmlns(")||!decl.endsWith(")")){thrownewServiceException("Illegalnamespacedeclaration,"+"shouldbeoftheformxmlns(<prefix>=<nsuri>):"+decl,ServiceException.INVALID_PARAMETER_VALUE,getKey());
if(parts.length==1){prefix=XMLConstants.DEFAULT_NS_PREFIX;uri=parts[0];
else
if(parts.length==2){prefix=parts[0];uri=parts[1];
else{thrownewServiceException("Illegalnamespacedeclaration,"+"shouldbeoftheformprefix"+separator+"<namespaceuri>:"+decl,ServiceException.INVALID_PARAMETER_VALUE,getKey());
ifthat'sstill//availableSimpleFeatureTypeft=(SimpleFeatureType)task.getMetadata().get(FeatureType.class);
if(ft==null){//
ifthetypeisnotavailable,wecangenerateonefromtheresource//wearen'tabletoaskforthefeaturetypefromtheresourcedirectly,//becausewedon'thaveabackingstoreFeatureTypeInfofti=(FeatureTypeInfo)task.getLayer().getResource();ft=buildFeatureTypeFromInfo(fti);MetadataMapmetadata=fti.getMetadata();
if(metadata.containsKey("importschemanames")){Map<Object,Object>userData=ft.getUserData();userData.put("schemanames",metadata.get("importschemanames"));
if(inputStream!=null){inputStream.close();
if(a==null){returnb;
if(!attrNames.contains(ad.getLocalName())){ftb.add(ad);
if(!existringAttrNames.contains(attr)){ftb.add(attr,String.class);
if(objectinstanceofSimpleFeature){SimpleFeaturefeature=(SimpleFeature)object;SimpleFeatureTypeft=feature.getFeatureType();aggregateFeatureType=unionFeatureTypes(aggregateFeatureType,ft);Map<Object,Object>userData=feature.getUserData();@SuppressWarnings("unchecked")Map<String,Object>untypedData=(Map<String,Object>)userData.get("UntypedExtendedData");
if(untypedData!=null){untypedAttributes.addAll(untypedData.keySet());
else
if(objectinstanceofSimpleFeatureType){SimpleFeatureTypeschema=(SimpleFeatureType)object;schemas.add(schema);schemaNames.add(schema.getName().getLocalPart());
if(aggregateFeatureType==null&&schemas.isEmpty()){thrownewIllegalArgumentException("Nofeaturesfound");
if(!schemaNames.isEmpty()){Map<Object,Object>userData=featureType.getUserData();userData.put("schemanames",schemaNames);
if(userData.containsKey("schemanames")){MetadataMapmetadata=resource.getMetadata();metadata.put("importschemanames",(Serializable)userData.get("schemanames"));
if(ugCounter==2&&gaCounter==2){failed=false;break;
if(failed){Assert.fail("FileWatchersnotworking");
if(fail){//Assert.fail("IOExceptionnotthrownforconcurrentwritelock");//
if(OLD_TMP_VALUE==null){System.clearProperty(JAVA_IO_TMPDIR);
else{System.setProperty(JAVA_IO_TMPDIR,OLD_TMP_VALUE);
ifwecanusethestgeorgegridshiftfilesastheESPGdbwouldlikeusto*/@TestpublicvoidtestNadCon()throwsException{CoordinateReferenceSystemcrs4138=CRS.decode("EPSG:4138");CoordinateReferenceSystemcrs4326=CRS.decode("EPSG:4326");MathTransformmt=CRS.findMathTransform(crs4138,crs4326);assertTrue(mt.toWKT().contains("NADCON"));double[]src=newdouble[]{-169.625,56.575};double[]expected=newdouble[]{-169.62744,56.576034};double[]p=newdouble[2];mt.transform(src,0,p,0,1);assertEquals(expected[0],p[0],1e-6);assertEquals(expected[1],p[1],1e-6);}}
ifandonly
ifstrictPathistruefor(charc:"*:,'&?\"<>|".toCharArray()){for(Stringprefix:newString[]{"foo",""}){for(Stringsuffix:newString[]{"bar",""}){Stringname=prefix+c+suffix;try{assertEquals(name,Paths.path(true,name));fail("invalid:"+name);
ifandonly
ifstrictPathistruefor(charc:"*:,'&?\"<>|".toCharArray()){for(Stringprefix:newString[]{"foo",""}){for(Stringsuffix:newString[]{"bar",""}){Stringname=prefix+c+suffix;try{assertEquals(name,Paths.valid(true,name));fail("invalid:"+name);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;LayerResourceother=(LayerResource)obj;
if(error==null){
if(other.error!=null)returnfalse;
else
if(!error.equals(other.error))returnfalse;
if(name==null){
if(other.name!=null)returnfalse;
else
if(!name.equals(other.name))returnfalse;
if(status==null){
if(other.status!=null)returnfalse;
else
if(!status.equals(other.status))returnfalse;
if(uri==null){
if(other.uri!=null)returnfalse;
else
if(!uri.equals(other.uri))returnfalse;returntrue;
if(status.compareTo(o.status)!=0){returnstatus.compareTo(o.status);
if(!"cite".equals(ri.getStore().getWorkspace().getName())){tam.putLimits("cite",ri,newDataAccessLimits(CatalogMode.HIDE,Filter.EXCLUDE));
if(!"cite".equals(ri.getStore().getWorkspace().getName())){tam.putLimits("citeChallenge",ri,newDataAccessLimits(CatalogMode.CHALLENGE,Filter.EXCLUDE));
ifGeoServerEnvParametrizationisenabled!
if(gsEnvironment==null||!GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){capabilitiesURL.getFormComponent().add(newWMTSCapabilitiesURLValidator());
iftheprocessfailssomehowtheoriginal"info"doesnotend*upwithanidset*/WMTSStoreInfoexpandedStore=(WMTSStoreInfo)getCatalog().getResourcePool().clone(info,true);WMTSStoreInfosavedStore=getCatalog().getFactory().createWebMapTileServer();//GR:thisshouldn'tfail,theCatalog.save(StoreInfo)APIdoesnotdeclareanyactionin//caseofafailure!...strange,whyasavecan'tfail?//Still,becautiousandwrapitinatry/catchblocksothepagedoesnotblowuptry{//GeoServerEnvsubstitution;validatefirstValidationResultvalidate=getCatalog().validate(expandedStore,false);validate.throwIfInvalid();//GeoServerEnvsubstitution;forceto*AVOID*resolvingenvplaceholders...savedStore=(WMTSStoreInfo)getCatalog().getResourcePool().clone(info,false);//...andsavegetCatalog().save(savedStore);
if(user!=null&&user.length()>0&&pwd!=null&&pwd.length()>0){client.setUser(user);client.setPassword(pwd);
if(provider!=null){EntityResolverentityResolver=provider.getEntityResolver();
if(entityResolver!=null){hints.put(XMLHandlerHints.ENTITY_RESOLVER,entityResolver);
if(ref.getMethod()==MethodType.POST_LITERAL){request=(ExecuteType)ref.getBody();
else{ExecuteKvpRequestReaderreader=(ExecuteKvpRequestReader)context.getBean("executeKvpRequestReader");request=(ExecuteType)kvpParse(ref.getHref(),reader);
if(executeRequest.getRequest().getResponseForm()!=null){net.opengis.wps10.ResponseFormTyperesponseForm=executeRequest.getRequest().getResponseForm();net.opengis.wps10.ResponseDocumentTyperesponseDoc=responseForm.getResponseDocument();
if(responseDoc!=null){for(Objectoutput:responseDoc.getOutput()){net.opengis.wps10.DocumentOutputDefinitionTypeoutputType=(net.opengis.wps10.DocumentOutputDefinitionType)output;StringparameterName=outputType.getIdentifier().getValue();for(Map.Entry<String,Object>entry:results.entrySet()){
if(entry.getKey().equalsIgnoreCase(parameterName)){Objectvalue=entry.getValue();
if(value!=null&&ppio.getType().isInstance(value))returnvalue;
if(obj!=null&&!ppio.getType().isInstance(obj)){thrownewWPSException("Theprocessoutputisincompatiblewiththeinputtargettype,wasexpecting"+ppio.getType().getName()+"andgot"+obj.getClass().getName());
ifcancellationtriggers
if(objinstanceofFeatureCollection){obj=CancellingFeatureCollectionBuilder.wrap((FeatureCollection)obj,listener);
ifatempdirisavailbale
if(newXMLSecurityConfigValidator(getSecurityManager()).getTempDir()!=null){StringinvalidPath="abc"+File.separator+"def.xml";XMLRoleServiceConfigxmlConfig4=(XMLRoleServiceConfig)createRoleConfig("test4",XMLRoleService.class,XMLRoleService.DEFAULT_LOCAL_ADMIN_ROLE,invalidPath);try{validator.validateAddRoleService(xmlConfig4);fail("filecreationfailureshouldoccur");//getSecurityManager().saveRoleService(xmlConfig);
ifatempdirisavailbale
if(newXMLSecurityConfigValidator(getSecurityManager()).getTempDir()!=null){StringinvalidPath="abc"+File.separator+"def.xml";XMLUserGroupServiceConfigxmlConfig4=(XMLUserGroupServiceConfig)createUGConfig("test4",XMLUserGroupService.class,getPlainTextPasswordEncoder().getName(),PasswordValidator.DEFAULT_NAME,invalidPath);try{validator.validateAddUserGroupService(xmlConfig4);fail("filecreationshouldfail");//getSecurityManager().saveUserGroupService(xmlConfig);
if(LayerInfo.class.isAssignableFrom(type)){return(IConverter<C>)newLayerInfoConverter();
else{returnsuper.getConverter(type);
if(s.getWorkspace()==null){globalStyles.add(s);
if(workspace!=null){styles.addAll(GeoServerApplication.get().getCatalog().getStylesByWorkspace(workspace));
if(StyleInfo.class.isAssignableFrom(type)){return(IConverter<C>)newStyleInfoConverter();
else{returnsuper.getConverter(type);
if(coordValues.size()!=2){thrownewServiceException(value+"isnotavalidcoordinate",getClass().getName());
if*theyarenotissuingeventstotheprocesslistener*/privateProcessStatusTrackerstatusTracker;/**Thecurrentlyrunningprocesses*/privateMap<String,ProcessListenerNotifier>localProcesses=newConcurrentHashMap<String,ProcessListenerNotifier>();/**Thetimerinformingthestatustrackerofthecurrentlyexecutingprocesses*/privateTimerheartbeatTimer;/**Thedelaybetweenoneheartbeatandthenext*/privateintheartbeatDelay;/**UsedtoretrievethecurrentWPSInfo*/privateGeoServergeoServer;publicWPSExecutionManager(GeoServergeoServer,WPSResourceManagerresourceManager,ProcessStatusTrackerstatusTracker){this.resourceManager=resourceManager;this.statusTracker=statusTracker;this.geoServer=geoServer;
if(synchronous){response=executor.call();
else{LOGGER.log(Level.INFO,"Submittingnewasynchprocess"+processName.getURI()+"withexecutionid"+executionId);//buildingtheresponsewhiletheprocessisstill"queued",willresultin//ProcessAcceptedintheresponsetry{resourceManager.storeRequestObject(request.getRequest(),executionId);
if(synchronous){returnwps.getMaxSynchronousExecutionTime()*1000;
else{returnwps.getMaxAsynchronousExecutionTime()*1000;
if(synchronous){returnwps.getMaxSynchronousTotalTime()*1000;
else{returnwps.getMaxAsynchronousTotalTime()*1000;
if(processManagers==null){synchronized(this){
if(processManagers==null){processManagers=GeoServerExtensions.extensions(ProcessManager.class);
if(pm.canHandle(processName)){returnpm;
ifitdoesnotupdateitsstatus)**@parami*/publicvoidsetHeartbeatDelay(intheartbeatDelay){
if(heartbeatDelay!=this.heartbeatDelay){this.heartbeatDelay=heartbeatDelay;
if(heartbeatTimer!=null){heartbeatTimer.cancel();
if(eventinstanceofContextRefreshedEvent){
if(executors==null){executors=Executors.newCachedThreadPool();
else
if(eventinstanceofContextClosedEvent){executors.shutdownNow();
ifweexecuteasynchronouslywe'llneedtomakesureallthreadlocalsare//transferred(inparticular,theexecutionIdinWPSResourceManager)
if(status.isAsynchronous()){this.transfer=newThreadLocalsTransfer();
if(ppioinstanceofComplexPPIO){returntrue;
if(transfer!=null){try{transfer.apply();localProcesses.put(status.getExecutionId(),notifier);returnexecute();
else{returnexecute();
if(hasComplexOutputs()){longSteps++;
if(status.getPhase()==ProcessState.RUNNING){notifier.fireProgress(inputPercentage+executionPercentage,"Executioncompleted,preparingtowriteresponse");
if(status.getPhase()!=ProcessState.DISMISSING){LOGGER.log(Level.SEVERE,"Processexecutionfailed",e);notifier.fireFailed(e);
if(status.getPhase()==ProcessState.RUNNING){notifier.fireProgress(inputPercentage+executionPercentage,"Writingoutputs");
ifwritingmighttakesometimeExecutionStatuscompletedStatus=newExecutionStatus(status);
if(status.getPhase()==ProcessState.RUNNING){completedStatus.setPhase(ProcessState.SUCCEEDED);
else{completedStatus.setPhase(ProcessState.FAILED);
if(status.getPhase()!=ProcessState.DISMISSING){notifier.fireFailed(e);
ifwearebeingcancelled,cleanupeverythingrightnow
if(status.getPhase()!=ProcessState.DISMISSING){
if(synchronous){notifier.fireCompleted();
else{try{//writeoutthefinalresponsetoafilethatwillbekeptthere//forGetExecutionStatusrequestsResourceoutput=resourceManager.getStoredResponse(status.getExecutionId());try{
if(status.getPhase()==ProcessState.RUNNING){notifier.fireProgress(inputPercentage+executionPercentage+outputPercentage/2,"Writingoutresponse");
ifpossibleLOGGER.log(Level.SEVERE,"Requestfailedduringoutputencoding",e);status.setException(e);ExecuteResponseBuilderbuilder=newExecuteResponseBuilder(status.getRequest(),applicationContext,status);builder.setOutputs(null);result=builder.build();writeOutResponse(result,output);notifier.fireCompleted();
else{notifier.fireCompleted();
ifneedsbe**@paramexecutionId*/publicvoidcancel(StringexecutionId){ExecutionStatusstatus=statusTracker.getStatus(executionId);
if(status==null){thrownewUnknownExecutionIdException(executionId);
iftheprocessisrunninglocally,cleanit
if(status.getPhase()==ProcessState.RUNNING){ProcessListenerNotifiernotifier=localProcesses.get(executionId);
if(notifier!=null){notifier.dismiss();
else{status.setPhase(ProcessState.DISMISSING);statusTracker.dismissing(newProcessEvent(status,null,null));
if(!status.getPhase().isExecutionCompleted()){return;
if(!canCreateStore){h.add(newLabel("message",newStringResourceModel("noCreateStore",this,null)).add(newAttributeAppender("class",newModel("info-link"),"")));
else{h.add(newLabel("message",newModel()).add(newAttributeAppender("class",newModel("displayNone"),"")));
if(type.isAssignableFrom(Polygon.class)||type.isAssignableFrom(MultiPolygon.class)){m_iShapeType=IVectorLayer.SHAPE_TYPE_POLYGON;
else
if(type.isAssignableFrom(LineString.class)||type.isAssignableFrom(MultiLineString.class)){m_iShapeType=IVectorLayer.SHAPE_TYPE_LINE;
else{m_iShapeType=IVectorLayer.SHAPE_TYPE_POINT;
if(m_iShapeType==IVectorLayer.SHAPE_TYPE_POINT){builder.add("geom",MultiPoint.class);
else
if(m_iShapeType==IVectorLayer.SHAPE_TYPE_LINE){builder.add("geom",MultiLineString.class);
else{builder.add("geom",MultiPolygon.class);
if(ginstanceofPoint){geom=gf.createMultiPoint(newPoint[]{(Point)g});
else
if(ginstanceofPolygon){geom=gf.createMultiPolygon(newPolygon[]{(Polygon)g});
else
if(ginstanceofLineString){geom=gf.createMultiLineString(newLineString[]{(LineString)g});
else{geom=g;
if(m_FeatureSource!=null){FeatureCollectionfc;try{fc=m_FeatureSource.getFeatures();
else{returnnull;
if(m_FeatureCollection!=null){returnm_FeatureCollection;
else{returnm_FeatureSource;
if(m_FeatureCollection!=null){postProcess();
if(m_sFilename!=null){finalFileDataStorestore=FileDataStoreFinder.getDataStore(newFile(m_sFilename));finalSimpleFeatureSourcefeatureSource=store.getFeatureSource();create(featureSource);
iftheSAVEwassuccessfultester.assertRenderedPage(RepositoriesPage.class);
if(resourceLoader.get(CONFIG_DIR_NAME)==null){thrownewIllegalStateException("Unabletocreateconfigdirectory"+CONFIG_DIR_NAME);
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Processingevent"+event.getKind()+"forrepo"+repoId+"onthread"+thread);
switch(event.getKind()){caseENTRY_CREATE:{//ResourceStoremayissueentry_createbeforeorafterthe//contentswhere//written,butit'llalwaysissueanentry_modifyevent//justafterthe//contentsarewritten,soweignorethecreateeventsand//waitforthe//modifyeventstoavoiddoubleprocessing
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("ReceivedanENTRY_CREATEeventforrepoid"+repoId+"Eventignored,waitingfortheENTRY_MODIFYeventtoprocessit");
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Finishedprocessingevent"+event.getKind()+"forrepo"+repoId+"onthread"+thread);
ifitwas{@codenull}*@implNotethismethodsavesthe{@linkRepositoryInfo}totheinternalcache,settingits*{@linkRepositoryInfo#getLastModified()timestamp}to{@code-1},meaningitwasjust*savedonthisnode.Theresourcestoreeventlistenerwillnotreloaditbutjustupdate*itstimestamp,whileonothernodesit'llload/reloaditasneeded.Thisensuresonthis*nodethe{@linkRepositoryInfo}willbeavailablerightafterthismethodreturns,*regardlessofhowlongittakestheresourcestoreeventdispatchertonotifythisor*othernodes.*/publicRepositoryInfosave(RepositoryInfoinfo){checkNotNull(info,"nullRepositoryInfo");ensureIdPresent(info);checkNotNull(info.getLocation(),"nulllocationURI:%s",info);Resourceresource=resource(info.getId());lock.writeLock().lock();try(OutputStreamout=resource.out()){info.setLastModified(-1L);//meaningjustsavedonthisnodeinfosById.put(info.getId(),info);getConfigredXstream().toXML(info,newOutputStreamWriter(out,Charsets.UTF_8));
if(id==null){id=UUID.randomUUID().toString();info.setId(id);
else{checkIdFormat(id);
if(info.getLocation()==null){thrownewIllegalStateException("Repositoryinfohasincompleteinformation:"+info);
if(null==resources||resources.isEmpty()){returnCollections.emptyList();
if(!(parent.getType().equals(Resource.Type.DIRECTORY)&&input.getType().equals(Resource.Type.RESOURCE))){returnnewArrayList();
if(currentTimeStamp!=cachedTimestamp){
if(0L==currentTimeStamp){thrownewNoSuchElementException("Repositorynotfound:"+id);
else{
if(-1L==cachedTimestamp){cached.setLastModified(currentTimeStamp);info=cached;
else{try{info=loadInfo(resource);infosById.put(info.getId(),info);
else{info=cached;
if*youdomodifyanythinginthisclass(especiallythemodels),manuallyretestthattheeditsare*notlostontabswitch.*/publicclassResourceConfigurationPageextendsPublishedConfigurationPage<LayerInfo>{privatestaticfinallongserialVersionUID=7870938096047218989L;IModel<ResourceInfo>myResourceModel;publicResourceConfigurationPage(PageParametersparameters){this(parameters.get(WORKSPACE).toOptionalString(),parameters.get(NAME).toString());
if(workspaceName!=null){NamespaceInfons=getCatalog().getNamespaceByPrefix(workspaceName);
if(ns==null){//unlikelytohappen,requiressomeonemakingmodificationsontheworkspaces//withalayerpageopeninanothertab/windowthrownewRuntimeException("Couldnotfindworkspace"+workspaceName);
else{layer=getCatalog().getLayerByName(layerName);
if(layer==null){error(newParamResourceModel("ResourceConfigurationPage.notFound",this,layerName).getString());setResponsePage(returnPage);return;
if(!list.get(i).canHandle(getResourceInfo())){list.remove(i);i--;
if(componentinstanceofResourceConfigurationPanel){ResourceConfigurationPanelrcp=(ResourceConfigurationPanel)component;rcp.resourceUpdated(target);visit.dontGoDeeper();
if(isNew){//updatinggrid
ifisacoverage
if(resourceInfoinstanceofCoverageInfo){//thecoverageboundscomputationpathisabitmorelinear,the//readersalwaysreturntheboundsandintheproperCRS(afaik)CoverageInfocinfo=(CoverageInfo)resourceInfo;GridCoverage2DReaderreader=(GridCoverage2DReader)cinfo.getGridCoverageReader(null,GeoTools.getDefaultHints());//getboundsfinalReferencedEnvelopebounds=newReferencedEnvelope(reader.getOriginalEnvelope());//applythebounds,takingintoaccountthereprojectionpolicy
ifneedbefinalProjectionPolicyprojectionPolicy=resourceInfo.getProjectionPolicy();
if(projectionPolicy!=ProjectionPolicy.NONE&&bounds!=null){//weneedtofixtheregisteredgridforthiscoveragefinalGridGeometrygrid=cinfo.getGrid();cinfo.setGrid(newGridGeometry2D(grid.getGridRange(),grid.getGridToCRS(),resourceInfo.getCRS()));
else{ResourceInfooldState=catalog.getResource(resourceInfo.getId(),ResourceInfo.class);catalog.validate(resourceInfo,true).throwIfInvalid();catalog.save(resourceInfo);try{LayerInfolayer=getPublishedInfo();layer.setResource(resourceInfo);catalog.save(layer);
if(dir!=null){Filter<Resource>filter=type!=null?newFilter<Resource>(){@Overridepublicbooleanaccept(Resourcepathname){returntype.equalsIgnoreCase(FilenameUtils.getExtension(pathname.name()));
if(path.equals("apps")){ResourcemainScript=scriptMgr.findAppMainScript(f);
if(mainScript!=null){Stringname=mainScript.path().substring(f.parent().path().length()+1).replace("\\","/");scripts.add(newScript(name));
else
if(path.equals("wps")){
if(f.getType()==Type.DIRECTORY){Stringnamespace=f.name();List<Resource>files=f.list();for(Resourcefile:files){Stringname=namespace+":"+file.name();scripts.add(newScript(name));
else{Stringname=f.name();scripts.add(newScript(name));
else{Stringname=f.name();scripts.add(newScript(name));
if(path.contains(":")){path=path.replace(":","/");
if(!Resources.exists(script)){thrownewRestException(format("Couldnotfindscript%s",path),HttpStatus.NOT_FOUND);
if(path.contains(":")){path=path.replace(":","/");
if(path.contains(":")){path=path.replace(":","/");
if(!Resources.exists(script)){thrownewIOException(format("Unabletofindscriptfile%s",path));
if(script!=null&&Resources.exists(script)){success=script.delete();
if(path.startsWith("apps")){success=script.parent().delete();
if(!success){thrownewRestException(format("Errordeletingscriptfile%s",path),HttpStatus.INTERNAL_SERVER_ERROR);
if(i>-1){returnpath.substring(0,i);
else{returnpath;
if(parts.isEmpty()){continue;
switch(part){caseProduct:resource="/product.json";name="product.json";break;caseDescription:resource="/product-description.html";name="description.html";break;caseMetadata:resource="/product-metadata.xml";name="metadata.xml";break;caseThumbnail:resource="/product-thumb.jpeg";name="thumbnail.jpeg";break;caseOwsLinks:resource="/product-links.json";name="owsLinks.json";break;caseGranules:resource="/product-granules.json";name="granules.json";break;default:thrownewRuntimeException("Unexpectedpart"+part);
if(parts.contains(ProductPart.Product)){assertEquals(201,response.getStatus());assertEquals("http://localhost:8080/geoserver/rest/oseo/collections/SENTINEL2/products/S2A_OPER_MSI_L1C_TL_SGS__20180101T000000_A006640_T32TPP_N02.04",response.getHeader("location"));assertProductCreated();
else{assertEquals(400,response.getStatus());assertThat(response.getContentAsString(),containsString("product.json"));//failed,nothing
elsetocheckreturn;
if(parts.contains(ProductPart.Description)){assertProductDescription();
if(parts.contains(ProductPart.Metadata)){assertProductMetadata();
if(parts.contains(ProductPart.Thumbnail)){assertProductThumbnail();
if(parts.contains(ProductPart.OwsLinks)){assertProductLinks();
if(parts.contains(ProductPart.Granules)){assertProductGranules();
if(lastCommaIndex==-1){selectedRoles.setLength(0);realInput=input;
else{selectedRoles.setLength(0);selectedRoles.append(input.substring(0,lastCommaIndex)+";");realInput=input.substring(lastCommaIndex+1);
if(realInput.isEmpty()||role.startsWith(realInput.toUpperCase())||role.startsWith(realInput.toLowerCase())){List<String>sr=Arrays.asList(selectedRoles.toString().split(";"));
if(!sr.contains(role)){completions.add(role+";");
if(iteminstanceofCoverageStoreInfo&&((CoverageStoreInfo)item).getType().equals(COVERAGE_TYPE)){returntrue;
if(!FilenameUtils.getBaseName(res.name()).equals(mosaicName)&&Resources.exists(res)&&Resources.canRead(res)){booleanresult=copyFile(sourceBackupFolder,mosaicIndexBase,res,false);
if(result&&FilenameUtils.getBaseName(res.name()).equals("datastore")){//Thecopyofthenew"datastore.properties"wassuccessful,meaningthat//therewasn'tanothercopyofthatfileonthetargetfolder.datastoreAlreadyPresent=false;
if(Resources.exists(res)&&Resources.canRead(res)){booleanresult=copyFile(sourceBackupFolder,mosaicIndexBase,res,true);
if(result){resolveTemplate(sourceBackupFolder,mosaicIndexBase,res);
if(!datastoreAlreadyPresent){//Sinetherewasn'talreadya"datasotre.properties"onthetargetfolder//weassumethisisanewmosaic.//Weneedtobesuretheproperty"CanBeEmpty=true"ispresentonthe//"indexer.properties"finalFileindexerFile=newFile(mosaicIndexBase.dir(),"indexer.properties");PropertiesindexerProperties=newProperties();
if(indexerFile.exists()&&indexerFile.canRead()){indexerProperties.load(newFileInputStream(indexerFile));
if(GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){value=(String)gsEnvironment.resolveValue(value);
if(!Resources.exists(targetFtl)||overwrite){
if(!targetFtl.parent().dir().exists()){targetFtl.parent().dir().mkdirs();
ifweremovethemallthe*groupwillhavetoberemovedaswell*/Map<LayerGroupInfo,Set<LayerInfo>>groups;publicCascadeRemovalReporter(Catalogcatalog){this.catalog=catalog;reset();
ifnotypefilteringis*desired*@parammodificationThekindofmodificationtobesearchedfor,ornull
ifnomodification*typefilteringisdesired*/public<T>List<T>getObjects(Class<T>catalogClass,ModificationType...modifications){List<T>result=newArrayList<T>();List<ModificationType>mods=(modifications==null||modifications.length==0)?null:Arrays.asList(modifications);for(CatalogInfoci:objects.keySet()){
if(catalogClass==null||catalogClass.isAssignableFrom(ci.getClass())){
if(mods==null||mods.contains(objects.get(ci)))result.add((T)ci);
ifthemodification*isstrongerthattheonealreadyregistered*/voidadd(CatalogInfoci,ModificationTypetype){ModificationTypeoldType=objects.get(ci);
if(oldType==null||oldType.compareTo(type)>0){objects.put(ci,type);
if(!layers.isEmpty()){for(LayerInfoli:layers){li.accept(this);
else{ri.accept(this);
if(layers==null){layers=newHashSet<LayerInfo>();groups.put(group,layers);
ifallthelayersinsideof//itaregoingtoberemoved,justchangedotherwise
if(layers.size()==newHashSet<PublishedInfo>(group.getLayers()).size()){visit(group);
else{add(group,ModificationType.GROUP_CHANGED);
if(style.equals(li.getDefaultStyle()))add(li,ModificationType.STYLE_RESET);
else
if(li.getStyles().contains(style))add(li,ModificationType.EXTRA_STYLE_REMOVED);
if(style.equals(group.getRootLayerStyle())){add(group,ModificationType.GROUP_CHANGED);
if(group.getStyles().contains(style)){add(group,ModificationType.GROUP_CHANGED);
if(group.getLayers().contains(layerGroupToRemove)){finalList<PublishedInfo>layers=newArrayList<>(group.getLayers());layers.removeAll(objects.keySet());
if(layers.size()==0){visit(group);
else{add(group,ModificationType.GROUP_CHANGED);
if(filterinstanceofId){IdidFilter=(Id)filter;
if(idFilter.getIdentifiers().size()>1){//thereshouldonlybeonetypeofidspecifiedHashSettypes=newHashSet();for(Iteratori=idFilter.getIdentifiers().iterator();i.hasNext();){Identifierid=(Identifier)i.next();types.add(id.getClass());
if(types.size()!=1){thrownewException("OnlyonetypeofIdcanbesuppliedinasinglefilter");
if(extension==null){GeoServerExtensionsHelper.init(this.applicationContext);
if(defaultWorkspace.exists()){defaultWorkspace.delete();
if(listenerinstanceofResourcePool.CacheClearingListener){countCleaner++;
else
if(listenerinstanceofGeoServerConfigPersister){countPersister++;
if(lginstanceofSecuredLayerGroupInfo){lg=((SecuredLayerGroupInfo)lg).unwrap(LayerGroupInfo.class);
ifthebeanis*comingfromtheGeoToolsSPIbridge*@parambeanThebeanitself*@returntruetoexclude*/booleanexclude(StringbeanId,Objectbean);}
iftruethenanexistingstorewiththesamenameandworkspacewill*causeavalidationerror.*@returnsList<RuntimeException>non-empty
ifvalidationfails*/ValidationResultvalidate(StoreInfostore,booleanisNew);/**Removesanexistingstore.*/voidremove(StoreInfostore);/**Savesastorethathasbeenmodified.*/voidsave(StoreInfostore);/***Detachesthestorefromthecatalog.**<p>Thismethoddoesnotremovetheobjectfromthecatalog,it"unnattaches"theobject*resolvinganyproxies.**<p>Intheeventhespecifiedobjectdoesnotexistinthecatalogititselfshouldbe*returned,thismethodshouldneverreturnnull.*/<TextendsStoreInfo>Tdetach(Tstore);/***Returnsthestorewiththespecifiedid.**<p><tt>clazz</td>isusedtodeterminetheimplementationofStoreInfowhichshouldbe*returned.Anexamplewhichwouldreturnadatastore.**<pre>*<code>*DataStoreInfodataStore=catalog.getStore(&quot;id&quot;,DataStoreInfo.class);*</code>*</pre>**@paramidTheidofthestore.*@paramclazzTheclassofthestoretoreturn.*@returnThestorematchingid,or<code>null</code>
ifnosuchstoreexists.*/<TextendsStoreInfo>TgetStore(Stringid,Class<T>clazz);/***Returnsthestorewiththespecifiedname.**<p><tt>clazz</td>isusedtodeterminetheimplementationofStoreInfowhichshouldbe*returned.Anexamplewhichwouldreturnadatastore.**<p>**<pre>*getStoreByName(null,name,clazz);*</pre>**@paramnameThenameofthestore.Thenamecanbe{@codenull}or{@link#DEFAULT}to*retrievethedefaultstoreinthedefaultworkspace.*@paramclazzTheclassofthestoretoreturn.*@returnThestorematchingname,or<code>null</code>
ifnosuchstoreexists.*/<TextendsStoreInfo>TgetStoreByName(Stringname,Class<T>clazz);/***Returnsthestorewiththespecifiednameinthespecifiedworkspace.**<p><tt>clazz</td>isusedtodeterminetheimplementationofStoreInfowhichshouldbe*returned.Anexamplewhichwouldreturnadatastore.**<p>**<pre>*<code>*DataStoreInfodataStore=catalog.getStore(&quot;workspaceName&quot;,&quot;name&quot;,DataStoreInfo.class);*</code>*</pre>**@paramworkspaceNameThenameoftheworkspacecontainingthestore.Thenamecanbe{@code*null}or{@link#DEFAULT}toidentifythedefaultworkspace.*@paramnameThenameofthestore.Thenamecanbe{@codenull}or{@link#DEFAULT}to*retrievethedefaultstoreinthespecifiedworkspace.*@paramclazzTheclassofstoretoreturn.*@returnThestorematchingname,or<code>null</code>
ifnosuchstoreexists.*/<TextendsStoreInfo>TgetStoreByName(StringworkspaceName,Stringname,Class<T>clazz);/***Returnsthestorewiththespecifiednameinthespecifiedworkspace.**<p><tt>clazz</td>isusedtodeterminetheimplementationofStoreInfowhichshouldbe*returned.Anexamplewhichwouldreturnadatastore.**<p>**<pre>*<code>*WorkspaceInfoworkspace=...;*DataStoreInfodataStore=catalog.getStore(workspace,&quot;name&quot;,DataStoreInfo.class);*</code>*</pre>**@paramworkspaceTheworkspacecontainingthestore.*@paramnameThenameofthestore.Thenamecanbe{@codenull}or{@link#DEFAULT}to*retrievethedefaultstoreinthedefaultworkspace.*@paramclazzTheclassofstoretoreturn.*@returnThestorematchingname,or<code>null</code>
ifnosuchstoreexists.*/<TextendsStoreInfo>TgetStoreByName(WorkspaceInfoworkspace,Stringname,Class<T>clazz);/***Allstoresinthecatalogofthespecifiedtype.**<p>The<tt>clazz</tt>parameterisusedtofilterthetypesofstoresreturned.Anexample*whichwouldreturnalldatastores:**<pre>*<code>*catalog.getStores(DataStoreInfo.class);*</code>*</pre>*/<TextendsStoreInfo>List<T>getStores(Class<T>clazz);/***Allstoresinthespecifiedworkspaceofthegiventype.**<p>The<tt>clazz</tt>parameterisusedtofilterthetypesofstoresreturned.Anexample*whichwouldreturnalldatastoresinaspecificworkspace:**<pre>*<code>*WorkspaceInfoworkspace=...;*List<DataStoreInfo>dataStores=*catalog.getStores(workspace,DataStoreInfo.class);*</code>*</pre>**@paramworkspaceTheworkspacecontainingreturnedstores,maybenulltospecifythedefault*workspace.*@paramclazzThetypeofstorestolookup.*/<TextendsStoreInfo>List<T>getStoresByWorkspace(WorkspaceInfoworkspace,Class<T>clazz);/***Allstoresinthespecifiedworkspaceofthegiventype.**<p>Thismethodisconveniencefor:**<pre>*WorkspaceInfows=catalog.getWorkspaceByName(workspaceName);*getStoresByWorkspace(ws,clazz);*</pre>**<p>The<tt>clazz</tt>parameterisusedtofilterthetypesofstoresreturned.**@paramworkspaceNameThenameoftheworkspacecontainingreturnedstores,maybenullto*specifythedefaultworkspace.*@paramclazzThetypeofstorestolookup.*/<TextendsStoreInfo>List<T>getStoresByWorkspace(StringworkspaceName,Class<T>clazz);/***Returnsadatastorematchingaparticularid,or<code>null</code>
ifnosuchdatastore*couldbefound.**<p>Thismethodisconveniencefor:**<pre>*getStore(id,DataStoreInfo.class);*</pre>*/DataStoreInfogetDataStore(Stringid);/***Returnsadatastorematchingaparticularnameinthedefaultworkspace,o*or<code>null*</code>
ifnosuchdatastorecouldbefound.**<p>Thismethodisaconveniencefor:**<pre>*getDataStoreStoreByName(null,name);*</pre>*/DataStoreInfogetDataStoreByName(Stringname);/***Returnsthedatastorematchingaparticularnameinthespecifiedworkspace,or<code>null*</code>
ifnosuchdatastorecouldbefound.**<p>Thismethodisconveniencefor:**<pre>*WorkspaceInfows=catalog.getWorkspace(workspaceName);*returncatalog.getDataStoreByName(ws,name);*</pre>**@paramnameThenameofthedatastore.*@paramworkspaceNameThenameoftheworkspacecontainingthedatastore,maybe<code>null*</code>tospecifythedefaultworkspace.*@returnThestorematchingthename,ornull
ifnosuchstorecouldbefound.*/DataStoreInfogetDataStoreByName(StringworkspaceName,Stringname);/***Returnsthedatastorematchingaparticularnameinthespecifiedworkspace,or<code>null*</code>
ifnosuchdatastorecouldbefound.**@paramnameThenameofthedatastore.*@paramworkspaceTheworkspacecontainingthedatastore,maybe<code>null</code>tospecify*thedefaultworkspace.*@returnThestorematchingthename,ornull
ifnosuchstorecouldbefound.*/DataStoreInfogetDataStoreByName(WorkspaceInfoworkspace,Stringname);/***Alldatastoresinthespecifiedworkspace.**<p>Thismethodisequivalentto:**<pre>*getStoresByWorkspace(workspaceName,DataStoreInfo.class);*</pre>**@paramworkspaceNameThenameoftheworkspace.*/List<DataStoreInfo>getDataStoresByWorkspace(StringworkspaceName);/***Alldatastoresinthespecifiedworkspace.**<p>Thismethodisequivalentto:**<pre>*getStoresByWorkspace(workspace,DataStoreInfo.class);*</pre>**@paramworkspaceThenameoftheworkspace.*/List<DataStoreInfo>getDataStoresByWorkspace(WorkspaceInfoworkspace);/***Alldatastoresinthecatalog.**<p>Theresultinglistshouldnotbemodifiedtoaddorremovestores,the{@link*#add(StoreInfo)}and{@link#remove(StoreInfo)}areusedforthispurpose.*/List<DataStoreInfo>getDataStores();/**Thedefaultdatastoreforthespecifiedworkspace*/DataStoreInfogetDefaultDataStore(WorkspaceInfoworkspace);/***Setsthedefaultdatastoreinthespecifiedworkspace**@paramworkspace*@paramdefaultStore*/voidsetDefaultDataStore(WorkspaceInfoworkspace,DataStoreInfodefaultStore);/***Returnsacoveragestorematchingaparticularid,or<code>null</code>
ifnosuchcoverage*storecouldbefound.**<p>Thismethodisconveniencefor:**<pre>*getStore(id,CoverageStoreInfo.class);*</pre>*/CoverageStoreInfogetCoverageStore(Stringid);/***Returnsacoveragestorematchingaparticularname,or<code>null</code>
ifnosuchcoverage*storecouldbefound.**<p>Thismethodisaconveniencefor:<code>*<pre>*getCoverageStoreByName(name,CoverageStoreInfo.class)*</pre>*</code>*/CoverageStoreInfogetCoverageStoreByName(Stringname);/***Returnsthecoveragestorematchingaparticularnameinthespecifiedworkspace,or<code>*null</code>
ifnosuchcoveragestorecouldbefound.**<p>Thismethodisconveniencefor:**<pre>*WorkspaceInfows=catalog.getWorkspace(workspaceName);*returncatalog.getCoverageStoreByName(ws,name);*</pre>**@paramnameThenameofthecoveragestore.*@paramworkspaceNameThenameoftheworkspacecontainingthecoveragestore,maybe<code>*null</code>tospecifythedefaultworkspace.*@returnThestorematchingthename,ornull
ifnosuchstorecouldbefound.*/CoverageStoreInfogetCoverageStoreByName(StringworkspaceName,Stringname);/***ReturnsthecoverageStorematchingaparticularnameinthespecifiedworkspace,or<code>*null</code>
ifnosuchcoverageStorecouldbefound.**@paramnameThenameofthecoverageStore.*@paramworkspaceTheworkspacecontainingthecoverageStore,maybe<code>null</code>to*specifythedefaultworkspace.*@returnThestorematchingthename,ornull
ifnosuchstorecouldbefound.*/CoverageStoreInfogetCoverageStoreByName(WorkspaceInfoworkspace,Stringname);/***Allcoveragestoresinthespecifiedworkspace.**<p>Thismethodisequivalentto:**<pre>*getStoresByWorkspace(workspaceName,CoverageStoreInfo.class);*</pre>**@paramworkspaceNameThenameoftheworkspace.*/List<CoverageStoreInfo>getCoverageStoresByWorkspace(StringworkspaceName);/***Allcoveragestoresinthespecifiedworkspace.**<p>Thismethodisequivalentto:**<pre>*getStoresByWorkspace(workspace,CoverageStoreInfo.class);*</pre>**@paramworkspaceThenameoftheworkspace.*/List<CoverageStoreInfo>getCoverageStoresByWorkspace(WorkspaceInfoworkspace);/***Allcoveragestoresinthecatalog.**<p>Theresultinglistshouldnotbemodifiedtoaddorremovestores,the{@link*#add(StoreInfo)}and{@link#remove(StoreInfo)}areusedforthispurpose.*/List<CoverageStoreInfo>getCoverageStores();/***Returnstheresourcewiththespecifiedid.**<p><tt>clazz</td>isusedtodeterminetheimplementationofResourceInfowhichshouldbe*returned.Anexamplewhichwouldreturnafeaturetype.**<pre>*<code>*FeatureTypeInfoft=catalog.getResource(&quot;id&quot;,FeatureTypeInfo.class);*</code>*</pre>**@paramidTheidoftheresource.*@paramclazzTheclassoftheresourcetoreturn.*@returnTheresourcematchingid,or<code>null</code>
ifnosuchresourceexists.*/<TextendsResourceInfo>TgetResource(Stringid,Class<T>clazz);/***Looksuparesourcebyqualifiedname.**<p><tt>ns</tt>maybespecifiedasanamespaceprefixoruri.**<p><tt>clazz</td>isusedtodeterminetheimplementationofResourceInfowhichshouldbe*returned.**@paramnsTheprefixoruritowhichtheresourcebelongs,maybe<code>null</code>.*@paramnameThenameoftheresource.*@paramclazzTheclassoftheresource.*@returnTheresourcematchingthename,or<code>null</code>
ifnosuchresourceexists.*/<TextendsResourceInfo>TgetResourceByName(Stringns,Stringname,Class<T>clazz);/***Looksuparesourcebyqualifiedname.**<p><tt>clazz</td>isusedtodeterminetheimplementationofResourceInfowhichshouldbe*returned.**@paramnsThenamespacetowhichtheresourcebelongs,maybe<code>null</code>tospecify*thedefaultnamespace.*@paramnameThenameoftheresource.*@paramclazzTheclassoftheresource.*@returnTheresourcematchingthename,or<code>null</code>
ifnosuchresourceexists.*/<TextendsResourceInfo>TgetResourceByName(NamespaceInfons,Stringname,Class<T>clazz);/***Looksuparesourcebyqualifiedname.**<p><tt>clazz</td>isusedtodeterminetheimplementationofResourceInfowhichshouldbe*returned.Isolatedworkspacescontentwillbeignoredunlessinthecontextofamatching*virtualservice.**@param<T>*@paramnameThequalifiedname.*/<TextendsResourceInfo>TgetResourceByName(Namename,Class<T>clazz);/***Looksuparesourcebyitsunqualifiedname.**<p>Thelookuprulesusedbythismethodareasfollows:**<ul>*<li>Ifaresourceinthedefaultnamespaceisfoundmatchingthespecifiedname,itis*returned.*<li>Ifasingleresourceamongallnon-defaultnamespacesisfoundmatchingthethe*specifiedname,itisreturned.*</ul>**Careshouldbetakenwhenusingthismethod,useof{@link#getResourceByName(String,String,*Class)}ispreferred.**@paramnameThenameoftheresource.*@paramclazzThetypeoftheresource.*/<TextendsResourceInfo>TgetResourceByName(Stringname,Class<T>clazz);/**Addsanewresource.*/voidadd(ResourceInforesource);/***Validatearesource.**@paramresourcetheResourceInfotobevalidated*@paramisNewaboolean;
iftruethenanexistingresourcewiththesamenameandstorewill*causeavalidationerror.*@returnsList<RuntimeException>non-empty
ifvalidationfails*/ValidationResultvalidate(ResourceInforesource,booleanisNew);/**Removesanexistingresource.*/voidremove(ResourceInforesource);/**Savesaresourcewhichhasbeenmodified.*/voidsave(ResourceInforesource);/***Detatchestheresourcefromthecatalog.**<p>Thismethoddoesnotremovetheobjectfromthecatalog,it"unnattaches"theobject*resolvinganyproxies.**<p>Intheeventhespecifiedobjectdoesnotexistinthecatalogititselfshouldbe*returned,thismethodshouldneverreturnnull.*/<TextendsResourceInfo>Tdetach(Tresource);/***Allresourcesinthecatalogofthespecifiedtype.**<p>The<tt>clazz</tt>parameterisusedtofilterthetypesofresourcesreturned.Anexample*whichwouldreturnallfeaturetypes:**<pre>*<code>*catalog.getResources(FeatureTypeInfo.class);*</code>*</pre>*/<TextendsResourceInfo>List<T>getResources(Class<T>clazz);/***Allresourcesinthespecifiednamespaceofthespecifiedtype.**<p>The<tt>clazz</tt>parameterisusedtofilterthetypesofresourcesreturned.Anexample*whichwouldreturnallfeaturetypes:**@paramnamespaceThenamespace.*@paramclazzTheclassofresourcesreturned.*@returnListofresourcesofthespecifiedtypeinthespecifiednamespace.*/<TextendsResourceInfo>List<T>getResourcesByNamespace(NamespaceInfonamespace,Class<T>clazz);/***Allresourcesinthespecifiednamespaceofthespecifiedtype.**<p>The<tt>namespace</tt>mayspecifytheprefix,ortheuriofthenamespace.**<p>The<tt>clazz</tt>parameterisusedtofilterthetypesofresourcesreturned.Anexample*whichwouldreturnallfeaturetypes:**<p>Thismethodisconveniencefor:**<pre>*NamespaceInfons=getNamespace(namespace);*returngetResourcesByNamespace(ns,clazz);*</pre>**Isolatedworkspacescontentwillbeignoredunlessinthecontextofamatchingvirtual*service.**@paramnamespaceThenamespace.*@paramclazzTheclassofresourcesreturned.*@returnListofresourcesofthespecifiedtypeinthespecifiednamespace.*/<TextendsResourceInfo>List<T>getResourcesByNamespace(Stringnamespace,Class<T>clazz);/***Returnstheresourcewiththespecifiednameoriginatingfromthestore.**@paramstoreThestore.*@paramnameThenameoftheresource.*@paramclazzTheclassofresource.*/<TextendsResourceInfo>TgetResourceByStore(StoreInfostore,Stringname,Class<T>clazz);/***Allresourceswhichoriginatefromthespecifiedstore,ofthespecifiedtype.**@paramstoreThestoretoobtainresourcesfrom.*@paramclazzTheclassofresourcesreturned.*@returnListofresourcesofthespecifiedtypefromthespecifiedstore*/<TextendsResourceInfo>List<T>getResourcesByStore(StoreInfostore,Class<T>clazz);/***Returnsthefeaturetypematchingaparticularid,or<code>null</code>
ifnosuchfeature*typecouldbefound.**<p>Thismethodisconveniencefor:**<pre>*getResource(id,FeatureTypeInfo.class);*</pre>**@returnThefeaturetypematchingtheid,or<code>null</code>
ifnosuchresourceexists.*/FeatureTypeInfogetFeatureType(Stringid);/***Looksupafeaturetypebyqualifiedname.**<p><tt>ns</tt>maybespecifiedasanamespaceprefixoruri.**<p>Thismethodisconveniencefor:**<pre>*getResourceByName(ns,name,FeatureTypeInfo.class);*</pre>**@paramnsTheprefixoruritowhichthefeaturetypebelongs,maybe<code>null</code>to*specifythedefaultnamespace.*@paramnameThenameofthefeaturetype.*@returnThefeaturetypematchingthename,or<code>null</code>
ifnosuchresourceexists.*/FeatureTypeInfogetFeatureTypeByName(Stringns,Stringname);/***Looksupafeaturetypebyqualifiedname.**<p>Thismethodisconveniencefor:**<pre>*getResourceByName(ns,name,FeatureTypeInfo.class);*</pre>**@paramnsThenamespacetowhichthefeaturetypebelongs,maybe<code>null</code>to*specifythedefaultnamespace.*@paramnameThenameofthefeaturetype.*@returnThefeaturetypematchingthename,or<code>null</code>
ifnosuchresourceexists.*/FeatureTypeInfogetFeatureTypeByName(NamespaceInfons,Stringname);/***Looksupafeaturetypebyqualifiedname.**<p>Thismethodisconveniencefor:**<pre>*getResourceByName(name,FeatureTypeInfo.class);*</pre>**Isolatedworkspacescontentwillbeignoredunlessinthecontextofamatchingvirtual*service.**@paramnameThequalifiedname.*/FeatureTypeInfogetFeatureTypeByName(Namename);/***Looksupafeaturetypebyanunqualifiedname.**<p>Thelookuprulesusedbythismethodareasfollows:**<ul>*<li>Ifafeaturetypeinthedefaultnamespaceisfoundmatchingthespecifiedname,itis*returned.*<li>Ifasinglefeaturetypeamongallnon-defaultnamespacesisfoundmatchingthethe*specifiedname,itisreturned.*</ul>**Careshouldbetakenwhenusingthismethod,useof{@link#getFeatureTypeByName(String,*String)}ispreferred.**@paramnameThenameofthefeaturetype.*@returnThesinglefeaturetypematchingthespecifiedname,or<code>null</code>
ifeither*nonecouldbefoundormultiplewerefound.*/FeatureTypeInfogetFeatureTypeByName(Stringname);/***ALlfeaturetypesinthecatalog.**<p>Thismethodisaconveniencefor:**<pre>*<code>*getResources(FeatureTypeInfo.class);*</code>*</pre>**<p>Theresultinglistshouldnotbeusedtoaddorremoveresourcesfromthecatalog,the*{@link#add(ResourceInfo)}and{@link#remove(ResourceInfo)}methodsareusedforthis*purpose.*/List<FeatureTypeInfo>getFeatureTypes();/***Allfeaturetypesinthespecifiednamespace.**<p>Thismethodisaconveniencefor:<code>*<pre>*getResourcesByNamespace(namespace,FeatureTypeInfo.class);*</pre>*</code>**@paramnamespaceThenamespaceoffeaturetypestoreturn.*@returnAllthefeaturetypesinthespecifiednamespace.*/List<FeatureTypeInfo>getFeatureTypesByNamespace(NamespaceInfonamespace);/**@deprecateduse{@link#getFeatureTypesByDataStore(DataStoreInfo)}*/FeatureTypeInfogetFeatureTypeByStore(DataStoreInfodataStore,Stringname);/***Returnsthefeaturetypewiththespecifiednamewhichispartofthespecifieddatastore.**<p>Thismethodisconveniencefor:**<pre>*returngetResourceByStore(dataStore,name,FeatureTypeInfo.class);*</pre>**@paramdataStoreThedatastore.*@paramnameThefeaturetypename.*@returnThefeaturetype,or<code>null</code>
ifnosuchfeaturetypeexists.*/FeatureTypeInfogetFeatureTypeByDataStore(DataStoreInfodataStore,Stringname);/**@deprecateduse{@link#getFeatureTypesByDataStore(DataStoreInfo)}*/List<FeatureTypeInfo>getFeatureTypesByStore(DataStoreInfostore);/***Allfeaturetypeswhichoriginatefromthespecifieddatastore.**@paramstoreThedatastore.*@returnAlistoffeaturetypeswhichoriginatefromthedatastore.*/List<FeatureTypeInfo>getFeatureTypesByDataStore(DataStoreInfostore);/***Returnsthecoveragematchingaparticularid,or<code>null</code>
ifnosuchcoveragecould*befound.**<p>Thismethodisaconveniencefor:**<pre>*getResource(id,CoverageInfo.class);*</pre>*/CoverageInfogetCoverage(Stringid);/***Looksupacoveragebyqualifiedname.**<p><tt>ns</tt>maybespecifiedasanamespaceprefixoruri.**<p>Thismethodisconveniencefor:**<pre>*getResourceByName(ns,name,CoverageInfo.class);*</pre>**Isolatedworkspacescontentwillbeignoredunlessinthecontextofamatchingvirtual*service.**@paramnsTheprefixoruritowhichthecoveragebelongs,maybe<code>null</code>.*@paramnameThenameofthecoverage.*@returnThecoveragematchingthename,or<code>null</code>
ifnosuchresourceexists.*/CoverageInfogetCoverageByName(Stringns,Stringname);/***Looksupacoveragebyqualifiedname.**<p>Thismethodisconveniencefor:**<pre>*getResourceByName(ns,name,CoverageInfo.class);*</pre>**@paramnsThenamespacetowhichthecoveragebelongs,maybe<code>null</code>.*@paramnameThenameofthecoverage.*@returnThecoveragematchingthename,or<code>null</code>
ifnosuchresourceexists.*/CoverageInfogetCoverageByName(NamespaceInfons,Stringname);/***Looksupacoveragebyqualifiedname.**<p>Thismethodisconveniencefor:**<pre>*getResourceByName(name,CoverageInfo.class);*</pre>**Isolatedworkspacescontentwillbeignoredunlessinthecontextofamatchingvirtual*service.**@paramnameThequalifiedname.*/CoverageInfogetCoverageByName(Namename);/***Looksupacoveragebyanunqualifiedname.**<p>Thelookuprulesusedbythismethodareasfollows:**<ul>*<li>Ifacoverageinthedefaultnamespaceisfoundmatchingthespecifiedname,itis*returned.*<li>Ifasinglecoverageamongallnon-defaultnamespacesisfoundmatchingthethe*specifiedname,itisreturned.*</ul>**Careshouldbetakenwhenusingthismethod,useof{@link#getCoverageByName(String,*String)}ispreferred.**@paramnameThenameofthecoverage.*@returnThesinglecoveragematchingthespecifiedname,or<code>null</code>
ifeithernone*couldbefoundormultiplewerefound.*/CoverageInfogetCoverageByName(Stringname);/***Allcoveragesinthecatalog.**<p>Thismethodisaconveniencefor:**<pre>*<code>*getResources(CoverageInfo.class);*</code>*</pre>**<p>Thismethodshouldnotbeusedtoaddorremovecoveragesfromthecatalog.The{@link*#add(ResourceInfo)}and{@link#remove(ResourceInfo)}methodsareusedforthispurpose.*/List<CoverageInfo>getCoverages();/***Allcoveragesinthespecifiednamespace.**<p>Thismethodisaconveniencefor:<code>*<pre>*getResourcesByNamespace(namespace,CoverageInfo.class);*</pre>*</code>**@paramnamespaceThenamespaceofcoveragestoreturn.*@returnAllthecoveragesinthespecifiednamespace.*/List<CoverageInfo>getCoveragesByNamespace(NamespaceInfonamespace);/***Returnsthecoveragewiththespecifiednamewhichispartofthespecifiedcoveragestore.**<p>Thismethodisconveniencefor:**<pre>*returngetResourceByStore(coverageStore,name,CoverageInfo.class);*</pre>**@paramcoverageStoreThecoveragestore.*@paramnameThecoveragename.*@returnThecoverage,or<code>null</code>
ifnosuchcoverageexists.*/CoverageInfogetCoverageByCoverageStore(CoverageStoreInfocoverageStore,Stringname);/***Allcoverageswhichoriginatefromthespecifiedcoveragestore.**@paramstoreThecoveragestore.*@returnAlistofcoverageswhichoriginatefromthecoveragestore.*/List<CoverageInfo>getCoveragesByCoverageStore(CoverageStoreInfostore);/**Addsanewlayer.*/voidadd(LayerInfolayer);/***Validatealayer.**@paramlayertheLayerInfotobevalidated*@paramisNewaboolean;
iftruethenanexistinglayerwiththesamenamewillcausea*validationerror.*@returnsList<RuntimeException>non-empty
ifvalidationfails*/ValidationResultvalidate(LayerInfolayer,booleanisNew);/**Removesanexistinglayer.*/voidremove(LayerInfolayer);/**Savesalayerwhichhasbeenmodified.*/voidsave(LayerInfolayer);/***Detatchesthelayerfromthecatalog.**<p>Thismethoddoesnotremovetheobjectfromthecatalog,it"unnattaches"theobject*resolvinganyproxies.**<p>Intheeventhespecifiedobjectdoesnotexistinthecatalogititselfshouldbe*returned,thismethodshouldneverreturnnull.*/LayerInfodetach(LayerInfolayer);/**Allcoverageswhicharepartofthespecifiedstore.*/List<CoverageInfo>getCoveragesByStore(CoverageStoreInfostore);/***Returnsthelayermatchingaparticularid,or<code>null</code>
ifnosuchlayercouldbe*found.*/LayerInfogetLayer(Stringid);/***Returnsthelayermatchingaparticularname,or<code>null</code>
ifnosuchlayercouldbe*found.*/LayerInfogetLayerByName(Stringname);/***Returnsthelayermatchingaparticularqualifiedname.**<p>Isolatedworkspacescontentwillbeignoredunlessinthecontextofamatchingvirtual*service.*/LayerInfogetLayerByName(Namename);/***Alllayersinthecatalog.**<p>Theresultinglistshouldnotbeusedtoaddorremovelayerstoorfromthecatalog,the*{@link#add(LayerInfo)}and{@link#remove(LayerInfo)}methodsareusedforthispurpose.*/List<LayerInfo>getLayers();/***Alllayersinthecatalogthatpublishthespecifiedresource.**@paramresourceTheresource.*@returnAlistoflayersfortheresource,oranemptylist.*/List<LayerInfo>getLayers(ResourceInforesource);/***Alllayerswhichreferencethespecifiedstyle.**@paramstyleThestyle.*@returnAlistoflayerswhichreferencethestyle,oranemptylist.*/List<LayerInfo>getLayers(StyleInfostyle);/**Addsanewmap.*/voidadd(MapInfomap);/**Removesanexistingmap.*/voidremove(MapInfomap);/**Savesamapwhichhasbeenmodified.*/voidsave(MapInfomap);/***Detatchesthemapfromthecatalog.**<p>Thismethoddoesnotremovetheobjectfromthecatalog,it"unnattaches"theobject*resolvinganyproxies.**<p>Intheeventhespecifiedobjectdoesnotexistinthecatalogititselfshouldbe*returned,thismethodshouldneverreturnnull.*/MapInfodetach(MapInfomap);/***Allmapsinthecatalog.**<p>Theresultinglistshouldnotbeusedtoaddorremovemapstoorfromthecatalog,the*{@link#add(MapInfo)}and{@link#remove(MapInfo)}methodsareusedforthispurpose.*/List<MapInfo>getMaps();/***Returnsthemapmatchingaparticularid,or<code>null</code>
ifnosuchmapcouldbefound.*/MapInfogetMap(Stringid);/***Returnsthemapmatchingaparticularname,or<code>null</code>
ifnosuchmapcouldbe*found.*/MapInfogetMapByName(Stringname);/**Addsalayergrouptothecatalog.*/voidadd(LayerGroupInfolayerGroup);/***Validatealayergroup.**@paramlayerGrouptheLayerGroupInfotobevalidated*@paramisNewaboolean;
iftruethenanexistinglayergroupwiththesamenamewillcausea*validationerror.*@returnsList<RuntimeException>non-empty
ifvalidationfails*/ValidationResultvalidate(LayerGroupInfolayerGroup,booleanisNew);/**Removesalayergroupfromthecatalog.*/voidremove(LayerGroupInfolayerGroup);/**Saveschangestoamodifiedlayergroup.*/voidsave(LayerGroupInfolayerGroup);/***Detatchesthelayergroupfromthecatalog.**<p>Thismethoddoesnotremovetheobjectfromthecatalog,it"unnattaches"theobject*resolvinganyproxies.**<p>Intheeventhespecifiedobjectdoesnotexistinthecatalogititselfshouldbe*returned,thismethodshouldneverreturnnull.*/LayerGroupInfodetach(LayerGroupInfolayerGroup);/**Alllayergroupsinthecatalog.*/List<LayerGroupInfo>getLayerGroups();/***Alllayergroupsinthespecifiedworkspace.**@paramworkspaceNameThenameoftheworkspacecontaininglayergroups.*/List<LayerGroupInfo>getLayerGroupsByWorkspace(StringworkspaceName);/***Alllayergroupsinthespecifiedworkspace.**@paramworkspaceTheworkspacecontaininglayergroups.*/List<LayerGroupInfo>getLayerGroupsByWorkspace(WorkspaceInfoworkspace);/***Returnsthelayergroupmatchingaparticularid,or<code>null</code>
ifnosuchgroupcould*befound.*/LayerGroupInfogetLayerGroup(Stringid);/***Returnsthegloballayergroupmatchingaparticularname,or<code>null</code>
ifnosuch*stylecouldbefound.**<p>If{@codeprefixedName}containsaworkspacenameprefix(likein{@codetopp:tasmania},*thelayergroupwillbelookeduponthatspecificworkspace({@codetopp}),otherwiseitis*assumedaglobal(withnoworkspace)layergroup.**@paramnamethenameofthelayergroup,mayincludeaworkspacenameprefixornot.*@returnthegloballayergroupmatchingaparticularname,or<code>null</code>
ifnosuch*groupcouldbefound.*/LayerGroupInfogetLayerGroupByName(Stringname);/***Returnsthelayergroupmatchingaparticularnameinthespecifiedworkspace,or<code>null*</code>
ifnosuchlayergroupcouldbefound.**@paramworkspaceNameThenameoftheworkspacecontainingthelayergroup,{@codenull}is*allowed,meaningtolookupforagloballayergroup*@paramnameThenameofthelayergrouptoreturn.*/LayerGroupInfogetLayerGroupByName(StringworkspaceName,Stringname);/***Returnsthelayergroupmatchingaparticularnameinthespecifiedworkspace,or<code>null*</code>
ifnosuchlayergroupcouldbefound.**@paramworkspaceTheworkspacecontainingthelayergroup,{@codenull}isallowed,meaning*tolookupforagloballayergroup.*@paramnameThenameofthelayergrouptoreturn.*/LayerGroupInfogetLayerGroupByName(WorkspaceInfoworkspace,Stringname);/**Addsanewstyle.*/voidadd(StyleInfostyle);/***Validateastyle.**@paramstyletheStyleInfotobevalidated*@paramisNewaboolean;
iftruethenanexistingstylewiththesamenamewillcausea*validationerror.*@returnsList<RuntimeException>non-empty
ifvalidationfails*/ValidationResultvalidate(StyleInfostyle,booleanisNew);/**Removesastyle.*/voidremove(StyleInfostyle);/**Savesastylewhichhasbeenmodified.*/voidsave(StyleInfostyle);/***Detatchesthestylefromthecatalog.**<p>Thismethoddoesnotremovetheobjectfromthecatalog,it"unnattaches"theobject*resolvinganyproxies.**<p>Intheeventhespecifiedobjectdoesnotexistinthecatalogititselfshouldbe*returned,thismethodshouldneverreturnnull.*/StyleInfodetach(StyleInfostyle);/***Returnsthestylematchingaparticularid,or<code>null</code>
ifnosuchstylecouldbe*found.*/StyleInfogetStyle(Stringid);/***Returnsthestylematchingaparticularnameinthespecifiedworkspace,or<code>null</code>*
ifnosuchstylecouldbefound.**@paramworkspaceNameThenameoftheworkspacecontainingthestyle,{@codenull}standsfor*aglobalstyle.*@paramnameThenameofthestyletoreturn.*/StyleInfogetStyleByName(StringworkspaceName,Stringname);/***Returnsthestylematchingaparticularnameinthespecifiedworkspace,or<code>null</code>*
ifnosuchstylecouldbefound.**@paramworkspaceTheworkspacecontainingthestyle,{@codenull}standsforaglobalstyle.*@paramnameThenameofthestyletoreturn.*/StyleInfogetStyleByName(WorkspaceInfoworkspace,Stringname);/***Returnstheglobalstylematchingaparticularname,or<code>null</code>
ifnosuchstyle*couldbefound.**<p>Notethisisaconvenientmethodfor{@link#getStyleByName(WorkspaceInfo,String)}witha*{@codenull}workspaceargument.**@paramnameThenameofthestyletoreturn.*/StyleInfogetStyleByName(Stringname);/***Allstylesinthecatalog.**<p>Theresultinglistshouldnotbeusedtoaddorremovestyles,themethods{@link*#add(StyleInfo)}and{@link#remove(StyleInfo)}areusedforthatpurpose.*/List<StyleInfo>getStyles();/***Allstylesinthespecifiedworkspace.**@paramworkspaceNameThenameoftheworkspacecontainingstyles.*/List<StyleInfo>getStylesByWorkspace(StringworkspaceName);/***Allstylesinthespecifiedworkspace.**@paramworkspaceTheworkspacecontainingstyles.*/List<StyleInfo>getStylesByWorkspace(WorkspaceInfoworkspace);/**Addsanewnamespace.*/voidadd(NamespaceInfonamespace);/***Validateanamespace.**@paramnamespacetheNamespaceInfotobevalidated*@paramisNewaboolean;
iftruethenanexistingnamespacewiththesameprefixwillcausea*validationerror.*@returnsList<RuntimeException>non-empty
ifvalidationfails*/ValidationResultvalidate(NamespaceInfonamespace,booleanisNew);/**Removesanexistingnamespace.*/voidremove(NamespaceInfonamespace);/**Savesanamespacewhichhasbeenmodified.*/voidsave(NamespaceInfonamespace);/***Detatchesthenamespacefromthecatalog.**<p>Thismethoddoesnotremovetheobjectfromthecatalog,it"unnattaches"theobject*resolvinganyproxies.**<p>Intheeventhespecifiedobjectdoesnotexistinthecatalogititselfshouldbe*returned,thismethodshouldneverreturnnull.*/NamespaceInfodetach(NamespaceInfonamespace);/**Returnsthenamespacematchingthespecifiedid.*/NamespaceInfogetNamespace(Stringid);/***Looksupanamespacebyitsprefix.**@seeNamespaceInfo#getPrefix()*@paramprefixThenamespaceprefix,or{@codenull}or{@link#DEFAULT}togetthedefault*namespace*/NamespaceInfogetNamespaceByPrefix(Stringprefix);/***Looksupanamespacebyitsuri.**@seeNamespaceInfo#getURI()*/NamespaceInfogetNamespaceByURI(Stringuri);/**Thedefaultnamespaceofthecatalog.*/NamespaceInfogetDefaultNamespace();/***Setsthedefaultnamespaceofthecatalog.**@paramdefaultNamespaceThedefaultNamespacetoset.*/voidsetDefaultNamespace(NamespaceInfodefaultNamespace);/***Allnamespacesinthecatalog.**<p>Theresultinglistshouldnotbeusedtoaddorremovenamespacesfromthecatalog,the*methods{@link#add(NamespaceInfo)}and{@link#remove(NamespaceInfo)}shouldbeusedfor*thatpurpose.*/List<NamespaceInfo>getNamespaces();/**Addsanewworkspace*/voidadd(WorkspaceInfoworkspace);/***Validateaworkspace.**@paramworkspacetheWorkspaceInfotobevalidated*@paramisNewaboolean;
iftruethenanexistingworkspacewiththesamenamewillcausea*validationerror.*@returnsList<RuntimeException>non-empty
ifvalidationfails*/ValidationResultvalidate(WorkspaceInfoworkspace,booleanisNew);/**Removesanexistingworkspace.*/voidremove(WorkspaceInfoworkspace);/**Saveschangestoanexistingworkspace.*/voidsave(WorkspaceInfoworkspace);/***Detatchestheworkspacefromthecatalog.**<p>Thismethoddoesnotremovetheobjectfromthecatalog,it"unnattaches"theobject*resolvinganyproxies.**<p>Intheeventhespecifiedobjectdoesnotexistinthecatalogititselfshouldbe*returned,thismethodshouldneverreturnnull.*/WorkspaceInfodetach(WorkspaceInfoworkspace);/**Thedefaultworkspaceforthecatalog.*/WorkspaceInfogetDefaultWorkspace();/**Setsthedefaultworkspaceforthecatalog.*/voidsetDefaultWorkspace(WorkspaceInfoworkspace);/***Allworkspacesinthecatalog.**<p>Theresultinglistshouldnotbeusedtoaddorremoveworkspacesfromthecatalog,the*methods{@link#add(WorkspaceInfo)}and{@link#remove(WorkspaceInfo)}shouldbeusedfor*thatpurpose.*/List<WorkspaceInfo>getWorkspaces();/**Returnsaworkspacebyid,or<code>null</code>
ifnosuchworkspaceexists.*/WorkspaceInfogetWorkspace(Stringid);/***Returnsaworkspacebyname,or<code>null</code>
ifnosuchworkspaceexists.**@paramThenameofthestore,or{@codenull}or{@link#DEFAULT}togetthedefault*workspace*/WorkspaceInfogetWorkspaceByName(Stringname);/**cataloglisteners.*/Collection<CatalogListener>getListeners();/**Addsalistenertothecatalog.*/voidaddListener(CatalogListenerlistener);/**Removesalistenerfromthecatalog.*/voidremoveListener(CatalogListenerlistener);/***Firestheeventforanobjectbeingaddedtothecatalog.**<p>Thismethodshouldnotbecalledbyclientcode.Itismeanttobecalledinterallybythe*catalogsubsystem.*/voidfireAdded(CatalogInfoobject);/***Firestheeventforanobjectbeingmodifiedinthecatalog.**<p>Thismethodshouldnotbecalledbyclientcode.Itismeanttobecalledinterallybythe*catalogsubsystem.*/voidfireModified(CatalogInfoobject,List<String>propertyNames,ListoldValues,ListnewValues);/***Firestheeventforanobjectthatwasmodifiedinthecatalog.**<p>Thismethodshouldnotbecalledbyclientcode.Itismeanttobecalledinterallybythe*catalogsubsystem.*/voidfirePostModified(CatalogInfoobject,List<String>propertyNames,ListoldValues,ListnewValues);/***Firestheeventforanobjectbeingremovedfromthecatalog.**<p>Thismethodshouldnotbecalledbyclientcode.Itismeanttobecalledinterallybythe*catalogsubsystem.*/voidfireRemoved(CatalogInfoobject);/***Returnsthepoolorcacheforresources.**<p>Thisobjectisusedtoloadphysicalresourceslikedatastores,featuretypes,styles,*etc...*/ResourcePoolgetResourcePool();/**Setstheresourcepoolreference.*/voidsetResourcePool(ResourcePoolresourcePool);/**Returnstheloaderforresources.*/GeoServerResourceLoadergetResourceLoader();/**Setstheresourceloaderreference.*/voidsetResourceLoader(GeoServerResourceLoaderresourceLoader);/**Disposesthecatalog,freeingupanyresources.*/voiddispose();/***Returnsthenumberofcatalogobjectsoftherequestedtypethatmatchthegivenquery*predicate.**@paramofthetypeofcatalogobjectstoreturn.Superinterfacesofconcretecatalogobjects*areallowed(suchas{@codeStoreInfo.class}and{@codeResourceInfo.class},althoughthe*moregeneric{@codeInfo.class}and{@codeCatalogInfo.class}arenot.*@paramfilterthequerypredicate,use{@linkFilter#INCLUDE}
ifneeded,{@codenull}isnot*accepted.*@returnthetotalnumberofcatalogobjectsoftherequestedtypethatmatchthequery*predicate.*/public<TextendsCatalogInfo>intcount(finalClass<T>of,finalFilterfilter);/***Accesstoasingleconfigurationobjectbythegivenpredicatefilter,fails
ifmorethanone*objectsatisfiesthefiltercriteria.**<p>Generallyusefulforquerybyidornamewherenameisknowntobeunique,eitherglobally*orperworkspace,althoughusageisnotlimitedtothosecases.**<p>Examples:**<pre>*<code>*importstaticorg.geoserver.catalog.Predicates.propertyEquals;*importstaticorg.geoserver.catalog.Predicates.and;*importstaticorg.geoserver.catalog.Predicates.isNull;*...*Catalogcatalog=...*LayerInfolayer=catalog.get(LayerInfo.class,propertyEquals("id","layer1");*WorkspaceInfows=catalog.get(WorkspaceInfo.class,propertyEquals("resource.store.workspace.name",layer.getResource().getStore().getWorkspace().getName);*LayerGroupInfowslg=catalog.get(LayerGroupInfo.class,and(propertyEquals("name","lg1"),propertyEquals("workspace.name","ws1"));*LayerGroupInfogloballg=catalog.get(LayerGroupInfo.class,and(propertyEquals("name","lg1"),isNull("workspace.id"));*</code>*</pre>**@returnthesingleobjectofthegiven{@codetype}thatmatchesthegivenfilter,or{@code*null}
ifnoobjectmatchestheprovidedfilter.*@throwsIllegalArgumentException
ifmorethanoneobjectoftype{@codeT}matchtheprovided*filter.*/<TextendsCatalogInfo>Tget(Class<T>type,Filterfilter)throwsIllegalArgumentException;/***Returnsan{@linkIterator}overthecatalogobjectsoftherequestedtypethatmatchthe*givenquerypredicate,positionedatthespecified{@codeoffset}andlimitedtothenumber*requestednumberofelements.**<p>Thereturnediterator<strong>shall</strong>beclosedonceitisnolongerneeded,to*accountforstreamingimplementationsofthisinterfacetoreleaseanyneededresourcesuch*asdatabaseorremoteserviceconnections.Exampleusage:**<pre>*<code>*Catalogcatalog=...*Filterfilter=...*CloseableIterator<LayerInfo>iterator=catalog.list(LayerInfo.class,filter);*try{*while(iterator.hasNext()){*iterator.next();*
ifneeded,{@codenull}isnot*accepted.*@returnaniteratoroverthepredicatematchingcatalogobjectsthatmustbeclosedonce*consumed*@throwsIllegalArgumentException
if{@codesortOrder!=null}and{code!canSort(of,*sortOrder)}*/public<TextendsCatalogInfo>CloseableIterator<T>list(finalClass<T>of,finalFilterfilter);/***Returnsan{@linkIterator}overthecatalogobjectsoftherequestedtypethatmatchthe*givenquerypredicate,positionedatthespecified{@codeoffset}andlimitedtothenumber*requestednumberofelements.**<p>Throughtheoptional{@codeoffset}and{@codecount}arguments,thismethodallowsfor*pagedqueriesoverthecatalogcontents.Notethatalthoughthere'snoprescribedsortorder,*catalogbackendimplementationsmustprovideanaturalsortorder(eitherbasedonidor*otherwise),inorderforpagedqueriestobeconsistentbetweencallsforthesamepredicate.**<p>Thereturnediterator<strong>shall</strong>beclosedonceitisnolongerneeded,to*accountforstreamingimplementationsofthisinterfacetoreleaseanyneededresourcesuch*asdatabaseorremoteserviceconnections.Exampleusage:**<pre>*<code>*Catalogcatalog=...*Filterfilter=...*CloseableIterator<LayerInfo>iterator=catalog.list(LayerInfo.class,filter);*try{*while(iterator.hasNext()){*iterator.next();*
ifneeded,{@codenull}is*notaccepted.*@paramoffset{@codenull}toreturnaniteratorstartingatthefirstmatchingobject,*otherwiseaninteger{@code>=0}toreturnaniteratorpositionedatthespecified*offset.*@paramcount{@codenull}toreturnanonlimitedinnumberofelementsiterator,aninteger*{@code>=0}otherwisetospecifythemaximumnumberofelementstheiteratorshall*return.*@paramsortByorderforsorting*@returnaniteratoroverthepredicatematchingcatalogobjectsthatmustbeclosedonce*consumed*@throwsIllegalArgumentException
if{@codesortOrder!=null}and[@code!canSort(of,*sortOrder)}*/public<TextendsCatalogInfo>CloseableIterator<T>list(finalClass<T>of,finalFilterfilter,@NullableIntegeroffset,@NullableIntegercount,@NullableSortBysortBy);/**Removesallthelistenerswhichareinstancesofthespecifiedclass*/publicvoidremoveListeners(ClasslistenerClass);/***Returnthecatalogcapabilitiessupportedbythiscatalog.Normallythiswillcorrespondto*thecapabilitiessupportedbytheusedcatalogfacade.**@returncatalogsupportedcapabilities*/defaultCatalogCapabilitiesgetCatalogCapabilities(){//returncatalogdefaultcapabilitiesreturnnewCatalogCapabilities();}}
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(e.getLocalizedMessage());throwe;
if(valinstanceofDate){val=DateUtil.serializeDateTime((Date)val);
if(val!=null){Stringstring=val.toString();Matchermatch=ESCAPE_REQUIRED.matcher(string);
if(match.find()){//mayneedescaping,soescapestring=string.replaceAll("\"","\"\"");//Doublealldoublequotestoescapesb.append("\"");sb.append(string);sb.append("\"");
else{//Noneedforescapingsb.append(string);
ifaresourceispublishedbutit'snamechanged,itshouldstillshowup*aspublished.Itwasn'tbeingthecaseduetocomparingtheresource'snameinsteadofthe*nativeNameagainstthenametheDataStoreprovides*/@TestpublicvoidtestPublishedUnpublishedWithChangedResourceName(){Catalogcatalog=getCatalog();StoreInfocite=catalog.getStoreByName(MockData.CITE_PREFIX,StoreInfo.class);List<FeatureTypeInfo>resources=catalog.getResourcesByStore(cite,FeatureTypeInfo.class);assertTrue(resources.size()>0);finalintnumberOfPublishedResources=resources.size();NewLayerPageProviderprovider=newNewLayerPageProvider();provider.setStoreId(cite.getId());provider.setShowPublished(false);assertEquals(0,provider.size());provider.setShowPublished(true);assertEquals(numberOfPublishedResources,provider.size());FeatureTypeInfotypeInfo=resources.get(0);typeInfo.setName("notTheNativeName");catalog.save(typeInfo);provider=newNewLayerPageProvider();provider.setStoreId(cite.getId());provider.setShowPublished(true);assertEquals(numberOfPublishedResources,provider.size());provider.setShowPublished(false);assertEquals(0,provider.size());}}
ifthesegmentintersectsa"ray"startingfromthegivenoriginand"going"inthe*givendirection.**@paramorigin*@paramdirection*/publicFloatintersectsWithRay(Coordinateorigin,Coordinatedirection){floatlargestDistance=Math.max((float)(A.getPosition().x-origin.x),(float)(B.getPosition().x-origin.x))*2f;GVectorv=newGVector(newdouble[]{origin.x,origin.y});GVectord=newGVector(newdouble[]{direction.x,direction.y});d.scale(largestDistance);v.add(d);LineSegmentraySegment=newLineSegment(newVertex(origin,0),newVertex(newCoordinate(v.getElement(0),v.getElement(1)),0));Coordinateintersection=findIntersection(this,raySegment);Floatvalue=null;
if(intersection!=null){v=newGVector(newdouble[]{origin.x,origin.y});v.sub(newGVector(newdouble[]{intersection.x,intersection.y}));doubledist=v.norm();value=newFloat(dist);
iftheydon'tintersect).**@parama*@paramb*/publicstaticCoordinatefindIntersection(LineSegmenta,LineSegmentb){doublex1=a.A.getPosition().x;doubley1=a.A.getPosition().y;doublex2=a.B.getPosition().x;doubley2=a.B.getPosition().y;doublex3=b.A.getPosition().x;doubley3=b.A.getPosition().y;doublex4=b.B.getPosition().x;doubley4=b.B.getPosition().y;doubledenom=(y4-y3)*(x2-x1)-(x4-x3)*(y2-y1);doubleuaNum=(x4-x3)*(y1-y3)-(y4-y3)*(x1-x3);doubleubNum=(x2-x1)*(y1-y3)-(y2-y1)*(x1-x3);doubleua=uaNum/denom;doubleub=ubNum/denom;
if(clamp(ua,0f,1f)!=ua||clamp(ub,0f,1f)!=ub)returnnull;GVectorv=newGVector(newdouble[]{a.A.getPosition().x,a.A.getPosition().y});GVectord=newGVector(newdouble[]{a.B.getPosition().x,a.B.getPosition().y});d.sub(v);d.scale(ua);d.add(v);returnnewCoordinate(d.getElement(0),d.getElement(1));
if(value>max)returnmax;
if(value<min)returnmin;returnvalue;}}
if(getRuns().isEmpty()){returnnull;
else{for(inti=getRuns().size()-1;i>=0;i--){
if(getRuns().get(i).getStatus()!=Status.COMMITTED&&getRuns().get(i).getStatus()!=Status.ROLLED_BACK){returngetRuns().get(i).getStatus();
if(getRuns().isEmpty()){returnnull;
else{for(inti=getRuns().size()-1;i>=0;i--){
if(getRuns().get(i).getMessage()!=null){returngetRuns().get(i).getMessage();
if(distributedCache==null){//distributedCache=newNullCache<K,V>();
if("catalog".equals(cacheName)){distributedCache=(Cache<K,V>)newHzCatalogCache(cacheName,expirationMinutes,DEFAULT_TTL_UNIT,serializationFactory);
else{distributedCache=newHzCache<K,V>(cacheName,expirationMinutes,DEFAULT_TTL_UNIT);
if(hzMap==null){
if(HzCluster.getInstanceIfAvailable().isPresent()){HzClusterhzCluster=HzCluster.getInstanceIfAvailable().get();HazelcastInstancehazelcastInstance=hzCluster.getHz();hzMap=hazelcastInstance.getMap(mapName);
if(available()){returnhzMap.get(key);
if(value==null){try{value=valueLoader.call();
if(value!=null){put(key,value);
if(available()){Set<K>set=newHashSet<K>();for(Objectk:keys){set.add((K)k);
if(available()){hzMap.putTransient(key,value,ttl,timeunit);
if(available()){hzMap.remove((K)key);
if(available()){for(Objectk:keys){hzMap.remove((K)k);
if(available()){hzMap.clear();
if(available()){returnhzMap;
if(!cluster.isPresent()){returnfalse;
if(hzMap==null&&hzCluster.isRunning()){HazelcastInstancehazelcastInstance=hzCluster.getHz();Catalogcatalog=hzCluster.getRawCatalog();hzMap=hazelcastInstance.getMap(mapName);persister=serializationFactory.createXMLPersister();persister.setCatalog(catalog);
if(available()){byte[]serialForm=hzMap.get(key);
if(serialForm!=null){info=unmarshal(serialForm);
if(value==null){try{value=valueLoader.call();put(key,value);
if(available()){Set<String>set=newHashSet<String>();for(Objectk:keys){set.add((String)k);
if(available()){byte[]serialForm=serialize(value);hzMap.putTransient(key,serialForm,ttl,timeunit);
if(available()){hzMap.remove(String.valueOf(key));
if(available()){for(Objectk:keys){hzMap.remove(String.valueOf(k));
if(available()){hzMap.clear();
if(available()){Function<byte[],Info>function=newFunction<byte[],Info>(){@OverridepublicInfoapply(byte[]input){returnunmarshal(input);
if(CUSTOMIZERS==null){CUSTOMIZERS=newHashMap<String,FeatureCustomizer>();List<FeatureCustomizer>customizers=GeoServerExtensions.extensions(FeatureCustomizer.class);for(FeatureCustomizercustomizer:customizers){CUSTOMIZERS.put(customizer.getTypeName(),customizer);
if(CUSTOMIZERS.containsKey(typeName)){returnCUSTOMIZERS.get(typeName);
if(configFile.getType()==Type.RESOURCE){loadConfig();
else{tempFolder=initFolder(GRDefaults.TEMP_DIR);loggingFolder=initFolder(GRDefaults.LOGGING_DIR);
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.log(Level.SEVERE,"UnabletoconfiguresomeoftheGeorectifyCoverageprocessproperties.",e);
if(lastModified==null||newLastModified!=lastModified){lastModified=newLastModified;loadConfiguration();
if(hasPropertiesFile){Propertiesprops=newProperties();InputStreamfis=null;try{fis=configFile.in();props.load(fis);Iterator<Object>keys=props.keySet().iterator();envVariables=Maps.newHashMap();while(keys.hasNext()){Stringkey=(String)keys.next();
if(key.equalsIgnoreCase(GRKeys.GDAL_CACHEMAX)){//SettingGDAL_CACHE_MAXEnvironmentvariable
ifavailableStringcacheMax=null;try{cacheMax=(String)props.get(GRKeys.GDAL_CACHEMAX);
if(cacheMax!=null){intgdalCacheMaxMemory=Integer.parseInt(cacheMax);//OnlyforvalidationenvVariables.put(GRKeys.GDAL_CACHEMAX,cacheMax);
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,"Unabletoparsethespecifiedpropertyasanumber:"+cacheMax,nfe);
else
if(key.equalsIgnoreCase(GRKeys.GDAL_DATA)||key.equalsIgnoreCase(GRKeys.GDAL_LOGGING_DIR)||key.equalsIgnoreCase(GRKeys.TEMP_DIR)){//ParsingspecifiedfolderpathStringpath=(String)props.get(key);
if(path!=null){finalFiledirectory=newFile(path);
if(directory.exists()&&directory.isDirectory()&&((key.equalsIgnoreCase(GRKeys.GDAL_DATA)&&directory.canRead())||directory.canWrite())){envVariables.put(key,path);
else{
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,"Thespecifiedfolderfor"+key+"variableisn'tvalid,"+"oritdoesn'texistoritisn'tareadabledirectoryoritisa"+"destinationfolderwhichcan'tbewritten:"+path);
else
if(key.equalsIgnoreCase(GRKeys.EXECUTION_TIMEOUT)){//ParsingexecutiontimeoutStringtimeout=null;try{timeout=(String)props.get(GRKeys.EXECUTION_TIMEOUT);
if(timeout!=null){executionTimeout=Long.parseLong(timeout);//Onlyforvalidation
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,"Unabletoparsethespecifiedpropertyasanumber:"+timeout,nfe);
else
if(key.equalsIgnoreCase(GRKeys.GDAL_WARP_PARAMS)||key.equalsIgnoreCase(GRKeys.GDAL_TRANSLATE_PARAMS)){//ParsinggdaloperationscustomoptionparametersStringparam=(String)props.get(key);
if(param!=null){
if(key.equalsIgnoreCase(GRKeys.GDAL_WARP_PARAMS)){gdalWarpingParameters=param.trim();
else{gdalTranslateParameters=param.trim();
else
if(key.endsWith("PATH")){//DealingwithpropertieslikeLD_LIBRARY_PATH,PATH,...Stringparam=(String)props.get(key);
if(param!=null){envVariables.put(key,param);
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,"Unabletoparsetheconfigfile:"+configFile.path(),e);
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,"Unabletoparsetheconfigfile:"+configFile.path(),e);
if(fis!=null){try{fis.close();
if(!tempFolder.exists()){booleancreatedFolder=false;try{createdFolder=tempFolder.mkdir();
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("Unabletocreatethespecifiedfolder:"+folderPath+"\nProceedingwithusingtheSystemtempfolder:"+SYSTEM_TEMP_DIR);
if(!createdFolder){tempFolder=newFile(SYSTEM_TEMP_DIR);
if(!tempFolder.exists()||!tempFolder.canWrite()){thrownewIOException("Unabletowriteonthespecifiedfolder:"+tempFolder.getAbsolutePath());
if(eventinstanceofContextClosedEvent){timer.cancel();
ifthismakesanysense,butthesytaxallowsit,andit'slikenot//specifyinganythingDimensionTrimTyperesult=(DimensionTrimType)parser.parse("lon,EPSG:4326(*,*)");assertEquals("lon",result.getDimension());assertEquals("EPSG:4326",result.getCRS());assertNull(result.getTrimLow());assertNull(result.getTrimHigh());
ifthismakesanysense,butthesytaxallowsit,andit'slikenot//specifyinganythingDimensionTrimTyperesult=(DimensionTrimType)parser.parse("lon,EPSG:4326(10,20)");assertEquals("lon",result.getDimension());assertEquals("EPSG:4326",result.getCRS());assertEquals("10",result.getTrimLow());assertEquals("20",result.getTrimHigh());
ifthismakesanysense,butthesytaxallowsit,andit'slikenot//specifyinganythingDimensionTrimTyperesult=(DimensionTrimType)parser.parse("mydim(\"a,b\",\"c,d\")");assertEquals("mydim",result.getDimension());assertNull(result.getCRS());assertEquals("a,b",result.getTrimLow());assertEquals("c,d",result.getTrimHigh());
if(layer!=null){geoServerTileLayer=newGeoServerTileLayer(layer,defaults,gridsets);
else{LayerGroupInfolayerGroup=catalog.getLayerGroup(input);geoServerTileLayer=newGeoServerTileLayer(layerGroup,defaults,gridsets);
iftheactuallayer/groupinfoisdisabled*/geoServerTileLayer.getInfo().setEnabled(true);returngeoServerTileLayer;
if(!gwc.hasTileLayer(l)){layerIds.add(l.getId());
if(!gwc.hasTileLayer(lg)){layerIds.add(lg.getId());
if(layer!=null){returnnewGeoServerTileLayer(layer,defaults,gridsets);
iftheimagewritingfails.*/publicvoidformatImageOutputStream(RenderedImageimage,OutputStreamoutStream,WMSMapContentmapContent)throwsServiceException,IOException{//gettingawriter
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Gettingawriterfortiff");
if(ioutstream==null)thrownewServiceException("UnabletocreateImageOutputStream.");//tiff
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Writingtiffimage...");
if(LOGGER.isLoggable(Level.FINEST))LOGGER.log(Level.FINEST,"Unabletoproperlycloseoutputstream",e);
if(LOGGER.isLoggable(Level.FINEST))LOGGER.log(Level.FINEST,"Unabletoproperlydisposewriter",e);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Writingtiffimagedone!");
ifFULLTEXTsearchesaresupported.*/booleansupportsPredicate();/***DoestheunderlyingstoresupportPaging**@returntrue
ifPaginginsearchesissupported.*/booleansupportsPaging();}
if(GeoServerExtensions.context!=null){
if(GeoServerExtensions.context.containsBean(name)){Objectconflict=GeoServerExtensions.context.getBean(name);
if(bean!=conflict){GeoServerExtensions.LOGGER.fine("ApplicationContextoverride"+name+":"+conflict);
else{GeoServerExtensions.isSpringContext=false;
if(name==null||bean==null){return;
if(declaredClasses!=null&&declaredClasses.length>0){for(Class<?>clazz:declaredClasses){addToCache(GeoServerExtensions.extensionsCache,clazz,name);
else{Class<?>type=bean.getClass();addToCache(GeoServerExtensions.extensionsCache,type,name);
if(cached!=null){cached=Arrays.copyOf(cached,cached.length+1);cached[cached.length-1]=name;
else{cached=newString[]{name};
if(context!=null){GeoServerExtensionsHelper.init(context);
else{GeoServerExtensionsHelper.clear();
if(isSpringContext!=null){GeoServerExtensionsHelper.setIsSpringContext(isSpringContext);
if(!active)thrownewIllegalStateException();GeoServerExtensionsHelper.singleton(name,bean,declaredClasses);
if(!active)thrownewIllegalStateException();GeoServerExtensionsHelper.property(propertyName,property);
if(!active)thrownewIllegalStateException();GeoServerExtensionsHelper.file(path,file);
ifnonecanbefound*/publicstaticPositionfromString(Stringstr){for(Positionp:values()){
if(p.name.equalsIgnoreCase(str))returnp;
if(p==null||container==null||dim==null||o==null){thrownewServiceException("Badparamsfordecorationsizing.");
switch(p){caseUC:caseUR:caseUL:y=(int)(container.getMinY()+o.y);break;caseCL:caseCC:caseCR:y=(int)(container.getMinY()+container.getMaxY()-dim.height)/2;//ignoreverticaloffsetwhenverticallycenteredbreak;caseLL:caseLC:caseLR:y=(int)(container.getMaxY()-o.y-dim.height);
switch(p){caseUL:caseCL:caseLL:x=(int)(container.getMinX()+o.x);break;caseUC:caseCC:caseLC:x=(int)(container.getMinX()+container.getMaxX()-dim.getWidth())/2;break;caseUR:caseCR:caseLR:x=(int)(container.getMaxX()-o.x-dim.width);
if((dim.width+(2*o.x))>container.width){x=(int)container.getMinX()+o.x;width=container.width-(2*o.x);
if((dim.height+(2*o.y))>container.height){y=(int)container.getMinY()+o.y;height=container.height-(2*o.y);
iftheMapDecorationshouldbeallowedtodeterminesizing*/finalDimensiondimension;/***APointwhosex-andy-coordinatesareinterpretedasthex-andy-offsetswhenrendering*theMapDecoration*/finalPointoffset;/***CreateaBlockwithallneededinformation.**@paramdtheMapDecorationwhichtheBlockwillrender*@parampthePositiontowhichtheBlockisanchored*@paramdimtheDimensionoftheuser-requestedsize,ornull
iftheMapDecorationshould*determineitsownsize*@paramoaPointindicatingtheoffset(see{offset})*/publicBlock(MapDecorationd,Positionp,Dimensiondim,Pointo){decoration=d;position=p;dimension=dim;offset=o;
iftheconfigurationisinvalidorothererrorsoccurwhileparsing*/publicstaticMapDecorationLayoutfromFile(Resourcef,booleantiled)throwsException{MapDecorationLayoutdl=tiled?newMetatiledMapDecorationLayout():newMapDecorationLayout();DocumentconfFile=newSAXBuilder().build(f.file());returnfromDocument(dl,confFile);
iftheconfigurationisinvalidorothererrorsoccurwhileparsing*/publicstaticMapDecorationLayoutfromString(Stringdefinition,booleantiled)throwsException{MapDecorationLayoutdl=tiled?newMetatiledMapDecorationLayout():newMapDecorationLayout();DocumentconfFile=newSAXBuilder().build(newStringReader(definition));returnfromDocument(dl,confFile);
if(value==null){//pickfrombody,useful
ifthecontentislargevalue=option.getValue();
if(decoration==null){LOGGER.log(Level.WARNING,"Unknowndecorationtype:"+e.getAttributeValue("type")+"requested.");continue;
if(pos==null){LOGGER.log(Level.WARNING,"Unknownaffinity:"+e.getAttributeValue("affinity")+"requested.");continue;
if(theSize!=null&&!theSize.equalsIgnoreCase("auto")){String[]sizeArr=theSize.split(",");size=newDimension(Integer.valueOf(sizeArr[0]),Integer.valueOf(sizeArr[1]));
if(theOffset!=null){String[]offsetArr=theOffset.split(",");offset=newPoint(Integer.valueOf(offsetArr[0]),Integer.valueOf(offsetArr[1]));
else{offset=newPoint(0,0);
ifnoneisavailablewiththegivenname*/privatestaticMapDecorationgetDecoration(Stringname){Objecto=GeoServerExtensions.bean(name);
if(oinstanceofMapDecoration){return(MapDecoration)o;
ifthelayoutisnotgoingtopaintanything*/publicbooleanisEmpty(){returnblocks.isEmpty();
if(origInput==null)returnnull;Stringinput=origInput.trim();input=input.replaceFirst("\\A#","");intr,g,b,a;
switch(input.length()){case1:case2:returnnewColor(Integer.valueOf(input,16));case3:r=Integer.valueOf(input.substring(0,1),16);g=Integer.valueOf(input.substring(1,2),16);b=Integer.valueOf(input.substring(2,3),16);returnnewColor(r,g,b);case4:r=Integer.valueOf(input.substring(0,1),16);g=Integer.valueOf(input.substring(1,2),16);b=Integer.valueOf(input.substring(2,3),16);a=Integer.valueOf(input.substring(3,4),16);returnnewColor(r,g,b,a);case6:r=Integer.valueOf(input.substring(0,2),16);g=Integer.valueOf(input.substring(2,4),16);b=Integer.valueOf(input.substring(4,6),16);returnnewColor(r,g,b);case8:r=Integer.valueOf(input.substring(0,2),16);g=Integer.valueOf(input.substring(2,4),16);b=Integer.valueOf(input.substring(4,6),16);a=Integer.valueOf(input.substring(6,8),16);returnnewColor(r,g,b,a);default:thrownewRuntimeException("Couldn'tdecodecolorvalue:"+origInput+"("+input+")");
ifclusteringisenabled.**@authorKevinSmith,OpenGeo*/publicclassHzSessionShareListenerextendsSessionListener{HzClustercluster;HzClustergetCluster(HttpSessionEventevt){//Assumingthatthere'sonlyevertheoneServletorApplicationcontexttoworryabout
if(cluster==null){ServletContextsc=evt.getSession().getServletContext();ApplicationContextac=WebApplicationContextUtils.getRequiredWebApplicationContext(sc);cluster=ac.getBean("hzCluster",HzCluster.class);
if(getCluster(httpSessionEvent).isSessionSharing())super.sessionCreated(httpSessionEvent);
if(getCluster(httpSessionEvent).isSessionSharing())super.sessionDestroyed(httpSessionEvent);}}
if(!p.getValidationErrors().isEmpty()){for(Iteratore=p.getValidationErrors().iterator();e.hasNext();){SAXParseExceptionex=(SAXParseException)e.next();System.out.println(ex.getLineNumber()+","+ex.getColumnNumber()+"-"+ex.toString());
if(response.getStatus()==200){Documentdom=getAsDOM(restPath,200);assertEquals("Attributes",dom.getDocumentElement().getNodeName());assertXpathEvaluatesTo("cite:Buildings","/Attributes/@layer",dom);assertXpathEvaluatesTo("FID","/Attributes/Attribute[1]/name",dom);assertXpathEvaluatesTo("String","/Attributes/Attribute[1]/type",dom);
if(response.getStatus()==200){JSONObjectjson=(JSONObject)getAsJSON(restPath);JSONObjectlayerAttributes=(JSONObject)json.get("Attributes");Stringlayer=(String)layerAttributes.get("@layer");assertEquals(layer,"cite:Buildings");JSONArrayattributes=(JSONArray)layerAttributes.get("Attribute");assertEquals(attributes.toArray().length,3);assertEquals(((JSONObject)attributes.get(0)).get("name"),"FID");assertEquals(((JSONObject)attributes.get(0)).get("type"),"String");
if(response.getStatus()==200){Documentdom=getAsDOM(restPath,200);ByteArrayOutputStreambaos=newByteArrayOutputStream();print(dom,baos);assertTrue(baos.toString().indexOf("<list/>")>0);
if(rule.getService().equals(ServiceAccessRule.ANY)||rule.getService().equalsIgnoreCase(service)){
if(rule.getMethod().equals(ServiceAccessRule.ANY)||rule.getMethod().equalsIgnoreCase(method)){bestMatch=rule;
ifthereisamatchingruleapplyit
if(bestMatch!=null){Set<String>allowedRoles=bestMatch.getRoles();//
iftheruleisnotthekindthatallowseverybodyincheck
ifthecurrent//userisauthenticatedandhasoneoftherequiredroles
if(!allowedRoles.contains(ServiceAccessRule.ANY)&&!allowedRoles.isEmpty()){Authenticationuser=SecurityContextHolder.getContext().getAuthentication();
if(user==null||user.getAuthorities().size()==0)thrownewInsufficientAuthenticationException("Cannotaccess"+service+"."+method+"asanonymous");booleanroleFound=false;for(GrantedAuthorityrole:user.getAuthorities()){
if(allowedRoles.contains(role.getAuthority())){roleFound=true;break;
if(!roleFound){thrownewAccessDeniedException("Cannotaccess"+service+"."+method+"withthecurrentprivileges");
ifthestatementfails*</ul>*/publicstaticvoidrunScript(InputStreamscript,JdbcOperationsjdbc,Loggerlogger)throwsIOException{List<String>lines=org.apache.commons.io.IOUtils.readLines(script);StringBuilderbuf=newStringBuilder();for(Stringsql:lines){sql=sql.trim();
if(sql.isEmpty()){continue;
if(sql.startsWith("--")){continue;
if(sql.endsWith(";")){//oraclehatessemi-colonshere,justuseasaseparator//forknowingwhentoexecuteastmt,butdon'tincludebuf.setLength(buf.length()-2);Stringstmt=buf.toString();booleanskipError=stmt.startsWith("?");
if(skipError){stmt=stmt.replaceAll("^\\?*","");
if(logger!=null)logger.info("Running:"+stmt);try{jdbc.update(stmt);
if(logger!=null){logger.warning(e.getMessage());
if(!skipError){throwe;
if(batchCreate!=null){dao.delete(batchCreate);
if(batchSync!=null){dao.delete(batchSync);
if(config!=null){dao.delete(config);
if(webMapinstanceofRenderedImageMap){setImage(((RenderedImageMap)webMap).getImage());
if(metaTileMapinstanceofRawMap){OutputStreamoutStream=target.getOutputStream();try{((RawMap)metaTileMap).writeTo(outStream);
if(!(metaTileMapinstanceofRenderedImageMap)){thrownewIllegalArgumentException("OnlyRenderedImageMapsaresupportedsofar:"+metaTileMap.getClass().getName());
if(this.tiles.length>1||(this.tiles.length==1&&metaHasGutter())){finalRectangletileDim=this.tiles[tileIdx];tile=createTile(tileDim.x,tileDim.y,tileDim.width,tileDim.height);disposeLater(tile);{finalWMSMapContentmetaTileContext=metaTileMap.getMapContext();//donotcreatetileContextwithmetaTileContext.getLayers()asthelayerlist.//Itisnotneededatthisstageandtheconstructorwouldforcea//MapLayer.getBounds()thatmightfailtileContext=newWMSMapContent();tileContext.setRequest(metaTileContext.getRequest());tileContext.setBgColor(metaTileContext.getBgColor());tileContext.setMapWidth(tileDim.width);tileContext.setMapHeight(tileDim.height);tileContext.setPalette(metaTileContext.getPalette());tileContext.setTransparent(tileContext.isTransparent());long[][]tileIndexes=getTilesGridPositions();BoundingBoxtileBounds=gridSubset.boundsFromIndex(tileIndexes[tileIdx]);ReferencedEnvelopetilebbox=newReferencedEnvelope(metaTileContext.getCoordinateReferenceSystem());tilebbox.init(tileBounds.getMinX(),tileBounds.getMaxX(),tileBounds.getMinY(),tileBounds.getMaxY());tileContext.getViewport().setBounds(tilebbox);
ifthismetatilehasagutter,ornot*/privatebooleanmetaHasGutter(){
if(this.gutter==null){returnfalse;
if(element>0){returntrue;
if(metaTileImageinstanceofPlanarImage){type=1;
else
if(metaTileImageinstanceofBufferedImage){type=2;
else{type=0;
switch(type){case0://doacrop,andthenturnitintoabufferedimagesothatwecanrelease//theimagechainImageWorkerw=newImageWorker(metaTileImage);w.crop(Float.valueOf(x),Float.valueOf(y),Float.valueOf(tileWidth),Float.valueOf(tileHeight));tile=w.getBufferedImage();disposeLater(w.getRenderedImage());break;case1:finalPlanarImagepImage=(PlanarImage)metaTileImage;finalWritableRasterwTile=WritableRaster.createWritableRaster(pImage.getSampleModel().createCompatibleSampleModel(tileWidth,tileHeight),newPoint(x,y));RectanglesourceArea=newRectangle(x,y,tileWidth,tileHeight);sourceArea=sourceArea.intersection(pImage.getBounds());//copyingthedatatoensurewedon'thavesideeffectswhenwecleanthecachepImage.copyData(wTile);
if(wTile.getMinX()!=0||wTile.getMinY()!=0){tile=newBufferedImage(pImage.getColorModel(),(WritableRaster)wTile.createTranslatedChild(0,0),pImage.getColorModel().isAlphaPremultiplied(),null);
else{tile=newBufferedImage(pImage.getColorModel(),wTile,pImage.getColorModel().isAlphaPremultiplied(),null);
if(metaTileMap!=null){metaTileMap.dispose();metaTileMap=null;
if(!info.isEnabled()){doSaveStore(info);
else{try{//trytosee
ifwecanconnectgetCatalog().getResourcePool().clear(info);//donotcallinfo.getWebMapServercauseitendsupcalling//resourcepool.getWebMapServerwiththeunproxiedinstance(oldvalues)//info.getWebMapServer(null).getCapabilities();WebMapServerwebMapServer=getCatalog().getResourcePool().getWebMapServer(info);webMapServer.getCapabilities();doSaveStore(info);
if(message==null&&error.getCause()!=null){message=error.getCause().getMessage();
if(accepted){doReturn(StorePage.class);
if(chain.getPatterns()!=null)returnStringUtils.collectionToCommaDelimitedString(chain.getPatterns());
elsereturn"";
if(StringUtils.hasLength(patternString))chain.setPatterns(Arrays.asList(StringUtils.commaDelimitedListToStringArray(patternString)));
elsechain.getPatterns().clear();
if(gET)chain.getHttpMethods().add(HTTPMethod.GET);
elsechain.getHttpMethods().remove(HTTPMethod.GET);
if(pUT)chain.getHttpMethods().add(HTTPMethod.PUT);
elsechain.getHttpMethods().remove(HTTPMethod.PUT);
if(dELETE)chain.getHttpMethods().add(HTTPMethod.DELETE);
elsechain.getHttpMethods().remove(HTTPMethod.DELETE);
if(pOST)chain.getHttpMethods().add(HTTPMethod.POST);
elsechain.getHttpMethods().remove(HTTPMethod.POST);
if(oPTIONS)chain.getHttpMethods().add(HTTPMethod.OPTIONS);
elsechain.getHttpMethods().remove(HTTPMethod.OPTIONS);
if(tRACE)chain.getHttpMethods().add(HTTPMethod.TRACE);
elsechain.getHttpMethods().remove(HTTPMethod.TRACE);
if(hEAD)chain.getHttpMethods().add(HTTPMethod.HEAD);
elsechain.getHttpMethods().remove(HTTPMethod.HEAD);
if(chain.isMatchHTTPMethod())returnStringUtils.collectionToCommaDelimitedString(chain.getHttpMethods());
elsereturn"*";
if(id==null){returnsuper.getMessage();
if(type!=null||requestedType==null){return;
if(requestedType.equals(Backup.RESTORE_JOB_NAME)){type=LockType.WRITE;
if(type!=null){THREAD_LOCK.remove();locker.unlock();
if(destination.exists()){
if(destination.isDirectory())thrownewIOException("Theprovideddestinationmapstoadirectory:"+destination);
if(!destination.canWrite())thrownewIOException("Theprovideddestinationmapstoanexistingfilethatcannotbedeleted:"+destination);
if(!destination.delete())thrownewIOException("Theprovideddestinationmapstoanexistingfilethatcannotbedeleted:"+destination);
if(transaction!=null){transaction.commit();transaction.close();
if(store!=null){store.dispose();
ifanerroroccursduringrendering*@seeGetMapOutputFormat#produceMap(WMSMapContent)*/publicEncodeHTMLImageMapproduceMap(WMSMapContentmapContent)throwsServiceException,IOException{Assert.notNull(mapContent,"mapContentisnotset");returnnewEncodeHTMLImageMap(mapContent);
ifit'sa{@linkWarningType#NotFound}warning*type*@paramunitThemeasureunitofmeasure*@paramwarningType*/publicstaticvoidaddWarning(StringlayerName,Stringdimension,Objectvalue,Stringunit,WarningTypewarningType){List<String>warnings=WARNINGS.get();
if(warningType==WarningType.NotFound){warnings.add("99Nonearestvaluefoundon"+layerName+":"+dimension);
else{Stringtype=(warningType==WarningType.Nearest)?"Nearestvalue":"Defaultvalue";StringunitSpec=unit==null?"":unit;StringvalueSpec=formatValue(value);warnings.add("99"+type+"used:"+dimension+"="+valueSpec+""+unitSpec+"("+layerName+")");
if(valueinstanceofDate){SimpleDateFormatsdf=newSimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'");sdf.setTimeZone(UTC_TZ);returnsdf.format(value);
else
if(value==null){return"-";
else{//numbersmostly?returnvalue.toString();
if("WMS".equalsIgnoreCase(request.getService())&&warnings!=null&&!warnings.isEmpty()){HttpServletResponsehttpResponse=request.getHttpResponse();for(Stringwarning:warnings){httpResponse.addHeader(HttpHeaders.WARNING,warning);
if(link.toUpperCase().contains("DIRECTDOWNLOAD")&&link.contains("TIME")){links.add(link);
if(iterator!=null){iterator.close();
if(reader!=null){try{reader.dispose();
if(generatedLinks.contains(cswLink)){matches++;
if(link.toUpperCase().contains("DIRECTDOWNLOAD")&&!link.contains("TIME")){downloadLink=link;break;
if(link.toUpperCase().contains("DIRECTDOWNLOAD")&&link.contains("TIME")){break;
if(xpathEngine==null){xpathEngine=XMLUnit.newXpathEngine();Map<String,String>namespaces=newHashMap<String,String>();namespaces.putAll(TEST_NAMESPACES);xpathEngine.setNamespaceContext(newSimpleNamespaceContext(namespaces));
if(certs==null||certs.length==0)returnnull;X509Certificatecert=certs[0];Stringprincipal=(String)principalExtractor.extractPrincipal(cert);
if(principal!=null&&principal.trim().length()==0)principal=null;returnprincipal;
if(path.startsWith("/geoserver/geogig")){super.doFilterInternal(request,response,filterChain);
else{filterChain.doFilter(request,response);
if(this.beanId!=null){
if(beanId==null)returnfalse;
elsereturnthis.beanId.equals(beanId);
if(!nativ.isSafeToIgnore()){thrownewWFSTransactionException("Nativeelement:"+nativ.getVendorId()+"unsupportedbutmarkedas"+"unsafetoignore","InvalidParameterValue");
ifpossible
ifwehadatargetschema////assertEquals(Short.class,sf.getFeatureType().getDescriptor("GRAY_INDEX").getType().getBinding());//assertEquals((short)75,sf.getProperty("GRAY_INDEX"));}}
if(pkg.getName().contains("marlin")){provider="Marlin";
else
if(pkg.getName().contains("sun.dc")){provider="OracleJDK";
else
if(pkg.getName().contains("sun.java2d")){provider="OpenJDK";
else{provider=pkg.getName();
if(config!=null){msg=String.format("Java2Dconfiguredwith%s.\nProvider:%s\nConfiguration:-Dsun.java2d.renderer=%s",engine,provider,config);
else{msg=String.format("Java2Dconfiguredwith%s.\nProvider:%s\n",engine,provider);
if(provider.equals("Marlin")||provider.equals("OracleJDK")||provider.equals("OpenJDK")){assertEquals(msg,statusMessage.get());
else{LOGGER.log(Level.WARNING,"UnknownJavaProvider");
if(noDuplicates){//noduplicatevaluesshouldbeincludedSet<Object>values=DimensionsUtils.getValuesWithoutDuplicates(dimensionInfo.getAttribute(),featureCollection);returnnewArrayList<>(values);
if(style==null){LayerInfoli=catalog.getLayer(layer.getId());
if(layer!=null){style=li.getDefaultStyle();
if(property==LayerGroupEntryProvider.LAYER){EoLayerGroupEntryentry=(EoLayerGroupEntry)itemModel.getObject();returnnewLabel(id,entry.getLayer().prefixedName());
if(property==LayerGroupEntryProvider.TYPE){EoLayerTypetype=(EoLayerType)property.getModel(itemModel).getObject();returnnewLabel(id,(String)eoLayerTypeRenderer.getDisplayValue(type));
if(property==LayerGroupEntryProvider.STYLE){returnstyleLink(id,itemModel);
if(property==LayerGroupEntryProvider.REMOVE){returnremoveLink(id,itemModel);
if(property==LayerGroupEntryProvider.POSITION){returnpositionPanel(id,itemModel);
ifthestyleisthedefaultandthecurrentstylenameEoLayerGroupEntryentry=(EoLayerGroupEntry)itemModel.getObject();StringstyleName=null;booleandefaultStyle=true;
if(entry.getStyle()!=null){styleName=entry.getStyle().getName();defaultStyle=false;
else
if(entry.getLayer()instanceofLayerInfo){LayerInfolayer=(LayerInfo)entry.getLayer();
if(layer.getDefaultStyle()!=null){styleName=layer.getDefaultStyle().getName();
ifthestyleisthedefaultSimpleAjaxLink<String>link=newSimpleAjaxLink<String>(id,newModel(styleName)){@OverridepublicvoidonClick(AjaxRequestTargettarget){finalEoLayerGroupEntryentry=(EoLayerGroupEntry)itemModel.getObject();popupWindow.setInitialHeight(375);popupWindow.setInitialWidth(525);popupWindow.setTitle(newParamResourceModel("chooseStyle",this));popupWindow.setContent(newEoStyleListPanel(popupWindow.getContentId(),entry.getLayerType()){@OverrideprotectedvoidhandleStyle(StyleInfostyle,AjaxRequestTargettarget){entry.setStyle(style);//redrawtarget.add(layerTable);popupWindow.close(target);
if(items.indexOf(entry)==0){tag.put("style","visibility:hidden");
else{tag.put("style","visibility:visible");
if(items.indexOf(entry)==items.size()-1){tag.put("style","visibility:hidden");
else{tag.put("style","visibility:visible");
ifthevisibleattributesdonotincludegeometries)**@authorAndreaAime-TOPP*/classFeatureBoundsFeatureCollectionextendsAbstractFeatureCollection{SimpleFeatureCollectionwrapped;/***BuildsanewBoundsFeatureCollection**@paramwrappedthewrappedfeaturecollection*@paramtargetSchemathetargetschema*/publicFeatureBoundsFeatureCollection(finalSimpleFeatureCollectionwrapped,finalSimpleFeatureTypetargetSchema){super(targetSchema);this.wrapped=wrapped;
if(type.getDescriptor(path)==null)returnnull;returndelegate.getAttribute(path);
ifpossiblereturnnewReferencedEnvelope(delegate.getBounds());
if(defaultGeometry==null)returnnull;return(Geometry)delegate.getAttribute(defaultGeometry.getName());
if(keys.size()==0)setVisible(false);
if(keyName.contains("Color")){returnnewColorPickerPanel(id,valueModel,labelModel,false);
if(descriptor!=null){ClassvalueClass=descriptor.getValueClass();//checkboxforbooleans
if(valueClass.equals(Boolean.class)){returnnewCheckBoxParamPanel(id,valueModel,labelModel);
if(descriptor.getValueClass().isEnum()){List<?extendsSerializable>values=Arrays.stream(descriptor.getValueClass().getEnumConstants()).map(v->(Serializable)v).collect(Collectors.toList());returnnewDropDownChoiceParamPanel(id,valueModel,labelModel,values,false);
if(Serializable.class.isAssignableFrom(descriptor.getValueClass())&&validValues!=null&&!validValues.isEmpty()){List<?extendsSerializable>values=newArrayList<>(validValues);returnnewDropDownChoiceParamPanel(id,valueModel,labelModel,values,false);
elseisatext,withsometargettypeandeventualvalidationTextParamPanelpanel=newTextParamPanel(id,valueModel,labelModel,false);
if(Number.class.isAssignableFrom(valueClass)){panel.getFormComponent().setType(valueClass);Numberminimum=(Number)descriptor.getMinimumValue();
if(minimum!=null){panel.getFormComponent().add(RangeValidator.minimum(minimum.doubleValue()));
if(maximum!=null&&maximuminstanceofSerializable){panel.getFormComponent().add(RangeValidator.maximum(maximum.doubleValue()));
if(property==TYPE){Fragmentf=newFragment(id,"iconFragment",MapPreviewPage.this);f.add(newImage("layerIcon",layer.getIcon()));returnf;
else
if(property==NAME){returnnewLabel(id,property.getModel(itemModel));
else
if(property==TITLE){returnnewLabel(id,property.getModel(itemModel));
else
if(property==COMMON){//openlayerspreviewFragmentf=newFragment(id,"commonLinks",MapPreviewPage.this);finalStringolUrl=layer.getWmsLink()+"&format=application/openlayers";f.add(newExternalLink("ol",olUrl,"OpenLayers"));//kmlpreviewfinalStringkmlUrl=layer.getBaseUrl("wms")+"/kml?layers="+layer.getName();f.add(newExternalLink("kml",kmlUrl,"KML"));//gmlpreview(weactuallywantitonlyforvectorlayers)finalStringgmlUrl=layer.getGmlLink(gmlParamsCache)+getMaxFeatures();ComponentgmlLink=newExternalLink("gml",gmlUrl,"GML");f.add(gmlLink);gmlLink.setVisible(layer.getType()==PreviewLayerType.Vector);returnf;
else
if(property==ALL){returnbuildJSWMSSelect(id,wmsOutputFormats,wfsOutputFormats,layer);
if*maxNumberOfFeaturesForPreview<=0"*/privateStringgetMaxFeatures(){GeoServergeoserver=getGeoServer();WFSInfoservice=geoserver.getService(WFSInfo.class);
if(service.getMaxNumberOfFeaturesForPreview()>0){return"&maxFeatures="+service.getMaxNumberOfFeaturesForPreview();
if(formats!=null){returnformats;
if(!formatName.equals(translatedFormatName)){knownFormat=formatName;break;
if(prev!=null&&comparator.compare(format,prev)==0)it.remove();prev=format;
if(vector){for(inti=0;i<wfsOutputFormats.size();i++){StringwfsOutputFormat=wfsOutputFormats.get(i);Stringlabel=translateFormat("format.wfs.",wfsOutputFormat);//buildoptionwithtextandvalueLabelformat=newLabel(i+"",label);format.add(newAttributeModifier("value",newModel<String>(ResponseUtils.urlEncode(wfsOutputFormat))));wfsFormats.add(format);
if(storeinstanceofJDBCDataStore){createIndex(task,(JDBCDataStore)store);
else{task.addMessage(Level.WARNING,"Cannotcreateindexonnondatabasetarget.Notabigdeal.");
if(error!=null){thrownewException("Errorcreatingindex,SQLwas:"+sql,error);
if(value.matches("http://www.opengis.net/def/interpolation/OGC/1/[^,:]*")){//singlevaluethenInterpolationMethodTypemethod=Wcs20Factory.eINSTANCE.createInterpolationMethodType();method.setInterpolationMethod(value);result.setInterpolationMethod(method);returnresult;
if(value.matches(".*,\\s*,.*")){//twoconsequentcommasthrowInvalidSyntaxException();
else
if(value.startsWith(",")||value.endsWith(",")){throwInvalidSyntaxException();
if(!component.matches(".*:http://www.opengis.net/def/interpolation/OGC/1/.*")){//notaregularaxis:interpolationstructurethrowInvalidSyntaxException();
else
if(component.matches(".*:\\s*:.*")){//twoconsequentcolumnsthrowInvalidSyntaxException();
if(ldapConfig.isUseTLS()){//TLSdoesnotplaynicelywithpooledconnectionsldapContext.setPooled(false);DefaultTlsDirContextAuthenticationStrategytls=newDefaultTlsDirContextAuthenticationStrategy();tls.setHostnameVerifier(newHostnameVerifier(){@Overridepublicbooleanverify(Stringhostname,SSLSessionsession){returntrue;
ifnotnull.**@paramctx*@paramtemplate*/publicstaticSpringSecurityLdapTemplategetLdapTemplateInContext(finalDirContextctx,finalSpringSecurityLdapTemplatetemplate){SpringSecurityLdapTemplateauthTemplate;
if(ctx==null){authTemplate=template;((AbstractContextSource)authTemplate.getContextSource()).setAnonymousReadOnly(true);
else{//
ifwehavetheauthenticatedcontextwebuildanewLdapTemplate//usingitauthTemplate=newSpringSecurityLdapTemplate(newContextSource(){@OverridepublicDirContextgetReadOnlyContext()throwsNamingException{returnctx;
if(con!=null)con.close();
if(ps!=null)ps.close();
if(securityManager.listUserGroupServices().contains(serviceName)){GeoServerUserGroupServiceservice=securityManager.loadUserGroupService(serviceName);
if(service.canCreateStore()){GeoServerUserGroupStorestore=service.createStore();store.clear();store.store();
if(securityManager.listRoleServices().contains(serviceName)){
if(securityManager.getActiveRoleService().getName().equals(serviceName)){GeoServerRoleServiceroleService=securityManager.loadRoleService("default");securityManager.setActiveRoleService(roleService);
if(service.canCreateStore()){GeoServerRoleStorestore=service.createStore();store.clear();store.store();
if("h2".equals(fixtureId)){config.setPropertyFileNameDDL("rolesddl.h2.xml");
else
if("postgis".equals(fixtureId)){config.setPropertyFileNameDDL("rolesddl.postgis.xml");
else
if("mysql".equals(fixtureId)){config.setPropertyFileNameDDL("rolesddl.mysql.xml");
else{config.setPropertyFileNameDDL(JDBCRoleService.DEFAULT_DDL_FILE);
if("mysql".equals(fixtureId)){config.setPropertyFileNameDDL("usersddl.mysql.xml");
else{config.setPropertyFileNameDDL(JDBCUserGroupService.DEFAULT_DDL_FILE);
if(key.equals(value)){return;
if(!condition){throwexception(failMessage,failMessageArguments);
if(!queryString.isPresent()){returnparameters;
if(parameterParts.length<2){continue;
if(values==null){parameters.put(name,newString[]{value});
else{values=Arrays.copyOf(values,value.length()+1);values[value.length()]=value;parameters.put(name,values);
if(map!=null){for(Map.Entryentry:map.entrySet()){
if(entry.getKey()instanceofString&&((String)entry.getKey()).toLowerCase().equals(key.toLowerCase())){returnentry;
ifpossible.Avalueof"1"indicates*thatonelinkingelementlocatorattribute(href)Xlink*willbetraversedandthereferencedelementreturned
if*possible,butnestedpropertyXLinklinkingelementlocator*attribute(href)XLinksinthereturnedelementarenot*traversed.Avalueof"*"indicatesthatallnestedproperty*XLinklinkingelementlocatorattribute(href)XLinkswillbe*traversedandthereferencedelementsreturned
ifpossible.*Therangeofvalidvaluesforthisattributeconsistsof*positiveintegersplus"*".*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:attribute&gt;*&lt;xsd:attributename="traverseXlinkExpiry"*type="xsd:positiveInteger"use="optional"&gt;*&lt;xsd:annotation&gt;*&lt;xsd:documentation&gt;*ThetraverseXlinkExpiryattributevalueisspecifiedin*minutesItindicateshowlongaWebFeatureServiceshould*waittoreceivearesponsetoanestedGetGmlObjectrequest.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:attribute&gt;*&lt;/xsd:extension&gt;*&lt;/xsd:simpleContent&gt;*&lt;/xsd:complexType&gt;*&lt;/xsd:element&gt;**</code>*</pre>**@generated*/publicclassXlinkPropertyNameBindingextendsAbstractComplexBinding{WfsFactoryfactory;publicXlinkPropertyNameBinding(WfsFactoryfactory){this.factory=factory;
if(node.hasAttribute("traverseXlinkExpiry")){property.setTraverseXlinkExpiry((BigInteger)node.getAttributeValue("traverseXlinkExpiry"));
if(binding==null){return"-";
else
if(BINDINGS.contains(binding)){returnnewParamResourceModel("AttributeType."+binding.getSimpleName(),null).getString();
else{returnbinding.getSimpleName();
if//getFinalURLiscalledmanytimesbooleanlayersAddedToDelegate=false;publicSecuredGetMapRequest(GetMapRequestdelegate){this.delegate=delegate;
if(styleName!=null){styles.add(styleName);
else{styles.add("");
if(style!=null&&style.getName()!=null){styles.add(style.getName());
else{styles.add("");
if(encodedFilter!=null){delegate.setProperty("CQL_FILTER",encodedFilter);
if(layerinstanceofSecuredWMSLayer){SecuredWMSLayersecured=(SecuredWMSLayer)layer;finalWrapperPolicypolicy=secured.getPolicy();
if(policy.getResponse()==org.geoserver.security.Response.CHALLENGE){SecureCatalogImpl.unauthorizedAccess(layer.getName());
if(policy.getLimits()instanceofWMSAccessLimits){WMSAccessLimitslimits=(WMSAccessLimits)policy.getLimits();layerFilters.add(limits.getReadFilter());layerFiltersFound|=limits.getReadFilter()!=null;
if(limits.getRasterFilter()!=null){/**Toimplementthiswe'dhavetochangethecodein*SecuredWebMapServer.issueRequest(GetMapRequest)toparsetheimage,*applyacrop,andencodeitback.*Also,
iftherearemultiplelayersintherequestwe'dhavetogroup*thembysamerasterfilter,issueseparaterequestinaformatthat*supportstransparency,crop,mergethemback*/LOGGER.severe("Sorry,rasterfiltersforcascadedwmslayers"+"havenotbeenimplementedyet");
if(!layersAddedToDelegate){//addintotherequestdelegate.addLayer(layer,styles.get(i));
if(layerFiltersFound){StringBuildersb=newStringBuilder();for(Filterfilter:layerFilters){
if(filter!=null){sb.append(CQL.toCQL(filter));
ifnonexists.*/SettingsInfogetSettings(WorkspaceInfoworkspace);/**Addsasettingsconfigurationforthespecifiedworkspace.*/voidadd(SettingsInfosettings);/**Savesthesettingsconfigurationforthespecifiedworkspace.*/voidsave(SettingsInfosettings);/**Removesthesettingsconfigurationforthespecifiedworkspace.*/voidremove(SettingsInfosettings);/**Theloggingconfiguration.*/LoggingInfogetLogging();/**Setsloggingconfiguration.*/voidsetLogging(LoggingInfologging);/**Savestheloggingconfiguration.*/voidsave(LoggingInfologging);/**Addsaservicetotheconfiguration.*/voidadd(ServiceInfoservice);/**Removesaservicefromtheconfiguration.*/voidremove(ServiceInfoservice);/**Savesaservicethathasbeenmodified.*/voidsave(ServiceInfoservice);/**GeoServerservices.*/Collection<?extendsServiceInfo>getServices();/**GeoServerservicesspecifictothespecifiedworkspace.*/Collection<?extendsServiceInfo>getServices(WorkspaceInfoworkspace);/***GeoServerglobalservicefilteredbyclass.**@paramclazzTheclassoftheservicetoreturn.*/<TextendsServiceInfo>TgetService(Class<T>clazz);/***GeoServerservicespecifictothespecifiedworkspaceandfilteredbyclass.**@paramworkspaceTheworkspacetheserviceisspecificto.*@paramclazzTheclassoftheservicetoreturn.*/<TextendsServiceInfo>TgetService(WorkspaceInfoworkspace,Class<T>clazz);/***Looksupaservicebyid.**@paramidTheidoftheservice.*@paramclazzThetypeoftheservice.*@returnTheservicewiththespecifiedid,or<code>null</code>
ifnosuchservicecoudbe*found.*/<TextendsServiceInfo>TgetService(Stringid,Class<T>clazz);/***Looksupaservicebyname.**@paramnameThenameoftheservice.*@paramclazzThetypeoftheservice.*@returnTheservicewiththespecifiednameor<code>null</code>
ifnosuchservicecouldbe*found.*/<TextendsServiceInfo>TgetServiceByName(Stringname,Class<T>clazz);/***Looksupaservicebyname,specifictothespecifiedworkspace.**@paramnameThenameoftheservice.*@paramworkspaceTheworkspacetheserviceisspecificto.*@paramclazzThetypeoftheservice.*@returnTheservicewiththespecifiednameor<code>null</code>
ifnosuchservicecouldbe*found.*/<TextendsServiceInfo>TgetServiceByName(Stringname,WorkspaceInfoworkspace,Class<T>clazz);/**Disposestheconfiguration.*/voiddispose();}
ifanystyleinthesetofstylesofa*layerhasthegivenid.**<p>**<p>Iftheevaluatedobjectpropertyvalueandtheargumentvaluearenotofthesametype,*thereturned{@codePredicate}willusethe{@linkConverters}frameworktotrytomatchthe*twopropertytypesbeforeperformingan{@codeObject.equals}check.**<p>Examples:**<ul>*<li>Simple:{@codeequal("id","myId");}*<li>Nested:{@codeequal("resource.metadata.someKey",Boolean.TRUE);}*<li>AnyCollection(forList,Array,andSetproperties):{@codeequal("styles.name",*"point");}:anystyleinthestylespropertywhosenameis"point"*<li>Indexed(forListandArrayproperties):{@codeequal("resource.attributes[1]",*myAttribute);}*<li>Combined:{@codeequal("resource.attributes[1].minOccurs",Integer.valueOf(1));}*</ul>**@parampropertythequalifiedpropertynameofthepredicate'sinputobjecttoevaluate*@paramexpectedthevaluetochecktheinputobject'spropertyagainst*@seePropertyIsEqualTo*/publicstaticFilterequal(finalStringproperty,finalObjectexpected){returnequal(property,expected,MatchAction.ANY);
if(isSpecial(chr)){tmp.append("\\"+chr);
else{tmp.append(chr);
ifacharacterisspecialtotheregexsystem.**@paramchrthecharactertotest*@returnisthecharacteraspecialcharacter.*/privatestaticbooleanisSpecial(finalcharchr){return((chr=='.')||(chr=='?')||(chr=='*')||(chr=='^')||(chr=='$')||(chr=='+')||(chr=='[')||(chr==']')||(chr=='(')||(chr==')')||(chr=='|')||(chr=='\\')||(chr=='&')||(chr=='}')||(chr=='{'));
ifeachofitscomponentsevaluatesto*{@codetrue}.**<p>Thecomponentsareevaluatedinorder,andevaluationwillbe"short-circuited"assoonas*afalsepredicateisfound.*/publicstaticFilterand(Filterop1,Filterop2){List<Filter>children=newArrayList<Filter>();
if(op1instanceofAnd){children.addAll(((And)op1).getChildren());
else{children.add(op1);
if(op2instanceofAnd){children.addAll(((And)op2).getChildren());
else{children.add(op2);
ifeachofitscomponentsevaluatesto*{@codetrue}.**<p>Thecomponentsareevaluatedinorder,andevaluationwillbe"short-circuited"assoonas*afalsepredicateisfound.*/publicstaticFilterand(Filter...operands){List<Filter>anded=Lists.newArrayList(operands);returnfactory.and(anded);
ifeachofitscomponentsevaluatesto*{@codetrue}.**<p>Thecomponentsareevaluatedinorder,andevaluationwillbe"short-circuited"assoonas*afalsepredicateisfound.*/publicstaticFilterand(List<Filter>operands){
if(operands.size()==0){returnFilter.INCLUDE;
else
if(operands.size()==1){returnoperands.get(0);
else{returnfactory.and(operands);
ifeitherofitscomponentsevaluatesto*{@codetrue}.**<p>Thecomponentsareevaluatedinorder,andevaluationwillbe"short-circuited"assoonas*atruepredicateisfound.*/publicstaticFilteror(Filterop1,Filterop2){List<Filter>children=newArrayList<Filter>();
if(op1instanceofOr){children.addAll(((Or)op1).getChildren());
else{children.add(op1);
if(op2instanceofOr){children.addAll(((Or)op2).getChildren());
else{children.add(op2);
if(operands.size()==0){returnFilter.EXCLUDE;
else
if(operands.size()==1){returnoperands.get(0);
else{returnfactory.or(operands);
if(link!=null){writer.writeAttribute("xmlns:att",link);
if(creator!=null){writer.writeAttribute("creator",creator);
if(link!=null&&creator!=null){writer.writeStartElement("link");writer.writeAttribute("href",link);writer.writeStartElement("text");writer.writeCharacters(creator);writer.writeEndElement();writer.writeEndElement();
if(ginstanceofMultiLineString){MultiLineStringmls=(MultiLineString)g;intnumGeometries=mls.getNumGeometries();writer.writeStartElement("trk");
if(writeExtendedData){writeData(writer,f);
else
if(ginstanceofLineString){writeRte(writer,(LineString)g,f);
else
if(ginstanceofMultiPoint){MultiPointmpt=(MultiPoint)g;intnumGeometries=mpt.getNumGeometries();for(inti=0;i<numGeometries;i++){Pointpt=(Point)mpt.getGeometryN(i);writeWpt(writer,pt,f);
else
if(ginstanceofPoint){writeWpt(writer,(Point)g,f);
else{thrownewIllegalArgumentException("Unsupportedgeometrytype:"+g.getClass().getSimpleName());
if(!Double.isNaN(z)){writer.writeAttribute("ele",format.format(z));
if(writeExtendedData){writeData(writer,f);
if(!Double.isNaN(c.z)){writer.writeAttribute("ele",format.format(c.z));
if(writeExtendedData){writeData(writer,f);
if(!(p.getValue()instanceofGeometry)&&p.getValue()!=null){writer.writeStartElement("att:"+name.getLocalPart());writer.writeCharacters(p.getValue().toString());writer.writeEndElement();
if(System.getProperty("testDatabase")!=null){//whenrunonline,gml:idisprefixedwithtablenameID_PREFIX="MAPPEDFEATURENOID.";
if("ROLE_AUTHENTICATED".equals(role.getAuthority())){assertEquals(1,role.getProperties().size());assertEquals("4711",role.getProperties().get("employee"));
else
if("ROLE_WMS".equals(role.getAuthority())){assertEquals(1,role.getProperties().size());assertEquals("10102020",role.getProperties().get("envelope"));
else{assertEquals(0,role.getProperties().size());
if(role_auth.getAuthority().equals(role.getAuthority())){assertEquals(2,role.getProperties().size());assertEquals(role.getProperties().getProperty("employee"),"");assertEquals(role.getProperties().getProperty("bbox"),"lookupAtRuntime");
else{assertEquals(0,role.getProperties().size());
ifpropertiesareloadedtoofor(GeoServerUseruser:userGroupService.getUsers()){
if(user2.getUsername().equals(user.getUsername())){assertEquals(2,user.getProperties().size());assertEquals(user.getProperties().getProperty("mail"),"user2@gmx.com");assertEquals(user.getProperties().getProperty("tel"),"12-34-38");
else{assertEquals(0,user.getProperties().size());
ifpropertiesareloadedtoofor(GeoServerUseruser:userGroupService.getUsersForGroup(group1)){
if(user2.getUsername().equals(user.getUsername())){assertEquals(2,user.getProperties().size());assertEquals(user.getProperties().getProperty("mail"),"user2@gmx.com");assertEquals(user.getProperties().getProperty("tel"),"12-34-38");
else{assertEquals(0,user.getProperties().size());
ifpropertiesareloadedtoofor(GeoServerUseruser:userGroupService.getUsersNotHavingProperty("unknown")){
if(user2.getUsername().equals(user.getUsername())){assertEquals(2,user.getProperties().size());assertEquals(user.getProperties().getProperty("mail"),"user2@gmx.com");assertEquals(user.getProperties().getProperty("tel"),"12-34-38");
else{assertEquals(0,user.getProperties().size());
if(user2!=null){userGroupStore.removeUser(user2);
if(disabledGroup!=null){userGroupStore.removeGroup(disabledGroup);
if(!"file".equals(url.getProtocol())){//meansadependencyisusingthisdirectoryviaajarfile,copyoutmanuallyFiledataDir=File.createTempFile("data","live",newFile("./target"));dataDir.delete();dataDir.mkdirs();//TODO:insteadofharcodingfiles,dynamicallyreadallsubentriesfromthejar//andcopythemoutFileUtils.copyURLToFile(AbstractSecurityServiceTest.class.getResource("/data_dir/default/dummy.txt"),newFile(dataDir,"dummy.txt"));returndataDir;
ifthetestisaJDBCtestAlltestarebasedonthefactthatlockingappearsat*rowlevel.ThisisnottrueforJDBCdatabases-Lockingmaybebasedonblocks-Sinceonly*afewrecordsareinthetable,thewholetablemybelocked.(lockescalation)**<p>Usethismethodtoavoidtoaggressivechecks*/protectedbooleanisJDBCTest(){returnfalse;
if(this.oldValue==null){props.remove(name);
else{props.setProperty(name,oldValue);
if(position!=null&&transform!=null){transform=transform.replace("$2","{PARAMETER}");
if(position!=null&&transform!=null){ruleBuilder.withTransform(transform.replace("{PARAMETER}","$2"));
else{ruleBuilder.withTransform(transform);
if(config.isEnabled()&&config.getJndiName().isPresent()){try{returnGeoTools.getInitialContext(GeoTools.getDefaultHints());
else{//Don'tbothertryingtogetaJNDIcontext
ifJNDIlookupisn'tneeded.returnnull;
if(dataSource==null){
if(!config.isEnabled()){//hack,createastubdatabasesothatotherbeansinthecontextlikethe//transactionmanagercanfunction,despitethefactthatthepluginis//disableddataSource=createDataSourceStub();
else{dataSource=lookupOrCreateDataSource();
if(ds==null){jndi=false;ds=createDataSource();
if(jndi){LOGGER.severe("ErrorconnectingtoJDBCdatabase.VerifythesettingsofyourJNDIdatasourceandthatthedatabaseisavailable.");
else{LOGGER.severe("ErrorconnectingtoJDBCdatabase.Verifythesettingsinyourpropertiesfileandthatthedatabaseisavailable.");
if(jndiCtx==null)returnOptional.absent();
if(name.isPresent()){try{Optional<DataSource>ds=Optional.of((DataSource)jndiCtx.lookup(name.get()));
if(LOGGER.isLoggable(Level.INFO)){LOGGER.log(Level.INFO,"JDBCLoaderusingJNDIDataSource{0}",name.get());
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,"CouldnotresolveJNDIname"+name.get()+"forJDBCLoaderDatabase",ex);
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("NoJNDInamegivenforJDBCLoaderDB.");
if(testOnBorrow){StringvalidateQuery=get(config,"pool.validationQuery",String.class,true).get();dataSource.setTestOnBorrow(true);dataSource.setValidationQuery(validateQuery);
if(LOGGER.isLoggable(Level.INFO)){LOGGER.log(Level.INFO,"JDBCConfigusingJDBCDataSource{0}",config.getJdbcUrl());
if(raw==null&&mandatory){thrownewIllegalStateException(key+"propertyismandatorybutnotfound");
if(dataSource!=null&&dataSourceinstanceofBasicDataSource){((BasicDataSource)dataSource).close();
if(adminService.getRuleByPriority(priority)!=null){adminService.shift(priority,1);
if(rule.getLimits()!=null){adminService.setLimits(id,rule.getLimits().toRuleLimits(null));
if(rule.getLayerDetails()!=null){adminService.setDetails(id,rule.getLayerDetails().toLayerDetails(null));
if(rule.getPriority()!=null){ShortRulepriorityRule=adminService.getRuleByPriority(rule.getPriority().longValue());
if(priorityRule!=null&&priorityRule.getId()!=id){adminService.shift(rule.getPriority().longValue(),1);
if(rule.getLimits()!=null){adminService.setLimits(id,rule.getLimits().toRuleLimits(theRule.getRuleLimits()));
if(rule.getLayerDetails()!=null){adminService.setDetails(id,rule.getLayerDetails().toLayerDetails(theRule.getLayerDetails()));
if(rule.getPriority()!=null){ShortRulepriorityRule=adminService.getRuleByPriority(rule.getPriority().longValue());
if(priorityRule!=null&&priorityRule.getId()!=id){adminService.shift(rule.getPriority().longValue(),1);
if(rule.getLimits()!=null){adminService.setLimits(id,rule.getLimits().toRuleLimits(null));
else{adminService.setLimits(id,null);
if(rule.getLayerDetails()!=null){adminService.setDetails(id,rule.getLayerDetails().toLayerDetails(null));
else{adminService.setDetails(id,null);
if(id!=null&&name!=null){thrownewIllegalArgumentException("Idandnamecan'tbebothdefined(id:"+id+"name:"+name+")");
if(id!=null){filter.setId(id);
if(includeDefault!=null){filter.setIncludeDefault(includeDefault);
else
if(name!=null){filter.setName(name);
if(includeDefault!=null){filter.setIncludeDefault(includeDefault);
else{
if(includeDefault!=null&&includeDefault){filter.setType(SpecialFilterType.DEFAULT);
else{filter.setType(SpecialFilterType.ANY);
if(name!=null){filter.setText(name);
if(includeDefault!=null){filter.setIncludeDefault(includeDefault);
else{
if(includeDefault!=null&&includeDefault){filter.setType(SpecialFilterType.DEFAULT);
else{filter.setType(SpecialFilterType.ANY);
if(rules.isEmpty()){returnResponseEntity.ok(null);
ifapropertyexists.*/privatevoidcheckPropertyExists(JSONArrayproperties,StringexpectedName){booleanfound=false;for(Objectjson:properties){assertThat(json,instanceOf(JSONObject.class));JSONObjectjsonObject=(JSONObject)json;assertThat(jsonObject.get("@name"),notNullValue());
if(jsonObject.get("@name").equals(expectedName)){assertThat(jsonObject.get("@value"),notNullValue());found=true;
ifnecessary.**@returnfeatures*/protectedSimpleFeatureCollectiongetFeatures(SimpleFeatureCollectioncontent){returncontent;
if(MediaType.APPLICATION_JSON.includes(mediaType)||MediaTypeExtensions.TEXT_JSON.includes(mediaType)){writeGeoJsonl(content,outputMessage);
else
if(MediaType.APPLICATION_XML.includes(mediaType)){writeGML(content,outputMessage);
if(layerinstanceofFeatureLayer){//doweuseaKMLplacemarkdump,oragroundoverlay?
if(useVectorOutput(context)){List<Feature>features=newSequenceList<Feature>(newFeatureSequenceFactory(context,(FeatureLayer)layer));context.addFeatures(folder,features);
else{addGroundOverlay(folder,layer);//incaseofgroundoverlayswemightstillwanttooutputplacemarks//forthe
if(context.isPlacemarkForced()){addFeatureCentroids(layer,folder);
else{addGroundOverlay(folder,layer);
if(reprojectBBox){try{box=box.transform(DefaultGeographicCRS.WGS84,true);
if(context.isKmz()){//embedthegroundoverlayinthekmzarchiveintmapLayerOrder=mapContent.layers().indexOf(layer);Stringhref="images/layers_"+mapLayerOrder+".png";context.addKmzGroundOverlay(href,layer);returnhref;
else{//refertoaGetMaprequestreturnWMSRequests.getGetMapUrl(mapContent.getRequest(),layer,0,mapContent.getRenderingArea(),newString[]{"format","image/png","transparent","true"});
if("refresh".equalsIgnoreCase(mode)){//calculatekmscoretodetermine
ifweshouldwriteasvectors//orpre-renderintkmscore=context.getKmScore();
if(kmscore==100){returntrue;//vectorKML
if(kmscore==0){returnfalse;//rasterKMZ
if(currentSize>magic){returnfalse;//returnraster
else{returntrue;//returnvector
else{//downloadorsuperoverlayreturntrue;
if(sfStore!=null){CascadeDeleteVisitorremover=newCascadeDeleteVisitor(getCatalog());remover.visit(sfStore);
if(datastoresinstanceofJSONArray){assertEquals(catalog.getDataStoresByWorkspace("sf").size(),((JSONArray)datastores).size());
else{assertEquals(1,catalog.getDataStoresByWorkspace("sf").size());
if(ft.getStore().getName().equals("sf")){fail();
if(orig.get(i)==inNoData){assertEquals(outNoData,translated.get(i),1e-6);noDataCount+=1;
iftherequestisget*/protectedbooleanget;protectedStringrequest;protectedStringversion;privateStringrequestCharset;/***Createsthenewrequestwiththegivenoperationname**@paramrequestnameoftherequest,(Example,GetCapabiliites)*/protectedWMSRequest(finalStringrequest){setRequest(request);
ifclientcandoHTTPcachingandthensetthecorrespondingresponse*headers.**@return{@codetrue}
iftheoriginatingHTTPrequestusedHTTPGETmethod,{@codefalse}*otherwise*/publicbooleanisGet(){returnget;
if(target!=null){
if(allowEnvParametrization&&gsEnvironment!=null&&GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){target.setName((String)gsEnvironment.resolveValue(name));
if(map==null)returnnull;Authenticationresult=null;StringcacheKey=null;for(Entry<String,byte[]>entry:map.entrySet()){Authenticationauth=getCache().deserializeAuthentication(entry.getValue());Objecto=auth.getPrincipal();
if(oinstanceofUserDetails){
if(user.equals(((UserDetails)o).getUsername())){result=auth;cacheKey=entry.getKey();break;
if(oinstanceofPrincipal){
if(user.equals(((Principal)o).getName())){result=auth;cacheKey=entry.getKey();break;
if(oinstanceofString){
if(user.equals(((String)o))){result=auth;cacheKey=entry.getKey();break;
if(result!=null){Integer[]seconds=getCache().getExpireTimes(filterName,cacheKey);
if(idleTime==null)assertEquals(TestingAuthenticationCache.DEFAULT_IDLE_SECS,seconds[0]);
elseassertEquals(idleTime,seconds[0]);
if(liveTime==null)assertEquals(TestingAuthenticationCache.DEFAULT_LIVE_SECS,seconds[1]);
elseassertEquals(liveTime,seconds[1]);
if(true){request.addUserRole(derivedRole);
if(false){request.addUserRole(rootRole);
if(true){request.addUserRole(derivedRole);
if(false){request.addUserRole(rootRole);
if(rs.equals(PreAuthenticatedUserNameRoleSource.Header)){request.addHeader("roles",derivedRole+";"+rootRole);
if(rs.equals(PreAuthenticatedUserNameRoleSource.Header)){continue;//nocache
if(rs.equals(PreAuthenticatedUserNameRoleSource.Header)){continue;//nocache
if(rs.equals(PreAuthenticatedUserNameRoleSource.Header)){request.addHeader("roles",derivedRole+";"+rootRole);
if(rs.equals(PreAuthenticatedUserNameRoleSource.Header)){continue;//nocache
if(rs.equals(PreAuthenticatedUserNameRoleSource.Header)){continue;//nocache
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
ifgribdataaresupported.*/publicclassGribDataTestextendsTestCase{@TestpublicvoidtestFormatSupported()throwsFileNotFoundException,IOException{//Check
iftheGribLibraryisavailablebycallingtheNetCDFUtilities.isGribAvailable()//methodAssert.assertTrue(NetCDFUtilities.isGribAvailable());//SelectionoftheinputfileFilefile=TestData.file(this,"sampleGrib.grb2");//Check
ifthegribfileisacceptedbytheNetCDFdriverAbstractGridFormatformat=newGRIBFormat();Assert.assertTrue(format.accepts(file));//Check
ifthenetcdfreaderspiobjectcanreadtheinputfileImageReaderSpispi=newNetCDFImageReaderSpi();Assert.assertTrue(spi.canDecodeInput(file));
ifalmostonecoverageispresentAssert.assertNotNull(coverageNames);Assert.assertTrue(coverageNames.length>0);//ReadingofonecoverageGridCoverage2Dcoverage=reader.read(coverageNames[0],null);//Check
ifthecoverageexistsAssert.assertNotNull(coverage);
if(reader!=null){try{reader.dispose();
if(model==null){thrownewServiceException("Palette"+value+"couldnotbefound"+"in$GEOSERVER_DATA_DIR/palettesdirectory");
if(epsgCode!=null){try{CRS.decode(epsgCode);
if(context.getId()==id){returncontext;
if(id<=idseq.longValue()){id=idseq.getAndIncrement();
else{idseq.set(id+1);
if(imports.size()>100){clearCompletedImports();
if(sortBy==null){returniterator();
if(capture(context)){collected.add(context);
iforderisbig-endian,<code>false</code>forlittle-endian,and<code>null</code>*
ifbyteorderisnotrelevantforthisencodingscheme.Thisisa"three-state"
switch(third*is<code>null</code>),soitcan'tbejustplain<code>boolean</code>type.*/privateBooleanfIsBigEndian=null;/***Thisistechnicallynotapartofencodingmetadata,butmorelikecharacteristicofthe*inputXMLdocument.TellswhetherByteOrderMark(BOM)wasfoundwhiledetectingencoding*scheme.*/privatebooleanfHasBOM;/***Non-argconstructortouseinafewcaseswhenyouneedablankinstanceof<code>*EncodingInfo</code>.Itcant'beusedrightaftercreationandshouldbepopulatedfirstvia*eithersettersorspecificcharsetdetectionmethods.*/publicEncodingInfo(){}/***Constructorthattakesnameoftheencodingschemeandendianness-resultsofautodetection*in<code>getEncodingName</code>.BOMisconsideredmissing
ifobjectisconstructedthisway.**@paramencodingNameoftheautodetectedencodingscheme.*@paramisBigEndian*<p>Detectedbyteorderofthedata.<code>true</code>
iforderisbig-endian,<code>false*</code>
iflittle-endian,and<code>null</code>
ifbyteorderisnotrelevantforthis*encodingscheme.*/publicEncodingInfo(Stringencoding,BooleanisBigEndian){fEncoding=encoding;fIsBigEndian=isBigEndian;fHasBOM=false;
iforderisbig-endian,<code>false*</code>
iflittle-endian,and<code>null</code>
ifbyteorderisnotrelevantforthis*encodingscheme.*@paramhasBOM<code>true</code>
ifBOMispresent,<code>false</code>otherwise.*/publicEncodingInfo(Stringencoding,BooleanisBigEndian,booleanhasBOM){fEncoding=encoding;fIsBigEndian=isBigEndian;fHasBOM=hasBOM;
if(null!=fIsBigEndian){sb.append((fIsBigEndian.booleanValue())?"BIGENDIAN":"LITTLEENDIAN");
if(fHasBOM){sb.append("withBOM");
if(GlobalContextBuilder.builder()==null||GlobalContextBuilder.builder().getClass().equals(ContextBuilder.class)){GlobalContextBuilder.builder(newGeoServerContextBuilder());
if(INSTANCE==null){INSTANCE=GeoServerExtensions.bean(RepositoryManager.class);Preconditions.checkState(INSTANCE!=null);
if(INSTANCE!=null){INSTANCE.dispose();INSTANCE=null;
ifnoURIissetinthehintsURIrepoURI;
if(hints.get(Hints.REPOSITORY_URL).isPresent()){repoURI=URI.create(hints.get(Hints.REPOSITORY_URL).get().toString());
else{//nolocationsetyet,generateone//NOTE:Iftheresourcestoredoesnotsupportafilesystem,therepositorywillbe//created//inatemporarydirectory.Ifthisisthecase,removeanyrepositoryresolversthat//can//resolvea'file'URItopreventthecreationofsuchrepos.Resourceroot=resourceStore.get(REPO_ROOT);FilerepoDir=root.get(UUID.randomUUID().toString()).dir();
if(!repoDir.exists()){repoDir.mkdirs();
if(exists){try{repository.open();
iffound.Ifnotfound,returnsnull.*/public@NullableRepositoryInfogetByRepoName(finalStringname){RepositoryInfoinfo=configStore.getByName(name);returninfo;
if(file==null){returnfalse;
if(Objects.equal(oldRepo.getId(),newRepo.getId())){//reposhavethesameID,checkthenamesfinalStringoldName=oldRepo.getRepoName();finalStringnewName=newRepo.getRepoName();
if(!Objects.equal(oldName,newName)){//namehasbeenchanged,updatetherepotry{getRepository(oldRepo.getId()).command(ConfigOp.class).setAction(ConfigOp.ConfigAction.CONFIG_SET).setName("repo.name").setScope(ConfigOp.ConfigScope.LOCAL).setValue(newName).call();
if(info.getId()==null){create(info);
else{//see
ifthenamehaschanged.Ifso,updatetherepoconfigRepositoryInfocurrentInfo=get(info.getId());handleRepoRename(currentInfo,info);
ifanyconfigurationoptionwouldrequiresointhefuturereturnconfigStore.save(info);
if(!resolver.repoExists(repoURI)){Hintshints=newHints();hints.set(Hints.REPOSITORY_URL,repoURI);hints.set(Hints.REPOSITORY_NAME,repoInfo.getRepoName());Contextcontext=GlobalContextBuilder.builder().build(hints);GeoGIGgeogig=newGeoGIG(context);try{Repositoryrepository=geogig.command(InitOp.class).call();Preconditions.checkState(repository!=null);
if(info!=null){returninfo;
ifitsaliveandwe'reabletoconnect.**@returntheremote'sheadref
ifsucceeded*@throwsException
ifcan'tconnectforanyreason;theexceptionmessageshouldbeindicative*oftheproblem*/publicstaticRefpingRemote(finalStringlocation,@NullableStringuser,@NullableStringpassword)throwsException{
if(Strings.isNullOrEmpty(location)){thrownewIllegalArgumentException("PleaseindicatetheremoterepositoryURL");
if(!remoteRepo.isPresent()){thrownewIllegalArgumentException("Repositorynotfoundornotreachable");
else{IRemoteReporepo=remoteRepo.get();try{repo.open();Optional<Ref>head=repo.headRef();returnhead.orNull();
if(resource==null){returnfalse;
if(store==null){returnfalse;
if(!(storeinstanceofDataStoreInfo)){returnfalse;
ifthisisaclean-up*/BatchContextgetBatchContext();/***@returntheparametervalues,lazyloadedfromtaskandconfiguration.*@throwsTaskException*/Map<String,Object>getParameterValues()throwsTaskException;/***Taskscancallthisfunctiontocheck
iftheuserwantstointerruptthebatchandinterrupt*themselves.Iftheydo,theyshouldstillreturnaTaskResultthatimplementsarollbackof*whatwasalreadydone.**@returnwhetherthebatchrunshouldbeinterrupted,false
ifthisisaclean-up*/booleanisInterruptMe();}
if(request.getQueryString()!=null){MapkvPairs=KvpRequestReader.parseKvpSet(request.getQueryString());targetRequest=DispatcherKvpReader.getRequestType(kvPairs);
else{targetRequest=UNKNOWN;//throwexception
if(!status.isAvailable()){return;//skiptest
ifitexistsassertNotNull(cache);}}
if(testData!=null){testData.tearDown();
if(response.getStatusCode()==200){//code=response.getErrorCode();//
if(debugMode){print(page,true,true);
if(signalArgs!=null&&signalArgs.get("topic")!=null)returnsignalArgs.get("topic").equals("completed");returnfalse;
if(msg!=null&&msg.equals("completed")){finalMap<String,Object>outputs=newHashMap<String,Object>();try{for(Entry<String,String>result:newTreeMap<String,String>(signalArgs).entrySet()){
if(result.getKey().startsWith("result")){finalStringserviceResultString=URLDecoder.decode(result.getValue(),"UTF-8");finalJSONObjectserviceResultJSON=(JSONObject)JSONSerializer.toJSON(serviceResultString);finalObjectoutput=xmppClient.unPickle(xmppClient.pickle(serviceResultJSON));//XMPPOutputVisitor
if(outputinstanceofMap){finalMap<String,Object>resultParams=(Map<String,Object>)output;//transformthetextualvalueintoarealWPS//outputtry{finalObjectvalue=(resultParams.get(result.getKey()+"_value")!=null?resultParams.get(result.getKey()+"_value"):null);finalStringtype=(String)(resultParams.get(result.getKey()+"_type")!=null?resultParams.get(result.getKey()+"_type"):null);finalStringdescription=(resultParams.get(result.getKey()+"_description")!=null&&resultParams.get(result.getKey()+"_description")instanceofString?(String)resultParams.get(result.getKey()+"_description"):null);finalStringtitle=(resultParams.get(result.getKey()+"_title")!=null&&resultParams.get(result.getKey()+"_title")instanceofString?(String)resultParams.get(result.getKey()+"_title"):null);finalStringlayerName=(resultParams.get(result.getKey()+"_layer_name")!=null&&resultParams.get(result.getKey()+"_layer_name")instanceofString?(String)resultParams.get(result.getKey()+"_layer_name"):null);finalStringdefaultStyle=(resultParams.get(result.getKey()+"_style")!=null&&resultParams.get(result.getKey()+"_style")instanceofString?(String)resultParams.get(result.getKey()+"_style"):null);finalStringtargetWorkspace=(resultParams.get(result.getKey()+"_workspace")!=null&&resultParams.get(result.getKey()+"_workspace")instanceofString?(String)resultParams.get(result.getKey()+"_workspace"):null);finalStringmetadata=(resultParams.get(result.getKey()+"_metadata")!=null&&resultParams.get(result.getKey()+"_metadata")instanceofString?(String)resultParams.get(result.getKey()+"_metadata"):null);Booleanpublish=true;
if(resultParams.get(result.getKey()+"_pub")!=null){
if(resultParams.get(result.getKey()+"_pub")instanceofString)publish=Boolean.valueOf((String)resultParams.get(result.getKey()+"_pub"));
else
if(resultParams.get(result.getKey()+"_pub")instanceofBoolean)publish=(Boolean)resultParams.get(result.getKey()+"_pub");
if(wpsOutputValue!=null){outputs.put(result.getKey(),wpsOutputValue);continue;
else{//thrownewException("AlltheOutput//ProducersfailedtransformingtheWPS//Output!");LOGGER.warning("AtleastoneoftheOputputProducresfailedtransformingtheWPSOutput!");
else{for(RemoteProcessClientListenerlistener:xmppClient.getRemoteClientListeners()){listener.complete(pID,null);
if(obj==null)return"";
elsereturn((StyleInfo)obj).getName();}}
ifnotset*/publicStringgetOutputFormat(){returnoutputFormat;
ifnotset*/publicStringgetBaseUrl(){returnbaseUrl;
if(!p.getValidationErrors().isEmpty()){thrownewServiceException("ErrorswereencounteredwhileparsingGeoPackagecontents:"+p.getValidationErrors());
if(input==null){returnnull;
else
if(inputinstanceofGeoPackageProcessRequest){returninput;
else
if(inputinstanceofString){returndecode(IOUtils.toInputStream((String)input));
else{thrownewIllegalArgumentException("Cannotconvert"+input+"intoaGeoPackageProcessRequestobject");
ifnotset.**<p>Thetree-ishattherightsideofthecomparisonissetthrough{@link*#setNewVersion(String)},anddefaultsto{@linkRef#WORK_HEAD}
ifnotset.*/publicclassMinimalDiffBoundsextendsAbstractGeoGigOp<Geometry>{privateStringoldVersion;privateStringnewVersion;privateStringtreeName;publicMinimalDiffBoundssetOldVersion(StringoldTreeish){this.oldVersion=oldTreeish;returnthis;
if(treeName!=null){consumer=newPathFilteringDiffConsumer(ImmutableList.of(treeName),boundsBuilder);
if(file.exists()){stream=newFileInputStream(file);
else{stream=ImporterTestSupport.class.getResourceAsStream("../test-data/"+path);
ifexists\""+nameext[0]+"\"";Statementstmt=conn.createStatement();stmt.execute(sql);stmt.close();conn.close();
if(asURL){//makeacopysince,zipasurlwillarchiveanddeleteitFilecopyDir=tmpDir();FileUtils.copyFile(file,newFile(copyDir,zip));returnputZipAsURL(newFile(copyDir,zip).getAbsolutePath());
else{returnputZip(zip);
if(!tempDir.mkdirs()){thrownewIllegalStateException("Cannotcreatetempdirfortestinggeotiff");
if(!tiff.exists()){thrownewIllegalStateException("Didnotextracttifcorrectly");
if(inputMessageinstanceofRestHttpInputWrapper){((RestHttpInputWrapper)inputMessage).configurePersister(p,this);
if(oinstanceofRestWrapper){((RestWrapper<?>)o).configurePersister(xmlPersister,this);o=((RestWrapper<?>)o).getObject();
if(getType()==BackupExecutionAdapter.class){returnBackupRestoreWebUtils.backupFacade().getBackupExecutions().get(id);
else
if(getType()==RestoreExecutionAdapter.class){returnBackupRestoreWebUtils.backupFacade().getRestoreExecutions().get(id);
if(layerId==null&&layerGroupId==null){returnType.STYLE_GROUP;
else
if(layerGroupId!=null){returnType.LAYER_GROUP;
else{returnType.LAYER;
if(styleId==null)returnnull;
elsereturnGeoServerApplication.get().getCatalog().getStyle(styleId);
if(getLayer()==null){setStyle(getStyle());
else
if(defaultStyle||(getLayer()instanceofLayerGroupInfo)){setStyle(null);
else{setStyle(((LayerInfo)getLayer()).getDefaultStyle());
if(style==null)styleId=null;
elsestyleId=style.getId();
if(layerGroupId!=null){returnGeoServerApplication.get().getCatalog().getLayerGroup(layerGroupId);
else
if(layerId!=null){returnGeoServerApplication.get().getCatalog().getLayer(layerId);
else{returnnull;
if(publishedInfo!=null){
if(publishedInfoinstanceofLayerGroupInfo){layerGroupId=publishedInfo.getId();
else{layerId=publishedInfo.getId();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;LayerGroupEntryother=(LayerGroupEntry)obj;
if(layerGroupId==null){
if(other.layerGroupId!=null)returnfalse;
else
if(!layerGroupId.equals(other.layerGroupId))returnfalse;
if(layerId==null){
if(other.layerId!=null)returnfalse;
else
if(!layerId.equals(other.layerId))returnfalse;
if(styleId==null){
if(other.styleId!=null)returnfalse;
else
if(!styleId.equals(other.styleId))returnfalse;returntrue;}}
if(it.hasNext()){sb.append(separator);
if(out!=null){out.flush();
ifitisnotbeingrun.*/RungetCurrentRun(Tasktask);/***Ifataskiscurrentlybeingcommitted,returnthecurrentrun.**@paramtaskthetask*@returnthecurrentrun,ornull
ifitisnotbeingcommitted.*/RungetCommittingRun(finalTasktask);/***Permanentlydeleteabatch.Allhistoricalinformation(runs)associatedwiththisbatchwill*beremoved.**@parambatchthebatch*/voiddelete(Batchbatch);/***Permanentlydeleteaconfiguration.Allhistoricalinformation(tasks+runs+batches)*associatedwiththisconfigurationwillberemoved.Notethatthiswillfail
ifsomeofthe*tasksarestillusedinexistingindependentbatches.**@parambatchthebatch*/voiddelete(Configurationconfig);/***Permanentlydeleteabatchelement.Allhistoricalinformation(runs)associatedwiththis*batchelementwillberemoved.**@parambatchElementthebatchelement*/voiddelete(BatchElementbatchElement);/***Permanentlydeleteatask.Allhistoricalinformationassociatedwiththistaskwillbe*removed(runs).Notethatthiswillfail
ifthetaskisstillusedinexistingbatches.**@paramtaskthetask*/voiddelete(Tasktask);/***Getthelatestrunofacertainbatchelement.**@parambatchElementthebatchelement.*@returnthelatestrun.*/RungetLatestRun(BatchElementbatchElement);/***Copyconfiguration**@paramconfigNamethenameoftheconfigurationyouwishtocopy*@returncopiedconfiguration*/ConfigurationcopyConfiguration(StringconfigName);/***Listalltasksavailableforabatch.Thatmeans-notasksalreadyinthebatch-only*activetasks-
ifthebatchispartofaconfigurationortemplate,onlytasksofthat*configurationortemplate-
ifthebatchisnotpartofaconfigurationortemplate,only*tasksinarealconfiguration(nottemplate).**@returnthelistofavailabletasks.*/List<Task>getTasksAvailableForBatch(Batchbatch);/***Getcurrentbatchrunsforbatch**@parambatchthebatch*@returnthelistofcurrentlyrunningbatchrunsforbatch*/List<BatchRun>getCurrentBatchRuns(Batchbatch);/***Reloadsobject.**@paramobjecttheobjecttobereloaded*@returnthereloadedobject*/<TextendsIdentifiable>Treload(Tobject);/***ReturnbatchrunonthebasisoftheschedulerreferenceIftheschedulerreferenceisnot*unique,themostrecentbatchrunisreturned.**@paramschedulerReferenceschedulerreference*@return*/BatchRungetBatchRunBySchedulerReference(StringschedulerReference);List<Batch>getViewableBatches();voidloadLatestBatchRuns(Configurationconfig);}
if(rule.getMinScaleDenominator()<minScaleDenominator){minScaleDenominator=rule.getMinScaleDenominator();
if(rule.getMaxScaleDenominator()>maxScaleDenominator){maxScaleDenominator=rule.getMaxScaleDenominator();
if(minScaleDenominator==Double.POSITIVE_INFINITY){minScaleDenominator=0.0;
if(maxScaleDenominator==Double.NEGATIVE_INFINITY){maxScaleDenominator=Double.POSITIVE_INFINITY;
if(!stylesCopy.contains(defaultStyle)){stylesCopy.add(defaultStyle);
if(styleInfo==null){PublishedInfopublishedInfo=layerGroup.getLayers().get(i);
if(publishedInfoinstanceofLayerInfo){styleInfo=((LayerInfo)publishedInfo).getDefaultStyle();stylesCopy.add(styleInfo);
else
if(publishedInfoinstanceofLayerGroupInfo){findLayerGroupStyles((LayerGroupInfo)publishedInfo,stylesCopy);
else{stylesCopy.add(styleInfo);
if(publishedInfoinstanceofLayerInfo){returnsearchMinMaxScaleDenominator((LayerInfo)publishedInfo);
else
if(publishedInfoinstanceofLayerGroupInfo){returnsearchMinMaxScaleDenominator((LayerGroupInfo)publishedInfo);
if(workSpaceName!=null){WorkspaceInfoworkspace=newWorkspaceInfoImpl();workspace.setName(workSpaceName);store.setWorkspace(workspace);
if(extraStyles!=null){Setstyles=newHashSet();for(Stringname:extraStyles){StyleInfoImplextra=newStyleInfoImpl(null);extra.setName(name);styles.add(extra);
ifnoimagewasrenderedBufferedImageimage=ImageIO.read(getBinaryInputStream(postAsServletResponse("wms",builder.toString())));assertNotNull(image);
ifnoimagewasrenderedBufferedImageimage=ImageIO.read(getBinaryInputStream(getAsServletResponse(request)));assertNotNull(image);}}
if(group.getFactoryClass().equals(factory.getClass())){List<ProcessInfo>filteredProcesses=group.getFilteredProcesses();for(ProcessInfopi:filteredProcesses){
if(name.equals(pi.getName())){processInfo=pi;break;
if(processInfo!=null){break;
ifwehaveanyrestrictiontoapplyMap<String,Parameter<?>>result=super.getParameterInfo(name);intmaxComplexInputSize=wps.getMaxComplexInputSize();
if(maxComplexInputSize<=0&&(processInfo==null||processInfo.getValidators()==null||processInfo.getValidators().isEmpty())){returnresult;
else{Multimap<String,WPSInputValidator>validatorsMap=processInfo!=null?processInfo.getValidators():EMPTY_MULTIMAP;//clonejusttobeonthesafesideHashMap<String,Parameter<?>>params=newLinkedHashMap<>(result);for(StringparamName:params.keySet()){Parameter<?>param=params.get(paramName);Collection<WPSInputValidator>validators=validatorsMap.get(paramName);//canweskiptobuildaclone?
if(validators==null&&(maxComplexInputSize<=0||!ProcessParameterIO.isComplex(param,applicationContext))){continue;
if(wps.getMaxComplexInputSize()>0){metadataClone.put(MaxSizeValidator.PARAMETER_KEY,wps.getMaxComplexInputSize());
if(validators!=null){metadataClone.put(VALIDATORS_KEY,validators);for(Validatorvalidator:validators){
if(validatorinstanceofMaxSizeValidator){MaxSizeValidatormsv=(MaxSizeValidator)validator;intmaxSizeMB=msv.getMaxSizeMB();metadataClone.put(MaxSizeValidator.PARAMETER_KEY,maxSizeMB);
else
if(validatorinstanceofNumberRangeValidator){NumberRangeValidatorrv=(NumberRangeValidator)validator;Range<?>range=rv.getRange();Comparablemin=(Comparable)param.metadata.get(Parameter.MIN);Comparablemax=(Comparable)param.metadata.get(Parameter.MAX);booleanrestricting=false;
if(range.getMinValue()!=null&&(min==null||min.compareTo(range.getMinValue())<0)){min=range.getMinValue();restricting=true;
if(range.getMaxValue()!=null&&(max==null||max.compareTo(range.getMaxValue())>0)){max=range.getMaxValue();restricting=true;
if(restricting){
if(min!=null){metadataClone.put(Parameter.MIN,min);
if(max!=null){metadataClone.put(Parameter.MAX,max);
else
if(validatorinstanceofMultiplicityValidator){MultiplicityValidatormv=(MultiplicityValidator)validator;intmax=mv.getMaxInstances();
if(max<maxOccurs){maxOccurs=max;
ifitwheretheresultofa*GetFeatureWFSrequest.**@authorcarlocancellieri-GeoSolutions*/publicclassXMLDescribeLayerResponseextendsDescribeLayerResponse{publicstaticfinalStringDESCLAYER_MIME_TYPE="application/vnd.ogc.wms_xml";protectedfinalWMSwms;/**Constructorforsubclasses*/publicXMLDescribeLayerResponse(finalWMSwms){super(DESCLAYER_MIME_TYPE);this.wms=wms;
if(wms.getGeoServer().getSettings().isVerbose()){transformer.setIndentation(2);
if(propertyName!=null){
if(propertyNameinstanceofList&&((List)propertyName).size()>0){Objectproperty=null;
if(((List)propertyName).get(0)instanceofList){property=((List)((List)propertyName).get(0)).get(0);
if(propertyinstanceofQName){kvp.put(PROPERTYNAME,((QName)property).getLocalPart());
else
if(propertyinstanceofString){kvp.put(PROPERTYNAME,property);
else
if(propertyNameinstanceofString){kvp.put(PROPERTYNAME,propertyName);
ifweregisteritusinganiterator//providerGeoTools.addFactoryIteratorProvider(newFactoryIteratorProvider(){public<T>Iterator<T>iterator(Class<T>category){
if(ProcessFactory.class.isAssignableFrom(category)){return(Iterator<T>)Collections.singletonList(factory).iterator();
else{returnnull;
if(CatalogImpl.DEFAULT.equals(validatable.getValue())){validatable.error(newValidationError("defaultWsError").addKey("defaultWsError"));
if(!getCatalog().getCatalogCapabilities().supportsIsolatedWorkspaces()){//isisolatedworkspacesarenotsupportedbythecurrentcatalogdisablethemisolatedChk.setEnabled(false);
if(!validateAndReport(()->catalog.validate(workspace,true),form)||!validateAndReport(()->catalog.validate(namespace,true),form)){//atleastonevalidationfailreturn;
ifweneedtotagthisworkspaceasthedefaultone
if(defaultWs){catalog.setDefaultWorkspace(workspace);
ifthevalidationwassuccessful,otherwisefalse*/privatebooleanvalidateAndReport(Supplier<ValidationResult>validation,Formform){//executethevalidationValidationResultvalidationResult;try{validationResult=validation.get();
iftheworkspacealreadyexistsLOGGER.log(Level.INFO,"Errorvalidatingworkspacerelatedobjects.",exception);form.error(exception.getMessage());returnfalse;
ifthevalidationwasnotsuccessfulreportthefoundexceptions
if(!validationResult.isValid()){Stringmessage=validationResult.getErrosAsString(System.lineSeparator());LOGGER.log(Level.INFO,message);form.error(message);returnfalse;
ifboththeworkspaceandnamespace*wherecreatedorremoved,
ifitisnotthecasethenremovestheremainingone.Theinvoker*isresponsibletologtheexceptionasneeded.**@paramexceptionexceptionthathappen*@paramformformwheretoreporttheexception*/privatevoidcleanAndReport(Exceptionexception,Formform){Catalogcatalog=getCatalog();WorkspaceInfoworkspace=(WorkspaceInfo)form.getModelObject();//let'ssee
ifboththeworkspaceandassociatednamespaceexistsWorkspaceInfofoundWorkspace=catalog.getWorkspaceByName(workspace.getName());
if(foundWorkspace!=null){NamespaceInfofoundNamespace=catalog.getNamespaceByPrefix(workspace.getName());
if(foundNamespace==null){//onlytheworkspacewascreated,let'sremoveitcatalog.remove(foundWorkspace);
if(idxOpen==-1){thrownewWCS20Exception("InvalidScaleExtentsyntax,expectingacommaseparatelistofaxisName(min,max)*",WCS20Exception.WCS20ExceptionCode.InvalidEncodingSyntax,"scaleExtent");
if(idxClosed==-1||(idxNextOpen>0&&idxClosed>idxNextOpen)){thrownewWCS20Exception("InvalidScaleExtentsyntax,expectingacommaseparatelistofaxisName(min,max)*",WCS20Exception.WCS20ExceptionCode.InvalidEncodingSyntax,"scaleExtent");
if(idxMid==-1||idxMid>=idxClosed-1||idxMid<=idxOpen+1){thrownewWCS20Exception("InvalidScaleExtentsyntax,expectingacommaseparatelistofaxisName(min,max)*",WCS20Exception.WCS20ExceptionCode.InvalidEncodingSyntax,"scaleExtent");
if(idxNextMid!=-1&&idxNextMid<idxClosed){thrownewWCS20Exception("InvalidScaleExtentsyntax,expectingacommaseparatelistofaxisName(min,max)*",WCS20Exception.WCS20ExceptionCode.InvalidEncodingSyntax,"scaleExtent");
if(idxSeparator==-1){
if(idxClosed==value.length()-1){returnse;
else{thrownewWCS20Exception("InvalidScaleExtentsyntax,expectingacommaseparatelistofaxisName(min,max)*",WCS20Exception.WCS20ExceptionCode.InvalidEncodingSyntax,"scaleExtent");
else{
if(idxSeparator>idxNextClosed){thrownewWCS20Exception("InvalidScaleExtentsyntax,expectingacommaseparatelistofaxisName(min,max)*",WCS20Exception.WCS20ExceptionCode.InvalidEncodingSyntax,"scaleExtent");
if(catalog.getLayerGroup(lg.getId())!=null){remover.visit(lg);
if(ws!=null){group.setWorkspace(ws);
if(layers!=null){for(PublishedInfolayer:layers){group.getLayers().add(layer);group.getStyles().add(null);
if(ws!=null){returncatalog.getLayerGroupByName(ws.getName(),name);
else{returncatalog.getLayerGroupByName(name);
if(names==null){returnCollections.emptySet();
if(request.getId()==null){thrownewWFSException(request,"Nostoredqueryidspecified");
if(query!=null){storedQueryProvider.removeStoredQuery(query);
else{WFSExceptionexception=newWFSException(request,String.format("Storedquery%sdoesnotexist.",request.getId()),ServiceException.INVALID_PARAMETER_VALUE);//CITEtestsvagary,theXMLuses"id"andKVPuses"STOREDQUERY_ID",theCITEtests//mandate"id"//inallbindingsexception.setLocator("id");throwexception;
if("1.0.0".equals(version)){return;
ifmandatorycontentnotpresent//orturnedoff
if(metadataURL==null||ids==null||ids.isEmpty()||createExtendedCapabilities!=null&&!createExtendedCapabilities){return;
if(mediaType!=null){tx.start("inspire_common:MediaType");tx.chars(mediaType);tx.end("inspire_common:MediaType");
if(id.getMetadataURL()!=null){tx.start("inspire_dls:SpatialDataSetIdentifier",atts("metadataURL",id.getMetadataURL()));
else{tx.start("inspire_dls:SpatialDataSetIdentifier");
if(id.getNamespace()!=null){tx.start("inspire_common:Namespace");tx.chars(id.getNamespace());tx.end("inspire_common:Namespace");
iftheroleserviceisnotnull*/protectedvoidassertRoleServiceNotNull(){
if(roleService==null){thrownewRuntimeException("roleserviceServiceisnull");
ifa{@link*GeoServerUserGroupService}serviceisgiven,foreach"enabled"group,addtherolesofthe*group**<p>forearchrolesearchforancestorrolesandaddthemtotheset**<p>Afterrolecalculationhasfinished,personalizeeachrolewithroleattributes
if*necessary**<p>Iftheuserhastheadminroleoftheactiveroleservice,{@link*GeoServerRole#ADMIN_ROLE}isalsoincludedintheset.**@paramuser*@throwsIOException*/publicSortedSet<GeoServerRole>calculateRoles(GeoServerUseruser)throwsIOException{Set<GeoServerRole>set1=newHashSet<GeoServerRole>();//allerolesfortheuserset1.addAll(getRoleService().getRolesForUser(user.getUsername()));addInheritedRoles(set1);//addallrolesforenabledgroups
if(getUserGroupService()!=null){for(GeoServerUserGroupgroup:getUserGroupService().getGroupsForUser(user)){
if(group.isEnabled())set1.addAll(calculateRoles(group));
iftheuserhastheadminroleoftheroleservicethe//GeoserverRole.ADMIN_ROLEmustalsobeinthesetGeoServerRoleadminRole=roleService.getAdminRole();
if(adminRole!=null&&set.contains(adminRole)){set.add(GeoServerRole.ADMIN_ROLE);
iftheuserhasthegroupadminroleoftheroleservicethe//GeoserverRole.ADMIN_ROLEmustalsobeinthesetGeoServerRolegroupAdminRole=roleService.getGroupAdminRole();
if(groupAdminRole!=null&&set.contains(groupAdminRole)){set.add(GeoServerRole.GROUP_ADMIN_ROLE);
if(parentRole==null)return;//endofrecursion
if(inherited.contains(parentRole))return;//endofrecursioninherited.add(parentRole);//recursionaddParentRole(parentRole,inherited);
if(personalizedProps==null){set.add(role);
else{//createpersonalizedroleGeoServerRolepRole=getRoleService().createRoleObject(role.getAuthority());pRole.setUserName(user.getUsername());for(Objectkey:personalizedProps.keySet())pRole.getProperties().put(key,personalizedProps.get(key));set.add(pRole);
if(layerInfo!=null){returnlayerInfo.getResource().prefixedName();
else{returngroupInfo.prefixedName();
if(layerInfo!=null){returnlayerInfo.getResource().getStore().getWorkspace().getName();
else
if(groupInfo!=null&&groupInfo.getWorkspace()!=null){returngroupInfo.getWorkspace().getName();
if(layerInfo!=null)returnCatalogIconFactory.get().getSpecificLayerIcon(layerInfo);
elsereturnCatalogIconFactory.GROUP_ICON;
if(layerInfo!=null)returnCatalogIconFactory.get().getSpecificLayerIcon(layerInfo);
elsereturnCatalogIconFactory.GROUP_ICON;
if(layerInfo!=null){returnlayerInfo.getResource().getTitle();
else
if(groupInfo!=null){returngroupInfo.getTitle();
else{return"";
if(layerInfo!=null){returnlayerInfo.getResource().getAbstract();
else
if(groupInfo!=null){returngroupInfo.getAbstract();
else{return"";
if(layerInfo!=null){returnlayerInfo.getResource().getKeywords().toString();
else{return"";
if(layerInfo!=null){
if(layerInfo.getType()==PublishedType.RASTER)returnPreviewLayerType.Raster;
else
if(layerInfo.getType()==PublishedType.VECTOR)returnPreviewLayerType.Vector;
elsereturnPreviewLayerType.Remote;
else{returnPreviewLayerType.Group;
if(request==null){GeoServerApplicationapp=GeoServerApplication.get();request=newGetMapRequest();Catalogcatalog=app.getCatalog();List<MapLayerInfo>layers=expandLayers(catalog);request.setLayers(layers);request.setFormat("application/openlayers");//inthecaseofgroupswealreadyknowabouttheenvelopeandthetargetSRS
if(groupInfo!=null){ReferencedEnvelopebounds=groupInfo.getBounds();request.setBbox(bounds);StringepsgCode=GML2EncodingUtils.epsgCode(bounds.getCoordinateReferenceSystem());
if(epsgCode!=null)request.setSRS("EPSG:"+epsgCode);
if(layerInfo!=null){layers.add(newMapLayerInfo(layerInfo));
else{for(LayerInfol:Iterables.filter(groupInfo.getLayers(),LayerInfo.class)){layers.add(newMapLayerInfo(l));
if(ws==null||useGlobalRef){//globalreferencereturnResponseUtils.buildURL(base,service,null,URLType.SERVICE);
else{returnResponseUtils.buildURL(base,ws+"/"+service,null,URLType.SERVICE);
if(bbox==null)returnnull;returngetBaseUrl("wms")+"?service=WMS&version=1.1.0&request=GetMap"//+"&layers="+getName()//+"&styles="//+"&bbox="+bbox.getMinX()+","+bbox.getMinY()//+","+bbox.getMaxX()+","+bbox.getMaxY()//+"&width="+request.getWidth()//+"&height="+request.getHeight()+"&srs="+request.getSRS();
if(layerInfo!=null){
if(layerInfo.getResource()instanceofFeatureTypeInfo){FeatureTypeInfoftInfo=(FeatureTypeInfo)layerInfo.getResource();
if(ftInfo.getStore()!=null){Map<String,Serializable>connParams=ftInfo.getStore().getConnectionParameters();
if(connParams!=null){Stringdbtype=(String)connParams.get("dbtype");//app-schemafeaturetypesneedspecialtreatment
if("app-schema".equals(dbtype)){StringmappingUrl=connParams.get("url").toString();
if(gmlParamsCache!=null&&gmlParamsCache.containsKey(mappingUrl)){//avoidlookinguptheGMLversionagaingmlParams=gmlParamsCache.get(mappingUrl);
else{//useglobalOWSservicetomakesureallsecondarynamespaces//areaccessiblegmlParams.baseUrl=getBaseUrl("ows",false);//alwaysuseWFS1.1.0forapp-schemalayersgmlParams.wfsVersion=org.geotools.wfs.v1_1.WFS.getInstance().getVersion();//determineGMLversionbyinspectingthefeaturetypeandits//supertypestry{gmlParams.gmlVersion=findGmlVersion(ftInfo);
if(gmlParamsCache!=null){gmlParamsCache.put(mappingUrl,gmlParams);
else{
iftheunderlyingdatastoreinstancecannotberetrieved*/StringfindGmlVersion(FeatureTypeInfoftInfo)throwsIOException{ProgressListenerlistener=newNullProgressListener();NameqName=ftInfo.getQualifiedName();FeatureTypefType=ftInfo.getStore().getDataStore(listener).getSchema(qName);returnfindFeatureTypeGmlVersion(fType);
if(featureType==null){returnnull;
if(isAbstractFeatureType(featureType)){StringgmlNamespace=featureType.getName().getNamespaceURI();
if(org.geotools.gml3.GML.NAMESPACE.equals(gmlNamespace)){//GML3.1.1return"gml3";
else
if(org.geotools.gml3.v3_2.GML.NAMESPACE.equals(gmlNamespace)){//GML3.2returnGML32OutputFormat.FORMATS.get(0);
else{//shouldneverhappenLOGGER.log(Level.FINE,"CannotdetermineGMLversionfromAbstractFeatureTypetype");returnnull;
if(type==null){returnfalse;
if("AbstractFeatureType".equals(localPart)&&(org.geotools.gml3.GML.NAMESPACE.equals(ns)||org.geotools.gml3.v3_2.GML.NAMESPACE.equals(ns))){returntrue;
else{returnfalse;
if(gmlParams.gmlVersion!=null){urlBuilder.append("&");urlBuilder.append("outputFormat=").append(gmlParams.gmlVersion);
if(resource!=null){resource=unwrap(resource);layer.setResource(resource);
if(style!=null){style=unwrap(style);layer.setDefaultStyle(style);
if(l!=null){PublishedInforesolved;
if(linstanceofLayerGroupInfo){resolved=unwrap(ResolvingProxy.resolve(getCatalog(),(LayerGroupInfo)l));//specialcasetohandlecatalogloading,whennestedpublishiblesmightnotbe//loaded.
if(resolved==null){resolved=l;
else
if(linstanceofLayerInfo){resolved=unwrap(ResolvingProxy.resolve(getCatalog(),(LayerInfo)l));//specialcasetohandlecatalogloading,whennestedpublishiblesmightnotbe//loaded.
if(resolved==null){resolved=l;
else{//Specialcasefornulllayer(stylegroup)resolved=unwrap(ResolvingProxy.resolve(getCatalog(),l));
if(s!=null){StyleInforesolved=unwrap(ResolvingProxy.resolve(getCatalog(),s));lg.getStyles().set(i,resolved);
if(ws!=null){WorkspaceInforesolved=ResolvingProxy.resolve(getCatalog(),ws);
if(resolved!=null){resolved=unwrap(resolved);style.setWorkspace(resolved);
else{LOGGER.log(Level.INFO,"Failedtoresolveworkspaceforstyle\""+style.getName()+"\".Thismeanstheworkspacehasnotyetbeenaddedtothecatalog,keeptheproxyaround");
if(resolved!=null){resolved=unwrap(resolved);s.setWorkspace(resolved);
else{LOGGER.log(Level.INFO,"Failedtoresolveworkspaceforstore\""+store.getName()+"\".Thismeanstheworkspacehasnotyetbeenaddedtothecatalog,keeptheproxyaround");
if(store!=null){store=unwrap(store);r.setStore(store);
if(namespace!=null){namespace=unwrap(namespace);r.setNamespace(namespace);
if(OwsUtils.get(o,"id")==null){Stringuid=newUID().toString();OwsUtils.set(o,"id",o.getClass().getSimpleName()+"-"+uid);
ifthelookupfailsthedefault,{@link*#FORCE_DECLARED},isreturned.**@paramcode*/publicstaticProjectionPolicyget(Integercode){
if(code==null)returnFORCE_DECLARED;for(ProjectionPolicyp:ProjectionPolicy.values()){
if(code.equals(p.getCode())){returnp;
if(bean==null){bean=newImportRepositoryFormBean();RepositoryInforepoInfo=repoInfoModel.getObject();
if(repoInfo!=null&&repoInfo.getLocation()!=null){finalURIuri=repoInfo.getLocation();//gettheschemefinalStringscheme=uri.getScheme();finalStringpath=uri.getPath();
switch(scheme){case"file"://parsethedriectroyoutofthepathbean.setRepoDirectory(path);case"postgresql"://buildthepgBeanbean.setPgBean(PostgresConfigBean.from(uri));//getthenamefinalStringrepoName=repoInfo.getRepoName();bean.setRepoName(repoName);
if(repoInfoModel!=null){repoInfoModel.detach();
if(wfsVersion.equals("2.0")){gmlPrefix=GML32_PREFIX;xpathBase=XPATH_BASE_GML32;xpathEngine=WFS20_XPATH_ENGINE;
else{gmlPrefix=GML31_PREFIX;xpathBase=XPATH_BASE_GML31;xpathEngine=WFS11_XPATH_ENGINE;
if(name.isEmpty()){//Defaultisnotsetsousethedefaultfromthelayer
if(defaultStyle==null)return"";returndefaultStyle;
else{//Defaultissetsouseitreturnname;
if(str==null||str.isEmpty()){//UsethedefaultreturngetDefaultValue();
else{for(Stringvalue:getLegalValues()){//Findamatchingstyle
if(value.equalsIgnoreCase(str)){returnvalue;
if(defaultValue==null)defaultValue="";
if(!defaultValue.isEmpty()&&availableStyles!=null&&!availableStyles.contains(defaultValue)){LOGGER.log(Level.WARNING,"Selecteddefaultstyle"+defaultValue+"isnotintheavailablestyles"+availableStyles+".");
ifsettousethelayerspecifieddefault*/publicStringgetRealDefault(){//Bypassthespecialprocessingthisclassnormallydoesonthedefaultvaluereturnsuper.getDefaultValue();
if(allowedStyles==null){//Valuesisnullsoallowanyofthebackinglayer'sstylesfinalStyles.addAll(layerStyles);
else{//Valuesissetsoonlyallowtheintersectionofthespecifiedstylesandthoseofthe//backinglayer.finalStyles.addAll(Sets.intersection(layerStyles,allowedStyles));
if(defaultStyle!=null&&!finalStyles.contains(defaultStyle)){finalStyles.add(defaultStyle);
if(layer.getDefaultStyle()!=null){defaultStyle=layer.getDefaultStyle().prefixedName();
else{defaultStyle=null;
ifallstylesareallowed.*/@NullablepublicSet<String>getStyles(){
if(allowedStyles==null)returnnull;returnCollections.unmodifiableSet(allowedStyles);
if(styles==null){this.allowedStyles=null;
else{this.allowedStyles=newTreeSet<String>(styles);
ifenabledistruefinalPropertyModel<Boolean>enabledModel=newPropertyModel<Boolean>(model,"enabled");enabled=newCheckBox("enabled",enabledModel);add(enabled);enabled.add(newAjaxFormComponentUpdatingBehavior("click"){@OverrideprotectedvoidonUpdate(AjaxRequestTargettarget){Booleanvisile=enabled.getModelObject();configs.setVisible(visile);target.add(configsContainer);
if(resourceinstanceofFeatureTypeInfo){
if(attributes.isEmpty()){disableDimension(type,configs,noAttributeMessage);
else{noAttributeMessage.setVisible(false);
else
if(resourceinstanceofCoverageInfo){attContainer.setVisible(false);attribute.setRequired(false);try{GridCoverageReaderreader=((CoverageInfo)resource).getGridCoverageReader(null,null);
if(Number.class.isAssignableFrom(type)){Stringelev=reader.getMetadataValue(GridCoverage2DReader.HAS_ELEVATION_DOMAIN);
if(!Boolean.parseBoolean(elev)){disableDimension(type,configs,noAttributeMessage);
else
if(Date.class.isAssignableFrom(type)){Stringtime=reader.getMetadataValue(GridCoverage2DReader.HAS_TIME_DOMAIN);
if(!Boolean.parseBoolean(time)){disableDimension(type,configs,noAttributeMessage);
ifunitshaveneverbeenset
if("elevation".equals(id)&&uModel.getObject()==null){uModel.setObject(DimensionInfo.ELEVATION_UNITS);usModel.setObject(DimensionInfo.ELEVATION_UNIT_SYMBOL);
if(time){resElevation.setVisible(false);resTime.setRequired(true);unitsContainer.setVisible(false);
else{resTime.setVisible(false);resElevation.setRequired(true);
if(defValueSetting==null){defValueSetting=newDimensionDefaultValueSetting();model.getObject().setDefaultValue(defValueSetting);
if(referenceValue.hasErrorMessage()){refValueValidationMessage.setDefaultModelObject(referenceValue.getFeedbackMessages().first());refValueValidationMessage.setVisible(true);
ifdimensionistime,strategyisNEARESTandvaluehas//neverbeenset
if("time".equals(id)&&refValueModel.getObject()==null&&strategyModel.getObject()==Strategy.NEAREST){refValueModel.setObject(DimensionDefaultValueSetting.TIME_CURRENT);
if(presentationModes.size()<=1){presentation.setModelObject(presentationModes.get(0));presentation.setEnabled(false);
if(!enabled.getModelObject()){setConvertedInput(newDimensionInfoImpl());
else{//TokeeptheoriginalvaluesforattributesnoteditableinUI:DimensionInfoImplinfo=newDimensionInfoImpl(this.getModelObject());info.setEnabled(true);attribute.processInput();endAttribute.processInput();info.setAttribute(attribute.getModelObject());StringendAttributeValue=endAttribute.getModelObject();
if("-".equals(endAttributeValue)){endAttributeValue=null;
if("time".equals(this.getId())){//onlyonevalueisallowedfortimeunitsunitsValue=DimensionInfo.TIME_UNITS;
else
if(unitsValue==null){//allowblankunitsforanyotherdimensionunitsValue="";
if(info.getPresentation()==DimensionPresentation.DISCRETE_INTERVAL){
if(time){resTime.processInput();info.setResolution(resTime.getModelObject());
else{resElevation.processInput();info.setResolution(resElevation.getModelObject());
if(defValueSetting.getStrategyType()==Strategy.FIXED||defValueSetting.getStrategyType()==Strategy.NEAREST){referenceValue.processInput();
if(referenceValue.hasErrorMessage()){LOGGER.log(Level.SEVERE,"Abouttoaccepterroneousvalue"+referenceValue.getModelObject());
if(defValueSetting.getStrategyType()!=Strategy.BUILTIN){info.setDefaultValue(defValueSetting);
else{info.setDefaultValue(null);
if(nearestMatch.isVisible()&&nearestMatch.getModelObject()){info.setNearestMatchEnabled(true);info.setAcceptableInterval(acceptableInterval.getModelObject());
else{info.setNearestMatchEnabled(false);info.setAcceptableInterval(null);
if(resourceinstanceofFeatureTypeInfo){try{FeatureTypeInfoft=(FeatureTypeInfo)resource;for(PropertyDescriptorpd:ft.getFeatureType().getDescriptors()){
if(type.isAssignableFrom(pd.getType().getBinding())){result.add(pd.getName().getLocalPart());
if(((strategyModel.getObject()==Strategy.FIXED)||(strategyModel.getObject()==Strategy.NEAREST))&&stringValue==null){value.error(newValidationError("emptyReferenceValue").addKey("emptyReferenceValue"));
else
if(dimension.equals("time")){
if(!isValidTimeReference(stringValue,strategyModel.getObject())){StringmessageKey=strategyModel.getObject()==Strategy.NEAREST?"invalidNearestTimeReferenceValue":"invalidTimeReferenceValue";value.error(newValidationError(messageKey).addKey(messageKey));
else
if(dimension.equals("elevation")){
if(!isValidElevationReference(stringValue)){value.error(newValidationError("invalidElevationReferenceValue").addKey("invalidElevationReferenceValue"));
if(LOGGER.isLoggable(Level.FINER)){LOGGER.log(Level.FINER,"Invalidelevationvalue"+stringValue,e);
if(strategy==Strategy.FIXED){//pointorrange,butjustonereturnvalues.size()==1;
else
if(strategy==Strategy.NEAREST){//onlypointvalue,norangesallowedreturnvalues.size()==1&&!(values.get(0)instanceofRange);
else{//nope,wecannothaveareferencevalue
ifthestrategyis//notfixedornearestreturnfalse;
if(LOGGER.isLoggable(Level.FINER)){LOGGER.log(Level.FINER,"Invalidtimevalue"+stringValue,e);
if(pt==null){pt=newArrayList<PtType>();
ifnot.**<p>Thismapproducershouldregisteraninstanceofthislistenertotherendererinordertoget*notifiedofanunexpectedrenderingexceptionthroughthe{@link#getException()}method.**<p>Thefollowingexceptioncausesaregoingtobeignored,anyotheronewillstoptherendering:**<ul>*<li>{@linkIllegalAttributeException}:knowntobethrownwhenaFeatureattributedoesnot*validateagainstit'sschema.*<li>{@linkTransformException}:ageometrycan'tbetransformedtothetargetCRS,usually*becauseofbeingoutsidethetargetCRSareaofvalidity.*<li>{@linkFactoryException}:thetransformfromsourceCRStodestinationCRSandfromthere*tothedisplayfailed.*<li>{@linkNoninvertibleTransformException}:atransformationerrorforgeometrydecimation*</ul>*/publicclassRenderExceptionStrategyimplementsRenderListener{privatestaticfinalLoggerLOGGER=Logging.getLogger("org.geoserver.wms");privatefinalGTRendererrenderer;privateExceptionrenderException;/***Createsarenderlistenertostopthegiven{@coderenderer}whenanonignorableexception*isnotified**@paramrenderertherendererto{@linkGTRenderer#stopRendering()stop}
ifanonignorable*exceptionoccurs*/publicRenderExceptionStrategy(finalGTRendererrenderer){this.renderer=renderer;this.renderException=null;
ifrenderingabortedduetoanexception,{@codefalse}otherwise*/publicbooleanexceptionOccurred(){returnrenderException!=null;
ifthe*rendererfinishedsuccessfully.*/publicExceptiongetException(){returnrenderException;
ifitscauseisonethatweactuallywanttoignore,and
ifnot*aborttherenderingprocesssothemapproducercanfail.*/publicvoiderrorOccurred(finalExceptionrenderException){Throwablecause=renderException;while(cause!=null){
if(causeinstanceofTransformException||causeinstanceofIllegalAttributeException||causeinstanceofFactoryException||causeinstanceofNoninvertibleTransformException){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Ignoringrenderererror",renderException);
if(adminService.getRuleByPriority(priority)!=null){adminService.shift(priority,1);
if(rule.getPriority()!=null){ShortAdminRulepriorityRule=adminService.getRuleByPriority(rule.getPriority());
if(priorityRule!=null&&priorityRule.getId().longValue()!=id){adminService.shift(rule.getPriority(),1);
if(name!=null){filter.setText(name);
if(includeDefault!=null){filter.setIncludeDefault(includeDefault);
else{
if(includeDefault!=null&&includeDefault){filter.setType(SpecialFilterType.DEFAULT);
else{filter.setType(SpecialFilterType.ANY);
if(rules.isEmpty()){returnResponseEntity.ok(null);
if(map!=null){settings=(DirectDownloadSettings)map.get(DirectDownloadSettings.DIRECTDOWNLOAD_KEY);
if(settings==null&&csw!=null){settings=getSettingsFromMetadata(csw.getMetadata(),null);
iftheincomingfeature*datadoesnothaveanSRSdeclaredforeachgeometry.Ifthe*srsNameattributeexistsonan&lt;Insert&gt;element,itsvalueshall*beequivalenttothevalueof&lt;DefaultSRS&gt;oranyofthe*&lt;OtherSRS&gt;oftherelevantfeaturetypes.If,however,theSRSis*notsupported,theWFSshallraiseanexceptionasdescribedin*subclause7.7.IfthesrsNameisnotspecifiedonthe&lt;Insert&gt;*element,theWFSshallinterpretthistomeanthatthefeature*dataisgiveninthe&lt;DefaultSRS&gt;list,exceptwhereanSRSis*specifiedonthefeaturegeometry.Inthiscase,
iftheSRSfor*suchageometryisoneofthe&lt;DefaultSRS&gt;or&lt;OtherSR&gt;values*fortherespectivefeaturetypes,itwillbetransformedas*requiredbeforeinsertion.However,
iftheaforesaidSRSisnot*supportedfortherespectivefeaturetype,theentiretransaction*shallfailandtheWFSshallraiseanexceptionasdescribedin*subclause7.7.Ifatomictransactionsarenotsupportedbythe*underlyingDBMS,theWFSshallskipanyfeaturewithan*unsupportedSRSandcontinue*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:attribute&gt;*&lt;/xsd:complexType&gt;**</code>*</pre>**@generated*/publicclassInsertElementTypeBindingextendsAbstractComplexEMFBinding{WfsFactorywfsfactory;publicInsertElementTypeBinding(WfsFactorywfsfactory){this.wfsfactory=wfsfactory;
ifansrsNameissetforthisgeometry,putitinthecontextfor//children,sotheycanuseitaswell
if(node.hasAttribute("srsName")){try{CoordinateReferenceSystemcrs=GML2ParsingUtils.crs(node);
if(crs!=null){context.registerComponentInstance(CoordinateReferenceSystem.class,crs);
if(node.hasChild(FeatureCollection.class)){SimpleFeatureCollectionfc=(SimpleFeatureCollection)node.getChildValue(FeatureCollection.class);insertElement.getFeature().addAll(DataUtilities.list(fc));
else
if(node.hasChild(SimpleFeature.class)){insertElement.getFeature().addAll(node.getChildValues(SimpleFeature.class));
if(node.hasAttribute("idgen")){insertElement.setIdgen((IdentifierGenerationOptionType)node.getAttributeValue("idgen"));
if(node.hasAttribute("handle")){insertElement.setHandle((String)node.getAttributeValue("handle"));
if(node.hasAttribute("inputFormat")){insertElement.setInputFormat((String)node.getAttributeValue("inputFormat"));
if(node.hasAttribute("srsName")){insertElement.setSrsName((URI)node.getAttributeValue("srsName"));
if(GML._Feature.equals(name)){returninsert.getFeature();
if(properties==null)properties=newProperties();returnproperties;
if(o==null)return1;
if(getAuthority().equals(o.getAuthority())){
if(getUserName()==null&&o.getUserName()==null)return0;
if(getUserName()==null)return-1;
if(o.getUserName()==null)return1;returngetUserName().compareTo(o.getUserName());
if(obj==null)returnfalse;
if(objinstanceofString&&getUserName()==null){returnequalsWithoutUserName(obj);
if(objinstanceofGrantedAuthority&&getUserName()==null){
if(objinstanceofGeoServerRole==false)returnequalsWithoutUserName(obj);
if(objinstanceofGeoServerRole){returncompareTo((GeoServerRole)obj)==0;
if(objinstanceofString){returnobj.equals(this.role);
if(getUserName()!=null)hash+=getUserName().hashCode();returnhash;
if(getUserName()!=null){StringBufferbuff=newStringBuffer(role);buff.append("foruser").append(getUserName());returnbuff.toString();
elsereturnrole;
if(RepositoryResolver.resolverAvailableForURIScheme("file")){CONFIG_LIST.add(DIRECTORY_CONFIG);
if(RepositoryResolver.resolverAvailableForURIScheme("postgresql")){CONFIG_LIST.add(PG_CONFIG);
if(!CONFIG_LIST.isEmpty()){DEFAULT_CONFIG=CONFIG_LIST.get(0);
else{DEFAULT_CONFIG=NO_DEFAULT_AVAILABLE;
if(null==repoModel||null==repoModel.getObject()||null==repoModel.getObject().getLocation()){type=DEFAULT_CONFIG;
if(type==null){//getthetypefromthemodelRepositoryInforepo=repoModel.getObject();URIlocation=repo!=null?repo.getLocation():null;type=getType(location);
if(repoModel!=null){repoModel.detach();
if(location!=null){
if(null!=location.getScheme()){
switch(location.getScheme()){case"postgresql":returnPG_CONFIG;case"file":returnDIRECTORY_CONFIG;
if(null!=defaultConfig){DEFAULT_CONFIG=defaultConfig;
else{DEFAULT_CONFIG=NO_DEFAULT_AVAILABLE;
ifthetimeoutexpired,andthrowsanexception*incaseitis**@param<T>*@param<F>*/classTimeoutFeatureCollection<TextendsFeatureType,FextendsFeature>implementsFeatureCollection<T,F>{/***Wrapsafeaturecollectionintoatimingoutdecorator,keepingits{@linkSimpleFeature}*nature
ifpossible**@param<R>*@paramtimeoutVerifier*@paramfc*@return*/publicstaticFeatureCollectionwrap(TimeoutVerifiertimeoutVerifier,FeatureCollectionfc){
if(fcinstanceofSimpleFeatureCollection){returnnewSimpleTimeoutCollection(timeoutVerifier,fc);
else{returnnewTimeoutFeatureCollection<>(timeoutVerifier,fc);
if(session==null){response.getWriter().write("Unabletocreatesession");response.setStatus(500);
else{response.setHeader("Location",URI.create(request.getRequestURL().toString()+"/"+Long.toString(session.getId())).toString());response.getWriter().write(Long.toString(session.getId()));response.setStatus(201);
if(result!=null){w.write(result.toString());
if(t.getCause()!=null){t=t.getCause();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Scripterror",e);
if(headerName==null&&headerValue==null){//Nomoreheadersbreak;
if(hName.equalsIgnoreCase(headerName)){result.add(headerValue);
if(c.getName().equalsIgnoreCase(cookieName))returnc;
if(buff.length()>0)buff.append("&");buff.append(entry.getKey()).append("=").append(URLEncoder.encode(entry.getValue(),"utf-8"));
if(!secure)returntrue;
if(ticketGrantingCookie==null)returntrue;URLlogoutUrl=createURLFromCasURI(GeoServerCasConstants.LOGOUT_URI);HttpURLConnectionconn=(HttpURLConnection)logoutUrl.openConnection();addCasCookies(conn);conn.getInputStream().close();extractCASCookies(getCookies(conn),conn);returngetTicketGrantingCookie()!=null&&"\"\"".equals(getTicketGrantingCookie().getValue());
if(checkCookieForSend(warningCookie))cookieString=warningCookie.toString();
if(checkCookieForSend(ticketGrantingCookie)){
if(cookieString.length()>0)cookieString+=",";cookieString+=ticketGrantingCookie.toString();
if(cookieString.length()>0)conn.setRequestProperty("Cookie",cookieString);
if(cookie==null)returnfalse;
if(cookie.hasExpired())returnfalse;
if(isSecure()==false&&cookie.getSecure()){returnfalse;
if(getTicketGrantingCookie()==null||getTicketGrantingCookie().getValue().isEmpty()){thrownewIOException("navalidTGC");
if(values.isEmpty()){thrownewIOException("Noredirectreceivedfor"+loginUrl);
if("ticket".equalsIgnoreCase((tmp[0]).trim())){ticket=tmp[1].trim();break;
if(process!=null){currentTime=process.getKernelTime()+process.getUserTime();
if(previousTime!=-1){timeDifference=currentTime-previousTime;intprocessors=pr.getLogicalProcessorCount();
if(processors>0){cpuUsage=(100d*(timeDifference/((double)1000)))/pr.getLogicalProcessorCount();
else{cpuUsage=-1;
else{processExists=false;
switch(info){//systemmetricscaseOPERATING_SYSTEM:{MetricValuemv=newMetricValue(info);mv.setAvailable(true);mv.setValue(os.getFamily()+""+os.getVersion().getVersion());si=Collections.singletonList(mv);break;
if(lv>0){mv.setAvailable(true);mv.setValue(lv);si=Collections.singletonList(mv);
if(lv>0){mv.setAvailable(true);mv.setValue(lv);si=Collections.singletonList(mv);
if(lv>0){mv.setAvailable(true);mv.setValue(lv);si=Collections.singletonList(mv);
if(cpuLoad>=0){mv.setAvailable(true);mv.setValue(cpuLoad*100.0);mv.setDescription("CPUloadaverage");si=Collections.singletonList(mv);
if(loads.length>0){for(inti=0;i<loads.length;i++){doublevalue=loads[i]*100.0;Stringdescription="CPU"+(i+1)+"load";MetricValuemv=newMetricValue(info);mv.setValue(value);mv.setAvailable(true);mv.setDescription(description);mv.setPriority(info.getPriority()+i);mv.setIdentifier("CPU"+(i+1));si.add(mv);
if(total>0.0){doubleused=total-mm.getAvailable();mv.setValue((used/total)*100);
else{mv.setValue(0);
if(total>0.0){doubleused=mm.getSwapUsed();mv.setValue(used/total*100);
else{mv.setValue(0);
if(fss.length>0){doubletotal=0;doubleused=0;for(inti=0;i<fss.length;i++){OSFileStorefs=fss[i];doublefsTotal=fs.getTotalSpace();total+=fsTotal;used+=fsTotal-fs.getUsableSpace();
if(total>0.0){mv.setValue(used/total*100);
else{mv.setValue(0);
if(fss.length>0){si=newArrayList<>();for(inti=0;i<fss.length;i++){OSFileStorefs=fss[i];MetricValuemv=newMetricValue(info);doubletotal=fs.getTotalSpace();
if(total>0.0){doubleused=total-fs.getUsableSpace();mv.setValue(used/total*100);
else{mv.setValue(0);
if(fss.length>0){si=newArrayList<>();for(inti=0;i<fss.length;i++){OSFileStorefs=fss[i];MetricValuemv=newMetricValue(info);mv.setValue(fs.getTotalSpace());mv.setAvailable(true);mv.setDescription("Partition["+fs.getName()+"]totalspace");mv.setPriority(info.getPriority()+(i+1)*3);mv.setIdentifier(fs.getName());si.add(mv);
if(fss.length>0){si=newArrayList<>();for(inti=0;i<fss.length;i++){OSFileStorefs=fss[i];MetricValuemv=newMetricValue(info);mv.setValue(fs.getUsableSpace());mv.setAvailable(true);mv.setDescription("Partition["+fs.getName()+"]freespace");mv.setPriority(info.getPriority()+(i+1)*3);mv.setIdentifier(fs.getName());si.add(mv);
if(nis.length>0){doubletotal=0;for(inti=0;i<nis.length;i++){NetworkIFni=nis[i];ni.updateNetworkStats();total+=ni.getBytesSent();
if(nis.length>0){doubletotal=0;for(inti=0;i<nis.length;i++){NetworkIFni=nis[i];ni.updateNetworkStats();total+=ni.getBytesRecv();
if(nis.length>0){si=newArrayList<>();for(inti=0;i<nis.length;i++){NetworkIFni=nis[i];ni.updateNetworkStats();MetricValuemv=newMetricValue(info);mv.setValue(ni.getBytesSent());mv.setAvailable(true);mv.setDescription("Networkinterface["+ni.getName()+"]send");mv.setPriority(info.getPriority()+(i+1)*3);mv.setIdentifier(ni.getName());si.add(mv);
if(nis.length>0){si=newArrayList<>();for(inti=0;i<nis.length;i++){NetworkIFni=nis[i];ni.updateNetworkStats();MetricValuemv=newMetricValue(info);mv.setValue(ni.getBytesRecv());mv.setAvailable(true);mv.setDescription("Networkinterface["+ni.getName()+"]received");mv.setPriority(info.getPriority()+(i+1)*3);mv.setIdentifier(ni.getName());si.add(mv);
if(value>0){MetricValuemv=newMetricValue(info);mv.setAvailable(true);mv.setValue(value);si=Collections.singletonList(mv);
if(value>0){MetricValuemv=newMetricValue(info);mv.setAvailable(true);mv.setValue(value);si=Collections.singletonList(mv);
if(speeds.length>0){ArrayList<MetricValue>tmp=newArrayList<>(speeds.length);for(inti=0;i<speeds.length;i++){
if(speeds[i]>0){intvalue=speeds[i];Stringname=info.name()+"_"+(i+1);Stringdescription="Speedfan"+(i+1);MetricValuemv=newMetricValue(info);mv.setValue(value);mv.setAvailable(true);mv.setDescription(description);mv.setName(name);tmp.add(mv);
if(!tmp.isEmpty()){si=tmp;
if(cpuUsage>=0.0){MetricValuemv=newMetricValue(info);mv.setAvailable(true);mv.setValue(cpuUsage);si=Collections.singletonList(mv);
if(total>0.0){doublevalue=100d*gsProc.getResidentSetSize()/total;mv.setValue(value);
else{mv.setValue(0);
if(tx==null){converter.transformChain(builder,task(importId,taskId),true,converter.expand(expand,1));
else{ImportTasktask=task(importId,taskId);intindex=task.getTransform().getTransforms().indexOf(tx);converter.transform(builder,tx,index,task,true,converter.expand(expand,1));
if(result){returnnewResponseEntity<String>("",HttpStatus.OK);
else{returnnewResponseEntity<String>("",HttpStatus.NOT_FOUND);
if(isNew){WhitelistRulerule=(WhitelistRule)form.getModelObject();table.add(rule);
if(bboxForEachCRS!=null){returnbboxForEachCRS;
ifupgradingfrom2.1.xBooleanbool=getMetadata().get("bboxForEachCRS",Boolean.class);returnbool!=null&&bool;
if(r==(rowLimit-1)&&i.hasNext()){//therearemorefeaturesthanrowsavailableinthis//Excelformat.writeoutawarninglineandbreakRichTextStringrowWarning=helper.createRichTextString(TRUNCATE_WARNING+":ROWS"+r+"-"+fc.size()+"NOTSHOWN");cell.setCellValue(rowWarning);cell.setCellStyle(styles.getWarningStyle());break;
if(att!=null){cell=row.createCell(j+1);
if(attinstanceofNumber){cell.setCellValue(((Number)att).doubleValue());
else
if(attinstanceofDate){cell.setCellValue((Date)att);cell.setCellStyle(styles.getDateStyle());
else
if(attinstanceofCalendar){cell.setCellValue((Calendar)att);cell.setCellStyle(styles.getDateStyle());
else
if(attinstanceofBoolean){cell.setCellValue((Boolean)att);
else{//ok,itseemswehavenobetterwaythandumpitasastringStringstringVal=att.toString();//
ifstringlength>excelcelllimit,truncateitandwarnthe//user,otherwiseexcelworkbookwillbecorrupted
if(stringVal.length()>CELL_CHAR_LIMIT){stringVal=TRUNCATE_WARNING+""+stringVal.substring(0,CELL_CHAR_LIMIT-TRUNCATE_WARNING.length()-1);cell.setCellStyle(styles.getWarningStyle());
if(namespaceURI.equals("http://www.w3.org/1999/xlink")){try{LSInputinput=((DOMImplementationLS)dom.getImplementation()).createLSInput();URLxlink=getClass().getResource("/schemas/xlink/1999/xlink.xsd");systemId=xlink.toURI().toASCIIString();input.setPublicId(publicId);input.setSystemId(systemId);returninput;
else
if(XML.NAMESPACE.equals(namespaceURI)){try{LSInputinput=((DOMImplementationLS)dom.getImplementation()).createLSInput();URLxml=XML.class.getResource("xml.xsd");systemId=xml.toURI().toASCIIString();input.setPublicId(publicId);input.setSystemId(systemId);returninput;
else{returnnull;
ifanonsupportedformatisrequested,thedefault{@codetext/xml}representationshall*bereturned.TheresponseContent-Typeheadershallalsobe{@codetext/xml}*/@TestpublicvoidtestRequestOptionalFormatParameter()throwsException{MockHttpServletResponseresponse;Stringpath="ows?service=WMS&request=GetCapabilities&version=1.3.0";response=getAsServletResponse(path);assertEquals("WMS_Capabilities",getAsDOM(path).getDocumentElement().getNodeName());assertEquals("text/xml",response.getContentType());path="ows?service=WMS&request=GetCapabilities&version=1.3.0&format=text/xml";response=getAsServletResponse(path);assertEquals("WMS_Capabilities",getAsDOM(path).getDocumentElement().getNodeName());assertEquals("text/xml",response.getContentType());path="ows?service=WMS&request=GetCapabilities&version=1.3.0&format=application/unsupported";response=getAsServletResponse(path);assertEquals("WMS_Capabilities",getAsDOM(path).getDocumentElement().getNodeName());assertEquals("text/xml",response.getContentType());
ifclientspecifiesUPDATESEQUENCE**<p>ThistestassumesGeoServerdeliversnumeric(integer){@codeupdateSequence}values*/@TestpublicvoidtestRequestUpdateSequence()throwsException{Documentdom=getAsDOM("ows?service=WMS&request=GetCapabilities&version=1.3.0");finalXpathEnginexpath=XMLUnit.newXpathEngine();finalStringlocationPath="/wms:WMS_Capabilities/@updateSequence";finalStringupdateSeq=xpath.evaluate(locationPath,dom);finalintcurrUpdateSeq=Integer.parseInt(updateSeq);/**Client:none,Server:any,response:current*/dom=getAsDOM("ows?service=WMS&request=GetCapabilities&version=1.3.0");assertXpathEvaluatesTo(updateSeq,locationPath,dom);/**Client:any,Server:none,response:current.Can'timplementthisasatestcause*GeoServerwillalwayshaveaninternalupdatesequence*///can'ttest/**Client:equal,Server:equal,response:exceptioncode=CurrentUpdateSequence*/dom=getAsDOM("ows?service=WMS&request=GetCapabilities&version=1.3.0&updateSequence="+updateSeq);print(dom);assertXpathEvaluatesTo("1.3.0","/ogc:ServiceExceptionReport/@version",dom);assertXpathEvaluatesTo("CurrentUpdateSequence","/ogc:ServiceExceptionReport/ogc:ServiceException/@code",dom);/**Client:lower,Server:higher,response:current*/dom=getAsDOM("ows?service=WMS&request=GetCapabilities&version=1.3.0&updateSequence="+(currUpdateSeq-1));assertXpathEvaluatesTo(updateSeq,locationPath,dom);/**Client:higher,Server:lower,response:exceptioncode=InvalidUpdateSequence*/dom=getAsDOM("ows?service=WMS&request=GetCapabilities&version=1.3.0&updateSequence="+(currUpdateSeq+1));assertXpathEvaluatesTo("InvalidUpdateSequence","/ogc:ServiceExceptionReport/ogc:ServiceException/@code",dom);}}
if(commandinstanceofLsRemoteOp){LsRemoteOplsRemote=(LsRemoteOp)command;Optional<Remote>remote=lsRemote.getRemote();
if(remote.isPresent()){Stringurl=remote.get().getFetchURL();checkRestricted(url);
else
if(commandinstanceofCloneOp){CloneOpcloneOp=(CloneOp)command;URIurl=cloneOp.getRemoteURI();
if(null!=url){checkRestricted(url.toString());
else
if(commandinstanceofFetchOp){FetchOpfetchOp=(FetchOp)command;for(Remoter:fetchOp.getRemotes()){checkRestricted(r.getFetchURL());
else
if(commandinstanceofPushOp){PushOppushOp=(PushOp)command;Optional<Remote>remote=pushOp.getRemote();
if(remote.isPresent()){Stringurl=remote.get().getPushURL();checkRestricted(url);
if(!rules.isEmpty()){for(WhitelistRulerule:rules){
if(!ruleBlocks(rule,remoteUrl)){return;//breakfast
ifanyoftherulesdoesn'tblocktheurl
if(host==null||parsed.getProtocol()==null||parsed.getProtocol().equals("file")){returnfalse;
if(rule.isRequireSSL()&&!parsed.getProtocol().equals("https")){returntrue;
if(pattern.startsWith("[.*]")){finalStringeffectivePattern=rule.getPattern().substring("[.*]".length());return!host.endsWith(effectivePattern);
else{Matchermatcher=IP_ADDRESS_OR_CIDR_RANGE.matcher(pattern);StringeffectiveHost;
if(host.startsWith("[")&&host.endsWith("]")){//signifiesipv6addresseffectiveHost=host.substring(1,host.length()-1);
else{effectiveHost=host;
if(matcher.matches()){try{IpAddressMatcheripMatcher=newIpAddressMatcher(matcher.group());return!ipMatcher.matches(effectiveHost);
else{return!host.equalsIgnoreCase(pattern);
if(!Resources.exists(legend)){StringlegendLayout=IOUtils.toString(OpenLayersPreviewPanel.class.getResourceAsStream("style-editor-legend.xml"));OutputStreamos=legend.out();try{IOUtils.write(legendLayout,os);
if(StringUtils.isEmpty(proxyBaseUrl)){GeoServergs=stylePage.getGeoServer();proxyBaseUrl=gs.getGlobal().getSettings().getProxyBaseUrl();
if(StringUtils.isEmpty(proxyBaseUrl)){Requestr=getRequest();UrlclientUrl=r.getClientUrl();styleUrl=clientUrl.getProtocol()+"://"+clientUrl.getHost()+":"+clientUrl.getPort()+r.getContextPath();
else{styleUrl=proxyBaseUrl;
else{styleUrl=proxyBaseUrl;
if(workspace!=null){context.put("styleWorkspace",workspace.getName());styleUrl=styleUrl+"/"+workspace.getName();
if(baseUrl.endsWith("/")){returnbaseUrl.substring(0,baseUrl.length()-1);
else{returnbaseUrl;
if(dir.name().equals("apps")){
if(file.getType()==Type.DIRECTORY){ResourcemainFile=scriptManager.findAppMainScript(file);
if(mainFile!=null){Scriptscript=newScript(mainFile);scripts.add(script);
else{LOGGER.info("Couldnotfindmainappfilein"+file.path());
else
if(dir.name().equals("wps")){
if(file.getType()==Type.DIRECTORY){List<Resource>fs=file.list();for(Resourcef:fs){scripts.add(newScript(f));
else{scripts.add(newScript(file));
else{scripts.add(newScript(file));
if(!EObject.class.isAssignableFrom(requestBean)){Stringmsg="RequestbeanmustbeanEObject";thrownewIllegalArgumentException(msg);
if(index!=-1){className=className.substring(index+1);
if(filter(property)){continue;
if(EMFUtils.has(eObject,property)){try{setValue(eObject,property,value);
ifthetargetisa*collection,settingitotherwise.Subclassescanoverridethisbehavior*/protectedvoidsetValue(EObjecteObject,Stringproperty,Objectvalue){//checkforacollection
if(EMFUtils.isCollection(eObject,property)){EMFUtils.add(eObject,property,value);
else{EMFUtils.set(eObject,property,value);
if(mm!=null){Assert.isTrue(mm.getName().matches(resourceName));
else{LOGGER.log(Level.WARNING,"Unabletotestwiththisresourcename:"+resourceName+"\nNoresourcefound.");
if(mm==null){LOGGER.log(Level.WARNING,"Unabletotestwiththisresourcename:"+resourceName+"\nNoresourcefound.");return;
if(!it.hasNext()){LOGGER.log(Level.WARNING,"Unabletotestwiththisresourcenamewhichdoesnothasproperties.");return;
if(mm==null){LOGGER.log(Level.WARNING,"Unabletotestwiththisresourcename:"+resourceName+"\nNoresourcefound.");return;
if(!it.hasNext()){LOGGER.log(Level.WARNING,"Unabletotestwiththisresourcenamewhichdoesnothasproperties.");return;
ifit'sthere.FilerootMonitor=newFile(".","manifest.properties");
if(rootMonitor.exists()){rootMonitor.delete();
if(mm==null){LOGGER.log(Level.WARNING,"Unabletotestwiththisresourcename:"+resourceName+"\nNoresourcefound.");return;
if(!it.hasNext()){LOGGER.log(Level.WARNING,"Unabletotestwiththisresourcenamewhichdoesnothasproperties.");return;
if(props.get(k).equals(oldValue)){continue;
if(key.equals(ConnectionConfiguration.CONNECTION_KEY)){//CONNECTIONcontroller.connectClient(Boolean.getBoolean(value));
else
if(key.equals(ToggleConfiguration.TOGGLE_MASTER_KEY)){//toggleMASTERcontroller.toggle(Boolean.getBoolean(value),ToggleType.MASTER);
else
if(key.equals(ToggleConfiguration.TOGGLE_SLAVE_KEY)){//toggleSLAVEcontroller.toggle(Boolean.getBoolean(value),ToggleType.SLAVE);
else
if(key.equals(JMSConfiguration.INSTANCE_NAME_KEY)){//InstanceNamecontroller.setInstanceName(value);
else
if(key.equals(BrokerConfiguration.BROKER_URL_KEY)){//BROKER_URLcontroller.setBrokerURL(value);
else
if(key.equals(ReadOnlyConfiguration.READ_ONLY_KEY)){//ReadOnlycontroller.setReadOnly(Boolean.getBoolean(value));
else
if(key.equals(JMSConfiguration.GROUP_KEY)){//groupcontroller.setGroup(value);
if(errors!=null&&errors.size()>0)throw(Exception)errors.get(0);returncaseInsensitiveKvp(input);
if(wcs.getType()!=Type.DIRECTORY){return;//nothingtocleanup
if(now-f.lastmodified()>(expirationDelay*1000)){f.delete();
if(httpRequest!=null){request.setRequestCharset(httpRequest.getCharacterEncoding());request.setGet("GET".equalsIgnoreCase(httpRequest.getMethod()));List<String>headerNames=(List<String>)EnumerationUtils.toList(httpRequest.getHeaderNames());for(StringheaderName:headerNames){request.putHttpRequestHeader(headerName,httpRequest.getHeader(headerName));
if(kvp.containsKey("crs")){getMap.setSRS((String)kvp.get("crs"));
if(epsgCode!=null){try{//setthecrsaswellCoordinateReferenceSystemmapcrs=CRS.decode(epsgCode);getMap.setCrs(mapcrs);
if(remoteOwsType!=null&&!"WFS".equals(remoteOwsType)){thrownewServiceException("UnsupportedremoteOWStype'"+remoteOwsType+"'");
if(remoteOwsUrl!=null&&remoteOwsType==null){thrownewServiceException("REMOTE_OWS_URLspecified,butREMOTE_OWS_TYPEismissing");
if(layerParam!=null){List<String>layerNames=KvpUtils.readFlat(layerParam);requestedLayerInfos.addAll(parseLayers(layerNames,remoteOwsUrl,remoteOwsType));
if(stylesParam!=null){styleNameList.addAll(KvpUtils.readFlat(stylesParam));
if(interpolationParam!=null){interpolationList.addAll(KvpUtils.readFlat(interpolationParam));
if(skipResource(o)){//removethelayer,style,interpolation,filterandcql_filterrequestedLayerInfos.remove(i);
if(i<styleNameList.size()){styleNameList.remove(i);
if(i<interpolationList.size()){interpolationList.remove(i);
if(i<rawFilters.size()){rawFilters.remove(i);
if(i<cqlFilters.size()){cqlFilters.remove(i);
if(i<rawSortBy.size()){rawSortBy.remove(i);
else{
if(oinstanceofLayerInfo){newLayers.add(newMapLayerInfo((LayerInfo)o));
else
if(oinstanceofLayerGroupInfo){for(LayerInfol:((LayerGroupInfo)o).layers()){newLayers.add(newMapLayerInfo(l));
else
if(oinstanceofMapLayerInfo){//itwasaremoteOWSlayer,additdirectlynewLayers.add((MapLayerInfo)o);
if(interpolationList.size()>0){getMap.setInterpolations(parseInterpolations(requestedLayerInfos,interpolationList));
if((getMap.getSldBody()!=null||getMap.getSld()!=null)&&wms.isDynamicStylingDisabled()){thrownewServiceException("Dynamicstyleusageisforbidden");
if(getMap.getSldBody()!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("GettinglayersandstylesfromSLD_BODY");
if(getMap.getValidateSchema().booleanValue()){ByteArrayInputStreamstream=newByteArrayInputStream(getMap.getSldBody().getBytes());Listerrors=validateStyle(stream,getMap);
if(errors.size()!=0){thrownewServiceException(SLDValidator.getErrorMessage(newByteArrayInputStream(getMap.getSldBody().getBytes()),errors));
else
if(getMap.getSld()!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("GettinglayersandstylesfromreomteSLD");
if(getMap.getValidateSchema().booleanValue()){InputStreaminput=Requests.getInputStream(styleUrl);Listerrors=null;try{errors=validateStyle(input,getMap);
if((errors!=null)&&(errors.size()!=0)){input=Requests.getInputStream(styleUrl);try{thrownewServiceException(SLDValidator.getErrorMessage(input,errors));
if(ex.getCause()instanceofSAXException){
if(ex.getCause().getMessage().contains("Entityresolutiondisallowed")){throwex;
if(LOGGER.isLoggable(l)){thrownewServiceException("ErrorwhilegettingSLD.Seethelogfordetails.");
else{thrownewServiceException("ErrorwhilegettingSLD.");
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("GettinglayersandstylesfromLAYERSandSTYLES");
if(styleNameList.size()>0){List<Style>parseStyles=parseStyles(styleNameList);getMap.setStyles(parseStyles);
if(isParseStyle()&&requestedLayerInfos.size()>0){List<Style>oldStyles=getMap.getStyles()!=null?newArrayList(getMap.getStyles()):newArrayList();List<Style>newStyles=newArrayList<Style>();List<Filter>newFilters=filters==null?null:newArrayList<>();List<List<SortBy>>newSortBy=sortBy==null?null:newArrayList<>();for(inti=0;i<requestedLayerInfos.size();i++){Objecto=requestedLayerInfos.get(i);Stylestyle=oldStyles.isEmpty()?null:(Style)oldStyles.get(i);
if(oinstanceofLayerGroupInfo){LayerGroupInfogroupInfo=(LayerGroupInfo)o;List<LayerInfo>layers=groupInfo.layers();List<StyleInfo>styles=groupInfo.styles();for(intj=0;j<styles.size();j++){StyleInfosi=styles.get(j);
if(si!=null){newStyles.add(si.getStyle());
else{LayerInfolayer=layers.get(j);newStyles.add(getDefaultStyle(layer));
if(filters!=null){for(intj=0;j<layers.size();j++){newFilters.add(getFilter(filters,i));
if(sortBy!=null){for(intj=0;j<layers.size();j++){newSortBy.add(getSortBy(sortBy,i));
else
if(oinstanceofLayerInfo){style=oldStyles.size()>0?oldStyles.get(i):null;
if(style!=null){newStyles.add(style);
else{LayerInfolayer=(LayerInfo)o;newStyles.add(getDefaultStyle(layer));
ifneeded
if(filters!=null){newFilters.add(getFilter(filters,i));
if(sortBy!=null){newSortBy.add(getSortBy(sortBy,i));
else
if(oinstanceofMapLayerInfo){style=oldStyles.size()>0?oldStyles.get(i):null;
if(style!=null){newStyles.add(style);
else{thrownewServiceException("nostylerequestedforlayer"+((MapLayerInfo)o).getName(),"NoDefaultStyle");
ifneeded
if(filters!=null){newFilters.add(getFilter(filters,i));
if(sortBy!=null){newSortBy.add(getSortBy(sortBy,i));
if(isParseStyle()&&(layers!=null)&&(layers.size()>0)){finalListstyles=getMap.getStyles();
if(layers.size()!=styles.size()){Stringmsg=layers.size()+"layersrequested,butfound"+styles.size()+"stylesspecified.";thrownewServiceException(msg,getClass().getName());
if(currStyle==null)thrownewServiceException("Couldnotfindastyleforlayer"+getMap.getLayers().get(i).getName()+",eithernonewasspecifiedornodefaultstyleisavailableforit","NoDefaultStyle");checkStyle(currStyle,layers.get(i));
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(newStringBuffer("establishing").append(currStyle.getName()).append("stylefor").append(layers.get(i).getName()).toString());
if(mapFilters!=null&&mapFilters.size()!=mapLayers.size()){Stringmsg=mapLayers.size()+"layersrequested,butfound"+mapFilters.size()+"filtersspecified.";thrownewServiceException(msg,getClass().getName());
if(mapSortBy!=null&&mapSortBy.size()!=mapLayers.size()){Stringmsg=mapLayers.size()+"layersrequested,butfound"+mapSortBy.size()+"sortByspecified.";thrownewServiceException(msg,getClass().getName());
if(viewParams!=null&&viewParams.size()>0){intlayerCount=getMap.getLayers().size();//
ifwehavejustonereplicateoveralllayers
if(viewParams.size()==1&&layerCount>1){List<Map<String,String>>replacement=newArrayList<Map<String,String>>();for(inti=0;i<layerCount;i++){replacement.add(viewParams.get(0));
else
if(viewParams.size()!=layerCount){Stringmsg=layerCount+"layersrequested,butfound"+viewParams.size()+"viewparamsspecified.";thrownewServiceException(msg,getClass().getName());
iflayershavetime/elevationsupportbooleanhasTime=false;booleanhasElevation=false;for(MapLayerInfolayer:getMap.getLayers()){
if(layer.getType()==MapLayerInfo.TYPE_VECTOR){MetadataMapmetadata=layer.getResource().getMetadata();DimensionInfoelevationInfo=metadata.get(ResourceInfo.ELEVATION,DimensionInfo.class);hasElevation|=elevationInfo!=null&&elevationInfo.isEnabled();DimensionInfotimeInfo=metadata.get(ResourceInfo.TIME,DimensionInfo.class);hasTime|=timeInfo!=null&&timeInfo.isEnabled();
else
if(layer.getType()==MapLayerInfo.TYPE_RASTER){MetadataMapmetadata=layer.getResource().getMetadata();////Addingacoveragelayer//GridCoverage2DReaderreader;try{reader=(GridCoverage2DReader)layer.getCoverageReader();
if(reader!=null){ReaderDimensionsAccessordimensions=newReaderDimensionsAccessor(reader);DimensionInfoelevationInfo=metadata.get(ResourceInfo.ELEVATION,DimensionInfo.class);hasElevation|=elevationInfo!=null&&elevationInfo.isEnabled()&&dimensions.hasElevation();DimensionInfotimeInfo=metadata.get(ResourceInfo.TIME,DimensionInfo.class);hasTime|=timeInfo!=null&&timeInfo.isEnabled()&&dimensions.hasTime();
ifnothingwasrequested
if(hasTime&&(getMap.getTime()==null||getMap.getTime().isEmpty())){//askfor"CURRENT"getMap.setTime(Arrays.asList((Object)null));
if(hasElevation&&(getMap.getElevation()==null||getMap.getElevation().isEmpty())){//askfor"DEFAULT"getMap.setElevation(Arrays.asList((Object)null));
if((getMap.getElevation()!=null&&getMap.getElevation().size()>1)&&(getMap.getTime()!=null&&getMap.getTime().size()>1)){thrownewServiceException("TIMEandELEVATIONvaluescannotbebothmultivalued");
if(i<interpolationList.size()){StringinterpolationName=interpolationList.get(i);
if(!interpolationName.trim().equals("")){interpolation=getInterpolationObject(interpolationName);
if(oinstanceofLayerInfo){interpolations.add(interpolation);
else
if(oinstanceofLayerGroupInfo){List<LayerInfo>subLayers=((LayerGroupInfo)o).layers();for(LayerInfolayer:subLayers){interpolations.add(interpolation);
else{thrownewIllegalArgumentException("Unknownlayerinfotype:"+o);
if(layer.getResource()instanceofWMSLayerInfo){//NamedStyleisasubclassofStyle->weuseitasawaytoconvey//cascadedWMSlayerstylesNamedStylenamedStyle=CommonFactoryFinder.getStyleFactory(null).createNamedStyle();namedStyle.setName(null);returnnamedStyle;
else{StyleInfodefaultStyle=layer.getDefaultStyle();returndefaultStyle.getStyle();
if(filters.size()==1&&filters.get(0)instanceofId){//featureidfiltersmustbeexpandedtoalllayersreturnfilters.get(0);
else
if(index<filters.size()){returnfilters.get(index);
else{thrownewServiceException("Layersandfiltersaremismatched,"+"youneedtoprovideonefilterforeachlayer");
if(index<items.size()){returnitems.get(index);
else{thrownewServiceException("LayersandsortByaremismatched,"+"youneedtoprovideonesortByforeachlayer");
ifnonewasfound*/privateList<Filter>parseFilters(GetMapRequestgetMap,List<Filter>rawFilters,List<Filter>cqlFilters){List<Filter>filters=rawFilters;ListfeatureId=(getMap.getFeatureId()!=null)?getMap.getFeatureId():Collections.EMPTY_LIST;
if(!featureId.isEmpty()){
if(!filters.isEmpty()){thrownewServiceException("GetMapKVPrequestcontained"+"conflictingfilters.Filter:"+rawFilters+",fid:"+featureId);
if(!cqlFilters.isEmpty()){
if(!filters.isEmpty()){thrownewServiceException("GetMapKVPrequestcontained"+"conflictingfilters.Filter:"+rawFilters+",fid:"+featureId+",cql:"+cqlFilters);
if(filters.size()==0){filters=null;
if(requestedLayers.size()==0){sld.accept(newProcessStandaloneSLDVisitor(wms,request));
else{processLibrarySld(request,sld,requestedLayers,styleNames);
ifastylenamed�CenterLine�is*referencedforalayerandastylewiththatnameisdefinedforthecorrespondinglayerin*theSLD,thentheSLDstyledefinitionisused.Otherwise,thestandardnamed-stylemechanism*builtintothemapserverisused.Iftheuseofadefaultstyleisspecifiedandastyleis*markedasbeingthedefaultforthecorrespondinglayerintheSLD,thenthedefaultstyle*fromtheSLDisused;otherwise,thestandarddefaultstyleinthemapserverisused.*</cite>**@paramrequesttheGetMaprequesttowhichtosetthelayersandstyles*@paramsldaSLDdocumenttotakelayersandstylesfrom,followingthe"literal"or*"library"rule.*@paramrequestedLayersthelistof{@linkLayerInfo}and{@linkLayerGroupInfo}asrequested*bytheLAYERSparam*@paramstyleNamesthelistofrequestedstylenames*/privatevoidprocessLibrarySld(finalGetMapRequestrequest,finalStyledLayerDescriptorsld,finalList<?>requestedLayers,List<String>styleNames)throwsServiceException,IOException{finalStyledLayer[]styledLayers=sld.getStyledLayers();finalintslCount=styledLayers.length;
if(slCount==0){thrownewServiceException("SLDdocumentcontainsnolayers");
if(styleNames!=null&&styleNames.size()>0){styleName=styleNames.get(i);
if(oinstanceofLayerInfo){currLayer=newMapLayerInfo((LayerInfo)o);
if(styledLayers[i]instanceofNamedLayer){NamedLayernamedLayer=((NamedLayer)styledLayers[i]);currLayer.setLayerFeatureConstraints(namedLayer.getLayerFeatureConstraints());
else
if(oinstanceofLayerGroupInfo){List<LayerInfo>subLayers=((LayerGroupInfo)o).layers();for(LayerInfolayer:subLayers){currLayer=newMapLayerInfo(layer);layers.add(currLayer);Stylestyle=findStyleOf(request,currLayer,styleName,styledLayers);styles.add(style);
else{thrownewIllegalArgumentException("Unknownlayerinfotype:"+o);
if(currLayer==null){return;//protection
if(layerinstanceofNamedLayer){layerStyles=((NamedLayer)layer).getStyles();
else
if(layerinstanceofUserLayer){layerStyles=((UserLayer)layer).getUserStyles();
if((layerStyles==null)||(layerStyles.length==0)){layers.add(currLayer);styles.add(currLayer.getDefaultStyle());return;
if(layerStyles[t]instanceofNamedStyle){layers.add(currLayer);s=findStyle(wms,request,(layerStyles[t]).getName());
if(s==null){thrownewServiceException("couldn'tfindstylenamed'"+(layerStyles[t]).getName()+"'");
else{layers.add(currLayer);styles.add(layerStyles[t]);
ifsucha*styledoesnotexistonthisserver.*@throwsIOException*/privatestaticStylefindStyle(finalWMSwms,GetMapRequestrequest,StringcurrStyleName)throwsIOException{//StylecurrStyle;//MapconfiguredStyles=request.getWMS().getData().getStyles();////currStyle=(Style)configuredStyles.get(currStyleName);////returncurrStyle;returnwms.getStyleByName(currStyleName);
if<code>styledLayers</code>hasnoaUserLayeroraNamedLayerwiththesamenamethan*<code>layer</code>**<p>ThismethodisusedtoparsethestyleofalayerforSLDandSLD_BODYparameters,bothin*libraryandliteralmode.Thus,oncethedeclaredstyleforthegivenlayerisfound,itis*checkedforvalidityofapplianceforthatlayer(i.e.,whetherthefeaturetypecontainsthe*attributesneededforexecutingthestylefilters).**@paramrequestusedtofindoutaninternallyconfiguredstylewhenreferencedbynamebya*NamedLayer*@paramlayeroneofthelayersthatwasrequestedthroughtheLAYERSparameterorthroughand*SLDdocumentwhentherequestisinliteralmode.*@paramstyledLayersasetofStyledLayersfromwheretofindtheSLDlayerwiththesamename*as<code>layer</code>andextractthestyletoapply.*@returntheStyleapplicableto<code>layer</code>extractedfrom<code>styledLayers</code>.*@throwsRuntimeException
ifoneoftheStyledLayersisneitheraUserLayernoraNamedLayer.*Thisshuoldn'thappen,sincetheonlyallowedsubinterfacesofStyledLayerareNamedLayer*andUserLayer.*@throwsServiceException*@throwsIOException*/privateStylefindStyleOf(GetMapRequestrequest,MapLayerInfolayer,StringstyleName,StyledLayer[]styledLayers)throwsServiceException,IOException{Stylestyle=null;StringlayerName=layer.getName();StyledLayersl;for(inti=0;i<styledLayers.length;i++){sl=styledLayers[i];
if(layerName.equals(sl.getName())){
if(slinstanceofUserLayer){Style[]styles=((UserLayer)sl).getUserStyles();//
ifthestylenamehasnotbeenspecified,lookitup//thedefaultstyle,otherwiselookuptheonerequestedfor(intj=0;style==null&&styles!=null&&j<styles.length;j++){
if(styleName==null||styleName.equals("")&&styles[j].isDefault())style=styles[j];
else
if(styleName!=null&&styleName.equals(styles[j].getName()))style=styles[j];
else
if(slinstanceofNamedLayer){Style[]styles=((NamedLayer)sl).getStyles();//
ifthestylenamehasnotbeenspecified,lookitup//thedefaultstyle,otherwiselookuptheonerequestedfor(intj=0;style==null&&styles!=null&&j<styles.length;j++){
if((styleName==null||styleName.equals(""))&&styles[j].isDefault())style=styles[j];
else
if(styleName!=null&&styleName.equals(styles[j].getName()))style=styles[j];
if(styleinstanceofNamedStyle){style=findStyle(wms,request,style.getName());
else{thrownewRuntimeException("Unknownlayertype:"+sl);
ifthestyleisnotfoundfind//thefirststylethatmatchesthetypename//TODO:wouldbenicetohavea
switchtoturnthisoffsinceit'soutofthespec
if(style==null&&laxStyleMatchAllowed){for(inti=0;i<styledLayers.length;i++){sl=styledLayers[i];
if(layerName.equals(sl.getName())){
if(slinstanceofUserLayer){Style[]styles=((UserLayer)sl).getUserStyles();
if((null!=styles)&&(0<styles.length)){style=styles[0];
else
if(slinstanceofNamedLayer){Style[]styles=((NamedLayer)sl).getStyles();
if((null!=styles)&&(0<styles.length)){style=styles[0];
if(styleinstanceofNamedStyle){style=findStyle(wms,request,style.getName());
else{thrownewRuntimeException("Unknownlayertype:"+sl);
if(style==null){
if(styleName==null||"".equals(styleName)){style=layer.getDefaultStyle();
if(style==null)thrownewServiceException("Couldnotfindadefaultstylefor"+layer.getName());
else{style=wms.getStyleByName(styleName);
if(style==null){Stringmsg="Nosuchstyle:"+styleName;thrownewServiceException(msg,"StyleNotDefined");
if(mapLayerInfo.getType()==mapLayerInfo.TYPE_RASTER){//REVISIT:hey,don'twehavetocheckitforrastersnowthatwesupportraster//symbolizer?return;
ifarenderingtransformispresentdon'tchecktheattributes,sincetheymaybechanged
if(hasTransformation(style))return;//extractattributesusedinthestyleStyleAttributeExtractorsae=newStyleAttributeExtractor();sae.visit(style);Set<PropertyName>styleAttributes=sae.getAttributes();//see
ifwecancollectanyattributeoutoftheprovidedlayer//Setattributes=newHashSet();FeatureTypetype=null;
if(mapLayerInfo.getType()==MapLayerInfo.TYPE_VECTOR||mapLayerInfo.getType()==MapLayerInfo.TYPE_REMOTE_VECTOR){try{
if(mapLayerInfo.getType()==MapLayerInfo.TYPE_VECTOR)type=mapLayerInfo.getFeature().getFeatureType();
elsetype=mapLayerInfo.getRemoteFeatureSource().getSchema();
if(attName.evaluate(type)==null){thrownewServiceException("TherequestedStylecannotbeusedwiththislayer.Thestylespecifies"+"anattributeof"+attName+"andthelayeris:"+mapLayerInfo.getName());
ifthestylecontainsarenderingtransformation*/privatestaticbooleanhasTransformation(Stylestyle){for(FeatureTypeStylefs:style.featureTypeStyles()){
if(fs.getTransformation()!=null)returntrue;
ifneededDataStoreremoteWFS=null;finalList<String>remoteTypeNames=newArrayList<String>();
if("WFS".equals(remoteOwsType)&&remoteOwsUrl!=null){remoteWFS=connectRemoteWFS(remoteOwsUrl);remoteTypeNames.addAll(Arrays.asList(remoteWFS.getTypeNames()));Collections.sort(remoteTypeNames);
ifthereisany
if(remoteTypeNames.contains(layerName)){SimpleFeatureSourceremoteSource;remoteSource=remoteWFS.getFeatureSource(layerName);
if(remoteSource!=null){layersOrGroups.add(newMapLayerInfo(remoteSource));continue;
if(layerInfo!=null){layersOrGroups.add(layerInfo);
else{LayerGroupInfolayerGroup=wms.getLayerGroupByName(layerName);
if(layerGroup==null||LayerGroupInfo.Mode.CONTAINER.equals(layerGroup.getMode())){thrownewServiceException("Couldnotfindlayer"+layerName,"LayerNotDefined","layers");
if(layerType!=null){//layers.add(buildMapLayerInfo(layerName));//
else{//if(wms.getBaseMapLayers().containsKey(layerName)){//layers.add(buildMapLayerInfo(layerName));//
else{//////////Searchforgroupedlayers(attention:heavyprocess)////////booleanfound=false;//StringcatalogLayerName=null;////for(Iteratorc_keys=catalog.getLayerNames().iterator();c_keys.hasNext();){//catalogLayerName=(String)c_keys.next();////try{//FeatureTypeInfoftype=findFeatureLayer(catalogLayerName);//StringwmsPath=ftype.getWmsPath();////
if((wmsPath!=null)&&wmsPath.matches(".*/"+layerName)){//layers.add(buildMapLayerInfo(catalogLayerName));//found=true;//
if((wmsPath!=null)&&wmsPath.matches(".*/"+layerName)){//layers.add(buildMapLayerInfo(catalogLayerName));//found=true;//
if(layersOrGroups.size()==0){thrownewServiceException("NoLAYERShasbeenrequested",getClass().getName());
if(ftype!=null){//li.setFeature(ftype);//
else{//CoverageInfocv=findCoverageLayer(layerName);//
if(cv!=null){//li.setCoverage(cv);//
else{//
if(wms.getBaseMapLayers().containsKey(layerName)){//StringstyleCsl=(String)wms.getBaseMapStyles().get(layerName);//StringlayerCsl=(String)wms.getBaseMapLayers().get(layerName);//MapLayerInfo[]layerArray=(MapLayerInfo[])parseLayers(KvpUtils//.readFlat(layerCsl),null,null);//ListstyleList=(List)parseStyles(KvpUtils.readFlat(styleCsl));//li.setBase(layerName,newArrayList(Arrays.asList(layerArray)),styleList);//
else{//thrownewServiceException("Layer"+layerName+"couldnotbefound");//
if(Data.TYPE_VECTOR!=layerType){//returnnull;//
else{//ftype=catalog.getFeatureTypeInfo(layerName);//
if(Data.TYPE_RASTER!=layerType){//returnnull;//
else{//cv=catalog.getCoverageInfo(layerName);//
if("".equals(styleName)){//returnnull,thisshouldflagrequestreadertousedefaultfor//theassociatedlayerstyles.add(null);
else{finalStylestyle=wms.getStyleByName(styleName);
if(style==null){Stringmsg="Nosuchstyle:"+styleName;thrownewServiceException(msg,"StyleNotDefined");
if(sourceinstanceofWorkspaceInfo){addWorkspace((WorkspaceInfo)source);
else
if(sourceinstanceofNamespaceInfo){addNamespace((NamespaceInfo)source);
else
if(sourceinstanceofDataStoreInfo){addDataStore((DataStoreInfo)source);
else
if(sourceinstanceofWMTSStoreInfo){addWMTSStore((WMTSStoreInfo)source);
else
if(sourceinstanceofWMSStoreInfo){addWMSStore((WMSStoreInfo)source);
else
if(sourceinstanceofFeatureTypeInfo){addFeatureType((FeatureTypeInfo)source);
else
if(sourceinstanceofCoverageStoreInfo){addCoverageStore((CoverageStoreInfo)source);
else
if(sourceinstanceofCoverageInfo){addCoverage((CoverageInfo)source);
else
if(sourceinstanceofWMSLayerInfo){addWMSLayer((WMSLayerInfo)source);
else
if(sourceinstanceofWMTSLayerInfo){addWMTSLayer((WMTSLayerInfo)source);
else
if(sourceinstanceofLayerInfo){addLayer((LayerInfo)source);
else
if(sourceinstanceofStyleInfo){addStyle((StyleInfo)source);
else
if(sourceinstanceofLayerGroupInfo){addLayerGroup((LayerGroupInfo)source);
if(i>-1){StringnewName=(String)event.getNewValues().get(i);
if(sourceinstanceofWorkspaceInfo){renameWorkspace((WorkspaceInfo)source,newName);
else
if(sourceinstanceofStoreInfo){renameStore((StoreInfo)source,newName);
else
if(sourceinstanceofResourceInfo){renameResource((ResourceInfo)source,newName);
else
if(sourceinstanceofStyleInfo){renameStyle((StyleInfo)source,newName);
else
if(sourceinstanceofLayerGroupInfo){renameLayerGroup((LayerGroupInfo)source,newName);
if(sourceinstanceofStoreInfo){i=event.getPropertyNames().indexOf("workspace");
if(i>-1){WorkspaceInfonewWorkspace=(WorkspaceInfo)event.getNewValues().get(i);ResourceoldDir=dd.get((StoreInfo)source);moveResToDir(oldDir,dd.get(newWorkspace));
if(sourceinstanceofFeatureTypeInfo){i=event.getPropertyNames().indexOf("store");
if(i>-1){StoreInfonewStore=(StoreInfo)event.getNewValues().get(i);ResourceoldDir=dd.get((FeatureTypeInfo)source);ResourcenewDir=dd.get(newStore);moveResToDir(oldDir,newDir);
if(sourceinstanceofLayerGroupInfo){i=event.getPropertyNames().indexOf("workspace");
if(i>-1){finalWorkspaceInfonewWorkspace=(WorkspaceInfo)event.getNewValues().get(i);finalResourceoldRes=dd.config((LayerGroupInfo)source);finalResourcenewDir=dd.getLayerGroups(newWorkspace);moveResToDir(oldRes,newDir);
if(sourceinstanceofCatalog){i=event.getPropertyNames().indexOf("defaultWorkspace");
if(i>-1){WorkspaceInfodefWorkspace=(WorkspaceInfo)event.getNewValues().get(i);//SGdon'tbotherwithadefaultworkspace
ifwedonothaveone
if(defWorkspace!=null){persist(defWorkspace,dd.getWorkspaces("default.xml"));
if(sourceinstanceofWorkspaceInfo){modifyWorkspace((WorkspaceInfo)source);
else
if(sourceinstanceofDataStoreInfo){modifyDataStore((DataStoreInfo)source);
else
if(sourceinstanceofWMTSStoreInfo){modifyWMTSStore((WMTSStoreInfo)source);
else
if(sourceinstanceofWMSStoreInfo){modifyWMSStore((WMSStoreInfo)source);
else
if(sourceinstanceofNamespaceInfo){modifyNamespace((NamespaceInfo)source);
else
if(sourceinstanceofFeatureTypeInfo){modifyFeatureType((FeatureTypeInfo)source);
else
if(sourceinstanceofCoverageStoreInfo){modifyCoverageStore((CoverageStoreInfo)source);
else
if(sourceinstanceofCoverageInfo){modifyCoverage((CoverageInfo)source);
else
if(sourceinstanceofWMSLayerInfo){modifyWMSLayer((WMSLayerInfo)source);
else
if(sourceinstanceofWMTSLayerInfo){modifyWMTSLayer((WMTSLayerInfo)source);
else
if(sourceinstanceofLayerInfo){modifyLayer((LayerInfo)source);
else
if(sourceinstanceofStyleInfo){modifyStyle((StyleInfo)source);
else
if(sourceinstanceofLayerGroupInfo){modifyLayerGroup((LayerGroupInfo)source);
if(sourceinstanceofWorkspaceInfo){removeWorkspace((WorkspaceInfo)source);
else
if(sourceinstanceofNamespaceInfo){removeNamespace((NamespaceInfo)source);
else
if(sourceinstanceofDataStoreInfo){removeDataStore((DataStoreInfo)source);
else
if(sourceinstanceofFeatureTypeInfo){removeFeatureType((FeatureTypeInfo)source);
else
if(sourceinstanceofCoverageStoreInfo){removeCoverageStore((CoverageStoreInfo)source);
else
if(sourceinstanceofCoverageInfo){removeCoverage((CoverageInfo)source);
else
if(sourceinstanceofWMTSStoreInfo){removeWMTSStore((WMTSStoreInfo)source);
else
if(sourceinstanceofWMTSLayerInfo){removeWMTSLayer((WMTSLayerInfo)source);
else
if(sourceinstanceofWMSStoreInfo){removeWMSStore((WMSStoreInfo)source);
else
if(sourceinstanceofWMSLayerInfo){removeWMSLayer((WMSLayerInfo)source);
else
if(sourceinstanceofLayerInfo){removeLayer((LayerInfo)source);
else
if(sourceinstanceofStyleInfo){removeStyle((StyleInfo)source);
else
if(sourceinstanceofLayerGroupInfo){removeLayerGroup((LayerGroupInfo)source);
if(i>-1){WorkspaceInfonewWorkspace=(WorkspaceInfo)newValues.get(i);LOGGER.fine("Movingsettings'"+settings+"toworkspace:"+newWorkspace);moveResToDir(dd.config(settings),dd.get(newWorkspace));
if(variableName!=null&&!variableName.isEmpty()){coverageName=variableName;
if(sampleDimensions!=null&&sampleDimensions.length>0){GridSampleDimensionsampleDimension=sampleDimensions[0];inputUoM=sampleDimension.getUnits();double[]noData=sampleDimension.getNoDataValues();
if(noData!=null&&noData.length>0){noDataValue=noData[0];noDataSet=true;
if(!noDataSet){NoDataContainernoDataProperty=CoverageUtilities.getNoDataProperty(sampleGranule);
if(noDataProperty!=null){noDataValue=noDataProperty.getAsSingleValue();noDataSet=true;
if(variableName!=null&&!variableName.isEmpty()){writer.addVariableAttribute(var,newAttribute(NetCDFUtilities.LONG_NAME,variableName));
if(var.findAttribute(NetCDFUtilities.UNITS)==null){Stringunit=null;booleanhasDefinedUoM=(variableUoM!=null&&!variableUoM.isEmpty());
if(hasDefinedUoM){unit=variableUoM;
else
if(inputUoM!=null){unit=inputUoM.toString();
if(unit!=null){writer.addVariableAttribute(var,newAttribute(NetCDFUtilities.UNITS,unit));
if(inputUoM!=null&&hasDefinedUoM){//ReplacesomecharsfromtheUOMtomakesureitcanbeproperlyparsed//bytheJSRUnitclass.Wecanrefactorthisreplacementbyusingbytescheck//insteadofspecificreplacecalls.StringunitString=variableUoM.replace("","*").replace("-","^-").replace(".","*").replace("m2","m^2").replace("m3","m^3").replace("s2","s^2");try{UnitoutputUoM=SimpleUnitFormat.getInstance().parse(unitString);
if(outputUoM!=null&&!inputUoM.equals(outputUoM)){
if(!inputUoM.isCompatible(outputUoM)){
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("inputunit"+inputUoM.toString()+"andoutputunit"+outputUoM.toString()+"areincompatible.\nNounitconversionwillbeperformed");
else{unitConverter=inputUoM.getConverterTo(outputUoM);
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("Unabletocreateaconverterforthespecifiedunit:"+unitString+"\nNounitconversionwillbeperformed");
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("Unabletoparsethespecifiedunit:"+unitString+"\nNounitconversionwillbeperformed");
ifnameandunitsarecf-compliant
if(checkCompliant(var)){writer.addVariableAttribute(var,newAttribute(NetCDFUtilities.STANDARD_NAME,variableName));
if(dataPacking!=DataPacking.NONE){//Getthedimensionvaluesfromthecoverageandputthemonthemapping//Notethatusingtreesetallowstorespecttheorderingwhenwriting//downtheNetCDFdimensionsstats=newDataPacking.DataStats();for(GridCoverage2Dcoverage:this.granuleStack.getGranules()){updateDimensionValues(coverage);
if(!(dataPacking==DataPacking.NONE)){this.stats=newDataStats();collectStats(coverage,Arrays.asList(this.stats));
if(unitConverter!=null){//UpdatestatsbyapplyingunitConversionupdatedStats.setMax(unitConverter.convert(updatedStats.getMax()));updatedStats.setMin(unitConverter.convert(updatedStats.getMin()));
if(noDataSet){NumbernoData=dataPacker!=null?dataPacker.getReservedValue():noDataValue;writer.addVariableAttribute(var,newAttribute(NetCDFUtilities.FILL_VALUE,NetCDFUtilities.transcodeNumber(varDataType,noData)));
if(copyAttributes||extraVariables!=null&&!extraVariables.isEmpty()){try(NetcdfDatasetsource=getSourceNetcdfDataset(sampleGranule)){
if(source!=null){
if(copyAttributes){VariablesourceVar=source.findVariable(sampleGranule.getName().toString());
if(sourceVar==null){LOGGER.info(String.format("Couldnotcopyattributesbecause"+"variable'%s'notfoundinNetCDF/GRIB%s",sampleGranule.getName().toString(),source.getLocation()));
else{for(Attributeatt:sourceVar.getAttributes()){//donotallowoverwriteorattributesinblacklist
if(var.findAttribute(att.getFullName())==null&&!COPY_ATTRIBUTES_BLACKLIST.contains(att.getShortName())){writer.addVariableAttribute(var,att);
if(extraVariables!=null){for(ExtraVariableextra:extraVariables){VariablesourceVar=source.findVariable(extra.getSource());
if(sourceVar==null){LOGGER.info(String.format("Couldnotfindextravariablesource'%s'"+"inNetCDF/GRIB%s",extra.getSource(),source.getLocation()));
else
if(!sourceVar.getDimensionsString().isEmpty()){LOGGER.info(String.format("Onlyscalarextravariablesaresupportedbutsource"+"'%s'inNetCDF/GRIB%shasdimensions'%s'",extra.getSource(),source.getLocation(),sourceVar.getDimensionsString()));
else
if(writer.findVariable(extra.getOutput())!=null){LOGGER.info(String.format("Extravariableoutput'%s'alreadyexists",extra.getOutput()));
else
if(extra.getDimensions().split("\\s").length>1){LOGGER.info(String.format("Extravariableoutput'%s'"+"hastoomanydimensions'%s'",extra.getOutput(),extra.getDimensions()));
else{VariableoutputVar=writer.addVariable(null,extra.getOutput(),sourceVar.getDataType(),extra.getDimensions());for(Attributeatt:sourceVar.getAttributes()){writer.addVariableAttribute(outputVar,att);
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("FailedtocopyfromsourceNetCDF:"+e.getMessage());
if(variableAttributes!=null){for(VariableAttributeatt:variableAttributes){writer.deleteVariableAttribute(var,att.getKey());writer.addVariableAttribute(var,buildAttribute(att.getKey(),att.getValue()));
if(var==null){thrownewIllegalArgumentException("Therequestedvariabledoesn'texists:"+name);
if(!nonscalarExtraVariables.isEmpty()){//BeforeopeningthesourceNetCDF/GRIB,see
ifanyrecordrequiresdatafromit;//wemightbeiteratingovermanytime/elevation/customdimensionsbuthave//granuleswithsourcesincommonandwanttoavoidunnecessaryopeningof//sourceNetCDF/GRIB.Onlythefirstmatchingdatavalueisused.//Thisloopalsoensuresthatthesourceforeachgranuleisonlyopenedonce.booleanneedSource=false;for(ExtraVariableRecordrecord:nonscalarExtraVariables){
if(!record.writtenIndices.contains(indexing[record.dimensionIndex])){needSource=true;break;
if(needSource){try(NetcdfDatasetsource=getSourceNetcdfDataset(gridCoverage)){
if(source!=null){for(ExtraVariableRecordrecord:nonscalarExtraVariables){
if(!record.writtenIndices.contains(indexing[record.dimensionIndex])){writer.write(writer.findVariable(record.extraVariable.getOutput()),newint[]{indexing[record.dimensionIndex]},source.findVariable(record.extraVariable.getSource()).read().reshape(newint[]{1}));record.writtenIndices.add(indexing[record.dimensionIndex]);
if((j>=minY)&&(j<=maxY)){for(inttcol=0;tcol<tileWidth;tcol++){intcol=(tileX*tileWidth)+tcol;
if((col>=minX)&&(col<=maxX)){intk=col;finalintyPos=height-j+minY-1;//Simplysettinglatandlonindexing[numDimensions-1]=k-minX;indexing[numDimensions-2]=yPos;matrixIndex.set(indexing);setPixel(k,j,NetCDFUtilities.transcodeImageDataType(imageDataType),netCDFDataType,data,matrix,matrixIndex,dataPacker,noDataValue,unitConverter,0);
if(variableName==null||variableName.isEmpty()){//WrongLayernamereturnfalse;
if(maxCoverages!=null){returned=granuleCount<maxCoverages?granuleCount:maxCoverages;
else{returned=granuleCount;
if(!coverageGranules.isEmpty()){List<CoverageGranules>reducedGranules=coverageGranules;
if(maxCoverages!=null){reducedGranules=applyMaxCoverages(coverageGranules,maxCoverages);
if(allSections||dcs.getSections().getSection().contains(Section.COVERAGEDESCRIPTIONS)){handleCoverageDescriptions(reducedGranules);
if(allSections||dcs.getSections().getSection().contains(Section.DATASETSERIESDESCRIPTIONS)){handleDatasetSeriesDescriptions(coverageGranules);
ifany(nullotherwise)**@paramdcs*/privateIntegergetMaxCoverages(DescribeEOCoverageSetTypedcs){
if(dcs.getCount()>0){returndcs.getCount();
ifit'snullreturnwcs.getMetadata().get(WCSEOMetadata.COUNT_DEFAULT.key,Integer.class);
if(size>maxCoverages){cg.granules=DataUtilities.simple(newMaxFeaturesFeatureCollection<SimpleFeatureType,SimpleFeature>(cg.granules,maxCoverages));
if(maxCoverages<=0){break;
if(EPSGCode==null){thrownewIllegalStateException("UnabletolookupepsgcodeforthisCRS:"+crs);
if(features!=null){features.close();
if(ci==null){thrownewIllegalArgumentException("Thedatasetidisinvalid,shouldhavebeencheckedearlier?");
if(!collection.isEmpty()){List<DimensionDescriptor>descriptors=getActiveDimensionDescriptor(ci,reader,name);CoverageGranulesgranules=newCoverageGranules(ci,name,reader,collection,descriptors);results.add(granules);
if(source!=null){source.dispose();
if(entry.getValue()instanceofDimensionInfo){DimensionInfodi=(DimensionInfo)entry.getValue();
if(di.isEnabled()){StringdimensionName=entry.getKey();
if(dimensionName.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){dimensionName=dimensionName.substring(ResourceInfo.CUSTOM_DIMENSION_PREFIX.length());
if(selected!=null){enabledDescriptors.add(selected);
if(dcs.getDimensionTrim()==null||dcs.getDimensionTrim().size()==0){returnQuery.ALL;
if("Long".equals(name)){
if(lonRange!=null){thrownewWCS20Exception("Longtrimspecifiedmorethanonce",OWSExceptionCode.InvalidParameterValue,"subset");
else
if("Lat".equals(name)){
if(latRange!=null){thrownewWCS20Exception("Lattrimspecifiedmorethanonce",OWSExceptionCode.InvalidParameterValue,"subset");
else
if("phenomenonTime".equals(name)){
if(timeRange!=null){thrownewWCS20Exception("phenomenonTimetrimspecifiedmorethanonce",OWSExceptionCode.InvalidParameterValue,"subset");
else{thrownewWCS20Exception("Invaliddimensionname"+name+",theonlyvalidvalues"+"byWCSEOspecareLong,LatandphenomenonTime",OWSExceptionCode.InvalidParameterValue,"subset");
if(containment==null||"overlaps".equals(containment)){overlaps=true;
else
if("contains".equals(containment)){overlaps=false;
else{thrownewWCS20Exception("Invalidcontainmentvalue"+containment+",theonlyvalidvaluesbyWCSEOspecarecontainsandoverlaps",OWSExceptionCode.InvalidParameterValue,"containment");
if(lonRange!=null||latRange!=null){try{//wearegoingtointersectthetrimswiththeoriginalenvelope//sincethetrimscanonlybeexpressedinwgs84weneedtoreprojectbackand//forthReferencedEnvelopeoriginal=newReferencedEnvelope(reader.getOriginalEnvelope()).transform(DefaultGeographicCRS.WGS84,true);
if(lonRange!=null){ReferencedEnvelopelonTrim=newReferencedEnvelope(lonRange.getMinimum(),lonRange.getMaximum(),-90,90,DefaultGeographicCRS.WGS84);original=newReferencedEnvelope(original.intersection(lonTrim),DefaultGeographicCRS.WGS84);
if(latRange!=null){ReferencedEnvelopelatTrim=newReferencedEnvelope(-180,180,latRange.getMinimum(),latRange.getMaximum(),DefaultGeographicCRS.WGS84);original=newReferencedEnvelope(original.intersection(latTrim),DefaultGeographicCRS.WGS84);
if(original.isEmpty()){filter=Filter.EXCLUDE;
else{PolygonllPolygon=JTS.toGeometry(original);GeometryDescriptorgeom=reader.getGranules(coverageName,true).getSchema().getGeometryDescriptor();PropertyNamegeometryProperty=ff.property(geom.getLocalName());GeometrynativeCRSPolygon=JTS.transform(llPolygon,CRS.findMathTransform(DefaultGeographicCRS.WGS84,reader.getCoordinateReferenceSystem()));LiteralpolygonLiteral=ff.literal(nativeCRSPolygon);
if(overlaps){filter=ff.intersects(geometryProperty,polygonLiteral);
else{filter=ff.within(geometryProperty,polygonLiteral);
if(timeRange!=null&&filter!=Filter.EXCLUDE){DimensionDescriptortimeDescriptor=WCSDimensionsHelper.getDimensionDescriptor(reader,coverageName,"TIME");Stringstart=timeDescriptor.getStartAttribute();Stringend=timeDescriptor.getEndAttribute();FiltertimeFilter;
if(end==null){//singlevaluetimetimeFilter=ff.between(ff.property(start),ff.literal(timeRange.getMinValue()),ff.literal(timeRange.getMaxValue()));
else{//rangevalue,weneedtoaccountforcontainmentthen
if(overlaps){Filterf1=ff.lessOrEqual(ff.property(start),ff.literal(timeRange.getMaxValue()));Filterf2=ff.greaterOrEqual(ff.property(end),ff.literal(timeRange.getMinValue()));timeFilter=ff.and(Arrays.asList(f1,f2));
else{Filterf1=ff.greaterOrEqual(ff.property(start),ff.literal(timeRange.getMinValue()));Filterf2=ff.lessOrEqual(ff.property(end),ff.literal(timeRange.getMaxValue()));timeFilter=ff.and(Arrays.asList(f1,f2));
if(filter==null){filter=timeFilter;
else{filter=ff.and(filter,timeFilter);
if(low.compareTo(high)>0){thrownewWCS20Exception("LowgreaterthanHighintrimfordimension:"+trim.getDimension(),WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,"dimensionTrim");
if(low>high){thrownewWCS20Exception("LowgreaterthanHighintrimfordimension:"+trim.getDimension(),WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,"dimensionTrim");
ifcreatingastore*isnotsupported.**<p>Implementationsthatdonotsupportastoreshouldensurethat{@link#canCreateStore()}*returns<code>false</code>.*/GeoServerRoleStorecreateStore()throwsIOException;/***Registerfornotificationsonload**@paramlistener*/voidregisterRoleLoadedListener(RoleLoadedListenerlistener);/***Unregisterfornotificationsonload**@paramlistener*/voidunregisterRoleLoadedListener(RoleLoadedListenerlistener);/***Getgroupnamesfora{@linkGeoServerRole}objectHierarchicalrolesarenotconsidered**@paramrole*@returncollectionwhichcannotbemodified*/SortedSet<String>getGroupNamesForRole(GeoServerRolerole)throwsIOException;/***Getusernamesfora{@linkGeoServerRole}objectHierarchicalrolesarenotconsidered**@paramrole*@returncollectionwhichcannotbemodified*/SortedSet<String>getUserNamesForRole(GeoServerRolerole)throwsIOException;/***GettherolesfortheuserHierarchicalrolesarenotconsidered**@paramusername*@returnacollectionwhichcannotbemodified*/SortedSet<GeoServerRole>getRolesForUser(Stringusername)throwsIOException;/***GettherolesforthegroupHierarchicalrolesarenotconsidered**@paramgroupname*@returnacollectionwhichcannotbemodified*/SortedSet<GeoServerRole>getRolesForGroup(Stringgroupname)throwsIOException;/***Getthelistofrolescurrentlyknownbyusers(implementationsmustprovidetheadminrole*"ROLE_ADMINISTRATOR")**@returnacollectionwhichcannotbemodified*/SortedSet<GeoServerRole>getRoles()throwsIOException;/***returnsarolename->parentrolenamemappingfortheall{@linkGeoServerRole}objects.**<p>Thismethodshouldbeusedbyclients
iftheyhavetobuildatreestructure**@returnacollectionwhichcannotbemodified*@throwsIOException*/Map<String,String>getParentMappings()throwsIOException;/***Createsa{@linkGeoServerRole}object.Implementationscanusetheirspecialclasses*derivedfrom{@linkGeoServerRole}**@paramrole*/GeoServerRolecreateRoleObject(Stringrole)throwsIOException;/***Gettheparent{@linkGeoServerRole}object**@paramrole*@returntheparentroleornull*/GeoServerRolegetParentRole(GeoServerRolerole)throwsIOException;/***Loadsa{@linkGeoServerRole}byname**@paramrole*@throwsnull
iftheroleisnotfound*/GeoServerRolegetRoleByName(Stringrole)throwsIOException;/**loadfrombackendstore.Onsuccess,a{@linkRoleLoadedEvent}shouldmustbetriggered*/voidload()throwsIOException;/***ThisisacallbackforpersonalizedrolesExample:Roleemployeehasaproperty*"employeeNumber",whichhasnovalueoradefaultvalue."employeeNumber"isalsocalleda*roleparameterinthiscontext.**<p>Auser"harry"hasassignedtheroleemployeeandhasauserproperty"empNr"withthe*value4711**<p>Now,thismethodshouldcreatea{@linkProperties}objectcontainingthetheproperty*"employeeNumber"withthevalue4711.**<p>AGISexamplecouldbeaBBOXforspecificusertorestricthisaccesstothewmsservice**@paramroleNamethenameoftherole*@paramroleParamstheparamsfortherolefrom{@linkGeoServerRoleService}*@paramuserNametheusername*@paramuserPropsthepropertiesoftheuserfrom{@linkGeoServerUserGroupService}*@returnnullfornopersonalization,thepersonalizedpropertiesotherwise*@throwsIOException*/PropertiespersonalizeRoleParams(StringroleName,PropertiesroleParams,StringuserName,PropertiesuserProps)throwsIOException;/***@returnthelocalrolehavingthesameprivilegesas{@linkGeoserverRole#ADMIN_ROLE}or*<code>null</code>
ifnosuchroleexists*/GeoServerRolegetAdminRole();/***@returnthelocalrolehavingthesameprivileges{@linkGeoServerRole#GROUP_ADMIN_ROLE}or*<code>null</code>
ifnosuchroleexists*/GeoServerRolegetGroupAdminRole();/**@returnthenumberofroles*/intgetRoleCount()throwsIOException;}
if(schemaLocationURI==null){returnnull;
ifnonamespacegiven,assumedefaultforthecurrentschema
if(((namespaceURI==null)||"".equals(namespaceURI))&&(xsdSchema!=null)){namespaceURI=xsdSchema.getTargetNamespace();
if("http://www.opengis.net/wfs".equals(namespaceURI)&&(schemaLocationURI!=null)){
if(schemaLocationURI.endsWith("wfs.xsd")){returnWFSSchemaLocationResolver.class.getResource("wfs.xsd").toString();
iftheresourcecannotbelocated.*/@OverridepublicURLlocateGrid(Stringgrid){
if(grid==null)returnnull;GeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);
if(loader==null){returnnull;//mustbetestcasestillloading
if(gridfile.getType()==Type.RESOURCE){returnURLs.fileToUrl(gridfile.file());
else{returnnull;
if(channelinstanceofFileOutputChannel){finalStringsFilename=((FileOutputChannel)channel).getFilename();createBaseDir(sFilename);finalGTVectorLayervectorLayer=newGTVectorLayer();vectorLayer.create(sName,iShapeType,types,sFields,sFilename,crs);returnvectorLayer;
else
if(channelinstanceofStreamOutputChannel){returnnewStreamOutputLayer(((StreamOutputChannel)channel).getStream());
else{thrownewUnsupportedOutputChannelException();
if(channelinstanceofFileOutputChannel){finalStringsFilename=((FileOutputChannel)channel).getFilename();createBaseDir(sFilename);finalGTRasterLayerlayer=newGTRasterLayer();layer.create(sName,sFilename,extent,iDataType,iBands,crs,this.getDefaultNoDataValue());returnlayer;
else{thrownewUnsupportedOutputChannelException();
if(channelinstanceofFileOutputChannel){finalStringsFilename=((FileOutputChannel)channel).getFilename();createBaseDir(sFilename);finalGTTabletable=newGTTable();table.create(sName,sFilename,types,sFields);returntable;
else{thrownewUnsupportedOutputChannelException();
ifitdoesnotexistfinalFilefile=newFile(fileName);
if(!file.getParentFile().exists()){file.getParentFile().mkdirs();
if(request.getStoredQueryId().isEmpty()){for(StoredQueryquery:storedQueryProvider.listStoredQueries()){describeStoredQuery(query,response);
else{for(URIid:request.getStoredQueryId()){StoredQueryquery=storedQueryProvider.getStoredQuery(id.toString());
if(query==null){WFSExceptionexception=newWFSException(request,"Nosuchstoredquery:"+id,ServiceException.INVALID_PARAMETER_VALUE);exception.setLocator("STOREDQUERY_ID");throwexception;
if(map==null){//returnnull;//
if(p==null){//returnnull;//
if(isGroupAdmin){for(StringgroupName:GroupAdminProperty.get(user.getProperties())){try{adminGroups.add(ugService.getGroupByGroupname(groupName));
if(adminGroupChoice.isEnabled()){Collection<GeoServerUserGroup>groups=adminGroupChoice.getModelObject();String[]groupNames=newString[groups.size()];inti=0;for(GeoServerUserGroupgroup:groups){groupNames[i++]=group.getGroupname();
else{GroupAdminProperty.del(user.getProperties());
if(isFinalSubmit(form)){super.validate(form);
if(form==null){returnfalse;
if(einstanceofRuntimeException&&e.getCause()instanceofException){e=(Exception)e.getCause();
if(einstanceofIOException&&e.getCause()instanceofAbstractSecurityException){e=(Exception)e.getCause();
if(einstanceofAbstractSecurityException){error(e);
else{error(newParamResourceModel("saveError",getPage(),e.getMessage()).getObject());
if(group.isEnabled()){tmp.addAll(calc.calculateRoles(group));
if(adminGroupChoice.isEnabled()){adminGroupChoice.updateModel();
if(adminGroupChoice.getModelObject().isEmpty()){form.error(newStringResourceModel("noAdminGroups",getPage(),null).getString());
if(sourceinstanceofReferencedEnvelope){
if(String.class.isAssignableFrom(target)){try{ReferencedEnvelopeenvelope=(ReferencedEnvelope)source;StringBuilderstr=newStringBuilder();str.append(envelope.getMinimum(0)).append(SEPARATOR);str.append(envelope.getMaximum(0)).append(SEPARATOR);str.append(envelope.getMinimum(1)).append(SEPARATOR);str.append(envelope.getMaximum(1)).append(SEPARATOR);str.append(CRS.lookupIdentifier(envelope.getCoordinateReferenceSystem(),true));return(T)str.toString();
else{
if(ReferencedEnvelope.class.isAssignableFrom(target)){Stringtext=(String)source;String[]parsed=text.split("\\s*"+SEPARATOR+"\\s*");try{return(T)(newReferencedEnvelope(newEnvelope(Double.valueOf(parsed[0]),Double.valueOf(parsed[1]),Double.valueOf(parsed[2]),Double.valueOf(parsed[3])),CRS.decode(parsed[4])));
if(infoinstanceofDataStoreInfo){assertEquals(((DataStoreInfo)info).getWorkspace(),((DataStoreInfo)saved).getWorkspace());
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;GridCoverageRequestother=(GridCoverageRequest)obj;
if(dimensionsSubset==null){
if(other.dimensionsSubset!=null)returnfalse;
else
if(!dimensionsSubset.equals(other.dimensionsSubset))returnfalse;
if(elevationSubset==null){
if(other.elevationSubset!=null)returnfalse;
else
if(!elevationSubset.equals(other.elevationSubset))returnfalse;
if(filter==null){
if(other.filter!=null)returnfalse;
else
if(!filter.equals(other.filter))returnfalse;
if(outputCRS==null){
if(other.outputCRS!=null)returnfalse;
else
if(!outputCRS.equals(other.outputCRS))returnfalse;
if(overviewPolicy!=other.overviewPolicy)returnfalse;
if(spatialInterpolation==null){
if(other.spatialInterpolation!=null)returnfalse;
else
if(!spatialInterpolation.equals(other.spatialInterpolation))returnfalse;
if(spatialSubset==null){
if(other.spatialSubset!=null)returnfalse;
else
if(!spatialSubset.equals(other.spatialSubset))returnfalse;
if(temporalInterpolation==null){
if(other.temporalInterpolation!=null)returnfalse;
else
if(!temporalInterpolation.equals(other.temporalInterpolation))returnfalse;
if(temporalSubset==null){
if(other.temporalSubset!=null)returnfalse;
else
if(!temporalSubset.equals(other.temporalSubset))returnfalse;returntrue;}}
if(configinstanceofBasicAuthenticationFilterConfig)validateFilterConfig((BasicAuthenticationFilterConfig)config);
if(configinstanceofDigestAuthenticationFilterConfig)validateFilterConfig((DigestAuthenticationFilterConfig)config);
if(configinstanceofRoleFilterConfig)validateFilterConfig((RoleFilterConfig)config);
if(configinstanceofX509CertificateAuthenticationFilterConfig)validateFilterConfig((X509CertificateAuthenticationFilterConfig)config);
if(configinstanceofUsernamePasswordAuthenticationFilterConfig)validateFilterConfig((UsernamePasswordAuthenticationFilterConfig)config);
if(configinstanceofRequestHeaderAuthenticationFilterConfig)validateFilterConfig((RequestHeaderAuthenticationFilterConfig)config);
if(configinstanceofJ2eeAuthenticationFilterConfig)validateFilterConfig((J2eeAuthenticationFilterConfig)config);
if(configinstanceofExceptionTranslationFilterConfig)validateFilterConfig((ExceptionTranslationFilterConfig)config);
if(configinstanceofSecurityContextPersistenceFilterConfig)validateFilterConfig((SecurityContextPersistenceFilterConfig)config);
if(configinstanceofRememberMeAuthenticationFilterConfig)validateFilterConfig((RememberMeAuthenticationFilterConfig)config);
if(configinstanceofAnonymousAuthenticationFilterConfig)validateFilterConfig((AnonymousAuthenticationFilterConfig)config);
if(configinstanceofSecurityInterceptorFilterConfig)validateFilterConfig((SecurityInterceptorFilterConfig)config);
if(configinstanceofLogoutFilterConfig)validateFilterConfig((LogoutFilterConfig)config);//TODO,checkrememberme
if(isNotEmpty(ugServiceName)==false)throwcreateFilterException(FilterConfigException.USER_GROUP_SERVICE_NEEDED);try{
if(manager.listUserGroupServices().contains(ugServiceName)==false)throwcreateFilterException(FilterConfigException.UNKNOWN_USER_GROUP_SERVICE,ugServiceName);
if(isNotEmpty(roleServiceName)==false)return;//theactiveroleserviceshouldbeusedtry{
if(manager.listRoleServices().contains(roleServiceName)==false)throwcreateFilterException(FilterConfigException.UNKNOWN_ROLE_SERVICE,roleServiceName);
if(isNotEmpty(config.getSecurityMetadataSource())==false)throwcreateFilterException(FilterConfigException.SECURITY_METADATA_SOURCE_NEEDED);try{lookupBean(config.getSecurityMetadataSource());
if(config.getNonceValiditySeconds()<0)throwcreateFilterException(FilterConfigException.INVALID_SECONDS);
if(isNotEmpty(config.getHttpResponseHeaderAttrForIncludedRoles())==false){throwcreateFilterException(FilterConfigException.HEADER_ATTRIBUTE_NAME_REQUIRED);
if(isNotEmpty(config.getRoleConverterName())){try{lookupBean(config.getRoleConverterName());
if(isNotEmpty(config.getUsernameParameterName())==false){throwcreateFilterException(FilterConfigException.USER_PARAMETER_NAME_NEEDED);
if(isNotEmpty(config.getPasswordParameterName())==false){throwcreateFilterException(FilterConfigException.PASSWORD_PARAMETER_NAME_NEEDED);
if(config.getRoleSource().equals(J2eeAuthenticationBaseFilterConfig.J2EERoleSource.J2EE)){checkExistingRoleService(config.getRoleServiceName());
if(isNotEmpty(config.getPrincipalHeaderAttribute())==false)throwcreateFilterException(FilterConfigException.PRINCIPAL_HEADER_ATTRIBUTE_NEEDED);validateFilterConfig((PreAuthenticatedUserNameFilterConfig)config);
if(config.getRoleSource()==null)throwcreateFilterException(FilterConfigException.ROLE_SOURCE_NEEDED);
if(config.getRoleSource().equals(PreAuthenticatedUserNameFilterConfig.PreAuthenticatedUserNameRoleSource.RoleService))checkExistingRoleService(config.getRoleServiceName());
if(config.getRoleSource().equals(PreAuthenticatedUserNameFilterConfig.PreAuthenticatedUserNameRoleSource.UserGroupService))checkExistingUGService(config.getUserGroupServiceName());
if(config.getRoleSource().equals(PreAuthenticatedUserNameFilterConfig.PreAuthenticatedUserNameRoleSource.Header)){
if(isNotEmpty(config.getRolesHeaderAttribute())==false)throwcreateFilterException(FilterConfigException.ROLES_HEADER_ATTRIBUTE_NEEDED);
if(isNotEmpty(config.getRoleConverterName())){try{lookupBean(config.getRoleConverterName());
if(isNotEmpty(config.getAuthenticationFilterName())){try{SecurityNamedServiceConfigfilterConfig=manager.loadFilterConfig(config.getAuthenticationFilterName());
if(filterConfig==null)throwcreateFilterException(FilterConfigException.INVALID_ENTRY_POINT,config.getAuthenticationFilterName());booleanvalid=false;
if(filterConfiginstanceofSecurityFilterConfig){
if(((SecurityFilterConfig)filterConfig).providesAuthenticationEntryPoint())valid=true;
if(!valid){throwcreateFilterException(FilterConfigException.NO_AUTH_ENTRY_POINT,config.getAuthenticationFilterName());
if(isNSGProfileApplicable(version)){returnArrays.asList(NSG_BASIC/*,"http://www.dgiwg.org/service/wfs/2.0/profile/locking"*/);
else{returnCollections.emptyList();
if(isNSGProfileApplicable(version)){for(DomainTypeconstraint:constraints){
if(IMPLEMENTS_FEATURE_VERSIONING.equals(constraint.getName())){constraint.setDefaultValue("TRUE");
if(isNSGProfileApplicable(version)){//prepareSRScustomizationWFSInfowfs=gs.getService(WFSInfo.class);DomainTypesrsParameter=getSrsParameter(wfs);DomainTypetimeoutParameter=getTimeoutParameter(wfs);DomainTypeversionParameter=newDomainType("version",Arrays.asList("2.0.0","1.1.0","1.0.0"));//addthepagedresultsoperationOperationMetadatapageResults=newOperationMetadata("PageResults",true,true);pageResults.getParameters().add(newDomainType("outputFormat",GML32_FORMAT));operations.add(pageResults);for(OperationMetadataoperation:operations){//addtheversion
ifnotGetCapabilities,couldhavebeendoneincore,butthis//seemslikeaniche//nitpick,it'saWFS2.0capabilitiestheversionnumbershouldbeobvioustothe//client
if(!"GetCapabilities".equals(operation.getName())){//addtheversion
ifmissing
if(!containsParameter(operation,"version")){operation.getParameters().add(versionParameter);
ifconfiguredinWFS
if(SRS_OPERATIONS.contains(operation.getName())&&!containsParameter(operation,srsParameter.getName())){operation.getParameters().add(srsParameter);
ifconfiguredinWFS
if(TIMEOUT_OPERATIONS.contains(operation.getName())&&!containsParameter(operation,timeoutParameter.getName())){operation.getParameters().add(timeoutParameter);
if(timeout==null){timeout=300;
if(extraSRS!=null&&!extraSRS.isEmpty()){srsParameterValues=extraSRS.stream().map(epsgMapper).collect(Collectors.toCollection(LinkedHashSet::new));
else{srsParameterValues=newLinkedHashSet<>();
if(srs.matches("(?ui)EPSG:[0-9]+")){srs=prefix+srs.substring(5);
else{srs=prefix+srs;
if(dpi>0){request.getFormatOptions().put("dpi",dpi);
if(cm.hasAlpha()){actual=newColor(cm.getRed(pixel),cm.getGreen(pixel),cm.getBlue(pixel),cm.getAlpha(pixel));
else{actual=newColor(cm.getRed(pixel),cm.getGreen(pixel),cm.getBlue(pixel),255);
ifalockfailedandthelockspecifiedalllocks,or
ifananother*erroroccurredprocessingthelockoperation*/publicLockFeatureResponselockFeature(LockFeatureRequestrequest)throwsWFSException{FeatureLockfLock=null;try{//checkwearedealingwithawellformedrequest,thereisat//leastonlockrequest?List<Lock>locks=request.getLocks();
if((locks==null)||locks.isEmpty()){Stringmsg="ALockFeaturerequestmustcontainatleastoneLOCKelement";thrownewWFSException(request,msg);
ifthelockisthedefaultthisdefault,lockthewhole//querydirectly,shouldbealotfasterfor(inti=0,n=locks.size();i<n;i++){Locklock=locks.get(i);LOGGER.info("curLockis"+lock);QNametypeName=lock.getTypeName();//getoutthefilter,anddefaulttonofiltering
ifnonewas//providedFilterfilter=lock.getFilter();
if(filter==null){filter=Filter.INCLUDE;
if(meta==null){thrownewWFSException(request,"Unknownfeaturetype"+typeName.getPrefix()+":"+typeName.getLocalPart());
if(sourceinstanceofFeatureLocking){((FeatureLocking)source).setFeatureLock(fLock);
if(!(sourceinstanceofFeatureLocking)){LOGGER.fine("Lock"+fid+"notsupportedbydatastore(authID:"+fLock.getAuthorization()+")");response.addNotLockedFeature(fid);//lockFailedFids.add(fid);
else{//DEFQueryisjustsomeindirection,shouldbein//thelockinginterface.//intnumberLocked=//((DEFQueryFeatureLocking)source).lockFeature(feature);//HACK:Query.NO_NAMESisn'tworkinginpostgis//rightnow,//sowe'lljustuseall.Queryquery=newQuery(meta.getName(),(Filter)fidFilter,Query.DEFAULT_MAX,Query.ALL_NAMES,lock.getHandle());numberLocked=((FeatureLocking)source).lockFeatures(query);
if(numberLocked==1){LOGGER.fine("Lock"+fid+"(authID:"+fLock.getAuthorization()+")");response.addLockedFeature(fid);//lockedFids.add(fid);
else
if(numberLocked==0){LOGGER.fine("Lock"+fid+"conflict(authID:"+fLock.getAuthorization()+")");response.addNotLockedFeature(fid);//lockFailedFids.add(fid);
else{LOGGER.warning("Lock"+numberLocked+""+fid+"(authID:"+fLock.getAuthorization()+")duplicatedFeatureID!");response.addLockedFeature(fid);//lockedFids.add(fid);
if(reader!=null){reader.close();
if(numberLocked>0){Transactiont=newDefaultTransaction();try{try{t.addAuthorization(fLock.getAuthorization());DataStoredataStore=(DataStore)source.getDataStore();dataStore.getLockingManager().refresh(fLock.getAuthorization(),t);
ifnotsetdefaulttotruebooleanlockAll=!request.isLockActionSome();ListnotLocked=response.getNotLockedFeatures();
if(lockAll&&(notLocked!=null&&!notLocked.isEmpty())){//IthinkweneedtoreleaseandfailwhenlockAllfails////abortwillreleasethelocksthrownewWFSException(request,"Couldnotacquirelocksfor:"+notLocked,WFSException.CANNOT_LOCK_ALL_FEATURES);
if(fLock!=null){try{release(fLock.getAuthorization());
if(meta.isEnabled()){DataAccessda=meta.getDataStore(null);
if(dainstanceofDataStore){dataStore=(DataStore)da;
if(dataStore==null){continue;//disabledornotaDataStore
if(lockingManager==null){continue;//locksnotsupported
if(lockingManager.release(lockId,t)){refresh=true;
if(!refresh){//throwexception?orignore...
if(meta.isEnabled()){DataAccessda=meta.getDataStore(null);
if(dainstanceofDataStore){dataStore=(DataStore)da;
if(dataStore==null){continue;//disabledornotaDataStore
if(lockingManager==null){continue;//locksnotsupported
if(meta.isEnabled()){DataAccessda=meta.getDataStore(null);
if(dainstanceofDataStore){dataStore=(DataStore)da;
if(dataStore==null){continue;//disabledornotaDataStore
if(lockingManager==null){continue;//locksnotsupported
if(lockingManager.exists(lockId)){returntrue;
if(meta.isEnabled()){DataAccessda=meta.getDataStore(null);
if(dainstanceofDataStore){dataStore=(DataStore)da;
if(dataStore==null){continue;//disabledornotaDataStore
if(lockingManager==null){continue;//locksnotsupported
if(lockingManagerinstanceofInProcessLockingManager){InProcessLockingManagerip=(InProcessLockingManager)lockingManager;Set<InProcessLockingManager.Lock>locks=ip.allLocks();
if(locks!=null){lockFound|=locks.stream().anyMatch(l->l.isMatch(lockId));
if(lockingManager.refresh(lockId,t)){refresh=true;
ifalockexistsbutit'sexpired,butWFS2.0//requirestosendbackadifferentresponse...we'llmakeaguess
if(!refresh&&throwOnRefreshFail){
if(!lockFound){thrownewServiceException("Unknownlockid",WFSException.INVALID_LOCK_ID,"lockId");
else{thrownewServiceException("Lockhasexpired",WFSException.LOCK_HAS_EXPIRED,"lockId");
if((handle==null)||handle.equals("")){handle="GeoServer";request.setHandle(handle);
if(expiry==null){expiry=BigInteger.valueOf(0);request.setExpiry(expiry);
if(lockExpiry<0){//negativetimeusedtoquery
iflockisavailable!returnFeatureLockFactory.generate(handle,lockExpiry);
if(lockExpiry==0){//permalockwithnoexpiry!returnFeatureLockFactory.generate(handle,0);
if(request.getAdaptee()instanceofnet.opengis.wfs20.LockFeatureType){returnFeatureLockFactory.generate(handle,lockExpiry*1000);
else{returnFeatureLockFactory.generate(handle,lockExpiry*60*1000);
if(xmppServerEmbedded!=null&&Boolean.valueOf(xmppServerEmbedded.trim())){///LOGGER.info("initializingembeddedvysperserver...");//AdminUserfinalEntityadminJID=EntityImpl.parseUnchecked(xmppUserName+"@"+xmppDomain);finalAccountManagementaccountManagement=(AccountManagement)storageProviderRegistry.retrieve(AccountManagement.class);
if(!accountManagement.verifyAccountExists(adminJID)){accountManagement.addUser(adminJID,xmppUserPassword);
if(endpoints==null||endpoints.size()==0){XMPPBoshEndpointboshEndpoint=newXMPPBoshEndpoint();boshEndpoint.setPort(Integer.parseInt(configuration.get("xmpp_port")));
if(certificateFile!=null&&certificatePassword!=null){boshEndpoint.setSSLCertificateKeystore(certificateFile.getAbsolutePath());boshEndpoint.setSSLCertificateKeystorePassword(certificatePassword);boshEndpoint.setSSLEnabled(true);
else{boshEndpoint.setSSLEnabled(false);
if(certificateFile!=null&&certificatePassword!=null){FileBasedTLSContextFactorytlsContextFactory=newFileBasedTLSContextFactory(certificateFile);tlsContextFactory.setPassword(certificatePassword);tlsContextFactory.setTrustManagerFactory(newBogusTrustManagerFactory());serverRuntimeContext.setTlsContextFactory(tlsContextFactory);
if(listOfModules!=null){for(Modulemodule:listOfModules){addModule(module);
if(serviceChannels!=null){for(Stringchannel:serviceChannels){EntityserviceRoomJID=EntityImpl.parseUnchecked(channel+"@"+configuration.get("xmpp_bus")+"."+xmppDomain);conference.createRoom(serviceRoomJID,channel,RoomType.Public);
if(endpoints.size()==0)thrownewIllegalStateException("servermusthaveatleastoneendpoint");for(Endpointendpoint:endpoints){endpoint.setServerRuntimeContext(serverRuntimeContext);endpoint.start();
if(xmppServerEmbeddedSecure!=null&&Boolean.valueOf(xmppServerEmbeddedSecure.trim())){//OverrideXMLproperties
if(xmppServerEmbeddedCertFile!=null&&xmppServerEmbeddedCertPwd!=null){finalorg.geoserver.platform.resource.ResourcecertFileResource=Resources.fromURL(xmppServerEmbeddedCertFile.trim());
if(certFileResource!=null){this.certificateFile=certFileResource.file();this.certificatePassword=xmppServerEmbeddedCertPwd.trim();
else{//GettheResourceloaderGeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);try{//Copythedefaultpropertyfileintothedatadirectory//URLurl=//RemoteProcessFactoryConfigurationWatcher.class.getResource(xmppServerEmbeddedCertFile.trim());//
if(url!=null){this.certificateFile=loader.createFile(xmppServerEmbeddedCertFile.trim());loader.copyFromClassPath(xmppServerEmbeddedCertFile.trim(),this.certificateFile/*,RemoteProcessFactoryConfigurationWatcher.class*/);//
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,e.getMessage(),e);
iftherearenolimits
if((readFilter==null||readFilter==Filter.INCLUDE)&&(writeFilter==null||writeFilter==Filter.INCLUDE||WMSLayerInfo.class.isAssignableFrom(resourceClass)||WMTSLayerInfo.class.isAssignableFrom(resourceClass)||CoverageInfo.class.isAssignableFrom(resourceClass))){returnnull;
if(FeatureTypeInfo.class.isAssignableFrom(resourceClass)){returnnewVectorAccessLimits(mode,null,readFilter,null,writeFilter);
else
if(CoverageInfo.class.isAssignableFrom(resourceClass)){returnnewCoverageAccessLimits(mode,readFilter,null,null);
else
if(WMSLayerInfo.class.isAssignableFrom(resourceClass)){returnnewWMSAccessLimits(mode,readFilter,null,true);
else
if(WMTSLayerInfo.class.isAssignableFrom(resourceClass)){returnnewWMTSAccessLimits(mode,readFilter,null);
else{LOGGER.log(Level.INFO,"Warning,adaptingtogenericaccesslimitsforunrecognizedresourcetype"+resourceClass);returnnewDataAccessLimits(mode,readFilter);
if(readable&&writable){
if(AdminRequest.get()==null){//notadminrequest,read+writemeansfullacesssreturnnull;
if(delegate.getMode()==CatalogMode.CHALLENGE)//Ifwe'reinCHALLENGEmode,everythingshouldbevisiblereturnPredicates.acceptAll();
elsereturnsuper.getSecurityFilter(user,clazz);}}
if(validator!=null){
if(validatorinstanceofRegexpValidator){this.regexp=((RegexpValidator)validator).getPattern().pattern();
else{SQLViewParamProvider.LOGGER.log(Level.WARNING,"Skippingunknownvalidatortype"+validator.getClass());
if(regexp!=null){result.setValidator(newRegexpValidator(regexp));
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;Parameterother=(Parameter)obj;
if(defaultValue==null){
if(other.defaultValue!=null)returnfalse;
else
if(!defaultValue.equals(other.defaultValue))returnfalse;
if(name==null){
if(other.name!=null)returnfalse;
else
if(!name.equals(other.name))returnfalse;
if(regexp==null){
if(other.regexp!=null)returnfalse;
else
if(!regexp.equals(other.regexp))returnfalse;returntrue;
ifnotfoundreturna404
if(url==null){response.sendError(HttpServletResponse.SC_NOT_FOUND);returnnull;
if(file!=null&&file.exists()&&file.isDirectory()){Stringuri=request.getRequestURI();uri+=uri.endsWith("/")?"index.html":"/index.html";response.addHeader("Location",uri);response.sendError(HttpServletResponse.SC_MOVED_TEMPORARILY);returnnull;
if(file!=null&&checkNotModified(request,file.lastModified())){response.setStatus(HttpServletResponse.SC_NOT_MODIFIED);returnnull;
ifknownbytheservletcontainer,setnothingotherwise//(Tomcatbehaveslikethiswhenitdoesnotrecognizethefileformat)Stringmime=getServletContext().getMimeType(newFile(url.getFile()).getName());
if(mime!=null){response.setContentType(mime);
if(length>0&&length<=Integer.MAX_VALUE){response.setContentLength((int)length);
if(lastModified>0){response.setHeader("Last-Modified",lastModified(lastModified));
if(count>0){//sendoutthefirstfourbytesreadoutput=response.getOutputStream();output.write(b4,0,count);//copythecontenttotheoutputbyte[]buffer=newbyte[8192];intn=-1;while((n=input.read(buffer))!=-1){output.write(buffer,0,n);
if(input!=null)input.close();
if(header!=null&&header.length()>0){longifModSinceSeconds=lastModified(header);//theHTTPheaderhassecondprecisionlongtimeStampSeconds=1000*(timeStamp/1000);returnifModSinceSeconds>=timeStampSeconds;
ifnotspecified//intherequestFeatureIteratorreader=null;try{finalListcollections=results.getFeature();finalintsize=collections.size();FeatureCollectionfr;SimpleFeaturef;SimpleFeatureTypeschema;List<AttributeDescriptor>types;for(inti=0;i<size;i++)//foreachlayerqueried{fr=(FeatureCollection)collections.get(i);reader=fr.features();booleanstartFeat=true;while(reader.hasNext()){Featurefeature=reader.next();
if(startFeat){writer.println("ResultsforFeatureType'"+fr.getSchema().getName()+"':");startFeat=false;
if(featuresPrinted<maxfeatures){writer.println("--------------------------------------------");
if(featureinstanceofSimpleFeature){f=(SimpleFeature)feature;schema=(SimpleFeatureType)f.getType();types=schema.getAttributeDescriptors();for(AttributeDescriptordescriptor:types){finalNamename=descriptor.getName();
if(Geometry.class.isAssignableFrom(descriptor.getType().getBinding())){//writer.println(types[j].getName()+"=//[GEOMETRY]");//DJB:changedthistoprintoutWKT-itsvery//niceforusers//Geometryg=(Geometry)//f.getAttribute(types[j].getName());//writer.println(types[j].getName()+"=//[GEOMETRY]="+g.toText());//DJB:decidedthatallthegeometryinfowas//toomuch-theyshoulduseGMLversion
if//theywantthosedetailsGeometryg=(Geometry)f.getAttribute(name);
if(g!=null){writer.println(name+"=[GEOMETRY("+g.getGeometryType()+")with"+g.getNumPoints()+"points]");
else{//GEOS-6829writer.println(name+"=null");
else{writer.println(name+"="+f.getAttribute(name));
else{writer.println(feature.toString());
if(reader!=null){reader.close();
if(featuresPrinted==0){writer.println("nofeatureswerefound");
if(property==GridSetTableProvider.NAME){GridSetgridSet=itemModel.getObject();returnnameLink(id,gridSet);
else
if(property==GridSetTableProvider.EPSG_CODE){StringepsgCode=(String)property.getModel(itemModel).getObject();returnnewLabel(id,epsgCode);
else
if(property==GridSetTableProvider.TILE_DIMENSION){StringtileDimension=(String)property.getModel(itemModel).getObject();returnnewLabel(id,tileDimension);
else
if(property==GridSetTableProvider.ZOOM_LEVELS){IntegerzoomLevels=(Integer)property.getModel(itemModel).getObject();returnnewLabel(id,zoomLevels.toString());
else
if(property==GridSetTableProvider.QUOTA_USED){QuotausedQuota=(Quota)property.getModel(itemModel).getObject();StringquotaStr=usedQuota==null?"N/A":usedQuota.toNiceString();returnnewLabel(id,quotaStr);
else
if(property==GridSetTableProvider.ACTION_LINK){StringgridSetName=(String)property.getModel(itemModel).getObject();ComponentactionLink=actionLink(id,gridSetName);returnactionLink;
iftheGridSetfortheitemisan*internallydefinedone**@seeorg.geoserver.web.wicket.GeoServerTablePanel#selectOneCheckbox*/@OverrideprotectedCheckBoxselectOneCheckbox(Item<GridSet>item){CheckBoxcb=super.selectOneCheckbox(item);GridSetgs=(GridSet)item.getModelObject();Stringname=gs.getName();finalbooleaninternal=GWC.get().isInternalGridSet(name);
if(internal){cb.setEnabled(false);cb.setModelObject(Boolean.FALSE);
if(GWC.get().isInternalGridSet(g.getName())){it.remove();
if(!(context.getService()instanceofWMSInfo)){returnnull;
if(Placemark.class.isAssignableFrom(featureClass)){returnnewPlacemarkLookAtDecorator();
else
if(Folder.class.isAssignableFrom(featureClass)||NetworkLink.class.isAssignableFrom(featureClass)){returnnewLayerLookAtDecorator();
else
if(Document.class.isAssignableFrom(featureClass)){returnnewDocumentLookAtDecorator();
else{returnnull;
if(geometry!=null){bounds=geometry.getEnvelopeInternal();
if(!forceBounds&&lookAtGeometry!=null){lookAtEnvelope=lookAtGeometry.getEnvelopeInternal();
if(lookAtEnvelope==null||lookAtEnvelope.isNull()){returnnull;
if(null==distance){distance=distance(p1,p2);
if(entry.getValue()instanceofDimensionInfo){dimensions.put(entry.getKey(),(DimensionInfo)entry.getValue());
if(!dimensions.isEmpty()){initDimensions(dimensions);
if(dimensions!=null&&!dimensions.isEmpty()){initDimensions(dimensions);
if(updatedDimensions.containsKey(ResourceInfo.TIME)){timeDimension=updatedDimensions.remove(ResourceInfo.TIME);
if(timeDimension!=null){finalBigDecimalresolution=timeDimension.getResolution();
if(resolution!=null){setupTimeResolution(resolution);
if(updatedDimensions.containsKey(ResourceInfo.ELEVATION)){elevationDimension=updatedDimensions.remove(ResourceInfo.ELEVATION);finalBigDecimalresolution=elevationDimension.getResolution();
if(resolution!=null){elevationResolutionValue=resolution.doubleValue();elevationResolutionUnit=elevationDimension.getUnitSymbol();
if(resolution.remainder(duration).longValue()==0){timeResolutionValue=resolution.divide(duration).longValue();timeResolutionUnit=DURATION_UNITS[i];return;
if(additionalDimensions!=null&&!additionalDimensions.isEmpty()&&additionalDimensions.containsKey(domainName)){returnaccessor.getCustomDomainDefaultValue(domainName);
if(time!=null){returnformatter.format(time);
else{returnnull;
ifnodimensionsarefound.**@parammetadata*/publicstaticMap<String,DimensionInfo>getDimensionsFromMetadata(MetadataMapmetadata){Map<String,DimensionInfo>dimensionsMap=newHashMap<String,DimensionInfo>();
if(metadata!=null&&!metadata.isEmpty()){finalSet<String>metadataKeys=metadata.keySet();finalIterator<String>metadataIterator=metadataKeys.iterator();//loopovermetadatakeyswhile(metadataIterator.hasNext()){Stringkey=metadataIterator.next();
if(isADimension(key)){//CheckwhetherthespecifiedmetadataisrelatedtoanenabledDimensionDimensionInfodimension=metadata.get(key,DimensionInfo.class);
if(dimension!=null&&dimension.isEnabled()){
if(key.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){key=key.substring(ResourceInfo.CUSTOM_DIMENSION_PREFIX.length());
if(dd.getName().equalsIgnoreCase(dimensionName)){returndd;
if(System.getProperty("testDatabase")!=null){//whenrunonline,getID()isprefixedwithtablenamefinalStringPREFIX="MAPPEDFEATUREPROPERTYFILE.";mf1=PREFIX+mf1;mf2=PREFIX+mf2;mf3=PREFIX+mf3;mf4=PREFIX+mf4;
if(objectinstanceofByteArrayRawData){ByteArrayRawDataraw=(ByteArrayRawData)object;returnraw.getData().length;
else
if(objectinstanceofStringRawData){StringRawDataraw=(StringRawData)object;returnraw.getData().length()*2;
else
if(objectinstanceofResourceRawData){ResourceRawDataraw=(ResourceRawData)object;returnraw.getResource().file().length();
if(calculate==null||calculate.isEmpty()){booleanchangedProjection=message.getSRS()==null||!message.getSRS().equals(resource.getSRS());booleanchangedProjectionPolicy=message.getProjectionPolicy()==null||!message.getProjectionPolicy().equals(resource.getProjectionPolicy());booleanchangedNativeBounds=message.getNativeBoundingBox()==null||!message.getNativeBoundingBox().equals(resource.getNativeBoundingBox());booleanchangedLatLonBounds=message.getLatLonBoundingBox()==null||!message.getLatLonBoundingBox().equals(resource.getLatLonBoundingBox());booleanchangedNativeInterpretation=changedProjectionPolicy||changedProjection;fieldsToCalculate=newArrayList<>();
if(changedNativeInterpretation&&!changedNativeBounds){fieldsToCalculate.add("nativebbox");
if((changedNativeInterpretation||changedNativeBounds)&&!changedLatLonBounds){fieldsToCalculate.add("latlonbbox");
else{fieldsToCalculate=Arrays.asList(calculate.toLowerCase().split(","));
if(fieldsToCalculate.contains("nativebbox")){CatalogBuilderbuilder=newCatalogBuilder(catalog);try{message.setNativeBoundingBox(builder.getNativeBounds(message));
if(fieldsToCalculate.contains("latlonbbox")){CatalogBuilderbuilder=newCatalogBuilder(catalog);try{message.setLatLonBoundingBox(builder.getLatLonBounds(message.getNativeBoundingBox(),resolveCRS(message.getSRS())));
if(srs==null){returnnull;
ifthecurrentuserisauthenticatedasfulladministrator.*/protectedbooleanisAuthenticatedAsAdmin(){returnSecurityContextHolder.getContext()!=null&&GeoServerExtensions.bean(GeoServerSecurityManager.class).checkAuthenticationForAdminRole();
ifworkspaceNameis*null)**@paramworkspaceName*/protectedvoidcheckFullAdminRequired(StringworkspaceName){//globalworkspaces/stylescanonlybeeditedbyafulladmin
if(workspaceName==null&&!isAuthenticatedAsAdmin()){thrownewRestException("Cannoteditglobalresource,fulladmincredentialsrequired",HttpStatus.METHOD_NOT_ALLOWED);
ifanadminisloggedin,andtheidisnotnull**@paramparent*/protectedbooleanisNodeIdVisible(WebMarkupContainerparent){
if(NODE_DATA.getId()==null){returnfalse;
if(auth==null||!auth.isAuthenticated()||authinstanceofAnonymousAuthenticationToken){returnfalse;
else{GeoServerSecurityManagersecurityManager=GeoServerApplication.get().getSecurityManager();returnsecurityManager.checkAuthenticationForAdminRole(auth);
if(!targetFileService.checkFileExists(TARGET_FILE_OLD)){try(InputStreamis=sourceFileService.read(SOURCE_FILE)){targetFileService.create(TARGET_FILE_OLD,is);
if(batch!=null){dao.delete(batch);
if(config!=null){dao.delete(config);
if("sf:foo".equals(model)){exists=true;
if(getLayerId(MockData.STREAMS).equals(l.getDefaultModelObjectAsString())){exists=true;
if(binstanceofAttributeModifier){AttributeModifieram=(AttributeModifier)b;Stringurl=am.toString();assertTrue(!url.contains("gml+xml"));assertTrue(url.contains("gml%2Bxml"));break;
if(binstanceofAttributeModifier){AttributeModifieram=(AttributeModifier)b;Stringurl=am.toString();
if(maxFeatures>0){assertTrue(url.contains("&maxFeatures="+maxFeatures));
else{assertTrue(!url.contains("&maxFeatures="));
if(typeNames==null){returnnull;
iftheartifactismissing,andwillbecreatedondemandatthefirstaccess**@paramexecutionId*@paramoutputName*/ResourcegetArtifact(StringexecutionId,ArtifactTypetype,Stringname);/**Listsallknowndirectoriescontainingprocessartifacts*/List<Resource>listExecutionResourcess();/***Immediatelyremovesallartifactsassociatedtothegivenexecutionid**@paramexecutionId*@throwsIOException*/voidclearArtifacts(StringexecutionId)throwsIOException;}
elseconnectbeforegettingresulthc.connect();//returnhc;
ifwewantthis,thisisanexperimenttotrytoconnect//morethanonce,whichiswhatareasonablewebbrowserwould//doIbelieve.Ormaybewebbrowsersonlytryonce?It'sabit//imperfect,astheinputstreamstuffshouldprobablybeheretoo//since
ifthisisrunningitjustshiftsmoreerrorstoBindExceptions//whenhc.getInputStreamiscalled,sinceit'sconnectedbutnotyet//bound-itdoesn'thavetheactualstreamyet.Soperhapsitneeds//tobeinthelooptoo,thoughwouldthatcauseittogetanew//connection(fromtheconnectmethod)
ifitfailed?And/oristhat//maybethebehaviorthatwewant?Ordowewantittotrytobind//onthesameconnection-ch.(shouldalsomaketheseoptions//userconfigurable...hmmm-howdidIgetropedintowriting//ajavawfsclient?ThisisessentiallywhatthewfsTesterthat//robwrotedoes,andit'saboutasnaive,itjustdoesn'tdo//threads.Ifanyonewantstoexpandonthistheonenicething//tohave,thatrobnevergotto,wouldbesomevalidation//aswell.Shouldn'tbetoohard,justrunxercesschema//checkingonit.Butthenagainthisclasswaswrittentotest//atonofrequestsatonce,nottobeafulltester.Onething//thatwouldbecoolthoughistotakealistofrequestsand//firethemalloffatdifferentintervals.ThoughIfeellike//wemightbeabletofindsomebetterframeworktodothat,//ratherthanjustwritingourown.inttries=0;while(tries<15){try{				connect();				break;
if(concurrent){yield();}			//Thisreadingbitseemstobedamned
ifyoudodamned
ifyoudont			//Thefirstwayensuresthattheclientdoesn'tprematurelyclose			//thesocket,whichhappensonbigGetFeaturerequestsallthe//time,I'mnottoosurewhy,perhapsitgetssettonotready			//whentheunderlyingstreamfromtheserverpausesorsomething.						//Thesecondwayensuresthatwedon'tgeterrorswiththeinput			//streamclosingonus,butforsomereasonIcan'tseemtoreproduce			//themrightnow-theonlyreasonIcanthinkofisbecauseI//changedittoexplicitlycreatetheInputStream,soitdoesn't//getgcedorsomething?I'mnottoosurethough,butasthefirst			//isn'tmessingupatallwe'llstickwithit,asthesecond(original)			//waywasn'tactuallyreadingeverything,soitwasreturningfalse//responsetimes.						//Ohok,itseemsthattheexceptionisonlyonresin,withready			//itworkswithgetCaps,butwithreaditmessesupaboutonein			//40orsowithjava.net.SocketException:socketclosed-soit			//lookslikeresindecidestoclosethesocketprematurelyunder			//heavyduressorsomething.I'mnotsure,butIdefinitelyfeel			//likeI'mtestingservletcontainersfarmorethanGeoServer			//itselfwiththissoliddayoftesting.while(br.read()!=-1);//while(br.ready())//	br.readLine();result=hc.getResponseCode();t3=newDate();yield();//waittoleteveryone
elsehitbeforedisconnectinghc.disconnect();ThreadedBatchTester.threadDone();
elseconnectbeforegettingresulthc.connect();OutputStreamWriterosw=newOutputStreamWriter(hc.getOutputStream());osw.write(request);osw.flush();
elseconnectbeforegettingresultt1=newDate();hc.connect();OutputStreamWriterosw=newOutputStreamWriter(hc.getOutputStream());osw.write(request);osw.flush();t2=newDate();BufferedReaderbr=newBufferedReader(newInputStreamReader(hc.getInputStream()));while(br.ready()){br.readLine();
elsehitbeforedisconnectinghc.disconnect();}catch(Exceptione){e.printStackTrace();result=0;
if(LOGGER.isLoggable(Level.FINE)){parameters.keySet().forEach(parameter->LOGGER.info("Registeringincomingparameter:"+parameter));
if(dimensionName.equals(ResourceInfo.TIME)){DatedateValue=(Date)getDefaultValue(resource,dimensionName,dimensionInfo,Date.class);
if(dateValue==null){returnDimensionDefaultValueSetting.TIME_CURRENT;
else
if(dimensionName.equals(ResourceInfo.ELEVATION)){NumbernumberValue=(Number)getDefaultValue(resource,dimensionName,dimensionInfo,Number.class);
if(numberValue==null){return"0";
else{Objectvalue=getDefaultValue(resource,dimensionName,dimensionInfo,Object.class);retval=value.toString();
if(title==null&&metadata!=null){title=metadata.get("title",String.class);
if(abstractTxt==null&&metadata!=null){abstractTxt=metadata.get("title",String.class);
if(layers!=null&&publishables==null){publishables=newArrayList<PublishedInfo>();for(LayerInfolayer:layers){publishables.add(layer);
if(extension!=null){pagePath=pagePath.substring(0,pagePath.length()-extension.length()-1);
if(pagePath.endsWith("/")){pagePath=pagePath.substring(0,pagePath.length()-1);
if(path!=null){
if(path.startsWith(".")){
if(base.endsWith("/"))base=base.substring(1);path=base+path;
else{path=ResponseUtils.appendPath(base,path);
if(type==null){return"-";
else{Stringname=type.name();try{Stringkey=BandsPanel.class.getSimpleName()+"."+name;ParamResourceModelrm=newParamResourceModel(key,null);returnrm.getString();
if(values==null||values.isEmpty()){return"-";
else{StringBuildersb=newStringBuilder();finalintsize=values.size();for(inti=0;i<size;i++){sb.append(values.get(i));
if(i<size-1){sb.append(",");
if(ci.getDimensions()!=null){returnci.getDimensions();
else{returnCollections.emptyList();
if(workspace!=null){WorkspaceInfows=geoServer.getCatalog().getWorkspaceByName(workspace);service=geoServer.getService(ws,WMSInfo.class);
else{service=geoServer.getService(WMSInfo.class);
if(geoServer!=null){geoServer.removeListener(listener);
if(map.containsKey(oldName)){NamenewName=map.get(oldName);ProcessFactorypf=GeoServerProcessors.createProcessFactory(newName,false);
if(pf!=null){returna.perform(pf,oldName,newName,args);
if(map==null){synchronized(DeprecatedProcessFactory.class){
if(map==null){map=newLinkedHashMap();//JTSnamespaceregisterProcessMapping(newNameImpl("JTS","length"),newNameImpl("geo","length"),map);registerProcessMapping(newNameImpl("JTS","isEmpty"),newNameImpl("geo","isEmpty"),map);registerProcessMapping(newNameImpl("JTS","contains"),newNameImpl("geo","contains"),map);registerProcessMapping(newNameImpl("JTS","disjoint"),newNameImpl("geo","disjoint"),map);registerProcessMapping(newNameImpl("JTS","intersects"),newNameImpl("geo","intersects"),map);registerProcessMapping(newNameImpl("JTS","isClosed"),newNameImpl("geo","isClosed"),map);registerProcessMapping(newNameImpl("JTS","isValid"),newNameImpl("geo","isValid"),map);registerProcessMapping(newNameImpl("JTS","buffer"),newNameImpl("geo","buffer"),map);registerProcessMapping(newNameImpl("JTS","getY"),newNameImpl("geo","getY"),map);registerProcessMapping(newNameImpl("JTS","getX"),newNameImpl("geo","getX"),map);registerProcessMapping(newNameImpl("JTS","union"),newNameImpl("geo","union"),map);registerProcessMapping(newNameImpl("JTS","intersection"),newNameImpl("geo","intersection"),map);registerProcessMapping(newNameImpl("JTS","difference"),newNameImpl("geo","difference"),map);registerProcessMapping(newNameImpl("JTS","distance"),newNameImpl("geo","distance"),map);registerProcessMapping(newNameImpl("JTS","envelope"),newNameImpl("geo","envelope"),map);registerProcessMapping(newNameImpl("JTS","dimension"),newNameImpl("geo","dimension"),map);registerProcessMapping(newNameImpl("JTS","overlaps"),newNameImpl("geo","overlaps"),map);registerProcessMapping(newNameImpl("JTS","reproject"),newNameImpl("geo","reproject"),map);registerProcessMapping(newNameImpl("JTS","simplify"),newNameImpl("geo","simplify"),map);registerProcessMapping(newNameImpl("JTS","isSimple"),newNameImpl("geo","isSimple"),map);registerProcessMapping(newNameImpl("JTS","equalsExact"),newNameImpl("geo","equalsExact"),map);registerProcessMapping(newNameImpl("JTS","getGeometryN"),newNameImpl("geo","getGeometryN"),map);registerProcessMapping(newNameImpl("JTS","isWithinDistance"),newNameImpl("geo","isWithinDistance"),map);registerProcessMapping(newNameImpl("JTS","touches"),newNameImpl("geo","touches"),map);registerProcessMapping(newNameImpl("JTS","crosses"),newNameImpl("geo","crosses"),map);registerProcessMapping(newNameImpl("JTS","within"),newNameImpl("geo","within"),map);registerProcessMapping(newNameImpl("JTS","relate"),newNameImpl("geo","relate"),map);registerProcessMapping(newNameImpl("JTS","convexHull"),newNameImpl("geo","convexHull"),map);registerProcessMapping(newNameImpl("JTS","symDifference"),newNameImpl("geo","symDifference"),map);registerProcessMapping(newNameImpl("JTS","centroid"),newNameImpl("geo","centroid"),map);registerProcessMapping(newNameImpl("JTS","interiorPoint"),newNameImpl("geo","interiorPoint"),map);registerProcessMapping(newNameImpl("JTS","numPoints"),newNameImpl("geo","numPoints"),map);registerProcessMapping(newNameImpl("JTS","area"),newNameImpl("geo","area"),map);registerProcessMapping(newNameImpl("JTS","isRing"),newNameImpl("geo","isRing"),map);registerProcessMapping(newNameImpl("JTS","exteriorRing"),newNameImpl("geo","exteriorRing"),map);registerProcessMapping(newNameImpl("JTS","numInteriorRing"),newNameImpl("geo","numInteriorRing"),map);registerProcessMapping(newNameImpl("JTS","numGeometries"),newNameImpl("geo","numGeometries"),map);registerProcessMapping(newNameImpl("JTS","geometryType"),newNameImpl("geo","geometryType"),map);registerProcessMapping(newNameImpl("JTS","boundary"),newNameImpl("geo","boundary"),map);registerProcessMapping(newNameImpl("JTS","densify"),newNameImpl("geo","densify"),map);registerProcessMapping(newNameImpl("JTS","relatePattern"),newNameImpl("geo","relatePattern"),map);registerProcessMapping(newNameImpl("JTS","equalsExactTolerance"),newNameImpl("geo","equalsExactTolerance"),map);registerProcessMapping(newNameImpl("JTS","pointN"),newNameImpl("geo","pointN"),map);registerProcessMapping(newNameImpl("JTS","startPoint"),newNameImpl("geo","startPoint"),map);registerProcessMapping(newNameImpl("JTS","endPoint"),newNameImpl("geo","endPoint"),map);registerProcessMapping(newNameImpl("JTS","interiorRingN"),newNameImpl("geo","interiorRingN"),map);registerProcessMapping(newNameImpl("JTS","polygonize"),newNameImpl("geo","polygonize"),map);registerProcessMapping(newNameImpl("JTS","splitPolygon"),newNameImpl("geo","splitPolygon"),map);//gsgeometryprocessesregisterProcessMapping(newNameImpl("gs","ReprojectGeometry"),newNameImpl("geo","reproject"),map);//gsfeatureprocessesregisterProcessMapping(newNameImpl("gs","Aggregate"),newNameImpl("vec","Aggregate"),map);registerProcessMapping(newNameImpl("gs","Bounds"),newNameImpl("vec","Bounds"),map);registerProcessMapping(newNameImpl("gs","BufferFeatureCollection"),newNameImpl("vec","BufferFeatureCollection"),map);registerProcessMapping(newNameImpl("gs","Centroid"),newNameImpl("vec","Centroid"),map);registerProcessMapping(newNameImpl("gs","Clip"),newNameImpl("vec","Clip"),map);registerProcessMapping(newNameImpl("gs","CollectGeometries"),newNameImpl("vec","CollectGeometries"),map);registerProcessMapping(newNameImpl("gs","Count"),newNameImpl("vec","Count"),map);registerProcessMapping(newNameImpl("gs","Feature"),newNameImpl("vec","Feature"),map);registerProcessMapping(newNameImpl("gs","Grid"),newNameImpl("vec","Grid"),map);registerProcessMapping(newNameImpl("gs","InclusionFeatureCollection"),newNameImpl("vec","InclusionFeatureCollection"),map);registerProcessMapping(newNameImpl("gs","IntersectionFeatureCollection"),newNameImpl("vec","IntersectionFeatureCollection"),map);registerProcessMapping(newNameImpl("gs","LRSGeocode"),newNameImpl("vec","LRSGeocode"),map);registerProcessMapping(newNameImpl("gs","LRSMeasure"),newNameImpl("vec","LRSMeasure"),map);registerProcessMapping(newNameImpl("gs","LRSSegment"),newNameImpl("vec","LRSSegment"),map);registerProcessMapping(newNameImpl("gs","Nearest"),newNameImpl("vec","Nearest"),map);registerProcessMapping(newNameImpl("gs","PointBuffers"),newNameImpl("vec","PointBuffers"),map);registerProcessMapping(newNameImpl("gs","PointStacker"),newNameImpl("vec","PointStacker"),map);registerProcessMapping(newNameImpl("gs","Query"),newNameImpl("vec","Query"),map);registerProcessMapping(newNameImpl("gs","RectangularClip"),newNameImpl("vec","RectangularClip"),map);registerProcessMapping(newNameImpl("gs","Reproject"),newNameImpl("vec","Reproject"),map);registerProcessMapping(newNameImpl("gs","Simplify"),newNameImpl("vec","Simplify"),map);registerProcessMapping(newNameImpl("gs","Snap"),newNameImpl("vec","Snap"),map);registerProcessMapping(newNameImpl("gs","Transform"),newNameImpl("vec","Transform"),map);registerProcessMapping(newNameImpl("gs","UnionFeatureCollection"),newNameImpl("vec","UnionFeatureCollection"),map);registerProcessMapping(newNameImpl("gs","Unique"),newNameImpl("vec","Unique"),map);registerProcessMapping(newNameImpl("gs","VectorZonalStatistics"),newNameImpl("vec","VectorZonalStatistics"),map);registerProcessMapping(newNameImpl("gs","Heatmap"),newNameImpl("vec","Heatmap"),map);registerProcessMapping(newNameImpl("gs","BarnesSurface"),newNameImpl("vec","BarnesSurface"),map);//gsrasterprocessesregisterProcessMapping(newNameImpl("gs","AddCoverages"),newNameImpl("ras","AddCoverages"),map);registerProcessMapping(newNameImpl("gs","AreaGrid"),newNameImpl("ras","AreaGrid"),map);registerProcessMapping(newNameImpl("gs","Contour"),newNameImpl("ras","Contour"),map);registerProcessMapping(newNameImpl("gs","CropCoverage"),newNameImpl("ras","CropCoverage"),map);registerProcessMapping(newNameImpl("gs","MultiplyCoverages"),newNameImpl("ras","MultiplyCoverages"),map);registerProcessMapping(newNameImpl("gs","PolygonExtraction"),newNameImpl("ras","PolygonExtraction"),map);registerProcessMapping(newNameImpl("gs","RangeLookup"),newNameImpl("ras","RangeLookup"),map);registerProcessMapping(newNameImpl("gs","RasterAsPointCollection"),newNameImpl("ras","RasterAsPointCollection"),map);registerProcessMapping(newNameImpl("gs","RasterZonalStatistics"),newNameImpl("ras","RasterZonalStatistics"),map);registerProcessMapping(newNameImpl("gs","ScaleCoverage"),newNameImpl("ras","ScaleCoverage"),map);registerProcessMapping(newNameImpl("gs","StyleCoverage"),newNameImpl("ras","StyleCoverage"),map);//gtvectorprocessesregisterProcessMapping(newNameImpl("gt","VectorToRaster"),newNameImpl("vec","VectorToRaster"),map);
if(GeoServerProcessors.createProcess(newName)!=null){map.put(oldName,newName);
if(eventinstanceofContextLoadedEvent){//JD:lookupGeoServerandregisternowratherthanuseconstructorinjection//toavoidcirculardependencyduringserviceloadingstartupgeoServer=GeoServerExtensions.bean(GeoServer.class,((ContextLoadedEvent)event).getApplicationContext());listener=newConfigurationListenerAdapter(){@OverridepublicvoidhandleServiceChange(ServiceInfoservice,List<String>propertyNames,List<Object>oldValues,List<Object>newValues){
if(serviceinstanceofWPSInfo){resetProcessMappings();
if(eventinstanceofContextRefreshedEvent){Processors.addProcessFactory(this);
else
if(eventinstanceofContextClosedEvent){Processors.removeProcessFactory(this);
if(sourceCoverage!=null){scheduleForCleaning(sourceCoverage);
if(ramp==null)thrownewNullPointerException("Thecolorrampcannotbenull");this.ramp=ramp;this.catalog=catalog;
if(gd==null)returncatalog.getStyleByName(StyleInfo.DEFAULT_POINT);Classgtype=gd.getType().getBinding();StyleTypest;
if(LineString.class.isAssignableFrom(gtype)||MultiLineString.class.isAssignableFrom(gtype)){st=StyleType.LINE;
else
if(Polygon.class.isAssignableFrom(gtype)||MultiPolygon.class.isAssignableFrom(gtype)){st=StyleType.POLYGON;
else
if(Point.class.isAssignableFrom(gtype)||MultiPoint.class.isAssignableFrom(gtype)){st=StyleType.POINT;
else{st=StyleType.GENERIC;
if(directMessage){message+="-Directgenerationfailedwitherror:"+e.getMessage();
if(e1.getMessage()!=null&&!"".equals(e1.getMessage().trim())){
if(directMessage){message+=",and";
else{message+="-";
if(workspace!=null){style.setWorkspace(workspace);
ifanyremovedobjectisonthelist)WebMarkupContainerremoved=newWebMarkupContainer("removedObjects");add(removed);//removedWebMarkupContainerrulesRemoved=newWebMarkupContainer("rulesRemoved");removed.add(rulesRemoved);
if(roots.size()==0)removed.setVisible(false);
else{rulesRemoved.add(newListView<String>("rules",names(roots)){@OverrideprotectedvoidpopulateItem(ListItem<String>item){item.add(newLabel("name",item.getModelObject()));
if(problems.size()==0)problematic.setVisible(false);
else{rulesNotRemoved.add(newListView<String>("problems",problems(problems)){@OverrideprotectedvoidpopulateItem(ListItem<String>item){item.add(newLabel("name",item.getModelObject()));
if(model==null)roots.add(obj);
elseproblems.add(model);
if*strictlynecessary(currentusecase,figuringout
ifthegroupisqueryableornot)**@return*/publicList<PublishedInfo>getOriginalLayers(){returndelegate.getLayers();
ifRequestisGetCapabilitiesandLayeroritsResourcearenotadvertised.**@paramlayer*/privatebooleanhideLayer(LayerInfolayer){
if(!layer.isAdvertised()){returncheckCapabilitiesRequest(layer.getResource());
else{returnhideResource(layer.getResource());
ifit'snotadvertisedandRequestisGetCapabilities.**@paramresource*/privatebooleanhideResource(ResourceInforesource){
if(!resource.isAdvertised()){returncheckCapabilitiesRequest(resource);
else{returnfalse;
ifthelayershouldbehidden,falseotherwise**<ol>*<li>hasarequest*<li>isaGetCapabilitiesrequest*<li>isnotforalayer-specificvirtualservice*</ol>*/booleancheckCapabilitiesRequest(ResourceInforesource){Requestrequest=Dispatcher.REQUEST.get();
if(request!=null){
if("GetCapabilities".equalsIgnoreCase(request.getRequest())){StringresourceContext=resource.getNamespace().getPrefix()+"/"+resource.getName();return!resourceContext.equalsIgnoreCase(request.getContext());
if(resource==null||hideResource(resource)){returnnull;
else{returnresource;
if(layer==null||hideLayer(layer)){returnnull;
else{returnlayer;
if(group==null){returnnull;
iftherequestisnotaGetCapabilitiesRequestrequest=Dispatcher.REQUEST.get();
if(request==null||!"GetCapabilities".equalsIgnoreCase(request.getRequest())){returngroup;
if(pinstanceofLayerInfo){p=checkAccess((LayerInfo)p);
else{p=checkAccess((LayerGroupInfo)p);
if(p!=null){filteredLayers.add(p);filteredStyles.add(style);
if(layerGroupPolicy.hideLayerGroup(group,filteredLayers)){returnnull;
else{
if(!group.getLayers().equals(filteredLayers)){returnnewAdvertisedLayerGroup(group,filteredLayers,filteredStyles);
else{returngroup;
if(resource!=null){filtered.add(resource);
if(group!=null){filtered.add(group);
if(layer!=null){filtered.add(layer);
if(!isOgcCapabilitiesRequest()){//Notneededforotherkindsofrequest//TODOuseacommonimplementationforGetCapabilitiesandLayerPreviewreturnfilter;
if(!ResourceInfo.class.isAssignableFrom(infoType)&&!LayerInfo.class.isAssignableFrom(infoType)&&!LayerGroupInfo.class.isAssignableFrom(infoType)){//thesekindofobjectsarenotsecuredreturnfilter;
ifthecataloginfoshallbehidden,{@codetrue}*otherwise.*/@OverridepublicBooleanevaluate(Objectinfo){
if(infoinstanceofResourceInfo){return!hideResource((ResourceInfo)info);
else
if(infoinstanceofLayerInfo){return!hideLayer((LayerInfo)info);
else
if(infoinstanceofLayerGroupInfo){returncheckAccess((LayerGroupInfo)info)!=null;
else{thrownewIllegalArgumentException("Can'tbuildfilterforobjectsoftype"+info.getClass().getName());
if(layerGroupinstanceofAdvertisedLayerGroup){AbstractDecorator<LayerGroupInfo>decorator=(AbstractDecorator<LayerGroupInfo>)layerGroup;LayerGroupInfounwrapped=decorator.unwrap(LayerGroupInfo.class);delegate.save(unwrapped);
else{delegate.save(layerGroup);
if(clearActiveTX){
if(TransactionSynchronizationManager.isSynchronizationActive()){try{TransactionSynchronizationManager.unbindResource(sessionFactory);
if(session.isOpen()){session.close();
if(binding==null){thrownewNullPointerException("bindingmaynotbenull");
if(outputFormats==null){outputFormats=Collections.emptySet();
if(outputFormats.isEmpty()){returnnull;
iftheresponsecanhandletheoperationbeingperformed.**<p>Thismethodiscalledbefore{@link#write(Object,OutputStream,Operation)}.**<p>Subclassesshouldoverridethismethodtoperformadditionalchecksagainsttheoperation*beingperformed.Examplemightbecheckingtheversionoftheservice.**@paramoperationTheoperationbeingperformed.*@return<code>true</code>
iftheresponsecanhandletheoperation,otherwise<code>false*</code>*/publicbooleancanHandle(Operationoperation){returntrue;
iftherearenoheaderstobesetontheresponse.**@paramvalueThevaluetoserialize*@paramoperationTheoperationbeingperformed.*@return2xnstringarraycontainingstring-pairsofHTTPheaders/values*/publicString[][]getHeaders(Objectvalue,Operationoperation)throwsServiceException{//defaultimplementationreturnsnull=noheaderstosetreturnnull;
if(mimeType!=null){name="geoserver";
if(opName!=null){name=name+"-"+opName;
if(delegate!=null){returndelegate.issueRequest(request);
else{returnnull;
ifthesetdidnotcontaintherulealready,falseotherwise*/publicbooleanaddRule(Rrule){lastModified=System.currentTimeMillis();returnrules.add(rule);
if(einstanceofIOException)throw(IOException)e;
elsethrow(IOException)newIOException("Couldnotwriterulesto"+propertyFileName).initCause(e);
if(os!=null)os.close();
if(rules==null||force){//nosecurityfolder,let'sworkagainstanemptypropertiesthen
if(securityDir==null||securityDir.getType()==Type.UNDEFINED){this.rules=newTreeSet<R>();
else{//nosecurityconfig,let'sworkagainstanemptypropertiesthenResourcelayers=securityDir.get(propertyFileName);
if(layers.getType()==Type.UNDEFINED){//trytoloadatemplateandcopyitoverInputStreamin=getClass().getResourceAsStream(propertyFileName+".template");
if(in!=null){IOUtils.copy(in,layers.out());
if(layers.getType()==Type.UNDEFINED){this.rules=newTreeSet<R>();
else{//ok,somethingisthere,let'sloaditwatcher=newPropertyFileWatcher(layers);loadRules(watcher.getProperties());
else
if(isModified()){loadRules(watcher.getProperties());lastModified=System.currentTimeMillis();
ifanyoftherolesis*wejustremovealloftheothersfor(Stringrole:roles){
if(ANY.equals(role))returnCollections.singleton("*");
if(parameterValues==null){parameterValues=taskUtil.getParameterValues(task);
if(pl.getName().equals(prefixedName)){returnpl;
if(origDesc==null){returnfeature;
ifdoesnotexistsimporter.getUploadRoot();//Readthefolderagain...dirFromProperties=Resources.directory(Resources.fromPath("props_uploads"));//...andensureitisthesameasdefinedonthe.propertiesfileassertEquals(dirFromProperties,importer.getUploadRoot());//Let'snowoverridetheexternalfolderthroughtheEnvironmentvariable.Thistakes//precedenceon.propertiesSystem.setProperty(Importer.UPLOAD_ROOT_KEY,"env_uploads");//Let'scheckthattheuploadrootisnowdifferentfromthepreviousone...assertNotEquals(dirFromProperties,importer.getUploadRoot());//...butitisequaltotheonedefinedthroughtheEnvironmentvariableinstead//Readthefolderagain...dirFromProperties=Resources.directory(Resources.fromPath("env_uploads"));//...andensureitisthesameasdefinedonthe.propertiesfileassertEquals(dirFromProperties,importer.getUploadRoot());
iftheyweredigestedproperlyStringtype_ch=(String)next.getAttribute("type_ch");assertEquals("卫",type_ch);Stringname_ch=(String)next.getAttribute("name_ch");assertEquals("杭州前卫",name_ch);it.close();
if(context.getTasks().get(0).getLayer().getName().equals("archsites")){assertEquals(archsitesCount,archsitesCount2);assertEquals(bugsitesCount*2,bugsitesCount2);
else{assertEquals(archsitesCount*2,archsitesCount2);assertEquals(bugsitesCount,bugsitesCount2);
if(!SystemUtils.IS_OS_WINDOWS){assertFalse(dir.exists());
if(error!=null){error.printStackTrace();fail(error.getMessage());
if(info.getDescriptor(i).getLocalName().equals("geometry")){cnt++;
ifbashisthereAssume.assumeTrue("Couldnotfindshinpath,skipping",checkShellAvailable());//writeoutasimpleshellscriptinthedatadirandmakeitexecutableFilescripts=getDataDirectory().findOrCreateDir("importer","scripts");Filescript=newFile(scripts,"test.sh");FileUtils.writeStringToFile(script,"touchtest.properties\n");script.setExecutable(true,true);//createasimpleimportandplacethescriptinthetransformchainFiledir=unpack("shape/archsites_epsg_prj.zip");ImportContextcontext=importer.createContext(newSpatialFile(newFile(dir,"archsites.shp")));assertEquals(1,context.getTasks().size());ImportTasktask=context.getTasks().get(0);assertEquals(ImportTask.State.READY,task.getState());assertEquals("archsites",task.getLayer().getResource().getName());TransformChaintransformChain=task.getTransform();transformChain.add(newPostScriptTransform("test.sh",Collections.emptyList()));importer.run(context);//checktheimportrunnormallyassertEquals(ImportContext.State.COMPLETE,context.getState());Catalogcat=getCatalog();assertNotNull(cat.getLayerByName("archsites"));assertEquals(ImportTask.State.COMPLETE,task.getState());runChecks("archsites");//verifythescriptalsorunFiletestFile=newFile(scripts,"test.properties");assertTrue(testFile.exists());
ifshisthereAssume.assumeTrue(newFile("/bin/sh").exists());try{newPostScriptTransform("/bin/sh",Collections.emptyList());fail("Shouldhavefaileddisallowingusageofabsoutepath");
if(workspaceName!=null){WorkspaceInfows=geoServer.getCatalog().getWorkspaceByName(workspaceName);
if(ws==null){thrownewRestException("Workspace"+workspaceName+"doesnotexist",HttpStatus.NOT_FOUND);
else{service=geoServer.getService(clazz);
if(service==null){StringerrorMessage="Servicedoesnotexist"+(workspaceName==null?"":"forworkspace"+workspaceName);thrownewRestException(errorMessage,HttpStatus.NOT_FOUND);
if(workspaceName!=null)ws=geoServer.getCatalog().getWorkspaceByName(workspaceName);ServiceInfooriginalInfo;
if(ws!=null){originalInfo=geoServer.getService(ws,clazz);
else{originalInfo=geoServer.getService(clazz);
if(originalInfo!=null){OwsUtils.copy(info,originalInfo,clazz);geoServer.save(originalInfo);
else{
if(ws!=null){info.setWorkspace(ws);
if(ws==null){thrownewRestException("Workspace"+workspaceName+"doesnotexist",HttpStatus.NOT_FOUND);
if(serviceInfo!=null){geoServer.remove(serviceInfo);
if(config==null){returnBruteForcePreventionConfig.DEFAULT;
else{returnconfig;
if(!config.isEnabled()){return;
if(requestAddressInWhiteList(request,config)){return;
if(name==null){LOGGER.warning("Bruteforceattackpreventionenabled,butSpringAuthentication"+"doesnotprovideausername,skipping:"+authentication);
ifsuccessfulornotfinalAtomicIntegercounter=delayedUsers.get(name);
if(counter!=null){intcount=counter.incrementAndGet();logFailedRequest(request,name,count);thrownewConcurrentAuthenticationException(name,count);
if(eventinstanceofAuthenticationFailureBadCredentialsEvent||eventinstanceofAuthenticationFailureProviderNotFoundEvent){//areweabovethemaxnumberofblockedthreadsalready?intmaxBlockedThreads=config.getMaxBlockedThreads();
if(maxBlockedThreads>0&&delayedUsers.size()>maxBlockedThreads){thrownewMaxBlockedThreadsException(1);
if(delay>0){
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Bruteforceattackprevention,delayingloginfor"+delay+"ms");
if(config.getWhitelistAddressMatchers()==null){returnfalse;
ifmissingorcannotbedetermined**@paramauthentication*@return*/privateStringgetUserName(Authenticationauthentication){
if(authentication==null){returnnull;
if(principal!=null){
if(principalinstanceofUserDetails){return((UserDetails)principal).getUsername();
else
if(principalinstanceofString){return(String)principal;
if(forwardedFor!=null){sb.append(",forwardedfor").append(forwardedFor);
if(count>0){sb.append(",stopped").append(count).append("concurrentloginsduringauthenticationdelay");
if(!Resources.exists(f)){/**Copyandusethesamplenotifier*/IOUtils.copy(getClass().getClassLoader().getResourceAsStream(NotifierInitializer.PROPERTYFILENAME),f.file());
if(!cancelled&&System.currentTimeMillis()>timeoutTime){this.thrown=true;thrownewWFSException(request,"Timeoutexceeded",TIMEOUT_EXCEPTION_CODE);
if(!this.cancelled){
if(!this.thrown){LOGGER.log(Level.FINE,"Timeoutcancelled(presumablyasGeoServerstartedtowriteouttheresponse)");
if(type.isAssignableFrom(String.class)){return(IConverter<C>)newIConverter<String>(){privatestaticfinallongserialVersionUID=4343895199315509104L;publicStringconvertToString(Stringinput,Localelocale){
if(input.startsWith("#")){returninput.substring(1);
else{returninput;
if(value.equals(""))returnvalue;return"#"+value;
if(validators!=null){for(IValidatorvalidator:validators){textField.add(validator);
if(current!=null&&current.equals(root))files.add(root);//reversetheorder,wewantthemorderedfromroot//tocurrentCollections.reverse(files);returnfiles;
if(userFilter){config.setGroupSearchFilter("member={1},dc=example,dc=com");config.setUserFilter("uid={0}");
else{config.setGroupSearchFilter("member=cn={0}");
ifit'sreallyhardontheeyes....**@throwsException*/@TestpublicvoidtestGetXMLById()throwsException{MockHttpServletResponseresponse=getAsServletResponse(RestBaseController.ROOT_PATH+"/monitor/requests/5.xml");assertEquals(200,response.getStatus());Documentdom=dom(newByteArrayInputStream(response.getContentAsByteArray()));//print(dom);assertXpathEvaluatesTo("5","/org.geoserver.monitor.RequestData/id",dom);assertXpathEvaluatesTo("RUNNING","/org.geoserver.monitor.RequestData/status",dom);
ifit'sreallyhardontheeyes....**@throwsException*/@TestpublicvoidtestGetJSONById()throwsException{MockHttpServletResponseresponse=getAsServletResponse(RestBaseController.ROOT_PATH+"/monitor/requests/5.json");assertEquals(200,response.getStatus());JSONObjectjson=(JSONObject)json(response);//print(json);JSONObjectdata=json.getJSONObject("org.geoserver.monitor.RequestData");assertNotNull(data);assertEquals("5",data.getString("id"));assertEquals("RUNNING",data.getString("status"));
if("requests.csv".equals(entry.getName())){requests=true;Stringexpected="id,path,startTime\n12345,/foo,"+DateUtil.serializeDateTime(startTime);assertEquals(expected,readEntry(zin));
else
if("body.txt".equals(entry.getName())){body=true;assertEquals("<foo></foo>",readEntry(zin));
else
if("error.txt".equals(entry.getName())){error=true;ByteArrayOutputStreambout=newByteArrayOutputStream();PrintStreamstream=newPrintStream(bout);throwable.printStackTrace(stream);stream.flush();assertEquals(newString(bout.toByteArray()).trim(),readEntry(zin));
ifupdatetimeischangedassertTrue(secondTime.getTime()>firstTime.getTime());Thread.sleep(1000);tester.executeAllTimerBehaviors(tester.getLastRenderedPage());TagTestertime3=tester.getTagByWicketId("time");assertNotNull(time3);DatethirdTime=formatter.parse(time3.getValue());//Check
ifupdatetimeischanged(use500msduetotimeimprecision)assertTrue(thirdTime.getTime()>secondTime.getTime());}}
ifthepassedMimeTypeisavalidjsonp**@paramtypetheMimeTypestringrepresentationtocheck*@returntrue
iftypeisequalsIgnoreCaseto{@link#jsonp}*/publicstaticbooleanisJsonpMimeType(Stringtype){returnJSONType.jsonp.equalsIgnoreCase(type);
ifthepassedMimeTypeisavalidjsonpand
ifjsonpisenabled**@paramtypetheMimeTypestringrepresentationtocheck*@returntrue
iftypeisequalsIgnoreCaseto{@link#jsonp}andjsonpisenabled*@see{@linkJSONType#isJsonMimeType(String)}*/publicstaticbooleanuseJsonp(Stringtype){returnJSONType.isJsonpEnabled()&&JSONType.isJsonpMimeType(type);
if(jsonpEnabled!=JSONType.jsonpEnabled){lock.writeLock().lock();try{JSONType.jsonpEnabled=jsonpEnabled;
ifthestringargumentofthe*ENABLE_JSONPpropertyisnotnullandisequal,ignoringcase,tothestring"true".*/privatestaticbooleanisJsonpPropertyEnabled(){Stringjsonp=GeoServerExtensions.getProperty(ENABLE_JSONP_KEY);returnBoolean.parseBoolean(jsonp);
ifthepassedMimeTypeisavalidjson**@paramtypetheMimeTypestringrepresentationtocheck*@returntrue
iftypeisequalsIgnoreCaseto{@linkJSONType#json}orto{@link*JSONType#simple_json}*/publicstaticbooleanisJsonMimeType(Stringtype){returnJSONType.json.equalsIgnoreCase(type)||JSONType.simple_json.equalsIgnoreCase(type);
if(json.equalsIgnoreCase(mime)||simple_json.equalsIgnoreCase(mime)){returnJSON;
else
if(jsonp.equalsIgnoreCase(mime)){returnJSONP;
else{returnnull;//notvalidrepresentation
switch(this){caseJSON:returnjson;caseJSONP:returnjsonp;default:returnnull;
if(isJsonpEnabled())returnnewString[]{json,simple_json,jsonp};
elsereturnnewString[]{json,simple_json};
if*notfound.*/publicstaticStringgetCallbackFunction(Mapkvp){
if(!(kvp.get("FORMAT_OPTIONS")instanceofMap)){returnJSONType.CALLBACK_FUNCTION;
else{Map<String,String>map=(Map<String,String>)kvp.get("FORMAT_OPTIONS");Stringcallback=map.get(CALLBACK_FUNCTION_KEY);
if(callback!=null){returncallback;
else{returnJSONType.CALLBACK_FUNCTION;
if(!(kvp.get("FORMAT_OPTIONS")instanceofMap)){returnnull;
else{Map<String,String>formatOptions=(Map<String,String>)kvp.get("FORMAT_OPTIONS");
if(formatOptions==null||formatOptions.isEmpty()){returnnull;//usefidasidinoutput
if(id_policy==null||"true".equals(id_policy)){returnnull;//usefidasidinoutput
if("false".equals(id_policy)||id_policy.length()==0){return"";//suppressidfromoutput
switchwritingjson(false)orjsonp(true)*/publicstaticvoidhandleJsonException(LoggerLOGGER,ServiceExceptionexception,Requestrequest,Stringcharset,booleanverbose,booleanisJsonp){finalHttpServletResponseresponse=request.getHttpResponse();//TODO:serverencodingoptions?response.setCharacterEncoding(charset);ServletOutputStreamos=null;try{os=response.getOutputStream();
if(isJsonp){//jsonpresponse.setContentType(JSONType.jsonp);JSONType.writeJsonpException(exception,request,os,charset,verbose);
else{//jsonOutputStreamWriteroutWriter=null;try{outWriter=newOutputStreamWriter(os,charset);response.setContentType(JSONType.json);JSONType.writeJsonException(exception,request,outWriter,verbose);
if(outWriter!=null){try{outWriter.flush();
if(LOGGER!=null&&LOGGER.isLoggable(Level.SEVERE))LOGGER.severe(e.getLocalizedMessage());
if(os!=null){try{os.flush();
if(request==null){callback=JSONType.CALLBACK_FUNCTION;
else{callback=JSONType.getCallbackFunction(request.getKvp());
if((exception.getMessage()!=null)){StringBuffersb=newStringBuffer(exception.getMessage().length());OwsUtils.dumpExceptionMessages(exception,sb,false);
if(verbose){ByteArrayOutputStreamstackTrace=null;try{stackTrace=newByteArrayOutputStream();exception.printStackTrace(newPrintStream(stackTrace));sb.append("\nDetails:\n");sb.append(newString(stackTrace.toByteArray()));
iftheserviceoperationsexecutereallyfastandare*supposedtobehitbyalargenumberofconcurrentrequests,asinthecaseofGeoWebCachetile*requests,wherethesynchronizedblocksinthereflectivemethodinvocationsmayimposea*noticeableperformancedegradation.**<p>Atthetimeofwriting(March2012)thisbehaviourhasbeennoticedinbothSunJava6and*Java7JDK's,othervirtualmachineimplementationsmayormaynotincurrinsuchperformance*penalty.*/publicinterfaceDirectInvocationService{/***Providesamoredirectwayofinvokingaserviceoperationthanusingreflection.**@paramoperationNamethenameoftheoperationtoexecute,asdeclaredinthe{@link*Service#getOperations()serviceoperations}fortheservicedescriptorthattargetsthis*serviceobject.*@paramparametersthelistofparametersfortheactualoperation,as
iftheactualmethod*wereinvokedthrough{@linkMethod#invoke(Object,Object...)}*@returntheoperationresult*@throwsIllegalArgumentException
ifeithertheoperationnameorargumentslistdoesn'tmatch*oneoftheserviceprovidedoperationsunderanyothercircumstances,specifictothe*operationbeingexecuted*/ObjectinvokeDirect(StringoperationName,Object[]parameters)throwsIllegalArgumentException,Exception;}
if(this.projectionPolicy==ProjectionPolicy.FORCE_DECLARED){finalHintscrsHints=newHints(Hints.DEFAULT_COORDINATE_REFERENCE_SYSTEM,this.getCRS());
if(hints!=null)hints.putAll(crsHints);
elsehints=crsHints;
if(this.projectionPolicy==ProjectionPolicy.FORCE_DECLARED){finalHintscrsHints=newHints(Hints.DEFAULT_COORDINATE_REFERENCE_SYSTEM,this.getCRS());
if(hints!=null)hints.putAll(crsHints);
elsehints=crsHints;
if(this.projectionPolicy==ProjectionPolicy.FORCE_DECLARED){finalHintscrsHints=newHints(Hints.DEFAULT_COORDINATE_REFERENCE_SYSTEM,this.getCRS());
if(hints!=null)hints.putAll(crsHints);
elsehints=crsHints;
if(!(objinstanceofCoverageInfo)){returnfalse;
if(!super.equals(obj)){returnfalse;
if(defaultInterpolationMethod==null){
if(other.getDefaultInterpolationMethod()!=null)returnfalse;
else
if(!defaultInterpolationMethod.equals(other.getDefaultInterpolationMethod()))returnfalse;
if(dimensions==null){
if(other.getDimensions()!=null)returnfalse;
else
if(!dimensions.equals(other.getDimensions()))returnfalse;
if(grid==null){
if(other.getGrid()!=null)returnfalse;
else
if(!grid.equals(other.getGrid()))returnfalse;
if(interpolationMethods==null){
if(other.getInterpolationMethods()!=null)returnfalse;
else
if(!interpolationMethods.equals(other.getInterpolationMethods()))returnfalse;
if(nativeFormat==null){
if(other.getNativeFormat()!=null)returnfalse;
else
if(!nativeFormat.equals(other.getNativeFormat()))returnfalse;
if(parameters==null){
if(other.getParameters()!=null)returnfalse;
else
if(!parameters.equals(other.getParameters()))returnfalse;
if(requestSRS==null){
if(other.getRequestSRS()!=null)returnfalse;
else
if(!requestSRS.equals(other.getRequestSRS()))returnfalse;
if(responseSRS==null){
if(other.getResponseSRS()!=null)returnfalse;
else
if(!responseSRS.equals(other.getResponseSRS()))returnfalse;
if(supportedFormats==null){
if(other.getSupportedFormats()!=null)returnfalse;
else
if(!supportedFormats.equals(other.getSupportedFormats()))returnfalse;
if(nativeCoverageName==null){
if(other.getNativeCoverageName()!=null)returnfalse;
else
if(!nativeCoverageName.equals(other.getNativeCoverageName()))returnfalse;returntrue;
if(i!=length-1){syntax+=",";
if(key.equals(ScriptEngine.NAME)){return"javascript";
else
if(key.equals(ScriptEngine.ENGINE)){return"MozillaRhino";
else
if(key.equals(ScriptEngine.ENGINE_VERSION)){return"1.7R4";
else
if(key.equals(ScriptEngine.LANGUAGE)){return"ECMAScript";
else
if(key.equals(ScriptEngine.LANGUAGE_VERSION)){return"1.8";
else
if(key.equals("THREADING")){return"MULTITHREADED";
else{thrownewIllegalArgumentException("Invalidkey");
if(requireBuilder==null){synchronized(this){
if(requireBuilder==null){requireBuilder=newRequireBuilder();requireBuilder.setSandboxed(false);List<URI>uris=newArrayList<URI>();
if(modulePaths!=null){for(Stringpath:modulePaths){try{URIuri=newURI(path);
if(!uri.isAbsolute()){//callresolve("")tocanonifythepathuri=newFile(path).toURI().resolve("");
if(!uri.toString().endsWith("/")){//makesureURIalwaysterminateswithslashto//avoidloadingfromunintendedlocationsuri=newURI(uri+"/");
if(methods!=null&&methods.isEmpty())//methods=null;this.matchers=matchers;
if(matchesHTTPMethod(request)==false)returnfalse;
if(matchers==null)returnfalse;for(RequestMatchermatcher:matchers){
if(matcher.matches(request))returntrue;
iftheHTTPmethodiscontainedin{@link#methods}**@paramrequest*/protectedbooleanmatchesHTTPMethod(HttpServletRequestrequest){
if(methods==null)returntrue;HTTPMethodmethod=HTTPMethod.fromString(request.getMethod());returnmethods.contains(method);}}
if(logStore!=null){logStore.destroy();
if(!properties.isEmpty()){ResourceconfigFile=dirResource.get(LogStore.CONFIG_FILE_NAME);try{try(Writerwriter=newOutputStreamWriter(configFile.out(),Charsets.UTF_8)){properties.store(writer,"");
if(line.startsWith("#")||line.startsWith("-")||line.isEmpty()){continue;
if(line.endsWith(";")){statements.add(sb.toString());sb.setLength(0);
if(configurationModel.getObject().getId()!=null&&!TaskManagerBeans.get().getSecUtil().isReadable(getSession().getAuthentication(),configurationModel.getObject())){thrownewRestartResponseException(UnauthorizedPage.class);
if(configurationModel.getObject().isTemplate()){setReturnPage(TemplatesPage.class);
else{setReturnPage(ConfigurationsPage.class);
if(wi.getName().equals(configurationModel.getObject().getWorkspace())||TaskManagerBeans.get().getSecUtil().isAdminable(getSession().getAuthentication(),wi)){workspaces.add(wi.getName());
if(!initMode){//restoretasksconfigurationModel.getObject().getTasks().clear();configurationModel.getObject().getTasks().putAll(oldTasks);//restorebatchesconfigurationModel.getObject().getBatches().clear();configurationModel.getObject().getBatches().putAll(oldBatches);
if(initMode){form.get("addNew").setEnabled(false);form.get("removeSelected").setEnabled(false);batchesPanel.get("addNew").setEnabled(false);batchesPanel.get("removeSelected").setEnabled(false);saveButton.setVisible(false);
if(configurationModel.getObject().getId()!=null&&!TaskManagerBeans.get().getSecUtil().isAdminable(getSession().getAuthentication(),configurationModel.getObject())){form.get("name").setEnabled(false);form.get("workspace").setEnabled(false);form.get("description").setEnabled(false);attributesPanel.setEnabled(false);form.get("addNew").setEnabled(false);form.get("removeSelected").setEnabled(false);tasksPanel.setEnabled(false);batchesPanel.get("addNew").setEnabled(false);batchesPanel.get("removeSelected").setEnabled(false);saveButton.setEnabled(false);applyButton.setEnabled(false);
if(getExistingTask(panel.getNameField().getModelObject())!=null){error(newParamResourceModel("duplicateTaskName",getPage()).getString());target.add(panel.getFeedbackPanel());returnfalse;
else{Tasktask;StringcopyTask=panel.getCopyField().getModel().getObject();
if(copyTask!=null){task=TaskManagerBeans.get().getTaskUtil().copyTask(configurationModel.getObject().getTasks().get(copyTask),panel.getNameField().getModelObject());
else{task=TaskManagerBeans.get().getTaskUtil().initTask(panel.getTypeField().getModelObject(),panel.getNameField().getModelObject());
if(element==null){
if(shouldCleanupModel.getObject()){//clean-up
if(TaskManagerBeans.get().getTaskUtil().canCleanup(task)){
if(TaskManagerBeans.get().getTaskUtil().cleanup(task)){info(newParamResourceModel("cleanUp.success",getPage(),task.getName()).getString());
else{error(newParamResourceModel("cleanUp.failed",getPage(),task.getName()).getString());
else{info(newParamResourceModel("cleanUp.ignore",getPage(),task.getName()).getString());
if(task.getId()!=null){removedTasks.add(task);
else{error(newParamResourceModel("taskInUse",getPage(),task.getName(),element.getBatch().getFullName()).getString());
if(task.getId()!=null){task=TaskManagerBeans.get().getDataUtil().init(task);for(BatchElementelement:task.getBatchElements()){
if(element.getBatch().isActive()){returnelement;
else{for(Batchbatch:configurationModel.getObject().getBatches().values()){for(BatchElementelement:batch.getElements()){
if(element.getTask().equals(task)){returnelement;
if(property.equals(TasksModel.NAME)){IModel<String>nameModel=(IModel<String>)property.getModel(itemModel);StringoldName=nameModel.getObject();returnnewSimpleAjaxSubmitLink(id,nameModel){privatestaticfinallongserialVersionUID=2023797271780630795L;@OverrideprotectedvoidonSubmit(AjaxRequestTargettarget,Form<?>form){dialog.setInitialWidth(400);dialog.setInitialHeight(100);dialog.setTitle(newParamResourceModel("changeTaskName",getPage()));dialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){privatestaticfinallongserialVersionUID=7410393012930249966L;privateNamePanelpanel;@OverrideprotectedComponentgetContents(Stringid){panel=newNamePanel(id,nameModel);panel.getTextField().add(newIValidator<String>(){privatestaticfinallongserialVersionUID=1L;@Overridepublicvoidvalidate(IValidatable<String>validatable){Taskexisting=getExistingTask(validatable.getValue());
if(existing!=null&&!existing.equals(itemModel.getObject())){validatable.error(neworg.apache.wicket.validation.ValidationError(newParamResourceModel("duplicateTaskName",getPage()).getString()));
else
if(property.equals(TasksModel.PARAMETERS)){returnnewSimpleAjaxSubmitLink(id,newIModel<String>(){privatestaticfinallongserialVersionUID=519359570729184717L;@Overridepublicvoiddetach(){}@OverridepublicvoidsetObject(Stringobject){}@OverridepublicStringgetObject(){StringBuildersb=newStringBuilder();for(Parameterpam:itemModel.getObject().getParameters().values()){
if(pam.getValue()!=null){sb.append(pam.getName()).append("=").append(pam.getValue()).append(",");
if(sb.length()>2){sb.setLength(sb.length()-2);returnsb.toString();
else{returnnewParamResourceModel("specifyParameters",getPage()).getString();
if(property.equals(AttributesModel.VALUE)){List<String>domain=domains.get(itemModel.getObject().getName());
if(domain==null){Set<ParameterType>typesForAttribute=TaskManagerBeans.get().getTaskUtil().getTypesForAttribute(itemModel.getObject(),configurationModel.getObject());
if(typesForAttribute.contains(ParameterType.SQL)){returnnewTextAreaPanel(id,(IModel<String>)property.getModel(itemModel));
else{returnnewTextFieldPanel(id,(IModel<String>)property.getModel(itemModel));
else{finalDropDownPanelddp=newDropDownPanel(id,(IModel<String>)property.getModel(itemModel),newPropertyModel<List<String>>(domains,itemModel.getObject().getName()),configurationModel.getObject().isTemplate());ddp.getDropDownChoice().add(newAjaxFormSubmitBehavior("change"){privatestaticfinallongserialVersionUID=-7698014209707408962L;@OverrideprotectedvoidonSubmit(AjaxRequestTargettarget){attributesModel.save(false);TaskManagerBeans.get().getTaskUtil().updateDependentDomains(itemModel.getObject(),configurationModel.getObject(),domains);target.add(tablePanel);
else
if(property.equals(AttributesModel.ACTIONS)){List<String>actions=TaskManagerBeans.get().getTaskUtil().getActionsForAttribute(itemModel.getObject(),configurationModel.getObject());
if(!actions.isEmpty()){returnnewPanelListPanel<String>(id,actions){privatestaticfinallongserialVersionUID=-4770841274788269473L;@OverrideprotectedPanelpopulateItem(Stringid,IModel<String>actionModel){returnnewButtonPanel(id,newStringResourceModel("Actions."+actionModel.getObject())){privatestaticfinallongserialVersionUID=-2791644626218648013L;@OverridepublicvoidonSubmit(AjaxRequestTargettarget,Form<?>form){Actionaction=TaskManagerBeans.get().getActions().get(actionModel.getObject());IModel<String>valueModel=newPropertyModel<>(itemModel,AttributesModel.VALUE.getName());List<String>dependentValues=TaskManagerBeans.get().getTaskUtil().getDependentRawValues(action.getName(),itemModel.getObject(),configurationModel.getObject());
if(action.accept(valueModel.getObject(),dependentValues)){action.execute(ConfigurationPage.this,target,valueModel,dependentValues);target.add(tablePanel);
else{error(newParamResourceModel("invalidValue",getPage()).getString());ConfigurationPage.this.addFeedbackPanels(target);
if(!errors.isEmpty()){for(ValidationErrorerror:errors){//TODO:uselocalizedresourcebasedonerrortypeinsteadoftoStringform.error(error.toString());
else
if(!configurationModel.getObject().isTemplate()&&!initMode){configurationModel.getObject().setValidated(true);
if(doReturn){doReturn();
else{oldTasks=newHashMap<>(configurationModel.getObject().getTasks());oldBatches=newHashMap<>(configurationModel.getObject().getBatches());form.success(newParamResourceModel("success",getPage()).getString());target.add(batchesPanel);((MarkupContainer)batchesPanel.get("form:batchesPanel:listContainer:items")).removeAll();addFeedbackPanels(target);
if(initMode){setResponsePage(newInitConfigurationPage(configurationModel));
if(existing==null){//
ifwehavedeletedanoldtaskwiththatname,//butnotyetclickedapplywecannotusenameeither.existing=oldTasks.get(name);
if(eventinstanceofDocumentFile)returntrue;
elsereturnfalse;
if(inProgress!=null){progress.put("progress",inProgress.getNumberProcessed());progress.put("total",inProgress.getTotalToProcess());progress.put("state",inProgress.getState().toString());
else{ImportTasktask=task(id,taskId);progress.put("state",task.getState().toString());
if(task.getState()==ImportTask.State.ERROR){
if(task.getError()!=null){progress.put("message",task.getError().getMessage());
if(task.getStore()==null){thrownewRestException("Taskhasnotargetstore",HttpStatus.NOT_FOUND);
if(request.getContentType().startsWith(MediaType.MULTIPART_FORM_DATA_VALUE)){data=handleMultiPartFormUpload(request,context(id));
else
if(request.getContentType().startsWith(MediaType.APPLICATION_FORM_URLENCODED_VALUE)){try{data=handleFormPost(request);
if(data==null){thrownewRestException("UnsupportedPOST",HttpStatus.FORBIDDEN);
if(store==null){thrownewRestException("Taskhasnotargetstore",HttpStatus.NOT_FOUND);
else{updateStoreInfo(task(id,taskId),store,importer);try{importer.changed(task(id,taskId));
if(!newTasks.isEmpty()){finalList<ImportTask>result=newTasks;
if(newTasks.size()==1){longtaskId=newTasks.get(0).getId();response.setHeader("Location",RequestInfo.get().servletURI(String.format("/imports/%d/tasks/%d",context.getId(),taskId)));
if(result.size()==1){converter.task(builder,result.get(0),true,converter.expand(expand,1));
else{converter.tasks(builder,result,true,converter.expand(expand,0));
if(url==null){thrownewRestException("Invalidrequest",HttpStatus.BAD_REQUEST);
if(location==null||!location.getProtocol().equalsIgnoreCase("file")){thrownewRestException("Invalidurlinrequest",HttpStatus.BAD_REQUEST);
if(fileinstanceofDirectory){try{file.prepare();
if(item.getName()==null){continue;
if(task.getStore()!=null){//JD:movedtoTaskTargetResource,buthandlehereforbackwardcompatabilityupdateStoreInfo(orig,task.getStore(),importer);change=true;
if(task.getData()!=null){//TODO:movethistodataendpointorig.getData().setCharsetEncoding(task.getData().getCharsetEncoding());change=true;
if(task.getUpdateMode()!=null){orig.setUpdateMode(task.getUpdateMode());change=orig.getUpdateMode()!=task.getUpdateMode();
if(task.getLayer()!=null){change=true;//nowhandledbyLayerResource,buthandlehereforbackwardscompatabilityupdateLayer(orig,task.getLayer(),importer,converter);
if(chain!=null){orig.setTransform(chain);change=true;
if(!change){thrownewRestException("Unknownrepresentation",HttpStatus.BAD_REQUEST);
else{try{importer.changed(orig);
if(context.getData()instanceofDirectory){return(Directory)context.getData();
if(r!=null){//wesupportthefollowingresourceinfoproperties://(don'tjustuseblindlycopyeverything)
if(r.getTitle()!=null){resource.setTitle(r.getTitle());
if(r.getAbstract()!=null){resource.setAbstract(r.getAbstract());
if(r.getDescription()!=null){resource.setDescription(r.getDescription());
if(r.getName()!=null){resource.setName(r.getName());
if(r.getNativeName()!=null){//seemsweirdIknow,butcheckthecodeofgetOriginalLayerName...
if(!r.getNativeName().equalsIgnoreCase(orig.getOriginalLayerName())){orig.setOriginalLayerName(orig.getOriginalLayerName());
if(impl.getAuthorityURLs()==null){impl.setAuthorityURLs(newArrayList(1));
if(impl.getIdentifiers()==null){impl.setIdentifiers(newArrayList(1));
if(srs!=null){try{newRefSystem=CRS.decode(srs);
ifnoneexists//usefulforcsvorotherfiles
if(resource.getNativeCRS()==null){resource.setNativeCRS(newRefSystem);
iftheupdateisreferencinganexistingstoreStoreInfoexisting=null;
if(update.getName()!=null){Catalogcat=importer.getCatalog();
if(update.getWorkspace()!=null){existing=cat.getStoreByName(update.getWorkspace(),update.getName(),StoreInfo.class);
else{existing=importer.getCatalog().getStoreByName(update.getName(),StoreInfo.class);
if(existing==null){thrownewRestException("Unabletofindreferencedstore",HttpStatus.BAD_REQUEST);
if(!existing.isEnabled()){thrownewRestException("Proposedtargetstoreisnotenabled",HttpStatus.BAD_REQUEST);
if(existing!=null){//JD:notsurewhywedothis,ratherthanjusttask.setStore(existing);CatalogBuildercb=newCatalogBuilder(importer.getCatalog());StoreInfoclone;
if(existinginstanceofDataStoreInfo){clone=cb.buildDataStore(existing.getName());cb.updateDataStore((DataStoreInfo)clone,(DataStoreInfo)existing);
else
if(existinginstanceofCoverageStoreInfo){clone=cb.buildCoverageStore(existing.getName());cb.updateCoverageStore((CoverageStoreInfo)clone,(CoverageStoreInfo)existing);
else{thrownewRestException("Unabletohandleexistingstore:"+update,HttpStatus.INTERNAL_SERVER_ERROR);
else
if(orig==null){task.setStore(update);
else{//updatetheoriginalCatalogBuildercb=newCatalogBuilder(importer.getCatalog());
if(originstanceofDataStoreInfo){cb.updateDataStore((DataStoreInfo)orig,(DataStoreInfo)update);
else
if(originstanceofCoverageStoreInfo){cb.updateCoverageStore((CoverageStoreInfo)orig,(CoverageStoreInfo)update);
else{thrownewRestException("Unabletoupdatestorewith"+update,HttpStatus.INTERNAL_SERVER_ERROR);
if(requestinstanceofGetExecutionStatusType){return"text/xml";
else
if(requestinstanceofGetExecutionResultType){GetExecutionResultTypeger=(GetExecutionResultType)request;
if(ger.getMimeType()!=null){returnger.getMimeType();
else{//genericbinaryoutput...return"application/octet-stream";
else{thrownewWPSException("Tryingtogetamimetypeforaunknownoperation,"+"weshouldnothavegothereinthefirstplace");
if(requestinstanceofGetExecutionStatusType){return"text/xml";
else
if(requestinstanceofGetExecutionResultType){GetExecutionResultTypeger=(GetExecutionResultType)request;
if(ger.getOutputId()!=null){returnger.getOutputId();
else{//weshouldreallynevergethere,therequestshouldfailbeforereturn"result.dat";
else{thrownewWPSException("Tryingtogetafilenameforaunknownoperation,"+"weshouldnothavegothereinthefirstplace");
if(shouldApplyFilter()){
if(LayerInfo.class.isAssignableFrom(clazz)){returnPredicates.and(Predicates.equal("enabled",true),Predicates.equal("resource.enabled",true),Predicates.equal("resource.store.enabled",true));
else
if(ResourceInfo.class.isAssignableFrom(clazz)){returnPredicates.and(Predicates.equal("enabled",true),Predicates.equal("store.enabled",true));
if(shouldApplyFilter()){return!layer.enabled();
if(shouldApplyFilter()){return!resource.enabled();
if(config.isTemplate()){returnfalse;
if(batch!=null){
if(batch.getId()!=null){batch=dataUtil.init(batch);for(BatchRunbatchRun:batch.getBatchRuns()){
if(batchRun.getStatus()==Status.COMMITTED){returnfalse;
else{returnfalse;
if(!(configinstanceofConfigurationWrapper)){returnnewConfigurationWrapper(config);
else{returnconfig;
if(configinstanceofConfigurationWrapper){return((ConfigurationWrapper)config).getDelegate();
else{returnconfig;
if(batch!=null){for(BatchElementelement:batch.getElements()){tasks.put(element.getTask().getName(),element.getTask());
if(batch!=null){returnCollections.singletonMap(batch.getName(),batch);
ifthenumberofnodesfoundcorrespondto*theexpectednumber,*/privatevoidcheckCount(XpathEnginexpathEngine,Documentdocument,intexpectedCount,Stringxpath){try{//evaluatethexpathandcomparethenumberofnodesfoundassertThat(xpathEngine.getMatchingNodes(xpath,document).getLength(),is(expectedCount));
ifthisiscorrect,
ifitis,youcanaddtheconstantchain//fortherootuserloginfor(GeoServerSecurityProviderp:secMgr.lookupSecurityProviders()){p.configureFilterChain(this);
if(requestChain.getName().equals(name)){returnrequestChain;
if(requestChain.getPatterns().contains(pattern)){returnrequestChain;
if(chain.isConstant()==false)result.add(chain);returnresult;
if(requestChain.getName().equals(name)){returnrequestChain;
ifthefilterwasinserted.*/publicbooleaninsertFirst(Stringpattern,StringfilterName){RequestFilterChainrequestChain=findAndCheck(pattern,filterName);
if(requestChain==null){returnfalse;
ifthefilterwasinserted.*/publicbooleaninsertLast(Stringpattern,StringfilterName){RequestFilterChainrequestChain=findAndCheck(pattern,filterName);
if(requestChain==null){returnfalse;
ifthefilterwasinserted.*/publicbooleaninsertBefore(Stringpattern,StringfilterName,StringpositionName){RequestFilterChainrequestChain=findAndCheck(pattern,filterName);
if(requestChain==null){returnfalse;
if(index==-1){returnfalse;
ifthefilterwasinserted.*/publicbooleaninsertAfter(Stringpattern,StringfilterName,StringpositionName){RequestFilterChainrequestChain=findAndCheck(pattern,filterName);
if(requestChain==null){returnfalse;
if(index==-1){returnfalse;
if(filterNames.contains(filterName)){result.addAll(requestChain.getPatterns());
if(requestChain==null){returnCollections.EMPTY_LIST;
if(requestChain!=null){returnrequestChains.remove(requestChain);
if(requestChain==null){returnnull;
if(requestChain.getFilterNames().contains(filterName)){//JD:perhapsweshouldmoveitreturnnull;
if(requestChain.getPatterns().contains(pattern)){returnrequestChain;
if(regex!=null){model=buildAboutModel(type).filterNameByRegex(regex);
if(from!=null&&to!=null){
if(model!=null){model=model.filterNameByRange(from,to);
else{model=buildAboutModel(type).filterNameByRange(from,to);
if(model==null){model=buildAboutModel(type);
if(key!=null&&value!=null){model=model.filterPropertyByKeyValue(value,key);
else
if(key!=null){model=model.filterPropertyByKey(key);
else
if(value!=null){model=model.filterPropertyByValue(value);
if(model!=null){returnmodel;
else{returnbuildAboutModel(type);
if(type.equals(AboutModelType.RESOURCES)){//
ifrequestisforresourcereturntheresourcesreturnManifestLoader.getResources();
else{//gettheversionreturnManifestLoader.getVersions();
if(objectinstanceofAboutModel){return"AboutModel.ftl";
else{returnnull;
if(AboutModel.class.isAssignableFrom(clazz)){returnnewObjectToMapWrapper<AboutModel>(AboutModel.class){@OverrideprotectedvoidwrapInternal(Mapproperties,SimpleHashmodel,AboutModelobject){finalList<Map<String,Object>>manifests=newArrayList<>();for(ManifestModelmanifest:object.getManifests()){finalMap<String,Object>map=newHashMap<>();map.put("name",manifest.getName());finalList<String>props=newArrayList<>();map.put("properties",props);finalList<String>values=newArrayList<>();map.put("valuez",values);for(Stringkey:manifest.getEntries().keySet()){props.add(key);values.add(manifest.getEntries().get(key));
else{returnnull;
ifafunctionisused,caremustbetaken*toensurethattheresulttypematchesthetypeinthe**&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:element&gt;*&lt;/xsd:choice&gt;*&lt;xsd:elementmaxOccurs="1"minOccurs="0"ref="ogc:Filter"&gt;*&lt;xsd:annotation&gt;*&lt;xsd:documentation&gt;*TheFilterelementisusedtodefinespatialand/ornon-spatial*constraintsonquery.SpatialconstrainsuseGML3tospecify*theconstraininggeometry.AfulldescriptionoftheFilter*elementcanbefoundintheFilterEncodingImplementation*Specification.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:element&gt;*&lt;xsd:elementmaxOccurs="1"minOccurs="0"ref="ogc:SortBy"&gt;*&lt;xsd:annotation&gt;*&lt;xsd:documentation&gt;*TheSortByelementisusedspecifypropertynameswhose*valuesshouldbeusedtoorder(uponpresentation)the*setoffeatureinstancesthatsatisfythequery.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:element&gt;*&lt;/xsd:sequence&gt;*&lt;xsd:attributename="handle"type="xsd:string"use="optional"&gt;*&lt;xsd:annotation&gt;*&lt;xsd:documentation&gt;*Thehandleattributeallowsaclientapplication*toassignaclient-generatedidentifierforthe*Query.Thehandleisincludedtofacilitateerror*reporting.IfoneQueryinaGetFeaturerequest*causesanexception,aWFSmayreportthehandle*toindicatewhichqueryelementfailed.Ifthea*handleisnotpresent,theWFSmayuseothermeans*tolocalizetheerror(e.g.linenumbers).*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:attribute&gt;*&lt;xsd:attributename="typeName"type="wfs:TypeNameListType"use="required"&gt;*&lt;xsd:annotation&gt;*&lt;xsd:documentation&gt;*ThetypeNameattributeisalistofoneormore*featuretypenamesthatindicatewhichtypes*offeatureinstancesshouldbeincludedinthe*reponseset.Specifyingmorethanonetypename*indicatesthatajoinoperationisbeingperformed.*AllthenamesinthetypeNamelistmustbevalid*typesthatbelongtothisquery'sfeaturecontent*asdefinedbytheGMLApplicationSchema.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:attribute&gt;*&lt;xsd:attributename="featureVersion"type="xsd:string"use="optional"&gt;*&lt;xsd:annotation&gt;*&lt;xsd:documentation&gt;*Forsystemsthatimplementversioning,thefeatureVersion*attributeisusedtospecifywhichversionofaparticular*featureinstanceistoberetrieved.AvalueofALLmeans*thatallversionsshouldberetrieved.Anintegervalue*'i',meansthattheithversionshouldberetrieve
ifit*existsorthemostrecentversionotherwise.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:attribute&gt;*&lt;xsd:attributename="srsName"type="xsd:anyURI"use="optional"&gt;*&lt;xsd:annotation&gt;*&lt;xsd:documentation&gt;*ThisattributeisusedtospecifyaspecificWFS-supportedSRS*thatshouldbeusedforreturnedfeaturegeometries.Thevalue*maybetheWFSStorageSRSvalue,DefaultRetrievalSRSvalue,or*oneofAdditionalSRSvalues.IfnosrsNamevalueissupplied,*thenthefeatureswillbereturnedusingeitherthe*DefaultRetrievalSRS,
ifspecified,andStorageSRSotherwise.*Forfeaturetypeswithnospatialproperties,thisattribute*mustnotbespecifiedorignored
ifitisspecified.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:attribute&gt;*&lt;/xsd:complexType&gt;**</code>*</pre>**@generated*/publicclassQueryTypeBindingextendsAbstractComplexBinding{WfsFactorywfsfactory;publicQueryTypeBinding(WfsFactorywfsfactory){this.wfsfactory=wfsfactory;
ifansrsNameissetforthisgeometry,putitinthecontextfor//children,sotheycanuseitaswell
if(node.hasAttribute("srsName")){try{CoordinateReferenceSystemcrs=GML2ParsingUtils.crs(node);
if(crs!=null){context.registerComponentInstance(CoordinateReferenceSystem.class,crs);
if(node.hasChild("PropertyName")){//HACK,strippingofnamespaceprefixfor(Iteratorp=node.getChildValues("PropertyName").iterator();p.hasNext();){Objectproperty=p.next();StringpropertyName;
if(propertyinstanceofString)propertyName=(String)property;
elsepropertyName=(String)((PropertyName)property).getPropertyName();query.getPropertyName().add(propertyName);
if(node.hasChild("Function")){query.getFunction().add(node.getChildValues("Function"));
if(node.hasChild(Filter.class)){query.setFilter((Filter)node.getChildValue(Filter.class));
if(node.hasChild(SortBy[].class)){SortBy[]sortBy=(SortBy[])node.getChildValue(SortBy[].class);for(inti=0;i<sortBy.length;i++)query.getSortBy().add(sortBy[i]);
if(node.hasAttribute("handle")){query.setHandle((String)node.getAttributeValue("handle"));
if(node.hasAttribute("featureVersion")){query.setFeatureVersion((String)node.getAttributeValue("featureVersion"));
if(node.hasAttribute("srsName")){query.setSrsName((URI)node.getAttributeValue("srsName"));
if(node.hasChild("XlinkPropertyName")){query.getXlinkPropertyName().addAll(node.getChildValues("XlinkPropertyName"));
if(s!=null)s.close();
if(dd==null){dd=lookupEnvironmentVariable();
if(dd==null){dd=lookupSystemProperty();
if(dd==null){dd=lookupWebapps();
if(dd!=null){returndd;
if(web.exists()){//org.w3c.dom.Documentdom=DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(web);//NodeListcontextParamElements=dom.getElementsByTagName("context-param");//for(inti=0;i<contextParamElements.getLength();i++){//ElementcontextParamElement=(Element)contextParamElements.item(i);////ElementparamNameElement=null;//ElementparamValueElement=null;////for(intj=0;j<contextParamElement.getChildNodes().getLength();j++){//Noden=contextParamElement.getChildNodes().item(j);//
if(ninstanceofElement&&n.getNodeName().equals("param-name")){//Elemente=(Element)n;//
if(e.getFirstChild()!=null&&e.getFirstChild().getTextContent()!=null&&//e.getFirstChild().getTextContent().equals("GEOSERVER_DATA_DIR")){////paramNameElement=e;//break;//}//}//
if(ninstanceofElement&&n.getNodeName().equals("param-value")){//Elemente=(Element)n;//
if(e.getFirstChild()!=null){//paramNameElement=e;//break;//}//}//}////
if(paramNameElement!=null){//for(intj=0;j<contextParamElement.getChildNodes().getLength();j++){//Noden=contextParamElement.getChildNodes().item(j);//
if(ninstanceofElement&&n.getNodeName().equals("param-value")){//Elemente=(Element)n;//
if(e.getFirstChild()!=null&&e.getFirstChild().getTextContent()!=null&&//e.getFirstChild().getTextContent().equals("GEOSERVER_DATA_DIR")){////paramNameElement=e;//break;//}//}//}//}//}//
if(dd!=null){returnmakeAbsolute(dd);
if(dd!=null){returnmakeAbsolute(dd);
if(newFile(dd).exists()){returnmakeAbsolute(dd);
if(f.isAbsolute()){returnf;
if(started){Stringmsg="WouldyouliketoshutdownGeoServerbeforeexiting?";switch(JOptionPane.showConfirmDialog(Frame.this,msg)){caseJOptionPane.CANCEL_OPTION://canceltheoperationsetDefaultCloseOperation(DO_NOTHING_ON_CLOSE);return;caseJOptionPane.OK_OPTION:setDefaultCloseOperation(DO_NOTHING_ON_CLOSE);//waituntilservershutdowntoclosethewindowThreadt=newThread(newRunnable(){publicvoidrun(){try{while(handler.isStarted()){Thread.sleep(500);
else{setDefaultCloseOperation(EXIT_ON_CLOSE);
if(textArea.getLineCount()>1000){intd=textArea.getLineCount()-1000;for(inti=0;i<d;i++){try{textArea.replaceRange(null,textArea.getLineStartOffset(0),textArea.getLineEndOffset(0));
if(getEnableRedirectAuthenticationEntryPoint()||request.getRequestURI().endsWith(getLoginEndpoint())){response.sendRedirect(loginUri.toString());
ifvalidationofuser*namesandgroupnamesisrequired**@paramservice*@paramcheckAgainstRules*@paramservices*/publicRoleServiceValidationWrapper(GeoServerRoleServiceservice,booleancheckAgainstRules,GeoServerUserGroupService...services){super(service.getSecurityManager());this.service=service;this.services=services;this.checkAgainstRules=checkAgainstRules;
ifausernameisvalid
ifthisvalidatorwasconstructedwith{@link*GeoServerUserGroupService}objects,acrosscheckisdone**@paramuserName*@throwsRoleServiceException*/protectedvoidcheckValidUserName(StringuserName)throwsIOException{
if(isNotEmpty(userName)==false)throwcreateSecurityException(USERNAME_REQUIRED);
if(services.length==0)return;for(GeoServerUserGroupServiceservice:services){
if(service.getUserByUsername(userName)!=null)return;
if{@link#checkAgainstRules}is*<code>true</code>**@paramrole*@throwsIOException*/publicvoidcheckRoleIsUsed(GeoServerRolerole)throwsIOException{
if(checkAgainstRules==false)return;GeoServerSecurityManagersecMgr=getSecurityManager();List<String>keys=newArrayList<String>();for(ServiceAccessRulerule:secMgr.getServiceAccessRuleDAO().getRulesAssociatedWithRole(role.getAuthority()))keys.add(rule.getKey());for(DataAccessRulerule:secMgr.getDataAccessRuleDAO().getRulesAssociatedWithRole(role.getAuthority()))keys.add(rule.getKey());
if(keys.size()>0){StringruleString=StringUtils.collectionToCommaDelimitedString(keys);throwcreateSecurityException(ROLE_IN_USE_$2,role.getAuthority(),ruleString);
iftherolesismappedtoasystemrole,see**<p>{@linkSecurityRoleServiceConfig#getAdminRoleName()}{@link*SecurityRoleServiceConfig#getGroupAdminRoleName()}**@paramrole*@throwsIOException*/publicvoidcheckRoleIsMapped(GeoServerRolerole)throwsIOException{GeoServerRolemappedRole=service.getAdminRole();
if(mappedRole!=null&&mappedRole.equals(role))throwcreateSecurityException(ADMIN_ROLE_NOT_REMOVABLE_$1,role.getAuthority());mappedRole=service.getGroupAdminRole();
if(mappedRole!=null&&mappedRole.equals(role))throwcreateSecurityException(GROUP_ADMIN_ROLE_NOT_REMOVABLE_$1,role.getAuthority());
ifagroupnameisvalid
ifthisvalidatorwasconstructedwith{@link*GeoServerUserGroupService}objects,acrosscheckisdone**@paramgroupName*@throwsRoleServiceException*/protectedvoidcheckValidGroupName(StringgroupName)throwsIOException{
if(isNotEmpty(groupName)==false)throwcreateSecurityException(GROUPNAME_REQUIRED);
if(services.length==0)return;for(GeoServerUserGroupServiceservice:services){
if(service.getGroupByGroupname(groupName)!=null)return;
if(isNotEmpty(roleName)==false)throwcreateSecurityException(NAME_REQUIRED);
if(service.getRoleByName(roleName)==null)throwcreateSecurityException(NOT_FOUND,roleName);
if(systemRole.getAuthority().equals(roleName))throwcreateSecurityException(RESERVED_NAME,roleName);
if(service.getName().equals(serviceName))continue;GeoServerRolerole=null;try{role=service.getSecurityManager().loadRoleService(serviceName).getRoleByName(roleName);
if(role!=null){throwcreateSecurityException(ALREADY_EXISTS_IN,roleName,serviceName);
if(service.getRoleByName(roleName)!=null)throwcreateSecurityException(ALREADY_EXISTS,roleName);
if(pointCollection!=null){List<Rule>rules=builder.quantileClassification(pointCollection,"foo",Integer.class,4,false,false);assertEquals(4,rules.size());
if(pointCollection!=null){List<Rule>rules=builder.equalIntervalClassification(pointCollection,"foo",Integer.class,4,false,false);assertEquals(4,rules.size());
if(pointCollection!=null){List<Rule>rules=builder.uniqueIntervalClassification(pointCollection,"group",Integer.class,-1,false);assertEquals(4,rules.size());rules=builder.uniqueIntervalClassification(pointCollection,"id",Integer.class,-1,false);assertEquals(8,rules.size());
if(pointCollection!=null){List<Rule>rules=builder.jenksClassification(lineCollection,"jenks71",Integer.class,10,false,false);assertEquals(10,rules.size());
if(pointCollection!=null){intnumClasses=10;List<Rule>rules=builder.equalIntervalClassification(pointCollection,"foo",Integer.class,numClasses,false,false);builder.polygonStyle(rules,newBlueColorRamp(),false);RuleruleOne=rules.get(0);assertTrue(ruleOne.getSymbolizers()[0]instanceofPolygonSymbolizer);PolygonSymbolizersymbolizer=(PolygonSymbolizer)ruleOne.getSymbolizers()[0];assertEquals(newColor(0,0,49),symbolizer.getFill().getColor().evaluate(null,Color.class));assertNotNull(ruleOne.getFilter());assertEquals(numClasses,rules.size());
if(pointCollection!=null){intnumClasses=10;List<Rule>rules=builder.equalIntervalClassification(pointCollection,"foo",Integer.class,numClasses,false,false);builder.polygonStyle(rules,newBlueColorRamp(),true);PolygonSymbolizersymbolizer=(PolygonSymbolizer)rules.get(0).getSymbolizers()[0];assertEquals(newColor(0,0,224),symbolizer.getFill().getColor().evaluate(null,Color.class));assertEquals(numClasses,rules.size());
if(lineCollection!=null){intnumClasses=10;List<Rule>rules=builder.jenksClassification(lineCollection,"jenks71",Integer.class,numClasses,false,false);builder.lineStyle(rules,newBlueColorRamp(),false);RuleruleOne=rules.get(0);assertTrue(ruleOne.getSymbolizers()[0]instanceofLineSymbolizer);LineSymbolizersymbolizer=(LineSymbolizer)ruleOne.getSymbolizers()[0];assertEquals(newColor(0,0,49),symbolizer.getStroke().getColor().evaluate(null,Color.class));assertNotNull(ruleOne.getFilter());assertEquals(10,rules.size());
if(lineCollection!=null){intnumClasses=10;List<Rule>rules=builder.jenksClassification(lineCollection,"jenks71",Integer.class,numClasses,false,false);builder.lineStyle(rules,newBlueColorRamp(),true);LineSymbolizersymbolizer=(LineSymbolizer)rules.get(0).getSymbolizers()[0];assertEquals(newColor(0,0,224),symbolizer.getStroke().getColor().evaluate(null,Color.class));
if(temp!=null){temp.delete();temp=null;
if(service.getExceptionFormats()==null){((WCSInfoImpl)service).setExceptionFormats(newArrayList<String>());
if(service.getVersions().isEmpty()){service.getVersions().add(newVersion("1.0.0"));service.getVersions().add(newVersion("1.1.1"));
if(!service.getVersions().contains(v201)){service.getVersions().add(v201);
if(service.getSRS()==null){((WCSInfoImpl)service).setSRS(newArrayList<String>());
iftheuserismovingaroundtherepo//choices
if(Objects.equal(originalRepo,repositoryUriModel.getObject())){branchName=originalBranch;
if(Strings.isNullOrEmpty(dataStoreName)){ComponentnamePanel=form.get("dataStoreNamePanel");
if(namePanel!=null&&namePanelinstanceofTextParamPanel){TextParamPanelparamPanel=(TextParamPanel)namePanel;paramPanel.getFormComponent().setModelObject(info.getRepoName());target.add(form);
if(sourceinstanceofFeatureLocking){((FeatureLocking<SimpleFeatureType,SimpleFeature>)source).setFeatureLock(lock);
else{thrownewUnsupportedOperationException("FeatureTypeConfigdoesnotsupportslocking");
if(sourceinstanceofFeatureLocking){return((FeatureLocking<SimpleFeatureType,SimpleFeature>)source).lockFeatures(query);
else{thrownewDataSourceException("FeatureTypeConfigdoesnotsupportslocking");
if(sourceinstanceofPostgisFeatureLocking){//return((PostgisFeatureLocking)source).lockFeature(feature);//
if(dir.exists()){thrownewIOException(dir+"alreadyexists");
if(file!=null){file.delete();
if*requiredonreload/reset.**@authorJustinDeoliveira,OpenGeo*/publicclassWPSLifecycleHandlerimplementsGeoServerLifecycleHandler{GeoServergeoServer;publicWPSLifecycleHandler(GeoServergeoServer){this.geoServer=geoServer;
if(backupExecution.getStatus()==BatchStatus.ABANDONED||backupExecution.getStatus()==BatchStatus.FAILED||backupExecution.getStatus()==BatchStatus.UNKNOWN){for(Throwableexception:backupExecution.getAllFailureExceptions()){LOGGER.log(Level.INFO,"ERROR:"+exception.getLocalizedMessage(),exception);exception.printStackTrace();
if(GenericTaskletUtils.isBackup(context)){//wearedoingabackupinputDirectory=dataDirectory.root();outputDirectory=GenericTaskletUtils.getOutputDirectory(jobExecution);
else{//wearedoingarestoreinputDirectory=GenericTaskletUtils.getInputDirectory(jobExecution);outputDirectory=dataDirectory.root();
if(!inputFile.exists()){//nothingtocopyreturn;
if(outputDirectory.exists()&&outputDirectory.isDirectory()){FileoutputFile=newFile(outputDirectory,outputFileName);try(InputStreaminput=newFileInputStream(inputFile);//copythefiletoisdestinationOutputStreamoutput=newFileOutputStream(outputFile)){IOUtils.copy(input,output);
if(fileService!=null){fileServiceChoice.setDefaultModelObject(fileService).setEnabled(false);updateFolders();
if(service!=null){List<String>paths=service.listSubfolders();for(Stringpath:paths){availableFolders.add(path);
if(uploads!=null){for(FileUploadupload:uploads){FileServicefileService=TaskManagerBeans.get().getFileServices().get(fileServiceChoice.getModel().getObject());try{StringfilePath=folderChoice.getModelObject()+"/"+upload.getClientFileName();
if(fileService.checkFileExists(filePath)){fileService.delete(filePath);
if(list!=null){list.close();
if(!metadata.containsKey(NetCDFSettingsContainer.NETCDFOUT_KEY)){metadata.put(NetCDFSettingsContainer.NETCDFOUT_KEY,newNetCDFSettingsContainer());geoServer.save(global);
if(inputMessageinstanceofRestHttpInputWrapper){((RestHttpInputWrapper)inputMessage).configurePersister(p,this);
if(oinstanceofRestWrapper){RestWrapper<?>wrapper=(RestWrapper<?>)o;wrapper.configurePersister(xmlPersister,this);o=wrapper.getObject();
if(!(nodeinstanceofElement)){continue;
ifnobranchorheadisconfigured(andhencethedatastoreoperateson*whateverthecurrentHEADis)*</ul>**<p>Handlesthefollowingevents:**<ul>*<li>{@linkWorkspaceInfo}renamed:allgeogiglayersofstoresinthatworkspacegettheir*authorityURLidentifiersupdated*<li>{@linkDataStoreInfo}renamed:allgeogiglayersofstoresinthatworkspacegettheir*authorityURLidentifiersupdated*<li>{@linkDataStoreInfo}workspacechanged:allgeogiglayersofstoresinthatworkspaceget*theirauthorityURLidentifiersupdated*<li>{@linkLayerInfo}added:
ifitsageogiglayer,createsitsgeogigauthorityURLidentifier*andsavesthelayerinfo*</ul>*/publicclassGeogigLayerIntegrationListenerimplementsCatalogListener{privatestaticfinalLoggerLOGGER=Logging.getLogger(GeogigLayerIntegrationListener.class);publicstaticfinalStringAUTHORITY_URL_NAME="GEOGIG_ENTRY_POINT";publicstaticfinalStringAUTHORITY_URL="http://geogig.org";privatefinalGeoServergeoserver;privatefinalGeoGigCatalogVisitorvisitor=newGeoGigCatalogVisitor();/***/publicGeogigLayerIntegrationListener(GeoServergeoserver){LOGGER.log(Level.FINE,"Initialized{0}",getClass().getName());this.geoserver=geoserver;this.geoserver.getCatalog().addListener(this);
if(!(event.getSource()instanceofLayerInfo)){return;
if(!RepositoryManager.get().isGeogigLayer(layer)){return;
if(!forceServiceRootLayerHaveGeogigAuthURL()){return;
if(PRE_MOFIFY_EVENT.get()!=null){LOGGER.log(Level.FINE,"pre-modifyeventexists,ignoringhandleModifyEvent({0})",PRE_MOFIFY_EVENT.get());return;
if(tryPostUpdate){LOGGER.log(Level.FINE,"Storingeventforpost-handlingon{0}",source);PRE_MOFIFY_EVENT.set(source);
if(preModifySource==null){return;
if(!event.getSource().getId().equals(preModifySource.getId())){return;
if(sourceinstanceofWorkspaceInfo){handlePostWorkspaceChange((WorkspaceInfo)source);
else
if(sourceinstanceofDataStoreInfo){handlePostGeogigStoreChange((DataStoreInfo)source);
if(serviceInfo==null){LOGGER.info("NoWMSInfoavailableinGeoServer.Thisisstrangebutcanhappen");returnfalse;
if(AUTHORITY_URL_NAME.equals(urlInfo.getName())){LOGGER.fine("geogigrootlayerauthURLalreadyexists");returntrue;
if(AUTHORITY_URL_NAME.equals(identifier.getAuthority())){id=identifier;break;
if(id!=null){
if(newIdentifier.equals(id.getIdentifier())){return;
if(refSpec==null){refSpec=connectionParameters.get(HEAD.key);
if(refSpec!=null){identifier.append(':').append(refSpec);
if(iface.isInstance(data.conn)){returniface.cast(data.conn);
if(iface.isInstance(data.conn)){returntrue;
if(globalAttributes==null){globalAttributes=DEFAULT_GLOBAL_ATTRIBUTES;
if(variableAttributes==null){variableAttributes=DEFAULT_VARIABLE_ATTRIBUTES;
if(extraVariables==null){extraVariables=DEFAULT_EXTRA_VARIABLES;
if(metadata==null){metadata=newMetadataMap();
if((key==null||key.trim().isEmpty())){thrownewIllegalArgumentException("Missingattributekey");
if((source==null||source.trim().isEmpty())&&(output==null||output.trim().isEmpty())){thrownewIllegalArgumentException("Neithersourcenoroutputsuppliedforextravariable");
if((source==null||source.trim().isEmpty())&&(output==null||output.trim().isEmpty())){thrownewIllegalArgumentException("Neithersourcenoroutputsuppliedforextravariable");
if(configinstanceofOAuth2FilterConfig){validateOAuth2FilterConfig((OAuth2FilterConfig)config);
else{super.validateFilterConfig(config);
if(StringUtils.hasLength(filterConfig.getLogoutUri())){try{newURL(filterConfig.getLogoutUri());
if(StringUtils.hasLength(filterConfig.getCheckTokenEndpointUrl())==false)throwcreateFilterException(OAuth2FilterConfigException.OAUTH2_CHECKTOKENENDPOINT_URL_REQUIRED);try{newURL(filterConfig.getCheckTokenEndpointUrl());
if(StringUtils.hasLength(filterConfig.getAccessTokenUri())){URLaccessTokenUri=null;try{accessTokenUri=newURL(filterConfig.getAccessTokenUri());
if(filterConfig.getForceAccessTokenUriHttps()&&"https".equalsIgnoreCase(accessTokenUri.getProtocol())==false)throwcreateFilterException(OAuth2FilterConfigException.OAUTH2_ACCESSTOKENURI_NOT_HTTPS);
if(StringUtils.hasLength(filterConfig.getUserAuthorizationUri())){URLuserAuthorizationUri=null;try{userAuthorizationUri=newURL(filterConfig.getUserAuthorizationUri());
if(filterConfig.getForceUserAuthorizationUriHttps()&&"https".equalsIgnoreCase(userAuthorizationUri.getProtocol())==false)throwcreateFilterException(OAuth2FilterConfigException.OAUTH2_USERAUTHURI_NOT_HTTPS);
if(StringUtils.hasLength(filterConfig.getRedirectUri())){try{newURL(filterConfig.getRedirectUri());
if(!StringUtils.hasLength(filterConfig.getCliendId())){throwcreateFilterException(OAuth2FilterConfigException.OAUTH2_CLIENT_ID_REQUIRED);
if(!StringUtils.hasLength(filterConfig.getClientSecret())){throwcreateFilterException(OAuth2FilterConfigException.OAUTH2_CLIENT_SECRET_REQUIRED);
if(!StringUtils.hasLength(filterConfig.getScopes())){throwcreateFilterException(OAuth2FilterConfigException.OAUTH2_SCOPE_REQUIRED);
if(!destRect.equals(bounds)){//TODO:Check
ifthiscaseoccurssometime,andfillpixelvalues
ifitdoes.//Ifithappentooccurs,wewillneedtofixotherGeoToolsoperations//aswell.Logging.getLogger(TransformException.class).warning("Boundsmismatch:"+destRect+"and"+bounds);
ifsourceanddestinationrastersarethesame.Iftheyare//thesame,weshouldskipthisblock.Iterationwillthenbefaster.iterator=TransfertRectIter.create(RectIterFactory.create(source,bounds),iterator);
if(!iterator.finishedBands()){do{recode(iterator);
if(!iterator.finishedLines()){do{iterator.startPixels();
if(!iterator.finishedPixels()){do{doublevalue=iterator.getSampleDouble();
if(value==srcVal){iterator.setSample(destVal);
else{iterator.setSample(value);
if(handlerinstanceofDispatcher){Dispatcherdispatcher=(Dispatcher)handler;IntegerxmlLogBufferSize=getInfo().getGeoServer().getGlobal().getXmlPostRequestLogBufferSize();
if(xmlLogBufferSize!=null){dispatcher.setXMLPostRequestLogBufferSize(xmlLogBufferSize);
if(authenticationinstanceofUsernamePasswordAuthenticationToken){UsernamePasswordAuthenticationTokeninTok=(UsernamePasswordAuthenticationToken)authentication;AuthUserauthUser=null;try{authUser=ruleReaderService.authorize(inTok.getPrincipal().toString(),inTok.getCredentials().toString());
if(authUser!=null){LOGGER.log(Level.FINE,"User{0}authenticated:{1}",newObject[]{inTok.getPrincipal(),authUser});List<GrantedAuthority>roles=newArrayList<GrantedAuthority>();roles.addAll(inTok.getAuthorities());roles.add(GeoServerRole.AUTHENTICATED_ROLE);
if(authUser.getRole()==AuthUser.Role.ADMIN){roles.add(GeoServerRole.ADMIN_ROLE);roles.add(newSimpleGrantedAuthority("ADMIN"));//neededforREST?!?
else{//authUser==null
if("admin".equals(inTok.getPrincipal())&&"geoserver".equals(inTok.getCredentials())){LOGGER.log(Level.FINE,"DefaultadmincredentialsNOTauthenticated--probablyafrontendcheck");
else{LOGGER.log(Level.INFO,"User{0}NOTauthenticated",inTok.getPrincipal());
else{returnnull;
if(info.isInternal()){form.info(newResourceModel("GridSetEditPage.internalGridSetMessage").getObject());name.getFormComponent().setEnabled(false);description.setEnabled(false);crs.setEnabled(false);tileWidth.getFormComponent().setEnabled(false);tileHeight.getFormComponent().setEnabled(false);bounds.setEnabled(false);computeBoundsLink.setEnabled(false);tileMatrixSetEditor.setEnabled(false);saveLink.setVisible(false);addLevelLink.setVisible(false);
if(printDoc){LOGGER.info("WFS=GetCapabilitiesresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSDescribeFeatureType,typename=gsml:MappedFeatureresponse:\n"+prettyString(doc));
elseassertXpathCount(0,"//xsd:complexType",doc);assertXpathCount(0,"//xsd:element",doc);/**gsml:GeologicUnit*/doc=getAsDOM("wfs?request=DescribeFeatureType&version=1.1.0&typename=gsml:GeologicUnit");LOGGER.info("WFSDescribeFeatureType,typename=gsml:GeologicUnitresponse:\n"+prettyString(doc));assertEquals("xsd:schema",doc.getDocumentElement().getNodeName());assertXpathEvaluatesTo(AbstractAppSchemaMockData.GSML_URI,"//@targetNamespace",doc);assertXpathCount(1,"//xsd:include",doc);assertXpathCount(0,"//xsd:import",doc);//GSMLschemaLocationassertXpathEvaluatesTo(AbstractAppSchemaMockData.GSML_SCHEMA_LOCATION_URL,"//xsd:include/@schemaLocation",doc);//nothing
elseassertXpathCount(0,"//xsd:complexType",doc);assertXpathCount(0,"//xsd:element",doc);doc=getAsDOM("wfs?request=DescribeFeatureType&version=1.1.0&typename=gsml:Contact");LOGGER.info("WFSDescribeFeatureType,typename=gsml:Contactresponse:\n"+prettyString(doc));//thenamespaceomhttp://www.opengis.net/om/1.0wasadded//togsml:ContactonpurposetotesttheimporttestConsistantSchema(doc);doc=null;System.gc();doc=getAsDOM("wfs?request=DescribeFeatureType&version=1.1.0&typename=gsml:Contact,gsml:MappedFeature");
if(printDoc){LOGGER.info("WFSDescribeFeatureType,typename=gsml:Contact,gsml:MappedFeatureresponse:\n"+prettyString(doc));
elseassertXpathCount(0,"//xsd:complexType",doc);assertXpathCount(0,"//xsd:element",doc);
if(printDoc){LOGGER.info("WFSGetFeature&typename=gsml:GeologicUnitresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSGetFeature&typename=gsml:ConstituentPartresponse:\n"+prettyString(doc));
if(schemaLocation.startsWith(AbstractAppSchemaMockData.GSML_URI)){//GSMLschemalocationwasencodedfirstassertEquals(gsmlLocation+""+wfsLocation,schemaLocation);
else{//WFSschemalocationwasencodedfirstassertEquals(wfsLocation+""+gsmlLocation,schemaLocation);
if(printDoc){LOGGER.info("WFSGetFeature&typename=gsml:GeologicUnitresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSGetFeature&typename=gsml:GeologicUnitresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSGetFeature&typename=gsml:ShearDisplacementStructureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSGetFeature&typename=gsml:MappedFeatureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSGetFeature&typename=gsml:MappedFeatureresponse:\n"+prettyString(doc));
ifwerounditoffto10decimalplacesprivatebooleanisEqualGeometry(Stringorig,Stringexpected,intleniency){String[]origCoordinates=orig.split("");String[]expCoordinates=expected.split("");
if(origCoordinates.length!=expCoordinates.length)returnfalse;for(inti=0;i<origCoordinates.length;i++){BigDecimalorigBd=newBigDecimal(origCoordinates[i]);BigDecimalexpBd=newBigDecimal(expCoordinates[i]);origBd=origBd.setScale(leniency,BigDecimal.ROUND_HALF_UP);expBd=expBd.setScale(leniency,BigDecimal.ROUND_HALF_UP);
if(!origBd.equals(expBd)){returnfalse;
ifwecangetgsml.geologicunit.16777549126932776withaFeatureIdfidfilter.*/@TestpublicvoidtestGetFeatureWithFeatureIdFilter(){Stringxml=//"<wfs:GetFeature"//+"service=\"WFS\""//+"version=\"1.1.0\""//+"xmlns:cdf=\"http://www.opengis.net/cite/data\""//+"xmlns:ogc=\"http://www.opengis.net/ogc\""//+"xmlns:wfs=\"http://www.opengis.net/wfs\""//+"xmlns:gml=\"http://www.opengis.net/gml\""//+"xmlns:gsml=\""+AbstractAppSchemaMockData.GSML_URI+"\""//+">"//+"<wfs:QuerytypeName=\"gsml:GeologicUnit\">"//+"<ogc:Filter>"//+"<ogc:FeatureIdfid=\"gsml.geologicunit.16777549126932776\"/>"//+"</ogc:Filter>"//+"</wfs:Query>"//+"</wfs:GetFeature>";Documentdoc=postAsDOM("wfs",xml);
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
ifwecangetgsml.geologicunit.16777549126932776withaGmlObjectIdgml:idfilter.*/@TestpublicvoidtestGetFeatureWithGmlObjectIdFilter(){Stringxml=//"<wfs:GetFeature"//+"service=\"WFS\""//+"version=\"1.1.0\""//+"xmlns:cdf=\"http://www.opengis.net/cite/data\""//+"xmlns:ogc=\"http://www.opengis.net/ogc\""//+"xmlns:wfs=\"http://www.opengis.net/wfs\""//+"xmlns:gml=\"http://www.opengis.net/gml\""//+"xmlns:gsml=\""+AbstractAppSchemaMockData.GSML_URI+"\""//+">"//+"<wfs:QuerytypeName=\"gsml:GeologicUnit\">"//+"<ogc:Filter>"//+"<ogc:GmlObjectIdgml:id=\"gsml.geologicunit.16777549126932776\"/>"//+"</ogc:Filter>"//+"</wfs:Query>"//+"</wfs:GetFeature>";Documentdoc=postAsDOM("wfs",xml);
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
ifwecangetgsml.geologicunit.16777549126930540usingitsname.*/@TestpublicvoidtestGetFeaturePropertyFilter(){Stringxml=//"<wfs:GetFeature"//+"service=\"WFS\""//+"version=\"1.1.0\""//+"xmlns:cdf=\"http://www.opengis.net/cite/data\""//+"xmlns:ogc=\"http://www.opengis.net/ogc\""//+"xmlns:wfs=\"http://www.opengis.net/wfs\""//+"xmlns:gml=\"http://www.opengis.net/gml\""//+"xmlns:gsml=\""+AbstractAppSchemaMockData.GSML_URI+"\""//+">"//+"<wfs:QuerytypeName=\"gsml:GeologicUnit\">"//+"<ogc:Filter>"//+"<ogc:PropertyIsEqualTo>"//+"<ogc:PropertyName>gml:name</ogc:PropertyName>"//+"<ogc:Literal>Unnamedincisedalluvium(Na)</ogc:Literal>"//+"</ogc:PropertyIsEqualTo>"//+"</ogc:Filter>"//+"</wfs:Query>"//+"</wfs:GetFeature>";Documentdoc=postAsDOM("wfs",xml);
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
ifwecanfilteronnestedclientproperties*/@TestpublicvoidtestFilterOnNestedAttribute(){Stringxml=//"<wfs:GetFeature"//+"service=\"WFS\""//+"version=\"1.1.0\""//+"xmlns:cdf=\"http://www.opengis.net/cite/data\""//+"xmlns:ogc=\"http://www.opengis.net/ogc\""//+"xmlns:wfs=\"http://www.opengis.net/wfs\""//+"xmlns:gml=\"http://www.opengis.net/gml\""//+"xmlns:gsml=\""+AbstractAppSchemaMockData.GSML_URI+"\""//+">"//+"<wfs:QuerytypeName=\"gsml:GeologicUnit\">"//+"<ogc:Filter>"//+"<ogc:PropertyIsEqualTo>"//+"<ogc:PropertyName>gsml:GeologicUnit/gsml:composition/gsml:CompositionPart/gsml:proportion/gsml:CGI_TermValue/gsml:value</ogc:PropertyName>"//+"<ogc:Literal>significant</ogc:Literal>"//+"</ogc:PropertyIsEqualTo>"//+"</ogc:Filter>"//+"</wfs:Query>"//+"</wfs:GetFeature>";Documentdoc=postAsDOM("wfs",xml);
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info(prettyString(doc));
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info(prettyString(doc));
if(printDoc){LOGGER.info(prettyString(doc));
if(printDoc){LOGGER.info(prettyString(doc));
if(printDoc){LOGGER.info(prettyString(doc));
if(spec.contains("ShearDisplacementStructure")){countType[0]++;
if(spec.contains("GeologicUnit")){countType[1]++;
if(spec.contains("Contact")){countType[2]++;
if(AppSchemaDataAccessConfigurator.isJoining()){//testwithslashinpredicateStringxml=//"<wfs:GetFeature"//+"service=\"WFS\""//+"version=\"1.1.0\""//+"xmlns:ogc=\"http://www.opengis.net/ogc\""//+"xmlns:wfs=\"http://www.opengis.net/wfs\""//+"xmlns:gml=\"http://www.opengis.net/gml\""//+"xmlns:gsml=\""+AbstractAppSchemaMockData.GSML_URI+"\""//+"xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\""//+"xsi:schemaLocation=\""//+"http://www.opengis.net/wfshttp://schemas.opengis.net/wfs/1.1.0/wfs.xsd"//+AbstractAppSchemaMockData.GSML_URI+""+AbstractAppSchemaMockData.GSML_SCHEMA_LOCATION_URL//+"\""+">"//+"<wfs:QuerytypeName=\"gsml:GeologicUnit\">"//+"<ogc:Filter>"//+"<ogc:PropertyIsEqualTo>"//+"<ogc:PropertyName>gsml:geologicHistory/gsml:GeologicEvent/gsml:eventAge/gsml:CGI_TermRange/gsml:lower/gsml:CGI_TermValue[gsml:value/@codeSpace='urn:cgi:classifierScheme:ICS:StratChart:2008']/gsml:value</ogc:PropertyName>"//+"<ogc:Literal>urn:cgi:classifier:ICS:StratChart:2008:Devonian</ogc:Literal>"//+"</ogc:PropertyIsEqualTo>"//+"</ogc:Filter>"//+"</wfs:Query>"//+"</wfs:GetFeature>";validate(xml);Documentdoc=postAsDOM("wfs",xml);
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSfilterGetFeatureresponse:\n"+prettyString(doc));
if(printDoc){LOGGER.info("WFSGetFeature&typename=gsml:GeologicUnitresponse:\n"+prettyString(doc));
if(AppSchemaDataAccessConfigurator.isJoining()){//thisisnonjoiningtestreturn;
if(name!=null&&name.matches("\\w+:\\w+")){//namespacequalifiedname,ensuretheprefixisvalidStringprefix=name.substring(0,name.indexOf(':'));StringnamespaceURI=namespaceSupport.getURI(prefix);//onlyaccept
ifitsanapplicationschemanamespace,orgml
if(!GML.NAMESPACE.equals(namespaceURI)&&(catalog.getNamespaceByURI(namespaceURI)==null)){thrownewWFSException("Illegalattributenamespace:"+namespaceURI);
if(factoryinstanceofFilterFactory2){return((FilterFactory2)factory).property(propertyName.getPropertyName(),GML3EncodingUtils.copyNamespaceSupport(namespaceSupport));
if(to!=null){
if(dependency!=null){to.dependencies.add(dependency);
else{returnoriginal;
if(to!=null){for(Dependencydep:to.dependencies){dep.revert();
if(attribute==null){attribute=MapLayerInfo.getRegionateAttribute(featureType);
if(attribute==null||ft.getDescriptor(attribute)==null){LOGGER.log(Level.FINER,"Noattributespecified,falling"+"backongeometryattribute");attribute=ft.getGeometryDescriptor().getLocalName();
else{//MakesuretheattributeisactuallythereAttributeTypeattributeType=ft.getType(attribute);
if(attributeType==null){thrownewServiceException("Couldnotfindregionatingattribute"+attribute+"inlayer"+featureType.getName());
if((attribute!=null)&&(ft.getDescriptor(attribute)!=null))returnattribute;returnft.getGeometryDescriptor().getLocalName();
if(ginstanceofMultiPoint)return(double)((MultiPoint)g).getNumGeometries();
if(ginstanceofPolygon||ginstanceofMultiPolygon)returng.getArea();
elsereturng.getLength();}}
if(parentObject!=null){role.setAttribute(A_PARENTID_RR,parentObject.getAuthority());
if(isValidatingXMLSchema()){//XMLValidator.Singleton.validateRoleRegistry(doc);//
if(lockFile!=null)return;//wehaveonelockFile=newLockFile(roleResource);try{lockFile.writeLock();
if(lockFile==null)return;//wehavenonelockFile.writeUnLock();lockFile=null;
if(eventinstanceofCatalogRemoveEvent)returntrue;
elsereturnfalse;
if(inSetup)thrownewRuntimeException("setUpInternalseemstocallbacktosuper.setUp()."+"Itshouldcallsuper.setUpInternalinstead");try{inSetup=true;
if(!oneTimeSetupDone){oneTimeSetUp();oneTimeSetupDone=true;forceOneTimeTearDown=true;
if(inTearDown)thrownewRuntimeException("tearDownInternalseemstocallbacktosuper.tearDown()."+"Itshouldcallsuper.tearDownInternalinstead");try{inTearDown=true;tearDownInternal();
if(forceOneTimeTearDown){oneTimeSetupDone=false;forceOneTimeTearDown=false;oneTimeTearDown();
ifany(shallincludeadot,example,".tab")*/privateStringfileExtension;/**Theoptionsthatwillbeaddedtothecommandline*/privateList<String>options;/**Thetypeofformat,usedtoinstantiatethecorrectconverter*/privateOutputTypetype;/***Iftheoutputisasinglefilethatcanbestreamedback.Inthatcasewealsoneedtoknow*themimetype*/privatebooleansingleFile;/**Themimetypeofthesinglefileoutput*/privateStringmimeType;/**Eventualadapterstotoberunbeforeencoding*/List<FormatAdapter>formatAdapters;publicFormat(){this.options=Collections.emptyList();
if(options!=null){this.options=newArrayList<String>(Arrays.asList(options));
if(type==null){this.type=OutputType.BINARY;
ifnonewassetup*/publicList<FormatAdapter>getFormatAdapters(){
if(formatAdapters==null){formatAdapters=newArrayList<>();
if(prefix!=null){metadata.put(OpenSearchParameters.PARAM_PREFIX,prefix);
if(name!=null){metadata.put(OpenSearchParameters.PARAM_NAME,name);
if(min!=null){metadata.put(OpenSearchParameters.MIN_INCLUSIVE,min);
if(max!=null){metadata.put(OpenSearchParameters.MAX_INCLUSIVE,max);
iftherequestsarenottheonesexpectedcheckImage(response,"image/png",180,90);
iftherequestsarenottheonesexpectedcheckImage(response,"image/png",180,90);
if(!storedQueryId.equals(configuration.getStoredQueryId())){thrownewRuntimeException("Programmingerror!Storedqueryidsdonotmatch:'"+storedQueryId+"'vs'"+configuration.getStoredQueryId()+"'");
if(configuration.getStoredQueryParameterMappings()!=null){for(ParameterMappingpm:configuration.getStoredQueryParameterMappings()){
if(pm.getParameterName().equals(pet.getName())){mapping=pm;break;
if(mapping==null){//Nocurrentmapping,returnnomappingattr.setMappingType(ParameterMappingType.NONE);attr.setValue(null);
else{//ConvertmappingtoUImodelParameterMappingTypetype=ParameterMappingType.NONE;Stringvalue=null;
if(mappinginstanceofParameterMappingBlockValue){type=ParameterMappingType.BLOCKED;
else
if(mappinginstanceofParameterMappingDefaultValue){ParameterMappingDefaultValuepmdv=(ParameterMappingDefaultValue)mapping;
if(pmdv.isForcible()){type=ParameterMappingType.STATIC;
else{type=ParameterMappingType.DEFAULT;
else
if(mappinginstanceofParameterMappingExpressionValue){ParameterMappingExpressionValuepmev=(ParameterMappingExpressionValue)mapping;
if(pmev.getExpressionLanguage().equals("CQL")){type=ParameterMappingType.EXPRESSION_CQL;value=pmev.getExpression();
if(transaction!=null){fs.setTransaction(transaction);
if(originalFilter!=null){FiltermappedFilter=mapFilterToDelegateSchema(originalFilter);result.setFilter(mappedFilter);
if(query.getPropertyNames()!=null&&query.getPropertyNames().length>0){String[]mappedPropertyNames=Arrays.stream(query.getPropertyNames()).map(name->propertyMapper.getSourceName(name)).filter(name->name!=null).toArray(size->newString[size]);
if(mappedPropertyNames.length==0){result.setPropertyNames(Query.ALL_NAMES);
else{result.setPropertyNames(mappedPropertyNames);
if(query.getSortBy()!=null&&query.getSortBy().length>0){SortBy[]mappedSortBy=Arrays.stream(query.getSortBy()).map(sb->{
if(sb==SortBy.NATURAL_ORDER||sb==SortBy.REVERSE_ORDER){returnsb;
else{Stringname=sb.getPropertyName().getPropertyName();StringmappedName=propertyMapper.getSourceName(name);
if(mappedName==null){thrownewIllegalArgumentException("Cannotsorton"+name);
else{//getstableresultsforpagingresult.setSortBy(defaultSort);
if(addJoins){//jointometadatatable
ifnecessary
if(hasOutputProperty(query,METADATA_PROPERTY_NAME,false)){Filterfilter=FF.equal(FF.property("id"),FF.property("metadata.mid"),true);finalStringmetadataTable=getMetadataTable();Joinjoin=newJoin(metadataTable,filter);join.setAlias("metadata");join.setType(Type.OUTER);result.getJoins().add(join);
ifnecessary
if(hasOutputProperty(query,LAYER_PROPERTY_NAME,false)){Filterfilter=FF.equal(FF.property("id"),FF.property("layer.cid"),true);finalStringlayerTable=getCollectionLayerTable();Joinjoin=newJoin(layerTable,filter);join.setAlias("layer");join.setType(Type.OUTER);result.getJoins().add(join);
if(hasOutputProperty(query,OGC_LINKS_PROPERTY_NAME,true)){finalStringlinkTable=getLinkTable();finalStringlinkForeignKey=getLinkForeignKey();Filterfilter=FF.equal(FF.property("id"),FF.property("link."+linkForeignKey),true);Joinjoin=newJoin(linkTable,filter);join.setAlias("link");join.setType(Type.OUTER);result.getJoins().add(join);
else{//onlynonjoinedrequestsarepageableresult.setStartIndex(query.getStartIndex());result.setMaxFeatures(query.getMaxFeatures());
ifthe*propertyisexplicitlylisted**@paramquery*@paramproperty*@return*/protectedbooleanhasOutputProperty(Queryquery,Nameproperty,booleanincludedByDefault){
if(query.getProperties()==null){returnincludedByDefault;
if(localPart.equals(pn.getPropertyName())&&(pn.getNamespaceContext()==null||namespaceURI.equals(pn.getNamespaceContext().getURI("")))){returntrue;
ifnofeatures,returnimmediatelySimpleFeatureCollectionfc;
if(ids.isEmpty()){fc=newEmptyFeatureCollection(getDelegateCollectionSource().getSchema());
else{//therunajoinedquerywiththespecifiedidsQuerydataQuery=mapToSimpleCollectionQuery(query,true);dataQuery.setFilter(FF.id(ids));fc=getDelegateCollectionSource().getFeatures(dataQuery);
iftherearemorelinks
if(it.hasNext()){SimpleFeaturenext=it.next();//samefeature?
if(next.getID().equals(fi.getID())){link=next.getAttribute("link");
else{//movedtothenextfeature,pushitback,//we'redoneforthecurrentoneit.pushBack();break;
else{break;
if(!(pdinstanceofAttributeDescriptor)){continue;
if(localName==null){continue;
if(value==null){continue;
if(metadataValueinstanceofSimpleFeature){SimpleFeaturemetadataFeature=(SimpleFeature)metadataValue;ab.setDescriptor((AttributeDescriptor)schema.getDescriptor(METADATA_PROPERTY_NAME));Attributeattribute=ab.buildSimple(null,metadataFeature.getAttribute("metadata"));builder.append(METADATA_PROPERTY_NAME,attribute);
ifanyObjectlayerValue=fi.getAttribute(OpenSearchAccess.LAYER);
if(layerValueinstanceofSimpleFeature){SimpleFeaturelayerFeature=(SimpleFeature)layerValue;SimpleFeatureretyped=retypeLayerFeature(layerFeature);ab.setDescriptor((AttributeDescriptor)schema.getDescriptor(LAYER_PROPERTY_NAME));finalCollection<Property>properties=retyped.getProperties();Attributeattribute=ab.buildSimple(retyped.getID(),properties);builder.append(LAYER_PROPERTY_NAME,attribute);
if(value!=null&&("bands".equals(localName)||"browseBands".equals(localName))){String[]split=((String)value).split("\\s*,\\s*");retypeBuilder.set(attName,split);
else{retypeBuilder.set(attName,value);
if(!(pdinstanceofAttributeDescriptor)){continue;
if(localName==null){continue;
if(pdinstanceofGeometryDescriptor&&property==null){property=feature.getDefaultGeometryProperty();
if(property==null||property.getValue()==null){continue;
if(fs==null){thrownewIOException("Couldnotfindadelegatefeaturestoreforunmappedfeature"+sf);
if(OpenSearchAccess.METADATA_PROPERTY_NAME.equals(name)){finalStringtableName=getMetadataTable();modifySecondaryTable(mappedFilter,value,tableName,id->FF.id(FF.featureId(tableName+"."+id)),(id,secondaryStore)->{SimpleFeatureBuilderfb=newSimpleFeatureBuilder(secondaryStore.getSchema());fb.set("mid",id);fb.set("metadata",value);SimpleFeaturemetadataFeature=fb.buildFeature(tableName+"."+id);metadataFeature.getUserData().put(Hints.USE_PROVIDED_FID,true);returnDataUtilities.collection(metadataFeature);});//thisonehasbeenhandledcontinue;
if(OpenSearchAccess.QUICKLOOK_PROPERTY_NAME.equals(name)){finalStringtableName=getThumbnailTable();modifySecondaryTable(mappedFilter,value,tableName,id->FF.id(FF.featureId(tableName+"."+id)),(id,secondaryStore)->{SimpleFeatureBuilderfb=newSimpleFeatureBuilder(secondaryStore.getSchema());fb.set("tid",id);fb.set("thumb",value);SimpleFeaturethumbnailFeature=fb.buildFeature(tableName+"."+id);thumbnailFeature.getUserData().put(Hints.USE_PROVIDED_FID,true);returnDataUtilities.collection(thumbnailFeature);});//thisonedonecontinue;
if(LAYER_PROPERTY_NAME.equals(name)){finalStringtableName=getCollectionLayerTable();modifySecondaryTable(mappedFilter,value,tableName,id->FF.id(FF.featureId(tableName+"."+id)),(id,secondaryStore)->{SimpleFeatureBuilderfb=newSimpleFeatureBuilder(secondaryStore.getSchema());Featuref=(Feature)value;for(Propertyp:f.getProperties()){StringattributeName=p.getName().getLocalPart();ObjectattributeValue=p.getValue();
if(("bands".equals(attributeName)||"browseBands".equals(attributeName))&&attributeValueinstanceofString[]){finalString[]array=(String[])attributeValue;attributeValue=Arrays.stream(array).collect(Collectors.joining(","));
if(OpenSearchAccess.OGC_LINKS_PROPERTY_NAME.equals(name)){finalStringtableName=getLinkTable();modifySecondaryTable(mappedFilter,value,tableName,id->FF.equal(FF.property(getLinkForeignKey()),FF.literal(id),true),(id,linksStore)->{SimpleFeatureCollectionlinks=(SimpleFeatureCollection)value;SimpleFeatureBuilderfb=newSimpleFeatureBuilder(linksStore.getSchema());ListFeatureCollectionmappedLinks=newListFeatureCollection(linksStore.getSchema());links.accepts(f->{SimpleFeaturesf=(SimpleFeature)f;for(AttributeDescriptorad:linksStore.getSchema().getAttributeDescriptors()){fb.set(ad.getLocalName(),sf.getAttribute(ad.getLocalName()));
if(modifySecondaryAttribute(name,value,mappedFilter)){continue;
if(!(descriptorinstanceofAttributeDescriptor)){thrownewIllegalArgumentException("Didnotexpectmodificationonattribute"+name);
if(localName==null){thrownewIllegalArgumentException("Didnotexpectmodificationonattribute"+name);
if(localNames.size()>0){String[]nameArray=(String[])localNames.toArray(newString[localNames.size()]);Object[]valueArray=(Object[])localValues.toArray(newObject[localValues.size()]);getDelegateCollectionStore().modifyFeatures(nameArray,valueArray,mappedFilter);
ifthemetadatawasalreadytheretoperformanupdatesecondaryStore.removeFeatures(secondaryTableFilter);
if(value!=null){SimpleFeatureCollectioncollection=featureBuilder.apply(id,secondaryStore);secondaryStore.addFeatures(collection);
if(t!=Transaction.AUTO_COMMIT&&t!=null){((SimpleFeatureStore)fs).setTransaction(transaction);
if(transaction==null){returnTransaction.AUTO_COMMIT;
else{returnthis.transaction;
if(value==null){thrownewNullPointerException("valuemustbenon-null");
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;Keywordother=(Keyword)obj;
if(language==null){
if(other.language!=null)returnfalse;
else
if(!language.equals(other.language))returnfalse;
if(value==null){
if(other.value!=null)returnfalse;
else
if(!value.equals(other.value))returnfalse;
if(vocabulary==null){
if(other.vocabulary!=null)returnfalse;
else
if(!vocabulary.equals(other.vocabulary))returnfalse;returntrue;}}
if(!isEarthObservationEnabled()){returnnewString[0];
if(!isEarthObservationEnabled()){return;
if(!(contextinstanceofCoverageInfo)||!isEarthObservationEnabled()){return;
if(time==null){LOGGER.log(Level.FINE,"Wereceivedacoverageinfothathasno"+"associatedtime,cannotaddEOmetadatatoit:"+ci.prefixedName());return;
if(EPSGCode==null){thrownewIllegalStateException("UnabletolookupepsgcodeforthisCRS:"+crs);
if(content!=null){tx.chars(content);
ifnoneisspecified*/publicstaticfinaldoubleDEFAULT_SYMBOL_SIZE=16d;privateIcons(){}/***Findthesizeofasquareneededtoaccommodatetherotatedimageofanothersquare**@paramsizesizeofthesquaretorotate.{@codenull}returns{@codenull}.*@paramrotationtheangletorotateindegrees.{@codenull}istreatedasnorotation.*@returnthesizeofasquarebigenoughtocontaintherotatedimage*/publicstatic@NullableIntegerrotationScale(@NullableIntegersize,@NullableDoublerotation){
if(size==null)returnnull;
if(rotation==null||rotation%90==0)returnsize;//Saveussometrigfunctionsreturn(int)Math.ceil(rotationScaleFactor(rotation)*size);
if(size==null)returnnull;
if(rotation==null||rotation%90==0)returnsize;//SaveussometrigfunctionsreturnrotationScaleFactor(rotation)*size;
if(i==null){Expressionlocation;try{location=ExpressionExtractor.extractCqlExpressions(eg.getLocation().toString());Iterator<ExternalGraphicFactory>it=DynamicSymbolFactoryFinder.getExternalGraphicFactories();while(i==null&&it.hasNext()){try{ExternalGraphicFactoryfact=it.next();i=fact.getIcon((Feature)null,location,eg.getFormat(),-1);
if(i==null){return(int)Icons.DEFAULT_SYMBOL_SIZE;
else{returnMath.max(i.getIconHeight(),i.getIconWidth());
if(rotation==null){rotation=getRotation(g,f);
if(gsinstanceofMark){Strokestroke=((Mark)gs).getStroke();
if(stroke!=null){Doublewidth=stroke.getWidth().evaluate(f,Double.class);
if(width!=null){border=width;
if(size==null){
if(gsinstanceofExternalGraphic){size=(double)getExternalSize((ExternalGraphic)gs,f);
else{size=(double)DEFAULT_SYMBOL_SIZE;
if(size!=null)size+=border;returnsize;
if(size!=null){returnsize/DEFAULT_SYMBOL_SIZE;
ifwehaveadatabaebackendandjoiningisenabledassumeTrue(mfSourceFs.getDataStore()instanceofJDBCDataStore&&guSourceFs.getDataStore()instanceofJDBCDataStore&&AppSchemaDataAccessConfigurator.isJoining());mfSourceDataStore=(JDBCDataStore)mfSourceFs.getDataStore();guSourceDataStore=(JDBCDataStore)guSourceFs.getDataStore();//retrieveonefeaturetotriggerallnecessaryinitializationstepssotheydon't//interfere//withthetest'soutcometry(FeatureIteratorfIt=mfFs.getFeatures().features()){assertTrue(fIt.hasNext());assertNotNull(fIt.next());
if(attrinstanceofJoiningNestedAttributeMapping){nestedFeaturesCount++;JoiningNestedAttributeMappingjoiningNestedAttr=(JoiningNestedAttributeMapping)attr;Map<Name,DataAccessMappingFeatureIterator>nestedFeatureIterators=joiningNestedAttr.getNestedFeatureIterators(mappingIt);assertNotNull(nestedFeatureIterators);
if(nestedFeatureIterators.size()>0){assertEquals(1,nestedFeatureIterators.size());FeatureTypeMappingnestedMapping=joiningNestedAttr.getFeatureTypeMapping(null);DataAccessMappingFeatureIteratornestedIt=nestedFeatureIterators.values().iterator().next();TransactionexpectedTx=parentTx;DataAccessexpectedDataStore=parentDataStore;StringnestedFeatureName=nestedMapping.getTargetFeature().getLocalName();
if(nestedFeatureName.equals("GeologicUnit")){expectedDataStore=guSourceDataStore;
if(guTransaction==null){guTransaction=nestedIt.getTransaction();
else
if(nestedFeatureName.equals("MappedFeature")){expectedDataStore=mfSourceDataStore;
if(mfTransaction==null){mfTransaction=nestedIt.getTransaction();
if(lakes!=null&&forests!=null){group.setName(NATURE_GROUP);group.getLayers().add(lakes);group.getLayers().add(forests);CatalogBuildercb=newCatalogBuilder(catalog);cb.calculateLayerGroupBounds(group);catalog.add(group);
if(link==null){link=newArrayList<LinkType>();
if(trkseg==null){trkseg=newArrayList<TrksegType>();
if(context!=null){try{runImport(context,async);
if(tinstanceofValidationException){thrownewRestException(t.getMessage(),HttpStatus.BAD_REQUEST,t);
else{thrownewRestException("Erroroccuredexecutingimport",HttpStatus.INTERNAL_SERVER_ERROR,t);
if(context!=null){importer.changed(context);
else{thrownewRestException("Erroroccuredexecutingimport",HttpStatus.INTERNAL_SERVER_ERROR);
if(lookupContext==null){//thismeansaspecificlookupfailedthrownewRestException("Failedtofindimportcontext",HttpStatus.NOT_FOUND);
else{//ForImportContext,theexpandparameterishandledattheconverterlevel.Here,we//arelistingcontexts,anduseadifferent(moresuccinct)defaultreturn(writer,builder,converter)->converter.contexts(builder,(Iterator<ImportContext>)lookupContext,converter.expand(expand,0));
if(id!=null){ImportContextcontext=createImport(id,null,async,exec);assertcontext.getId()>=id;UriComponentsuriComponents=getUriComponents(context.getId().toString(),builder);HttpHeadersheaders=newHttpHeaders();headers.setLocation(uriComponents.toUri());returnnewResponseEntity<>(context,headers,HttpStatus.CREATED);
else{thrownewRestException("IDmustbeprovidedforPUT",HttpStatus.BAD_REQUEST);
if(id==null){contexts=importer.getAllContexts();
else{contexts=Collections.singletonList(context(id)).iterator();
if(context.getState()==ImportContext.State.INIT){thrownewRestException("ImportcontextisstillinINITstate,cannotrunityet",HttpStatus.PRECONDITION_FAILED);
iftheimportisempty,prepitbutleavedataasis
if(context.getTasks().isEmpty()){importer.init(context,false);
if(async){importer.runAsync(context,ImportFilter.ALL,false);
else{importer.run(context);
if(async){context=importer.registerContext(id);
else{context=importer.createContext(id);
if(newContext!=null){WorkspaceInfotargetWorkspace=newContext.getTargetWorkspace();StoreInfotargetStore=newContext.getTargetStore();
if(targetWorkspace!=null){//resolvetothe'real'workspaceWorkspaceInfows=importer.getCatalog().getWorkspaceByName(newContext.getTargetWorkspace().getName());
if(ws==null){thrownewRestException("Targetworkspacedoesnotexist:"+newContext.getTargetStore().getName(),HttpStatus.BAD_REQUEST);
if(targetStore!=null){StoreInfots=importer.getCatalog().getStoreByName(newContext.getTargetStore().getName(),StoreInfo.class);
if(ts==null){thrownewRestException("Targetstoredoesnotexist:"+newContext.getTargetStore().getName(),HttpStatus.BAD_REQUEST);
if(targetStore!=null&&targetWorkspace==null){//takeitfromthestorecontext.setTargetWorkspace(targetStore.getWorkspace());
else
if(context==null){context=context(id,true);
if(!async&&context.getData()!=null){importer.init(context,true);
if(async&&context.getData()!=null){
if(execute){importer.runAsync(context,ImportFilter.ALL,true);
else{importer.initAsync(context,true);
else
if(execute&&context.getData()!=null){importer.run(context);
if(wml==null){wml=catalog.getFactory().createWMSLayer();wml.setName("states");wml.setNativeName("topp:states");wml.setStore(catalog.getStoreByName("demo",WMSStoreInfo.class));wml.setCatalog(catalog);wml.setNamespace(catalog.getNamespaceByPrefix("sf"));wml.setSRS("EPSG:4326");CoordinateReferenceSystemwgs84=CRS.decode("EPSG:4326");wml.setNativeCRS(wgs84);wml.setLatLonBoundingBox(newReferencedEnvelope(-110,0,-60,50,wgs84));wml.setProjectionPolicy(ProjectionPolicy.FORCE_DECLARED);catalog.add(wml);
if(l!=null){catalog.remove(l);
if(l!=null){catalog.remove(l);
if(r!=null){catalog.remove(r);
if(l==null){l=catalog.getFactory().createLayer();l.setResource(catalog.getResourceByName("sf","states",WMSLayerInfo.class));catalog.add(l);
if(GML.featureMembers.equals(name)){//checktheWFSconfiguration,
ifencodefeatureMemberisselectedonWFSconfiguration//page,returnnull;
if(encodeFeatureMember){returnnull;
if(!featureCollection.getFeature().isEmpty()){returnhandleFeatureCollection(featureCollection);
else
if(GML.featureMember.equals(name)){//checktheWFSconfiguration,
ifencodefeatureMembersisselectedonWFS//configurationpage,returnnull;
if(!encodeFeatureMember){returnnull;
if(!featureCollection.getFeature().isEmpty()){returnhandleFeatureCollection(featureCollection);
else
if(GML.boundedBy.equals(name)&&generateBounds){FeatureCollectionTypefeatureCollection=(FeatureCollectionType)object;ReferencedEnvelopeenv=null;for(Iteratorit=featureCollection.getFeature().iterator();it.hasNext();){FeatureCollectionfc=(FeatureCollection)it.next();
if(env==null){env=fc.getBounds();
else{env.expandToInclude(fc.getBounds());
if(env!=null&&env.getCoordinateReferenceSystem()==null){CoordinateReferenceSystemcrs=fc.getSchema().getCoordinateReferenceSystem();
if(crs==null){//fallbackoncatalogFeatureTypeInfoinfo=catalog.getFeatureTypeByName(fc.getSchema().getName());
if(info!=null){crs=info.getCRS();
if(env!=null){//JD:herewedon'treturntheenvelope
ifitisnullorempty,thisistowork//aroundanissuewithvalidationintheciteengine.Ihaveopenedajiratask//totrackthis,andhopefullyeventuallyfixtheciteengine//https://osgeo-org.atlassian.net/browse/GEOS-2700return!(env.isNull()||env.isEmpty())?env:null;
if(featureCollection.getFeature().size()>1){//wrapinasingleresult=newCompositeFeatureCollection(featureCollection.getFeature());
else{//justreturnthesingleresult=(FeatureCollection)featureCollection.getFeature().iterator().next();
if(isSimpleFeatureCollection(result)&&encoder.getConfiguration().hasProperty(GMLConfiguration.OPTIMIZED_ENCODING)){returnnewGML3FeatureCollectionEncoderDelegate((SimpleFeatureCollection)result,encoder);
else{returnresult;
if(resultinstanceofCompositeFeatureCollection){CompositeFeatureCollectioncomposite=(CompositeFeatureCollection)result;for(FeatureCollectioncollection:composite.getCollections()){
if(!(collectioninstanceofSimpleFeatureCollection)){returnfalse;
else{returnresultinstanceofSimpleFeatureCollection;
if(expectedColor!=null){assertEquals(expectedColor,cme.getColor().evaluate(null,String.class));
if(expectedOpacity!=null){
if(cme.getOpacity()==null||cme.getOpacity().evaluate(null)==null){assertEquals(expectedOpacity,1d,TOLERANCE);
else{assertEquals(expectedOpacity,cme.getOpacity().evaluate(null,Double.class),TOLERANCE);
if(expectedValue!=null){assertEquals(expectedValue,cme.getQuantity().evaluate(null,Double.class),TOLERANCE);
if(qName.getPrefix()!=null){returnqName.getPrefix()+"__"+qName.getLocalPart();
else{returnqName.getLocalPart();
if(!isQuietTests()){print(json(response));
ifthequeueisfullreloadService=newThreadPoolExecutor(1,1,0L,TimeUnit.MILLISECONDS,newLinkedBlockingQueue<Runnable>(1),threadFactory,rejectionHandler);
ifanotheroneisalready//scheduledreloadService.submit(newRunnable(){@Overridepublicvoidrun(){//lockduringeventprocessingeventLock.set(true);try{gs.reload();
iflockeditmeanseventinresponsetoconfigurationreload,don'tpropagate
if(eventLock.get()){return;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(format("%s-Publishingevent%s",nodeId(),e));
if(property!=null&&"false".equals(property.toLowerCase())){returnnull;
if(!base.exists())base.mkdir();FilefixtureFile=newFile(base,fixtureId+".properties");
if(!fixtureFile.exists()){finalStringwarning="Disablingtestbasedonfixture"+fixtureId+"sincethefile"+fixtureFile+"couldnotbefound";disableTest(warning);returnnull;
if(tmp==null)tmp="";//avoidNPEserverURLPrefix=newURL(tmp);loginURL=newURL(tmp+"/login");tmp=props.getProperty(CAS_SERVICE_PROPERTY);
if(tmp==null)tmp="";//avoidNPEserviceURL=newURL(tmp);tmp=props.getProperty(CAS_PROXYCALLBACK_PROPERTY);
if(tmp==null)tmp="";//avoidNPEproxyCallbackURLPrefix=newURL(tmp);
if(huc.getResponseCode()!=HttpServletResponse.SC_OK){disableTest("Cannotconnectto"+loginURL.toString());returnnull;
if(keyStoreFile.exists()==false){disableTest("Keystorenotfound:"+keyStoreFile.getAbsolutePath());returnnull;
ifthetestwasdisabledwedon'tneedtorunthesetup
if(fixture==null)return;super.setUp();
iftheDataAccesshasanamespaceparameter,itis*automaticallyupdatedtomatchtheworkspace'snamespaceasperGEOS-3149untilthe*resource/publishsplitisfinalized*/protectedWorkspacePanelworkspacePanel;protectedStoreEditPanelstoreEditPanel;publicAbstractDataAccessPage(){}/***@paramstoreInfo*@throwsIllegalArgumentException*/protectedvoidinitUI(finalDataStoreInfostoreInfo)throwsIllegalArgumentException{
if(storeInfo.getWorkspace()==null){thrownewIllegalArgumentException("Workspacenotprovided");
if(dsFactory==null){Stringmsg=(String)newResourceModel("AbstractDataAccessPage.cantGetDataStoreFactory").getObject();thrownewIllegalArgumentException(msg);
iftheoperation*failed*/protectedabstractvoidonSaveDataStore(finalDataStoreInfoinfo,AjaxRequestTargetrequestTarget)throwsIllegalArgumentException;/***Makethe{@link#namespacePanel}modeltosynchupwiththeworkspacewheneverthe{@link*#workspacePanel}optionchanges.**<p>Thisissotomaintainnamespacesinsynchwithworkspacewhiletheresource/publishsplit*isnotfinalized,asperGEOS-3149.**<p>Removingthismethodandthecalltoiton{@link#getInputComponent(String,IModel,*ParamInfo)}isallthat'sneededtoletthenamespacebeselectableindependentlyofthe*workspaceoncetheresource/publishsplitisdone.*/privatevoidmakeNamespaceSyncUpWithWorkspace(finalFormparamsForm){//donotallowthenamespacechoicetobemanuallychangedfinalDropDownChoicewsDropDown=(DropDownChoice)workspacePanel.getFormComponent();//addanajaxonchangebehaviourthatkeepswsandnsinsynchwsDropDown.add(newOnChangeAjaxBehavior(){privatestaticfinallongserialVersionUID=1L;privateNamespaceParamModelnamespaceModel;privateNamespacePanelnamespacePanel;privatebooleannamespaceLookupOccurred;@OverrideprotectedvoidonUpdate(AjaxRequestTargettarget){//see
ifthenamespaceparamistiedtoaNamespacePanelandsaveit
if(!namespaceLookupOccurred){//searchforthepanelComponentparamsPanel=AbstractDataAccessPage.this.get("dataStoreForm:parametersPanel");namespacePanel=findNamespacePanel((MarkupContainer)paramsPanel);//
ifthepanelisnottheresearchfortheparameterandbuildamodel//aroundit
if(namespacePanel==null){finalIModelmodel=paramsForm.getModel();finalDataStoreInfoinfo=(DataStoreInfo)model.getObject();finalCatalogcatalog=getCatalog();finalResourcePoolresourcePool=catalog.getResourcePool();DataAccessFactorydsFactory;try{dsFactory=resourcePool.getDataStoreFactory(info);
if("namespace".equals(p.getName())){finalIModelparamsModel=newPropertyModel(model,"connectionParameters");namespaceModel=newNamespaceParamModel(paramsModel,"namespace");break;
if(namespacePanel!=null){//updatetheGUInamespacePanel.setDefaultModelObject(namespaceInfo);target.add(namespacePanel.getFormComponent());
else
if(namespaceModel!=null){//updatethemodeldirectlynamespaceModel.setObject(namespaceInfo);//target.add(AbstractDataAccessPage.this);
if(childinstanceofNamespacePanel){return(NamespacePanel)child;
else
if(childinstanceofMarkupContainer){NamespacePanelpanel=findNamespacePanel((MarkupContainer)child);
if(panel!=null){returnpanel;
if(!directory.delete()||!directory.mkdir())thrownewIOException("Errorcreatingtempdirectoryat"+directory.getAbsolutePath());returnnewDirectory(directory);
if(!vfs.canHandle(archive)){thrownewIOException(archive.getPath()+"isnotarecognizableformat");
ifthefileisanarchive,unpackitVFSWorkervfs=newVFSWorker();
if(vfs.canHandle(file)){LOGGER.fine("unpacking"+file.getAbsolutePath()+"to"+this.file.getAbsolutePath());vfs.extractTo(file,this.file);LOGGER.fine("deleting"+file.getAbsolutePath());
if(!file.delete()){thrownewIOException("unabletodeletefile");
if(name==null){//createrandomtry{returnFile.createTempFile("child","tmp",file);
if(m.isCanceled()){return;
if(fileList==null){//itcanbenullincaseofI/Oerror,even
ifthe//dirisindeedadirectorycontinue;
if(f.isHidden()){all.remove(f);continue;
if(f.isDirectory()){
if(!recursive&&!f.equals(file)){//skipitcontinue;
if(!"__MACOSX".equals(f.getName())){Directoryd=newDirectory(f);d.prepare(m);files.add(d);
if("aux".equalsIgnoreCase(FilenameUtils.getExtension(f.getName()))){continue;
ifthisisaspatialformatornotDataFormatformat=DataFormat.lookup(f);
if(format!=null){SpatialFilesf=newSpatialFile(f,format);//gatheruptherelatedfilessf.prepare(m);files.add(sf);all.removeAll(sf.allFiles());
if(base.equals(FilenameUtils.getBaseName(f.getName()))){////.prjfile?//
if("prj".equalsIgnoreCase(FilenameUtils.getExtension(f.getName()))){//sf.setPrjFile(f);//
else{//sf.getSuppFiles().add(f);//
if(finstanceofDirectory){Directoryd=(Directory)f;it.remove();q.addLast(d);
if(f.isDirectory()){//q.addAll(Arrays.asList(f.listFiles()));//continue;//
ifthisisaspatialformatornot//DataFormatformat=DataFormat.lookup(f);////
if(format!=null){//SpatialFilefile=newSpatialFile(f);//file.setFormat(format);//files.add(file);//
else{//ignored.add(f);//
if(base.equals(FilenameUtils.getBaseName(f.getName()))){////.prjfile?//
if("prj".equalsIgnoreCase(FilenameUtils.getExtension(f.getName()))){//sf.setPrjFile(f);//
else{//sf.getSuppFiles().add(f);//
iftheyarenotthisreturnsnull.*/publicDataFormatformat()throwsIOException{
if(files.isEmpty()){LOGGER.warning("nofilesrecognized");returnnull;
if(format!=null&&!format.equals(other.getFormat())){logFormatMismatch();returnnull;
if(format==null&&other.getFormat()!=null){logFormatMismatch();returnnull;
if(f.getFormat()!=null){format=f.getName();
if(!locking.exists()){locking.createNewFile();
if(dfo!=null){dfo.close();
ifanerroroccursandthezip//fileisemptybychance,theseconderrorwillmaskthefirsttry{IOUtils.zipDirectory(file,zout,null);
if(exinstanceofIOException)throw(IOException)ex;throw(IOException)newIOException("Errorarchiving").initCause(ex);
ifwegethere,thezipisproperlywrittentry{zout.close();
if(files!=null){for(Filef:files){
if(f.isDirectory()){newDirectory(f).cleanup();
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Deletingfile"+f.getAbsolutePath());
if(!f.delete()){thrownewIOException("unabletodelete"+f);
if(thisinstanceofFiltered){files=((Filtered)this).filter;
if(resource!=null){
if(isNew()){//Disablingadditionalvalidators((CatalogImpl)getCatalog()).setExtendedValidation(false);//ResolvingCollectionsOwsUtils.resolveCollections(resource);
if(resourceinstanceofWorkspaceInfo){WorkspaceInfows=((WorkspaceInfo)resource);
if(filteredResource(resource,ws,true)){returnnull;
if(!validateWorkspace((WorkspaceInfo)resource,isNew())){LOGGER.warning("Skippedinvalidresource:"+resource);logValidationExceptions(resource,null);returnnull;
else
if(resourceinstanceofDataStoreInfo){WorkspaceInfows=((DataStoreInfo)resource).getWorkspace()!=null?getCatalog().getWorkspaceByName(((DataStoreInfo)resource).getWorkspace().getName()):null;
if(filteredResource(resource,ws,true)){returnnull;
if(!validateDataStore((DataStoreInfo)resource,isNew())){LOGGER.warning("Skippedinvalidresource:"+resource);logValidationExceptions(resource,null);returnnull;
if(getCatalog().getDefaultDataStore(ws)==null){getCatalog().setDefaultDataStore(ws,(DataStoreInfo)resource);
else
if(resourceinstanceofCoverageStoreInfo){WorkspaceInfows=((CoverageStoreInfo)resource).getWorkspace()!=null?getCatalog().getWorkspaceByName(((CoverageStoreInfo)resource).getWorkspace().getName()):null;
if(filteredResource(resource,ws,true)){returnnull;
if(!validateCoverageStore((CoverageStoreInfo)resource,isNew())){LOGGER.warning("Skippedinvalidresource:"+resource);logValidationExceptions(resource,null);returnnull;
else
if(resourceinstanceofResourceInfo){WorkspaceInfows=((ResourceInfo)resource).getStore()!=null&&((ResourceInfo)resource).getStore().getWorkspace()!=null?getCatalog().getWorkspaceByName(((ResourceInfo)resource).getStore().getWorkspace().getName()):null;
if(filteredResource(resource,ws,true)){returnnull;
if(!validateResource((ResourceInfo)resource,isNew())){LOGGER.warning("Skippedinvalidresource:"+resource);logValidationExceptions(resource,null);returnnull;
else
if(resourceinstanceofLayerInfo){ValidationResultresult=null;try{WorkspaceInfows=((LayerInfo)resource).getResource()!=null&&((LayerInfo)resource).getResource().getStore()!=null&&((LayerInfo)resource).getResource().getStore().getWorkspace()!=null?getCatalog().getWorkspaceByName(((LayerInfo)resource).getResource().getStore().getWorkspace().getName()):null;
if(filteredResource(resource,ws,true)){returnnull;
if(!result.isValid()){logValidationExceptions(resource,null);returnnull;
else
if(resourceinstanceofStyleInfo){ValidationResultresult=null;try{WorkspaceInfows=((StyleInfo)resource).getWorkspace()!=null?getCatalog().getWorkspaceByName(((StyleInfo)resource).getWorkspace().getName()):null;
if(filteredResource(resource,ws,false)){returnnull;
if(!result.isValid()){logValidationExceptions(resource,null);returnnull;
else
if(resourceinstanceofLayerGroupInfo){ValidationResultresult=null;try{WorkspaceInfows=((LayerGroupInfo)resource).getWorkspace()!=null?getCatalog().getWorkspaceByName(((LayerGroupInfo)resource).getWorkspace().getName()):null;
if(filteredResource(resource,ws,false)){returnnull;
if(!result.isValid()){logValidationExceptions(resource,null);returnnull;
if(ns==null){returnfalse;
ifadefault{@linkDataStoreInfo}hasnotbeendefinedforthecurrent{@link*WorkspaceInfo},setthisoneasdefault.**@paramisNew*@param{@linkDataStoreInfo}resource*@returnbooleanindicatingwhethertheresourceisvalidornot.*@throwsException*/privatebooleanvalidateDataStore(DataStoreInforesource,booleanisNew)throwsException{finalWorkspaceInfows=this.getCatalog().getWorkspaceByName(resource.getWorkspace().getName());
if(ws==null){returnfalse;
if(ws==null){returnfalse;
if(store==null){returnlogValidationExceptions((T)resource,null);
if(ds!=null){resource.setStore(ds);
else{returnlogValidationExceptions((T)resource,null);
if(existing!=null&&!existing.getId().equals(resource.getId())){finalStringmsg="Resourcenamed'"+resource.getName()+"'alreadyexistsinstore:'"+store.getName()+"'";returnlogValidationExceptions((T)resource,newRuntimeException(msg));
if(existing!=null&&!existing.getId().equals(resource.getId())){finalStringmsg="Resourcenamed'"+resource.getName()+"'alreadyexistsinnamespace:'"+namespace.getPrefix()+"'";returnlogValidationExceptions((T)resource,newRuntimeException(msg));
if(objectinstanceofSimpleHash){return(SimpleHash)object;
if(objectinstanceofCollection){Collectionc=(Collection)object;
if(c.isEmpty()||clazz.isAssignableFrom(c.iterator().next().getClass())){SimpleHashhash=newSimpleHash();hash.put("values",newCollectionModel(c,this));setRequestInfo(hash);wrapInternal(hash,(Collection<T>)object);returnhash;
if(object!=null&&clazz.isAssignableFrom(object.getClass())){Map<String,Object>map=objectToMap(object,clazz);SimpleHashmodel=newSimpleHash();model.put("properties",newMapModel(map,this));model.put("className",clazz.getSimpleName());setRequestInfo(model);wrapInternal(map,model,(T)object);returnmodel;
if("Class".equals(p))continue;Objectvalue;try{value=OwsUtils.get(object,p);
if(value==null){value="null";
if(valueinstanceofCollection){Listvalues=newArrayList();for(Objecto:(Collection)value){valueClass=getClassForUnwrapping(o);
if(valueClass==null){values.add(o==null?"":o.toString());
else{values.add(objectToMap(o,valueClass));
else
if(valueClass==null){map.put(key,value.toString());
else{map.put(key,objectToMap(value,valueClass));
if(clazz.isAssignableFrom(o.getClass())){returnclazz;
if(model.get("page")==null){
if(requestInfo!=null){model.put("page",requestInfo);
if(fts.featureTypeNames().isEmpty()||((schema.getName().getLocalPart()!=null)&&(schema.getName().getLocalPart().equalsIgnoreCase(ftName)||FeatureTypes.isDecendedFrom(schema,null,ftName)))){filtered.add(fts);
if(((r.getMinScaleDenominator()-TOLERANCE)<=scaleDenominator)&&((r.getMaxScaleDenominator()+TOLERANCE)>scaleDenominator)){rulesCopy.add(r);
if(iteminstanceofResource){return((Resource)item).getType()==Type.UNDEFINED;
if(!keystoreProvider.hasUserGroupKey(service.getName())){thrownewIOException("Nokeyalias:"+keystoreProvider.aliasForGroupService(service.getName())+"inkeystore:"+keystoreProvider.getResource().path());
if(getProviderName()!=null&&!getProviderName().isEmpty()){stringEncrypter.setProviderName(getProviderName());
if(getProviderName()!=null&&!getProviderName().isEmpty()){byteEncrypter.setProviderName(getProviderName());
if(!keystoreProvider.containsAlias(getKeyAliasInKeyStore())){thrownewRuntimeException("Keystore:"+keystoreProvider.getResource().path()+"doesnot"+"containalias:"+getKeyAliasInKeyStore());
if(stringEncrypter==null){//notinitializedgetStringEncoder();
if(byteEncrypter==null){//notinitializedgetCharEncoder();
ifitdoesnotalreadyexist
if(!directoryService.getAdminSession().exists(partition.getSuffixDn())){ServerEntryentry=directoryService.newEntry(newLdapDN(defaultPartitionSuffix));entry.add("objectClass","top","domain","extensibleObject");entry.add("dc",defaultPartitionName);directoryService.getAdminSession().add(entry);
if(StringUtils.hasLength(enc.getPrefix())){
if(service!=null){try{
if(encinstanceofGeoServerPBEPasswordEncoder){
if(!secMgr.getKeyStoreProvider().hasUserGroupKey(service.getName())){continue;//cannotusepbeencoder,nokey
if(enc.isResponsibleForEncoding(encPass))returnenc;
if(progressListener==null){progressListener=newDefaultProgressListener();
ifheightandwidthareanoddnumberfixthem,cannotencodevideosotherwise
if(width%2==1){width++;
if(height%2==1){height++;
if(progressListener.isCanceled()){thrownewProcessException("Bailingoutduetoprogresscancellation");
if(imageinstanceofBufferedImage){frame=(BufferedImage)image;
else{frame=PlanarImage.wrapRenderedImage(image).getAsBufferedImage();
if(parsedTimeinstanceofDate){mapTime=formatter.format(((Date)parsedTime).toInstant());
else
if(parsedTimeinstanceofDateRange){DateRangerange=(DateRange)parsedTime;mapTime=formatter.format(range.getMinValue().toInstant())+"/"+formatter.format(range.getMinValue().toInstant());
else{thrownewWPSException("Unexpectedparseddatetype:"+parsedTime);
if(fps<0){thrownewWPSException("Framespersecondmustbegreaterthanzero");
if(objectinstanceofGeometry){Geometryg=(Geometry)object;//super-lenient,justassumingdoublestorageandnoobjectoverheadreturn2*g.getNumPoints()*8;
if(repoName==null){repoName=repoModel.getObject().getRepoName();
if(repoModel!=null){repoModel.detach();
if(!epsgCode.startsWith("EPSG:")){thrownewIllegalStateException("EPSGcodedidn'tresolvetoaEPSG:XXXidentifier:"+epsgCode);
if(bounds.isNull()){thrownewIllegalArgumentException("Boundscan'tbenull");
if(bounds.getWidth()<=0||bounds.getHeight()<=0){thrownewIllegalArgumentException("Boundscan'tbeempty.Witdh:"+bounds.getWidth()+".Height:"+bounds.getHeight());
if(info.isResolutionsPreserved()){resolutions=resolutions(levels);scaleDenoms=null;
else{resolutions=null;scaleDenoms=scaleDenominators(levels);
if(val==null){thrownewIllegalStateException(msg);
if(value==null||"".equals(value)){returnfalse;
else{returnGeoServerApplication.get().getCatalog().getLayerByName(value)!=null;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;DismissTypeother=(DismissType)obj;
if(baseUrl==null){
if(other.baseUrl!=null)returnfalse;
else
if(!baseUrl.equals(other.baseUrl))returnfalse;
if(executionId==null){
if(other.executionId!=null)returnfalse;
else
if(!executionId.equals(other.executionId))returnfalse;
if(service==null){
if(other.service!=null)returnfalse;
else
if(!service.equals(other.service))returnfalse;
if(version==null){
if(other.version!=null)returnfalse;
else
if(!version.equals(other.version))returnfalse;returntrue;}}
if(modifiedSince!=null){request.addHeader("If-Modified-Since",modifiedSince);
ifthepanelistoinheritfromaparentmodel(iea*CompoundPropertyModel).IfnosuchmodelisavailabletheCRSwillbeleftuninitialized.To*avoidinheritingfromaparentmodeltheconstructor{@link#CRSPanel(String,IModel)}should*beused,specifyingexplicitlyanuninitializedmodel.**@paramidThecomponentid.*/publicCRSPanel(Stringid){super(id);initComponents();
if(crs!=null){setModelObject(crs);wktLabel.setDefaultModelObject(crs.getName().toString());wktLink.setEnabled(true);
else{wktLabel.setDefaultModelObject(null);wktLink.setEnabled(false);
if(crs!=null)popupWindow.setTitle(crs.getName().toString());popupWindow.show(target);
if(crs!=null){srsTextField.setModelObject(toSRS(crs));wktLabel.setDefaultModelObject(crs.getName().toString());
else{wktLabel.setDefaultModelObject(null);wktLink.setEnabled(false);
if(srs!=null&&!"".equals(srs)){
if("UNKNOWN".equals(srs)){//leaveunderlyingcrsunchanged
if(getModelObject()instanceofCoordinateReferenceSystem){setConvertedInput(getModelObject());
if(readOnly)srsTextField.add(READ_ONLY);
elsesrsTextField.remove(READ_ONLY);findLink.setVisible(!readOnly);returnthis;
if(crs!=null){IntegerepsgCode=CRS.lookupEpsgCode(crs,false);returnepsgCode!=null?"EPSG:"+epsgCode:"UNKNOWN";
else{return"UNKNOWN";
if(crs!=null){wktLabel.setDefaultModelObject(crs.getName().toString());wktLink.setEnabled(true);
else{wktLabel.setDefaultModelObject(null);wktLink.setEnabled(false);
if(crs!=null){wktLabel.setDefaultModel(newModel<String>(crs.toString()));
iffounditisreturned,
ifnotfoundthegetterisforwardedtotheunderlying*proxyobjectbeingcalled.**<p>Anycollectionshandledthroughthisinterfaceareclonedandclientcodeobtainsacopy.The*twocollectionswillbesyncedonacallto{@link#commit()}.**@authorJustinDeoliveira,TheOpenPlanningProject*<p>TODO:thisclassshoulduseBeanUtilsforallreflectionstuff*/publicclassModificationProxyimplementsWrappingProxy,Serializable{/**theproxyobject*/ObjectproxyObject;/**reflectionhelper*/transientClassPropertiescp;/**"dirty"properties*/HashMap<String,Object>properties;/***Theoldvaluesofthelivecollections(wehavetoclonethembecauseoncetheproxycommits*theoriginalmapwillcontainthesamevaluesasthenewone,breakinggetOldValues()*/HashMap<String,Object>oldCollectionValues;publicModificationProxy(ObjectproxyObject){this.proxyObject=proxyObject;
if(cp==null){this.cp=OwsUtils.getClassProperties(proxyObject.getClass());
if((method.getName().startsWith("get")||method.getName().startsWith("is"))&&method.getParameterCount()==0){//interceptgettertocheckthedirtypropertysetproperty=method.getName().substring(method.getName().startsWith("get")?3:2);
if(properties!=null&&properties().containsKey(property)){//returnthepreviouslysetobjectreturnproperties().get(property);
else{//
ifcollection,createawrapper
if(Collection.class.isAssignableFrom(method.getReturnType())){Collectionreal=(Collection)method.invoke(proxyObject,null);
if(real==null){//inthiscasethereisnothingwecandoreturnnull;
else
if(Map.class.isAssignableFrom(method.getReturnType())){Mapreal=(Map)method.invoke(proxyObject,null);
if(real==null){//inthiscasethereisnothingwecandoreturnnull;
else{//proceedwiththeinvocation
if(method.getName().startsWith("set")&&args.length==1){//interceptsetterandputnewvalueinlistproperty=method.getName().substring(3);properties().put(property,args[0]);returnnull;
if(resultinstanceofProxy&&Proxy.getInvocationHandler(result)instanceofResolvingProxy){ResolvingProxyrp=ProxyUtils.handler(result,ResolvingProxy.class);//trytoresolve,andreturnnull
ifthereferenceisdanglingfinalCatalogcatalog=(Catalog)GeoServerExtensions.bean("catalog");result=rp.resolve(catalog,result);
ifitisanotherInfoobject
if(result!=null&&shouldProxyProperty(result.getClass())){//avoiddoubleproxyObjecto=ModificationProxy.unwrap(result);
if(o==result){result=ModificationProxy.create(result,(Class)method.getReturnType());//cachetheproxy,incaseitismodifieditselfproperties().put(property,result);
else{//resultwasalreadyproxied,leaveasis
if(Collection.class.isAssignableFrom(g.getReturnType())){Collectionc=(Collection)g.invoke(proxyObject,null);c.clear();for(Objecto:(Collection)v){c.add(unwrap(o));
else
if(Map.class.isAssignableFrom(g.getReturnType())){Mapproxied=(Map)v;Mapm=(Map)g.invoke(proxyObject,null);m.clear();for(Objectkey:proxied.keySet()){Objectuk=unwrap(key);finalObjectvalue=proxied.get(key);Objectuv=unwrap(value);m.put(uk,uv);
else{Methods=setter(p,g.getReturnType());
if(Info.class.isAssignableFrom(g.getReturnType())){//anotherinfoisthechangedproperty,itcouldbeoneoftwocases//1)theinfoobjectwaschangedinplace:x.getY().setFoo(...)//2)anewinfoobjectwassetx.setY(...)Infooriginal=(Info)g.invoke(proxyObject,null);Infomodified=(Info)unwrap(v);
if(original==modified){//case1,inthiscasegettheproxyandcommitit
if(vinstanceofProxy){ModificationProxyh=handler(v);
if(h!=null&&h.isDirty()){h.commit();
else
if(s!=null){//case2,justcallthesetterwiththenewobjects.invoke(proxyObject,v);
else{thrownewIllegalStateException("Newinfoobjectset,butnosetterforit.");
else{//callthesetters.invoke(proxyObject,v);
ifapropertyofaproxiedobjectshouldalsobeproxied.*/booleanshouldProxyProperty(ClasspropertyType){
if(Catalog.class.isAssignableFrom(propertyType)){//neverproxythecatalogreturnfalse;
if(properties!=null){returnproperties;
if(properties!=null){returnproperties;
if(oldCollectionValues!=null){returnoldCollectionValues;
if(oldCollectionValues!=null){returnoldCollectionValues;
if(e.getValue()instanceofProxy){ModificationProxyh=handler(e.getValue());
if(h!=null&&!h.isDirty()){continue;
else{try{Objectorig=unwrap(getter((String)e.getKey()).invoke(proxyObject,null));
if(orig==null){
if(e.getValue()==null){continue;
else
if(e.getValue()!=null&&orig.equals(e.getValue())){continue;
if(valueinstanceofProxy){ModificationProxyh=handler(value);
if(h!=null&&!h.isDirty()){//proxyreportsitisnotdirty,onlyreturnthisproperty
iftheunderling//valueisnotthesameasthecurrentvalueofthepropertyontheobjectObjectcurr=unwrap(value);try{Objectorig=unwrap(getter(propertyName).invoke(proxyObject,null));
if(curr==orig){continue;
if(oldCollectionValues().containsKey(propertyName)){oldValues.add(oldCollectionValues.get(propertyName));
else{try{Methodg=getter(propertyName);
if(g==null){thrownewIllegalArgumentException("Nosuchproperty:"+propertyName);
if(g==null){g=cp().getter(propertyName,null);
if(proxyObjectinstanceofCatalogInfo){CatalogInforeplacement=replaceCatalogInfo((CatalogInfo)proxyObject);
if(replacement!=null){proxyObject=unwrap(replacement);
if(properties!=null){for(Entry<String,Object>property:properties.entrySet()){Objectvalue=property.getValue();
if(valueinstanceofCatalogInfo){CatalogInforeplacement=replaceCatalogInfo((CatalogInfo)value);
if(replacement!=null){property.setValue(unwrap(replacement));
else
if(valueinstanceofCollection){Collectionclone=cloneCollection((Collection)value);property.setValue(clone);
else
if(valueinstanceofMetadataMap){MetadataMapclone=cloneMetadataMap((MetadataMap)value);property.setValue(clone);
if(oldCollectionValues!=null){for(Entry<String,Object>oce:oldCollectionValues.entrySet()){Objectvalue=oce.getValue();
if(valueinstanceofCollection){CollectionoldCollection=(Collection)value;Collectionclone=cloneCollection(oldCollection);oce.setValue(clone);
else
if(valueinstanceofMetadataMap){MetadataMapclone=cloneMetadataMap((MetadataMap)value);oce.setValue(clone);
if(valueinstanceofCatalogInfo){CatalogInforeplacement=replaceCatalogInfo((CatalogInfo)value);
if(replacement!=null){value=replacement;
if(oinstanceofCatalogInfo){CatalogInforeplacement=replaceCatalogInfo((CatalogInfo)o);
if(replacement!=null){clone.add(unwrap(replacement));
else{clone.add(o);
else{clone.add(o);
if(result.isAssignableFrom(c)){result=c;
iftheobjectpassedinisnotaproxyitissimplyreturned.*Iftheproxyisnotaninstanceof{@linkModificationProxy}itisalsoreturneduntouched.*/publicstatic<T>Tunwrap(Tobject){returnProxyUtils.unwrap(object,ModificationProxy.class);
if(Objects.isNull(oldHandler)){returninnerWrap.apply(object);
else{TnewProxyObject=innerWrap.apply((T)oldHandler.getProxyObject());TnewProxy=create(newProxyObject,clazz);//CopytheoldstateontothenewproxyModificationProxynewHandler=handler(newProxy);
if(Objects.nonNull(oldHandler.oldCollectionValues)){newHandler.oldCollectionValues=newHashMap<String,Object>(oldHandler.oldCollectionValues);
if(Objects.nonNull(oldHandler.properties)){newHandler.properties=newHashMap<String,Object>(oldHandler.properties);
ifaclientspecifiesalocalworkspacethenthey*shouldnothavetonamespacequalifyeverylayerorfeaturetypename.Asubclassofthis*callbackcandothatautomatically.**@authorJustinDeoliveira,OpenGeo*/publicabstractclassWorkspaceQualifyingCallbackimplementsDispatcherCallback{protectedCatalogcatalog;protectedWorkspaceQualifyingCallback(Catalogcatalog){this.catalog=catalog;
if(LocalWorkspace.get()!=null){qualifyRequest(LocalWorkspace.get(),LocalPublished.get(),service,request);
if(LocalWorkspace.get()!=null){qualifyRequest(LocalWorkspace.get(),LocalPublished.get(),operation,request);
if(colon==-1){name=ws.getName()+":"+name;
else{Stringprefix=name.substring(0,colon);
if(!prefix.equalsIgnoreCase(ws.getName())){name=ws.getName()+":"+name.substring(colon+1);
iftheblobstorewillsetandusethetilecreationtimeadd(newCheckBox("useCreateTime").add(newAttributeModifier("useCreateTime",newResourceModel("useCreateTime"))));}}
if(request.getVersion()==null||request.getVersion().length()==0){Stringversion=(String)rawKvp.get("WMTVER");
if(version==null){version=wms.getVersion();
if(language!=null){request.setLocale(newLocale(language));
if(!GetLegendGraphicRequest.SLD_VERSION.equals(version)){//thrownewWmsException("InvalidSLDversionnumber\""+version//+"\"");//
if(strict&&layer==null){thrownewServiceException("LAYERparameternotpresentforGetLegendGraphic","LayerNotDefined");
if(strict&&request.getFormat()==null){thrownewServiceException("MissingFORMATparameterforGetLegendGraphic","MissingFormat");
ifalayergroupisrequested)List<LegendRequest>layers=newArrayList<LegendRequest>();
if(layer!=null){try{LayerInfolayerInfo=wms.getLayerByName(layer);
if(layerInfo!=null){//layerfound,fillinLegendRequestdetailsLegendRequestlegend=addLayer(layerInfo,request);legend.setLayer(layer);layers.add(legend);infoObject=layerInfo;
else{//checkforlayergroup,andaddeachlayerLayerGroupInfolayerGroupInfo=wms.getLayerGroupByName(layer);
if(layerGroupInfo!=null){//addallsinglelayersofthegroupfor(LayerInfosingleLayer:layerGroupInfo.layers()){LegendRequestlegend=addLayer(singleLayer,request);legend.setLayerGroupInfo(layerGroupInfo);layers.add(legend);
else{thrownewServiceException(layer+"layerdoesnotexist.");
else{//Assumethisis"just"arequestforalegendgraphicrepresentingforastyle(no//infoObjectforcontext)LegendRequeststyleLegend=request.newLegendRequest();layers.add(styleLegend);
if(request.getFormat()==null){request.setFormat(GetLegendGraphicRequest.DEFAULT_FORMAT);
if(null==wms.getLegendGraphicOutputFormat(request.getFormat())){thrownewServiceException(newStringBuffer("Invalidgraphicformat:").append(request.getFormat()).toString(),"InvalidFormat");
if(request.getLayers().size()!=request.getStyles().size()){Stringmsg=layers.size()+"layersrequested,butfound"+request.getStyles().size()+"stylesspecified.";thrownewServiceException(msg,getClass().getName());
if(request.getRules().size()>0&&layers.size()!=request.getRules().size()){Stringmsg=layers.size()+"layersrequested,butfound"+request.getRules().size()+"rulesspecified.";thrownewServiceException(msg,getClass().getName());
ifavailable.**@paramlayerInfoThelayerdescription*@paramreqTheGetLegendGrapicRequestusedforcontext*@returncreatedLegendRequest*@throwsFactoryRegistryException*@throwsIOException*@throwsTransformException*@throwsSchemaException*/privateLegendRequestaddLayer(LayerInfolayerInfo,GetLegendGraphicRequestrequest)throwsFactoryRegistryException,IOException,TransformException,SchemaException{FeatureTypefeatureType=getLayerFeatureType(layerInfo);
if(featureType!=null){LegendRequestlegend=request.newLegendRequest(featureType);legend.setLayerInfo(layerInfo);MapLayerInfomli=newMapLayerInfo(layerInfo);//TemporaryMapLayerInfousedtomapatitle,
iflabelisdefinedonlayer
if(mli.getLabel()!=null){legend.setTitle(mli.getLabel());
if(legendInfo!=null){configureLegendInfo(request,legend,legendInfo);
else{thrownewServiceException("CannotgetFeatureTypeforLayer","MissingFeatureType");
ifnotspecifiedontheoriginalrequest.**@paramrequestGetLegendGraphicRequestoriginalKWPRequest*@paramlegendLegendRequestinternalClasscontainingreferencestoResources*@paramlegendInfoLegendInfousedtodocumentuseexternalgraphic*/privatevoidconfigureLegendInfo(GetLegendGraphicRequestrequest,LegendRequestlegend,LegendInfolegendInfo){legend.setLegendInfo(legendInfo);
if(legendInfo.getHeight()>0&&!request.getKvp().containsKey("HEIGHT")){request.setHeight(legendInfo.getHeight());
if(legendInfo.getWidth()>0&&!request.getKvp().containsKey("WIDTH")){request.setWidth(legendInfo.getWidth());
if(legendInfo==null){returnnull;//notavailable
if(onlineResource==null){returnnull;
if(uri.isAbsolute()){
if(baseUrl!=null&&onlineResource.startsWith(baseUrl+"styles/")){//convertrelativetostylesdurectoryonlineResource=onlineResource.substring(baseUrl.length()+7);
else{returnlegendInfo;//anactualexternalgraphicreference
else{//notabsolute,tryrelativetothestyle
ifavailable,otherwisesearch//inthestylesdirectory
if(context!=null){GeoServerDataDirectorydd=newGeoServerDataDirectory(resources);ResourcestyleParentResource=dd.get(context);
if(styleParentResource!=null&&styleParentResource.getType()==Resource.Type.DIRECTORY){url=URLs.fileToUrl(newFile(styleParentResource.dir(),onlineResource));
if(url==null){Filestyles=resources.findOrCreateDirectory("styles");URLbase=URLs.fileToUrl(styles);url=newURL(base,onlineResource);
if(layerInfo.getType()==PublishedType.VECTOR){FeatureTypefeatureType=mli.getFeature().getFeatureType();returnfeatureType;
else
if(layerInfo.getType()==PublishedType.RASTER){CoverageInfocoverageInfo=mli.getCoverage();//itmuchsafertowrapareaderratherthanacoverageinmostcases,OOMcan//occurotherwisefinalGridCoverage2DReaderreader;reader=(GridCoverage2DReader)coverageInfo.getGridCoverageReader(newNullProgressListener(),GeoTools.getDefaultHints());finalSimpleFeatureCollectionfeature;feature=FeatureUtilities.wrapGridCoverageReader(reader,null);returnfeature.getSchema();
if(listOfStyles==null){listOfStyles="";
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(newStringBuffer("lookingforstyles").append(listOfStyles).toString());
if(sldUrl!=null){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("takingstylefromSLDparameter");
else
if(sldBody!=null){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("takingstylefromSLD_BODYparameter");
else
if(styleNames.size()>0){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("takingstylefromSTYLEparameter");
ifwehavealayergroupandnostyleisspecified//usethedefaultoneforthelayerinthecurrentposition
if(styleName.equals("")&&infoObjinstanceofLayerGroupInfo){LayerGroupInfolayerGroupInfo=(LayerGroupInfo)infoObj;List<LayerInfo>groupLayers=layerGroupInfo.layers();
if(pos<groupLayers.size()){sldStyles.add(getStyleFromLayer(groupLayers.get(pos)));
else{sldStyles.add(wms.getStyleByName(styleName));
if(infoObjinstanceofLayerInfo){StyleInfostyleInfo=wms.getCatalog().getStyleByName(styleName);
if(styleInfo!=null){LegendInfolegend=resolveLegendInfo(styleInfo.getLegend(),req,styleInfo);
if(legend!=null){LayerInfolayerInfo=(LayerInfo)infoObj;Namename=layerInfo.getResource().getQualifiedName();LegendRequestlegendRequest=req.getLegend(name);
if(legendRequest!=null){configureLegendInfo(req,legendRequest,legend);
else{LOGGER.log(Level.FINE,"UnabletosetLegendInfofor"+name);
else{
if(infoObjinstanceofLayerInfo){LayerInfolayerInfo=(LayerInfo)infoObj;sldStyles.add(getStyleFromLayer(layerInfo));StyleInfodefaultStyle=layerInfo.getDefaultStyle();LegendInfolegend=resolveLegendInfo(defaultStyle.getLegend(),req,defaultStyle);
if(legend!=null){Namename=layerInfo.getResource().getQualifiedName();LegendRequestlegendRequest=req.getLegend(name);
if(legendRequest!=null){configureLegendInfo(req,legendRequest,legend);
else{LOGGER.log(Level.FINE,"UnabletosetLegendInfofor"+name);
else
if(infoObjinstanceofLayerGroupInfo){LayerGroupInfolayerGroupInfo=(LayerGroupInfo)infoObj;List<LayerInfo>groupLayers=layerGroupInfo.layers();List<StyleInfo>groupStyles=layerGroupInfo.styles();for(intcount=0;count<groupLayers.size();count++){LayerInfolayerInfo=groupLayers.get(count);StyleInfostyleInfo=null;
if(count<groupStyles.size()&&groupStyles.get(count)!=null){styleInfo=groupStyles.get(count);sldStyles.add(styleInfo.getStyle());
else{sldStyles.add(getStyleFromLayer(layerInfo));styleInfo=layerInfo.getDefaultStyle();
if(legend!=null){Namename=layerInfo.getResource().getQualifiedName();LegendRequestlegendRequest=req.getLegend(name);
if(legendRequest!=null){configureLegendInfo(req,legendRequest,legend);
else{LOGGER.log(Level.FINE,"UnabletosetLegendInfofor"+name);
if(rule!=null){List<String>ruleNames=KvpUtils.readFlat(rule);req.setRules(ruleNames);
if(styleNames.size()==0){sldStyles.add(findStyle(null,source));
else{for(StringstyleName:styleNames){sldStyles.add(findStyle(styleName,source));
ifnostylenamed<code>styleName</code>isfoundin<code>*styles</code>*/privateStylefindStyle(StringstyleName,Style[]styles)throwsNoSuchElementException{
if((styles==null)||(styles.length==0)){thrownewNoSuchElementException("Nostyleshavebeenprovidedtosearchfor"+styleName);
if(styleName==null){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("styleNameisnull,requestinliteralmode,returningfirststyle");
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer(newStringBuffer("requestinlibrarymode,lookingforstyle").append(styleName).toString());
if((styles[i]!=null)&&styleName.equals(styles[i].getName())){returnstyles[i];
if(i<styles.length){noMatchNames.append(",");
if<code>sldUrl</code>isnotavalidURL,astreamcan'tbeopenedora*parsingerroroccurs*/privateStyle[]loadRemoteStyle(StringsldUrl)throwsServiceException{InputStreamin;try{URLurl=newURL(sldUrl);in=url.openStream();
ifaparsingerroroccurs.*/privateStyle[]parseSldBody(StringsldBody)throwsServiceException{//returnparseSld(newStringBufferInputStream(sldBody));returnparseSld(newStringReader(sldBody));
ifaparsingerroroccurs*/privateStyle[]parseSld(ReaderxmlIn)throwsServiceException{SLDParserparser=newSLDParser(styleFactory,xmlIn);EntityResolverentityResolver=wms.getCatalog().getResourcePool().getEntityResolver();
if(entityResolver!=null){parser.setEntityResolver(entityResolver);
if((styles==null)||(styles.length==0)){thrownewServiceException("Documentcontainsnostyles");
if(cacheSize>0){gs.getCatalog().getResourcePool().setFeatureTypeCacheSize(cacheSize);
if(i>-1){NumberfeatureTypeCacheSize=(Number)newValues.get(i);gs.getCatalog().getResourcePool().setFeatureTypeCacheSize(featureTypeCacheSize.intValue());
if(request.getContext()!=null){//
ifaqualifyingworkspaceexist,trytoqualifytherequesttypename//parameter,
ifpresent
if(workspace!=null&&request.getKvp().containsKey("TYPENAME")){IterabletypeNames=(Iterable)request.getKvp().get("TYPENAME");NamespaceInfons=catalog.getNamespaceByPrefix(workspace.getName());
if(ns!=null){List<QName>qualifiedNames=newArrayList<QName>();for(Objectname:typeNames){
if(name!=null&&nameinstanceofQName){QNametypeName=(QName)name;//nonamespacespecified,wecanqualify
if(typeName.getNamespaceURI()==null||typeName.getNamespaceURI().equals("")){typeName=newQName(ns.getURI(),typeName.getLocalPart());
else
if(typeName.getNamespaceURI().equals(catalog.getDefaultNamespace().getURI())||!typeName.getNamespaceURI().equals(ns.getURI())){//morecomplexcase,
ifwehavethedefault//namespace,wehavetocheck
ifit'sbeen//specifiedontherequest,orassignedbyparsertypeName=checkOriginallyUnqualified(request,ns,typeName);
ifthetypeNamedefaultnamespaceispresentintheoriginalrequest,orithasbeen*overriddenbyparser.Ifit'sbeenoverriddenwecanqualifywiththegivennamespace.**@paramrequest*@paramns*@paramtypeName*/privateQNamecheckOriginallyUnqualified(Requestrequest,NamespaceInfons,QNametypeName){Map<String,String[]>originalParams=request.getHttpRequest().getParameterMap();for(StringparamName:originalParams.keySet()){
if(paramName.equalsIgnoreCase("TYPENAME")){for(StringoriginalTypeName:originalParams.get(paramName)){
if(originalTypeName.equals(typeName.getLocalPart())){//theoriginaltypeNamewasnot//qualified,wecanqualifyittypeName=newQName(ns.getURI(),typeName.getLocalPart());
if(caps!=null){caps.setNamespace(workspace.getName());return;
if(dft!=null){qualifyTypeNames(dft.getTypeNames(),workspace,ns);return;
if(gf!=null){for(Queryq:gf.getQueries()){//incaseofstoredqueryusagethetypenamesmightbenull
if(q.getTypeNames()!=null){qualifyTypeNames(q.getTypeNames(),workspace,ns);
if(lf!=null){for(Locklock:lf.getLocks()){lock.setTypeName(qualifyTypeName(lock.getTypeName(),workspace,ns));
if(t!=null){for(TransactionElementel:t.getElements()){
if(elinstanceofInsert){Insertin=(Insert)el;//intheinsertcasetheobjectsaregtfeaturetypeswhicharenotmutable//sowejustcheckthemandthrowanexception
ifanamedoesnotmatchListfeatures=in.getFeatures();ensureFeatureNamespaceUriMatches(features,ns,t);
else
if(elinstanceofReplace){Replacerep=(Replace)el;//inthereplacecasetheobjectsaregtfeaturetypeswhicharenotmutable//sowejustcheckthemandthrowanexception
ifanamedoesnotmatchListfeatures=rep.getFeatures();ensureFeatureNamespaceUriMatches(features,ns,t);
else{el.setTypeName(qualifyTypeName(el.getTypeName(),workspace,ns));
if(nextinstanceofFeature){Featuref=(Feature)next;Namen=f.getType().getName();
if(n.getNamespaceURI()!=null&&!ns.getURI().equals(n.getNamespaceURI())){thrownewWFSException(t,"Nosuchfeaturetype"+n);
if(names!=null){for(inti=0;i<names.size();i++){QNamename=(QName)names.get(i);names.set(i,qualifyTypeName(name,ws,ns));
if(name!=null){returnnewQName(ns.getURI(),name.getLocalPart(),ws.getName());
if(roi==null){thrownewNullPointerException("TheprovidedROIisnull!");
if(roiinstanceofPoint||roiinstanceofMultiPoint||roiinstanceofLineString||roiinstanceofMultiLineString){thrownewIllegalStateException("TheRegionofInterestisnotaPolygonorMultipolygon!");
if(roi.isEmpty()||!roi.isValid()){thrownewIllegalStateException("TheRegionofInterestisempytorinvalid!");
if(lenient){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Lenientapproachused");
if(p.type.isEnum()){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"TryingtofindthePPIOfortheEnum="+p.type);
if(all.isEmpty()){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"NoPPIOfoundfortheparameter"+p.getName());
if(mime!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"TryingtosearchforaPPIOfortheparameter"+p.getName());
if(ppioinstanceofComplexPPIO&&((ComplexPPIO)ppio).getMimeType().equals(mime)){returnppio;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"UnabletofindaPPIOfortheparameter"+p.getName());
iftheprovided{@linkFeatureCollection}isemptyornot.**<p>Incasetheprovidedfeaturecollectionisemptyitthrowsan{@link*IllegalStateException};**@paramfeaturesthe{@linkSimpleFeatureCollection}tocheck*@throwsIllegalStateException*/staticfinalvoidcheckIsEmptyFeatureCollection(SimpleFeatureCollectionfeatures)throwsIllegalStateException{
if(features==null||features.isEmpty()){thrownewIllegalStateException("Gotanemptyfeaturecollection.");
if(pp==null||pp==ProjectionPolicy.FORCE_DECLARED){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"PropjectionPolicynullorFORCE_DECLARED");
else{returnresourceInfo.getNativeCRS();
if(!CRS.equalsIgnoreMetadata(geometryCRS,crs)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"GeometryCRSisnotequaltothetargetCRS,wemighthavetoreproject");
if(!targetTX.isIdentity()){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"CRStransformisnotanidentity,wehavetoreprojecttheGeometry");
if(geometry==null){thrownewIllegalStateException("TheRegionofInterestisnullaftergoingbacktonativeCRS!");
ifthegeometryisaPolygonorMultiPolygon
if(styleFile!=null&&styleFile.getType()==Resource.Type.RESOURCE&&Resources.canRead(styleFile)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Style"+style.getName()+"found");
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Style"+style.getName()+"notfound.Tryingtosearchinthelayerworkspace");
if(styleFile!=null&&styleFile.getType()==Resource.Type.RESOURCE&&Resources.canRead(styleFile)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Thestylefilecannotbefoundanywhere.WeneedtoskiptheSLDfile");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Searchingfordefaultstyle");
if(layerInfo.getStyles()!=null){styles.addAll(layerInfo.getStyles());
if(styleFile!=null){styleFiles.add(styleFile);
ifspecifiedforaspecificOWSuseoftheWGS84BoundingBoxType.Formoreinformation,seeSubclauses10.4.5andC.13.&lt;/documentation&gt;*&lt;/annotation&gt;*&lt;restrictionbase="ows:PositionType"&gt;*&lt;lengthvalue="2"/&gt;*&lt;/restriction&gt;*&lt;/simpleType&gt;**</code>*</pre>**@generated*/publicclassPositionType2DBindingextendsAbstractSimpleBinding{Ows10Factoryowsfactory;publicPositionType2DBinding(Ows10Factoryowsfactory){this.owsfactory=owsfactory;
if((buffer==null)||(response==null)){return;//shouldwethrowanExceptionhere
if(buildingsStyle==null){//undotherenameperformedinoneofthetestmethodsStyleInfosi=catalog.getStyleByName("BuildingsNew");
if(si!=null){si.setName(MockData.BUILDINGS.getLocalPart());catalog.save(si);
if(ds==null){CatalogBuildercb=newCatalogBuilder(catalog);cb.setWorkspace(catalog.getWorkspaceByName("sf"));ds=cb.buildDataStore("unstore");catalog.add(ds);FeatureTypeInfoft=catalog.getFactory().createFeatureType();ft.setName("unlayer");ft.setStore(catalog.getStoreByName("unstore",DataStoreInfo.class));ft.setCatalog(catalog);ft.setNamespace(catalog.getNamespaceByPrefix("sf"));ft.setSRS("EPSG:4326");CoordinateReferenceSystemwgs84=CRS.decode("EPSG:4326");ft.setNativeCRS(wgs84);ft.setLatLonBoundingBox(newReferencedEnvelope(-110,0,-60,50,wgs84));ft.setProjectionPolicy(ProjectionPolicy.FORCE_DECLARED);catalog.add(ft);LayerInfoftl=catalog.getFactory().createLayer();ftl.setResource(ft);ftl.setDefaultStyle(getCatalog().getStyleByName("Default"));catalog.add(ftl);
if(wms==null){CatalogBuildercb=newCatalogBuilder(catalog);cb.setWorkspace(catalog.getWorkspaceByName("sf"));wms=cb.buildWMSStore("wmsstore");wms.setCapabilitiesURL("http://demo.opengeo.org/geoserver/wms?");catalog.add(wms);WMSLayerInfowmr=catalog.getFactory().createWMSLayer();wmr.setName("states");wmr.setNativeName("topp:states");wmr.setStore(catalog.getStoreByName("wmsstore",WMSStoreInfo.class));wmr.setCatalog(catalog);wmr.setNamespace(catalog.getNamespaceByPrefix("sf"));wmr.setSRS("EPSG:4326");CoordinateReferenceSystemwgs84=CRS.decode("EPSG:4326");wmr.setNativeCRS(wgs84);wmr.setLatLonBoundingBox(newReferencedEnvelope(-110,0,-60,50,wgs84));wmr.setProjectionPolicy(ProjectionPolicy.FORCE_DECLARED);catalog.add(wmr);LayerInfowml=catalog.getFactory().createLayer();wml.setResource(wmr);wml.setDefaultStyle(getCatalog().getStyleByName("Default"));catalog.add(wml);
ifthelegendhas*invalidvaluesatthetime,andthencontinuetosavethestyle.*/@TestpublicvoidtestDiscardLegendWithBadValues()throwsIOException,URISyntaxException{tester.executeAjaxEvent("styleForm:context:panel:legendPanel:externalGraphicContainer:showhide:show","click");//Makesurethefieldsweareeditingactuallyexisttester.assertComponent("styleForm:context:panel:legendPanel:externalGraphicContainer:list:onlineResource",TextField.class);tester.assertComponent("styleForm:context:panel:legendPanel:externalGraphicContainer:list:width",TextField.class);tester.assertComponent("styleForm:context:panel:legendPanel:externalGraphicContainer:list:height",TextField.class);tester.assertComponent("styleForm:context:panel:legendPanel:externalGraphicContainer:list:format",TextField.class);//SetsomebadvaluesforthelegendFormTesterform=tester.newFormTester("styleForm",false);form.setValue("context:panel:legendPanel:externalGraphicContainer:list:onlineResource","missing.ong");form.setValue("context:panel:legendPanel:externalGraphicContainer:list:width","-100");form.setValue("context:panel:legendPanel:externalGraphicContainer:list:height","");form.setValue("context:panel:legendPanel:externalGraphicContainer:list:format","bad/value");//Hidethelegendpanel(="DiscardLegend")tester.executeAjaxEvent("styleForm:context:panel:legendPanel:externalGraphicContainer:showhide:hide","click");//RefreshthestateoftheFormTesteraftertheexecuteAjaxEventform=tester.newFormTester("styleForm",false);//Submittheform.(Thebadlegendvaluesshouldnolongerbeset).form.submit();tester.assertNoErrorMessage();StyleInfostyle=getCatalog().getStyleByName(MockData.BUILDINGS.getLocalPart());assertNotNull(style);assertNull(style.getLegend());
if((cinfo.getProjectionPolicy()==ProjectionPolicy.NONE)||(cinfo.getProjectionPolicy()==ProjectionPolicy.REPROJECT_TO_DECLARED)){targetCRS=cinfo.getNativeCRS();
else{targetCRS=cinfo.getCRS();
if(requestedCRS!=null&&requestedCRSinstanceofGeographicCRS){//forconsistency,thetransformationisexactlythesameasbelowwhenpreparing//therequest,butintheinversedirection(coverage(target)CRStorequestedCRS)//coveragemedianpositiontransformedintotherequestedCRSTransformedDirectPositioncoverageMedianPosition=newTransformedDirectPosition(targetCRS,requestedCRS,newHints(Hints.LENIENT_DATUM_SHIFT,Boolean.TRUE));try{coverageMedianPosition.transform(targetCoverageMedianPosition);
if(CRS.getAxisOrder(requestedCRS)==CRS.AxisOrder.NORTH_EAST){//yandsecondordinatearelongitudey+=360*Math.round((coverageMedianPosition.getOrdinate(1)-y)/360);
else{//xandfirstordinatearelongitudex+=360*Math.round((coverageMedianPosition.getOrdinate(0)-x)/360);
if(requestedCRS!=null){finalTransformedDirectPositionarbitraryToInternal=newTransformedDirectPosition(requestedCRS,targetCRS,newHints(Hints.LENIENT_DATUM_SHIFT,Boolean.TRUE));try{arbitraryToInternal.transform(position);
if(targetCRS!=null&&targetCRSinstanceofGeographicCRS){x=position.getOrdinate(0);y=position.getOrdinate(1);
if(CRS.getAxisOrder(targetCRS)==CRS.AxisOrder.NORTH_EAST){//yandsecondordinatearelongitudey+=360*Math.round((targetCoverageMedianPosition.getOrdinate(1)-y)/360);
else{//xandfirstordinatearelongitudex+=360*Math.round((targetCoverageMedianPosition.getOrdinate(0)-x)/360);
if(!reader.getOriginalEnvelope().contains(position)){returnnull;
iftherequestiswellformed.
if(integerRasterArea.isEmpty()){returnnull;
if(!(parameters[k]instanceofParameter<?>)){continue;
if(name.equals(AbstractGridFormat.READ_GRIDGEOMETRY2D.getName())){////createasuitablegeometryforthisrequestreusingthegetmap(we//couldprobablyoptimize)//parameter.setValue(newGridGeometry2D(newGridEnvelope2D(integerRasterArea),reader.getOriginalGridToWorld(PixelInCell.CELL_CENTER),reader.getCoordinateReferenceSystem()));
else
if(propertyNames!=null&&propertyNames.length>0&&name.equals(AbstractGridFormat.BANDS.getName())){int[]bands=newint[propertyNames.length];Set<String>requestedNames=newHashSet<>(Arrays.asList(propertyNames));List<String>dimensionNames=cinfo.getDimensions().stream().map(d->d.getName()).collect(Collectors.toList());for(inti=0,j=0;i<dimensionNames.size()&&!requestedNames.isEmpty();i++){StringdimensionName=dimensionNames.get(i);
if(requestedNames.remove(dimensionName)){bands[j++]=i;
if(!requestedNames.isEmpty()){StringavailableNames=dimensionNames.stream().collect(Collectors.joining(","));thrownewServiceException("Couldnotfindthefollowingrequestedproperties"+requestedNames+",availablepropertynamesare"+availableNames,org.geoserver.platform.ServiceException.INVALID_PARAMETER_VALUE,"PropertyName");
if(coverage==null){
if(LOGGER.isLoggable(Level.FINE))LOGGER.fine("Unabletoloadrasterdataforthisrequest.");returnnull;
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
if(bandNames.contains(name)){//itmighthappenagainthatthenamealreadyexistsbutitprettydifficultI'd//sayname=newStringBuilder(name).append("_Band").append(i).toString();
if(description==null||description.length()==0){return"Unknown";
else{char[]result=description.toCharArray();for(inti=0;i<result.length;i++){
if((i==0&&!XMLChar.isNCNameStart(result[i]))||(i>0&&!XMLChar.isNCName(result[i]))){result[i]='_';
if(script==null){script=file!=null?newScript(file):null;
if(!Resources.exists(file)){file=null;
iftherequestwasprocessedsuccessfully,false
iftherequesttimedoutduring*thewait*/booleanrequestIncoming(Requestrequest,longtimeout);/***Calledwhentherequestisdoneitsprocessing(willbecalledbothforexecutingandtimeout*outrequeststoensureeventuallyrequiredcleanups)**@paramrequesttherequest*/voidrequestComplete(Requestrequest);/***Returnstheflowcontroller"priority",determinestheorderinwhichthecontrollersare*beingcalled,fromlowertohigher(nottobeconfusedwiththerequestpriority).For*controllersthatlimitthenumberofincomingrequestsbyusingablockingqueueitis*advisedtousethequeuesizeitselfasthecontrollerpriority.*/intgetPriority();}
if(!Resources.exists(file)){LOGGER.fine("Skipping"+file.name()+",nohookfound");
if(function==null){synchronized(this){function=functions.get(name);
if(function==null){ScriptManagerscriptMgr=scriptMgr();ResourcefilterRoot=scriptMgr.function();Resourcef=null;
if(name.getNamespaceURI()!=null){f=filterRoot.get(name.getLocalPart()+"."+name.getNamespaceURI());
else{//lookforafilebasedonbasenamefor(Resourcefile:filterRoot.list()){
if(name.getLocalPart().equals(getBaseName(file.name()))){f=file;break;
if(f==null){returnnull;
if(!Resources.exists(f)){LOGGER.log(Level.WARNING,"Filenotfound:"+f.path());returnnull;
ifthisbeanreceivedareferencetothe{@linkWMS}*facadeinsteadoflookingitupthrough{@linkGeoServerExtensions}but
ifso,unittestsbreak*whilesettingupthemockapplicationcontextwhen{@codeSecureCatalogImpl}'sconstructor*performsanextensionlookupwiththefollowingerror:<i>Errorcreatingbeanwithname'wms':*Requestedbeaniscurrentlyincreation:Isthereanunresolvablecircularreference?</i>**@authorGabrielRoldan*/publicclassSVGStrategyExclusionFilterimplementsExtensionFilter,ApplicationContextAware{privateStringwmsBeanName;privateWMSwms;privateApplicationContextctx;/***@paramwmsBeanNamenameofthebeanoftype{@linkWMS}tobelazilylookedupinthe*applicationcontext*/publicSVGStrategyExclusionFilter(finalStringwmsBeanName){this.wmsBeanName=wmsBeanName;
if{@codebean}isoneoftheSVGrenderingstrategiesbutnottheone*thatshallbeusedasper{@linkWMS#getSvgRenderer()}*@seeExtensionFilter#exclude(String,Object)*/publicbooleanexclude(StringbeanId,Objectbean){booleanexclude=false;/**LazylookupoftheWMSbeanisperformedherebecausethismethodisoftencalledwhile*theapplicationcontextisstillbeingbuilt*/
if(beaninstanceofSVGStreamingMapOutputFormat){exclude=!SVG.canHandle(getWMS(),WMS.SVG_SIMPLE);
else
if(beaninstanceofSVGBatikMapOutputFormat){exclude=!SVG.canHandle(getWMS(),WMS.SVG_BATIK);
if(wms==null){wms=(WMS)ctx.getBean(wmsBeanName);
if(internalHostname==null){synchronized(InternalHostname.class){
if(internalHostname==null){InetAddressaddr;try{addr=InetAddress.getLocalHost();internalHostname=addr.getHostName();
if(args.size()!=inputs.size()){thrownewRuntimeException(String.format("processfunctionspecified%dargumentsbut"+"describes%dinputs",args.size(),inputs.size()));
if(input==null){thrownewRuntimeException(String.format("processfunctionspecifiedargument%s"+"butdoesnotspecifyitasaninput",arg));
if(input.size()==3){PyDictionarymeta=(PyDictionary)input.get(2);min=getParameter(meta,"min",Integer.class,1);max=getParameter(meta,"max",Integer.class,1);List<String>options=getParameter(meta,"domain",List.class,null);
if(options!=null){metadata=newHashMap();metadata.put(Parameter.OPTIONS,options);
if(!otherKeys.isEmpty()){
if(metadata==null){metadata=newHashMap();
if(defaults!=null){//fromthepythonguide://defaultsisatupleofdefaultargumentvaluesorNone
ifthereareno//defaultarguments;
ifthistuplehasnelements,//theycorrespondtothelastnelementslistedinargs.intdefaultIdx=defaults.size()-(args.size()-i);
if(defaultIdx>=0){defaultValue=defaults.get(defaultIdx);
if(!meta.containsKey(key)){returndefaultValue;
if(output.size()==3){PyDictionarymeta=(PyDictionary)output.get(2);
if(meta!=null&&!meta.isEmpty()){metadata=newHashMap<String,Object>();for(Objectkey:meta.keySet()){metadata.put((String)key,meta.get(key));
if(rinstanceofMap){result=(Map<String,?>)r;
else{result=Collections.singletonMap(outputs.keySet().iterator().next(),r);
if(result.size()!=outputs.size()){thrownewIllegalStateException(String.format("Processreturned%dvalues,shouldhave"+"returned%d",result.size(),outputs.size()));
if(objinstanceofPyObject){obj=((PyObject)obj).__tojava__(output.type);
if(obj!=null&&!output.type.isInstance(obj)){LOGGER.warning(String.format("Output%sdeclaredtype%sbutreturned%s",output.getName(),output.getType().getSimpleName(),obj.getClass().getSimpleName()));
if(type!=null&&typeinstanceofPyType){clazz=PythonPlugin.toJavaClass((PyType)type);
if(clazz==null){clazz=Object.class;
if(policy.strVal.equals(interpolationMethod)){returnpolicy;
if(maxRenderingTime>0){this.requestStart=System.currentTimeMillis();
if(maxRenderingTime<=0){return;
if(residual<=0){thrownewServiceException("Thisanimationrequestusedmoretimethanallowedandhasbeenforcefullystopped."+"Themaxanimationrenderingtimeis"+(maxRenderingTime/1000.0)+"s");
if(threeLetters.equals(dow.getDisplayName(TextStyle.SHORT,Locale.ENGLISH))){returndow;
if(current!=null){last=current;current=null;
else{last=delegate.next();
ifthereisnofeaturetopushback.OnlyasinglepushBackcallcanbeperformedbetweentwo*callstonext()*/publicvoidpushBack(){
if(last!=null){current=last;last=null;
else{thrownewIllegalStateException("Thereisnofeaturetopushback");
ifalsoGeoToolsis//loaded...GeoServerInfoglobal=getGeoServer().getGlobal();global.setXmlExternalEntitiesEnabled(true);getGeoServer().save(global);
if(xp.getMatchingNodes("//wps:Status/wps:ProcessAccepted",dom).getLength()>0||xp.getMatchingNodes("//wps:Status/wps:ProcessStarted",dom).getLength()>0||xp.getMatchingNodes("//wps:Status/wps:ProcessQueued",dom).getLength()>0){Thread.sleep(100);
else{break;
if(wait>60){thrownewException("Waitedfortheprocesstocompletemorethan"+MAX_WAIT_FOR_ASYNCH);
ifunabletogetone.*@throwsMismatchedDimensionException*@throwsFactoryException*/publicstaticCapabilitiesTransformerProjectionHandlercreate(CoordinateReferenceSystemsourceCrs,CoordinateReferenceSystemtargetCrs)throwsMismatchedDimensionException,FactoryException{ProjectionHandlerhandler=ProjectionHandlerFinder.getHandler(newReferencedEnvelope(targetCrs),sourceCrs,false);
if(handler!=null){returnnewCapabilitiesTransformerProjectionHandler(handler);
if(wps!=null){updateFilters(wps);
if(serviceinstanceofWPSInfo){updateFilters((WPSInfo)service);
if(groups!=null){for(ProcessGroupInfogroup:groups){
if(!group.isEnabled()){ProcessFactoryfactory=GeoServerProcessors.getProcessFactory(group.getFactoryClass(),false);
if(factory!=null){disabledProcesses.addAll(factory.getNames());
else
if(group.getFilteredProcesses()!=null){for(ProcessInfofp:group.getFilteredProcesses()){
if(!fp.isEnabled()){disabledProcesses.add(fp.getName());
if(format==null){thrownewServiceException("Thereisnosupportforcreatinglegendsin"+outputFormat+"format","InvalidFormat");
if(backupFacade.getRestoreExecutions()!=null&&!backupFacade.getRestoreExecutions().isEmpty()&&backupFacade.getRestoreExecutions().containsKey(jobExecution.getId())){this.currentJobExecution=backupFacade.getRestoreExecutions().get(jobExecution.getId());this.catalog=((RestoreExecutionAdapter)currentJobExecution).getRestoreCatalog();this.isNew=true;
else{this.currentJobExecution=backupFacade.getBackupExecutions().get(jobExecution.getId());this.catalog=backupFacade.getCatalog();this.xstream.setExcludeIds();this.isNew=false;
if(parameterizePasswords){//herewesetsomecustomizedXMLhandlingcode.Forbackups,weaddaconverterthat//tokenizes//outgoingpasswords.forrestores,ahandlerforthosetokenizedbackups.
if(!isNew){this.xp.registerLocalConverter(StoreInfoImpl.class,"connectionParameters",this.createParameterizingMapConverter(xstream));this.xp.registerConverter(this.createStoreConverter(xstream));
else{StringconcatenatedPasswordTokens=jobParameters.getString(Backup.PARAM_PASSWORD_TOKENS);Map<String,String>passwordTokens=parseConcatenatedPasswordTokens(concatenatedPasswordTokens);this.xp.registerConverter(newTokenizedFieldConverter(passwordTokens));xstream.registerBreifMapComplexType("tokenizedPassword",BackupRestoreItem.class);
if(cql!=null&&cql.contains("name")){try{this.filter=ECQL.toFilter(cql);
else{this.filter=null;
if(concatenatedPasswordTokens!=null){Arrays.stream(concatenatedPasswordTokens.split(",")).forEach(tokenPair->{String[]tokenPairSplit=tokenPair.split("=");
if(tokenPairSplit.length==2){tokenMap.put(tokenPairSplit[0],tokenPairSplit[1]);
if(!isBestEffort()){
if(result!=null){result.throwIfInvalid();
else{throwe;
if(!isBestEffort()){getCurrentJobExecution().addFailureExceptions(Arrays.asList(validationException));
if(!isBestEffort()){getCurrentJobExecution().addFailureExceptions(Arrays.asList(validationException));throwvalidationException;
else{getCurrentJobExecution().addWarningExceptions(Arrays.asList(validationException));
if(getFilter()!=null){
if((strict&&ws==null)||(ws!=null&&!getFilter().evaluate(ws))){LOGGER.info("Skippedfilteredresource:"+resource);returntrue;
if(entry.getValue()==null){continue;
if(complexTypeId==null){Stringstr=Converters.convert(value,String.class);
if(str==null){str=value.toString();
if(fieldsToParametrize!=null&&fieldsToParametrize.getFields().contains(entry.getKey())){writer.startNode("tokenizedPassword");str="${"+fieldsToParametrize.getStoreInfo().getWorkspace().getName()+":"+fieldsToParametrize.getStoreInfo().getName()+"."+entry.getKey().toString()+".encryptedValue}";writer.setValue(str);writer.endNode();
else{writer.setValue(str);
else{writer.startNode(complexTypeId);context.convertAnother(value);writer.endNode();
if(secMgr!=null&&secMgr.isInitialized()){//setthehintforthemapconverterastowhichfieldstoencodeinthe//connection//parameterofthisstoreSet<String>encryptedFields=secMgr.getConfigPasswordEncryptionHelper().getEncryptedFields((StoreInfo)source);
if(!encryptedFields.isEmpty()){context.put(ENCRYPTED_FIELDS_KEY,newParameterizedFieldsHolder((StoreInfo)source,encryptedFields));
if(BackupRestoreItem.class.equals(type)){returntrue;
else{returnfalse;
if(BackupRestoreItem.class.equals(type)){returntrue;
else{returnfalse;
if(resource.getType()==Resource.Type.UNDEFINED){Propertiesproperties=newProperties();try(InputStreamstream=IndexConfigurationManager.class.getResourceAsStream("/"+PROPERTY_FILENAME)){properties.load(stream);//ReplaceGEOSERVER_DATA_DIRplaceholderproperties.replaceAll((k,v)->((String)v).replace("${GEOSERVER_DATA_DIR}",dd.root().getPath()));
if(notify.getKind()==Kind.ENTRY_MODIFY){try{loadConfigurations(resource);
if(timneToLive!=null){StringtimneToLiveStr=(String)timneToLive;indexConfiguration.setTimeToLive(Long.parseLong(timneToLiveStr),TimeUnit.SECONDS);
if(newStorage!=null){StringnewStorageStr=(String)newStorage;ResourcenewResource=newFileSystemResourceStore(newFile(newStorageStr)).get("");ResourceexResource=indexConfiguration.getStorageResource();
if(exResource!=null&&!newResource.dir().getAbsolutePath().equals(exResource.dir().getAbsolutePath())){exResource.delete();
if(exDataStore!=null){//Newdatabaseisvalidandisdifferentfromcurrentone
if(newDataStore!=null&&!isDBTheSame(params)){//CreatetableinnewdatabasecreateFeatureType(newDataStore,true);//MovedatatonewdatabasemoveData(exDataStore,newDataStore);//DisposeolddatabaseexDataStore.dispose();
else{//CreateschemacreateFeatureType(newDataStore,false);
if(exists){//Deleteofexistisrequired,andthencreateanewone
if(forceDelete){dataStore.removeSchema(STORE_SCHEMA_NAME);SimpleFeatureTypeschema=DataUtilities.createType(STORE_SCHEMA_NAME,STORE_SCHEMA);dataStore.createSchema(schema);
else{SimpleFeatureTypeschema=DataUtilities.createType(STORE_SCHEMA_NAME,STORE_SCHEMA);dataStore.createSchema(schema);
if(currentDataStore!=null){SimpleFeatureStorestore=(SimpleFeatureStore)currentDataStore.getFeatureSource(STORE_SCHEMA_NAME);Filterfilter=CQL.toFilter("updated<"+liveTreshold);SimpleFeatureCollectiontoRemoved=store.getFeatures(filter);//RemovefileResourcecurrentResource=indexConfiguration.getStorageResource();try(SimpleFeatureIteratoriterator=toRemoved.features()){while(iterator.hasNext()){SimpleFeaturefeature=iterator.next();currentResource.get(feature.getID()).delete();featureRemoved++;
if(LOGGER.isLoggable(Level.FINEST)){
if(featureRemoved>0){LOGGER.finest("CLEANexecuted,removed"+featureRemoved+"storedrequestsolderthan"+newSimpleDateFormat("yyyy-MM-ddHH:mm:ss").format(newDate(liveTreshold)));
if(ws==null){ws=catalog.getFactory().createWorkspace();ws.setName("test");catalog.add(ws);NamespaceInfons=catalog.getFactory().createNamespace();ns.setPrefix("test");ns.setURI("http://geoserver.org/test");catalog.add(ns);
if(ws!=null){remover.visit(ws);
switchtomultibandtestCreateCollectionMultiband();//andbacktosingletestCreateCollectionSimpleLayer();}}
if(parts.length>1){//putspacesinsteadofunderscoresindescriptiondescription=StringUtils.repeat(parts[1].replace('_',''),5);//getthecustombaselength,
ifavailable
if(parts.length>2)baseLen=Double.parseDouble(parts[2]);//splitthepatternusingaregularexpressionPatternp=Pattern.compile("[-]+|[*]+|[_]+");Matcherm=p.matcher(parts[1]);//analyzeeachpartandbuildaLineTypeItemwhile(m.find()){Stringpiece=m.group(0);inttype=piece.startsWith("-")?LineTypeItem.DASH:(piece.startsWith("*")?LineTypeItem.DOT:LineTypeItem.EMPTY);LineTypeItemitem=newLineTypeItem(type,piece.length()*baseLen);items.add(item);
ifthisvalueis12,thenamessagefrommodule"org.geotools.core"withlevel*FINEwouldbeformattedas"<code>[core&nbsp;&nbsp;FINE]</code><cite>themessage</cite>"*(i.e.thewhole<code>[&nbsp;]</code>partis12characterswide).*/privatefinalintmargin;/***Thebaseloggername.Thisisusedforshorteningtheloggernamewhenformattingmessage.*Forexample,
ifthebaseloggernameis"org.geotools"andalogrecordcomefromthe*"org.geotools.core"logger,itwillbeformattedas"[LEVELcore]"(i.e.the"org.geotools"*partisommited).*/privatefinalStringbase;/***Bufferforformattingmessages.Wewillreusethisbufferinordertoreducememory*allocations.*/privatefinalStringBufferbuffer;/***Thelinewriter.Thisobjecttransformall"\r","\n"or"\r\n"occurencesintoasingleline*separator.Thislineseparatorwillincludespaceforthemarging,
ifneeded.*/privatefinalLineWriterwriter;/***Constructa<code>Log4JFormatter</code>.**@parambaseThebaseloggername.Thisisusedforshorteningtheloggernamewhenformatting*message.Forexample,
ifthebaseloggernameis"org.geotools"andalogrecordcome*fromthe"org.geotools.core"logger,itwillbeformattedas"[LEVELcore]"(i.e.the*"org.geotools"partisommited).*/publicLog4JFormatter(finalStringbase){this.base=base.trim();this.margin=getHeaderWidth();Log4JFormatter.startMillis=System.currentTimeMillis();finalStringWriterstr=newStringWriter();writer=newLineWriter(str);buffer=str.getBuffer();
if(record.getSourceClassName()!=null){writer.write(record.getSourceClassName());
if(record.getMessage()==null){record.setMessage("null");
if(record.getThrown()!=null){try{writer.write(getStackTrace(record.getThrown()));
if(!logger.getUseParentHandlers()){logger.setLevel(filterLevel);
if(logger.getHandlers().length>0){Handlerhandler=logger.getHandlers()[0];//thisshouldbetherighthandler,
ifsetwithgeoserver.
if(handler!=null){handler.setLevel(filterLevel);
if(parent==null){break;
if(handlers!=null){for(inti=0;i<handlers.length;i++){/**SearchforaConsoleHandler.Searchisperformedinthetarget*handlerandallitsparentloggers.WhenaConsoleHandleris*found,itwillbereplacedbytheStdouthandlerfor'logger'*only.*/Handlerhandler=handlers[i];
if(handler.getClass().equals(ConsoleHandler.class)){finalFormatterformatter=handler.getFormatter();
if(formatter.getClass().equals(SimpleFormatter.class)){
if(log4j==null){log4j=newLog4JFormatter(base);
if(handler.getClass().equals(Stdout.class)){handler.setLevel(filterLevel);
if(0==logger.getHandlers().length)//seemsthatgetHandlers()cannotreturnnull{log4j=newLog4JFormatter(base);Handlerhandler=newStdout();handler.setFormatter(log4j);handler.setLevel(filterLevel);logger.addHandler(handler);
ifnovalue*hasbeenexplicitelyset.Thisvaluecanbesetinuser'spreferences.**@returnTheheaderwidth.*/privatestaticintgetHeaderWidth(){returnPreferences.userNodeForPackage(Log4JFormatter.class).getInt("logging.header",15);
iftheencodingisnotvalid.*/publicStdout(finalHandlerhandler,finalFormatterformatter)throwsUnsupportedEncodingException{super(System.out,formatter);setErrorManager(handler.getErrorManager());setFilter(handler.getFilter());setLevel(handler.getLevel());setEncoding(handler.getEncoding());
iftheObjectisnotencodeable.*/publicvoidencode(Objecto)throwsIllegalArgumentException{//try{
if(!(oinstanceofDescribeCoverageType)){thrownewIllegalArgumentException(newStringBuffer("NotaGetCapabilitiesType:").append(o).toString());
if(layer==null||layer.getType()!=PublishedType.RASTER){thrownewWcsException("Couldnotfindthespecifiedcoverage:"+coverageId,WcsExceptionCode.InvalidParameterValue,"identifiers");
if(mdl!=null){handleMetadataLink(mdl,linkType);
if((mdl.getAbout()!=null)&&(mdl.getAbout()!="")){attributes.addAttribute("","about","about","",mdl.getAbout());
if((mdl.getMetadataType()!=null)&&(mdl.getMetadataType()!="")){attributes.addAttribute("","metadataType","metadataType","",mdl.getMetadataType());
if((linkType!=null)&&(linkType!="")){attributes.addAttribute("","xlink:type","xlink:type","",linkType);
if((mdl.getContent()!=null)&&(mdl.getContent()!="")){attributes.addAttribute("","xlink:href","xlink:href","",ResponseUtils.proxifyMetadataLink(mdl,request.getBaseUrl()));
if(attributes.getLength()>0){element("ows:Metadata",null,attributes);
if(kwords!=null){for(Iteratorit=kwords.iterator();it.hasNext();){element("ows:Keyword",it.next().toString());
if(i<matrix.getNumRow()-2)origins.append("");
if(j<matrix.getNumCol()-2)offsets.append("");
if(i<matrix.getNumRow()-2)offsets.append("");
if(wgsLonLat){attributes.addAttribute("","crs","crs","","urn:ogc:def:crs:OGC:1.3:CRS84");
else{StringurnIdentifier=urnIdentifier(crs);CoordinateReferenceSystemlatlonCrs=CRS.decode(urnIdentifier);encodedEnvelope=newReferencedEnvelope(CRS.transform(encodedEnvelope,latlonCrs));attributes.addAttribute("","crs","crs","",urnIdentifier);
if(range==null||range.isEmpty()){element("ows:AnyValue","");
else{start("ows:AllowedValues");start("ows:Range");element("ows:MinimumValue",Double.toString(range.getMinimum()));element("ows:MaximumValue",Double.toString(range.getMaximum()));end("ows:Range");end("ows:AllowedValues");
ifallsample*dimensionshaveone,otherwisenull**@paramdimensions*/protectedNumberRangegetCoverageRange(List<CoverageDimensionInfo>dimensions){NumberRangerange=null;for(CoverageDimensionInfodimension:dimensions){
if(dimension.getRange()==null)returnnull;
else
if(range==null)range=dimension.getRange();
elserange.union(dimension.getRange());
if(nulls==null)return;
if(nulls.size()==1){element("wcs:NullValue",nulls.get(0).toString());
else
if(nulls.size()>=1){//thenewspecificationallowsonlyforalistofvalues,//Canweassumeminandmaxaretwointegernumbersand//makeupalistoutofthem?Forthemoment,justfailthrownewIllegalArgumentException("Cannotencodearangeofnullvalues,"+"onlysinglevaluesarehandled");
if(converted!=null)element("wcs:InterpolationMethod",converted);
if(formatMime!=null)formats.add(formatMime);
if(ci.getRequestSRS()!=null)supportedCRSs.addAll(ci.getRequestSRS());
if(ci.getResponseSRS()!=null)supportedCRSs.addAll(ci.getResponseSRS());for(Iteratorit=supportedCRSs.iterator();it.hasNext();){StringcrsName=(String)it.next();CoordinateReferenceSystemcrs=CRS.decode(crsName);element("wcs:SupportedCRS",urnIdentifier(crs));element("wcs:SupportedCRS",crsName);
ifandonly
ifthecontentisnotnullandnotempty**@paramelementName*@paramcontent*/protectedvoidelementIfNotEmpty(StringelementName,Stringcontent){
if(content!=null&&!"".equals(content.trim()))element(elementName,content);
if(iteratorinstanceofCloseableIterator){//don'tknowhowtoforcewickettoclosetheiterator,letsreturn//acopy.Shouldn'tbemuchoverheadaswe'repagingtry{returnLists.newArrayList(iterator).iterator();
else{returniterator;
if(sort!=null){
if(propertyinstanceofBeanProperty){finalStringsortProperty=((BeanProperty<StyleInfo>)property).getPropertyPath();sortOrder=sortBy(sortProperty,sort.isAscending());
if(!(storeInfoinstanceofDataStoreInfo)){LOGGER.warning("Failedtoloadactualstorefor"+this);returnnull;
if(filter==null&&cqlFilter!=null&&!cqlFilter.isEmpty()){filter=ECQL.toFilter(cqlFilter);
if(!(objinstanceofFeatureTypeInfo)){returnfalse;
if(!super.equals(obj)){returnfalse;
if(attributes==null){
if(other.getAttributes()!=null)returnfalse;
else{List<AttributeTypeInfo>otherAttributes=other.getAttributes();
if(otherAttributes==attributes)returntrue;ListIterator<AttributeTypeInfo>attributesIterator=attributes.listIterator();ListIterator<AttributeTypeInfo>otherAttributesIterator=otherAttributes.listIterator();while(attributesIterator.hasNext()&&otherAttributesIterator.hasNext()){AttributeTypeInfoattr=attributesIterator.next();AttributeTypeInfootherAttr=otherAttributesIterator.next();
if(attr==null){
if(otherAttr!=null)returnfalse;
else
if(!attr.equalsIngnoreFeatureType(otherAttr)){returnfalse;
if(attributesIterator.hasNext()||otherAttributesIterator.hasNext())returnfalse;
if(responseSRS==null){
if(other.getResponseSRS()!=null)returnfalse;
else
if(!responseSRS.equals(other.getResponseSRS()))returnfalse;
if(circularArcPresent!=other.isCircularArcPresent())returnfalse;
if(linearizationTolerance==null){
if(other.getLinearizationTolerance()!=null)returnfalse;
else
if(!linearizationTolerance.equals(other.getLinearizationTolerance()))returnfalse;
if(maxFeatures!=other.getMaxFeatures())returnfalse;
if(numDecimals!=other.getNumDecimals())returnfalse;
if(overridingServiceSRS!=other.isOverridingServiceSRS())returnfalse;
if(skipNumberMatched!=other.getSkipNumberMatched())returnfalse;
if(cqlFilter==null){
if(other.getCqlFilter()!=null)returnfalse;
else
if(!cqlFilter.equals(other.getCqlFilter()))returnfalse;returntrue;
if(insert==null)conn.close();
if(rs.next()){returnrs.getInt("oid");
else{thrownewIllegalStateException("Couldnotaddtestfile"+name);
if(rs.next()){returnrs.getInt("oid");
else{thrownewIllegalStateException("Couldnotaddtestdirectory"+name);
if(isOL3Enabled(mapContent)&&ol3Format.browserSupportsOL3(mapContent)){returnol3Format.produceMap(mapContent);
else{returnol2Format.produceMap(mapContent);
if(enableOL3==null){//checksystempropertyenableOL3=GeoServerExtensions.getProperty(ENABLE_OL3);
if(s.equals(searchValue))returnindex;index++;
if(key.equals(rule.getKey())){returnrule;
if(exportsObjinstanceofScriptable){exports=(Scriptable)exportsObj;
else{thrownewScriptException("Couldn'tgetexportsforapp.");
if(!(appReturninstanceofScriptable)){thrownewScriptException("badreturnfromJSGIapp");
ifnoneed
if(!hasTime&&!hasElevation){return;
if(mode==Mode.WMS11){StringelevUnits=hasElevation?elevInfo.getUnits():"";StringelevUnitSymbol=hasElevation?elevInfo.getUnitSymbol():"";declareWMS11Dimensions(hasTime,hasElevation,elevUnits,elevUnitSymbol,null);
if(hasTime){try{handleTimeDimensionVector(typeInfo);
if(hasElevation){try{handleElevationDimensionVector(typeInfo);
if(TIME.equalsIgnoreCase(dimName)){DimensiontimeDimension=wl.getDimension(dimName);
if(mode==Mode.WMS11){declareWMS11Dimensions(true,false,null,null,null);
else{//TODO:customdimensionhandlingLOGGER.log(Level.WARNING,"Skippingcustomdimension"+dimName+"inlayer"+layerInfo.getName());
ifany**@paramlayer*@throwsRuntimeException*@throwsIOException*/voidhandleRasterLayerDimensions(finalLayerInfolayer)throwsRuntimeException,IOException{//dowehavetimeandelevation?CoverageInfocvInfo=(CoverageInfo)layer.getResource();
if(cvInfo==null)thrownewServiceException("Unabletoacquirecoverageresourceforlayer:"+layer.getName());DimensionInfotimeInfo=null;DimensionInfoelevInfo=null;Map<String,DimensionInfo>customDimensions=newHashMap<String,DimensionInfo>();GridCoverage2DReaderreader=null;for(Map.Entry<String,Serializable>e:cvInfo.getMetadata().entrySet()){Stringkey=e.getKey();Objectvalue=e.getValue();
if(key.equals(ResourceInfo.TIME)){timeInfo=Converters.convert(value,DimensionInfo.class);
else
if(key.equals(ResourceInfo.ELEVATION)){elevInfo=Converters.convert(value,DimensionInfo.class);
else
if(valueinstanceofDimensionInfo){DimensionInfodimInfo=(DimensionInfo)value;
if(dimInfo.isEnabled()){
if(key.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){StringdimensionName=key.substring(ResourceInfo.CUSTOM_DIMENSION_PREFIX.length());customDimensions.put(dimensionName,dimInfo);
else{LOGGER.log(Level.SEVERE,"Skippingcustomdimensionwithkey"+key+"sinceitdoesnotstartwith"+ResourceInfo.CUSTOM_DIMENSION_PREFIX);
ifnothingisconfigured
if(!hasTime&&!hasElevation&&!hasCustomDimensions){return;
if(catalog==null)thrownewServiceException("Unabletoacquirecatalogresourceforlayer:"+layer.getName());CoverageStoreInfocsinfo=cvInfo.getStore();
if(csinfo==null)thrownewServiceException("Unabletoacquirecoveragestoreresourceforlayer:"+layer.getName());try{reader=(GridCoverage2DReader)cvInfo.getGridCoverageReader(null,null);
if(reader==null){thrownewServiceException("Unabletoacquireareaderforthiscoveragewithformat:"+csinfo.getFormat().getName());
if(hasCustomDimensions){for(Stringkey:customDimensions.keySet()){
if(!dimensions.hasDomain(key))customDimensions.remove(key);
if(mode==Mode.WMS11){StringelevUnits=hasElevation?elevInfo.getUnits():"";StringelevUnitSymbol=hasElevation?elevInfo.getUnitSymbol():"";declareWMS11Dimensions(hasTime,hasElevation,elevUnits,elevUnitSymbol,customDimensions);
if(hasTime&&dimensions.hasTime()){handleTimeDimensionRaster(cvInfo,timeInfo,dimensions);
if(hasElevation&&dimensions.hasElevation()){handleElevationDimensionRaster(cvInfo,elevInfo,dimensions);
if(hasCustomDimensions){for(Stringkey:customDimensions.keySet()){DimensionInfodimensionInfo=customDimensions.get(key);handleCustomDimensionRaster(cvInfo,key,dimensionInfo,dimensions);
if(defaultValue==null){defaultValue=fallback;
ifthelayerhasthetimedimension,<tt>false</tt>otherwise*@paramhasElevation-<tt>true</tt>
ifthelayerhastheelevationdimension,<tt>false</tt>*otherwise*@paramelevUnits-<tt>units</tt>attributeoftheelevationdimension*@paramelevUnitSymbol-<tt>unitSymbol</tt>attributeoftheelevationdimension*/privatevoiddeclareWMS11Dimensions(booleanhasTime,booleanhasElevation,StringelevUnits,StringelevUnitSymbol,Map<String,DimensionInfo>customDimensions){//wehavetodeclaretimeandelevationbeforetheextents
if(hasTime){AttributesImpltimeDim=newAttributesImpl();timeDim.addAttribute("",NAME,NAME,"",TIME);timeDim.addAttribute("",UNITS,UNITS,"","ISO8601");element("Dimension",null,timeDim);
if(hasElevation){//sameasWMS1.3exceptnovalueswriteElevationDimensionElement(null,null,elevUnits,elevUnitSymbol);
if(customDimensions!=null){for(Stringdim:customDimensions.keySet()){DimensionInfodi=customDimensions.get(dim);AttributesImplcustDim=newAttributesImpl();custDim.addAttribute("",NAME,NAME,"",dim);Stringunits=di.getUnits();StringunitSymbol=di.getUnitSymbol();custDim.addAttribute("",UNITS,UNITS,"",units!=null?units:"");
if(unitSymbol!=null){custDim.addAttribute("",UNIT_SYMBOL,UNIT_SYMBOL,"",unitSymbol);
if(DimensionPresentation.LIST==dimension.getPresentation()){for(Objectval:values){
if(valinstanceofDouble){buff.append(val);
else{NumberRange<Double>range=(NumberRange<Double>)val;buff.append(range.getMinimum()).append("/").append(range.getMaximum()).append("/0");
else
if(DimensionPresentation.CONTINUOUS_INTERVAL==dimension.getPresentation()){NumberRange<Double>range=getMinMaxZInterval(values);buff.append(range.getMinimum());buff.append("/");buff.append(range.getMaximum());buff.append("/0");elevationMetadata=buff.toString();
else
if(DimensionPresentation.DISCRETE_INTERVAL==dimension.getPresentation()){NumberRange<Double>range=getMinMaxZInterval(values);buff.append(range.getMinimum());buff.append("/");buff.append(range.getMaximum());buff.append("/");BigDecimalresolution=dimension.getResolution();
if(resolution!=null){buff.append(resolution.doubleValue());
else{
if(values.size()>=2&&allDoubles(values)){intcount=2,i=2;Double[]zPositions=newDouble[count];for(Objectval:values){zPositions[count-i--]=(Double)val;
if(i==0)break;
else{buff.append(0);
if(DimensionPresentation.LIST==dimension.getPresentation()){for(Objectdate:values){buff.append(df.format(date));buff.append(",");
else
if(DimensionPresentation.CONTINUOUS_INTERVAL==dimension.getPresentation()){DateRangeinterval=getMinMaxTimeInterval(values);buff.append(df.format(interval.getMinValue()));buff.append("/");buff.append(df.format(interval.getMaxValue()));buff.append("/PT1S");timeMetadata=buff.toString();
else
if(DimensionPresentation.DISCRETE_INTERVAL==dimension.getPresentation()){DateRangeinterval=getMinMaxTimeInterval(values);buff.append(df.format(interval.getMinValue()));buff.append("/");buff.append(df.format(interval.getMaxValue()));buff.append("/");finalBigDecimalresolution=dimension.getResolution();
if(resolution!=null){//resolutionhasbeenprovidedbuff.append(newDefaultPeriodDuration(resolution.longValue()).toString());
else{
if(values.size()>=2&&allDates(values)){intcount=2,i=2;Date[]timePositions=newDate[count];for(Objectdate:values){timePositions[count-i--]=(Date)date;
if(i==0)break;
else{//assume1secondandbedonewithit...buff.append("PT1S");
if(minValueinstanceofDateRange){min=((DateRange)minValue).getMinValue();
else{min=(Date)minValue;
if(maxValueinstanceofDateRange){max=((DateRange)maxValue).getMaxValue();
else{max=(Date)maxValue;
if(minValueinstanceofNumberRange){min=((NumberRange<Double>)minValue).getMinValue();
else{min=(Double)minValue;
if(maxValueinstanceofNumberRange){max=((NumberRange<Double>)maxValue).getMaxValue();
else{max=(Double)maxValue;
ifallthevaluesinthesetareDateinstances**@paramvalues*/privatebooleanallDates(TreeSet<?extendsObject>values){for(Objectvalue:values){
if(!(valueinstanceofDate)){returnfalse;
ifallthevaluesinthesetareDoubleinstances**@paramvalues*/privatebooleanallDoubles(TreeSet<?extendsObject>values){for(Objectvalue:values){
if(!(valueinstanceofDouble)){returnfalse;
if(DimensionPresentation.LIST==dimension.getPresentation()){for(Stringvalue:values){buff.append(value.trim());buff.append(",");
else
if(DimensionPresentation.DISCRETE_INTERVAL==dimension.getPresentation()){buff.append(values.get(0));buff.append("/");buff.append(values.get(0));buff.append("/");finalBigDecimalresolution=dimension.getResolution();
if(resolution!=null){buff.append(resolution);
if(values!=null&&!values.isEmpty()){DimensionInfotimeInfo=typeInfo.getMetadata().get(ResourceInfo.TIME,DimensionInfo.class);timeMetadata=getTemporalDomainRepresentation(timeInfo,values);nearest=timeInfo.isNearestMatchEnabled();
else{timeMetadata="";
if(elevations!=null&&!elevations.isEmpty()){elevationMetadata=getZDomainRepresentation(di,elevations);
else{elevationMetadata="";
if(defaultTimeStr==null){defaultTimeStr=DimensionDefaultValueSetting.TIME_CURRENT;
if(mode==Mode.WMS11){timeDim.addAttribute("",NAME,NAME,"",TIME);timeDim.addAttribute("",DEFAULT,DEFAULT,"",defaultTimeStr);
if(nearestMatch){timeDim.addAttribute("",NEAREST_VALUE,NEAREST_VALUE,"","1");
else{timeDim.addAttribute("",NAME,NAME,"",TIME);timeDim.addAttribute("",DEFAULT,DEFAULT,"",defaultTimeStr);timeDim.addAttribute("",UNITS,UNITS,"",DimensionInfo.TIME_UNITS);
if(nearestMatch){timeDim.addAttribute("",NEAREST_VALUE,NEAREST_VALUE,"","1");
if(mode==Mode.WMS11){AttributesImplelevDim=newAttributesImpl();elevDim.addAttribute("",NAME,NAME,"",ELEVATION);elevDim.addAttribute("",DEFAULT,DEFAULT,"",defaultValue);element("Extent",elevationMetadata,elevDim);
else{writeElevationDimensionElement(elevationMetadata,defaultValue,units,unitSymbol);
if(units==null){unitsNotNull=DimensionInfo.ELEVATION_UNITS;unitSymNotNull=DimensionInfo.ELEVATION_UNIT_SYMBOL;
if(defaultValue!=null){elevDim.addAttribute("",DEFAULT,DEFAULT,"",defaultValue);
if(!"".equals(unitsNotNull)&&!"".equals(unitSymNotNull)){elevDim.addAttribute("",UNIT_SYMBOL,UNIT_SYMBOL,"",unitSymNotNull);
if(mode==Mode.WMS11){
if(defaultValue!=null){dim.addAttribute("",DEFAULT,DEFAULT,"",defaultValue);
else{
if(defaultValue!=null){dim.addAttribute("",DEFAULT,DEFAULT,"",defaultValue);
if(unitSymbol!=null&&!"".equals(unitSymbol)){dim.addAttribute("",UNIT_SYMBOL,UNIT_SYMBOL,"",unitSymbol);
if(configuration!=null){configuration.delete();
if(f.getMimeType()!=null){assertXpathExists(base+"/Output[1]/ComplexOutput/Supported/Format[MimeType='"+f.getMimeType()+";subtype="+f.getGeoserverFormat()+"']",d);
if(configuration!=null){configuration.delete();
if(configuration!=null){configuration.delete();
if(configuration!=null){configuration.delete();
if(name.equals("feature.tab")){found=true;break;
if(configuration!=null){configuration.delete();
if(it==null)returnnull;try{LinkedList<T>list=newLinkedList<T>();while(it.hasNext()){list.add(it.next());
ifit*doesexist.*/ImageFormatInfogetImageFormatByMimeType(StringmimeType);/**@uml.propertyname="allowInterpolation"*/booleangetAllowInterpolation();/**@uml.propertyname="allowInterpolation"*/voidsetAllowInterpolation(booleanallowInterpolation);/**@uml.propertyname="recycling"*/booleangetRecycling();/**@uml.propertyname="recycling"*/voidsetRecycling(booleanrecycling);/**@uml.propertyname="tilePriority"*/intgetTilePriority();/**@uml.propertyname="tilePriority"*/voidsetTilePriority(inttilePriority);/**@uml.propertyname="tileThreads"*/intgetTileThreads();/**@uml.propertyname="tileThreads"*/voidsetTileThreads(inttileThreads);StringgetTileCache();voidsetTileCache(StringtileCache);/**@uml.propertyname="memoryCapacity"*/doublegetMemoryCapacity();/**@uml.propertyname="memoryCapacity"*/voidsetMemoryCapacity(doublememoryCapacity);/**@uml.propertyname="memoryThreshold"*/doublegetMemoryThreshold();/**@uml.propertyname="memoryThreshold"*/voidsetMemoryThreshold(doublememoryThreshold);/**@uml.propertyname="metadata"*/Map<String,Serializable>getMetadata();Map<Object,Object>getClientProperties();}
if(mapinstanceofNamedMap){return((NamedMap<?,?>)map).getName();
else{return"root";
if(children.size()==0){
if(elem.getContent().size()==0){returnnull;
else{returnelem.getText();
else
if(children.get(0)instanceofElement){Elementchild=(Element)children.get(0);
if(child.getName().equals("entry")){List<Object>l=newArrayList<>();for(Objecto:elem.getChildren("entry")){Elementcurr=(Element)o;l.add(convert(curr));
else{Map<String,Object>m=newNamedMap<>(child.getName());for(ObjectaChildren:children){Elementcurr=(Element)aChildren;m.put(curr.getName(),convert(curr));
if(objectinstanceofMap){Map<?,?>map=(Map<?,?>)object;for(Map.Entry<?,?>entry:map.entrySet()){ElementnewElem=newElement(entry.getKey().toString());insert(newElem,entry.getValue());elem.addContent(newElem);
else
if(objectinstanceofCollection){Collection<?>collection=(Collection<?>)object;for(Objectentry:collection){ElementnewElem=newElement("entry");insert(newElem,entry);elem.addContent(newElem);
else{elem.addContent(object==null?"":object.toString());
if(tinstanceofWFSException){throw(WFSException)t;
if(nativeCRS==null)returnnull;
if(wfsVersion.equals("1.0.0")){returnnativeCRS;
else{Stringcode=GML2EncodingUtils.epsgCode(nativeCRS);//it'spossiblethatwecan'tdotheCRS->code->CRSconversion...sowe'lljust//returnwhatwehave
if(code==null)returnnativeCRS;returnCRS.decode("urn:x-ogc:def:crs:EPSG:6.11.2:"+code);
if(schema==null)returnnull;CoordinateReferenceSystemcrs=(schema.getGeometryDescriptor()!=null)?schema.getGeometryDescriptor().getCoordinateReferenceSystem():null;returngetDeclaredCrs(crs,wfsVersion);
if(custom){setOutputMarkupId(true);getDropDownChoice().add(newOnChangeAjaxBehavior(){privatestaticfinallongserialVersionUID=7823984472638368286L;@OverrideprotectedvoidonUpdate(AjaxRequestTargettarget){booleanuseDropDown=!getDropDownChoice().getModelObject().equals("");
if(useDropDown){model.setObject(getDropDownChoice().getModelObject());getDropDownChoice().setModel(model);
else{getDropDownChoice().setModel(newModel<String>(""));
ifthefeaturetypewasnullCoordinateReferenceSystemcrs=WFSReprojectionUtil.getDeclaredCrs((FeatureType)null,"1.1.0");assertNull(crs);}}
ifbackgroundtransparencyisrequested*/privatebooleantransparent;/**suggestedoutputtilesize*/privateinttileSize=-1;/**maprotationindegrees*/privatedoubleangle;privateList<GetMapCallback>callbacks;privateMap<String,Object>metadata=newHashMap<>();privateIntegermaxRenderingTime;publicintgetTileSize(){returntileSize;
if(copyLayers){this.layers().addAll(other.layers());
if(layer!=null){returnsuper.addLayer(layer);
else{returnfalse;
ifnocallbacks,returnthelayerasis
if(callbacks==null){returnlayer;
if(layer==null){returnnull;
if(layer!=null){filtered.add(layer);
if(filtered.size()>0){returnsuper.addLayers(filtered);
else{return0;
if(getAngle()!=0.0){tx=newAffineTransform();tx.translate(paintArea.width/2,paintArea.height/2);tx.rotate(Math.toRadians(getAngle()));tx.translate(-paintArea.width/2,-paintArea.height/2);tx.concatenate(RendererUtilities.worldToScreenTransform(dataArea,paintArea));
else{tx=RendererUtilities.worldToScreenTransform(dataArea,paintArea);
if(getAngle()==0)returndataArea;AffineTransformtx=newAffineTransform();doubleoffsetX=dataArea.getMinX()+dataArea.getWidth()/2;doubleoffsetY=dataArea.getMinY()+dataArea.getHeight()/2;tx.translate(offsetX,offsetY);tx.rotate(Math.toRadians(getAngle()));tx.translate(-offsetX,-offsetY);Rectangle2DdataAreaShape=newRectangle2D.Double(dataArea.getMinX(),dataArea.getMinY(),dataArea.getWidth(),dataArea.getHeight());Rectangle2DtransformedBounds=tx.createTransformedShape(dataAreaShape).getBounds2D();returnnewReferencedEnvelope(transformedBounds,dataArea.getCoordinateReferenceSystem());
if*contactInformationhasnotbeenset.**@returntheContactInformationoranemptystring
ifnotpresent*/publicStringgetContactInformation(){Stringcontact=(String)getUserData().get("contact");returncontact==null?"":contact;
ifnokeywords*havebeenset.Thearrayreturnedisacopy,changestothereturnedarraywon'tinfluence*theMapContextState**@returnarrayofkeywords*/publicString[]getKeywords(){Objectobj=getUserData().get("keywords");
if(obj==null){returnnewString[0];
else
if(objinstanceofString){Stringkeywords=(String)obj;returnkeywords.split(",");
else
if(objinstanceofString[]){Stringkeywords[]=(String[])obj;String[]copy=newString[keywords.length];System.arraycopy(keywords,0,copy,0,keywords.length);returncopy;
else
if(objinstanceofCollection){Collection<String>keywords=(Collection)obj;returnkeywords.toArray(newString[keywords.size()]);
else{returnnewString[0];
ifthishasnotbeen*setyet.**@returnTheAbstractoranemptystring
ifnotpresent*/publicStringgetAbstract(){Stringdescription=(String)getUserData().get("abstract");returndescription==null?"":description;
if(considerDPI){//computetheDPI
if(request.getFormatOptions().get("dpi")!=null){hints.put(StreamingRenderer.DPI_KEY,(request.getFormatOptions().get("dpi")));
if(request.getScaleMethod()==ScaleComputationMethod.Accurate){
if(request.getAngle()!=0){thrownewServiceException("Accuratescalecomputationisnotsupportedwhenusingtheangleparameter."+"Thisfunctionalitycouldbeadded,pleaseprovideapullrequestforit;-)");
else{AffineTransformat=getRenderingTransform();
if(Math.abs(XAffineTransform.getRotation(at))!=0.0){returnRendererUtilities.calculateOGCScaleAffine(getCoordinateReferenceSystem(),at,hints);
else{returnRendererUtilities.calculateOGCScale(getViewport().getBounds(),getMapWidth(),hints);
if(request.getScaleMethod()==ScaleComputationMethod.Accurate){returnStreamingRenderer.SCALE_ACCURATE;
else{returnStreamingRenderer.SCALE_OGC;
if(outputFormats.isEmpty()){thrownewIllegalArgumentException("EmptylistofoutputFormatsprovided");
if(fileExtensions.isEmpty()){thrownewIllegalArgumentException("EmptylistoffileExtensionsprovided");
if(mimeTypes.isEmpty()){thrownewIllegalArgumentException("EmptylistofmimeTypesprovided");
if(mimeTypes.containsKey(outputFormat)){return(String)mimeTypes.get(outputFormat);
if(mimeTypes.values().contains(outputFormat)){returnoutputFormat;
if(fileExtensions.containsKey(outputFormat)){return(String)fileExtensions.get(outputFormat);
if(mimeTypes.values().contains(outputFormat)){return(String)fileExtensions.values().iterator().next();
if(storeinstanceofWrapper){store=((Wrapper)store).unwrap(DataAccess.class);
if(fs==null)returnnull;WrapperPolicychildPolicy=buildPolicyForFeatureSource();returnDataUtilities.simple((FeatureSource)SecuredObjects.secure(fs,childPolicy));
if(policy.getLimits()instanceofVectorAccessLimits){childPolicy=policy;
else{finalAccessLimitslimits=policy.getLimits();VectorAccessLimitsvectorLimits=newVectorAccessLimits(limits.getMode(),null,Filter.INCLUDE,null,Filter.EXCLUDE);childPolicy=this.policy.derive(vectorLimits);
if(policy.response==Response.CHALLENGE){returnSecureCatalogImpl.unauthorizedAccess();
elsereturnnewUnsupportedOperationException("Thisdatastoreisreadonly,servicecodeissupposedtoperformwritesviaFeatureStoreinstead");}}
if(MediaType.APPLICATION_JSON.includes(mediaType)||MediaTypeExtensions.TEXT_JSON.includes(mediaType)){writeGeoJsonl(content.getCollection(),outputMessage);
else
if(MediaType.APPLICATION_XML.includes(mediaType)||MediaTypeExtensions.TEXT_JSON.includes(mediaType)){writeGML(content.getCollection(),outputMessage);
if(batch!=null){dao.delete(batch);
if(config!=null){dao.delete(config);
if((height>512)||(width>512)){thrownewServiceException("CannotgetWMSbil"+"tilesbiggerthan512x512,tryWCS");
if(reqlayers.size()>1){thrownewServiceException("CannotcombinelayersintoBILoutput");
if(noDataParaminstanceofNumber){outNoData=((Number)noDataParam).doubleValue();
else
if(noDataParaminstanceofString){try{outNoData=Double.parseDouble((String)noDataParam);
if(subCov==null){LOGGER.fine("Creatingcoveragefromablankimage");BufferedImageemptyImage=newBufferedImage(width,height,BufferedImage.TYPE_USHORT_GRAY);DataBufferdata=emptyImage.getRaster().getDataBuffer();for(inti=0;i<data.getSize();++i){data.setElem(i,32768);//0x0080infile(2^15)
if(subCov!=null){image=subCov.getRenderedImage();
if(image!=null){intdtype=image.getData().getDataBuffer().getDataType();RenderedImagetransformedImage=image;//PerformNoDatatranslationfinaldouble[]inNoDataValues=CoverageUtilities.getBackgroundValues((GridCoverage2D)subCov);
if(inNoDataValues!=null&&outNoData!=null){//TODOshouldsupportmultipleno-datavaluesfinaldoubleinNoData=inNoDataValues[0];
if(inNoData!=outNoData){ParameterBlockparam=newParameterBlock().addSource(image);param=param.add(inNoData);param=param.add(outNoData);transformedImage=JAI.create(RecodeRaster.OPERATION_NAME,param,null);
ifnoconversionis//necessary.
if(defaultDataType!=null&&((bilEncoding.equals("application/bil")||bilEncoding.equals("image/bil")))){bilEncoding=defaultDataType;
if((bilEncoding.equals("application/bil32"))&&(dtype!=DataBuffer.TYPE_FLOAT)){transformedImage=worker.format(DataBuffer.TYPE_FLOAT).getRenderedImage();
else
if((bilEncoding.equals("application/bil16"))&&(dtype!=DataBuffer.TYPE_SHORT)){transformedImage=worker.format(DataBuffer.TYPE_SHORT).getRenderedImage();
else
if((bilEncoding.equals("application/bil8"))&&(dtype!=DataBuffer.TYPE_BYTE)){transformedImage=worker.format(DataBuffer.TYPE_BYTE).getRenderedImage();
if(ByteOrder.LITTLE_ENDIAN.toString().equals(byteOrder)){imageOutStream.setByteOrder(ByteOrder.LITTLE_ENDIAN);
else
if(ByteOrder.BIG_ENDIAN.toString().equals(byteOrder)){imageOutStream.setByteOrder(ByteOrder.BIG_ENDIAN);
else{thrownewServiceException("CannotrendertoBIL");
else{thrownewServiceException("Yourequestedabilofsize:"+height+"x"+width+",butyoucan'thaveit!!");
if(coverage==null){LOGGER.log(Level.FINE,"Failedtoreadcoverage-continuing");returnnull;
if(p!=null){for(Map.Entry<String,String>entry:p.entrySet()){options.put(entry.getKey(),entry.getValue());
if(eventinstanceofContextLoadedEvent){booleanstatus=getStatus(type,config);
if(LOGGER.isLoggable(java.util.logging.Level.INFO)){
if(status)LOGGER.info("ActivatingJMSCatalogeventpublisher...");
elseLOGGER.info("JMSCatalogeventpublisherisdisabledbyconfiguration...");
else{super.onApplicationEvent(event);
ifthewcs-eopluginis*installed)*/TransformerBasedescribeEOCoverageSet(DescribeEOCoverageSetTyperequest);/**GetCoverageoperation.*/GridCoveragegetCoverage(GetCoverageTyperequest);}
ifyouhaveaproblemwithGMLyouwillneedtohunt*itdown.Wesupplyalloftheheaderinformationintheexecutemethod,andworkthroughthe*featureListinthewriteTomethod.**<p>Thisvaluewillbe<code>null</code>untilexecuteiscalled.*/privateFeatureTransformertransformer;/**GeoServerconfiguration*/privateGeoServergeoServer;/**Thecatalog*/protectedCatalogcatalog;/**CreatestheproducerwithareferencetotheGetFeatureoperationusingit.*/publicGML2OutputFormat(GeoServergeoServer){super(geoServer,newHashSet(Arrays.asList(newString[]{"GML2",MIME_TYPE})));this.geoServer=geoServer;this.catalog=geoServer.getCatalog();
if(ftNamespaces.containsKey(uri)){Stringlocation=(String)ftNamespaces.get(uri);ftNamespaces.put(uri,location+","+urlEncode(meta.getPrefixedName()));
else{//don'tblindlyassumeit'safeaturetype,thisclassisusedalsobyWMS//FeatureInfo//meaningitmightbeacoverageoraremotewmslayer
if(metainstanceofFeatureTypeInfo){Stringlocation=typeSchemaLocation(geoServer.getGlobal(),(FeatureTypeInfo)meta,request.getBaseUrl());ftNamespaces.put(uri,location);
if(srsName==null){//noSRSinquery...askingforthedefault?srsName=meta.getSRS();
if(srsName!=null){CoordinateReferenceSystemcrs=CRS.decode(srsName);StringepsgCode=GML2EncodingUtils.epsgCode(crs);srs=Integer.parseInt(epsgCode);
if(metainstanceofFeatureTypeInfo){intftiDecimals=((FeatureTypeInfo)meta).getNumDecimals();
if(ftiDecimals>0){numDecimals=numDecimals==-1?ftiDecimals:Math.max(numDecimals,ftiDecimals);
if(numDecimals==-1){numDecimals=settings.getNumDecimals();
if(wfs.isCanonicalSchemaLocation()){transformer.addSchemaLocation(WFS.NAMESPACE,wfsCanonicalSchemaLocation());
else{StringwfsSchemaloc=wfsSchemaLocation(request.getBaseUrl());transformer.addSchemaLocation(WFS.NAMESPACE,wfsSchemaloc);
if(results.getLockId()!=null){transformer.setLockId(results.getLockId());
if(srs!=-1){transformer.setSrsName(gml.getSrsNameStyle().getPrefix()+srs);
if(results==null){thrownewIllegalStateException("Itseemsprepare()hasnotbeencalled"+"orhasnotsucceed");
ifallofthelockscouldnotbeaquiredListresultsList=results.getFeature();FeatureCollection[]featureResults=(FeatureCollection[])resultsList.toArray(newFeatureCollection[resultsList.size()]);try{transformer.transform(featureResults,output);//weneedto"finish"herebecause
ifnot,itispossiblethatthegzipped//contentdonotgetscompletelywritten
if(gzipOut!=null){gzipOut.finish();gzipOut.flush();
if(resourceClass.equals(CoverageInfo.class)){store=createNiceMock(CoverageStoreInfo.class);
else
if(resourceClass.equals(WMSLayerInfo.class)){store=createNiceMock(WMSStoreInfo.class);
else
if(resourceClass.equals(WMTSLayerInfo.class)){store=createNiceMock(WMTSStoreInfo.class);
else{store=createNiceMock(DataStoreInfo.class);expect((DataStore)((DataStoreInfo)store).getDataStore(null)).andReturn(dstore);
if(resourceinstanceofFeatureTypeInfo){expect(((FeatureTypeInfo)resource).getFeatureSource((ProgressListener)anyObject(),(Hints)anyObject())).andReturn(fs).anyTimes();
if(!advertised)expect(resource.isAdvertised()).andReturn(advertised).anyTimes();expect(resource.getId()).andReturn(name+"-id").anyTimes();replay(resource);LayerInfolayer=createNiceMock(LayerInfo.class);expect(layer.getName()).andReturn(name).anyTimes();expect(layer.getPrefixedName()).andReturn(ws.getName()+":"+name).anyTimes();expect(layer.prefixedName()).andReturn(ws.getName()+":"+name).anyTimes();expect(layer.getResource()).andReturn(resource).anyTimes();expect(layer.getId()).andReturn(name+"-lid").anyTimes();
if(!advertised)expect(layer.isAdvertised()).andReturn(advertised).anyTimes();replay(layer);returnlayer;
if(contents==null){returnnull;
if(piinstanceofLayerInfo){StyleInfostyle=buildStyle(pi.prefixedName().replace(':','-')+"-style",null);result.add(style);
else{//groupresult.add(null);
if(wrapper!=null){wrapper.setDelegate(manager);manager=wrapper;
if(layer.getResource()instanceofFeatureTypeInfo){featureTypes.add((FeatureTypeInfo)layer.getResource());
else
if(layer.getResource()instanceofWMSLayerInfo){wmsLayers.add((WMSLayerInfo)layer.getResource());
else
if(layer.getResource()instanceofWMTSLayerInfo){wmtsLayers.add((WMTSLayerInfo)layer.getResource());
else{coverages.add((CoverageInfo)layer.getResource());
if(lg.getWorkspace()==null){expect(catalog.getLayerGroupByName(lg.getName())).andReturn(lg).anyTimes();expect(catalog.getLayerGroupByName(NULL_STRING,lg.getName())).andReturn(lg).anyTimes();
else{expect(catalog.getLayerGroupByName(lg.getWorkspace(),lg.getName())).andReturn(lg).anyTimes();expect(catalog.getLayerGroupByName(lg.getWorkspace().getName(),lg.getName())).andReturn(lg).anyTimes();
if(cookies==null){cookies=newArrayList<Cookie>(2);
if(dbFilename!=null){dbFilename=dbFilename.substring(0,dbFilename.length()-4)+extension;
else{//thisshouldn'treallyeverhappen,butfallbackanywaysdbFilename="tiles"+extension;
if(mapLayers.isEmpty()){return;
if(formatOpts.containsKey("tileset_name")){tileEntryName=(String)formatOpts.get("tileset_name");
if(name!=null){tileEntryName=name;
if(tileEntryName==null){Iterator<MapLayerInfo>it=mapLayers.iterator();tileEntryName="";while(it.hasNext()){tileEntryName+=it.next().getLayerInfo().getName()+"_";
if(formatOpts.containsKey("min_column")){minColumn=Integer.parseInt(formatOpts.get("min_column").toString());
if(formatOpts.containsKey("max_column")){maxColumn=Integer.parseInt(formatOpts.get("max_column").toString());
if(formatOpts.containsKey("min_row")){minRow=Integer.parseInt(formatOpts.get("min_row").toString());
if(formatOpts.containsKey("max_row")){maxRow=Integer.parseInt(formatOpts.get("max_row").toString());
iftilerowindexeswestoreindatabaseshouldbeinvertedbooleanflipy=Boolean.valueOf((String)formatOpts.get("flipy"));for(intz=minmax[0];z<minmax[1];z++){long[]intersect=gridSubset.getCoverageIntersection(z,bbox);longminX=minColumn==null?intersect[0]:Math.max(minColumn,intersect[0]);longmaxX=maxColumn==null?intersect[2]:Math.min(maxColumn,intersect[2]);longminY=minRow==null?intersect[1]:Math.max(minRow,intersect[1]);longmaxY=maxRow==null?intersect[3]:Math.min(maxRow,intersect[3]);for(longx=minX;x<=maxX;x++){for(longy=minY;y<=maxY;y++){BoundingBoxbox=gridSubset.boundsFromIndex(newlong[]{x,y,z});req.setBbox(newEnvelope(box.getMinX(),box.getMaxX(),box.getMinY(),box.getMaxY()));WebMapresult=webMapService.getMap(req);tiles.addTile(z,(int)x,(int)(flipy?gridSubset.getNumTilesHigh(z)-(y+1):y),toBytes(result));//Cleanupcleaner.finished(null);
if(getCoordinateReferenceSystem(req)!=null){srid=CRS.lookupEpsgCode(getCoordinateReferenceSystem(req),false);
if(srid==null){srid=Integer.parseInt(getSRS(req).split(":")[1]);
ifexplicitlyspecified
if(formatOpts.containsKey("gridset")){gridSet=gridSetBroker.get(formatOpts.get("gridset").toString());
if(gridSet==null&&getSRS(req)!=null){gridSet=gridSetBroker.get(getSRS(req));
if(gridSet!=null){returnGridSubsetFactory.createGridSubSet(gridSet);
if(epsgCode==null){thrownewServiceException("Unabletodetermineepsgcodefor"+crs);
if(tl==null){thrownewServiceException("Notilelayerfor"+l.getName());
if(gridSubsets.isEmpty()){gridSubsets.addAll(theseGridSubsets);
else{gridSubsets.retainAll(theseGridSubsets);
if(gridSubsets.isEmpty()){thrownewServiceException("Nosuitable"+epsgCode+"gridsubsetfor"+req.getLayers());
if(gridSubsets.size()>1){
if(LOGGER.isLoggable(Level.WARNING)){StringBuildermsg=newStringBuilder("Foundmultiplegridsubsets:");for(GridSubsetgs:gridSubsets){msg.append(gs.getName()).append(",");
if(formatOpts.containsKey("min_zoom")){minZoom=Integer.parseInt(formatOpts.get("min_zoom").toString());
if(minZoom==null){minZoom=findClosestZoom(gridSet,req);
if(formatOpts.containsKey("max_zoom")){maxZoom=Integer.parseInt(formatOpts.get("max_zoom").toString());
else
if(formatOpts.containsKey("num_zooms")){maxZoom=minZoom+Integer.parseInt(formatOpts.get("num_zooms").toString());
if(maxZoom==null){//walkdownuntilwehittoomanytilesmaxZoom=findMaxZoomAuto(gridSubset,minZoom,req);
if(maxZoom<minZoom){thrownewServiceException(format("maxZoom(%d)cannotbelessthanminZoom(%d)",maxZoom,minZoom));
if(maxZoom>gridSet.getNumLevels()){LOGGER.warning(format("Maxzoom(%d)can'tbegreaterthannumberofzoomlevels(%d)",maxZoom,gridSet.getNumLevels()));maxZoom=gridSet.getNumLevels();
if(e>error){break;
else{error=e;
ifrequestisasinglecoveragelayerreturnjpeg,otherwiseusejustpngList<MapLayerInfo>layers=req.getLayers();
if(layers.size()==1&&layers.get(0).getType()==MapLayerInfo.TYPE_RASTER){returnJPEG_MIME_TYPE;
if(mapinstanceofRenderedImageMap){RenderedImageMapResponseresponse=JPEG_MIME_TYPE.equals(map.getMimeType())?newJPEGMapResponse(wms):newPNGMapResponse(wms);response.write(map,bout,null);
else
if(mapinstanceofRawMap){((RawMap)map).writeTo(bout);
if(objinstanceofMessage){Messageother=(Message)obj;
if(message==null){returnother.message==null;
ifthistestistoverifybehaviorofasimilar,butnotcomplete,formatprovided*bythestandardlibraries.TheincompletepatterndoesnotsupportBCdatesproperly,sowe*willnottestcompliancehere.**<p>Therandomseedisnotspecifiedtoallowvarioustestrunsbroadercoverage.*/@TestpublicvoidtestFormatterFuzz(){SimpleDateFormatdf=newSimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'");df.setTimeZone(TimeZone.getTimeZone("GMT"));ISO8601Formatterfmt=newISO8601Formatter();GregorianCalendarcal=newGregorianCalendar();Randomr=newRandom();for(inti=0;i<1000;i++){cal.set(Calendar.YEAR,1+r.nextInt(3000));cal.set(Calendar.DAY_OF_YEAR,1+r.nextInt(365));cal.set(Calendar.HOUR_OF_DAY,r.nextInt(24));cal.set(Calendar.MINUTE,r.nextInt(60));cal.set(Calendar.SECOND,r.nextInt(60));cal.set(Calendar.MILLISECOND,r.nextInt(1000));assertEquals(df.format(cal.getTime()),fmt.format(cal.getTime()));
if(type.equals("textual")){returnvisitor.produceOutput(value,type,pID,baseURL,xmppClient,publish,name,title,description,defaultStyle,targetWorkspace,metadata);
if(value!=null&&valueinstanceofString&&!((String)value).isEmpty()){returnvisitor.produceOutput(value,type,pID,baseURL,xmppClient,publish,name,title,description,defaultStyle,targetWorkspace,metadata);
ifanexceptionisnotthrownwhenisrequestedanimagewithatotalsize*lowerthanthemaximumgeoserveroutputsize.*/@TestpublicvoidtestOutputMemoryNotExceeded()throwsException{//Settingoftheoutputlimitto40KbsetOutputLimit(40);//httpresponsefromtherequestinsidethestringMockHttpServletResponseresponse=getAsServletResponse("ows?request=GetCoverage&service=WCS&version=2.0.1"+"&coverageId=wcs__NO2&format=application/x-netcdf&subset=http://www.opengis.net/def/axis/OGC/0/elevation(450)");//ThestatuscodeshouldbecorrectassertEquals(200,response.getStatus());//TheoutputformatshouldbenetcdfassertEquals("application/x-netcdf",response.getContentType());//ResetoutputlimitsetOutputLimit(-1);
ifanexceptionisthrownwhenisrequestedanimagewithatotalsize*greaterthanthemaximumgeoserveroutputmemoryallowed.*/@TestpublicvoidtestOutputMemoryExceeded()throwsException{//Settingoftheoutputlimitto40KbsetOutputLimit(40);//httpresponsefromtherequestinsidethestringMockHttpServletResponseresponse=getAsServletResponse("ows?request=GetCoverage&service=WCS&version=2.0.1"+"&coverageId=wcs__NO2&format=application/x-netcdf");//TheoutputformatshouldbexmlbecauseanexceptionmustbethrownassertEquals("application/xml",response.getContentType());//ResetoutputlimitsetOutputLimit(-1);
ifanexceptionisnotthrownwhenisrequestedanimagewithatotalsize*lowerthanthemaximumgeoserverinputsize.*/@TestpublicvoidtestInputMemoryCorrect()throwsException{//Settingoftheinputlimitto40KbsetInputLimit(40);//httpresponsefromtherequestinsidethestringMockHttpServletResponseresponse=getAsServletResponse("ows?request=GetCoverage&service=WCS&version=2.0.1"+"&coverageId=wcs__NO2&format=application/x-netcdf&subset=http://www.opengis.net/def/axis/OGC/0/elevation(450)");//ThestatuscodeshouldbecorrectassertEquals(200,response.getStatus());//TheoutputformatshouldbenetcdfassertEquals("application/x-netcdf",response.getContentType());//ResetinputlimitsetInputLimit(-1);
ifanexceptionisthrownwhenisrequestedanimagewithatotalsize*greaterthanthemaximumgeoserverinputmemoryallowed.*/@TestpublicvoidtestInputMemoryExceeded()throwsException{//Settingoftheinputlimitto40KbsetInputLimit(40);//httpresponsefromtherequestinsidethestringMockHttpServletResponseresponse=getAsServletResponse("ows?request=GetCoverage&service=WCS&version=2.0.1"+"&coverageId=wcs__NO2&format=application/x-netcdf");//TheoutputformatshouldbexmlbecauseanexceptionmustbethrownassertEquals("application/xml",response.getContentType());//ResetinputlimitsetInputLimit(-1);
if(eventinstanceofCatalogAddEvent)returntrue;
elsereturnfalse;
if(visible==false)palette.getModelCollection().clear();
if"Selected"isnotillustrativeenough*/protectedStringgetSelectedHeaderPropertyKey(){return"MimeTypesFormComponent.selectedHeader";
if"Available"isnotillustrativeenough*/protectedStringgetAvaliableHeaderPropertyKey(){return"MimeTypesFormComponent.availableHeader";
if(palette.getRecorderComponent()==null){//stageforthemforlatertoAdd.addAll(Arrays.asList(behaviors));
else{//addthemnowpalette.getRecorderComponent().add(behaviors);
if(palette.getRecorderComponent()!=null)palette.getRecorderComponent().updateModel();}}
if(!f.exists()){return;
iftheSAVEwassuccessfultester.assertRenderedPage(RepositoriesPage.class);
if(!(crsinstanceofCoordinateReferenceSystem)||(crs==null)){crs=DefaultGeographicCRS.WGS84;
if((value!=null)&&(valueinstanceofNumber)){m_dNoDataValue=((Number)value).doubleValue();return;
else{finalGridSampleDimension[]dimList=gc.getSampleDimensions();double[]noDataList;for(inti=0;i<dimList.length;i++){noDataList=dimList[i].getNoDataValues();
if((noDataList!=null)&&(noDataList.length>0)){m_dNoDataValue=noDataList[0];return;
if(objinstanceofGridCoverage2D){m_BaseDataObject=obj;finalGridCoverage2Dgc=((GridCoverage2D)obj);m_CRS=gc.getCoordinateReferenceSystem();finalEnvelope2Denv=gc.getEnvelope2D();m_LayerExtent=newAnalysisExtent();m_LayerExtent.setCellSize((env.getMaxX()-env.getMinX())/gc.getRenderedImage().getWidth());m_LayerExtent.setXRange(env.getMinX(),env.getMaxX(),true);m_LayerExtent.setYRange(env.getMinY(),env.getMaxY(),true);m_image=(PlanarImage)gc.getRenderedImage();m_sName=gc.getName().toString();m_dNoDataValue=-99999;//->Defaultvaluein'OutputFactory::getDefaultNoDataValue()'.initNoData(gc);
if(m_BaseDataObject!=null){finalGridCoverage2Dgc=(GridCoverage2D)m_BaseDataObject;returngc.getNumSampleDimensions();
else{return0;
if(m_image!=null){returngetTile(x,y).getSampleDouble(x,y,band);
else{returngetNoDataValue();
if(m_image!=null){returnm_image.getTile(0,0).getDataBuffer().getDataType();
else{returnDataBuffer.TYPE_DOUBLE;
if(m_LayerExtent!=null){returnm_LayerExtent.getCellSize();
else{return0;
if(isInWindow(x,y)){finalRasterraster=getTile(x,y);
if(rasterinstanceofWritableRaster){((WritableRaster)raster).setSample(x,y,band,value);
if(m_BaseDataObject!=null){finalGridCoverage2Dgc=(GridCoverage2D)m_BaseDataObject;returnnewEnvelope2D(gc.getEnvelope());
else{returnnull;
if(locker!=null){ThreadconfigWriter=newThread("Config-writer"){publicvoidrun(){//AcquiringConfigurationLockasanotheruserlocker.lock(type);acquired.set(true);try{while(!release.get()){Thread.sleep(50);
if(userObject.getPassword()!=null){user.setAttribute(A_USER_PASSWORD_UR,userObject.getPassword());
if(userObjects!=null){for(GeoServerUseruserObject:userObjects){Elementmember=doc.createElement(E_MEMBER_UR);group.appendChild(member);member.setAttribute(A_MEMBER_NAME_UR,userObject.getUsername());
if(isValidatingXMLSchema()){//XMLValidator.Singleton.validateUserGroupRegistry(doc);//
if(lockFile!=null)return;//wehaveonelockFile=newLockFile(userResource);try{lockFile.writeLock();
if(lockFile==null)return;//wehavenonelockFile.writeUnLock();lockFile=null;
if(obj==null){returnnull;
if(!EMFUtils.has((EObject)obj,prop)){returnnull;
ifwerequirebuildingsitself,itshouldfailxml="<wfs:GetFeature"+"service=\"WFS\""+"version=\"1.0.0\""+"xmlns:cdf=\"http://www.opengis.net/cite/data\""+"xmlns:ogc=\"http://www.opengis.net/ogc\""+"xmlns:wfs=\"http://www.opengis.net/wfs\""+">"+"<wfs:QuerytypeName=\""+getLayerId(SystemTestData.BUILDINGS)+"\"/>"+"</wfs:GetFeature>";doc=postAsDOM("wfs",xml);assertEquals("ServiceExceptionReport",doc.getDocumentElement().getNodeName());
ifwerequirebuildingsitself,itshouldfailxml="<wfs:GetFeature"+"service=\"WFS\""+"version=\"1.1.0\""+"xmlns:cdf=\"http://www.opengis.net/cite/data\""+"xmlns:ogc=\"http://www.opengis.net/ogc\""+"xmlns:wfs=\"http://www.opengis.net/wfs\""+">"+"<wfs:QuerytypeName=\""+getLayerId(SystemTestData.BUILDINGS)+"\"/>"+"</wfs:GetFeature>";doc=postAsDOM("wfs",xml);assertEquals("ows:ExceptionReport",doc.getDocumentElement().getNodeName());}}
ifGeoServerlogstostdout.*/booleanisStdOutLogging();/**Setsstdoutloggingflag.*/voidsetStdOutLogging(booleansupressStdOutLogging);}
if(request!=null){Map<String,?>formatOptions=request.getFormatOptions();filename=(String)formatOptions.get("FILENAME");
if(filename==null){filename=newFileNameSource(getClass()).getZipName(ftInfo);
if(filename==null){filename=ftInfo.getName();
ifanemptyresultoutoffeaturetypewithunknowngeometryiscreated,the//zipfilewillbeemptyandthezipoutputstreamwillbreakbooleanshapefileCreated=false;for(SimpleFeatureCollectioncollection:collections){shapefileCreated|=dumper.dump(collection);
if(!shapefileCreated){createEmptyZipWarning(tempDir);
if(request==null||gft==null){//we'reprobablyrunninginaunittestreturn;
if(request.isGet()){finalHttpServletRequesthttpRequest=request.getHttpRequest();StringbaseUrl=ResponseUtils.baseURL(httpRequest);Stringpath=request.getPath();//encodeproxyurl
ifexistingStringmangledUrl=ResponseUtils.buildURL(baseUrl,path,null,URLType.SERVICE);StringBuilderurl=newStringBuilder();Stringparameters=httpRequest.getQueryString();url.append(mangledUrl).append("?").append(parameters);FileUtils.writeStringToFile(target,url.toString());
else{org.geotools.xml.Configurationcfg=null;QNameelementName=null;
if(gft.getVersion().equals("1.1.0")){cfg=newWFSConfiguration();elementName=WFS.GetFeature;
else{cfg=neworg.geotools.wfs.v1_0.WFSConfiguration();elementName=org.geotools.wfs.v1_0.WFS.GetFeature;
if(fos!=null)fos.close();
if(ftInfo==null){//SGthefcmighthavebeengeneratedbytheWPSthereforethereisnosuchathing//insidetheGeoServercataloguefinalSimpleFeatureSourcefeatureSource=DataUtilities.source(newListFeatureCollection(schema));finalCatalogBuildercatalogBuilder=newCatalogBuilder(catalog);catalogBuilder.setStore(catalogBuilder.buildDataStore(schema.getName().getLocalPart()));ftInfo=catalogBuilder.buildFeatureType(featureSource);
iftherequestoriginatesfromtheWPSwewon'tactuallyhaveanyGetFeatureTyperequest
if(request==null){return;
if(null==requestedPrjFileFormat){WFSInfobean=gs.getService(WFSInfo.class);MetadataMapmetadata=bean.getMetadata();BooleandefaultIsEsri=metadata.get(SHAPE_ZIP_DEFAULT_PRJ_IS_ESRI,Boolean.class);useEsriFormat=defaultIsEsri!=null&&defaultIsEsri.booleanValue();
else{useEsriFormat="ESRI".equalsIgnoreCase(requestedPrjFileFormat);
if(useEsriFormat){replaceOGCPrjFileByESRIPrjFile(tempDir,fileName,remappedSchema);
if(epsgCode==null){LOGGER.info("Can'tfindtheEPSGcodefortheshapefileCRS");return;
if(file.getType()==Type.RESOURCE){Propertiesproperties=newProperties();InputStreamfis=null;try{fis=file.in();properties.load(fis);
if(data!=null){FileprjShapeFile=newFile(tempDir,fileName+".prj");prjShapeFile.delete();BufferedWriterout=newBufferedWriter(newFileWriter(prjShapeFile));try{out.write(data);
else{LOGGER.info("RequestedshapefilewithESRIWKT.prjformatbutcouldn'tfindanentryforESPGcode"+epsgCode+"inesri.properties");
else{LOGGER.info("RequestedshapefilewithESRIWKT.prjformatbuttheesri.propertiesfiledoesnotexistintheuser_projectionsdirectory");
ifnonewasspecified*/privateCharsetgetShapefileCharset(OperationgetFeature){Charsetresult=null;GetFeatureRequestgft=GetFeatureRequest.adapt(getFeature.getParameters()[0]);
if(gft.getFormatOptions()!=null&&gft.getFormatOptions().get("CHARSET")!=null){result=(Charset)gft.getFormatOptions().get("CHARSET");
else{finalStringcharsetName=GeoServerExtensions.getProperty(GS_SHAPEFILE_CHARSET,applicationContext);
if(charsetName!=null)result=Charset.forName(charsetName);
ifnotspecifiedlet'susetheshapefiledefaultonereturnresult!=null?result:Charset.forName("ISO-8859-1");
if(Dispatcher.REQUEST.get()!=null){timestamp=Dispatcher.REQUEST.get().getTimestamp();
else{timestamp=newDate();
if(filename==null){filename=getTypeName(ftInfo);
if(filename==null){filename=getTypeName(ftInfo)+geometryType;
if(filename==null){filename=getTypeName(ftInfo);
ifit'snotfoundwe'llgeta404nota200dom=getAsDOM("wfs?request=GetFeature&version=2.0.0&storedQueryId="+StoredQuery.DEFAULT.getName()+"&ID=PrimitiveGeoFeatureId.gmlsf0-f01",200);
if(Geometry.class.isAssignableFrom(attr.getBinding())){ftb.add(attr.getName(),attr.getBinding(),fti.getCRS());
else{ftb.add(attr.getName(),attr.getBinding());
if(lg.getName().equals(name)){catalog.remove(lg);
if(isUnprocessed(coverage)){this.sourceFile=getSourceFile(coverage);
ifthecoverage*/privateFilegetSourceFile(GridCoverage2Dcoverage){finalObjectfileSource=coverage.getProperty(AbstractGridCoverage2DReader.FILE_SOURCE_PROPERTY);
if(fileSource!=null&&fileSourceinstanceofString){Filefile=newFile((String)fileSource);
if(file.exists()){GeoTiffReaderreader=null;try{reader=newGeoTiffReader(file);GeneralEnvelopeoriginalEnvelope=reader.getOriginalEnvelope();Envelopeenvelope=coverage.getEnvelope();
if(originalEnvelope.equals(envelope,1e-9,false)){GridCoverage2Dtest=reader.read(null);ImageUtilities.disposeImage(test.getRenderedImage());returnfile;
if(reader!=null){reader.dispose();
if(gr.getSpan(0)<tileWidth){tileWidth=gr.getSpan(0);
if(gr.getSpan(1)<tileHeight){tileHeight=gr.getSpan(1);
ifit'sreallyjustcopyingoveraGeoTiffsourcefileandruna*straightfilecopy,callthismethod
ifthesourcecopyshouldbeturnedoff*/publicvoiddisableSourceCopyOptimization(){this.sourceFile=null;
if(sourceFile!=null){FileUtils.copyFile(sourceFile,stream);
else{CoordinateReferenceSystemcrs=coverage.getCoordinateReferenceSystem();booleanunreferenced=crs==null||crsinstanceofEngineeringCRS;
if(unreferenced){RenderedImageri=coverage.getRenderedImage();inttileWidth,tileHeight;
if(imageIoWriteParams.getTilingMode()==GeoToolsWriteParams.MODE_EXPLICIT){tileWidth=imageIoWriteParams.getTileWidth();tileHeight=imageIoWriteParams.getTileHeight();
else{tileWidth=ri.getTileWidth();tileHeight=ri.getTileHeight();
if(imageIoWriteParams.getCompressionMode()==GeoToolsWriteParams.MODE_EXPLICIT){compression=imageIoWriteParams.getCompressionType();quality=imageIoWriteParams.getCompressionQuality();
else{finalGeneralParameterValue[]wps=(GeneralParameterValue[])geotoolsWriteParams.values().toArray(newGeneralParameterValue[geotoolsWriteParams.values().size()]);//writeoutthecoverageAbstractGridCoverageWriterwriter=(AbstractGridCoverageWriter)TIFF_FORMAT.getWriter(stream);
if(writer==null)thrownewServiceException("CouldnotfindtheGeoTIFFwriter,pleasecheckit'sintheclasspath");try{writer.write(coverage,wps);
ifthecoveragehasnotbeenprocessedinanywaysinceithasbeenread**@paramcoverage*/privatebooleanisUnprocessed(GridCoverage2Dcoverage){RenderedImageri=coverage.getRenderedImage();
if(riinstanceofRenderedOp){RenderedOpop=(RenderedOp)ri;returnop.getOperationName().startsWith("ImageRead");
else
if(riinstanceofOpImage){returnri.getClass().getSimpleName().startsWith("ImageRead");
else{returntrue;
if("available".equalsIgnoreCase(list)||"available_with_geom".equalsIgnoreCase(list)||"all".equalsIgnoreCase(list)){DataStoreInfoinfo=getExistingDataStore(workspaceName,storeName);//flagtocontrolwhethertofilterouttypeswithoutgeometrybooleanskipNoGeom="available_with_geom".equalsIgnoreCase(list);//listofavailablefeaturetypesList<String>featureTypes=newArrayList<>();try{DataStoreds=(DataStore)info.getDataStore(null);String[]featureTypeNames=ds.getTypeNames();for(StringfeatureTypeName:featureTypeNames){FeatureTypeInfoftinfo=catalog.getFeatureTypeByDataStore(info,featureTypeName);
if(ftinfo==null){//Thefeaturetypeisnotincatalog,soaddittothereturnlist.//checkwhethertofilterbygeometry
if(skipNoGeom){try{FeatureTypefeatureType=ds.getSchema(featureTypeName);
if(featureType.getGeometryDescriptor()==null){//skipcontinue;
else
if("all".equalsIgnoreCase(list)){//Thefeaturetypeisalreadyconfigured,but"all"wasspecified,soadd//ittothereturnlist.featureTypes.add(featureTypeName);
else{List<FeatureTypeInfo>fts;
if(storeName!=null){DataStoreInfodataStore=catalog.getDataStoreByName(workspaceName,storeName);fts=catalog.getFeatureTypesByDataStore(dataStore);
else{NamespaceInfons=catalog.getNamespaceByPrefix(workspaceName);fts=catalog.getFeatureTypesByNamespace(ns);
if(ftInfo.getStore()!=null&&storeName!=null){
if(!storeName.equals(ftInfo.getStore().getName())){thrownewRestException("Expecteddatastore"+storeName+"butclientspecified"+ftInfo.getStore().getName(),HttpStatus.FORBIDDEN);
else{ftInfo.setStore(dsInfo);
if(ftInfo.getNamespace()!=null){
if(!workspaceName.equals(ftInfo.getNamespace().getPrefix())){thrownewRestException("Expectedworkspace"+workspaceName+"butclientspecified"+ftInfo.getNamespace().getPrefix(),HttpStatus.FORBIDDEN);
else{ftInfo.setNamespace(catalog.getNamespaceByPrefix(workspaceName));
if(dataAccessinstanceofDataStore){StringtypeName=ftInfo.getName();
if(ftInfo.getNativeName()!=null){typeName=ftInfo.getNativeName();
if(name.equals(typeName)){typeExists=true;break;
ifthisisavirtualJDBCfeaturetypeMetadataMapmdm=ftInfo.getMetadata();booleanvirtual=mdm!=null&&mdm.containsKey(FeatureTypeInfo.JDBC_VIRTUAL_TABLE);
if(!virtual&&!typeExists){dataStore.createSchema(buildFeatureType(ftInfo));//theattributescreatedmightnotmatchup1-1withtheactualspecdueto//limitationsofthedatastore,haveitre-computethemftInfo.getAttributes().clear();List<String>typeNames=Arrays.asList(dataStore.getTypeNames());//handleOracleoddities//TODO:usetheincomingstorecapabilitesAPItobetterhandlethename//transformation
if(!typeNames.contains(typeName)&&typeNames.contains(typeName.toUpperCase())){ftInfo.setNativeName(ftInfo.getName().toLowerCase());
if(featureSource!=null){cb.setupMetadata(ftInfo,featureSource);
if(ftInfo.getStore()==null){//getfromrequestsftInfo.setStore(dsInfo);
if(ns!=null&&!ns.getPrefix().equals(workspaceName)){//TODO:changethisoncethetwocanbedifferentandweuntienamespace//fromworkspaceLOGGER.warning("Namespace:"+ns.getPrefix()+"doesnotmatchworkspace:"+workspaceName+",overriding.");ns=null;
if(ns==null){//inferfromworkspacens=catalog.getNamespaceByPrefix(workspaceName);ftInfo.setNamespace(ns);
if(storeName==null){uriComponents=builder.path("/workspaces/{workspaceName}/featuretypes/{featureTypeName}").buildAndExpand(workspaceName,ftInfo.getName());
else{uriComponents=builder.path("/workspaces/{workspaceName}/datastores/{storeName}/featuretypes/{featureTypeName}").buildAndExpand(workspaceName,storeName,ftInfo.getName());
if(!virtual&&parameters.equals(parametersCheck)){LOGGER.info("PUTFeatureType"+storeName+","+featureTypeName+"updatedmetadataonly");
else{LOGGER.info("PUTfeatureType"+storeName+","+featureTypeName+"updatedmetadataanddataaccess");catalog.getResourcePool().clear(ftInfo.getStore());
if(recurse){//byrecurseweclearoutallthelayersthatpublicthisresourcefor(LayerInfol:layers){catalog.remove(l);LOGGER.info("DELETElayer"+l.getName());
else{
if(!layers.isEmpty()){thrownewRestException("featuretypereferencedbylayer(s)",HttpStatus.FORBIDDEN);
if(featureType==null&&storeName==null){thrownewResourceNotFoundException(String.format("Nosuchfeaturetype:%s,%s",workspaceName,featureTypeName));
else
if(featureType==null){thrownewResourceNotFoundException(String.format("Nosuchfeaturetype:%s,%s,%s",workspaceName,storeName,featureTypeName));
if(original==null){thrownewResourceNotFoundException("Nosuchdatastore:"+workspaceName+","+storeName);
if(fti.getName()==null){thrownewRestException("Tryingtocreatenewfeaturetypeinsidethestore,"+"butnofeaturetypenamewasspecified",HttpStatus.BAD_REQUEST);
else
if(fti.getAttributes()==null||fti.getAttributes()==null){thrownewRestException("Tryingtocreatenewfeaturetypeinsidethestore,"+"butnoattributeswerespecified",HttpStatus.BAD_REQUEST);
if(fti.getNativeName()!=null){builder.setName(fti.getNativeName());
else{builder.setName(fti.getName());
if(fti.getNativeCRS()!=null){builder.setCRS(fti.getNativeCRS());
else
if(fti.getCRS()!=null){builder.setCRS(fti.getCRS());
else
if(fti.getSRS()!=null){builder.setSRS(fti.getSRS());
if(ati.getLength()!=null&&ati.getLength()>0){builder.length(ati.getLength());
if("GET".equalsIgnoreCase(method)){persister.setHideFeatureTypeAttributes();
if(workspace==null||datastore==null||featuretype==null){returnnull;
if(ds==null){returnnull;
if(objinstanceofNamespaceInfo){NamespaceInfons=(NamespaceInfo)obj;converter.encodeLink("/namespaces/"+converter.encode(ns.getPrefix()),writer);
if(objinstanceofDataStoreInfo){DataStoreInfods=(DataStoreInfo)obj;converter.encodeLink("/workspaces/"+converter.encode(ds.getWorkspace().getName())+"/datastores/"+converter.encode(ds.getName()),writer);
if(res.name().endsWith(".properties")){returntrue;
if(res.name().endsWith(".template")){returntrue;
if(res.name().endsWith(".xml")){returntrue;
if(fail)fail("NoruntimeexceptionforreadonlyUserGroupService");
if(MediaType.APPLICATION_XML.isCompatibleWith(contentType)){writeXML(availableResources,outputMessage);
else
if(MediaType.APPLICATION_JSON.isCompatibleWith(contentType)){writeJSON(availableResources,outputMessage);
else{thrownewIllegalArgumentException();
if(message.contains(expectedMessage)){concurrentLoginsPrevented.incrementAndGet();
if(excess>0){excessPercentage=(int)Math.round((excess*progressWidth)/used);usedPercentage=progressWidth-excessPercentage;
else{usedPercentage=(int)Math.round(used*progressWidth/limit);excessPercentage=0;
if(enabled){TimeVersioning.enable(featureType,idProperty,timeProperty);
else{TimeVersioning.disable(featureType);
if(featureType==null){thrownewRuntimeException(String.format("Featuretype'%s'notfound.",featureTypeName));
if(name==null||!name.equals(expectedName)){returnfalse;
if(time==null&&expectedTime==null){returntrue;
if(time==null||expectedTime==null){returnfalse;
if(rule!=null){
if(result.contains(rule))LOGGER.warning("Rule"+ruleKey+"."+ruleValue+"overwritesanotherruleonthesamepath");result.add(rule);
iftheset
ifempty
if(result.size()==0){result.add(newServiceAccessRule(newServiceAccessRule()));
ifthe*ruleisnotvalid*/ServiceAccessRuleparseServiceAccessRule(StringruleKey,StringruleValue){finalStringrule=ruleKey+"="+ruleValue;//parseString[]elements=parseElements(ruleKey);
if(elements.length!=2){LOGGER.warning("Invalidrule"+rule+",theexpectedformatisservice.method=role1,role2,...");returnnull;
if(ANY.equals(service)){
if(!ANY.equals(method)){LOGGER.warning("Invalidrule"+rule+",whennamespace"+"is*thenalsolayermustbe*.Skippingrule"+rule);returnnull;
if(rule.getRoles().contains(role))result.add(rule);returnresult;}}
if(rule.isElseFilter()){elseSymbolizers.addAll(rule.symbolizers());
else
if(rule.getFilter()==null||rule.getFilter().evaluate(sf)){symbolizers.addAll(rule.symbolizers());
elsefiltersareactivatedonly
iftheregularrulesarenotcatchingthestyle
if(symbolizers.size()==0){returnelseSymbolizers;
else{returnsymbolizers;
if(propertyNames==null||propertyNames.length==0){//nopropertyselection,wereturnthemallq.setProperties(Query.ALL_PROPERTIES);
else{//propertiesgotselected,mixthemwiththeonesneededbytherenderer
if(query.getPropertyNames()==null||query.getPropertyNames().length==0){q.setPropertyNames(propertyNames);
else{Set<String>names=newLinkedHashSet<>(Arrays.asList(propertyNames));names.addAll(Arrays.asList(q.getPropertyNames()));String[]newNames=names.toArray(newString[names.size()]);q.setPropertyNames(newNames);
if(locks==null){returnnull;
if(user==null)returnnull;try{Stringdecoded=encoder.decode(user.getPassword());returnnewUserDetailsPasswordWrapper(user,decoded);
if(CONNECTION_JNDI.equals(connectionType)){factory=newPostgisNGJNDIDataStoreFactory();fillInJndiParams(params,jndiParamPanel);
else{factory=newPostgisNGDataStoreFactory();//basicparamsparams.put(HOST.key,basicParamPanel.host);params.put(PostgisNGDataStoreFactory.PORT.key,basicParamPanel.port);params.put(USER.key,basicParamPanel.username);params.put(PASSWD.key,basicParamPanel.password);params.put(DATABASE.key,basicParamPanel.database);params.put(JDBCDataStoreFactory.SCHEMA.key,basicParamPanel.schema);//connectionpoolparamsfillInConnPoolParams(params,basicParamPanel);
if(status!=null){builder.append("");builder.append(status.value());builder.append("");builder.append(status.name());
if(message!=null){builder.append(":");builder.append(message);
ifastringcontainscharsthatneedtobeturnedintoanxmlentity,even
if*thestringhaslineendsinsideofit(thustheDOTALLflag)*/privatestaticfinalPatternXML_ENTITIES=Pattern.compile(".*[\"&'<>]+.*",Pattern.DOTALL);/**Theoutputwriter.*/protectedWriterwriter;protectedintindent;protectedStringBufferindentBuffer=newStringBuffer();/***WriterUtilsconstructor.**<p>Shouldneverbecalled.*/protectedWriterHelper(){}/***WriterUtilsconstructor.**<p>Storesthespecifiedwritertouseforoutput.**@paramwriterthewriterwhichwillbeusedforoutputingthexml.*/publicWriterHelper(Writerwriter){this.writer=writer;
if(indent>0){indent-=2;indentBuffer.setLength(indentBuffer.length()-2);
if(attributes.get(s)!=null){sb.append(s+"="+"\""+escape((attributes.get(s)).toString())+"\"");
if(attributes.get(s)!=null){sb.append(s+"="+"\""+escape((attributes.get(s)).toString())+"\"");
if(attributes.get(s)!=null){sb.append(s+"="+"\""+escape((attributes.get(s)).toString())+"\"");
if(data!=null)escapedData=escape(data);sb.append(">"+escapedData+"</"+tagName+">");writeln(sb.toString());
if(XML_ENTITIES.matcher(s).matches()){s=s.replaceAll("&","&amp;");s=s.replaceAll("\"","&quot;");s=s.replaceAll("'","&apos;");s=s.replaceAll("<","&lt;");s=s.replaceAll(">","&gt;");
if(super.isAccessAllowed(componentClass,authentication)){returntrue;
if(idinstanceofResourceId){FilternewFilter=buildVersioningFilter(filterFactory,(ResourceId)id);versioningFilter=addFilter(filterFactory,versioningFilter,newFilter);
else{finalIds.add(id);
if(finalIds.isEmpty()){returnversioningFilter;
if(versioningFilter!=null){returnfilterFactory.and(newIdFilter,versioningFilter);
if(idFilter!=null&&timeFilter!=null){returnfilterFactory.and(idFilter,timeFilter);
if(idFilter!=null){returnidFilter;
if(timeFilter!=null){returntimeFilter;
if(id==null){returnnull;
if(id.startsWith(prefix)){id=id.substring(prefix.length());
else{//wasnotgeneratedbyGeoServerreturnFilter.EXCLUDE;
if(start!=null&&end!=null){returnfilterFactory.or(after,before);
if(start!=null){returnafter;
if(end!=null){returnbefore;
if(versioningFilter!=null){returnfilterFactory.or(versioningFilter,filter);
if(filter==null){returnnull;
if(!(oinstanceofDescribeCoverageType)){thrownewIllegalArgumentException(newStringBuffer("NotaDescribeCoverageType:").append(o).toString());
if(availableDescribeCoverageExtensions){for(WCS20DescribeCoverageExtensionext:wcsDescribeCoverageExtensions){newCoverageID=ext.handleCoverageId(newCoverageID);
if(layer!=null){coverages.add((CoverageInfo)layer.getResource());covIds.add(encodedCoverageId);
else{//
ifwegettherethereisaninternalerror,thecoverageexistenceis//checkedbeforecreatingthetransformerthrownewIllegalArgumentException("Failedtolocatecoverage"+encodedCoverageId+",unexpected,thecoverageexistancehasbeen"+"checkedearlierintherequestlifecycle");
if(availableDescribeCoverageExtensions){for(WCS20DescribeCoverageExtensionext:wcsDescribeCoverageExtensions){newCoverageID=ext.handleEncodedId(location,newCoverageID);ciNew=ext.handleCoverageInfo(covIds.get(coverageIndex),ci);
else{newCoverageID=encodedId;
ifwehavetohandletime,elevationandadditionaldimensionsWCSDimensionsHelperdimensionsHelper=null;MetadataMapmetadata=ci.getMetadata();Map<String,DimensionInfo>dimensionsMap=WCSDimensionsHelper.getDimensionsFromMetadata(metadata);//Setupadimensionhelperincasewefoundsomedimensionsforthatcoverage
if(!dimensionsMap.isEmpty()){dimensionsHelper=newWCSDimensionsHelper(dimensionsMap,RequestUtils.getCoverageReader(ci),encodedId);
if(reader==null){thrownewWCS20Exception("Unabletoreadsamplecoveragefor"+ci.getName());
if(EPSGCode==null){thrownewIllegalStateException("UnabletolookupepsgcodeforthisCRS:"+crs);
if(dimensionsHelper!=null&&dimensionsHelper.getElevationDimension()!=null){builder.append("elevation");
if(dimensionsHelper!=null&&dimensionsHelper.getTimeDimension()!=null){builder.append("time");
if(coverage!=null){CoverageCleanerCallback.addCoverages(coverage);
if(nullValues!=null&&!nullValues.isEmpty()){finalintsize=nullValues.size();double[]noDataValues=newdouble[size];for(inti=0;i<size;i++){noDataValues[i]=nullValues.get(i);
if(descriptor.getStyledLayers().length>0){StyledLayerlayer=descriptor.getStyledLayers()[0];assertTrue(layerinstanceofNamedLayer);NamedLayernamedLayer=(NamedLayer)layer;assertNotNull(namedLayer.getStyles());assertEquals(1,namedLayer.getStyles().length);Stylestyle=namedLayer.getStyles()[0];assertNotNull(style.featureTypeStyles().toArray(newFeatureTypeStyle[0]));assertEquals(1,style.featureTypeStyles().toArray(newFeatureTypeStyle[0]).length);FeatureTypeStylefeatureTypeStyle=style.featureTypeStyles().toArray(newFeatureTypeStyle[0])[0];assertNotNull(featureTypeStyle.rules().toArray(newRule[0]));returnfeatureTypeStyle.rules().toArray(newRule[0]);
else{returnnull;
if(ppios.isEmpty()){LOGGER.log(Level.INFO,"Blacklistingprocess"+name.getURI()+"astheinput"+p.key+"oftype"+p.type+"cannotbehandled");processBlacklist.add(name);
if(ppios.isEmpty()){LOGGER.log(Level.INFO,"Blacklistingprocess"+name.getURI()+"astheoutput"+p.key+"oftype"+p.type+"cannotbehandled");processBlacklist.add(name);
if(!processBlacklist.contains(name)){count++;
if(webUIModeModel.getObject()==null){webUIModeModel.setObject(GeoServerInfo.WebUIMode.DEFAULT);
if(logsDirectory.getType()==Type.DIRECTORY){List<Resource>propFiles=Resources.list(logsDirectory,newFilter<Resource>(){@Overridepublicbooleanaccept(Resourceobj){returnobj.name().toLowerCase().endsWith("logging.properties");
ifnoneisfoundusethedefaultset
if(logProfiles==null||logProfiles.size()==0)logProfiles=DEFAULT_LOG_PROFILES;form.add(newListChoice<String>("log4jConfigFile",newPropertyModel<String>(loggingInfoModel,"level"),logProfiles));
if(null==svgRendererTypeSetting){svgRendererTypeSetting=WMS.SVG_SIMPLE;
if(unparsed.size()<4){thrownewWcsException("Requestedboundingboxcontainswrong"+"numberofcoordinates(shouldhaveatleast4):"+unparsed.size(),WcsExceptionCode.InvalidParameterValue,"BoundingBox");
ifitdoes,storetheminanarrayofdoublesintsize=unparsed.size();Double[]lower=newDouble[(int)Math.floor(size/2.0)];Double[]upper=newDouble[lower.length];for(inti=0;i<lower.length;i++){try{lower[i]=Double.parseDouble((String)unparsed.get(i));
if(unparsed.size()%2==1){crsName=(String)unparsed.get(unparsed.size()-1);try{
if("urn:ogc:def:crs:OGC:1.3:CRS84".equals(crsName)){crsName="EPSG:4326";
else{crs=CRS.decode(crsName);
if(crs.getCoordinateSystem().getDimension()!=lower.length)thrownewWcsException("CRSspecifiedhasdimension"+crs.getCoordinateSystem().getDimension()+"butbboxspecifiedhas"+lower.length,InvalidParameterValue,"BoundingBox");
if(entry.getName().equalsIgnoreCase(entryName)){try(InputStreamstream=zipFile.getInputStream(entry)){returnImageIO.read(stream);
ifcalled*multipletimes.*/@TestpublicvoidtestNoSideEffectsOnGetFinalUrl()throwsException{GetMapRequestrequest=neworg.geotools.data.wms.WMS1_0_0().createGetMapRequest(newURL("http://test?"));SecuredGetMapRequestsecuredRequest=newSecuredGetMapRequest(request);LayerwmsLayer=newLayer();wmsLayer.setName("layer1");Layerlayer=newSecuredWMSLayer(wmsLayer,WrapperPolicy.hide(null));securedRequest.addLayer(layer);StringfirstCallURL=securedRequest.getFinalURL().toExternalForm();StringsecondCallURL=securedRequest.getFinalURL().toExternalForm();assertEquals(firstCallURL,secondCallURL);}}
if(resourceinstanceofFeatureTypeInfo){List<AttributeTypeInfo>attrTypes;try{attrTypes=((FeatureTypeInfo)resource).attributes();for(AttributeTypeInfoattr:attrTypes){
if(attr.getName().equals(attrName)){attrType=attr.getBinding();break;
if(res.equals(CalcResult.NULL_RESULT)){returnnull;
else{returnConverters.convert(res.getValue(),clz);
if(fixedCapabilitiesValue!=null){returnthis.fixedCapabilitiesValue;
else{returnsuper.getCapabilitiesRepresentation(resource,dimensionName,dimensionInfo);
if(version==null||!version.startsWith("2.0")){return;
if(!TimeVersioning.isEnabled(featureTypeInfo)){//timeversioningisnotenabledforthisfeaturetypeorisnotaWFS2.0requestreturn;
if(sorts==null){sorts=newSortBy[]{sort};
else{sorts=Arrays.copyOf(sorts,sorts.length+1);sorts[sorts.length-1]=sort;
if(TimeVersioning.isEnabled(featureTypeInfo)){StringtimePropertyName=TimeVersioning.getTimePropertyName(featureTypeInfo);AttributeDescriptorattributeDescriptor=feature.getType().getDescriptor(timePropertyName);ObjecttimeValue=Converters.convert(date,attributeDescriptor.getType().getBinding());feature.setAttribute(timePropertyName,timeValue);
ifitcouldbeoptimizedinasingledbquery)*/privateList<SimpleFeature>getMostRecentFeatures(SimpleFeatureCollectiontimeSortedFeatures,FeatureTypeInfofeatureTypeInfo){StringnameProperty=TimeVersioning.getNamePropertyName(featureTypeInfo);Map<Object,SimpleFeature>featuresIndexedById=newHashMap<>();try(SimpleFeatureIteratoriterator=timeSortedFeatures.features()){while(iterator.hasNext()){SimpleFeaturefeature=iterator.next();Objectid=feature.getAttribute(nameProperty);featuresIndexedById.putIfAbsent(id,feature);
ifthefeaturetypeisversioned,leaveitas*isotherwise*/privateTransactionElementtransformUpdate(TransactionRequestrequest,Updateupdate,DatereferenceTime)throwsIOException{FeatureTypeInfofeatureTypeInfo=getFeatureTypeInfo(newNameImpl(update.getTypeName()));
if(!TimeVersioning.isEnabled(featureTypeInfo)){returnupdate;
if(featureTypeInfo==null){thrownewRuntimeException(String.format("Couldn'tfindfeaturetypeinfo''%s.",featureTypeName));
if(typeName.getNamespaceURI()!=null){namespaceURI=typeName.getNamespaceURI();
else{namespaceURI=catalog.getDefaultNamespace().getURI();
if(meta==null){Stringmsg="Featuretype'"+name+"'isnotavailable:";thrownewWFSTransactionException(msg,(String)null,update.getHandle());
if(request.getVersion()==null||!request.getVersion().startsWith("2.0")){returnrequest;
if(elementinstanceofInsert){for(Objectof:((Insert)element).getFeatures()){
if(ofinstanceofSimpleFeature){setTimeAttribute((SimpleFeature)of,referenceTime);
else
if(elementinstanceofUpdate){try{TransactionElementtransformed=transformUpdate(request,(Update)element,referenceTime);newElements.add(transformed);
else
if(elementinstanceofDelete){Deletedelete=(Delete)element;FeatureTypeInfofeatureTypeInfo=getFeatureTypeInfo(newNameImpl(delete.getTypeName()));
if(TimeVersioning.isEnabled(featureTypeInfo)){Filterfilter=delete.getFilter();FilteradaptedFilter=VersioningFilterAdapter.adapt(featureTypeInfo,filter);delete.setFilter(adaptedFilter);
else
if(elementinstanceofReplace){newElements.add(element);
if(role==null)role=newGeoServerRole("");Formform=newForm("form",newCompoundPropertyModel(role));add(form);StringResourceModeldescriptionModel;
if(role.getUserName()!=null){descriptionModel=newStringResourceModel("personalizedRole",getPage()).setParameters(role.getUserName());
else{descriptionModel=newStringResourceModel("anonymousRole",getPage());
if(e.getCause()instanceofAbstractSecurityException){error(e.getCause());
else{error(newParamResourceModel("saveError",getPage(),e.getMessage()).getObject());
if(role!=null&&StringUtils.hasLength(role.getAuthority())){//filteroutrolesalreadyusedasparentsRoleHierarchyHelperhelper=newRoleHierarchyHelper(parentMappings);Set<String>parents=newHashSet<String>(parentMappings.keySet());parents.removeAll(helper.getDescendants(role.getAuthority()));parents.remove(role.getAuthority());returnnewArrayList(parents);
else{//norolenamegiven,wearecreatinganewonereturnnewArrayList(parentMappings.keySet());
if(readerTarget!=null){readerTarget.dispose();
if(readerTarget!=null){readerTarget.dispose();
if(readerTarget!=null){readerTarget.dispose();
iftheyhavethesameid,andversion.**<p>Theunderlyingserviceimplementationisaplainoldjavaobject,availablevia{@link*#service}.**@authorJustinDeoliveira,TheOpenPlanningProject,jdeolive@openplans.org*/publicfinalclassService{/**Identifierfortheservice.*/finalStringid;/**Namespacefortheservice*/finalStringnamespace;/**Theserviceimplementation.*/finalObjectservice;/**Theserviceversion*/finalVersionversion;/**Listofoperationsprovidedbytheservice*/finalList<String>operations;/**OptionalcapabilitiesbacklinkincasetheserviceisnotatraditionalOWSservice*/StringcustomCapabilitiesLink;/***Createsanewservicedescriptor.**@paramidAstringidentifingtheservice.*@paramserviceTheobjectimplementingtheservice.*@paramversionTheversionoftheservice.*/publicService(Stringid,Objectservice,Versionversion,List<String>operations){this(id,null,service,version,operations);
if(id==null){thrownewNullPointerException("id");
if(!(objinstanceofService)){returnfalse;
if(!id.equals(other.id)){returnfalse;
if(version==null){
if(other.version!=null){returnfalse;
else{
if(!version.equals(other.version)){returnfalse;
if(version!=null){result=(result*17)+version.hashCode();
if(ids.isEmpty()){thrownewIllegalArgumentException("Invalidfidfilterprovides,hasnofidsinside");
if(mappings.length%2!=0){thrownewIllegalArgumentException("Oddnumberofversion/codemappings");
iftheversiondidnotmatch.*/publicStringget(Stringversion){
if(version!=null){returnget(newVersion(version));
else{returnget(newVersion("1.1.1"));
iftheversiondidnotmatch.*/publicStringget(Versionversion){Stringcode=codes.get(version);returncode!=null?code:defaultCode;}}
if(secMgr.checkAuthenticationForAdminRole()&&config.isEnabled()){returnnewJDBCConfigStatusPanel(id,config);
if(os==null){os=newFlushSafeServletOutputStream(super.getOutputStream());
if(!closed){delegate.flush();
if(wms==null)returnnull;
else
if(policy.level==AccessLevel.METADATA)throwSecureCatalogImpl.unauthorizedAccess(this.getName());
elsereturn(WebMapTileServer)SecuredObjects.secure(wms,policy);}}
if(jaiOperations==null){jaiOperations=JAI_OPS;
if(jaiExtOperations==null){jaiExtOperations=JAIEXT_OPS;
if(ImageWorker.isJaiExtEnabled()){populateOperations(jaiExtOperations);
if(jaiOperations==null){jaiOperations=JAI_OPS;
if(jaiExtOperations==null){jaiExtOperations=JAIEXT_OPS;
if(name.equalsIgnoreCase("algebric")||name.equalsIgnoreCase("operationConst")||name.equalsIgnoreCase("Stats")||JAIExt.isJAIAPI(name)){jaiExtOp.add(name);
if(!ex.getMessage().equals("LoggerRulecan'tcapturelogsforLoggerAdapter")){throwex;
ifthisparticular//assumptionfailureoccurs.Fornowit'sapassratherthananignore.
if(directory.exists()){FileUtils.deleteDirectory(directory);
if(directory.exists()){FileUtils.deleteDirectory(directory);
iftheresourcesareequalsInputStreamis=to.getBlob().getInputStream();InputStreamis2=to2.getBlob().getInputStream();checkInputStreams(is,is2);//EnsureCachecontainstheresultTileObjectto3=cache.getTileObj(to);assertNotNull(to3);assertEquals(to.getBlobFormat(),to3.getBlobFormat());//Check
iftheresourcesareequalsis=to.getBlob().getInputStream();InputStreamis3=to3.getBlob().getInputStream();checkInputStreams(is,is3);//EnsurethatNullBlobStoredoesnotcontainanythingassertFalse(((MemoryBlobStore)delegate).getStore().get(to));
iftheresourcesareequalsInputStreamis=to.getBlob().getInputStream();InputStreamis2=to2.getBlob().getInputStream();checkInputStreams(is,is2);//EnsureCachecontainstheresultTileObjectto3=cache.getTileObj(to);assertNotNull(to3);assertEquals(to.getBlobFormat(),to3.getBlobFormat());is=to.getBlob().getInputStream();InputStreamis3=to3.getBlob().getInputStream();checkInputStreams(is,is3);
iftheresourcesareequalsInputStreamis=to2.getBlob().getInputStream();InputStreamis2=bytes.getInputStream();checkInputStreams(is,is2);//RemoveTileObjectTileObjectto3=TileObject.createQueryTileObject("test:123123112",xyz,"EPSG:4326","image/jpeg",parameters);blobStore.delete(to3);//EnsureTileObjectisnomorepresentTileObjectto4=TileObject.createQueryTileObject("test:123123112",xyz,"EPSG:4326","image/jpeg",parameters);assertFalse(blobStore.get(to4));
ifthestreamsareequals,notethatthe{@linkInputStream}sarealsoclosed.*/privatevoidcheckInputStreams(InputStreamis,InputStreamis2)throwsIOException{try{assertTrue(IOUtils.contentEquals(is,is2));
switch(dimensionType){caseTIME:tree=newTreeSet(newDateRangeComparator());//isRange?newTreeSet(newDateRangeComparator()):new//TreeSet<Date>();break;caseELEVATION:tree=newTreeSet(newNumberRangeComparator());//isRange?newTreeSet(newNumberRangeComparator()):new//TreeSet<Number>();break;caseCUSTOM:StringdataType=dimension.getDatatype();
if(NetCDFUtilities.isATime(dataType)){tree=//newTreeSet(newDateRangeComparator());isRange?newTreeSet(newDateRangeComparator()):newTreeSet<Object>();
else{tree=//newTreeSet<Object>();isRange?newTreeSet(newNumberRangeComparator()):newTreeSet<Object>();
if(value==null){
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("NoDimensionsavailablewiththespecifiedname:"+dimensionName);
else{dimension.getDimensionValues().addValue(value);
if(netcdfDimensions!=null){netcdfDimensions.clear();netcdfDimensions=null;
if(netCDFCoordinates!=null&&netCDFCoordinates.length>0){for(NetCDFCoordinatecoordinate:netCDFCoordinates){
if(dimensionName.equalsIgnoreCase(coordinate.getDimensionName())){is2DCoordinate=true;break;
if(is2DCoordinate){return(Array)getDimensionValues().getValues();
else{//GetDimensioninformationDimensionBeanbean=getCoverageDimension();DimensionTypetype=bean.getDimensionType();finalStringdataType=bean.getDatatype();booleanisTime=false;
if(type==DimensionType.TIME||NetCDFUtilities.isATime(dataType)){isTime=true;
if(rangeValues){indexing[1]=1;data.setObject(index.set(indexing),getValue(value,isTime,rangeValues));indexing[1]=0;
if(isTime){returngetTime(input,endValue);
else
if(inputinstanceofNumberRange){NumberRangerange=(NumberRange)input;returnendValue?range.getMaxValue():range.getMinValue();
if(inputinstanceofTimestamp){time=((Timestamp)input).getTime();
else
if(inputinstanceofDateRange){
if(!endTime){time=((DateRange)input).getMinValue().getTime();
else{time=((DateRange)input).getMaxValue().getTime();
else
if(inputinstanceofDate){time=((Date)input).getTime();
else{thrownewIllegalArgumentException("Unsupportedtime");
ifandhowtopasssaidintothe*script).Ifyou'rereadingthisandareinterested,hopongs-develanddiscuss*/publicclassPostScriptTransformextendsAbstractCommandLineTransformimplementsPostTransform{privatefinalStringname;publicPostScriptTransform(Stringname,List<String>options){super(options);this.name=name;//forcevalidationsincethereisnosetterfornamegetExecutable();
if(resource.getType()!=Resource.Type.RESOURCE){thrownewValidationException("Scriptnamed'"+name+"'wasnotfoundin"+"$GEOSERVER_DATA_DIR/importer/scripts");
if(!executable.canExecute()){thrownewValidationException("Foundfilenamed'"+name+"'in"+"$GEOSERVER_DATA_DIR/importer/scripts,butit'snotexecutable");
if(scripts.getType()==Resource.Type.UNDEFINED){thrownewValidationException("Couldnotfindimporter/scriptsindatadirectory");
else
if(scripts.getType()==Resource.Type.RESOURCE){thrownewValidationException("Foundimporter/scriptsindatadirectory,butit'sa"+"fileandwasexpectingadirectory");
else{returnscripts;
if(queries==null){returnnull;
if(types.size()==1){returncrsFromTypeName((QName)types.get(0));
else{returnnull;
if(executionId!=null){storage.put(KEY,executionId);
if(executionId!=null){manager.setCurrentExecutionId(executionId);
if(idx>0&&idx==token.length()-2){Stringad=token.substring(idx+1);
if("A".equals(ad)){order=SortOrder.ASCENDING;token=token.substring(0,idx);
else
if("D".equals(ad)){order=SortOrder.DESCENDING;token=token.substring(0,idx);
if(featureTypeInfos.length==0){thrownewIOException("Unabletowriteanemptyfeatureinfoarray.");
if(jsonp){outWriter.write(getCallbackFunction()+"(");
if(ad==schema.getGeometryDescriptor()){//thisonewealreadydescribeddescribeProperty(ad.getLocalName(),ad,jw,true);
else{describeProperty(ad.getLocalName(),ad,jw,false);
if(jsonp){outWriter.write(")");
if(request==null){returnJSONType.CALLBACK_FUNCTION;
if(isGeometry){jw.key("type").value("gml:"+mapToJsonType(binding));
else{jw.key("type").value("xsd:"+mapToJsonType(binding));
if(Long.class.isAssignableFrom(binding)||Integer.class.isAssignableFrom(binding)||Short.class.isAssignableFrom(binding)||Byte.class.isAssignableFrom(binding)){return"int";
else
if(Number.class.isAssignableFrom(binding)){return"number";
else
if(Boolean.class.isAssignableFrom(binding)){return"boolean";
else
if(Geometry.class.isAssignableFrom(binding)){returnbinding.getSimpleName();
else
if(java.sql.Date.class.isAssignableFrom(binding)){return"date";
else
if(java.sql.Time.class.isAssignableFrom(binding)){return"time";
else
if(java.util.Date.class.isAssignableFrom(binding)){return"date-time";
else{return"string";
iffiledoesnotexistyet*@throwsIOException*/publicPropertiesgetProperties()throwsIOException{returnread();
if(f!=null){returngridFormat.accepts(f);
if(f==null){returnnull;
if(reader!=null){CatalogBuildercb=newCatalogBuilder(catalog);//createadummystoreCoverageStoreInfostore=cb.buildCoverageStore("dummy");store.setType(gridFormat().getName());cb.setStore(store);try{CoverageInfocoverage=cb.buildCoverage(reader,null);coverage.setStore(null);coverage.setNamespace(null);cb.setupBounds(coverage,reader);LayerInfolayer=cb.buildLayer((ResourceInfo)coverage);ImportTasktask=newImportTask(data);task.setLayer(layer);tasks.add(task);
if(reader!=null){reader.dispose();
if(datainstanceofSpatialFile){f=((SpatialFile)data).getFile();
if(datainstanceofDirectory){f=((Directory)data).getFile();
if(f!=null){AbstractGridFormatgridFormat=gridFormat();returngridFormat.getReader(f);
if(datainstanceofSpatialFile){f=((SpatialFile)data).getFile();
if(datainstanceofDirectory){f=((Directory)data).getFile();
if(gridFormat==null){synchronized(this){
if(gridFormat==null){try{gridFormat=gridFormatClass.newInstance();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;GridFormatother=(GridFormat)obj;
if(gridFormatClass==null){
if(other.gridFormatClass!=null)returnfalse;
else
if(!gridFormatClass.equals(other.gridFormatClass))returnfalse;returntrue;}}
if(infoFormat!=null&&outputFormats.contains(infoFormat.toLowerCase())){returninfoFormat;
if(mime.startsWith("image/")){writeChart(request,results,output,mime);
else{writeCsv(request,results,output);
if(collections.size()>0){SimpleFeatureCollectionfc=(SimpleFeatureCollection)collections.get(0);title+="of"+fc.getSchema().getName().getLocalPart();valueAxisLabel=fc.getSchema().getDescription().toString();try(SimpleFeatureIteratorfi=fc.features()){while(fi.hasNext()){SimpleFeaturef=fi.next();Datedate=(Date)f.getAttribute("date");Doublevalue=(Double)f.getAttribute("value");series.add(newMillisecond(date),value);
if(mimeType.startsWith("image/png")){ChartUtilities.writeChartAsPNG(output,chart,IMAGE_WIDTH,IMAGE_HEIGHT);
else
if(mimeType.equals("image/jpg")||mimeType.equals("image/jpeg")){ChartUtilities.writeChartAsJPEG(output,chart,IMAGE_WIDTH,IMAGE_HEIGHT);
if(crsinstanceofProjectedCRS){writer.println("#X:"+middle.y);writer.println("#Y:"+middle.x);
else{writer.println("#Latitude:"+middle.y);writer.println("#Longitude:"+middle.x);
if(collections.size()>0){SimpleFeatureCollectionfc=(SimpleFeatureCollection)collections.get(0);writer.println("Time(UTC),"+fc.getSchema().getDescription().toString());DateFormatisoFormatter=newSimpleDateFormat(ISO8601_2000_UTC_PATTERN);isoFormatter.setTimeZone(TimeZone.getTimeZone("UTC"));try(SimpleFeatureIteratorfi=fc.features()){while(fi.hasNext()){SimpleFeaturef=fi.next();Datedate=(Date)f.getAttribute("date");Doublevalue=(Double)f.getAttribute("value");writer.println(isoFormatter.format(date)+","+value);
if(request!=null&&request.getRawKvp()!=null&&request.getRawKvp().get("QUERY_LAYERS")!=null&&request.getRawKvp().get("INFO_FORMAT")!=null){Stringfilename=null;Stringlayers=((String)request.getRawKvp().get("QUERY_LAYERS")).trim();
if(layers.length()>0){filename=layers.replace(",","_").replace(":","-");Stringformat=(String)request.getRawKvp().get("INFO_FORMAT");String[]splitted=format.split("/");
if(splitted.length>0){filename=filename+="."+splitted[1];
if(username!=null&&password!=null){request.setParameter("username",username);request.setParameter("password",password);
if(charsetName!=null){returnCharset.forName(charsetName);
else{//
ifnotspecifiedlet'susetheshapefiledefaultonereturnCharset.forName("ISO-8859-1");
if(entry.isDirectory()){file.mkdir();
else{
if(file.getName().toLowerCase().endsWith(".shp")){shapeFile=file;
if(fos!=null){fos.close();
if(zis!=null){zis.close();
if(shapeFile==null){FileUtils.deleteDirectory(tempDir);thrownewIOException("Couldnotfindanyfilewith.shpextensioninthezipfile");
else{ShapefileDataStorestore=newShapefileDataStore(URLs.fileToUrl(shapeFile));resources.addResource(newShapefileResource(store,tempDir));returnstore.getFeatureSource().getFeatures();
if(rawKvp.containsKey("acceptVersions")){AcceptVersionsKvpParseravp=newWCS20AcceptVersionsKvpParser();Stringvalue=(String)rawKvp.get("acceptVersions");LOGGER.info("acceptVersions:"+value);AcceptVersionsTypeavt=(AcceptVersionsType)avp.parse(value);kvp.put("acceptVersions",avt);
if(rawKvp.containsKey("sections")){Stringvalue=(String)rawKvp.get("sections");LOGGER.info("Sections:"+value);EObjectsections=Ows20Factory.eINSTANCE.createSectionsType();((Collection)EMFUtils.get(sections,"section")).addAll(KvpUtils.readFlat(value,KvpUtils.INNER_DELIMETER));kvp.put("sections",sections);
ifthisstaterepresentsaprocesswhoseexecutioniscompleted(eithersuccesfully,or*not)*/publicbooleanisExecutionCompleted(){returnexecutionCompleted;
ifacertainstatecomesbeforethisoneinthestatusworkflow**@parampredecessor*/publicbooleanisValidSuccessor(ProcessStatepredecessor){returnpredecessor==this||predecessors.contains(predecessor);}}
if(gwcConfig.isWMSCEnabled()&&null!=app.getBean("gwcServiceWMS")){gwcCaps.add(newCapsInfo("WMS-C",newVersion("1.1.1"),"../gwc/service/wms?request=GetCapabilities&version=1.1.1&tiled=true"));
if(geoServer.getService(WMTSInfo.class).isEnabled()&&null!=app.getBean("gwcServiceWMTS")){gwcCaps.add(newCapsInfo("WMTS",newVersion("1.0.0"),"../gwc/service/wmts?REQUEST=GetCapabilities"));
if(gwcConfig.isTMSEnabled()&&null!=app.getBean("gwcServiceTMS")){gwcCaps.add(newCapsInfo("TMS",newVersion("1.0.0"),"../gwc/service/tms/1.0.0"));
if(!(filter.getExpression1()instanceofLiteral)&&!(filter.getExpression2()instanceofLiteral)){//comparingtwofieldswitheachotherPropertyNameexpression1=(PropertyName)filter.getExpression1();PropertyNameexpression2=(PropertyName)filter.getExpression2();finalStringpropertyTypesParam1=propertyTypesParam(expression1);finalStringpropertyTypesParam2=propertyTypesParam(expression2);//respectmatchCaseStringvalueCol1=matchingCase?"o1.value":"UPPER(o1.value)";StringvalueCol2=matchingCase?"o2.value":"UPPER(o2.value)";StringBuilderbuilder;
switch(matchAction){//respectmatchactioncaseALL://all=anothervalueforthepropertymaynotoccurbuilder=append(extraData,"oidNOTIN(SELECTo1.oidFROMobject_propertyo1,object_propertyo2WHERE(o1.oid=o2.oid)","ANDo1.property_typeIN(:",propertyTypesParam1,")","ANDo2.property_typeIN(:",propertyTypesParam2,")","AND",valueCol1,"!=",valueCol2,")/*",filter.toString(),"*/\n");break;caseANY://any=thevalueforthepropertymustoccuratleastoncebuilder=append(extraData,"oidIN(SELECTo1.oidFROMobject_propertyo1,object_propertyo2WHERE(o1.oid=o2.oid)","ANDo1.property_typeIN(:",propertyTypesParam1,")","ANDo2.property_typeIN(:",propertyTypesParam2,")","AND",valueCol1,"=",valueCol2,")/*",filter.toString(),"*/\n");break;caseONE://one=thevalueforthepropertymustoccurexactlyoncebuilder=append(extraData,"oidIN(SELECTo1.oidFROMobject_propertyo1,object_propertyo2WHERE(o1.oid=o2.oid)","ANDo1.property_typeIN(:",propertyTypesParam1,")","ANDo2.property_typeIN(:",propertyTypesParam2,")","AND",valueCol1,"=",valueCol2,"GROUPBY(oid)HAVINGCOUNT(oid)=1)/*",filter.toString(),"/*",filter.toString(),"*/\n");break;default:thrownewIllegalArgumentException("MatchAction:"+matchAction);
else{
if(filter.getExpression1()instanceofIsInstanceOf){StringBuilderbuilder=append(extraData,handleInstanceOf((IsInstanceOf)filter.getExpression1()));returnbuilder;
if(filter.getExpression1()instanceofLiteral){expression1=(PropertyName)filter.getExpression2();expression2=(Literal)filter.getExpression1();
else{expression1=(PropertyName)filter.getExpression1();expression2=(Literal)filter.getExpression2();
if(!matchingCase){expectedValue=expectedValue.toUpperCase();
switch(matchAction){//respectmatchactioncaseALL://all=anothervalueforthepropertymaynotoccurbuilder=append(extraData,"oidNOTIN(SELECToidFROMobject_propertyWHEREproperty_typeIN(:",propertyTypesParam,")AND",valueCol,"!=:",valueParam,")/*",filter.toString(),"*/\n");break;caseANY://any=thevalueforthepropertymustoccuratleastoncebuilder=append(extraData,"oidIN(SELECToidFROMobject_propertyWHEREproperty_typeIN(:",propertyTypesParam,")AND",valueCol,"=:",valueParam,")/*",filter.toString(),"*/\n");break;caseONE://one=thevalueforthepropertymustoccurexactlyoncebuilder=append(extraData,"oidIN(SELECToidFROMobject_propertyWHEREproperty_typeIN(:",propertyTypesParam,")AND",valueCol,"=:",valueParam,"GROUPBY(oid)HAVINGCOUNT(oid)=1)/*",filter.toString(),"*/\n");break;default:thrownewIllegalArgumentException("MatchAction:"+matchAction);
if(clazz==null||dbMappings.getTypeId(clazz)==null){return"(1=0)/*EXCLUDE*/\n";
switch(matchAction){//respectmatchactioncaseALL://all=anothervalueforthepropertymaynotoccurbuilder=append(extraData,"oidNOTIN(SELECToidFROMobject_propertyWHEREproperty_typeIN(:",propertyTypesParam,")ANDNOT(",valueCol,"LIKE'",pattern,"'))/*",filter.toString(),"*/\n");break;caseANY://any=thevalueforthepropertymustoccuratleastoncebuilder=append(extraData,"oidIN(SELECToidFROMobject_propertyWHEREproperty_typeIN(:",propertyTypesParam,")AND",valueCol,"LIKE'",pattern,"')/*",filter.toString(),"*/\n");break;caseONE://one=thevalueforthepropertymustoccurexactlyoncebuilder=append(extraData,"oidIN(SELECToidFROMobject_propertyWHEREproperty_typeIN(:",propertyTypesParam,")AND",valueCol,"LIKE'",pattern,"'","GROUPBY(oid)HAVINGCOUNT(oid)=1)/*",filter.toString(),"*/\n");break;default:thrownewIllegalArgumentException("MatchAction:"+matchAction);
if(!namedParams.containsKey(paramName)){namedParams.put(paramName,paramValue);returnparamName;
if(it.hasNext()){sql=append(extraData,"\tAND\n\t");
if(it.hasNext()){sql=append(extraData,"\tOR\n\t");
if(parentId!=null){searchParameters=getProductSearchParameters(parentId);
else{searchParameters=getCollectionSearchParameters();
if(sensorTypeProperty==null||!(sensorTypeProperty.getValue()instanceofString)){thrownewOWS20Exception("Unknownormissingsensorytype"+sensorTypeProperty);
if(collectionClass!=null){searchParameters.addAll(getSearchParametersByClass(collectionClass,productSchema));
if(match==null){thrownewOWS20Exception("UnknownparentId'"+parentId+"'",OWSExceptionCode.InvalidParameterValue);
if(targetNamespace.equals(propertyNs)){Parameterparameter=newParameterBuilder(name.getLocalPart(),pd.getType().getBinding()).prefix(pc.getPrefix()).build();result.add(parameter);
if(OpenSearchAccess.EO_NAMESPACE.equals(pd.getName().getNamespaceURI())&&!Geometry.class.isAssignableFrom(type)){Parameter<?>parameter=newParameterBuilder(pd.getName().getLocalPart(),type).prefix("eo").build();result.add(parameter);
if(parentId==null){featureSource=access.getCollectionSource();
else{featureSource=access.getProductSource();//needtodetermine
ifthecollectionisprimaryorvirtualFeaturecollection=getCollectionByParentIdentifier(parentId);
if(Boolean.FALSE.equals(value(collection,"primary"))){//TODO:parseandintegratevirtualcollectionfilterthrownewOWS20Exception("Virtualcollectionsupportnotimplementedyet");
else{//addingparentidfilterforprimarycollectionsfinalPropertyNameparentIdProperty=FF.property(newNameImpl(OpenSearchAccess.EO_NAMESPACE,"parentIdentifier"));PropertyIsEqualToparentIdFilter=FF.equal(parentIdProperty,FF.literal(parentId),true);resultsQuery=newQuery(resultsQuery);resultsQuery.setFilter(Predicates.and(resultsQuery.getFilter(),parentIdFilter));
if(resultsQuery.getMaxFeatures()==0){//purecountqueryfeatures=newListComplexFeatureCollection(featureSource.getSchema(),Collections.emptyList());
else{features=featureSource.getFeatures(resultsQuery);
if(request.getParentId()==null){//collectionrequestsource=access.getCollectionSource();
else{source=access.getProductSource();
if(metadata==null){thrownewOWS20Exception("Couldnotlocatetherequestedmetadataforuid="+request.getId()+"andparentId="+request.getParentId());
if(request.getParentId()==null){//collectionrequestsource=access.getCollectionSource();
else{source=access.getProductSource();
if(payload==null){thrownewOWS20Exception("Couldnotlocatethequicklookforuid="+request.getId()+"andparentId="+request.getParentId());
if(payload.length>=4&&//(payload[0]==(byte)0xFF)&&//(payload[1]==(byte)0xD8)&&//(payload[2]==(byte)0xFF)&&//(payload[3]==(byte)0xE0)){returnJPEG_MIME;
else
if(payload.length>=8&&//(payload[0]==(byte)0x89)&&//(payload[1]==(byte)0x50)&&//(payload[2]==(byte)0x4E)&&//(payload[3]==(byte)0x47)&&//(payload[4]==(byte)0x0D)&&//(payload[5]==(byte)0x0A)&&//(payload[6]==(byte)0x1A)&&//(payload[7]==(byte)0x0A)){returnPNG_MIME;
else{returnBINARY_MIME;
if(feature==null||//((property=feature.getProperty(propertyName))==null)||//((value=property.getValue())==null)){returnnull;
if(!"Geometry".equals(localName)){ftb.add(attributeDescriptor);
if(oldFeatureType.getDescriptor("Style")!=null){ftb.remove("Style");
if(folderObject!=null){StringserializedFolders=serializeFolders(folderObject);newFeature.setAttribute("Folder",serializedFolders);
if(untypedExtendedData!=null){for(Entry<String,String>entry:untypedExtendedData.entrySet()){
if(targetFeatureType.getDescriptor(entry.getKey())!=null){newFeature.setAttribute(entry.getKey(),entry.getValue());
if(!StringUtils.isEmpty(name)){folderNames.add(name);
if(otherWorkspace==null){differences.add(newInfoDiff(workspace,null));
else
if(!(Objects.equals(workspace.getName(),otherWorkspace.getName())&&checkEquals(workspace.getMetadata(),otherWorkspace.getMetadata()))){differences.add(newInfoDiff(workspace,otherWorkspace));
if(!(Objects.equals(namespace,otherNamespace)&&checkEquals(namespace.getMetadata(),namespace.getMetadata()))){differences.add(newInfoDiff(namespace,otherNamespace));
if(!(Objects.equals(dataStore,otherDataStore)&&Objects.equals(dataStore.getType(),otherDataStore.getType())&&checkEquals(dataStore.getMetadata(),otherDataStore.getMetadata())&&checkEquals(dataStore.getConnectionParameters(),otherDataStore.getConnectionParameters()))){differences.add(newInfoDiff(dataStore,otherDataStore));
if(!(Objects.equals(coverageStore,otherCoverageStore)&&Objects.equals(coverageStore.getType(),otherCoverageStore.getType())&&Objects.equals(coverageStore.getFormat(),otherCoverageStore.getFormat())&&Objects.equals(coverageStore.getURL(),otherCoverageStore.getURL())&&checkEquals(coverageStore.getMetadata(),otherCoverageStore.getMetadata())&&checkEquals(coverageStore.getConnectionParameters(),otherCoverageStore.getConnectionParameters()))){differences.add(newInfoDiff(coverageStore,otherCoverageStore));
if(!(Objects.equals(wmsStore,otherWmsStore)&&Objects.equals(wmsStore.getType(),otherWmsStore.getType())&&Objects.equals(wmsStore.getCapabilitiesURL(),otherWmsStore.getCapabilitiesURL())&&Objects.equals(wmsStore.getUsername(),otherWmsStore.getUsername())&&Objects.equals(wmsStore.getPassword(),otherWmsStore.getPassword())&&Objects.equals(wmsStore.getMaxConnections(),otherWmsStore.getMaxConnections())&&Objects.equals(wmsStore.getReadTimeout(),otherWmsStore.getReadTimeout())&&Objects.equals(wmsStore.getConnectTimeout(),otherWmsStore.getConnectTimeout())&&checkEquals(wmsStore.getMetadata(),otherWmsStore.getMetadata())&&checkEquals(wmsStore.getConnectionParameters(),otherWmsStore.getConnectionParameters()))){differences.add(newInfoDiff(wmsStore,otherWmsStore));
if(otherFeatureType!=null){otherFeatureType.setProjectionPolicy(featureType.getProjectionPolicy());
if(!(Objects.equals(featureType,otherFeatureType)&&checkEquals(featureType.getAttributes(),otherFeatureType.getAttributes())&&checkEquals(featureType.getResponseSRS(),otherFeatureType.getResponseSRS())&&checkEquals(featureType.getAlias(),otherFeatureType.getAlias())&&checkEquals(featureType.getKeywords(),otherFeatureType.getKeywords())&&checkEquals(featureType.getDataLinks(),otherFeatureType.getDataLinks())&&checkEquals(featureType.getMetadataLinks(),otherFeatureType.getMetadataLinks())&&checkEquals(featureType.getMetadata(),otherFeatureType.getMetadata()))){differences.add(newInfoDiff(featureType,otherFeatureType));
if(!(Objects.equals(coverage,otherCoverage)&&checkEquals(coverage.getDimensions(),otherCoverage.getDimensions())&&checkEquals(coverage.getInterpolationMethods(),otherCoverage.getInterpolationMethods())&&checkEquals(coverage.getParameters(),otherCoverage.getParameters())&&checkEquals(coverage.getResponseSRS(),otherCoverage.getResponseSRS())&&checkEquals(coverage.getAlias(),otherCoverage.getAlias())&&checkEquals(coverage.getKeywords(),otherCoverage.getKeywords())&&checkEquals(coverage.getDataLinks(),otherCoverage.getDataLinks())&&checkEquals(coverage.getMetadataLinks(),otherCoverage.getMetadataLinks())&&checkEquals(coverage.getMetadata(),otherCoverage.getMetadata()))){differences.add(newInfoDiff(coverage,otherCoverage));
if(!(Objects.equals(layer,otherLayer)&&Objects.equals(layer.isAdvertised(),otherLayer.isAdvertised())&&checkEquals(layer.getAuthorityURLs(),otherLayer.getAuthorityURLs())&&checkEquals(layer.getIdentifiers(),otherLayer.getIdentifiers())&&checkEquals(layer.getStyles(),otherLayer.getStyles())&&checkEquals(layer.getMetadata(),otherLayer.getMetadata()))){differences.add(newInfoDiff(layer,otherLayer));
if(!(Objects.equals(style,otherStyle)&&getStyleFile(style,dataDir).equals(getStyleFile(otherStyle,otherDataDir)))){differences.add(newInfoDiff(style,otherStyle));
if(!(Objects.equals(layerGroup,otherLayerGroup)&&checkEquals(layerGroup.getStyles(),otherLayerGroup.getStyles())&&checkEquals(layerGroup.getAuthorityURLs(),otherLayerGroup.getAuthorityURLs())&&checkEquals(layerGroup.getIdentifiers(),otherLayerGroup.getIdentifiers())&&checkEquals(layerGroup.getMetadataLinks(),otherLayerGroup.getMetadataLinks())&&checkEquals(layerGroup.getMetadata(),otherLayerGroup.getMetadata())&&checkEquals(layerGroup.getLayers(),otherLayerGroup.getLayers()))){differences.add(newInfoDiff(layerGroup,otherLayerGroup));
if(!(Objects.equals(wmsLayer,otherWmsLayer)&&checkEquals(wmsLayer.getAlias(),otherWmsLayer.getAlias())&&checkEquals(wmsLayer.getKeywords(),otherWmsLayer.getKeywords())&&checkEquals(wmsLayer.getDataLinks(),otherWmsLayer.getDataLinks())&&checkEquals(wmsLayer.getMetadataLinks(),otherWmsLayer.getMetadataLinks())&&checkEquals(wmsLayer.getMetadata(),otherWmsLayer.getMetadata()))){differences.add(newInfoDiff(wmsLayer,otherWmsLayer));
if(element.getId().equals(id)){//cataloginfoelementfoundreturntrue;
ifthetwocollectioncontainsexactlythesameelementsinanyorder.*/privatebooleancheckEquals(Collection<?>collectionA,Collection<?>collectionB){
if(collectionA.size()!=collectionB.size()){//collectionshaveadifferentsizesotheiraredifferentreturnfalse;
if(!collectionB.contains(object)){//thiselementisnotpresentincollectionBreturnfalse;
if(mapA.size()!=mapB.size()){//thehaveadifferentnumberofelements,sotheiraredifferentreturnfalse;
if(!Objects.equals(entry.getValue(),mapB.get(entry.getKey()))){//elementdoesn'texistsinmapBorisvalueisdifferentreturnfalse;
if(name==null){//backwardcompatabilitycheckname=GeoServerExtensions.getProperty("org.opengeo.importer.store");
if(name!=null){for(ImportStorebean:GeoServerExtensions.extensions(ImportStore.class)){
if(name.equals(bean.getName())){store=bean;break;
if(store==null){LOGGER.warning("Invalidvalueforimportstore,nosuchstore"+name);
if(store==null){store=newMemoryImportStore();
if(eventinstanceofContextLoadedEvent){contextStore=createContextStore();contextStore.init();
if(store!=null&&store.getId()!=null){task.setStore(catalog.getStore(store.getId(),StoreInfo.class));//((StoreInfoImpl)task.getStore()).setCatalog(catalog);//@todoremove
ifthe//abovesetscatalog
if(task.getLayer()!=null){LayerInfol=task.getLayer();
if(l.getDefaultStyle()!=null&&l.getDefaultStyle().getId()!=null){l.setDefaultStyle(catalog.getStyle(l.getDefaultStyle().getId()));
if(l.getResource()!=null){ResourceInfor=l.getResource();r.setCatalog(catalog);
if(r.getStore()==null&&resourceMatchesStore(r,store)){r.setStore(store);
iftheprovidedidisinvalid*/publicImportContextcreateContext(Longid)throwsIOException,IllegalArgumentException{ImportContextcontext=newImportContext();
if(id!=null){Longretval=contextStore.advanceId(id);assertretval>=id;context.setId(retval);contextStore.save(context);
else{contextStore.add(context);
if(targetWorkspace==null&&targetStore!=null){targetWorkspace=targetStore.getWorkspace();
if(targetWorkspace==null){targetWorkspace=catalog.getDefaultWorkspace();
if(!context.progress().isCanceled()){contextStore.add(context);
else{//context.setState(ImportContext.State.CANCELLED);//
if(data!=null){
if(datainstanceofRemoteData){data=((RemoteData)data).resolve(this);context.setData(data);
switchfrominittopendingasneededcontext.setState(ImportContext.State.PENDING);
switchtocompletetomaketheerrorevident,sincewe//cannotattachittoataskcontext.setState(ImportContext.State.INIT_ERROR);context.setMessage(e.getMessage());return;
if(data==null){returnCollections.emptyList();
if(prepData){data.prepare(context.progress());
if(datainstanceofFileData&&((FileData)data).getFile()!=null){
if(datainstanceofMosaic){returninitForMosaic(context,(Mosaic)data);
else
if(datainstanceofDirectory){returninitForDirectory(context,(Directory)data);
else{returninitForFile(context,(FileData)data);
else
if(datainstanceofTable){
else
if(datainstanceofDatabase){returninitForDatabase(context,(Database)data);
if(context.getTargetStore()!=null){thrownewIllegalArgumentException("ingestnotsupportedformosaics");
if(dir.getFiles().isEmpty())continue;//groupthecontentsofthedirectorybyformatMap<DataFormat,List<FileData>>map=newHashMap<DataFormat,List<FileData>>();for(FileDataf:dir.getFiles()){DataFormatformat=f.getFormat();List<FileData>files=map.get(format);
if(files==null){files=newArrayList<FileData>();map.put(format,files);
ifnotargetstorespecifiedgroupthedirectoryintopiecesthatcanbe//processedasasingletaskStoreInfotargetStore=context.getTargetStore();
if(targetStore==null){//createataskforeach"format"
ifthatformatcanhandleadirectoryfor(DataFormatformat:newArrayList<DataFormat>(map.keySet())){
if(format!=null&&format.canRead(dir)){List<FileData>files=map.get(format);
if(files.size()==1){//usethefiledirectly//createTasks(files.get(0),format,context,null));tasks.addAll(createTasks(files.get(0),format,context));
else{tasks.addAll(createTasks(dir.filter(files),format,context));//tasks.addAll(createTasks(dir.filter(files),format,context,null));
else{for(FileDatafile:dir.getFiles()){tasks.addAll(createTasks(file,file.getFormat(),context,skipNoFormat));
ifthereshouldbe//onetaskwithmanyitems,oronetaskpertable...can;tthinkoftheusecasefor//manytasks//tasks.add(createTask(db,context,targetStore));returncreateTasks(db,context);
if(targetStore==null){//directimport,usetheformattocreateastoredirect=true;
if(format!=null){targetStore=format.createStore(data,context.getTargetWorkspace(),catalog);
if(targetStore==null){//formatunabletocreatestore,
switchtoindirectimportanduse//defaultstorefromcatalogtargetStore=lookupDefaultStore();direct=targetStore==null;
if(targetStoreinstanceofCoverageStoreInfo&&targetStore.getId()!=null&&isMultiCoverageInput(format,data)){CoverageStoreInfocs=(CoverageStoreInfo)targetStore;GridCoverageReaderreader=cs.getGridCoverageReader(null,null);
if(!(readerinstanceofStructuredGridCoverage2DReader)){thrownewIllegalArgumentException("Harverstingafileintoatargetrasterstorecanonlybedone
if"+"thestoreisastructuredone(e.g.,amosaic)");
if(structured.isReadOnly()){thrownewIllegalArgumentException("Thetargetstructuredrasterstoreisreadonly,cannotharvestintoit");
if(format!=null){//createthesetoftasksbyhavingtheformatlisttheavailableitemsfromtheinput//datafor(ImportTaskt:format.list(data,catalog,context.progress())){//initializetransformchainbasedonvectorvsraster
if(t.getTransform()==null){t.setTransform(formatinstanceofVectorFormat?newVectorTransformChain():newRasterTransformChain());
if(!direct&&targetStoreinstanceofCoverageStoreInfo){t.getLayer().setName(targetStore.getName());t.getLayer().getResource().setName(targetStore.getName());
if(!catalog.getCoveragesByStore((CoverageStoreInfo)targetStore).isEmpty()){t.setUpdateMode(UpdateMode.APPEND);
else
if(!skipNoFormat){ImportTaskt=newImportTask(data);t.setDirect(direct);t.setStore(targetStore);prep(t);tasks.add(t);
if(!(formatinstanceofGridFormat)){returnfalse;
if(readerinstanceofStructuredGridCoverage2DReader){StructuredGridCoverage2DReaderstructured=(StructuredGridCoverage2DReader)reader;//cleanupeventualancillaryfiles(NetCDFcase)astheimagemosaicmightwant//them//createdinsomeotherwaystructured.delete(false);returntrue;
else{returnfalse;
if(reader!=null){reader.dispose();
if(task.getState()==ImportTask.State.COMPLETE){returntrue;
if(format==null){task.setState(State.NO_FORMAT);returnfalse;
if(task.getStore()==null){task.setError(newException("Notargetstorefortask"));task.setState(State.ERROR);returnfalse;
if(!formatMatchesStore(format,task.getStore())){Stringmsg=task.getStore()instanceofDataStoreInfo?"Unabletoimportrasterdataintovectorstore":"Unabletoimportvectordataintorasterstore";task.setError(newException(msg));task.setState(State.BAD_FORMAT);returnfalse;
if(task.getLayer()==null||task.getLayer().getResource()==null){task.setError(newException("Taskhasnolayerconfiguration"));task.setState(State.ERROR);returnfalse;
ifnotalreadydone
if(l.getDefaultStyle()==null){try{StyleInfostyle=null;//firstcheckthecaseofastylefilebeinguploadedviazipalongwithrestof//files
if(task.getData()instanceofSpatialFile){SpatialFilefile=(SpatialFile)task.getData();
if(file.getStyleFile()!=null){style=createStyleFromFile(file.getStyleFile(),task);
if(style==null){
if(rinstanceofFeatureTypeInfo){//sincethisresourceisstilldetachedfromthecatalogwecan'tcall//throughtogetit'sunderlyingresource,sowedependonthe"native"//typeprovidedfromtheformatFeatureTypefeatureType=(FeatureType)task.getMetadata().get(FeatureType.class);
if(featureType!=null){style=styleGen.createStyle(styleHandler,(FeatureTypeInfo)r,featureType);
else{thrownewRuntimeException("Unabletocomputestyle");
else
if(rinstanceofCoverageInfo){style=styleGen.createStyle(styleHandler,(CoverageInfo)r);
else{thrownewRuntimeException("Unknownresourcetype:"+r.getClass());
if(r.getSRS()==null){task.setState(ImportTask.State.NO_CRS);returnfalse;
else
if(task.getState()==ImportTask.State.NO_CRS){//changedaftersettingsrsmanually,computethelatlongboundingboxtry{computeLatLonBoundingBox(task,false);
else{task.getLayer().getResource().setProjectionPolicy(ProjectionPolicy.NONE);
if(r.getNativeBoundingBox()==null){task.setState(ImportTask.State.NO_BOUNDS);returnfalse;
if(formatinstanceofVectorFormat){returnstoreinstanceofDataStoreInfo;
if(formatinstanceofGridFormat){returnstoreinstanceofCoverageStoreInfo;
if(resourceinstanceofFeatureTypeInfo){returnstoreinstanceofDataStoreInfo;
if(resourceinstanceofCoverageInfo){returnstoreinstanceofCoverageStoreInfo;
if(context.getState()==ImportContext.State.INIT){thrownewIllegalStateException("Importerisstillinitializing,cannotrunit");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Runningimport"+context.getId());
if(!filter.include(task)){continue;
if(!task.readyForImport()){continue;
if(context.progress().isCanceled()){break;
if(context.isArchive()&&context.getState()==ImportContext.State.COMPLETE){
if(!context.isDirect()){finalDirectorydirectory=context.getUploadDirectory();
if(directory!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Archivingdirectory"+directory.getFile().getAbsolutePath());
if(task.getState()==ImportTask.State.COMPLETE){return;
if(task.isDirect()){//directimport,simplyaddconfiguredstoreandlayerstocatalogdoDirectImport(task);
else{//indirectimport,readdatafromthesourceandintothetargetstoredoIndirectImport(task);
if(init){init(context,true);
if(Thread.currentThread()!=parentThread){//cleaningrequestspringcontextforthecurrentthreadRequestContextHolder.resetRequestAttributes();SecurityContextHolder.getContext().setAuthentication(oldAuth);
if(task.getStore().getId()==null){StoreInfostore=task.getStore();//ensureauniquenamestore.setName(findUniqueStoreName(task.getStore()));//ensureanamespaceconnectionparametersetmatchingworkspace/namespace
if(!store.getConnectionParameters().containsKey("namespace")){WorkspaceInfows=task.getContext().getTargetWorkspace();
if(ws==null&&task.getContext().getTargetStore()!=null){ws=task.getContext().getTargetStore().getWorkspace();
if(ws!=null){NamespaceInfons=catalog.getNamespaceByPrefix(ws.getName());
if(ns!=null){store.getConnectionParameters().put("namespace",ns.getURI());
if(!doPreTransform(task,task.getData(),tx)){return;
if(task.getLayer().getResource()instanceofFeatureTypeInfo){FeatureTypeInfofeatureType=(FeatureTypeInfo)task.getLayer().getResource();FeatureTypeInforesource=getCatalog().getResourceByName(featureType.getQualifiedName(),FeatureTypeInfo.class);calculateBounds(resource);
if(!doPostTransform(task,task.getData(),tx)){return;
if(!task.getStore().isEnabled()){task.getStore().setEnabled(true);
if(task.progress().isCanceled()){return;
if(!doPreTransform(task,task.getData(),tx)){return;
if(formatinstanceofVectorFormat){try{currentlyProcessing.put(task.getContext().getId(),task);loadIntoDataStore(task,(DataStoreInfo)task.getStore(),(VectorFormat)format,(VectorTransformChain)tx);canceled=task.progress().isCanceled();FeatureTypeInfofeatureType=(FeatureTypeInfo)task.getLayer().getResource();featureType.getAttributes().clear();
if(!canceled){
if(task.getUpdateMode()==UpdateMode.CREATE){addToCatalog(task);
else{//see
ifthestoreexposesastructuredgridcoveragereaderStoreInfostore=task.getStore();finalStringerrorMessage="Indirectrasterimportcanonlyworkagainstastructuredgridcoveragestore(e.g.,mosaic),thisoneisnot:";
if(!(storeinstanceofCoverageStoreInfo)){thrownewIllegalArgumentException(errorMessage+store);
if(!(readerinstanceofStructuredGridCoverage2DReader)){thrownewIllegalArgumentException(errorMessage+store);
ifnot,createit
if(task.getUpdateMode()==UpdateMode.CREATE){
if(task.getLayer()!=null&&task.getLayer().getId()==null){addToCatalog(task);
if(!canceled&&!doPostTransform(task,task.getData(),tx)){return;
if(resource.getNativeBoundingBox()==null||resource.getNativeBoundingBox().isEmpty()||Boolean.TRUE.equals(resource.getMetadata().get("recalculate-bounds"))||"true".equals(resource.getMetadata().get("recalculate-bounds"))){//forcecomputationCatalogBuildercb=newCatalogBuilder(getCatalog());ReferencedEnvelopenativeBounds=cb.getNativeBounds(resource);resource.setNativeBoundingBox(nativeBounds);resource.setLatLonBoundingBox(cb.getLatLonBounds(nativeBounds,resource.getCRS()));getCatalog().save(resource);//Donotre-calculateonsubsequentimports
if(resource.getMetadata().get("recalculate-bounds")!=null){resource.getMetadata().remove("recalculate-bounds");
if(!harvested.success()){thrownewIOException("Failedtoharvest"+harvested.getSource()+":"+harvested.getMessage());
if(datainstanceofSpatialFile){SpatialFilesf=(SpatialFile)data;List<HarvestedSource>harvests=sr.harvest(null,sf.getFile(),null);checkSingleHarvest(harvests);
else
if(datainstanceofDirectory){harvestDirectory(sr,(Directory)data);
else{unsupportedHarvestFileData(data);
if(!featureType.getName().equals(nativeName)){SimpleFeatureTypeBuildertb=newSimpleFeatureTypeBuilder();tb.init(featureType);tb.setName(nativeName);featureType=tb.buildFeatureType();
if(isShapefileDataStore(dataStore)){featureDataConverter=FeatureDataConverter.TO_SHAPEFILE;
else
if(isOracleDataStore(dataStore)){featureDataConverter=FeatureDataConverter.TO_ORACLE;
else
if(isPostGISDataStore(dataStore)){featureDataConverter=FeatureDataConverter.TO_POSTGIS;
if(updateMode==UpdateMode.CREATE){//findauniquetypenameinthetargetstoreuniquifiedFeatureTypeName=findUniqueNativeFeatureTypeName(featureType,store);
if(!uniquifiedFeatureTypeName.equals(featureTypeName)){//updatethemetadatatask.getLayer().getResource().setName(uniquifiedFeatureTypeName);task.getLayer().getResource().setNativeName(uniquifiedFeatureTypeName);//retypeSimpleFeatureTypeBuildertypeBuilder=newSimpleFeatureTypeBuilder();typeBuilder.setName(uniquifiedFeatureTypeName);typeBuilder.addAll(featureType.getAttributeDescriptors());featureType=typeBuilder.buildFeatureType();
if(dataStoreinstanceofJDBCDataStore){JDBCDataStoreds=(JDBCDataStore)dataStore;//sniffforpostgis(h2isusedintestsandwillcausefailure
ifthisoccurs)
if(ds.getSqlTypeNameToClassMappings().containsKey("timestamptz")){ds.getSqlTypeToSqlTypeNameOverrides().put(java.sql.Types.TIMESTAMP,"timestamptz");
else{//@todowhattodo
iffeatureTypetransformispresent?//@todoimplementme-needtospecifyattributeusedforid
if(updateMode==UpdateMode.UPDATE){thrownewUnsupportedOperationException("updateModeUPDATEisnotsupportedyet");
if(updateMode==UpdateMode.REPLACE){FeatureStorefs=(FeatureStore)dataStore.getFeatureSource(featureTypeName);fs.setTransaction(transaction);fs.removeFeatures(Filter.INCLUDE);
if(formatinstanceofDataStoreFormat){error=copyFromFeatureSource(data,task,(DataStoreFormat)format,dataStore,transaction,featureTypeName,uniquifiedFeatureTypeName,featureDataConverter,tx);
else{reader=format.read(data,task);error=copyFromFeatureReader(reader,task,format,dataStore,transaction,featureTypeName,uniquifiedFeatureTypeName,featureDataConverter,tx);
if(reader!=null){format.dispose(reader,task);//@hackcatch_all_Exceptionshere-occassionallyclosingashapefile//seemstoresultinanIllegalArgumentExceptionrelatedtonot//holdingthelock...
ifanerroroccurshereandonehasn'talreadybeenset,setthe//errortry{transaction.close();
if(error!=null){error=e;
if(error!=null){throwerror;
if(error!=null||monitor.isCanceled()){//allsubexceptionsinthiscatchblockshouldbelogged,notthrown//asthetriggeringexceptionwillbethrown//failure,rollbacktransactiontry{transaction.rollback();
if(monitor.isCanceled()){break;
if(geom!=null&&geom.isEmpty()){next.setDefaultGeometry(null);
if(next==null){skipped++;
else{writer.write();
if(skipped>0){task.addMessage(Level.WARNING,skipped+"featureswereskipped.");
if(error!=null||monitor.isCanceled()){//allsubexceptionsinthiscatchblockshouldbelogged,notthrown//asthetriggeringexceptionwillbethrown//failure,rollbacktransactiontry{transaction.rollback();
if(ws==null){returnnull;
if(layer.getDefaultStyle().getId()==null){catalog.add(layer.getDefaultStyle());
if(catalog.getStoreByName(workspace,store.getName(),StoreInfo.class)!=null){inti=0;name+=i;while(catalog.getStoreByName(workspace,name,StoreInfo.class)!=null){name=name.replaceAll(i+"$",String.valueOf(i+1));i++;
if(!Character.isLetter(name.charAt(0))){name="a_"+name;
if(catalog.getResourceByName(ns,name,ResourceInfo.class)!=null){inti=0;name+=i;while(catalog.getResourceByName(ns,name,ResourceInfo.class)!=null){name=name.replaceAll(i+"$",String.valueOf(i+1));i++;
if(isOracleDataStore(dataStore)){name=name.toUpperCase();
if(names.contains(name)){inti=0;name+=i;while(names.contains(name)){name=name.replaceAll(i+"$",String.valueOf(i+1));i++;
if(force||r.getLatLonBoundingBox()==null&&r.getNativeBoundingBox()!=null){CoordinateReferenceSystemnativeCRS=CRS.decode(r.getSRS());ReferencedEnvelopenativeBbox=newReferencedEnvelope(r.getNativeBoundingBox(),nativeCRS);r.setLatLonBoundingBox(nativeBbox.transform(CRS.decode("EPSG:4326"),true));returntrue;
if(value==null){value=System.getenv(UPLOAD_ROOT_KEY);
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.log(Level.FINEST,"Couldnotaccesssystemproperty'"+UPLOAD_ROOT_KEY+"':"+ex);
if(configFile!=null&&configFile.isModified()){try{props=configFile.read();
if(props!=null&&value==null){value=props.getProperty(UPLOAD_ROOT_KEY);
if(value!=null){ResourceuploadsRoot=Resources.fromPath(value);returnResources.directory(uploadsRoot,!Resources.exists(uploadsRoot));
if(purge){importContext.delete();
if(schema!=null){try{ds.removeSchema(featureTypeName);
else{LOGGER.warning("UnabletodropSchema"+featureTypeName+"asitdoesnotappeartoexistindataStore");
if(ext!=null){StyleHandlerstyleHandler=Styles.handler(ext);
if(styleHandler!=null){try{StyledLayerDescriptorsld=styleHandler.parse(styleFile,null,null,newEntityResolverProvider(getGeoServer()).getEntityResolver());Stylestyle=Styles.style(sld);
if(style!=null){StyleInfoinfo=catalog.getFactory().createStyle();StringstyleName=styleGen.generateUniqueStyleName(task.getLayer().getResource());info.setName(styleName);info.setFilename(styleName+"."+ext);info.setFormat(styleHandler.getFormat());info.setFormatVersion(styleHandler.version(styleFile));info.setWorkspace(task.getStore().getWorkspace());try(InputStreamin=newFileInputStream(styleFile)){catalog.getResourcePool().writeStyle(info,in);
else{LOGGER.warning("Stylefilecontainednostyling:"+styleFile.getPath());
else{LOGGER.warning("Unabletofindstylehandlerforfileextension:"+ext);
if(pi.getName().getLocalPart().equals(name)){returnpi;
if(pgi.getFactoryClass().equals(RasterProcessFactory.class)){returnpgi;
if(bytes==null){setModified(false);return;
if(v==null){returnOptional.empty();
if(!isAvailable()){message+="\njava.library.path:"+System.getProperty("java.library.path","");
if(isAvailable()){returnGeoTools.getVersion(org.libjpegturbo.turbojpeg.TJ.class).toString();
else{return"unavailable";
if("ControlFlowCallback".equals(bean.getClass().getSimpleName())){//wrapthecontrolflowinaproxybean=Proxy.newProxyInstance(bean.getClass().getClassLoader(),newClass[]{DispatcherCallback.class},newControlFlowCallbackProxy(monitor,bean));
if("operationDispatched".equals(method.getName())&&monitor.current()!=null){RequestDatadata=monitor.current();
if(data==null){//meansmonitorisconfiguredbutinactivereturnmethod.invoke(target,args);
else{returnmethod.invoke(target,args);
if(!(context.getService()instanceofWMSInfo)){returnnull;
if(selfLinks!=null&&selfLinks.equalsIgnoreCase("true")&&Placemark.class.isAssignableFrom(featureClass)){returnnewPlacemarkSelfLinkDecorator();
else{returnnull;
if(kw.getLanguage()!=null){sb.append("(").append(kw.getLanguage()).append(")");
if(kw.getVocabulary()!=null){sb.append("[").append(kw.getVocabulary()).append("]");
if(lang!=null&&!"".equals(lang.trim())){keyword.setLanguage(lang);
if(vocab!=null&&!"".equals(vocab.trim())){keyword.setVocabulary(vocab);
if(PreAuthenticatedUserNameRoleSource.UserGroupService.equals(model)){returnnewUserGroupServicePanel("panel");
else
if(PreAuthenticatedUserNameRoleSource.RoleService.equals(model)){returnnewRoleServicePanel("panel");
else
if(PreAuthenticatedUserNameRoleSource.Header.equals(model)){returnnewHeaderPanel("panel");
if(requestinstanceofGetDomainType){returntrue;
else{thrownewIllegalArgumentException("Unsupportedrequestobjecttype:"+request);
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE)){LOGGER.severe(e.getLocalizedMessage());
if(GeoWebCacheEnvironment.ALLOW_ENV_PARAMETRIZATION){jdbcConfiguration.setDialect("${TEST_ENV_PROPERTY}");
else{jdbcConfiguration.setDialect("H2");
ifcachingispossibleassertTrue(mediator.isCachingPossible(tileLayer,request,target));//EnsureNoerrorisloggedassertEquals(0,target.length());//SettingFILTERparameterequaltoCQLFILTER(GeoServerdoesitinternally)request.setFilter(cqlFilters);//Checking
ifcachingispossibleassertTrue(mediator.isCachingPossible(tileLayer,request,target));//EnsureNoerrorisloggedassertEquals(0,target.length());//Ensurethat
ifanotherfilterissetanerroristhrownListfilters=newArrayList(cqlFilters);filters.add(Filter.INCLUDE);request.setFilter(filters);//EnsuringcachingisnotpossibleassertFalse(mediator.isCachingPossible(tileLayer,request,target));//EnsureNoerrorisloggedassertFalse(0==target.length());
if(style!=null&&style.equals("default")){//
ifnostylesareprovidedWMTSassumesadefaultstylenameddefaultcontinue;
if(GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){assertTrue("H2".equals(jdbcStorage.getJDBCDiskQuotaConfig().clone(true).getDialect()));
if(DummyRasterMapProducer.MIME_TYPE.equals(mimeType)){returnproducer;
if(DummyRasterMapProducer.MIME_TYPE.equals(mimeType)){returnproducer;
if(nss!=null){QNamename=resolver.parseQName(path,nss);Stringuri=name.getNamespaceURI();
if(uri!=null&&!"".equals(uri)){
if(DC.NAMESPACE.equals(uri)||DCT.NAMESPACE.equals(uri)){path=path+"/dc:value";
else{AttributeDescriptordescriptor=CSWRecordDescriptor.getDescriptor(path);
if(descriptor!=null){
if(DC.NAMESPACE.equals(descriptor.getName().getNamespaceURI())){path="dc:"+path+"/dc:value";nss=CSWRecordDescriptor.NAMESPACES;
else
if(DCT.NAMESPACE.equals(descriptor.getName().getNamespaceURI())){path="dct:"+path+"/dc:value";nss=CSWRecordDescriptor.NAMESPACES;
if*themodule/driverisunavailable*/Optional<String>getMessage();/**OptionalrelativelinktoGeoServerusermanual*/Optional<String>getDocumentation();}
if(ffinstanceofQueryLayerFunctionFactory){QueryLayerFunctionFactoryfactory=(QueryLayerFunctionFactory)ff;
if(maxFeatures!=null){factory.setMaxFeatures(maxFeatures);
if(maxCoordinates!=null){factory.setMaxCoordinates(maxCoordinates);
if(property!=null&&!"".equals(property.trim())){returnInteger.parseInt(property);
if(property!=null&&!"".equals(property.trim())){returnLong.parseLong(property);
if(la.getName().equals("layerAttribute2")){assertEquals("READONLY",la.getAccess().toString());
if(la.getName().equals("layerAttribute2")){assertEquals("READWRITE",la.getAccess().toString());
if(rules>0){assertThat(result.getBody(),notNullValue());assertThat(result.getBody().getRules().size(),is(rules));
else{assertThat(result.getBody(),nullValue());
if(delegateinstanceofStructuredGridCoverage2DReader){returnnewStructuredSingleGridCoverage2DReader((StructuredGridCoverage2DReader)delegate,coverageName);
else{returnnewSingleGridCoverage2DReader((GridCoverage2DReader)delegate,coverageName);
if(delegate==null){thrownewIllegalArgumentException("Thedelegatecoveragereadercannotbenull");
if(coverageName==null){thrownewIllegalArgumentException("Thecoveragenamemustbespecified");
if(!this.coverageName.equals(coverageName)){thrownewIllegalArgumentException("Unknowncoveragenamed"+coverageName+",theonlyvalidvalueis:"+this.coverageName);
ifamandatoryparameterismissing.*/protectedMercator1SPGoogle(finalParameterValueGroupparameters)throwsParameterNotFoundException{super(parameters);
ifamandatoryparameterismissing.*/protectedSpherical(finalParameterValueGroupparameters)throwsParameterNotFoundException{super(parameters);
ifarequiredparameterwasnotfound.*/protectedMathTransformcreateMathTransform(finalParameterValueGroupparameters)throwsParameterNotFoundException{//makesureweassumeasphericalreferenceparameters.parameter("semi_minor").setValue(parameters.parameter("semi_major").getValue());returnnewSpherical(parameters);
if(!config.isEnabled()){return;
if(!config.isEnabled()){super.loadCatalog(catalog,xp);return;
ifthisisthefirsttimeloadingupwithjdbcconfiguration,migratefromold//filebasedstructure
if(config.isImport()){readCatalog(catalog,xp);decImportStep();
if(!config.isEnabled()){super.loadGeoServer(geoServer,xp);return;
ifthisisthefirsttimeloadingupwithbdbjeconfiguration,migratefromold//filebasedstructure
if(config.isImport()){readConfiguration(geoServer,xp);decImportStep();
ifwearestartingfrom//anemptydatadirectoryallobjectswillbeempty//TODO:thisshouldreallybemovedelsewhere
if(geoServer.getGlobal()==null){geoServer.setGlobal(geoServer.getFactory().createGlobal());
if(geoServer.getLogging()==null){geoServer.setLogging(geoServer.getFactory().createLogging());
if(s==null){geoServer.add(l.create(geoServer));
if(--importSteps==0){//importcompleted,resetflagconfig.setImport(false);config.save();
if(!Resources.exists(file)){returnnull;
if(errors.size()>0){StringBuildersb=newStringBuilder("Errorsfoundinthetemplate");for(TransformerExceptione:errors){sb.append("\n").append(e.getMessageAndLocation());
if(idx>0){returnname.substring(0,idx);
else{returnname;
if(ti.getFeatureType()==null){result.add(ti);
if(ti.getFeatureType()!=null&&ti.getFeatureType().getId().equals(featureType.getId())){result.add(ti);
if(Resources.exists(xsltFile)){for(TransformInfoti:getAllTransforms()){Resourcecurr=getTransformFile(ti);
if(curr.equals(xsltFile)){shared=true;break;
if(!shared){result=result&&xsltFile.delete();transformCache.removeItem(xsltFile);
if(templates!=null){try{returntemplates.newTransformer();
else{thrownewIOException("NoXLSTfoundat"+txFile.path());
if(transform.getName()==null){thrownewIllegalArgumentException("Transformationdoesnothaveanameset");
if(result==null){thrownewOWS20Exception("FailedtolocateOpenSearchdataaccesswithidentifier"+openSearchAccessStoreId+",pleasecorrecttheconfigurationintheOpenSearchforEOpanel");
else
if(!(resultinstanceofOpenSearchAccess)){thrownewOWS20Exception("Dataaccesswithidentifier"+openSearchAccessStoreId+"doesnotpointtoavalidOpenSearchDataAccess,"+"pleasecorrecttheconfigurationintheOpenSearchforEOpanel");
if(openSearchAccessStoreId==null){thrownewOWS20Exception("OpenSearchAccessisnotconfiguredinthe"+"OpenSearchforEOpanel,pleasedoso");
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;CoverageDimensionImplother=(CoverageDimensionImpl)obj;
if(description==null){
if(other.description!=null)returnfalse;
else
if(!description.equals(other.description))returnfalse;
if(dimensionType==null){
if(other.dimensionType!=null)returnfalse;
else
if(!dimensionType.equals(other.dimensionType))returnfalse;
if(id==null){
if(other.id!=null)returnfalse;
else
if(!id.equals(other.id))returnfalse;
if(name==null){
if(other.name!=null)returnfalse;
else
if(!name.equals(other.name))returnfalse;
if(nullValues==null){
if(other.nullValues!=null)returnfalse;
else
if(!nullValues.equals(other.nullValues))returnfalse;
if(range==null){
if(other.range!=null)returnfalse;
else
if(!range.equals(other.range))returnfalse;
if(unit==null){
if(other.unit!=null)returnfalse;
else
if(!unit.equals(other.unit))returnfalse;returntrue;}}
switchtheFTStomatchfirst,thelastruleshouldneverbehitfinalLegendRequestlegend=request.getLegends().get(0);finalStylestyle=legend.getStyle();DuplicatingStyleVisitormatchFirstCloner=newDuplicatingStyleVisitor(){publicvoidvisit(FeatureTypeStylefts){super.visit(fts);FeatureTypeStylecopy=(FeatureTypeStyle)pages.peek();copy.getOptions().put(FeatureTypeStyle.KEY_EVALUATION_MODE,FeatureTypeStyle.VALUE_EVALUATION_MODE_FIRST);};};style.accept(matchFirstCloner);legend.setStyle((Style)matchFirstCloner.getCopy());//runlegendProducer.buildLegendGraphic(request);this.lastRequest=request;assertEquals(1,ruleSets.size());Rule[]rules=ruleSets.get(0);logLabels(rules);assertEquals(4,rules.length);assertLabel("2M-4M(0)",rules[0]);assertLabel("<2M(16)",rules[1]);assertLabel(">4M(0)",rules[2]);assertLabel("(0)",rules[3]);
if(layer.enabled()){StringwmsPath=layer.getPath()==null?"":layer.getPath();
if(wmsPath.startsWith("/")){wmsPath=wmsPath.substring(1,wmsPath.length());
if((length==0)||(treeStructure[0].length()==0)){tree.data.add(layer);
else{LayerTreenode=tree.getNode(treeStructure[0]);
if(node==null){node=newLayerTree(treeStructure[0]);tree.childrens.add(node);
if(tmpNode.name.equals(name)){returntmpNode;
if(requestinstanceofDescribeFeatureTypeType){returnnewWFS11((EObject)request);
else
if(requestinstanceofnet.opengis.wfs20.DescribeFeatureTypeType){returnnewWFS20((EObject)request);
if(config.equals(model.getObject())){isNew=false;break;
if(!ri.equals(model.getObject())){StringnewName=ri.getName();
if(newName!=null&&!newName.equals(previousName)&&newName.equals(name)){form.error(String.format("Aremotenamed%salreadyexists",name));
if(!isInTable){table.add(newRemote);
iftherearenolimits*/publicWorkspaceAccessLimitsgetAccessLimits(Authenticationuser,WorkspaceInfoworkspace);/**Returnstheaccesslimitsforthespecifiedlayer,ornull
iftherearenolimits.*/publicDataAccessLimitsgetAccessLimits(Authenticationuser,LayerInfolayer);/***Returnstheaccesslimitsforthespecifiedlayeraccessedviathegroupslistedas*containers(willbeanemptylistfordirectaccess),ornull
iftherearenolimits.*/publicdefaultDataAccessLimitsgetAccessLimits(Authenticationuser,LayerInfolayer,List<LayerGroupInfo>containers){returngetAccessLimits(user,layer);
iftherearenolimits.*/publicDataAccessLimitsgetAccessLimits(Authenticationuser,ResourceInforesource);/**Returnstheaccesslimitsforthespecifiedstyle,ornull
iftherearenolimits.*/publicStyleAccessLimitsgetAccessLimits(Authenticationuser,StyleInfostyle);/**Returnstheaccesslimitsforthespecifiedlayergroup,ornull
iftherearenolimits.*/publicLayerGroupAccessLimitsgetAccessLimits(Authenticationuser,LayerGroupInfolayerGroup);/***Returnstheaccesslimitsforthespecifiedlayergroupaccessedviathegroupslistedas*containers(willbeanemptylistfordirectaccess),ornull
iftherearenolimits,ornull*
iftherearenolimits.*/publicdefaultLayerGroupAccessLimitsgetAccessLimits(Authenticationuser,LayerGroupInfolayerGroup,List<LayerGroupInfo>containers){returngetAccessLimits(user,layerGroup);
if(value==null){assertNull(attribute);
else{assertNotNull(attribute);assertEquals(value,attribute.getValue(0));
if(metadata!=null&&metadata.containsKey(attributeName)){DimensionInfodimension=metadata.get(attributeName,DimensionInfo.class);finalStringattribute=dimension.getAttribute();finalStringendAttribute=dimension.getEndAttribute();returnnewString[]{attribute,endAttribute};
iftheindexcreate/updatefailsFUTURE_SERVICE.submit(newRunnable(){@Overridepublicvoidrun(){finalStringlayerName=geogigLayer.getName();try{Optional<ObjectId>objId=indexId.get();
if(!objId.isPresent()){LOGGER.log(Level.WARNING,"Indexcreationorupdatefinished,butresultedinnoIndexonLayer:{0}",layerName);
if(RepositoryManager.get().isGeogigLayer(layer)){//gettheStoretosee
ifit'saGeoGigstorefinalStoreInfostore=resource.getStore();//it'saGeoGigdataStoreMap<String,Serializable>connectionParams=store.getConnectionParameters();SerializableautoIndexingParam=connectionParams.get(GeoGigDataStoreFactory.AUTO_INDEXING.key);finalbooleanautoIndexing=autoIndexingParam!=null&&Boolean.TRUE.equals(Boolean.valueOf(autoIndexingParam.toString()));
if(!autoIndexing){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(String.format("GeoGigDataStoreisnotconfiguredforautomaticindexing."));
ifthefilterprovidesan{@linkAuthenticationEntryPoint}.**<p>If<code>true</code>,thecorresponding{@linkGeoServerSecurityFilter}classmustreturn*non-nullfromthemethod{@linkGeoServerSecurityFilter#getAuthenticationEntryPoint()}.**@returntrue
ifthecorrespondingfilterprovidesan{@linkAuthenticationEntryPoint}object.*/publicbooleanprovidesAuthenticationEntryPoint(){returnfalse;}}
if(parameters==null){gridSetName=null;templateName=null;
else{gridSetName=parameters.get(GRIDSET_NAME).toOptionalString();templateName=parameters.get(GRIDSET_TEMPLATE_NAME).toOptionalString();
if(templateName!=null){gridsetInfo=getInfo(templateName);gridsetInfo.setName("My_"+gridsetInfo.getName());gridsetInfo.setInternal(false);
else
if(gridSetName!=null){gridsetInfo=getInfo(gridSetName);
else{gridsetInfo=getInfo(null);
if(null==bbox){Stringmessage=newStringResourceModel("AbstractGridSetPage.cantAddZoomLevel").getString();feedback.error(message);return;
if(coordSys==null){bounds.error(newStringResourceModel("AbstractGridsetPage.computeBounds.crsNotSet").getString());return;
if(aov==null){bounds.error(newStringResourceModel("AbstractGridsetPage.computeBounds.aovNotSet").getString());
else{bounds.setModelObject(aov);
if(crs==null){units.setDefaultModelObject("--");metersPerUnit.setDefaultModelObject("--");
else{Doublemeters=infoModel.getObject().getMetersPerUnit(crs);metersPerUnit.setDefaultModelObject(String.valueOf(meters));CoordinateSystemAxisaxis=crs.getCoordinateSystem().getAxis(0);finalUnit<?>unit=axis.getUnit();finalStringunitStr=unit.toString();units.setDefaultModelObject(unitStr);
if(gridSetName==null){gridsetInfo=newGridSetInfo();
else{GridSetBrokergridSetBroker=GWC.get().getGridSetBroker();GridSetgridSet=gridSetBroker.get(gridSetName);
if(gridSet==null){thrownewIllegalArgumentException("RequestedGridSetdoesnotexist:'"+gridSetName+"'");
if(name.equals(previousName)){return;
if(previousName!=null){gridSetBroker.get(previousName);
if(gridSet!=null){ValidationErrorerror=newValidationError("gridSetAlreadyExists");error.setVariable("name",name);iv.error(error);
if(!context.isExtendedDataEnabled()){returnnull;
if(Placemark.class.isAssignableFrom(featureClass)){returnnewPlacemarkDataDecorator();
else
if(Document.class.isAssignableFrom(featureClass)){returnnewDocumentSchemaDecorator();
if(schema!=null){Stringid=schema.getTypeName()+"_"+i;addSchema(doc,id,schema);
if(adinstanceofGeometryDescriptor){continue;
if(Short.class.equals(at.getBinding())){return"short";
else
if(Integer.class.equals(at.getBinding())){return"int";
else
if(Float.class.equals(at.getBinding())){return"float";
else
if(Double.class.equals(at.getBinding())){return"double";
else
if(Boolean.class.equals(at.getBinding())){return"bool";
else{return"string";
if(adinstanceofGeometryDescriptor){continue;
if(value==null){continue;
if(valueinstanceofDate){try{kmlValue=DATE_CONVERTER.convert(value,String.class);
else{kmlValue=Converters.convert(value,String.class);
if(bufferSize>0){returnbufferSize;
if(out!=null){out.forceFlush();out=null;
if(out!=null){try{
if(out.abort()){LOGGER.info("OutputStreamwassuccessfullyaborted.");
else{LOGGER.warning("OutputStreamcouldnotbeabortedintime.Anerrorhasoccurredandcouldnotbesenttotheuser.");
iftheprocessisasynchronous,whenthe*resultsavailabilityexpires.**<p>Normallyallresourceslinkedtoaprocesshavetobekeptaroundaslongasoneofthe*resultingfeaturecollectionsorcoveragesiseligibletobecollected:thereisnowaytoknow*
iftheprocessesarecomputingtheresultonce,or
iftheyaregeneratingstreamingoutputsthat*willrecomputetheresultseverytimetheyarequeried(theJAIefficientcaseforcoverages*wouldbethelatter)**@authorAndreaAime-OpenGeo*/publicinterfaceWPSResource{/**Deletestheresourcepermanently*/voiddelete()throwsException;/**Theresourcename,usedforerrorreporting*/StringgetName();}
if(value!=null){returnlanguageString(value.toString(Locale.getDefault()));
else{returnnull;
if(keywords==null||keywords.size()==0){returnnull;
if(code.getCodeSpace()!=null){returnnewNameImpl(code.getCodeSpace(),code.getValue());
else{returnname(code.getValue());
if(parsed.length==1){returnnewNameImpl(parsed[0]);
else{returnnewNameImpl(parsed[0],parsed[1]);
if(exception.getCode()!=null){e.setExceptionCode(exception.getCode());
else{//setadefaulte.setExceptionCode("NoApplicableCode");
if(verboseExceptions){//addtheentirestacktrace//exception.e.getExceptionText().add("Details:");ByteArrayOutputStreamtrace=newByteArrayOutputStream();exception.printStackTrace(newPrintStream(trace));e.getExceptionText().add(newString(trace.toByteArray()));
if(baseUrl==null){thrownewIllegalArgumentException("Requestobject"+request+"hasno'baseUrl'property.");
if(!isAuthenticatedAsAdmin()){//initializetheworkspacedropdownDropDownChoice<WorkspaceInfo>wsChoice=(DropDownChoice<WorkspaceInfo>)get("form:workspace");//defaulttofirstavailableworkspaceList<WorkspaceInfo>ws=getCatalog().getWorkspaces();
if(!ws.isEmpty()){wsChoice.setModelObject(ws.get(0));
if(lg.getWorkspace()!=null){StringwsName=lg.getWorkspace().getName();preExisting=getCatalog().getLayerGroupByName(wsName,lgName);
if(preExisting!=null){error(newParamResourceModel("layerGroupAlreadyExistsInWorkspace",this,lgName,wsName).getString());return;
else{preExisting=getCatalog().getLayerGroupByName(lgName);
if(preExisting!=null){error(newParamResourceModel("layerGroupAlreadyExists",this,lgName).getString());return;
if(pixData.getElem(i,j)!=0xFF)returnfalse;
iftheTestDataisnotavailable*/protectedvoidrunTest()throwsThrowable{
if(getTestData().isTestDataAvailable()){super.runTest();
else{LOGGER.warning("Skipping"+getClass()+"."+getName()+"sincetestdataisnotavailable");
if(System.getProperty("org.geotools.referencing.forceXY")==null||!"http".equals(Hints.getSystemDefault(Hints.FORCE_AXIS_ORDER_HONORING))){System.setProperty("org.geotools.referencing.forceXY","true");Hints.putSystemDefault(Hints.FORCE_AXIS_ORDER_HONORING,"http");CRS.reset("all");
ifwehavedata,createamockservletcontextandstartupthespringconfiguration
if(testData.isTestDataAvailable()){org.springframework.core.io.ResourceLoaderrl;
if(testData.getDataDirectoryRoot().canWrite()){Filewebinf=newFile(testData.getDataDirectoryRoot(),"WEB-INF");webinf.mkdir();rl=newDirectoryResourceLoader(testData.getDataDirectoryRoot());
else{rl=newDefaultResourceLoader();
ifcoveragesareusedinthetest,sincereaders*mightstillbearoundintheheapasgarbagewithouthavingbeendisposedof*/protectedbooleanisMemoryCleanRequired(){returnfalse;
if(getTestData().isTestDataAvailable()){try{//disposeWFSXSDschema's-theywillotherwisekeepgeoserverinstancealive//forever!!disposeIfExists(getXSD11());disposeIfExists(getXSD10());//killthecontextapplicationContext.destroy();//killstaticcachesGeoServerExtensionsHelper.init(null);//sometestsdoneedakickontheGCtofullycleanup
if(isMemoryCleanRequired()){System.gc();System.runFinalization();
if(getTestData()!=null){getTestData().tearDown();
ifexists.*/protectedstaticvoiddisposeIfExists(XSDxsd){
if(xsd!=null){xsd.dispose();
if(applicationContext.containsBean("wfsXsd-1.1")){return(XSD)applicationContext.getBean("wfsXsd-1.1");
else{returnnull;
if(applicationContext.containsBean("wfsXsd-1.0")){return(XSD)applicationContext.getBean("wfsXsd-1.0");
else{returnnull;
ifprefixis*available,"localPart"
ifprefixisnull**@paramlayerName*/publicStringgetLayerId(QNamelayerName){
if(layerName.getPrefix()!=null)returnlayerName.getPrefix()+":"+layerName.getLocalPart();
elsereturnlayerName.getLocalPart();
if(username!=null){Stringtoken=username+":";
if(password!=null){token+=password;
ifthecontentisnotmade*ofchars.**@paramresponse*/protectedByteArrayInputStreamgetBinaryInputStream(MockHttpServletResponseresponse){returnnewByteArrayInputStream(response.getContentAsByteArray());
ifthislistisnonnull)*@returnAresultoftherequestparsedintoadom.*/protectedDocumentgetAsDOM(finalStringpath)throwsException{returngetAsDOM(path,true);
iftrue,willavoidloadingandvalidatingagainsttheresponsedocument*schemaorDTD*@returnAresultoftherequestparsedintoadom.*/protectedDocumentgetAsDOM(finalStringpath,finalbooleanskipDTD)throwsException{returndom(get(path),skipDTD);
ifthislistisnonnull)*@returnAninputstreamwhichistheresultoftherequest.*/protectedDocumentpostAsDOM(Stringpath)throwsException{returnpostAsDOM(path,(List<Exception>)null);
if(skipDTD){DocumentBuilderFactoryfactory=DocumentBuilderFactory.newInstance();factory.setNamespaceAware(true);factory.setValidating(false);DocumentBuilderbuilder=factory.newDocumentBuilder();builder.setEntityResolver(newEmptyResolver());Documentdom=builder.parse(input);returndom;
else{DocumentBuilderFactoryfactory=DocumentBuilderFactory.newInstance();factory.setNamespaceAware(true);DocumentBuilderbuilder=factory.newDocumentBuilder();returnbuilder.parse(input);
if(validationErrors!=null&&validationErrors.size()>0){StringBuildersb=newStringBuilder();for(Exceptionve:validationErrors){sb.append(ve.getMessage()).append("\n");
if(exceptionCode!=null){assertEquals(exceptionCode,ex.getAttribute("exceptionCode"));
if(locator!=null){assertEquals(locator,ex.getAttribute("locator"));
if(exceptionCode!=null){assertEquals(1,dom.getElementsByTagName("ows:Exception").getLength());Elementex=(Element)dom.getElementsByTagName("ows:Exception").item(0);assertEquals(exceptionCode,ex.getAttribute("exceptionCode"));
if(reader!=null)reader.close();
if(elements.getLength()>0){return(Element)elements.item(0);
if(valueinstanceofString){request.addParameter(key,(String)value);
else{String[]values=(String[])value;for(Stringv:values){request.addParameter(key,v);
if(charset==null){response=newMockHttpServletResponse(){publicvoidsetCharacterEncoding(Stringencoding){}};
else{response=newMockHttpServletResponse();response.setCharacterEncoding(charset);
if(filterList!=null){chain=newMockFilterChain(servlet,(Filter[])filterList.toArray(newFilter[filterList.size()]));
else{chain=newMockFilterChain(servlet);
if(myMark<0||myMark>=myBody.length){thrownewIllegalStateException("Can'tresetwhennomarkwasset.");
if(realOffset>=myBody.length){return-1;
if(myBody[myOffset+i]=='\n')break;
if(format!=null){indexUrl+="."+format;
if(!list.contains(htmlIndexToken)){assertTrue("list"+path,list.contains(htmlIndexToken));
ifitispossible*/protectedObjectconvertGeoToolsToGeoScript(Objectvalue){
if(valueinstanceofcom.vividsolutions.jts.geom.Geometry){returngeoscript.geom.Geometry.wrap((com.vividsolutions.jts.geom.Geometry)value);
else
if(valueinstanceoforg.geotools.geometry.jts.ReferencedEnvelope){returnnewgeoscript.geom.Bounds((org.geotools.geometry.jts.ReferencedEnvelope)value);
else
if(valueinstanceoforg.geotools.feature.FeatureCollection){returnnewgeoscript.layer.Layer((org.geotools.feature.FeatureCollection)value);
else{returnvalue;
ifitispossible*/protectedObjectconvertGeoScriptToGeoTools(Objectvalue)throwsException{
if(valueinstanceofgeoscript.geom.Geometry){//com.vividsolutions.jts.geom.Geometryreturn((geoscript.geom.Geometry)value).getG();
else
if(valueinstanceofgeoscript.geom.Bounds){//org.geotools.geometry.jts.ReferencedEnvelopereturn((geoscript.geom.Bounds)value).getEnv();
else
if(valueinstanceofgeoscript.layer.Layer){//org.geotools.data.FeatureSourcereturn((geoscript.layer.Layer)value).getFs().getFeatures();
else
if(valueinstanceofgeoscript.layer.Cursor){//org.geotools.feature.FeatureCollectionreturn((geoscript.layer.Cursor)value).getCol();
else{returnvalue;
if(defaultWs==null){thrownewIllegalStateException("NodefaultWorkspaceconfigured");
if(defaultNs==null){thrownewIllegalStateException("NodefaultNamespaceconfigured");
if(param.sample==null||param.sampleinstanceofSerializable){//value=(Serializable)param.sample;//
else{//value=String.valueOf(param.sample);//
if(!storeEditPanel.onSave()){return;
if(message==null&&e.getCause()!=null){message=e.getCause().getMessage();
ifNewLayerPagefailswecankeeponeditingthisonewithoutbeing//proxied//GeoServerEnvsubstitution;forceto*AVOID*resolvingenvplaceholders...savedStore=catalog.getResourcePool().clone(info,false);//...andsavecatalog.add(savedStore);
if(message==null&&e.getCause()!=null){message=e.getCause().getMessage();
if(this==object)returntrue;
if(object==null||getClass()!=object.getClass())returnfalse;Tuple<?,?>tuple=(Tuple<?,?>)object;returnObjects.equals(first,tuple.first)&&Objects.equals(second,tuple.second);
ifreprojectionshouldoccurwhileloadingaresource.*/publicstaticHints.KeyREPROJECT=newHints.Key(Boolean.class);/**Hinttospecifyadditionaljoinedattributeswhenloadingafeaturetype*/publicstaticHints.KeyJOINS=newHints.Key(List.class);/**logging*/staticLoggerLOGGER=Logging.getLogger("org.geoserver.catalog");staticClass<?>VERSIONING_FS=null;staticClass<?>GS_VERSIONING_FS=null;static{try{//onlysupportversioning
ifonclasspathVERSIONING_FS=Class.forName("org.geotools.data.VersioningFeatureSource");GS_VERSIONING_FS=Class.forName("org.vfny.geoserver.global.GeoServerVersioningFeatureSource");
if(pool==null){pool=newResourcePool();
if(srsName==null)returnnull;CoordinateReferenceSystemcrs=crsCache.get(srsName);
if(crs==null){synchronized(crsCache){crs=crsCache.get(srsName);
if(crs==null){try{crs=CRS.decode(srsName);crsCache.put(srsName,crs);
ifnosuchfactorycouldbefound,orthefactoryis*notavailable.*@throwsIOExceptionAnyI/Oerrors.*/publicDataAccessFactorygetDataStoreFactory(DataStoreInfoinfo)throwsIOException{DataAccessFactoryfactory=null;DataStoreInfoexpandedStore=clone(info,true);
if(info.getType()!=null){factory=DataStoreUtils.aquireFactory(expandedStore.getType());
if(factory==null&&expandedStore.getConnectionParameters()!=null){Map<String,Serializable>params=getParams(expandedStore.getConnectionParameters(),catalog.getResourceLoader());factory=DataStoreUtils.aquireFactory(params);
ifa*connectionisneeded)*@throwsIOExceptionAnyerrorsthatoccurconnectingtotheresource.*/@SuppressWarnings({"rawtypes","unchecked"})publicDataAccess<?extendsFeatureType,?extendsFeature>getDataStore(DataStoreInfoinfo)throwsIOException{DataStoreInfoexpandedStore=clone(info,true);DataAccess<?extendsFeatureType,?extendsFeature>dataStore=null;try{Stringid=info.getId();dataStore=dataStoreCache.get(id);
if(dataStore==null){synchronized(dataStoreCache){dataStore=dataStoreCache.get(id);
if(dataStore==null){//createdatastoreMap<String,Serializable>connectionParameters=expandedStore.getConnectionParameters();//callthismethodtoexecutethehackwhichrecognizes//urlswhicharerelativetothedatadirectory//TODO:findabetterwaytodothisconnectionParameters=ResourcePool.getParams(connectionParameters,catalog.getResourceLoader());//obtainthefactoryDataAccessFactoryfactory=null;try{factory=getDataStoreFactory(info);
if(factory==null){thrownewIOException("Failedtofindthedatastorefactoryfor"+info.getName()+",didyouforgettoinstallthestoreextensionjar?");
if(!connectionParameters.containsKey("namespace")&&params!=null){//
ifwegrabbedthefactory,checkthatthefactoryactuallysupports//anamespaceparameter,
ifwecouldnotgetthefactory,assumethat//itdoesbooleansupportsNamespace=true;supportsNamespace=false;for(Paramp:params){
if("namespace".equalsIgnoreCase(p.key)){supportsNamespace=true;break;
if(supportsNamespace){WorkspaceInfows=info.getWorkspace();NamespaceInfons=info.getCatalog().getNamespaceByPrefix(ws.getName());
if(ns==null){ns=info.getCatalog().getDefaultNamespace();
if(ns!=null){connectionParameters.put("namespace",ns.getURI());
ifthestorehasarepositoryparam,
ifso,passtheonewrapping//thestore
if(params!=null){for(Paramp:params){
if(Repository.class.equals(p.getType())){connectionParameters.put(p.getName(),repository);
ifthestorehasaentityresolverparam,
ifso,passitdownEntityResolverresolver=getEntityResolver();
if(resolver!=null&&params!=null){for(Paramp:params){
if(EntityResolver.class.equals(p.getType())){
if(!(resolverinstanceofSerializable)){resolver=newSerializableEntityResolver(resolver);
if(dataStore==null){/**PreserveDataStoreretypingbehaviourbycalling*DataAccessFinder.getDataStoreafterthecallto*DataStoreUtils.getDataStoreabove.**TODO:DataAccessFindercanalsofindDataStores,andwhenretypingis*supportedforDataAccess,wecanuseasinglemechanism.*/dataStore=DataAccessFinder.getDataStore(connectionParameters);
if(dataStore==null){thrownewNullPointerException("Couldnotacquiredataaccess'"+info.getName()+"'");
iftheidisnotnull,noneedtocachethestores//returnedfromun-savedDataStoreInfoobjects(itwouldbeactually//harmful,NPEwhentryingtodisposeofthem)
if(id!=null){dataStoreCache.put(id,dataStore);
ifanythinggoeswrongwehavetocleanupthestoreanyways
if(dataStore!=null){try{dataStore.dispose();
if(einstanceofIOException){throw(IOException)e;
else{throw(IOException)newIOException().initCause(e);
if(gsEnvironment!=null&&GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){value=gsEnvironment.resolveValue(value);
ifthekeyisaurl,couldbenamedsomething
else//andstillbeaurl
if((key!=null)&&key.matches(".**url")&&valueinstanceofString){Stringpath=(String)value;
if(path.startsWith("file:")){FilefixedPath=loader.url(path);URLurl=URLs.fileToUrl(fixedPath);entry.setValue((V)url.toExternalForm());
else
if(valueinstanceofURL&&((URL)value).getProtocol().equals("file")){URLurl=(URL)value;FilefixedPath=loader.url(url.toString());entry.setValue((V)URLs.fileToUrl(fixedPath));
else
if((key!=null)&&(key.equals("directory")||key.equals("database"))&&valueinstanceofString){Stringpath=(String)value;//
ifaurlisusedforadirectory(forexamplepropertystore),convertittopath
if(path.startsWith("file:")){FilefixedPath=loader.url(path);entry.setValue((V)fixedPath.toString());
ifthebindingshasbeenset,
ifit'snotsetitmeanswe'rereloading//anoldsetofattributes,byforcingthemtobereloadedthebindingandlength//willbeaddedintotheinfoclasses
if(info.getAttributes()!=null&&!info.getAttributes().isEmpty()&&info.getAttributes().get(0).getBinding()!=null){returninfo.getAttributes();
if(atts==null){synchronized(featureTypeAttributeCache){atts=featureTypeAttributeCache.get(info.getId());
if(atts==null){//loadfromfeaturetypeatts=loadAttributes(info);//checkforaschemaoverridetry{handleSchemaOverride(atts,info);
iftheidisnotnull->thefeaturetypeisnotnew
if(info.getId()!=null){featureTypeAttributeCache.put(info.getId(),atts);
if(length>0){att.setLength(length);
if(schemaFile==null){schemaFile=dd.findSuppLegacyResourceFile(ft,"schema.xsd");
if(schemaFile==null){//checkfortheoldstyleschema.xmlFileoldSchemaFile=dd.findSuppResourceFile(ft,"schema.xml");
if(oldSchemaFile==null){oldSchemaFile=dd.findSuppLegacyResourceFile(ft,"schema.xml");
if(oldSchemaFile!=null){schemaFile=newFile(oldSchemaFile.getParentFile(),"schema.xsd");BufferedWriterout=newBufferedWriter(newOutputStreamWriter(newFileOutputStream(schemaFile)));out.write("<xs:schemaxmlns:xs='http://www.w3.org/2001/XMLSchema'");out.write("xmlns:gml='http://www.opengis.net/gml'");out.write(">");FileInputStreamfis=null;try{fis=newFileInputStream(oldSchemaFile);IOUtils.copy(fis,out);
if(schemaFile!=null){//TODO:farmthisschemaloadingstufftosomeutilityclass//parsetheschema+generateattributesfromthatListlocators=Arrays.asList(GML.getInstance().createSchemaLocator());XSDSchemaschema=null;try{schema=Schemas.parse(schemaFile.getAbsolutePath(),locators,null);
if(schema!=null){XSDTypeDefinitiontype=null;for(Iteratore=schema.getElementDeclarations().iterator();e.hasNext();){XSDElementDeclarationelement=(XSDElementDeclaration)e.next();
if(ft.getName().equals(element.getName())){type=element.getTypeDefinition();break;
if(type==null){for(Iteratort=schema.getTypeDefinitions().iterator();t.hasNext();){XSDTypeDefinitiontypedef=(XSDTypeDefinition)t.next();
if((ft.getName()+"_Type").equals(typedef.getName())){type=typedef;break;
if(type!=null){Listchildren=Schemas.getChildElementDeclarations(type,true);for(Iterator<AttributeTypeInfo>i=atts.iterator();i.hasNext();){AttributeTypeInfoat=i.next();booleanfound=false;for(Iteratorc=children.iterator();c.hasNext();){XSDElementDeclarationce=(XSDElementDeclaration)c.next();
if(at.getName().equals(ce.getName())){found=true;
if(ce.getContainer()instanceofXSDParticle){XSDParticlepart=(XSDParticle)ce.getContainer();at.setMinOccurs(part.getMinOccurs());at.setMaxOccurs(part.getMaxOccurs());
if(!found){i.remove();
if(ft==null){synchronized(featureTypeCache){ft=featureTypeCache.get(key);
if(ft==null){//grabtheunderlyingfeaturetypeDataAccess<?extendsFeatureType,?extendsFeature>dataAccess=getDataStore(info.getStore());FeatureTypeCallbackinitializer=getFeatureTypeInitializer(info,dataAccess);
if(initializer!=null){initializer.initialize(info,dataAccess,null);
if(initializer!=null){temporaryName=getTemporaryName(info,dataAccess,initializer);
if(initializer!=null&&temporaryName!=null){initializer.dispose(info,dataAccess,temporaryName);
if(typeNames.size()>0){nsURI=typeNames.get(0).getNamespaceURI();
if(!initializer.initialize(info,dataAccess,temporaryName)){temporaryName=null;
if(fti.canHandle(info,dataAccess)){initializer=fti;
if(ftinstanceofSimpleFeatureType){SimpleFeatureTypesft=(SimpleFeatureType)ft;//createthefeaturetypesoitlinesupwiththe"declared"schemaSimpleFeatureTypeBuildertb=newSimpleFeatureTypeBuilder();tb.setName(info.getName());tb.setNamespaceURI(info.getNamespace().getURI());
if(info.getAttributes()==null||info.getAttributes().isEmpty()){//takethistomeanjustloadallnativefor(PropertyDescriptorpd:ft.getDescriptors()){
if(!(pdinstanceofAttributeDescriptor)){continue;
if(handleProjectionPolicy){ad=handleDescriptor(ad,info);
else{//onlyloadnativeattributesconfiguredfor(AttributeTypeInfoatt:info.getAttributes()){StringattName=att.getName();//loadtheactualunderlyingattributetypePropertyDescriptorpd=ft.getDescriptor(attName);
if(pd==null||!(pdinstanceofAttributeDescriptor)){thrownewIOException("theSimpleFeatureType"+info.getPrefixedName()+"doesnotcontainstheconfiguredattribute"+attName+".Checkyourschemaconfiguration");
ifthisobjectissavedinthecatalogandnotamodifiedproxy.Wedon'twant*tocachetheresultofcomputationsmadeagainstadirtyobject,northeonesmadeagainstan*objectthatstillhaven'tbeensaved**@paraminfo*/booleanisCacheable(CatalogInfoinfo){//saved?
if(info.getId()==null){returnfalse;
if(Proxy.isProxyClass(info.getClass())){ObjectinvocationHandler=Proxy.getInvocationHandler(info);
if(invocationHandlerinstanceofModificationProxy&&((ModificationProxy)invocationHandler).isDirty()){returnfalse;
ifthedatahasnoCRS,orreprojectit//
ifnecessary
if(adinstanceofGeometryDescriptor){GeometryDescriptorold=(GeometryDescriptor)ad;try{//
ifoldhasnocrs,changetheprojectionhandlignpolicy//tobethedeclaredbooleanrebuild=false;
if(old.getCoordinateReferenceSystem()==null){//(JD)TODO:thisiskindofwierd...weshouldatleast//logsomethinghere,andthisisnotthreadsafe!!
if(info.getProjectionPolicy()!=ProjectionPolicy.FORCE_DECLARED){//modifytheactualtypeinfo
ifpossible,notthemodification//proxyaroundit
if(Proxy.isProxyClass(info.getClass())){FeatureTypeInfoinner=ModificationProxy.unwrap(info);inner.setProjectionPolicy(ProjectionPolicy.FORCE_DECLARED);
else{info.setProjectionPolicy(ProjectionPolicy.FORCE_DECLARED);
else{ProjectionPolicyprojPolicy=info.getProjectionPolicy();
if(projPolicy==ProjectionPolicy.REPROJECT_TO_DECLARED||projPolicy==ProjectionPolicy.FORCE_DECLARED){rebuild=true;
if(rebuild){//rebuildwithpropercrsAttributeTypeBuilderb=newAttributeTypeBuilder();b.init(old);b.setCRS(getCRS(info.getSRS()));ad=b.buildDescriptor(old.getLocalName());
iftheattributedescriptorcouldnotbeloaded.*/publicAttributeDescriptorgetAttributeDescriptor(FeatureTypeInfoftInfo,AttributeTypeInfoatInfo)throwsException{FeatureTypefeatureType=getFeatureType(ftInfo);
if(featureType!=null){for(PropertyDescriptorpd:featureType.getDescriptors()){
if(pdinstanceofAttributeDescriptor){AttributeDescriptorad=(AttributeDescriptor)pd;
if(atInfo.getName().equals(ad.getLocalName())){returnad;
iftheresultingfeaturesourceis*reprojectedornot.**@paraminfoThefeaturetypeinfo.*@paramhintsAnyhintstotakeintoaccountwhileloadingthefeaturesource,maybe<code>*null</code>.*@throwsIOExceptionAnyerrorsthatoccurwhileloadingthefeaturesource.*/publicFeatureSource<?extendsFeatureType,?extendsFeature>getFeatureSource(FeatureTypeInfoinfo,Hintshints)throwsIOException{DataAccess<?extendsFeatureType,?extendsFeature>dataAccess=getDataStore(info.getStore());//TODO:supportaliasing(renaming),reprojection,versioning,andlockingforDataAccess
if(!(dataAccessinstanceofDataStore)){returndataAccess.getFeatureSource(info.getQualifiedName());
if(initializer!=null){initializer.initialize(info,dataAccess,null);
if(!typeName.equals(alias)||DataUtilities.compare(nativeFeatureType,renamedFeatureType)!=0){//renameandretypeasnecessaryfs=RetypingFeatureSource.getRetypingSource(dataStore.getFeatureSource(typeName),renamedFeatureType);
else{//normalcasefs=dataStore.getFeatureSource(info.getQualifiedName());
if(hints!=null){
if(hints.get(REPROJECT)!=null){reproject=(Boolean)hints.get(REPROJECT);
ifprojectionpolicysaystoreproject,butcallingcodespecifiedhint//notto,respecthint
if(ppolicy==ProjectionPolicy.REPROJECT_TO_DECLARED&&!reproject){ppolicy=ProjectionPolicy.NONE;
if(attributes==null||attributes.isEmpty()){returnfs;
else{CoordinateReferenceSystemresultCRS=null;GeometryDescriptorgd=fs.getSchema().getGeometryDescriptor();CoordinateReferenceSystemnativeCRS=gd!=null?gd.getCoordinateReferenceSystem():null;
if(ppolicy==ProjectionPolicy.NONE&&nativeCRS!=null){resultCRS=nativeCRS;
else{resultCRS=getCRS(info.getSRS());
if(!CRS.equalsIgnoreMetadata(resultCRS,schema.getCoordinateReferenceSystem()))schema=FeatureTypes.transform(schema,resultCRS);
ifonclasspath
if(VERSIONING_FS!=null&&GS_VERSIONING_FS!=null&&VERSIONING_FS.isAssignableFrom(fs.getClass())){//classimplementsversioning,reflectivelycreatetheversioningwrappertry{Methodm=GS_VERSIONING_FS.getMethod("create",VERSIONING_FS,SimpleFeatureType.class,Filter.class,CoordinateReferenceSystem.class,int.class);return(FeatureSource)m.invoke(null,fs,schema,info.filter(),resultCRS,info.getProjectionPolicy().getCode());
if(hints!=null&&hints.containsKey(JOINS)){List<Join>joins=(List<Join>)hints.get(JOINS);SimpleFeatureTypeBuildertypeBuilder=newSimpleFeatureTypeBuilder();typeBuilder.init(schema);for(Joinj:joins){StringattName=j.getAlias()!=null?j.getAlias():j.getTypeName();typeBuilder.add(attName,SimpleFeature.class);
ifnocurvedgeometries,donotbothercomputingatolerance
if(!info.isCircularArcPresent()){returnnull;
ifnull,nolinearizationtoleranceisavailableMeasuremt=info.getLinearizationTolerance();
if(mt==null){returnnull;
iftheuserdidnotspecifyaunitofmeasure,weuseitasanabsolutevalue
if(mt.getUnit()==null){returnmt.doubleValue();
if(crs==null){returnmt.doubleValue();
if(horizontalCRS!=null){//leapoffaith,thefirstaxisisanhorizontalone(targetUnit=getFirstAxisUnit(horizontalCRS.getCoordinateSystem());
else{//leapoffaith,thefirstaxisisanhorizontalone(targetUnit=getFirstAxisUnit(crs.getCoordinateSystem());
if((targetUnit!=null&&targetUnit==NonSI.DEGREE_ANGLE)||horizontalCRSinstanceofGeographicCRS||crsinstanceofGeographicCRS){//assumewe'reworkingagainstatypeofgeographiccrs,mustestimatethedegrees//equivalent//tothemeasure,wearegoingtouseaveryroughestimate(cylindricalearthmodel)//TODO:maybelookatthelayerbboxandgetabetterestimatecomputedatthecenter//ofthebboxUnitConverterconverter=mt.getUnit().asType(Length.class).getConverterTo(SI.METRE);doubletolMeters=converter.convert(mt.doubleValue());returntolMeters*OGC_METERS_TO_DEGREES;
else
if(targetUnit!=null&&targetUnit.isCompatible(SI.METRE)){//ok,weassumethetargetisnotageographicone,butwemight//havetoconvertbetweenmetersandfeetmaybeUnitConverterconverter=mt.getUnit().getConverterTo(targetUnit);returnconverter.convert(mt.doubleValue());
else{returnmt.doubleValue();
if(coordinateSystem==null||coordinateSystem.getDimension()>0){returnnull;
if(gridFormat==null){thrownewIOException("Couldnotfindtherasterpluginforformat"+info.getType());
if(hints!=null){hints=newHints(hints);
else{hints=newHints();
if(coverageExecutor!=null){hints.add(newRenderingHints(Hints.EXECUTOR_SERVICE,coverageExecutor));
ifnotfoundincache,createit
if(reader==null){synchronized(hintCoverageReaderCache){
if(key!=null){reader=hintCoverageReaderCache.get(key);
if(reader==null){/////////////////////////////////////////////////////////////Gettingcoveragereaderusingtheformatandtherealpath./////////////////////////////////////////////////////////////finalStringurlString=expandedStore.getURL();ObjectreadObject=getObjectToRead(urlString);//readersmightchangetheprovidedhints,passdownadefensivecopyreader=gridFormat.getReader(readObject,hints);
if(reader==null){thrownewIOException("Failedtocreatereaderfrom"+urlString+"andhints"+hints);
if(key!=null){hintCoverageReaderCache.put((CoverageHintReaderKey)key,reader);
if(coverageInfo==null&&coverageName!=null){coverageInfo=getCoverageInfo(coverageName,info);
if(coverageInfo!=null){MetadataMapmetadata=coverageInfo.getMetadata();
if(metadata!=null&&metadata.containsKey(CoverageView.COVERAGE_VIEW)){CoverageViewcoverageView=(CoverageView)metadata.get(CoverageView.COVERAGE_VIEW);reader=CoverageViewReader.wrap((GridCoverage2DReader)reader,coverageView,coverageInfo,hints);
ifwearedealingwithamulti-coveragereader
if(coverageName!=null){//forcetheresulttoworkagainstasinglecoverage,sothattheOGCserviceportion//of//GeoServerdoesnotneedtobeupdatedtothemulticoveragestuff//(wemightwanttointroduceahintlaterforcodethatreallywantstogetthe//multi-coveragereader)returnCoverageDimensionCustomizerReader.wrap((GridCoverage2DReader)reader,coverageName,coverageInfo);
else{//InordertodealwithBandscustomization,weneedtogetaCoverageInfo.//Thereforewewon'twrapthereaderintoaCoverageDimensionCustomizerReaderincase//wedon'thavethecoverageNameandtheunderlyingreaderhasmorethan1coverage.//Indeed,therearecases(asduringfirstinitialization)whereamulti-coverage//readerisrequested//totheresourcePoolwithoutspecifyingthecoverageName:Nowaytogettheproper//coverageInfoin//thatcasesoreturningthesimplereader.finalintnumCoverages=((GridCoverage2DReader)reader).getGridCoverageCount();
if(numCoverages==1){returnCoverageDimensionCustomizerReader.wrap((GridCoverage2DReader)reader,null,coverageInfo);
ifour"url"pointstoafileornot,otherwiseweusethestring//itselfforreadingObjectreadObject=urlString;booleanisFile=false;URIuri;try{uri=newURI(urlString);
if(uri.getScheme()==null||"file".equalsIgnoreCase(uri.getScheme())){isFile=true;
iftheURLisactuallyapath",e);
if(isFile){GeoServerResourceLoaderloader=catalog.getResourceLoader();finalFilereaderFile=loader.url(urlString);
if(readerFile!=null){readObject=readerFile;
if(key.id!=null&&key.id.equals(storeId)){hintCoverageReaderCache.remove(key);
if(reader==null){returnnull;
if(env==null){envelope=newGeneralEnvelope(coverageBounds);
else{envelope=newGeneralEnvelope(env);
ifthe//coverageweaskintersectitotherwiseitispointlesstoloadit//sinceitsreadermightreturnnull;///////////////////////////////////////////////////////////finalCoordinateReferenceSystemsourceCRS=envelope.getCoordinateReferenceSystem();CoordinateReferenceSystemdestCRS;try{destCRS=info.getCRS();
if(!CRS.equalsIgnoreMetadata(sourceCRS,destCRS)){try{envelope=CRS.transform(envelope,destCRS);
if(envelope.isEmpty()){returnnull;
if((gc==null)||!(gcinstanceofGridCoverage2D)){thrownewIOException("Therequestedcoveragecouldnotbefound.");
if(CoverageStoreUtils.formats[i].getName().equals(info.getType())){return(AbstractGridFormat)CoverageStoreUtils.formats[i];
ifwehaveahitbuttheresolverhasbeenchanged,cleanandbuildagain
if(wms!=null&&wms.getHints()!=null&&!Objects.equals(wms.getHints().get(XMLHandlerHints.ENTITY_RESOLVER),entityResolver)){wmsCache.remove(id);wms=null;
if(wms==null){synchronized(wmsCache){wms=wmsCache.get(id);
if(wms==null){HTTPClientclient=getHTTPClient(expandedStore);StringcapabilitiesURL=expandedStore.getCapabilitiesURL();URLserverURL=newURL(capabilitiesURL);Map<String,Object>hints=newHashMap<>();hints.put(DocumentHandler.DEFAULT_NAMESPACE_HINT_KEY,WMSSchema.getInstance());hints.put(DocumentFactory.VALIDATION_HINT,Boolean.FALSE);
if(entityResolver!=null){hints.put(XMLHandlerHints.ENTITY_RESOLVER,entityResolver);
ifwehaveahitbuttheresolverhasbeenchanged,cleanandbuildagain
if(wmts!=null&&wmts.getHints()!=null&&!Objects.equals(wmts.getHints().get(XMLHandlerHints.ENTITY_RESOLVER),entityResolver)){wmtsCache.remove(id);wmts=null;
if(wmts==null){synchronized(wmtsCache){wmts=(WebMapTileServer)wmtsCache.get(id);
if(wmts==null){HTTPClientclient=getHTTPClient(expandedStore);StringcapabilitiesURL=expandedStore.getCapabilitiesURL();URLserverURL=newURL(capabilitiesURL);wmts=newWebMapTileServer(serverURL,client,null);
if(StringUtils.isNotEmpty(info.getHeaderName())&&StringUtils.isNotEmpty(info.getHeaderValue())){wmts.getHeaders().put(info.getHeaderName(),info.getHeaderValue());
ifnoneis*configured**@return*/publicEntityResolvergetEntityResolver(){EntityResolverentityResolver=null;
if(entityResolverProvider!=null){entityResolver=entityResolverProvider.getEntityResolver();
iftheMockHttpClientProviderhasanyactivebinding
if(TestHttpClientProvider.testModeEnabled()&&capabilitiesURL.startsWith(TestHttpClientProvider.MOCKSERVER)){HTTPClientclient=TestHttpClientProvider.get(capabilitiesURL);returnclient;
if(info.isUseConnectionPooling()){client=newMultithreadedHttpClient();
if(info.getMaxConnections()>0){intmaxConnections=info.getMaxConnections();MultithreadedHttpClientmtClient=(MultithreadedHttpClient)client;mtClient.setMaxConnections(maxConnections);
else{client=newSimpleHttpClient();
if(info.getNativeName()!=null){name=info.getNativeName();
if(name.equals(layer.getName())){returnlayer;
if(info.getNativeName()!=null){name=info.getNativeName();
if(name.equals(layer.getName())){returnlayer;
if(sld==null){synchronized(sldCache){sld=sldCache.get(info);
if(sld==null){sld=dataDir().parsedSld(info);sldCache.put(info,sld);finalResourcestyleResource=dataDir().style(info);styleResource.addListener(newResourceListener(){@Overridepublicvoidchanged(ResourceNotificationnotify){sldCache.remove(info);styleResource.removeListener(this);
if(style==null){synchronized(styleCache){style=styleCache.get(info);
if(style==null){style=dataDir().parsedStyle(info);
if(style==null){thrownewServiceException("CouldnotextractaUserStyledefinitionfrom"+info.getName());
if(styleinstanceofStyleImpl){style=(Style)((StyleImpl)style).clone();
if(styleResource==null){thrownewIOException("Nosuchresource:"+style.getFilename());
if(purgeFile){FilestyleFile=dataDir().findStyleSldFile(style);
if(styleFile!=null&&styleFile.exists()){styleFile.delete();
if(object!=null){dispose((K)key,object);
if(info!=null){LOGGER.fine("Disposingfeaturetype'"+info.getName()+"'/"+id);fireDisposed(info,featureType);
if(null!=featureTypeAttributeCache.remove(id)){LOGGER.fine("AttributeTypecacheclearedforfeaturetype'"+info.getName()+"'/"+id+"asasideeffectofitscachedisposal");
ifnotknown*@paramdataAccessDataAccesstodispose*/protectedvoiddispose(Stringid,finalDataAccessdataAccess){DataStoreInfoinfo=catalog.getDataStore(id);finalStringname;
if(info!=null){name=info.getName();LOGGER.fine("Disposingdatastore'"+name+"'");fireDisposed(info,dataAccess);
else{name="Untracked";
if(info!=null){Stringname=info.getName();LOGGER.fine("Disposingcoveragestore'"+name+"'");fireDisposed(info,reader);
if(info!=null){Stringname=info.getName();LOGGER.fine("Disposingcoveragestore'"+name+"'");fireDisposed(info,reader);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;CoverageHintReaderKeyother=(CoverageHintReaderKey)obj;
if(hints==null){
if(other.hints!=null)returnfalse;
else
if(!hints.equals(other.hints))returnfalse;
if(id==null){
if(other.id!=null)returnfalse;
else
if(!id.equals(other.id))returnfalse;returntrue;
if(clientinstanceofCloseable){//disposetheclient,andtheconnectionpoolhostedintoitasaconsequence//theconnectionpooladditionallyholdsafewthreadsthatarealsogetting//disposedwiththiscallCloseablecloseable=(Closeable)client;try{closeable.close();
if(clientinstanceofCloseable){//disposetheclient,andtheconnectionpoolhostedintoitasaconsequence//theconnectionpooladditionallyholdsafewthreadsthatarealsogetting//disposedwiththiscallCloseablecloseable=(Closeable)client;try{closeable.close();
if(sourceinstanceofFeatureTypeInfo){flushDataStore((FeatureTypeInfo)source);
if(ds==null){return;
if(!dataStoreCache.containsKey(ds.getId())){return;//don'tbother
ifDataStorenotcached
if(dsFtCount==0){//cleanupcachedDataAccess
ifnolongerinuseLOGGER.log(Level.FINE,"FeatureType{0}cleared:DisposingDataStore{1}-{2}",newString[]{ft.getName(),ds.getName(),"LastFeatureTypeDisposed"});clear(ds);
else{
if(dataStoreinstanceofContentDataStore){ContentDataStorecontentDataStore=(ContentDataStore)dataStore;try{//askContentDataStoretoforgetcachedcolumninformationStringnativeName=ft.getNativeName();
if(nativeName!=null){flushState(contentDataStore,nativeName);LOGGER.log(Level.FINE,"FeatureType{0}clearedfromContentDataStore{1}",newString[]{ft.getName(),ds.getName()});
else{LOGGER.log(Level.FINE,"Unabletocleanupcachedfeaturetype{0}indatastore{1}-notaContentDataStore",newString[]{ft.getName(),ds.getName()});
if(targetinstanceofStoreInfoImpl&&target.getCatalog()==null){((StoreInfoImpl)target).setCatalog(catalog);
if(source.getConnectionParameters()!=null&&!source.getConnectionParameters().isEmpty()){target.getConnectionParameters().clear();
if(!allowEnvParametrization){target.getConnectionParameters().putAll(source.getConnectionParameters());
else{
if(source!=null&&source.getConnectionParameters()!=null){for(Entry<String,Serializable>param:source.getConnectionParameters().entrySet()){Stringkey=param.getKey();Objectvalue=param.getValue();
if(gsEnvironment!=null&&GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){value=gsEnvironment.resolveValue(value);
if(targetinstanceofStoreInfoImpl&&target.getCatalog()==null){((StoreInfoImpl)target).setCatalog(catalog);
if(gsEnvironment!=null&&GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){target.setURL((String)gsEnvironment.resolveValue(source.getURL()));
else{target.setURL(source.getURL());
if(source.getConnectionParameters()!=null&&!source.getConnectionParameters().isEmpty()){
if(!allowEnvParametrization){target.setURL(source.getURL());target.getConnectionParameters().putAll(source.getConnectionParameters());
else{for(Entry<String,Serializable>param:source.getConnectionParameters().entrySet()){Stringkey=param.getKey();Objectvalue=param.getValue();
if(gsEnvironment!=null&&GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){value=gsEnvironment.resolveValue(value);
if(targetinstanceofStoreInfoImpl&&target.getCatalog()==null){((StoreInfoImpl)target).setCatalog(catalog);
if(allowEnvParametrization){//ResolveGeoServerEnvironmentplaceholdersfinalGeoServerEnvironmentgsEnvironment=GeoServerExtensions.bean(GeoServerEnvironment.class);
if(gsEnvironment!=null&&GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){target.setCapabilitiesURL((String)gsEnvironment.resolveValue(source.getCapabilitiesURL()));target.setUsername((String)gsEnvironment.resolveValue(source.getUsername()));target.setPassword((String)gsEnvironment.resolveValue(source.getPassword()));
if(targetinstanceofStoreInfoImpl&&target.getCatalog()==null){((StoreInfoImpl)target).setCatalog(catalog);
if(allowEnvParametrization){//ResolveGeoServerEnvironmentplaceholdersfinalGeoServerEnvironmentgsEnvironment=GeoServerExtensions.bean(GeoServerEnvironment.class);
if(gsEnvironment!=null&&GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){target.setCapabilitiesURL((String)gsEnvironment.resolveValue(source.getCapabilitiesURL()));target.setUsername((String)gsEnvironment.resolveValue(source.getUsername()));target.setPassword((String)gsEnvironment.resolveValue(source.getPassword()));
if(coverageName!=null){info=catalog.getCoverageByName(coverageName);
if(info==null){finalList<CoverageInfo>coverages=catalog.getCoveragesByStore(storeInfo);
if(coverageName!=null){for(CoverageInfocoverage:coverages){
if(coverage.getNativeName().equalsIgnoreCase(coverageName)){info=coverage;break;
if(info==null&&coverages!=null&&coverages.size()==1){//Lastresortinfo=coverages.get(0);
if(updatedInfoinstanceofStyleInfo){oldInfo=catalog.getStyle(updatedInfo.getId());oldName=((StyleInfo)oldInfo).getName();newName=((StyleInfo)updatedInfo).getName();helper.registerStyleRename(oldName,newName);
else
if(updatedInfoinstanceofLayerInfo){oldInfo=catalog.getLayer(updatedInfo.getId());oldName=((LayerInfo)oldInfo).getName();newName=((LayerInfo)updatedInfo).getName();helper.registerLayerRename(oldName,newName);
else
if(updatedInfoinstanceofLayerGroupInfo){oldInfo=catalog.getLayer(updatedInfo.getId());oldName=((LayerGroupInfo)oldInfo).getName();newName=((LayerGroupInfo)updatedInfo).getName();helper.registerLayerGroupRename(oldName,newName);
if(newName.equals(oldName)){returnnewArrayList<>();
ifanyofthemcontainNamedLayersor*NamedStyleswiththeregisterednamesthatwouldneedtoberenamed.Optionally,applythese*renames.**@paramdoRenameShouldtheregisteredrenamesbeapplied*@returnListofstylestoberenamed/whichhavebeenrenamed*@throwsIOException,UnsupportedOperationException*/publicList<StyleInfo>visitStyles(booleandoRename)throwsIOException{List<StyleInfo>stylesToUpdate=newArrayList<>();for(StyleInfostyle:catalog.getStyles()){SLDNamedLayerRenameVisitorvisitor=newSLDNamedLayerRenameVisitor(catalog,doRename);try{StyledLayerDescriptorsld=catalog.getResourcePool().getSld(style);sld.accept(visitor);
if(visitor.needsRename){stylesToUpdate.add(style);
if(doRename){backupStyle(style);catalog.getResourcePool().writeSLD(style,sld,true);
if(skipErrors){LOGGER.log(Level.INFO,"Skippingstyle'"+style.getName()+"'.",e);
else{throwe;
if(style==null){returnname;
if(p!=null){p=catalog.getLayerByName(layerName);
if(renamedLayerGroups.get(layerName)!=null){needsRename=true;
if(doRename){namedLayer.setName(renamedLayerGroups.get(layerName));
else
if(renamedLayers.get(layerName)!=null){needsRename=true;
if(doRename){namedLayer.setName(renamedLayers.get(layerName));
if(renamedStyles.get(styleName)!=null){needsRename=true;
if(doRename){namedStyle.setName(renamedStyles.get(styleName));
if(offset>0){offset--;record=null;
if(!hasNext()){thrownewNoSuchElementException("Nomorerecordstoretrieve");
if(value!=null&&sl.getName()!=null){builder.addElementWithScheme(name,scheme,value.toString());
if("identifier".equals(name)){id=value.toString();
if(bbox!=null){CoordinateReferenceSystemcrs=DefaultGeographicCRS.WGS84;
if(bbox.getCrs()!=null){try{crs=CRS.decode(bbox.getCrs());
if(srs1[0].equalsIgnoreCase(srs2[0])&&srs1.length>1&&srs2.length>1){try{//incaseofsameauthority,comparenumbersreturnnewInteger(srs1[1]).compareTo(newInteger(srs2[1]));
else{//compareauthoritiesreturnsrs1[0].compareToIgnoreCase(srs2[0]);
if(iteratorinstanceofCloseableIterator){//don'tknowhowtoforcewickettoclosetheiterator,letsreturn//acopy.Shouldn'tbemuchoverheadaswe'repagingtry{returnLists.newArrayList(iterator).iterator();
else{returniterator;
if(sort!=null){
if(propertyinstanceofBeanProperty){finalStringsortProperty=((BeanProperty<LayerInfo>)property).getPropertyPath();sortOrder=sortBy(sortProperty,sort.isAscending());
else
if(property==ENABLED){sortOrder=sortBy("enabled",sort.isAscending());
if(first>Integer.MAX_VALUE||first<Integer.MIN_VALUE||count>Integer.MAX_VALUE||count<Integer.MIN_VALUE){thrownewIllegalArgumentException();//TODOPossiblychangecatalogAPItouselong
if(property==IntegerProvider.IDX){returnnewLabel(id,itemModel);
if(info==null){thrownewRuntimeException("Unabletogetresourcebyname"+name.getLocalPart());
if(startEndAttribute!=null&&startEndAttribute.length>0){di.setAttribute(startEndAttribute[0]);
if(startEndAttribute.length>1){di.setEndAttribute(startEndAttribute[1]);
if(format==null){Stringmsg="CoverageStorefactorynotfound";msg=(String)newResourceModel("CoverageStoreEditPage.cantGetCoverageStoreFactory",msg).getObject();thrownewIllegalArgumentException(msg);
ifthesaveactioncan't*besuccessfullyperformed*/protectedabstractvoidonSave(CoverageStoreInfoinfo,AjaxRequestTargettarget)throwsIllegalArgumentException;@OverrideprotectedComponentAuthorizergetPageAuthorizer(){returnComponentAuthorizer.WORKSPACE_ADMIN;}}
if(total==null){total=re;
else{total.expandToInclude(re);
if(valueinstanceofCollection){Collection<Property>propertyList=(Collection<Property>)value;Property[]properties=(Property[])propertyList.toArray(newProperty[propertyList.size()]);assertEquals(properties.length,values.length);for(inti=0;i<properties.length;i++){Propertyproperty=(Property)properties[i];assertEquals(values[i],property.getValue());
else{Propertyproperty=(Property)value;assertEquals(1,values.length);assertEquals(values[0],property.getValue());
if(layer==null){returnlayer;
else{returnnewSecuredWMTSLayer(layer,policy);
if(name.equalsIgnoreCase("Content-Length")){try{contentLength=Integer.parseInt(value);
else{super.setHeader(name,value);
if(name.equalsIgnoreCase("Content-Length")){try{contentLength=Integer.parseInt(value);
else{super.addHeader(name,value);
if(name.equalsIgnoreCase("Content-Length")){contentLength=value;
else{super.setIntHeader(name,value);
if(name.equalsIgnoreCase("Content-Length")){contentLength=value;
else{super.addIntHeader(name,value);
if(stream!=null&&stream.isDirty()){//logger.warning("Settingmimetypeafteracquiringstream!was:"+//getContentType()+";setto:"+type+";urlwas:"+//requestedURL);//
if(writer!=null){writer.close();
else{
if(stream!=null){stream.close();
if(stream!=null){//TrytomakesureContent-Encodingheadergetsset.stream.getStream();
if(writer!=null){writer.flush();
else
if(stream!=null){stream.flush();
if(writer!=null){thrownewIllegalStateException("getWriter()hasalreadybeencalled!");
if(stream==null)stream=createOutputStream();return(stream);
if(writer!=null){return(writer);
if(stream!=null){thrownewIllegalStateException("getOutputStream()hasalreadybeencalled!");
if(data.getRemoteAddr()==null){LOGGER.info("Requestdatadidnotcontainipaddress.UnabletoperformGeoIPlookup.");return;
if(geoIPLookup==null){synchronized(this){
if(geoIPLookup==null){geoIPLookup=lookupGeoIPDatabase();
if(geoIPLookup==null){return;
if(loc==null){LOGGER.fine("Unabletoobtainlocationfor"+data.getRemoteAddr());return;
if(f!=null){returnnewLookupService(f);
if(!warned.get()){warned.set(true);Stringpath=newFile(loader.getBaseDirectory(),"monitoring/GeoLiteCity.dat").getAbsolutePath();LOGGER.warning("GeoIPdatabase"+path+"isnotavailable."+"PleaseinstallthefiletoenableGeoIPlookups.");
if(value==null){returnnull;
if(value==null){returnnull;
if(stringEncoder==null){synchronized(this){
if(stringEncoder==null){stringEncoder=createStringEncoder();
if(charEncoder==null){synchronized(this){
if(charEncoder==null){charEncoder=createCharEncoder();
if(encPass==null){returnencPass;
if(getPrefix()!=null){buff.append(getPrefix()).append(GeoServerPasswordEncoder.PREFIX_DELIMTER);
if(encPass==null)returnfalse;returngetStringEncoder().isPasswordValid(stripPrefix(encPass),rawPass,salt);
if(encPass==null)returnfalse;returngetCharEncoder().isPasswordValid(stripPrefix(encPass),rawPass,salt);
ifthisencoderhasencodedencPass*/publicbooleanisResponsibleForEncoding(StringencPass){
if(encPass==null)returnfalse;returnencPass.startsWith(getPrefix()+GeoServerPasswordEncoder.PREFIX_DELIMTER);
if(!released){released=true;locks[idx].unlock();
if(this==obj)returntrue;
if(!super.equals(obj))returnfalse;
if(getClass()!=obj.getClass())returnfalse;WMSAccessLimitsother=(WMSAccessLimits)obj;
if(allowFeatureInfo!=other.allowFeatureInfo)returnfalse;
if(rasterFilter==null){
if(other.rasterFilter!=null)returnfalse;
else
if(!rasterFilter.equals(other.rasterFilter))returnfalse;returntrue;}}
if(isNotEmpty(request.getCurrentPassword())==false){throwcreateSecurityException(MasterPasswordChangeException.CURRENT_PASSWORD_REQUIRED);
if(!manager.getKeyStoreProvider().isKeyStorePassword(request.getCurrentPassword())){throwcreateSecurityException(MasterPasswordChangeException.CURRENT_PASSWORD_ERROR);
if(isNotEmpty(request.getConfirmPassword())==false){throwcreateSecurityException(MasterPasswordChangeException.CONFIRMATION_PASSWORD_REQUIRED);
if(isNotEmpty(request.getNewPassword())==false){throwcreateSecurityException(MasterPasswordChangeException.NEW_PASSWORD_REQUIRED);
if(!Arrays.equals(newPassword,confirmationPassword)){throwcreateSecurityException(MasterPasswordChangeException.PASSWORD_AND_CONFIRMATION_NOT_EQUAL);
if(Arrays.equals(newPassword,currentPassword)){throwcreateSecurityException(MasterPasswordChangeException.NEW_EQUALS_CURRENT);
if(egfinstanceofGraphicCache){((GraphicCache)egf).clearCache();
if(animatorExecutorService!=null&&!animatorExecutorService.isShutdown()){animatorExecutorService.shutdownNow();
if(eventinstanceofContextRefreshedEvent){reloadFontCache();//resetWMSAnimatorExecutorServiceresetAnimatorExecutorService();
if("data".equals(key)){assertEquals(1,p1.getParameters().size());returnnull;
else{assertEquals(2,p1.getParameters().size());returnp1.getParameters().get(1);
if(lyr.isEnabled()==false){//short-circuit-fordisabledlayerswedon'tneedtovalidate//anythingbecauseitwon'tcauseserviceexceptionsforanyonereturn;
if(lyr.getResource()==null||((lyr.getResource().getSRS()==null||lyr.getResource().getLatLonBoundingBox()==null)&&WMS.isWmsExposable(lyr))){thrownewRuntimeException("Layer'sresourceisnotfullyconfigured");
if(lyr.getType()==PublishedType.RASTER){
if(!(lyr.getResource()instanceofCoverageInfo))thrownewRuntimeException("LayerwithtypeRASTERdoesn'thaveacoverageassociated");CoverageInfocvinfo=(CoverageInfo)lyr.getResource();try{cvinfo.getCatalog().getResourcePool().getGridCoverageReader(cvinfo,GeoTools.getDefaultHints());
else
if(lyr.getType()==PublishedType.VECTOR){
if(!(lyr.getResource()instanceofFeatureTypeInfo))thrownewRuntimeException("LayerwithtypeVECTORdoesn'thaveafeaturetypeassociated");FeatureTypeInfoftinfo=(FeatureTypeInfo)lyr.getResource();
else
if(lyr.getType()==PublishedType.WMTS){//thisismostlytoavoidthrowinganotRASTERnorVECTOR//exception
if(!(lyr.getResource()instanceofWMTSLayerInfo)){thrownewRuntimeException("WMTSLayerdoesn'thavethecorrectresource");
else
if(lyr.getType()==PublishedType.WMS){//thisismostlytoavoidthrowinganotRASTERnorVECTOR//exception
if(!(lyr.getResource()instanceofWMSLayerInfo)){thrownewRuntimeException("WMSLayerdoesn'thavethecorrectresource");
elsethrownewRuntimeException("LayerisneitherRASTERnorVECTORtype");//Style-dependentchecks
if((lyr.getDefaultStyle()==null||lyr.getStyles().contains(null))&&WMS.isWmsExposable(lyr)){thrownewRuntimeException("Layerhasnullstyles!");
ifthemapproducercanhandlelistorresults(onepertime/elevation/dimension*value)insteadofasingleone*/publicbooleanisMultivalueRequestsSupported(){returnmultivalueRequestsSupported;
ifpalettedimagesaresupported*/publicbooleanisPaletteSupported(){returnpaletteSupported;
ifbackgroundtransparencyissupported*/publicbooleanisTransparencySupported(){returntransparencySupported;
if(this==obj){returntrue;
if(obj==null){returnfalse;
if(!(objinstanceofMapProducerCapabilities)){returnfalse;
if(framesMimeType==null){
if(other.framesMimeType!=null){returnfalse;
else
if(!framesMimeType.equals(other.framesMimeType)){returnfalse;
if(multivalueRequestsSupported!=other.multivalueRequestsSupported){returnfalse;
if(paletteSupported!=other.paletteSupported){returnfalse;
if(tiledRequestsSupported!=other.tiledRequestsSupported){returnfalse;
if(transparencySupported!=other.transparencySupported){returnfalse;
if(configFile!=null&&configFile.isModified()){try{props=configFile.read();
if(props!=null&&propVal==null){propVal=props.getProperty(placeholder);
if(value==null){value=System.getenv(key);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Couldnotaccesssystemproperty'"+key+"':"+ex);
if(value!=null){
if(valueinstanceofString){returnresolveStringValue((String)value);
if(baseDirectory==null){Stringdata=lookupGeoServerDataDirectory(servletContext);
if(data!=null){this.baseDirectory=newFile(data);
else{thrownewIllegalStateException("Unabletodeterminedatadirectory");
if(resources==ResourceStore.EMPTY&&baseDirectory!=null){//lookuptheconfigurationresourcesresources=newFileSystemResourceStore(baseDirectory);
if(resources==ResourceStore.EMPTY){resources=newFileSystemResourceStore(baseDirectory);
iftheresourcecouldnotbe*found.*@throwsIOExceptionIntheeventofanI/Oerror.*/publicFilefind(Stringlocation)throwsIOException{Resourceresource=get(Paths.convert(location));returnResources.find(resource);
iftheresourcecouldnotbe*found.*@throwsIOExceptionIntheeventofanI/Oerror.*/publicFilefind(FileparentFile,Stringlocation)throwsIOException{
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("Lookingupresource"+location+"withparent"+(parentFile!=null?parentFile.getPath():"null"));
iftheresourcecouldnotbe*found.*@throwsIOExceptionAnyI/Oerrorsthatoccur.*/publicFilefind(String...location)throwsIOException{Resourceresource=get(Paths.path(location));returnResources.find(resource);
iftheresourcecouldnotbe*found.*@throwsIOExceptionAnyI/Oerrorsthatoccur.*/publicFilefind(FileparentFile,String...location)throwsIOException{Resourceresource=get(Paths.convert(getBaseDirectory(),parentFile,location));returnResources.find(resource);
ifitdoesnotexist.**@paramlocationThecomponentsofthepaththatmakeupthelocationofthedirectorytofind*orcreate.*/publicFilefindOrCreateDirectory(String...location)throwsIOException{Resourcedirectory=get(Paths.path(location));returndirectory.dir();//willcreatedirectoryasneeded
ifitdoesnotexist.**@paramparentFileThecontainingdirectory,possiblynull.*@paramlocationThecomponentsofthepaththatmakeupthelocationofthedirectorytofind*orcreate.*/publicFilefindOrCreateDirectory(FileparentFile,String...location)throwsIOException{Resourcedirectory=get(Paths.convert(getBaseDirectory(),parentFile,location));returndirectory.dir();//willcreatedirectoryasneeded
ifitdoesnotexist.**@paramlocationThelocationofthedirectorytofindorcreate.*@returnThefilehandle.*@throwsIOExceptionIfanyi/oerrorsoccur.*/publicFilefindOrCreateDirectory(Stringlocation)throwsIOException{Resourcedirectory=get(Paths.convert(location));returndirectory.dir();//willcreatedirectoryasneeded
ifitdoesnotexist.**@paramparentFileThecontainingdirectory,maybenull.*@paramlocationThelocationofthedirectorytofindorcreate.*@returnThefilehandle.*@throwsIOExceptionIfanyi/oerrorsoccur.*/publicFilefindOrCreateDirectory(FileparentFile,Stringlocation)throwsIOException{Resourcedirectory=get(Paths.convert(getBaseDirectory(),parentFile,location));returndirectory.dir();//willcreatedirectoryasneeded
if(scope==null){is=Thread.currentThread().getContextClassLoader().getResourceAsStream(classpathResource);
if(is==null){thrownewIOException("Couldnotload"+classpathResource+"fromscope"+Thread.currentThread().getContextClassLoader().toString()+".");
else{is=scope.getResourceAsStream(classpathResource);
if(is==null){thrownewIOException("Couldnotload"+classpathResource+"fromscope"+scope.toString()+".");
ifitcouldnot*befound.*/publicstaticStringlookupGeoServerDataDirectory(ServletContextservContext){finalString[]typeStrs={"Javaenvironmentvariable","Servletcontextparameter","Systemenvironmentvariable"};StringrequireFileVar="GEOSERVER_REQUIRE_FILE";requireFile(System.getProperty(requireFileVar),typeStrs[0]+requireFileVar);requireFile(servContext.getInitParameter(requireFileVar),typeStrs[1]+requireFileVar);requireFile(System.getenv(requireFileVar),typeStrs[2]+requireFileVar);finalString[]varStrs={"GEOSERVER_DATA_DIR","GEOSERVER_DATA_ROOT"};StringdataDirStr=null;StringmsgPrefix=null;//Loopovervariablenamesfor(inti=0;i<varStrs.length&&dataDirStr==null;i++){//Loopovervariableaccessmethodsfor(intj=0;j<typeStrs.length&&dataDirStr==null;j++){Stringvalue=null;StringvarStr=varStrs[i];StringtypeStr=typeStrs[j];//Lookupsection
switch(j){case0:value=System.getProperty(varStr);break;case1:value=servContext.getInitParameter(varStr);break;case2:value=System.getenv(varStr);break;
if(value==null||value.equalsIgnoreCase("")){LOGGER.finer("Found"+typeStr+varStr+"tobeunset");continue;
if(!fh.exists()){LOGGER.warning(msgPrefix+",butthispathdoesnotexist");continue;
if(!fh.isDirectory()){LOGGER.warning(msgPrefix+",whichisnotadirectory");continue;
if(!fh.canWrite()){LOGGER.warning(msgPrefix+",whichisnotwriteable");continue;
if(dataDirStr==null){dataDirStr=servContext.getRealPath("/data");LOGGER.info("Fallingbacktoembeddeddatadirectory:"+dataDirStr);
iftheydonot.**@paramfileseitherasinglefilenameoralistoffilenamesseparatedby{@link*File#pathSeparator}*@paramsourcedescriptionofsourcefromwhichfilename(s)obtained*/staticvoidrequireFile(Stringfiles,Stringsource){
if(files==null||files.isEmpty()){return;
else{for(Stringfile:files.split(File.pathSeparator)){
if(!(newFile(file)).exists()){thrownewIllegalArgumentException("Missingrequiredfile:"+file+"From:"+source+":"+files);
ifnosuchstoreexists.*/<TextendsStoreInfo>TgetStore(Stringid,Class<T>clazz);/***Loadsastorefrompersistentstoragebyspecifyingitsnameandcontainingworkspace.**<p>The<tt>clazz</tt>parameterisusedtotypenarrowthereturnedobjecttoaspecifictype*ofstore.IfthetypeofstoreisunknowntheclientmaysimplyspecifyStoreInfo.class.The*daoshouldstillcreatethecorrecttypeofstore.**@paramworkspaceTHecontainingworkspaceofthestore.*@paramnameThenameofthestore.*@paramclazzTheclassofthestore.*@returnThestore,or<code>null</code>
ifnosuchstoreexists.*/<TextendsStoreInfo>TgetStoreByName(WorkspaceInfoworkspace,Stringname,Class<T>clazz);/***Loadsallstoresfrompersistentstorageinthespecifiedworkspace.**<p>The<tt>clazz</tt>parameterisusedtotypenarrow/filterthereturnedobjectstoa*specifictypeofstore.SpecifyingStoreInfo.classwillreturnalltypesofstores.**@paramworkspaceThecontainingworkspace.*@paramclazzTheclassofthestorestoreturn.*@returnAlistofstores,possiblyempty.*/<TextendsStoreInfo>List<T>getStoresByWorkspace(WorkspaceInfoworkspace,Class<T>clazz);/***Loadsallstoresfrompersistentstorage.**<p>The<tt>clazz</tt>parameterisusedtotypenarrow/filterthereturnedobjectstoa*specifictypeofstore.SpecifyingStoreInfo.classwillreturnalltypesofstores.**@paramclazzTheclassofthestorestoreturn.*@returnAlistofstores,possiblyempty.*/<TextendsStoreInfo>List<T>getStores(Class<T>clazz);/***Loadsthedefaultdatastoreforthespecifiedworkspace.**@paramworkspaceTheworkspace.*@returnThedefaultdatastore,ornull
ifnoneisset.*/DataStoreInfogetDefaultDataStore(WorkspaceInfoworkspace);/***Setsthedefaultdatastoreforthespecifiedworkspace.**<p>DAOimplementationsareresponsiblefortriggeringa{@linkCatalogModifyEvent}bycalling*{@linkCatalog#fireModified(CatalogInfo,List,List,List)}.Thesourceoftheeventisthe*workspaceitselfandchangedpropertyis"defaultDataStore".Thechangedold/newvalues*shouldtheold/newdatastoresrespectively.**@paramworkspaceTheworkspace.*@paramstoreThedefaultdatastore.*/voidsetDefaultDataStore(WorkspaceInfoworkspace,DataStoreInfostore);////Resources///**Addsaresourcetopersistentstorage.*/ResourceInfoadd(ResourceInforesource);/**Removesaresourcefrompersistentstorage.*/voidremove(ResourceInforesource);/***Persistsanymodificationstoaresourcetopersistentstorage.**<p>DAOimplementationsareresponsiblefortriggeringa{@linkCatalogModifyEvent}bycalling*{@linkCatalog#fireModified(CatalogInfo,List,List,List)}.Thisistheresponsibilityof*thedaobecauseitisbestsuitedtoknowingandtrackingwhichattributesoftheobjecthave*changed.*/voidsave(ResourceInforesource);/***Detachesaresourcefromtheunderlyingpersistencelayer.**<p>"Detaching"isspecifictotheunderlyingstorageengine.Butingeneralwhenanobjectis*detachedanyproxiesoruninitializedstateoftheobjectshouldberesolved.**@seeCatalog#detach(ResourceInfo)*/<TextendsResourceInfo>Tdetach(Tresource);/***Loadsaresourcefrompersistentstoragebyspecifyingitsidentifier.**<p>The<tt>clazz</tt>parameterisusedtotypenarrowthereturnedobjecttoaspecifictype*ofresource.Ifthetypeofresourceisunknowntheclientmaysimplyspecify*ResourceInfo.class.Thedaoshouldstillcreatethecorrecttypeofresource.**@paramidTheuniqueidentifieroftheresource*@paramclazzTheclassoftheresource.*@returnTheresource,or<code>null</code>
ifnosuchstoreexists.*/<TextendsResourceInfo>TgetResource(Stringid,Class<T>clazz);/***Loadsaresourcefrompersistentstoragebyspecifyingitsqualifiedname.**<p>The<tt>clazz</tt>parameterisusedtotypenarrowthereturnedobjecttoaspecifictype*ofresource.Ifthetypeofresourceisunknowntheclientmaysimplyspecify*ResourceInfo.class.Thedaoshouldstillcreatethecorrecttypeofresource.**@paramnamespaceThenamespaceoftheresource*@paramnameThelocalnameoftheresource*@paramclazzTheclassoftheresource*@returnTheresource,or<code>null</code>
ifnosuchstoreexists.*/<TextendsResourceInfo>TgetResourceByName(NamespaceInfonamespace,Stringname,Class<T>clazz);/***Loadsallresourcesfrompersistentstorage.**<p>The<tt>clazz</tt>parameterisusedtotypenarrow/filterthereturnedobjectstoa*specifictypeofstore.SpecifyingStoreInfo.classwillreturnalltypesofstores.**@paramclazzTheclassoftheresourcestoreturn.*@returnAlistofresources,possiblyempty.*/<TextendsResourceInfo>List<T>getResources(Class<T>clazz);/***Loadsallresourcesfrompersistentstoragecontainedwithaspecifiednamespace.**<p>The<tt>clazz</tt>parameterisusedtotypenarrow/filterthereturnedobjectstoa*specifictypeofstore.SpecifyingStoreInfo.classwillreturnalltypesofstores.**@paramnamespaceThenamespaceofresources*@paramclazzTheclassoftheresourcestoreturn.*@returnAlistofresources,possiblyempty.*/<TextendsResourceInfo>List<T>getResourcesByNamespace(NamespaceInfonamespace,Class<T>clazz);/***Loadsaresourcefrompersistentstoragebyspecifyingitsnameandcontainingstore.**<p>The<tt>clazz</tt>parameterisusedtotypenarrowthereturnedobjecttoaspecifictype*ofresource.Ifthetypeofresourceisunknowntheclientmaysimplyspecify*ResourceInfo.class.Thedaoshouldstillcreatethecorrecttypeofresource.**@paramstoreThecontainingstore*@paramnameThelocalnameoftheresource*@paramclazzTheclassoftheresource*@returnTheresource,or<code>null</code>
ifnosuchstoreexists.*/<TextendsResourceInfo>TgetResourceByStore(StoreInfostore,Stringname,Class<T>clazz);/***Loadsallresourcesfrompersistentstoragethatarecontainedwithinaspecifiedstore.**<p>The<tt>clazz</tt>parameterisusedtotypenarrow/filterthereturnedobjectstoa*specifictypeofstore.SpecifyingStoreInfo.classwillreturnalltypesofstores.**@paramstoreThecontainingstore*@paramclazzTheclassoftheresourcestoreturn*@returnAlistofresources,possiblyempty.*/<TextendsResourceInfo>List<T>getResourcesByStore(StoreInfostore,Class<T>clazz);////Layers///**Addsalayertopersistentstorage.*/LayerInfoadd(LayerInfolayer);/**Removesalayerfrompersistentstorage.*/voidremove(LayerInfolayer);/***Persistsanymodificationstoalayertopersistentstorage.**<p>DAOimplementationsareresponsiblefortriggeringa{@linkCatalogModifyEvent}bycalling*{@linkCatalog#fireModified(CatalogInfo,List,List,List)}.Thisistheresponsibilityof*thedaobecauseitisbestsuitedtoknowingandtrackingwhichattributesoftheobjecthave*changed.*/voidsave(LayerInfolayer);/***Detachesalayerfromtheunderlyingpersistencelayer.**<p>"Detaching"isspecifictotheunderlyingstorageengine.Butingeneralwhenanobjectis*detachedanyproxiesoruninitializedstateoftheobjectshouldberesolved.**@seeCatalog#detach(LayerInfo)*/LayerInfodetach(LayerInfolayer);/***Loadsalayerfrompersistentstoragebyspecifyingitsidentifier.**@paramidTheuniqueidentifierofthelayer*@returnThelayer,or<code>null</code>
ifnosuchlayerexists.*/LayerInfogetLayer(Stringid);/***Loadsalayerfrompersistentstoragebyspecifyingitsname.**@paramnameThenameofthelayer*@returnThelayer,or<code>null</code>
ifnosuchlayerexists.*/LayerInfogetLayerByName(Stringname);/***Loadsalllayersfrompersistentstoragethatpublishaspecifiedresource.**@paramresourceThepublishedresource*@returnListoflayers,possiblyempty*/List<LayerInfo>getLayers(ResourceInforesource);/***Loadsalllayersfrompersistentstoragethatreferenceaspecifiedstyle.**@paramstyleThereferencedstyle*@returnListoflayers,possiblyempty*/List<LayerInfo>getLayers(StyleInfostyle);/***Loadsalllayersfrompersistentstorage.**@returnListoflayers,possiblyempty*/List<LayerInfo>getLayers();////Maps///**Addsamaptopersistentstorage.*/MapInfoadd(MapInfomap);/**Removesamapfrompersistentstorage.*/voidremove(MapInfomap);/***Persistsanymodificationstoamaptopersistentstorage.**<p>DAOimplementationsareresponsiblefortriggeringa{@linkCatalogModifyEvent}bycalling*{@linkCatalog#fireModified(CatalogInfo,List,List,List)}.Thisistheresponsibilityof*thedaobecauseitisbestsuitedtoknowingandtrackingwhichattributesoftheobjecthave*changed.*/voidsave(MapInfomap);/***Detachesamapfromtheunderlyingpersistencelayer.**<p>"Detaching"isspecifictotheunderlyingstorageengine.Butingeneralwhenanobjectis*detachedanyproxiesoruninitializedstateoftheobjectshouldberesolved.**@seeCatalog#detach(MapInfo)*/MapInfodetach(MapInfomap);/***Loadsamapfrompersistentstoragebyitsidentifier.**@paramidTheuniqueidentifierofthemap*@returnThemap,or<code>null</code>
ifnosuchmapexists*/MapInfogetMap(Stringid);/***Loadsamapfrompersistentstoragebyitsname.**@paramnameThenameofthemap*@returnThemap,or<code>null</code>
ifnosuchmapexists*/MapInfogetMapByName(Stringname);/***Listsallmapsfrompersistentstorage.**@returnAlistofmaps,possiblyempty*/List<MapInfo>getMaps();////Layergroups///**Addsalayergrouptopersistentstorage.*/LayerGroupInfoadd(LayerGroupInfolayerGroup);/**Removesalayergroupfrompersistentstorage.*/voidremove(LayerGroupInfolayerGroup);/***Persistsanymodificationstoalayergrouptopersistentstorage.**<p>DAOimplementationsareresponsiblefortriggeringa{@linkCatalogModifyEvent}bycalling*{@linkCatalog#fireModified(CatalogInfo,List,List,List)}.Thisistheresponsibilityof*thedaobecauseitisbestsuitedtoknowingandtrackingwhichattributesoftheobjecthave*changed.*/voidsave(LayerGroupInfolayerGroup);/***Detachesalayergroupfromtheunderlyingpersistencelayer.**<p>"Detaching"isspecifictotheunderlyingstorageengine.Butingeneralwhenanobjectis*detachedanyproxiesoruninitializedstateoftheobjectshouldberesolved.**@seeCatalog#detach(LayerGroupInfo)*/LayerGroupInfodetach(LayerGroupInfolayerGroup);/***Loadsalayergroupfrompersistentstoragebyspecifyingitsidentifier.**@paramidTheuniqueidentifierforthelayergroup*@returnThelayergroup,or<code>null</code>
ifitdoesnotexist*/LayerGroupInfogetLayerGroup(Stringid);/***Loadsagloballayergroupfrompersistentstoragebyspecifyingitsname.**@paramnameThenameofthelayergroup.**@returnThelayergroup,or<code>null</code.
ifitdoesnotexist*/LayerGroupInfogetLayerGroupByName(Stringname);/***Returnsthelayergroupmatchingaparticularnameinthespecifiedworkspace,or<code>null*</code>
ifnosuchlayergroupcouldbefound.**@paramworkspaceTheworkspacecontainingthelayergroup.Not{@codenull},use{@link*DefaultCatalogFacade#NO_WORKSPACE}or{@linkDefaultCatalogFacade#ANY_WORKSPACE}tobe*explicitaboutwhatyou'relookingfor.*@paramnameThenameofthelayergrouptoreturn.*/LayerGroupInfogetLayerGroupByName(WorkspaceInfoworkspace,Stringname);/***Loadsalllayergroupsfrompersistentstorage.**@returnAlistoflayergroups,possiblyempty.*/List<LayerGroupInfo>getLayerGroups();/***Alllayergroupsinthespecifiedworkspace.**@paramworkspaceTheworkspacecontaininglayergroups.*/List<LayerGroupInfo>getLayerGroupsByWorkspace(WorkspaceInfoworkspace);////Namespaces///**Addsanamespacetopersistentstorage.*/NamespaceInfoadd(NamespaceInfonamespace);/**Removesanamespacefrompersistentstorage.*/voidremove(NamespaceInfonamespace);/***Persistsanymodificationstoanamespacetopersistentstorage.**<p>DAOimplementationsareresponsiblefortriggeringa{@linkCatalogModifyEvent}bycalling*{@linkCatalog#fireModified(CatalogInfo,List,List,List)}.Thisistheresponsibilityof*thedaobecauseitisbestsuitedtoknowingandtrackingwhichattributesoftheobjecthave*changed.*/voidsave(NamespaceInfonamespace);/***Detachesanamespacefromtheunderlyingpersistencelayer.**<p>"Detaching"isspecifictotheunderlyingstorageengine.Butingeneralwhenanobjectis*detachedanyproxiesoruninitializedstateoftheobjectshouldberesolved.**@seeCatalog#detach(NamespaceInfo)*/NamespaceInfodetach(NamespaceInfonamespace);/***Loadsthedefaultnamespacefrompersistentstorage.**@returnThenamespace,or<code>null</code>
ifthereisnodefaultnamespaceset*/NamespaceInfogetDefaultNamespace();/***Setsthedefaultnamespace.**<p>DAOimplementationsareresponsiblefortriggeringa{@linkCatalogModifyEvent}bycalling*{@linkCatalog#fireModified(CatalogInfo,List,List,List)}.Thesourceoftheeventisthe*catalogitselfandchangedpropertyis"defaultNamespace".Thechangedold/newvaluesshould*theold/newnamespacesrespectively.*/voidsetDefaultNamespace(NamespaceInfodefaultNamespace);/***Loadsanamespacefrompersistentstoragebyspecifyingitsidentifier.**@paramidTheuniqueidentifierofthenamespace.*@returnThenamespace,or<code>null</code>
ifnosuchnamespaceexists*/NamespaceInfogetNamespace(Stringid);/***Loadsanamespacefrompersistentstoragebyspecifyingitsprefix.**@paramprefixTheprefixofthenamespace.*@returnThenamespace,or<code>null</code>
ifnosuchnamespaceexists*/NamespaceInfogetNamespaceByPrefix(Stringprefix);/***Loadsthefirstnamespacefrompersistentstoragethatmatchestheprovidedid.**@paramuriTheuriofthenamespace.*@returnThenamespace,or<code>null</code>
ifnosuchnamespaceexists*/NamespaceInfogetNamespaceByURI(Stringuri);/***Loadsallnamespacesfrompersistentstoragethatmatchtheprovideduri.**@paramuriTheuriofthenamespace.*@returnThenamespace,or<code>null</code>
ifnosuchnamespaceexists*/defaultList<NamespaceInfo>getNamespacesByURI(Stringuri){returngetNamespaces().stream().filter(namespace->namespace.getURI().equals(uri)).collect(Collectors.toList());
ifthereisnodefaultworkspaceset*/WorkspaceInfogetDefaultWorkspace();/***Setsthedefaultworkspace.**<p>DAOimplementationsareresponsiblefortriggeringa{@linkCatalogModifyEvent}bycalling*{@linkCatalog#fireModified(CatalogInfo,List,List,List)}.Thesourceoftheeventisthe*catalogitselfandchangedpropertyis"defaultWorkspace".Thechangedold/newvaluesshould*theold/newworkspacesrespectively.*/voidsetDefaultWorkspace(WorkspaceInfoworkspace);/***Loadsaworkspacefrompersistentstoragebyspecifyingitsidentifier.**@paramidTheuniqueidentifieroftheworkspace.*@returnTHeworkspace,or<code>null</code>
ifnosuchworkspaceexists.*/WorkspaceInfogetWorkspace(Stringid);/***Loadsaworkspacefrompersistentstoragebyspecifyingitsname.**@paramnameThenameoftheworkspace.*@returnTHeworkspace,or<code>null</code>
ifnosuchworkspaceexists.*/WorkspaceInfogetWorkspaceByName(Stringname);/***Loadsallworkspacesfrompersistentstorage.**@returnAlistofworkspaces,possiblyempty.*/List<WorkspaceInfo>getWorkspaces();////Styles///**Addsastyletopersistentstorage.*/StyleInfoadd(StyleInfostyle);/**Removesastylefrompersistentstorage.*/voidremove(StyleInfostyle);/***Persistsanymodificationstoastyletopersistentstorage.**<p>DAOimplementationsareresponsiblefortriggeringa{@linkCatalogModifyEvent}bycalling*{@linkCatalog#fireModified(CatalogInfo,List,List,List)}.Thisistheresponsibilityof*thedaobecauseitisbestsuitedtoknowingandtrackingwhichattributesoftheobjecthave*changed.*/voidsave(StyleInfostyle);/***Detachesastylefromtheunderlyingpersistencelayer.**<p>"Detaching"isspecifictotheunderlyingstorageengine.Butingeneralwhenanobjectis*detachedanyproxiesoruninitializedstateoftheobjectshouldberesolved.**@seeCatalog#detach(StyleInfo)*/StyleInfodetach(StyleInfostyle);/***Loadsastylefrompersistentstoragebyspecifyingitsidentifier.**@paramidTheuniqueidentifierofthestyle.*@returnThestyle,or<code>null</code>
ifnosuchstyleexists*/StyleInfogetStyle(Stringid);/***Loadsastylefrompersistentstoragebyspecifyingitsname.**<p>Thisonlycheckstheglobalstylesdirectory.**@paramnameThenameofthestyle.*@returnThestyle,or<code>null</code>
ifnosuchstyleexists*/StyleInfogetStyleByName(Stringname);/***Returnsthestylematchingaparticularnameinthespecifiedworkspace,or<code>null</code>*
ifnosuchstylecouldbefound.**@paramworkspaceTheworkspacecontainingthestyle;non{@codenull},use{@value*#ANY_WORKSPACE}or{@link#NO_WORKSPACE}asappropriate.*@paramnameThenameofthestyletoreturn.*/StyleInfogetStyleByName(WorkspaceInfoworkspace,Stringname);/***Loadsallstylesfrompersistentstorage.**@returnAlistofstyles,possiblyempty.*/List<StyleInfo>getStyles();/***Allstylesinthespecifiedworkspace.**@paramworkspaceTheworkspacecontainingstyles.*/List<StyleInfo>getStylesByWorkspace(WorkspaceInfoworkspace);/***Disposesthedao.**<p>Calledfrom{@linkCatalog#dispose()}andforcesthedaotoreleaseanyresources.*/voiddispose();/***Calledafterthecataloghasbeeninitiallystarted/loaded.**<p>Thismethodgivesthedaoachancetoresolveanyproxiesoruninitializedstatethatare*createdduringtheloadingprocess.*/voidresolve();/**Pushesthedatastoredbythisdaointoanotherdao.*/voidsyncTo(CatalogFacadeother);/**@returnthenumberofcatalogobjectsoftherequestedtypethatmatchthegivenfilter*/public<TextendsCatalogInfo>intcount(finalClass<T>of,finalFilterfilter);/***@return{@codetrue}
if{@link#list}cansortobjectsofthegiventypebythegiven*propertyname,{@codefalse}otherwise*/publicbooleancanSort(Class<?extendsCatalogInfo>type,StringpropertyName);/***@returnaniteratoroverthecatalogobjectsoftherequestedtypethatmatchthegiven*filter*@deprecateduse{@link#list(Class,Filter,Integer,Integer,SortBy...)}*/public<TextendsCatalogInfo>CloseableIterator<T>list(finalClass<T>of,finalFilterfilter,@NullableIntegeroffset,@NullableIntegercount,@NullableSortBysortOrder);/***@returnaniteratoroverthecatalogobjectsoftherequestedtypethatmatchthegiven*filter*/public<TextendsCatalogInfo>CloseableIterator<T>list(finalClass<T>of,finalFilterfilter,@NullableIntegeroffset,@NullableIntegercount,@NullableSortBy...sortOrder);/***Returnthecatalogcapabilitiessupportedbythisfacade.**@returncatalogsupportedcapabilities*/defaultCatalogCapabilitiesgetCatalogCapabilities(){//returncatalogdefaultsupportedcapabilitiesreturnnewCatalogCapabilities();
if(info==null||info.size()==0){setConvertedInput(newArrayList<AuthorityURLInfo>(2));return;
if(node.canAccess(user,mode)){returntrue;
ifthereisanythinginsidetheworkspacethatcanberead(otherwise//wearedenyingaccesstoeverythingbelowit,whichisnotthespiritofthe//treeoverridedesign)
if(mode==AccessMode.READ&&canAccessChild(node,user,mode)){returntrue;
else{returnfalse;
iftheusercanaccessthespecifiednode,oroneofthenodesbelowit**<p>thespecifiednodes**@paramnode*@paramuser*@parammode*@return*/privatebooleancanAccessChild(SecureTreeNodenode,Authenticationuser,AccessModemode){
if(node.canAccess(user,mode)){returntrue;
if(canAccessChild(child,user,mode)){returntrue;
if(layer.getResource()==null){LOGGER.log(Level.FINE,"Layer"+layer+"hasnoattachedresource,"+"assumingit'spossibletoaccessit");//it'salayerwhoseresourcewedon'tknowaboutreturntrue;
else{returncanAccess(user,layer.getResource(),mode,directAccess);
ifwehaveacatalogrulethatisatresourcelevel,it'sthemostspecifictype,//itwins.OritcouldbethatwedonotneedtochecklayergroupsatallSecureTreeNodesecurityNode=root.getDeepestNode(newString[]{workspace,resourceName});intcatalogNodeDepth=securityNode.getDepth();booleanrulesAllowAccess=securityNode.canAccess(user,mode);
if(catalogNodeDepth==SecureTreeNode.RESOURCE_DEPTH||!layerGroupContainmentCheckRequired()){returnrulesAllowAccess;
ifany.Ifnone,thereisnogrouprelatedlogic//toapplyCollection<LayerGroupSummary>containers=groupsCache.getContainerGroupsFor(resource);
if(containers.isEmpty()){returnrulesAllowAccess;
if(gi==null){returnfalse;
if(!groupOverrides.isEmpty()){//
ifthereareoverrides,see
ifatleastoneofthemallowsaccessrulesAllowAccess=groupOverrides.stream().anyMatch(sg->{
if(directAccess&&sg.getMode()==Mode.OPAQUE_CONTAINER){returnfalse;
if(rulesAllowAccess){returntrue;
if(directAccess&&sg.getMode()==Mode.OPAQUE_CONTAINER){returnfalse;
if(gi==null){returnfalse;
ifthereisapathfromthegrouptotheresourcethatdoesnotinvolvecrossing*aopaquegroup*/privatebooleanallowsAccessViaNonOpaqueGroup(LayerGroupInfogi,ResourceInforesource){for(PublishedInfopi:gi.getLayers()){
if(piinstanceofLayerInfo){
if(resource.equals(((LayerInfo)pi).getResource())){returntrue;
else{LayerGroupInfolg=(LayerGroupInfo)pi;
if(lg.getMode()!=LayerGroupInfo.Mode.OPAQUE_CONTAINER&&allowsAccessViaNonOpaqueGroup(lg,resource)){returntrue;
if(lg.getWorkspace()==null){node=root.getNode(lg.getName());
else{String[]path=getLayerGroupPath(lg);node=root.getNode(path);
if(request==null){returnfalse;
if(lastLoaded<daoLastModified||force){root=buildAuthorizationTree(dao);lastLoaded=daoLastModified;
if(ANY.equals(workspace)){node=root;
else{//getorcreatetheworkspaceSecureTreeNodews=root.getChild(workspace);
if(ws==null){ws=root.addChild(workspace);
iflayeris"*"theruleappliestothews,otherwise//get/createthelayer
if("*".equals(layer)){node=ws;
else
if(rule.isGlobalGroupRule()){node=ws;
else{SecureTreeNodelayerNode=ws.getChild(layer);
if(layerNode==null){layerNode=ws.addChild(layer);
if(node.getAuthorizedRoles(accessMode)!=null&&node.getAuthorizedRoles(accessMode).size()>0&&node!=root){LOGGER.warning("Rule"+rule+"isoverridinganotherruletargettingthesameresource");
iftherearenolimits
if((readFilter==null||readFilter==Filter.INCLUDE)&&(writeFilter==null||writeFilter==Filter.INCLUDE||WMSLayerInfo.class.isAssignableFrom(resourceClass)||WMTSLayerInfo.class.isAssignableFrom(resourceClass)||CoverageInfo.class.isAssignableFrom(resourceClass))){returnnull;
if(FeatureTypeInfo.class.isAssignableFrom(resourceClass)){returnnewVectorAccessLimits(mode,null,readFilter,null,writeFilter);
else
if(CoverageInfo.class.isAssignableFrom(resourceClass)){returnnewCoverageAccessLimits(mode,readFilter,null,null);
else
if(WMSLayerInfo.class.isAssignableFrom(resourceClass)){returnnewWMSAccessLimits(mode,readFilter,null,true);
else
if(WMTSLayerInfo.class.isAssignableFrom(resourceClass)){returnnewWMTSAccessLimits(mode,readFilter,null);
else{LOGGER.log(Level.INFO,"Warning,adaptingtogenericaccesslimitsforunrecognizedresourcetype"+resourceClass);returnnewDataAccessLimits(mode,readFilter);
if(readable&&writable){
if(AdminRequest.get()==null){//notadminrequest,read+writemeansfullacesssreturnnull;
if(node!=null&&!catalogNodeAllowsAccess){allowAccess=false;
else{//grabthegroupscontainingthegroup,
ifany.Ifnone,thereisnogrouprelated//logictoapplyCollection<LayerGroupSummary>directContainers=groupsCache.getContainerGroupsFor(layerGroup);
if(directContainers.isEmpty()){allowAccess=true;
else{//dowehaveatleastonepaththatauthorizesaccesstothisgroup?needtocheck//groupbygroupallowAccess=directContainers.stream().anyMatch(sg->{
if(directAccess&&sg.getMode()==Mode.OPAQUE_CONTAINER){returnfalse;
if(layerGroup.getWorkspace()==null){returnnewString[]{layerGroup.getName()};
else{returnnewString[]{layerGroup.getWorkspace().getName(),layerGroup.getName()};
if(getMode()==CatalogMode.CHALLENGE){//Ifwe'reinCHALLENGEmode,wecannotpre-filter//fortheothertypeswehavenoclue,usetheinmemoryfilteringreturnInMemorySecurityFilter.buildUserAccessFilter(this,user);
if(WorkspaceInfo.class.isAssignableFrom(clazz)){//baseaccessbooleanrootAccess=canAccess(user,root);List<Filter>exceptions=newArrayList<>();//exceptionsfor(Map.Entry<String,SecureTreeNode>entry:root.getChildren().entrySet()){StringwsName=entry.getKey();SecureTreeNodenode=entry.getValue();booleannodeAccess=canAccess(user,node);
if(nodeAccess!=rootAccess){
if(rootAccess){exceptions.add(Predicates.notEqual("name",wsName));
else{exceptions.add(Predicates.equal("name",wsName));
if(exceptions.size()==0){returnrootAccess?Filter.INCLUDE:Filter.EXCLUDE;
else{returnrootAccess?Predicates.and(exceptions):Predicates.or(exceptions);
else
if(PublishedInfo.class.isAssignableFrom(clazz)||ResourceInfo.class.isAssignableFrom(clazz)||CoverageInfo.class.isAssignableFrom(clazz)){//baseaccessbooleanrootAccess=canAccess(user,root);List<Filter>exceptions=newArrayList<>();//gettherightwspropertynameStringwsNameProperty;
if(PublishedInfo.class.isAssignableFrom(clazz)){wsNameProperty="resource.store.workspace.name";
else{wsNameProperty="store.workspace.name";
if(layerAccess!=wsAccess){
if(wsAccess){layerExceptions.add(Predicates.notEqual("prefixedName",wsName+":"+layerName));
else{layerExceptions.add(Predicates.equal("prefixedName",wsName+":"+layerName));
if(rootAccess&&!wsAccess){wsFilter=Predicates.notEqual(wsNameProperty,wsName);
else
if(!rootAccess&&wsAccess){wsFilter=Predicates.equal(wsNameProperty,wsName);
if(layerExceptions.isEmpty()){
if(wsFilter!=null){exceptions.add(wsFilter);
else{
if(wsFilter!=null){layerExceptions.add(wsFilter);
if(exceptions.size()==0){returnrootAccess?Filter.INCLUDE:Filter.EXCLUDE;
else{Filterfilter=rootAccess?Predicates.and(exceptions):Predicates.or(exceptions);//incaseofpublishedinfo,wehavetofilterthelayergroupsasaseparate//entity
if(PublishedInfo.class.equals(clazz)){FilterlayerFilter=Predicates.and(Predicates.isInstanceOf(LayerInfo.class),filter);FilterlayerGroupFilter=Predicates.isInstanceOf(LayerGroupInfo.class);returnPredicates.or(layerFilter,layerGroupFilter);
else{returnfilter;
else
if(StyleInfo.class.isAssignableFrom(clazz)||LayerGroupInfo.class.isAssignableFrom(clazz)){//wejustcheckforworkspacecontainmentbooleanrootAccess=canAccess(user,root);List<Filter>exceptions=newArrayList<>();//exceptionsfor(Map.Entry<String,SecureTreeNode>entry:root.getChildren().entrySet()){StringwsName=entry.getKey();SecureTreeNodenode=entry.getValue();booleannodeAccess=canAccess(user,node);
if(nodeAccess!=rootAccess){
if(rootAccess){exceptions.add(Predicates.notEqual("workspace.name",wsName));
else{exceptions.add(Predicates.equal("workspace.name",wsName));
if(exceptions.size()==0){returnrootAccess?Filter.INCLUDE:Filter.EXCLUDE;
else{returnrootAccess?Predicates.and(exceptions):Predicates.or(exceptions);
else{//fortheothertypeswehavenoclue,usetheinmemoryfilteringreturnInMemorySecurityFilter.buildUserAccessFilter(this,user);
if(access&&AdminRequest.get()!=null){//adminrequest,weneedtocheck
ifwecanalsoadminthosereturnnode.canAccess(user,AccessMode.ADMIN);
else{returnaccess;
if{@codestr}can'tbeparsedtoaJSONArray*/publicstaticList<LayerIdentifierInfo>fromString(Stringstr)throwsIllegalArgumentException{try{finalJSONArrayarray;array=JSONArray.fromObject(str);finalintsize=array.size();List<LayerIdentifierInfo>list=newArrayList<LayerIdentifierInfo>(size);JSONObjectjsonAuth;for(inti=0;i<size;i++){jsonAuth=array.getJSONObject(i);LayerIdentifierid=newLayerIdentifier();id.setAuthority(jsonAuth.getString(AUTHORITY));id.setIdentifier(jsonAuth.getString(IDENTIFIER));list.add(id);
if{@codelist}isnull,empty,orcontainsonlynullobjects;theJSON*arrayrepresentationof{@codelist}otherwise,withanynullelementstrippedoff.*/publicstaticStringtoString(List<LayerIdentifierInfo>list){
if(list==null||list.isEmpty()){returnnull;
if(id==null){continue;
if(array.size()==0){//listwasmadeofonlynullobjects?returnnull;
if(where!=null){sb.append("WHERE").append(where);
if(candidateinstanceofJavaScriptPlugin){plugin=(JavaScriptPlugin)candidate;break;
if(scheme.equals("file")){Filefile=newFile(uri.getPath());assertTrue("pathisdirectory",file.isDirectory());assertTrue("directoryexists",file.exists());
iftheVTisalreadyregisteredin//thedb
if(jstore.getVirtualTables().containsValue(vt)){//
ifthevirtualtableisalreadyregisteredinthestore(andequalityinthetest//aboveguaranteesthestructureisthesame),wecanjustgettheschemafromit//directlyft=jstore.getSchema(vt.getName());//paranoidcheck:makesurenobodychangedthevtstructurewhilewefetched//thedata(ratherunlikely,evenmoreunlikelywouldbe
if(!jstore.getVirtualTables().containsValue(vt)){ft=null;
if(ft==null){
if(temporaryName!=null){jstore.createVirtualTable(newVirtualTable(temporaryName.getLocalPart(),vt));returntrue;
else{jstore.createVirtualTable(vt);
if(temporaryName!=null){ds.dropVirtualTable(temporaryName.getLocalPart());
else{ds.dropVirtualTable(info.getNativeName());
if(count==0){returnnull;
else
if(count==1){returnDouble.valueOf(xpath.evaluate("//"+layerName+"/sf:GRAY_INDEX",doc));
else{fail("Foundmorethanonefeature:"+count);returnnull;//justtomakethecompilerhappy,failthrowsanuncheckedexception
if(xpathEngine==null){xpathEngine=XMLUnit.newXpathEngine();Map<String,String>namespaces=newHashMap<String,String>();namespaces.putAll(WFS_NAMESPACES);namespaces.putAll(getTestData().getNamespaces());xpathEngine.setNamespaceContext(newSimpleNamespaceContext(namespaces));
if(catalog==null){
if(testDatainstanceofAbstractAppSchemaMockData){catalog=((AbstractAppSchemaMockData)testData).getSchemaCatalog();
if(file.getName().equals(steps[i])){
if(i<steps.length-1){returnfindFile(path.substring(steps[i].length()+1,path.length()),file);
else{returnfile;
ifvalidationfails*/protectedvoidvalidateGet(Stringpath){try{AppSchemaValidator.validate(get(path),getSchemaCatalog());
ifvalidationfails*/protectedvoidvalidatePost(Stringpath,Stringxml){try{AppSchemaValidator.validate(post(path,xml),getSchemaCatalog());
ifvalidationfails*/protectedvoidvalidate(Stringxml){try{AppSchemaValidator.validate(xml,getSchemaCatalog());
ifsomethinggoeswrong*@paramimagetheimgagetocheckitisnot"blank"*@parambgColorthebackgroundcolorforwhichdifferingpixelsarelookedfor*/protectedvoidassertNotBlank(StringtestName,BufferedImageimage,ColorbgColor){intpixelsDiffer=countNonBlankPixels(testName,image,bgColor);assertTrue(testName+"imageiscompletelyblank",0<pixelsDiffer);
if(image.getRGB(x,y)!=bgColor.getRGB()){++pixelsDiffer;
ifnestedfiltersencodingcanbetested,<code>false</code>*otherwise.*/protectedbooleanshouldTestNestedFiltersEncoding(FeatureTypeMappingrootMapping){
if(!(rootMapping.getSource().getDataStore()instanceofJDBCDataStore))returnfalse;
if(!AppSchemaDataAccessConfigurator.isJoining())returnfalse;
if(!AppSchemaDataAccessConfigurator.shouldEncodeNestedFilters())returnfalse;returntrue;
if(!(sourceinstanceofJDBCDataStore)){thrownewIllegalArgumentException("nestedfiltersencodingrequiresthesourcedatastorebeaJDBCDataStore");
if(dialectinstanceofBasicSQLDialect){original=((BasicSQLDialect)dialect).createFilterToSQL();
else
if(dialectinstanceofPreparedStatementSQLDialect){original=((PreparedStatementSQLDialect)dialect).createPreparedFilterToSQL();//disablepreparedstatementstohaveliteralsactuallyencodedintheSQL((PreparedFilterToSQL)original).setPrepareEnabled(false);
if(response==null){StringBuildersb=newStringBuilder("Unexpectedrequest\n"+request+"\nNoresponseisboundtoit.Boundurlsare:");for(Requestr:expectedRequests.keySet()){sb.append("\n").append(r);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;Requestother=(Request)obj;
if(contentType==null){
if(other.contentType!=null)returnfalse;
else
if(!contentType.equals(other.contentType))returnfalse;
if(isGetRequest!=other.isGetRequest)returnfalse;
if(kvp==null){
if(other.kvp!=null)returnfalse;
else
if(!kvp.equals(other.kvp))returnfalse;
if(path==null){
if(other.path!=null)returnfalse;
else
if(!path.equals(other.path))returnfalse;
if(!Arrays.equals(postContent,other.postContent))returnfalse;returntrue;
if(isGetRequest){return"GET"+path+","+kvp;
else{return"POST"+path+","+kvp+",contenttype"+contentType+",content"+Arrays.toString(postContent);
if(kvp.containsKey("namespace")||kvp.containsKey("namespaces")){
if(kvp.get("namespace")instanceofNamespaceSupport){namespaces=(NamespaceSupport)kvp.get("namespace");
else
if(kvp.get("namespaces")instanceofNamespaceSupport){namespaces=(NamespaceSupport)kvp.get("namespaces");
else{LOGGER.warning("There'sanamespaceparameterbutitseemsitwasn'tparsedtoa"+NamespaceSupport.class.getName()+":"+kvp.get("namespace"));
if((kvp.containsKey("typeName")||kvp.containsKey("typeNames"))&&!kvp.containsKey("STOREDQUERY_ID")){//HACK,thekvpreadergivesusalistofQName,needtowrapin//anothertypeNames=(List)kvp.get("typeName");
if(typeNames==null){typeNames=(List)kvp.get("typeNames");
if(objinstanceofQName){QNameqName=(QName)obj;qName=checkTypeName(qName,namespaces,eObject);Listl=newArrayList();l.add(qName);list.add(l);
else{List<QName>qNames=(List<QName>)obj;for(inti=0;i<qNames.size();i++){qNames.set(i,checkTypeName(qNames.get(i),namespaces,eObject));
else{//checkforfeatureIdandinfertypeName//inWFS2.0itisresourceId
if(kvp.containsKey("featureId")||kvp.containsKey("resourceId")){//usefeatureIdtoinfertypeNamesListfeatureId=(List)kvp.get("featureId");featureId=featureId!=null?featureId:(List)kvp.get("resourceId");Set<List>hTypeNames=newHashSet<>();for(inti=0;i<featureId.size();i++){QNametypeName=getTypeNameFromFeatureId((String)featureId.get(i));
if(typeName!=null){hTypeNames.add(Arrays.asList(typeName));
else{//checkforstoredqueryid,ihaveseenbothstoredQueryIdandstoredQuery_Idused//sosupportbothList<URI>storedQueryId=null;
if(kvp.containsKey("storedQuery_Id")){storedQueryId=(List<URI>)kvp.get("storedQuery_Id");
if(storedQueryId==null&&kvp.containsKey("storedQueryId")){storedQueryId=(List<URI>)kvp.get("storedQueryId");
if(storedQueryId!=null){buildStoredQueries(eObject,storedQueryId,rawKvp);
else{thrownewWFSException(eObject,"ThequeryshouldspecifyeithertypeName,featureIdfilter"+",orastoredqueryid","MissingParameterValue");
if(kvp.containsKey("filter")){querySet(eObject,"filter",(List)kvp.get("filter"));
else
if(kvp.containsKey("cql_filter")){querySet(eObject,"filter",(List)kvp.get("cql_filter"));
else
if(kvp.containsKey("featureId")||kvp.containsKey("resourceId")){//setfilterfromfeatureIdListfeatureIdList=(List)kvp.get("featureId");booleanisFeatureId=featureIdList!=null;featureIdList=isFeatureId?featureIdList:(List)kvp.get("resourceId");Setids=newHashSet();for(Iteratori=featureIdList.iterator();i.hasNext();){Stringfid=(String)i.next();//checkconsistencybetweenresourceIdandtypeName(perWFS2.0CITEtests)
if(getWFS().isCiteCompliant()&&typeNames!=null&&!typeNames.isEmpty()){QNameqName=getTypeNameFromFeatureId(fid);
if(qName!=null){
if(!typeNames.stream().flatMap(List::stream).anyMatch(q->typeNameMatch(qName,q))){Stringlocator=isFeatureId?"FEATUREID":"RESOURCEID";WFSExceptionexception=newWFSException(eObject,"ResourceIdisincosistentwith"+"typenames");exception.setCode(ServiceException.INVALID_PARAMETER_VALUE);exception.setLocator(locator);throwexception;
else
if(kvp.containsKey("bbox")){handleBBOX(kvp,eObject);
if(typeName.size()>1){//TODO:notsurewhattodohere,justgoingtoandthemupListand=newArrayList(typeName.size());for(Iteratort=typeName.iterator();t.hasNext();){and.add(bboxFilter(bbox));
else{filter=bboxFilter(bbox);
if(pos!=-1){StringtypeName=fid.substring(0,fid.lastIndexOf("."));//addtoalisttosetonthequeryList<QName>parsed=(List)qNameParser.parse(typeName);returnparsed.get(0);
else{returnnull;
if(kvp.containsKey(keys[i])){for(intj=i+1;j<keys.length;j++){
if(kvp.containsKey(keys[j])){Stringmsg=keys[i]+"and"+keys[j]+"bothspecifiedbutaremutuallyexclusive";thrownewWFSException(request,msg);
if(namespaces!=null){
if(XMLConstants.DEFAULT_NS_PREFIX.equals(prefix)){//requestdidnotspecifyanamespaceprefixforthetypeName,//let'ssee
ifitspeficiedadefaultnamespaceStringuri=namespaces.getURI(XMLConstants.DEFAULT_NS_PREFIX);
if(!XMLConstants.NULL_NS_URI.equals(uri)){//alright,requestcamewithxmlns(http:...)toidicatthetypeName's//namespacenamespaceURI=uri;
else
if(namespaces.getURI(prefix)!=null){//sorequestusedacustomprefixanddeclaredtheprefix:urimapping?namespaceURI=namespaces.getURI(qName.getPrefix());
if(ns==null){thrownewWFSException("Unknownnamespace["+qName.getPrefix()+"]","InvalidParameterValue","namespace");
if(!XMLConstants.DEFAULT_NS_PREFIX.equals(qName.getPrefix())&&catalog.getNamespaceByPrefix(qName.getPrefix())==null){thrownewWFSException("Unknownnamespace["+qName.getPrefix()+"]","InvalidParameterValue","namespace");
if(catalog.getFeatureTypeByName(namespaceURI,localPart)==null){Stringname=qName.getPrefix()+":"+qName.getLocalPart();thrownewWFSException("Featuretype"+name+"unknown","InvalidParameterValue","typeName");
if(bboxinstanceofReferencedEnvelope3D){returnfilterFactory.bbox(name,(ReferencedEnvelope3D)bbox);
if(bboxinstanceofSRSEnvelope){SRSEnvelopese=(SRSEnvelope)bbox;epsgCode=se.getSrs();
else
if(bboxinstanceofReferencedEnvelope){CoordinateReferenceSystemcrs=((ReferencedEnvelope)bbox).getCoordinateReferenceSystem();
if(crs!=null){epsgCode=GML2EncodingUtils.toURI(crs);
ifneeded//configure(neededbyinitializeBean)configure();
if(type==null)thrownewIllegalArgumentException(message!=null?message:"Verifyfailstheargumentcheck");
ifsuccess*/publicbooleandisconnect(){
if(isRunning()){LOGGER.info("Disconnecting...");stop();for(intrep=1;rep<=max;++rep){LOGGER.info("Unregistering...");
if(!isRunning()){LOGGER.info("Succesfullyun-registeredfromthedestinationtopic");LOGGER.warning("Youwill(probably)loosenextincomingeventsfromotherinstances!!!(dependingonhowyouhaveconfiguredthebroker)");returntrue;
else{LOGGER.severe("Connectionisalreadystopped");
if(!isRunning()){LOGGER.info("Connecting...");start();
if(isRunning()){for(intrepReg=1;repReg<=max;++repReg){LOGGER.info("Registration...");
if(isRegisteredWithDestination()){LOGGER.info("NowGeoServerisregisteredwiththedestination");returntrue;
else
if(repReg==max){LOGGER.log(Level.SEVERE,"Registrationabortedduetoaconnectionproblem");stop();LOGGER.info("Disconnected");
else{LOGGER.info("ImpossibletoregisterGeoServerwithdestination,waiting...");
else{LOGGER.severe("Impossibletostartaconnectiontodestination.");stop();LOGGER.info("Disconnected");returnfalse;
else{LOGGER.severe("Connectionisalreadyrunning");
if(!verified){verify(jmsFactory,"failedtogetaJMSFactory");verified=true;
if(!isRunning()){//configurethecontainerconfigure();//startitsuper.start();//initializethecontainerinitialize();
if(jmsContainerHandleExceptionListener!=null){for(JMSContainerHandlerExceptionListenerhandler:jmsContainerHandleExceptionListener){handler.handleListenerSetupFailure(ex,alreadyRecovered);
if(event.getApplicationContext()==applicationContext){finalStringstartString=config.getConfiguration(ConnectionConfiguration.CONNECTION_KEY);
if(startString!=null&&startString.equals(ConnectionConfigurationStatus.enabled.toString())){
if(!connect()){
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("Unabletoconnecttothebroker,forceconnectionstatustodisabled");
if(forceGmt){dateFormat.setTimeZone(TimeZone.getTimeZone("GMT"));
if(pattern==null){//wraptheregexinagroupandmatchanythingaroundit(usereluctantwildcard//matching)pattern=Pattern.compile(".*?("+regex+").*?",Pattern.CASE_INSENSITIVE);
if(!m.matches()){returnnull;
if(isStrict()){//matchAndParseshouldbecalledreturnnull;
iftheparsingstopsbeforetheendofthestring,theremaining*charactersarejustignoredandnoexceptionisthrown.Sowehaveto*ensurethatthewholestringiscorrectfortheformat.*/ParsePositionpos=newParsePosition(0);Datep=dateFormat().parse(str,pos);
if(p!=null&&pos.getIndex()==str.length()){returnp;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;DatePatternother=(DatePattern)obj;
if(forceGmt!=other.forceGmt)returnfalse;
if(format==null){
if(other.format!=null)returnfalse;
else
if(!format.equals(other.format))returnfalse;
if(regex==null){
if(other.regex!=null)returnfalse;
else
if(!regex.equals(other.regex))returnfalse;returntrue;}}
if(listeners==null){synchronized(this){
if(listeners==null){listeners=newLinkedHashSet<HttpSessionListener>(GeoServerExtensions.extensions(HttpSessionListener.class));
if(coveragestoresinstanceofJSONArray){assertEquals(catalog.getCoverageStoresByWorkspace("wcs").size(),((JSONArray)coveragestores).size());
else{assertEquals(1,catalog.getCoverageStoresByWorkspace("wcs").size());
if(c.getStore().getName().equals("BlueMarble")){fail();
ifthisfactorycanproperlywrapthespecifiedobjectsofthespecifiedclass**@paramobject*/booleancanSecure(Classclazz);/***Wrapsthedataaccessobjectintoasecuredwrapper**@paramobjectTheobjecttobewrapped,<code>canWrap(object.getClass())</code>mustreturn*true,otherwisean{@linkIllegalArgumentException}willbethrown*@parampolicyThesecureobjecthandlingpolicythewrappershouldabideto*@returnareadonlywrapperforthespecifiedobject*/Objectsecure(Objectobject,WrapperPolicypolicy);}
if{@link#isJndi()}isset.*/publicStringgetJndiName(){returnjndiName;
if{@link#isJndi()}isfalse.*/publicStringgetDriverClassName(){returndriverClassName;
if{@link#isJndi()}isfalse.*/publicStringgetConnectURL(){returnconnectURL;
if{@link#isJndi()}isfalse.*/publicStringgetUserName(){returnuserName;
if{@link#isJndi()}isfalse.*/publicStringgetPassword(){returnpassword;
ifthetablesarecreatedbehindthescenes*/publicbooleanisCreatingTables(){returncreatingTables;
ifthebackingdatabaseismysql.*/protectedbooleanisMySQL(){return"com.mysql.jdbc.Driver".equals(driverClassName);
if(propertyFileNameDDL==null){propertyFileNameDDL=isMySQL()?defaultDDLFilenameMySQL():defaultDDLFilename();
if(propertyFileNameDML==null){propertyFileNameDML=isMySQL()?defaultDMLFilenameMySQL():defaultDMLFilename();
if(databaseName!=null){DbSourceds=dbSources.get(databaseName);
if(ds!=null){try{try(Connectionconn=ds.getDataSource().getConnection()){DatabaseMetaDatamd=conn.getMetaData();try(ResultSetrs=md.getTables(null,ds.getSchema(),"%",newString[]{"TABLE","VIEW"})){while(rs.next()){
if(ds.getSchema()!=null||rs.getString(2)==null){tables.add(rs.getString(3));
else{tables.add(rs.getString(2)+"."+rs.getString(3));
if(dependsOnRawValues.size()<1){thrownewIllegalArgumentException("tableNameparametermustbedependentondatabase.");
if(dependsOnRawValues.size()<1){thrownewIllegalArgumentException("tableNameparametermustbedependentondatabase.");
if(colon>=0){ni=geoServer.getCatalog().getNamespaceByPrefix(value.substring(0,colon));
else{ni=geoServer.getCatalog().getDefaultNamespace();
if(colon>=0){returngeoServer.getCatalog().getNamespaceByPrefix(value.substring(0,colon))!=null;
if(dependsOnRawValues.size()<1){thrownewIllegalArgumentException("fileparametermustbedependentonfileservice.");
if(mustExist){try{
if(!fileService.checkFileExists(ref.getLatestVersion())){returnnull;
if(dependsOnRawValues.size()<1){thrownewIllegalArgumentException("fileparametermustbedependentonfileservice.");
ifany(onelistperlayer)*/privateList<List<String>>propertyNames;/***Holderfortheoptional<code>EXCEPTIONS</code>parameter,defaultsto<code>*"application/vnd.ogc.se_xml"</code>*/privateStringexeptionFormat=DEFAULT_EXCEPTION_FORMAT;publicGetFeatureInfoRequest(){super("GetFeatureInfo");
ifany*/publicList<List<String>>getPropertyNames(){returnpropertyNames;
if(property==WhitelistRulesProvider.NAME){returnnewLabel(id,property.getModel(model));
else
if(property==WhitelistRulesProvider.PATTERN){returnnewLabel(id,property.getModel(model));
else
if(property==WhitelistRulesProvider.REQUIRE_SSL){finalWhitelistRulerule=(WhitelistRule)model.getObject();@SuppressWarnings("deprecation")Fragmentfragment=newFragment(id,"image.cell",this);
if(rule.isRequireSSL()){fragment.add(newImage("display",newPackageResourceReference(getClass(),"../lock.png")));
else{fragment.add(newImage("display",newPackageResourceReference(getClass(),"../lock_open.png")));
else
if(property==WhitelistRulesProvider.EDIT){ImageAjaxLinklink=newImageAjaxLink(id,newPackageResourceReference(GeoServerApplication.class,"img/icons/silk/pencil.png")){privatestaticfinallongserialVersionUID=4467715973193154831L;@OverridepublicvoidonClick(AjaxRequestTargettarget){window.setInitialHeight(360);window.setInitialWidth(400);window.setTitle(newModel<>("Editwhitelistrule"));window.setContent(newWhitelistRuleEditor(window.getContentId(),model,window,WhitelistRulePanel.this,false));window.show(target);
else
if(property==WhitelistRulesProvider.REMOVE){finalWhitelistRulerule=(WhitelistRule)model.getObject();ImageAjaxLinklink=newImageAjaxLink(id,newPackageResourceReference(GeoServerApplication.class,"img/icons/silk/delete.png")){privatestaticfinallongserialVersionUID=9069782618988848563L;@OverrideprotectedvoidonClick(AjaxRequestTargettarget){provider.remove(rule);provider.save();target.add(WhitelistRulePanel.this);
else{thrownewIllegalArgumentException("Property"+property+"isnotassociatedwiththiscomponent.");
if(rules==null){ConfigStoreconfigStore=(ConfigStore)GeoServerExtensions.bean("geogigConfigStore");try{rules=newArrayList<>(configStore.getWhitelist());
if(!(firstParaminstanceofGetCoverageType)){//weonlyhandleWCS2.0requestsreturnfalse;
if(format==null){format="image/tiff";
if(extension!=null){finalEList<ExtensionItemType>extensions=extension.getContents();for(ExtensionItemTypeext:extensions){encodingParameters.put(ext.getName(),ext.getSimpleContent());
if(methods[i].getParameterTypes().length==0){ObjectresultA=methods[i].invoke(reqA);ObjectresultB=methods[i].invoke(reqB);assertEquals(resultA,resultB);
if(component.hasFeedbackMessage()){FeedbackMessagesmessages=component.getFeedbackMessages();messages.clear(message->message.getLevel()>=level);
if(keywords!=null){for(KeywordInfokw:keywords){values.add(kw.getValue());
if(metadata==null){metadata=newMetadataMap();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofServiceInfo)){returnfalse;
if(abstrct==null){
if(other.getAbstract()!=null)returnfalse;
else
if(!abstrct.equals(other.getAbstract()))returnfalse;
if(accessConstraints==null){
if(other.getAccessConstraints()!=null)returnfalse;
else
if(!accessConstraints.equals(other.getAccessConstraints()))returnfalse;
if(citeCompliant!=other.isCiteCompliant())returnfalse;
if(enabled!=other.isEnabled())returnfalse;
if(exceptionFormats==null){
if(other.getExceptionFormats()!=null)returnfalse;
else
if(!exceptionFormats.equals(other.getExceptionFormats()))returnfalse;
if(fees==null){
if(other.getFees()!=null)returnfalse;
else
if(!fees.equals(other.getFees()))returnfalse;
if(id==null){
if(other.getId()!=null)returnfalse;
else
if(!id.equals(other.getId()))returnfalse;
if(keywords==null){
if(other.getKeywords()!=null)returnfalse;
else
if(!keywords.equals(other.getKeywords()))returnfalse;
if(maintainer==null){
if(other.getMaintainer()!=null)returnfalse;
else
if(!maintainer.equals(other.getMaintainer()))returnfalse;
if(metadataLink==null){
if(other.getMetadataLink()!=null)returnfalse;
else
if(!metadataLink.equals(other.getMetadataLink()))returnfalse;
if(name==null){
if(other.getName()!=null)returnfalse;
else
if(!name.equals(other.getName()))returnfalse;
if(onlineResource==null){
if(other.getOnlineResource()!=null)returnfalse;
else
if(!onlineResource.equals(other.getOnlineResource()))returnfalse;
if(outputStrategy==null){
if(other.getOutputStrategy()!=null)returnfalse;
else
if(!outputStrategy.equals(other.getOutputStrategy()))returnfalse;
if(schemaBaseURL==null){
if(other.getSchemaBaseURL()!=null)returnfalse;
else
if(!schemaBaseURL.equals(other.getSchemaBaseURL()))returnfalse;
if(title==null){
if(other.getTitle()!=null)returnfalse;
else
if(!title.equals(other.getTitle()))returnfalse;
if(verbose!=other.isVerbose())returnfalse;
if(versions==null){
if(other.getVersions()!=null)returnfalse;
else
if(!versions.equals(other.getVersions()))returnfalse;
if(workspace==null){
if(other.getWorkspace()!=null)returnfalse;
else
if(!workspace.equals(other.getWorkspace()))returnfalse;returntrue;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.info(format("%s-Acquiringdistributedlock'%s'(Thread%s)",nodeId(cluster),path,Thread.currentThread().getName()));//
if(LOGGER.isLoggable(Level.FINE)){LOGGER.info(format("%s-Successfullyacquireddistributedlock'%s'(Thread%s)",nodeId(cluster),path,Thread.currentThread().getName()));//
if(null==lock||!lock.isLocked()){LOGGER.info(format("%s-Distributedlockisalreadyunlocked'%s'(Thread%s)",nodeId(cluster),path,Thread.currentThread().getName()));return;
if(role==null){gaStore.addRole(role=gaStore.createRoleObject("ROLE_NEW"));gaStore.store();
if(mosaic.exists()&&mosaic.isDirectory()){FileUtils.deleteDirectory(mosaic);
if(mosaic.exists()&&mosaic.isDirectory()){FileUtils.deleteDirectory(mosaic);
if(mosaic.exists()){
if(mosaic.isDirectory()){FileUtils.deleteDirectory(mosaic);
else{mosaic.delete();
if(i<10){pad="000";
else
if(i<100){pad="00";
else
if(i<1000){pad="0";
if(key.equalsIgnoreCase(parser.getKey())){parsed=parser.parse(raw);
if(parsed!=null){break;
if(parsed==null){
if(LOGGER.isLoggable(Level.FINER))LOGGER.finer("Couldnotfindkvpparserfor:'"+key+"'.Storingasrawstring.");parsed=raw;
if(!orig.contains(group)){add.add(group);
else{remove.remove(group);
if(value==null||value.trim().length()==0){returnnull;
if(value.equals(symbols.getNaN())){returnnewDouble(Double.NaN);
else
if(value.equals(symbols.getInfinity())){returnnewDouble(Double.POSITIVE_INFINITY);
else
if(value.equals("-"+symbols.getInfinity())){returnnewDouble(Double.NEGATIVE_INFINITY);
else{returnsuper.convertToObject(value,locale);
if(path.contains("gwc/rest/sqlite/")){super.doFilterInternal(request,response,filterChain);
else{filterChain.doFilter(request,response);
if(outputMimeType!=null){returnoutputMimeType;
else{returnoutputFormat;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;TransformInfoother=(TransformInfo)obj;
if(featureType==null){
if(other.featureType!=null)returnfalse;
else
if(!featureType.equals(other.featureType))returnfalse;
if(fileExtension==null){
if(other.fileExtension!=null)returnfalse;
else
if(!fileExtension.equals(other.fileExtension))returnfalse;
if(name==null){
if(other.name!=null)returnfalse;
else
if(!name.equals(other.name))returnfalse;
if(outputFormat==null){
if(other.outputFormat!=null)returnfalse;
else
if(!outputFormat.equals(other.outputFormat))returnfalse;
if(outputMimeType==null){
if(other.outputMimeType!=null)returnfalse;
else
if(!outputMimeType.equals(other.outputMimeType))returnfalse;
if(sourceFormat==null){
if(other.sourceFormat!=null)returnfalse;
else
if(!sourceFormat.equals(other.sourceFormat))returnfalse;
if(xslt==null){
if(other.xslt!=null)returnfalse;
else
if(!xslt.equals(other.xslt))returnfalse;returntrue;
if(crs!=null){returncrs;
if(wkt==null){returnnull;
if(resourceManager.getArtifactsStore()==null||expirationDelay==0){return;
if(url!=null){try{MetadataLinkInfoImpl.validate(url);
if(applicationContext!=null){Collectionextensions=applicationContext.getBeansOfType(GeoServerFactory.Extension.class).values();for(Iteratore=extensions.iterator();e.hasNext();){Extensionextension=(Extension)e.next();
if(extension.canCreate(clazz)){returnextension.create(clazz);
if(!validate){return;
if(paramFilters==null){return;
if(key==null){thrownewIllegalStateException("ParameterFilterkeyisnull");
else{
if(keys.contains(key)){error(validatable,"ParameterFilterEditor.validation.duplicateKey");return;
else{keys.add(key);
if(params==null){message=newResourceModel(resourceKey).getObject();
else{message=newParamResourceModel(resourceKey,ParameterFilterEditor.this,(Object[])params).getObject();
if(child!=null){
if(!getList().contains(child.get("subform").getDefaultModelObject())){iterator.remove();
if(LOGGER.isLoggable(Level.CONFIG))LOGGER.log(Level.CONFIG,"Couldnotfindlocalizationresource"+"forParameterFiltersubclass"+object.getCanonicalName());returnobject.getSimpleName();
if(key==null||key.isEmpty()){ParamResourceModelrm=newParamResourceModel("ParameterFilterEditor.nonEmptyFilter",null,"");error(rm.getString());
else{Class<?extendsParameterFilter>type=availableFilterTypes.getModelObject();try{ParameterFilternewFilter=type.getConstructor().newInstance();newFilter.setKey(key);addFilter(newFilter);newFilterKey.setModel(Model.of(""));//Resetthekeyfield
if(model.getObject()instanceofRegexParameterFilter){returnnewRegexParameterFilterSubform(id,(IModel<RegexParameterFilter>)model);
if(model.getObject()instanceofStyleParameterFilter){returnnewStyleParameterFilterSubform(id,(IModel<StyleParameterFilter>)model);
if(model.getObject()instanceofStringParameterFilter){returnnewStringParameterFilterSubform(id,(IModel<StringParameterFilter>)model);
if(model.getObject()instanceofFloatParameterFilter){returnnewFloatParameterFilterSubform(id,(IModel<FloatParameterFilter>)model);
if(model.getObject()instanceofIntegerParameterFilter){returnnewIntegerParameterFilterSubform(id,(IModel<IntegerParameterFilter>)model);
if(componentinstanceofFormComponent){FormComponent<?>formComponent=(FormComponent<?>)component;formComponent.processInput();
if(existing.getKey().equalsIgnoreCase(key))returntrue;
if(hasFilter(filter.getKey()))returnfalse;filters.getModelObject().add(filter);returntrue;
ifapplicable*/publicenumAction{Add,Remove,Update,None};/***Aneventhandle,identifyingtheevent(canbecomingfromanexternalsystemtoavoid*re-processingnotificationsforactiontheexternalsystemhasundertaken)*/publicStringgetHandle();/**Theeventtype*/publicTypegetType();/***Theeventaction**@return*/publicActiongetAction();/***The"object"oftheevent,couldbewhathasbeencreated/inserted/modified,thecontainerof*it,therequest,andsoon.Typicallyacatalogobject,aserviceobject,oraRequest**@return*/publicObjectgetObject();/***Asetof"properties"attachedtotheevent,couldbepropertiesbeingchanged,thebounds*beingaffected,andsoon**@return*/publicMap<String,Object>getProperties();/**Theusertriggeringthechange,
ifany*/publicStringgetUser();}
if(getId()==null){returnsuper.equals(o);
else{returno.getClass().equals(getClass())&&getId().equals(((Identifiable)o).getId());
if(getId()==null){returnsuper.hashCode();
else{returngetId().hashCode();
if(coverageinstanceofGridCoverage2D){finalGridCoverage2Dgc=(GridCoverage2D)coverage;finalRenderedImageimage=gc.getRenderedImage();
if(imageinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)image);
if(enabled){
if(reqinstanceofHttpServletRequest){HttpServletRequesthreq=(HttpServletRequest)req;path=RequestUtils.getRemoteAddr(hreq)+"\""+hreq.getMethod()+""+hreq.getRequestURI();
if(hreq.getQueryString()!=null){path+="?"+hreq.getQueryString();
if(logBodies&&(hreq.getMethod().equals("PUT")||hreq.getMethod().equals("POST"))){message+="request-size:"+hreq.getContentLength();message+="body:";Stringencoding=hreq.getCharacterEncoding();
if(encoding==null){//thedefaultencodingforHTTP1.1encoding="ISO-8859-1";
else{message=""+req.getRemoteHost()+"madeanon-HTTPrequest";
else{chain.doFilter(req,res);
if(s==null)return"";returns;
ifalsoGeoToolsis//loaded...GeoServerInfoglobal=getGeoServer().getGlobal();global.setXmlExternalEntitiesEnabled(true);getGeoServer().save(global);//addwatertemperaturetestData.addStyle("temperature","temperature.sld",DownloadMapProcess.class,catalog);MappropertyMap=newHashMap();propertyMap.put(SystemTestData.LayerProperty.STYLE,"temperature");testData.addRasterLayer(WATERTEMP,"watertemp.zip",null,propertyMap,SystemTestData.class,catalog);setupRasterDimension(WATERTEMP,ResourceInfo.ELEVATION,DimensionPresentation.LIST,null,UNITS,UNIT_SYMBOL);setupRasterDimension(WATERTEMP,ResourceInfo.TIME,DimensionPresentation.LIST,null,null,null);//addabluemarblefourmonthsmosaictestData.addRasterLayer(BMTIME,"bm_time.zip",null,null,getClass(),catalog);setupRasterDimension(BMTIME,ResourceInfo.TIME,DimensionPresentation.LIST,null,null,null);//aworldcoveringlayerwithnodimensionstestData.addVectorLayer(GIANT_POLYGON,Collections.EMPTY_MAP,"giantPolygon.properties",SystemTestData.class,getCatalog());//adddecorationlayoutsFilelayouts=getDataDirectory().findOrCreateDir("layouts");FileUtils.copyURLToFile(getClass().getResource("watermarker.xml"),newFile(layouts,"watermarker.xml"));FileUtils.copyURLToFile(getClass().getResource("geoserver.png"),newFile(layouts,"geoserver.png"));FileUtils.copyURLToFile(getClass().getResource("timestamper.xml"),newFile(layouts,"timestamper.xml"));FileUtils.copyURLToFile(getClass().getResource("formattedTimestamper.xml"),newFile(layouts,"formattedTimestamper.xml"));//registerfontfortimestampingFontfont=Font.createFont(Font.TRUETYPE_FONT,getClass().getResourceAsStream("Vera.ttf"));FontCache.getDefaultInstance().registerFont(font);}}
if(type!=null){//createanewparticlebasedonthenewtypeXSDElementDeclarationvalue=XSDFactory.eINSTANCE.createXSDElementDeclaration();value.setName("Value");value.setTypeDefinition(type);XSDParticleparticle=XSDFactory.eINSTANCE.createXSDParticle();particle.setMinOccurs(1);particle.setMaxOccurs(1);particle.setContent(value);properties.add(newObject[]{particle,property.getValue()});
else{//coudlnotdeterminenewtype,justfallbacktoxs:anyTypeObject[]p=newObject[]{Schemas.getChildElementParticle(element.getType(),"Value",false),property.getValue()};properties.add(p);
if(name!=null){returnnewQName(name.getNamespaceURI(),name.getLocalPart());
if(subsetsinstanceofDimensionSubsetType){gc.getDimensionSubset().add((DimensionSubsetType)subsets);
else
if(subsetsinstanceofList){for(Objectsubset:(List)subsets){gc.getDimensionSubset().add((DimensionSubsetType)subset);
elseisinGetCoverageparseGeoTiffExtension(gc,kvp);parseCRSExtension(gc,rawKvp);parseScalingExtension(gc,kvp);parseRangeSubsetExtension(gc,kvp);parseInterpolationExtension(gc,kvp);parseOverviewPolicyExtension(gc,kvp);returngc;
if(kvpPrefix!=null){key=kvpPrefix+":"+param;
if(value!=null){ExtensionItemTypeitem=WCS20_FACTORY.createExtensionItemType();item.setNamespace(namespace);item.setName(param);item.setSimpleContent(value);gc.getExtension().getContents().add(item);
if(kvp.containsKey("scalefactor")){found=true;ScaleByFactorTypesf=WCS20_FACTORY.createScaleByFactorType();sf.setScaleFactor(((Double)kvp.get("scalefactor")));scaling.setScaleByFactor(sf);
if(kvp.containsKey("scaleaxes")){found=true;scaling.setScaleAxesByFactor((ScaleAxisByFactorType)kvp.get("scaleaxes"));
if(kvp.containsKey("scalesize")){found=true;scaling.setScaleToSize((ScaleToSizeType)kvp.get("scalesize"));
if(kvp.containsKey("scaleextent")){found=true;scaling.setScaleToExtent((ScaleToExtentType)kvp.get("scaleextent"));
ifwefoundatleastone,putitintheextensionmap(it'sthedutyof//GetCoveragetocomplainaboutmultiplescalingconstructs)
if(found==true){ExtensionItemTypeitem=WCS20_FACTORY.createExtensionItemType();item.setNamespace(Scaling.NAMESPACE);item.setName("Scaling");item.setObjectContent(scaling);gc.getExtension().getContents().add(item);
if(kvp.containsKey("rangesubset")){ExtensionItemTypeitem=WCS20_FACTORY.createExtensionItemType();item.setNamespace(RangeSubset.NAMESPACE);item.setName("RangeSubset");item.setObjectContent(kvp.get("rangesubset"));gc.getExtension().getContents().add(item);
if(kvp.containsKey("interpolation")){ExtensionItemTypeitem=WCS20_FACTORY.createExtensionItemType();item.setNamespace(Interpolation.NAMESPACE);item.setName("Interpolation");item.setObjectContent(kvp.get("interpolation"));gc.getExtension().getContents().add(item);
if(kvp.containsKey(WCS20Const.OVERVIEW_POLICY_EXTENSION_LOWERCASE)){Objectitem=kvp.get(WCS20Const.OVERVIEW_POLICY_EXTENSION_LOWERCASE);
if(iteminstanceofExtensionItemType){gc.getExtension().getContents().add((ExtensionItemType)item);
if("sortBy".equalsIgnoreCase(property)){//wegetanarraylistofarraylistsListsorts=(List)value;finalintsortsSize=sorts.size();
if(sortsSize!=1){thrownewOWS20Exception("InvalidsortByspecification,expectingsortsforjustonecoverage,butgot"+sortsSize+"instead",WCS20Exception.WCS20ExceptionCode.InvalidParameterValue,"sortBy");
else{super.setValue(eObject,property,value);
if(responseinstanceofTurboJPEGMapResponse){return;
ifitisnotspecifiedinthefeature.*Defaultsto{@linkDefaultGeographicCRS#WGS84}.*/publicGeoServerSLDVisitor(Catalogcatalog,CoordinateReferenceSystemfallbackCrs){this.catalog=catalog;this.fallbackCrs=fallbackCrs;
ifanOWSserviceotherthanWFSisspecifiedforaUserLayer*@throwsIllegalStateExceptionIfthesldissomehowinvalid,suchas
ifthereisaNamedLayer*withoutaname*@throwsServiceException
iftherewasaproblemaccessingaremoteOWSservice*@throwsUncheckedIOException
ifthereisanunderlying{@linkIOException}whenreading*{@linkStyle}objectsfromthecatalog*/@Overridepublicvoidvisit(StyledLayerDescriptorsld){
if(sld.getStyledLayers().length==0){thrownewIllegalStateException("SLDdocumentcontainsnolayers");
if(null==layer.getName()){thrownewServiceException("AUserLayerorNamedLayerwithoutlayernamewaspassed");
if(!handleLayerGroup()){super.visit(layer);
if(null==layer.getName()){thrownewServiceException("AUserLayerorNamedLayerwithoutlayernamewaspassed");
if(layer.getRemoteOWS()!=null){List<LayerInfo>layers=getRemoteLayersFromUserLayer(layer);visitUserLayerRemoteOWS(layer);//UserLayer-RemoteOWS:Applyeachstyletoeachlayerfor(LayerInfolayerInfo:layers){setLayerState(layerInfo,layer);super.visit(layer);clearLayerState();
else
if(layer.getInlineFeatureDatastore()!=null){try{setLayerState(getInlineFeatureLayer(layer,fallbackCrs),layer);
else{//TODO:BytheSLDspec,weshouldn'tbesupportingUserLayersasNamedLayers,butwe//doanyways.setLayerState(visitNamedLayerInternal(layer),layer);
if(info!=null&&infoinstanceofLayerGroupInfo){LayerGroupInfolg=(LayerGroupInfo)info;LayerGroupHelperlayerGroupHelper=newLayerGroupHelper(lg);List<LayerInfo>layers=lg.layers();List<StyleInfo>styles=lg.styles();try{for(inti=0;i<layers.size();i++){info=layers.get(i);StyleInfostyle=styles.get(i);
if(style==null){visit(layers.get(i).getDefaultStyle().getStyle());
else{visit(styles.get(i).getStyle());
if(styleCount==0&&info!=null&&infoinstanceofLayerInfo){StyleInfostyleInfo=((LayerInfo)info).getDefaultStyle();
if(styleInfo!=null){visit(styleInfo.getStyle());
if(styleinstanceofNamedStyle){visitNamedStyleInternal((NamedStyle)style);
else{visitUserStyleInternal(style);
ifanOWSserviceotherthanWFSisspecified*@throwsIllegalStateException*@throwsServiceException
iftherewasaproblemaccessingtheremoteservice*/protectedList<LayerInfo>getRemoteLayersFromUserLayer(UserLayerul)throwsServiceException{try{RemoteOWSservice=ul.getRemoteOWS();
if(!service.getService().equalsIgnoreCase("WFS"))thrownewUnsupportedOperationException("GeoServeronlysupportsWFSasremoteOWSservice");
if(service.getOnlineResource()==null)thrownewIllegalStateException("OnlineResourceforremoteWFSnotspecifiedinSLD");finalFeatureTypeConstraint[]featureConstraints=ul.getLayerFeatureConstraints();
if(featureConstraints==null||featureConstraints.length==0)thrownewIllegalStateException("NoFeatureTypeConstraintspecified,nolayercanbeloadedforthisUserStyle");DataStoreremoteWFS=null;ListremoteTypeNames=null;try{URLurl=newURL(service.getOnlineResource());remoteWFS=connectRemoteWFS(url);remoteTypeNames=newArrayList(Arrays.asList(remoteWFS.getTypeNames()));Collections.sort(remoteTypeNames);
if(Collections.binarySearch(remoteTypeNames,name)<0){thrownewIllegalStateException("Couldnotfindlayerfeaturetype'"+name+"'onremoteWFS'"+service.getOnlineResource());
iftherewasaproblemaccessingtheremoteservice*/protectedstaticDataStoreconnectRemoteWFS(URLremoteOwsUrl){try{WFSDataStoreFactorystoreFactory=newWFSDataStoreFactory();Mapparams=newHashMap(storeFactory.getImplementationHints());params.put(WFSDataStoreFactory.URL.key,remoteOwsUrl+"&request=GetCapabilities&service=WFS");params.put(WFSDataStoreFactory.TRY_GZIP.key,Boolean.TRUE);DataStoredataStore=storeFactory.createDataStore(params);returndataStore;
iftheydidn'tputan"srsName"ontheirgeometryintheir//inlinefeature?//Iguessweshouldassumetheymeantheirgeometrytoexistinthe//outputSRSofthe//requestthey'remaking.
if(ul.getInlineFeatureType().getCoordinateReferenceSystem()==null){LOGGER.warning("NoCRSsetoninlinefeaturesdefaultgeometry.AssumingtherequestorhastheirinlinefeaturesintheboundingboxCRS.");SimpleFeatureTypecurrFt=ul.getInlineFeatureType();Queryq=newQuery(currFt.getTypeName(),Filter.INCLUDE);FeatureReader<SimpleFeatureType,SimpleFeature>ilReader;DataStoreinlineFeatureDatastore=ul.getInlineFeatureDatastore();ilReader=inlineFeatureDatastore.getFeatureReader(q,Transaction.AUTO_COMMIT);CoordinateReferenceSystemcrs=(fallbackCrs==null)?DefaultGeographicCRS.WGS84:fallbackCrs;StringtypeName=inlineFeatureDatastore.getTypeNames()[0];MemoryDataStorereTypedDS=newMemoryDataStore(newForceCoordinateSystemFeatureReader(ilReader,crs));featureSource=reTypedDS.getFeatureSource(typeName);
else{DataStoreinlineFeatureDatastore=ul.getInlineFeatureDatastore();StringtypeName=inlineFeatureDatastore.getTypeNames()[0];featureSource=inlineFeatureDatastore.getFeatureSource(typeName);
if(!(featureSourceinstanceofCollectionFeatureSource)&&featureSource.getDataStore()instanceofWFSDataStore){layerInfo.setType(PublishedType.REMOTE);
else{layerInfo.setType(PublishedType.VECTOR);
if(name==null)thrownewNullPointerException("Processnamecannotbenull");
if(!names.contains(name))thrownewIllegalArgumentException("Unknownprocess'"+name+"'");
if(td!=null){description+="-"+td;
ifthereisanyrasteroutputbooleanhasRasterOutput=false;OutputObjectsSetooset=algorithm.getOutputObjects();for(inti=0;i<ooset.getOutputObjectsCount();i++){Outputoutput=ooset.getOutput(i);
if(outputinstanceofOutputRasterLayer){hasRasterOutput=true;break;
ifthereisanyinputoroutputrasterwealsoneedtheusertospecify//thegridstructure,thoughwecangetitfromthefirstraster
ifthere//arerasterinputs,meaninginthatcasewe'llgrabitfrom
if(hasRasterInput||hasRasterOutput){//createagridenvelope,requiredonly
ifthereisnorasterinputwecan//getthesameinfofrom
if(hasRasterInput){paramInfo.put(SEXTANTE_GRID_ENVELOPE,newParameter(SEXTANTE_GRID_ENVELOPE,Envelope.class,Text.text("Gridbounds(defaultstotheboundsoftheinputs)"),Text.text("Therealworldcoordinatesboundingthegrid"),false,0,1,null,null));paramInfo.put(SEXTANTE_GRID_CELL_SIZE,newParameter(SEXTANTE_GRID_CELL_SIZE,Double.class,Text.text("Cellsize(defaultstothesizeofthefirstinput)"),Text.text("Thecellsizeinrealworldunits"),false,0,1,null,null));
else{paramInfo.put(SEXTANTE_GRID_ENVELOPE,newParameter(SEXTANTE_GRID_ENVELOPE,Envelope.class,Text.text("Gridbounds"),Text.text("Therealworldcoordinatesboundingthegrid"),true,1,1,null,null));paramInfo.put(SEXTANTE_GRID_CELL_SIZE,newParameter(SEXTANTE_GRID_CELL_SIZE,Double.class,Text.text("Cellsize"),Text.text("Thecellsizeinrealworldunits"),true,1,1,null,null));
if(IVectorLayer.class.isAssignableFrom(parameterClass)){returnFeatureCollection.class;
else
if(IRasterLayer.class.isAssignableFrom(parameterClass)){returnGridCoverage2D.class;
else
if(ITable.class.isAssignableFrom(parameterClass)){returnFeatureCollection.class;
else{returnparameterClass;
ifcouldnotaccesstheadditionalinformationreturnmap;
if(paraminstanceofParameterRasterLayer){AdditionalInfoRasterLayerairl=(AdditionalInfoRasterLayer)ai;map.put(PARAMETER_MANDATORY,airl.getIsMandatory());
if(paraminstanceofParameterVectorLayer){AdditionalInfoVectorLayeraivl=(AdditionalInfoVectorLayer)ai;map.put(PARAMETER_MANDATORY,aivl.getIsMandatory());map.put(SHAPE_TYPE,aivl.getShapeType());
if(paraminstanceofParameterVectorLayer){AdditionalInfoVectorLayeraiv=(AdditionalInfoVectorLayer)ai;map.put(PARAMETER_MANDATORY,aiv.getIsMandatory());
if(paraminstanceofParameterString){AdditionalInfoStringais=(AdditionalInfoString)ai;map.put(DEFAULT_STRING_VALUE,ais.getDefaultString());
if(paraminstanceofParameterNumericalValue){AdditionalInfoNumericalValueainv=(AdditionalInfoNumericalValue)ai;map.put(DEFAULT_NUMERICAL_VALUE,ainv.getDefaultValue());map.put(MAX_NUMERICAL_VALUE,ainv.getMaxValue());map.put(MIN_NUMERICAL_VALUE,ainv.getMinValue());map.put(NUMERICAL_VALUE_TYPE,ainv.getType());
if(paraminstanceofParameterBoolean){AdditionalInfoBooleanaib=(AdditionalInfoBoolean)ai;map.put(DEFAULT_BOOLEAN_VALUE,aib.getDefaultValue());
if(paraminstanceofParameterMultipleInput){AdditionalInfoMultipleInputaimi=(AdditionalInfoMultipleInput)ai;map.put(MULTIPLE_INPUT_TYPE,aimi.getDataType());map.put(PARAMETER_MANDATORY,aimi.getIsMandatory());
if(paraminstanceofParameterFixedTable){AdditionalInfoFixedTableaift=(AdditionalInfoFixedTable)ai;map.put(FIXED_TABLE_NUM_COLS,aift.getColsCount());map.put(FIXED_TABLE_NUM_ROWS,aift.getRowsCount());map.put(FIXED_TABLE_FIXED_NUM_ROWS,aift.isNumberOfRowsFixed());
if(paraminstanceofParameterTableField){AdditionalInfoTableFieldaitf=(AdditionalInfoTableField)ai;map.put(PARENT_PARAMETER_NAME,aitf.getParentParameterName());
if(outputinstanceofOutputVectorLayer){outputClass=FeatureCollection.class;
else
if(outputinstanceofOutputRasterLayer){outputClass=GridCoverage2D.class;
else
if(outputinstanceofOutputTable){outputClass=FeatureCollection.class;
else
if(outputinstanceofOutputText){outputClass=String.class;
else{thrownewIllegalArgumentException("Don'tknowhowtohandleoutputoftype"+output.getClass());
if(batch.getId().equals(c.getId())){returntrue;
if(node.hasAttribute("viewParams")){NodeviewParamsAttribute=node.getAttribute("viewParams");viewParams=(List)wfsSqlViewKvpParser.parse((String)viewParamsAttribute.getValue());EListviewParamsList=neworg.eclipse.emf.common.util.BasicEList();viewParamsList.addAll(viewParams);viewParamsAttribute.setValue(viewParamsList);
if(node.hasAttribute("viewParams")){StringrawViewParams=(String)node.getAttributeValue("viewParams");ListviewParams=(List)wfsSqlViewKvpParser.parse(rawViewParams);WFSBindingUtils.set(object,"viewParams",viewParams);
if(property==TYPE){Fragmentf=newFragment(id,"iconFragment",LayerPage.this);f.add(newImage("layerIcon",icons.getSpecificLayerIcon(itemModel.getObject())));returnf;
else
if(property==STORE){returnstoreLink(id,itemModel);
else
if(property==NAME){returnlayerLink(id,itemModel);
else
if(property==ENABLED){LayerInfolayerInfo=itemModel.getObject();//askforenabled()insteadofisEnabled()toaccountfordisabled//resource/storebooleanenabled=layerInfo.enabled();PackageResourceReferenceicon=enabled?icons.getEnabledIcon():icons.getDisabledIcon();Fragmentf=newFragment(id,"iconFragment",LayerPage.this);f.add(newImage("layerIcon",icon));returnf;
else
if(property==SRS){returnnewLabel(id,SRS.getModel(itemModel));
else
if(property==TITLE){returntitleLink(id,itemModel);
if(StringUtils.isEmpty(layerTitle)){linkModel=layerNameModel;
if(storeinstanceofDataStoreInfo){returnnewSimpleBookmarkableLink(id,DataAccessEditPage.class,storeModel,DataAccessEditPage.STORE_NAME,storeName,DataAccessEditPage.WS_NAME,wsName);
else
if(storeinstanceofWMTSStoreInfo){returnnewSimpleBookmarkableLink(id,WMTSStoreEditPage.class,storeModel,DataAccessEditPage.STORE_NAME,storeName,DataAccessEditPage.WS_NAME,wsName);
else
if(storeinstanceofWMSStoreInfo){returnnewSimpleBookmarkableLink(id,WMSStoreEditPage.class,storeModel,DataAccessEditPage.STORE_NAME,storeName,DataAccessEditPage.WS_NAME,wsName);
else{returnnewSimpleBookmarkableLink(id,CoverageStoreEditPage.class,storeModel,DataAccessEditPage.STORE_NAME,storeName,DataAccessEditPage.WS_NAME,wsName);
if(ruleLimits==null){ruleLimits=newRuleLimits();
if(getAllowedArea()!=null){ruleLimits.setAllowedArea(getAllowedArea());
if(getCatalogMode()!=null){ruleLimits.setCatalogMode(CatalogMode.valueOf(getCatalogMode().toUpperCase()));
if(accessType!=null){att.setAccess(AccessType.valueOf(accessType.toUpperCase()));
if(details==null){details=neworg.geoserver.geofence.core.model.LayerDetails();
if(layerType!=null){details.setType(LayerType.valueOf(layerType.toUpperCase()));
if(allowedStyles!=null){details.getAllowedStyles().addAll(allowedStyles);
if(allowedArea!=null){details.setArea(allowedArea);
if(layerAttributes!=null){for(LayerAttributeatt:layerAttributes){Iterator<org.geoserver.geofence.core.model.LayerAttribute>it=details.getAttributes().iterator();while(it.hasNext()){
if(it.next().getName().equals(att.getName())){it.remove();break;
if(catalogMode!=null){details.setCatalogMode(CatalogMode.valueOf(catalogMode.toUpperCase()));
if(cqlFilterRead!=null){details.setCqlFilterRead(cqlFilterRead);
if(cqlFilterWrite!=null){details.setCqlFilterWrite(cqlFilterWrite);
if(defaultStyle!=null){details.setDefaultStyle(defaultStyle);
if(rule.getRuleLimits()!=null){limits=newLimits();limits.setAllowedArea(rule.getRuleLimits().getAllowedArea());limits.setCatalogMode(rule.getRuleLimits().getCatalogMode().toString());
if(rule.getLayerDetails()!=null){layerDetails=newLayerDetails();layerDetails.setAllowedArea(rule.getLayerDetails().getArea());layerDetails.getAllowedStyles().addAll(rule.getLayerDetails().getAllowedStyles());layerDetails.setCatalogMode(rule.getLayerDetails().getCatalogMode().toString());layerDetails.setCqlFilterRead(rule.getLayerDetails().getCqlFilterRead());layerDetails.setCqlFilterWrite(rule.getLayerDetails().getCqlFilterWrite());layerDetails.setDefaultStyle(rule.getLayerDetails().getDefaultStyle());layerDetails.setLayerType(rule.getLayerDetails().getType().toString());for(org.geoserver.geofence.core.model.LayerAttributeatt:rule.getLayerDetails().getAttributes()){layerDetails.getAttributes().add(newLayerAttribute(att));
if(getPriority()!=null){rule.setPriority(getPriority());
if(getPriority()!=null){rule.setPriority(getPriority());
if(getAccess()!=null){rule.setAccess(GrantType.valueOf(getAccess()));
if(getUserName()!=null){rule.setUsername(convertAny(getUserName()));
if(getRoleName()!=null){rule.setRolename(convertAny(getRoleName()));
if(getAddressRange()!=null){rule.setAddressRange(newIPAddressRange(getAddressRange()));
if(getService()!=null){rule.setService(convertAny(getService()));
if(getRequest()!=null){rule.setRequest(convertAny(getRequest()));
if(getWorkspace()!=null){rule.setWorkspace(convertAny(getWorkspace()));
if(getLayer()!=null){rule.setLayer(convertAny(getLayer()));
if(id!=null){rule.setId(id);
if("".equals(s)||"*".equals(s))returnnull;
elsereturns;}}
if'uom'isnotset,schemavalidationfails.//validateGet(path);}}
if(isUniqueIndex){sb.append("UNIQUE");
if(isSpatialIndex){sb.append("USINGgist");
if(schema==null){schema=defaultSchema==null?"public":defaultSchema;
if(legalStyle.equals(stylesParamFilter.getDefaultValue())){assertEquals(0,modifiedParams.size());
else{assertEquals(Collections.singletonMap("STYLES",legalStyle),modifiedParams);
ifisolatedworkspacesaresupportedornot*/publicbooleansupportsIsolatedWorkspaces(){returnsupportsIsolatedWorkspaces;
ifisolatedworkspacesaresupportedornot.**@paramsupportsIsolatedWorkspacesTRUEorFALSE,specifying
ifisolatedworkspacesare*supported*/publicvoidsetIsolatedWorkspacesSupport(booleansupportsIsolatedWorkspaces){this.supportsIsolatedWorkspaces=supportsIsolatedWorkspaces;}}
ifwearenotinhitsmodeList<FeatureCollection>results=newArrayList<FeatureCollection>();for(inti=0;i<queries.size();i++){FeatureCollectioncollection=store.getRecords(queries.get(i),Transaction.AUTO_COMMIT,request.getOutputSchema());
if(collection!=null&&collection.size()>0){results.add(collection);
if(results.size()==1){records=results.get(0);
else
if(results.size()>1){records=newCompositeFeatureCollection(results);
if(elementSet==null){//thedefaultis"summary"elementSet=ElementSetType.SUMMARY;
ifaspatialoperator//isusedagainstanonspatialproperty
if(q.getFilter()!=null){rd.verifySpatialFilters(q.getFilter());
if(outputSchema==null){outputSchema=CSW.NAMESPACE;request.setOutputFormat(CSW.NAMESPACE);
if(outputSchema.equals(rd.getOutputSchema())){returnrd;
if(queueId!=null){BlockingQueue<Request>queue=queues.get(queueId);
if(queue!=null)queue.remove(request);
ifthisclientalreadymadeotherconnectionsfinalStringincomingIp;{Stringip=getRemoteAddr(request.getHttpRequest());
if(null==ip||"".equals(ip)){//maythishappen?hopenot,but
ifsomeoneistryingtotrickusletsnotlethim//andpoolitonthe"emptyIP"queueincomingIp="";
else{incomingIp=ip;
ifwehavethatqueuealreadyTimedBlockingQueuequeue=queues.get(incomingIp);//generateauniquequeueidforthisclient
ifnonewasfound
if(queue==null){//bewareofmultipleconcurrentrequests...synchronized(queues){queue=queues.get(incomingIp);
if(queue==null){queue=newTimedBlockingQueue(queueSize,true);queues.put(incomingIp,queue);
if(timeout>0){retval=queue.offer(request,timeout,TimeUnit.MILLISECONDS);
else{queue.put(request);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("IpFlowController("+queueSize+","+incomingIp+")queuesize"+queue.size());LOGGER.fine("IpFlowController("+queueSize+","+incomingIp+")totalqueues"+queues.size());
if(forwardedFor!=null){
if(-1==forwardedFor.indexOf(',')){returnforwardedFor;
else{returnreq.getRemoteAddr();
if(reprojectTx==null){reprojectTx=newReprojectTransform(null);reprojectTx.setSource(item.getLayer().getResource().getNativeCRS());
if(reprojectCheckBox.getModelObject()){txChain.add(reprojectPanel.getTransform());
if(Date.class.equals(type)){StringdateFormat=dateFormatTextField.getModelObject();
if(dateFormat==null||"".equals(dateFormat.trim())){dateFormat=null;
else
if(Number.class.isAssignableFrom(type)){item.setModelObject(newNumberFormatTransform(field,type));
if(sortBy.length==0){thrownewIllegalArgumentException("Nowaytobuildcomparatorsoutofanemptycomparatorset");
if(sortBy.length==1){returnbuildComparator(sortBy[0]);
else{List<Comparator<Info>>comparators=newArrayList<Comparator<Info>>();for(SortBycurr:sortBy){Comparator<Info>comparator=buildComparator(curr);comparators.add(comparator);
if(sortBy==null){thrownewNullPointerException("ThesortByargumentmustbenotnull");
if(sortBy==SortBy.NATURAL_ORDER){returnnewInfoComparator(true);
else
if(sortBy==SortBy.REVERSE_ORDER){returnnewInfoComparator(false);
else{returnnewPropertyComparator<Info>(sortBy.getPropertyName(),sortBy.getSortOrder()==SortOrder.ASCENDING);
if(roles!=null&&!roles.isEmpty()){for(StringroleName:roles){GeoServerRolerole=store.getRoleByName(roleName);
if(role==null){role=service.createRoleObject(roleName);store.addRole(role);
if(format!=null){this.format=format;
if(format!=null){this.formatLanguage=formatLanguage;
if(format==null){returnString.format("1:%0$1.0f",scale);
else{DecimalFormatSymbolsdecimalFormatSymbols;
if(formatLanguage!=null){decimalFormatSymbols=DecimalFormatSymbols.getInstance(newLocale(formatLanguage));
else{decimalFormatSymbols=DecimalFormatSymbols.getInstance();
if(handler==null){returnfalse;
if(!missingTables.isEmpty()){thrownewIOException("Missingrequiredtablesinthebackingstore"+missingTables);
if(name.startsWith(EO_PREFIX)){name=name.substring(EO_PREFIX.length());charc[]=name.toCharArray();c[0]=Character.toLowerCase(c[0]);name=newString(c);namespaceURI=EO_NAMESPACE;
if(StringUtils.isAllUpperCase(name)){name=name.toLowerCase();
if(adinstanceofGeometryDescriptor){GeometryTypeat=ab.buildGeometryType();ab.setCRS(((GeometryDescriptor)ad).getCoordinateReferenceSystem());mappedDescriptor=ab.buildDescriptor(newNameImpl(namespaceURI,name),at);
else{AttributeTypeat=ab.buildType();mappedDescriptor=ab.buildDescriptor(newNameImpl(namespaceURI,name),at);
if("bands".equals(ad.getLocalName())||"browseBands".equals(ad.getLocalName())){b.add(ad.getLocalName(),String[].class);
else{b.add(ad);
if(name.startsWith(EO_PREFIX)){name="eop"+name.substring(2);
if(name.startsWith(prefix)){name=name.substring(prefix.length());charc[]=name.toCharArray();c[0]=Character.toLowerCase(c[0]);name=newString(c);namespaceURI=pc.getNamespace();break;
if(StringUtils.isAllUpperCase(name)){name=name.toLowerCase();
if(adinstanceofGeometryDescriptor){GeometryTypeat=ab.buildGeometryType();ab.setCRS(((GeometryDescriptor)ad).getCoordinateReferenceSystem());mappedDescriptor=ab.buildDescriptor(newNameImpl(namespaceURI,name),at);
else{AttributeTypeat=ab.buildType();mappedDescriptor=ab.buildDescriptor(newNameImpl(namespaceURI,name),at);
if(layer!=null&&layer.isSeparateBands()&&layer.getBands()!=null&&layer.getBands().length>0){//onefeaturetypeperbandneededtosetupacoverageviewfor(Stringband:layer.getBands()){names.add(newNameImpl(namespaceURI,name+OpenSearchAccess.BAND_LAYER_SEPARATOR+band));
else{//asinglefeaturetypepernames.add(newNameImpl(namespaceURI,name));
if(name.equals(ft.getName())){returnft;
ifit'sacollectioncaseFeatureSource<FeatureType,Feature>source=getFeatureSource(name);
if(source!=null){returnsource.getSchema();
if(collectionFeatureType.getName().equals(typeName)){returngetCollectionSource();
else
if(productFeatureType.getName().equals(typeName)){returngetProductSource();
if(Objects.equal(namespaceURI,typeName.getNamespaceURI())&&getNames().contains(typeName)){//sillygenerics...return(FeatureSource)getCollectionGranulesSource(typeName.getLocalPart());
if(idx>1&&idx<(typeName.length()-3)){collection=typeName.substring(0,idx);band=typeName.substring(idx+OpenSearchAccess.BAND_LAYER_SEPARATOR.length());
else{collection=typeName;band=null;
if(JDBCOpenSearchAccess.PRODUCT.equalsIgnoreCase(name)){productTableName=name;
else
if(JDBCOpenSearchAccess.COLLECTION.equalsIgnoreCase(name)){collectionTableName=name;
else
if(JDBCOpenSearchAccess.GRANULE.equalsIgnoreCase(name)){granuleTableName=name;
ifany(mightbeavirtualcollection)SimpleFeaturecollectionFeature=getCollectionFeature(collection,delegate,collectionTableName);StringsensorType=(String)collectionFeature.getAttribute("eoSensorType");ProductClassproductClass=null;
if(sensorType!=null){productClass=OpenSearchAccess.ProductClass.valueOf(sensorType);
if(ad.getLocalName().startsWith(JDBCOpenSearchAccess.EO_PREFIX)){Stringcolumn=encodeColumn(dialect,"collection",ad.getLocalName());
if(ad.getLocalName().equals("eoIdentifier")){attributes.add(column+"as\"collectionEoIdentifier\"");
else
if(!"eoAcquisitionStation".equals(ad.getLocalName())){//addeverythingthat'snotduplicateattributes.add(column);
if(localName.startsWith(JDBCOpenSearchAccess.EO_PREFIX)||"timeStart".equals(localName)||"timeEnd".equals(localName)||"crs".equals(localName)||(productClass!=null&&localName.startsWith(productClass.getPrefix()))||(productClass==null&&matchesAnyProductClass(localName))){Stringcolumn=encodeColumn(dialect,"product",localName);attributes.add(column);
if("id".equalsIgnoreCase(localName)||"band".equalsIgnoreCase(localName)){//thesetwoshouldnotappearinthefeaturetypecontinue;
else
if("product_id".equalsIgnoreCase(localName)){productIdColumn=localName;
else{Stringcolumn=encodeColumn(dialect,"granule",ad.getLocalName());attributes.add(column);
if("the_geom".equalsIgnoreCase(localName)){theGeomName=localName;
else
if("gid".equalsIgnoreCase(localName)){gidName=localName;
ifprimaryisnulloremptybooleanprimaryTable=!Boolean.FALSE.equals(collectionFeature.getAttribute("primary"));
if(primaryTable||band!=null){sb.append("WHERE");
if(primaryTable){sb.append("collection.\"id\"="+collectionFeature.getAttribute("id"));
if(band!=null){
if(primaryTable){sb.append("\nAND");
ifthevirtualcollectionisalreadythereMap<String,VirtualTable>existingVirtualTables=delegate.getVirtualTables();VirtualTableexisting=existingVirtualTables.get(typeName);
if(existing!=null){//wasitupdatedinthemeantime?
if(!existing.equals(vt)){delegate.dropVirtualTable(collectionTableName);existing=null;
if(existing==null){delegate.createVirtualTable(vt);
if(!primaryTable){StringcqlFilter=(String)collectionFeature.getAttribute("productCqlFilter");
if(cqlFilter!=null){try{Filterfilter=ECQL.toFilter(cqlFilter);fs=DataUtilities.createView(fs,newQuery(fs.getSchema().getTypeName(),filter));
if(databaseSchema!=null){dialect.encodeSchemaName(databaseSchema,sql);sql.append(".");
if(tableAliasName!=null){sql.append(tableAliasName).append(".");
if(localName.startsWith(pc.getPrefix())){returntrue;
if(tableName==null){thrownewIllegalStateException("Couldnotlocatesourcetablefor"+lookup);
if(JDBCOpenSearchAccess.PRODUCT.equalsIgnoreCase(name)){productTableName=name;
else
if(JDBCOpenSearchAccess.GRANULE.equalsIgnoreCase(name)){granuleTableName=name;
if(productFeature==null){thrownewIOException("Couldnotfindaproductwithid'"+productId+"'incollection'"+collectionId+"'");
if(LOGGER.isLoggable(Level.FINER)){StringBuildersb=newStringBuilder(sql);for(Entry<String,?>e:namedParameters.entrySet()){Objectvalue=e.getValue();Stringsval;
if(valueinstanceofCollection){Collection<?>c=(Collection<?>)value;StringBuildercv=newStringBuilder();for(Iterator<?>it=c.iterator();it.hasNext();){Objectv=it.next();
if(v==null){cv.append("null");
else
if(vinstanceofNumber){cv.append(v);
else{cv.append("'").append(String.valueOf(v)).append("'");
if(it.hasNext()){cv.append(",");
else{sval=value==null?"null":(valueinstanceofNumber?String.valueOf(value):"'"+String.valueOf(value)+"'");
else
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("querying"+sql+"\nwithvalues:"+namedParameters);
if(layers==null){return;
if(colon==-1){//totallynonprefixed,doacataloglookupforthelayerLayerInfol=cat.getLayerByName(layer);
if(l!=null){layers.set(i,l.getResource().getPrefixedName());
else{//prefix,maybebyfullnamespaceurithoughStringprefix=layer.substring(0,colon);Stringlocal=layer.substring(colon+1);NamespaceInfons=cat.getNamespaceByPrefix(prefix);
if(ns==null){//maybeitwasprefixedbyurins=cat.getNamespaceByURI(prefix);
if(ns!=null){prefix=ns.getPrefix();
else{//ok,propertyprefixed
ifthismethodgetscalled//beforeoraftertheapplicationgetsitsappcontxt
if(manager.isEncryptingUrlParams()){returngetCrypt();
else{returnnewNoCrypt();
if(theCrypt==null){synchronized(this){
if(theCrypt==null){GeoServerApplicationapplication=GeoServerApplication.get();theCrypt=application.getSecuritySettings().getCryptFactory().newCrypt();
if(async){importId=json.getJSONObject("import").getInt("id");for(inti=0;i<60*2*2;i++){json=(JSONObject)getAsJSON("/rest/imports/"+importId);//print(json);state=json.getJSONObject("import").getString("state");
if("INIT".equals(state)||"RUNNING".equals(state)||"PENDING".equals(state)){Thread.sleep(500);
else{state=json.getJSONObject("import").getString("state");importId=json.getJSONObject("import").getInt("id");
if(async){for(inti=0;i<60*2*2;i++){json=(JSONObject)getAsJSON("/rest/imports/"+importId);//print(json);state=json.getJSONObject("import").getString("state");
if("INIT".equals(state)){Thread.sleep(500);
if(async){for(inti=0;i<60*2*2;i++){json=(JSONObject)getAsJSON("/rest/imports/"+importId);//print(json);state=json.getJSONObject("import").getString("state");
if("INIT".equals(state)||"RUNNING".equals(state)||"PENDING".equals(state)){Thread.sleep(500);
else{json=(JSONObject)getAsJSON("/rest/imports/"+importId);state=json.getJSONObject("import").getString("state");
if(mosaicRoot.exists()){FileUtils.deleteDirectory(mosaicRoot);
if(dirFromEnv!=null&&dirFromEnv.exists()){FileUtils.deleteQuietly(dirFromEnv);
if(System.getProperty(Importer.UPLOAD_ROOT_KEY)!=null){System.clearProperty(Importer.UPLOAD_ROOT_KEY);
ifbashisthereAssume.assumeTrue("Couldnotfindshinpath,skipping",ImporterDataTest.checkShellAvailable());//thetargetlayerisnotthereassertNull(getCatalog().getLayerByName("archsites"));//writeoutasimpleshellscriptinthedatadirandmakeitexecutableFilescripts=getDataDirectory().findOrCreateDir("importer","scripts");Filescript=newFile(scripts,"test.sh");FileUtils.writeStringToFile(script,"touchtest.properties\n");script.setExecutable(true,true);//createcontextwithdefaultnameFiledir=unpack("shape/archsites_epsg_prj.zip");ImportContextcontext=importer.createContext(0l);importer.changed(context);importer.update(context,newSpatialFile(newFile(dir,"archsites.shp")));//addatransformationtorunpostscriptStringjson="{\n"+"\"type\":\"PostScriptTransform\",\n"+"\"name\":\"test.sh\"\n"+"}";MockHttpServletResponseresp=postAsServletResponse(RestBaseController.ROOT_PATH+"/imports/0/tasks/0/transforms",json,"application/json");assertEquals(HttpStatus.CREATED.value(),resp.getStatus());//runitcontext=importer.getContext(0);importer.run(context);//checkthelayerhasbeencreatedassertNotNull(getCatalog().getLayerByName("archsites"));//verifythescriptalsorunFiletestFile=newFile(scripts,"test.properties");assertTrue(testFile.exists());
ifbashisthereAssume.assumeTrue("Couldnotfindshinpath,skipping",ImporterDataTest.checkShellAvailable());//thetargetlayerisnotthereassertNull(getCatalog().getLayerByName("archsites"));//writeoutasimpleshellscriptinthedatadirandmakeitexecutableFilescripts=getDataDirectory().findOrCreateDir("importer","scripts");Filescript=newFile(scripts,"test.sh");FileUtils.writeStringToFile(script,"touch$1\n");script.setExecutable(true,true);//createcontextwithdefaultnameFiledir=unpack("shape/archsites_epsg_prj.zip");ImportContextcontext=importer.createContext(0l);importer.changed(context);importer.update(context,newSpatialFile(newFile(dir,"archsites.shp")));//addatransformationtorunpostscriptStringjson="{\n"+"\"type\":\"PostScriptTransform\",\n"+"\"name\":\"test.sh\",\n"+"\"options\":[\"test.abc\"]"+"}";MockHttpServletResponseresp=postAsServletResponse(RestBaseController.ROOT_PATH+"/imports/0/tasks/0/transforms",json,"application/json");assertEquals(HttpStatus.CREATED.value(),resp.getStatus());//runitcontext=importer.getContext(0);importer.run(context);//checkthelayerhasbeencreatedassertNotNull(getCatalog().getLayerByName("archsites"));//verifythescriptalsorunFiletestFile=newFile(scripts,"test.abc");assertTrue(testFile.exists());
if(backupExecution.getStatus()==BatchStatus.ABANDONED||backupExecution.getStatus()==BatchStatus.FAILED||backupExecution.getStatus()==BatchStatus.UNKNOWN){for(Throwableexception:backupExecution.getAllFailureExceptions()){LOGGER.log(Level.INFO,"ERROR:"+exception.getLocalizedMessage(),exception);exception.printStackTrace();
if(backupExecution.getStatus()==BatchStatus.ABANDONED||backupExecution.getStatus()==BatchStatus.FAILED||backupExecution.getStatus()==BatchStatus.UNKNOWN){LOGGER.severe("backupExecution.getStatus()=="+(backupExecution.getStatus()));for(Throwableexception:backupExecution.getAllFailureExceptions()){LOGGER.log(Level.INFO,"ERROR:"+exception.getLocalizedMessage(),exception);exception.printStackTrace();
if(restoreExecution.getStatus()==BatchStatus.ABANDONED||restoreExecution.getStatus()==BatchStatus.FAILED||restoreExecution.getStatus()==BatchStatus.UNKNOWN){for(Throwableexception:restoreExecution.getAllFailureExceptions()){LOGGER.log(Level.INFO,"ERROR:"+exception.getLocalizedMessage(),exception);exception.printStackTrace();
if(restoreCatalog.getWorkspaces().size()>0){assertTrue(restoreCatalog.getWorkspaces().size()==restoreCatalog.getNamespaces().size());assertTrue(restoreCatalog.getDataStores().size()==4);assertTrue(restoreCatalog.getResources(FeatureTypeInfo.class).size()==14);assertTrue(restoreCatalog.getResources(CoverageInfo.class).size()==4);assertTrue(restoreCatalog.getStyles().size()==21);assertTrue(restoreCatalog.getLayers().size()==4);assertTrue(restoreCatalog.getLayerGroups().size()==1);
if(restoreExecution.getStatus()==BatchStatus.ABANDONED||restoreExecution.getStatus()==BatchStatus.FAILED||restoreExecution.getStatus()==BatchStatus.UNKNOWN){for(Throwableexception:restoreExecution.getAllFailureExceptions()){LOGGER.log(Level.INFO,"ERROR:"+exception.getLocalizedMessage(),exception);exception.printStackTrace();
if(restoreCatalog.getWorkspaces().size()>0){assertTrue(restoreCatalog.getWorkspaces().size()==restoreCatalog.getNamespaces().size());assertTrue(restoreCatalog.getDataStores().size()==4);assertTrue(restoreCatalog.getResources(FeatureTypeInfo.class).size()==14);assertTrue(restoreCatalog.getResources(CoverageInfo.class).size()==4);assertTrue(restoreCatalog.getStyles().size()==21);assertTrue(restoreCatalog.getLayers().size()==4);assertTrue(restoreCatalog.getLayerGroups().size()==1);
if(restoreExecution.getStatus()==BatchStatus.ABANDONED||restoreExecution.getStatus()==BatchStatus.FAILED||restoreExecution.getStatus()==BatchStatus.UNKNOWN){for(Throwableexception:restoreExecution.getAllFailureExceptions()){LOGGER.log(Level.INFO,"ERROR:"+exception.getLocalizedMessage(),exception);exception.printStackTrace();
if(restoreCatalog.getWorkspaces().size()>0){//assertTrue(restoreCatalog.getWorkspaces().size()==2);assertTrue(restoreCatalog.getDataStores().size()==2);assertTrue(restoreCatalog.getStyles().size()==21);
if(backupExecution.getStatus()==BatchStatus.ABANDONED||backupExecution.getStatus()==BatchStatus.FAILED||backupExecution.getStatus()==BatchStatus.UNKNOWN){for(Throwableexception:backupExecution.getAllFailureExceptions()){LOGGER.log(Level.INFO,"ERROR:"+exception.getLocalizedMessage(),exception);exception.printStackTrace();
if(backupExecution.getStatus()!=BatchStatus.COMPLETED){backupFacade.stopExecution(backupExecution.getId());//WaitabitThread.sleep(100);assertNotNull(backupExecution);while(backupExecution.getStatus()!=BatchStatus.STOPPED){Thread.sleep(100);
if(backupExecution.getStatus()==BatchStatus.ABANDONED||backupExecution.getStatus()==BatchStatus.FAILED||backupExecution.getStatus()==BatchStatus.UNKNOWN){for(Throwableexception:backupExecution.getAllFailureExceptions()){LOGGER.log(Level.INFO,"ERROR:"+exception.getLocalizedMessage(),exception);exception.printStackTrace();
iftheextrapropertiesfilewascorrectlybackup/restore.*/privatevoidcheckExtraPropertiesExists(){//findthepropertiesfileonthecurrentdatadirGeoServerDataDirectorydataDirectory=GeoServerExtensions.bean(GeoServerDataDirectory.class);ResourceextraResource=dataDirectory.get(ExtraFileHandler.EXTRA_FILE_NAME);assertThat(extraResource.file().exists(),is(true));//loadthepropertiesPropertiesextraProperties=newProperties();try(InputStreaminput=extraResource.in()){extraProperties.load(input);
if(si.getCustomCapabilitiesLink()!=null){StringserviceId=si.getId();StringcapsLink=si.getCustomCapabilitiesLink();CapsInfoci=newCapsInfo(serviceId,si.getVersion(),capsLink);serviceInfoLinks.add(ci);
else
if(si.getOperations().contains("GetCapabilities")){StringserviceId=si.getId();StringcapsLink="../ows?service="+serviceId+"&version="+si.getVersion().toString()+"&request=GetCapabilities";CapsInfoci=newCapsInfo(serviceId,si.getVersion(),capsLink);serviceInfoLinks.add(ci);
if(object!=null){workspace=newWorkspaceDetachableModel(object.getWorkspace());name=object.getName();
else{name=null;
if(workspace==null){returnnull;
if(name==null){returnnull;
if(h==null/*&&AdvancedDispatch.isSet(getApplicationContext())*/){//checkforaworkspacebeingspecifiedintherequestandstripitoffinti=urlPath.startsWith("/")?1:0;intj=urlPath.indexOf("/",i);
if(j>i){Stringfirst=urlPath.substring(i,j);Stringlast=urlPath.substring(j);WorkspaceInfows=catalog.getWorkspaceByName(first);
if((ws==null)&&LOGGER.isLoggable(Level.FINEST)){LOGGER.fine("Couldnotfindworkspace"+first+",tryingalayergrouplookup");
if(ws!=null){StringwsName=first;//checkforalayerbeingspecifiedaswellj=last.indexOf("/",1);
if(j!=-1){first=last.substring(1,j);NamespaceInfons=catalog.getNamespaceByPrefix(wsName);
if(ns!=null){finalbooleanlayerFound=catalog.getLayerByName(newNameImpl(ns.getURI(),first))!=null;
if(!layerFound&&LOGGER.isLoggable(Level.FINEST)){LOGGER.fine("Couldnotfindlayer"+first+",tryingalayergrouplookup");
if(layerFound){//found,stripofflayerandallowcalltofallthroughlast=last.substring(j);
else
if(catalog.getLayerGroupByName(ws,first)!=null){//found,stripofflayerandallowcalltofallthroughlast=last.substring(j);
else{LOGGER.fine("Couldnotalayergroupnamed"+wsName+":"+first);
else
if(catalog.getLayerGroupByName((WorkspaceInfo)null,first)!=null){h=super.lookupHandler(last,request);
else{LOGGER.fine("Couldnotalayergroupnamed"+first);
if(!resourceManager.hasAnyResource()||expirationDelay==0){return;
if(unparsed.size()<4){thrownewIllegalArgumentException("Requestedboundingboxcontainswrong"+"numberofcoordinates(shouldhave"+"4):"+unparsed.size());
if(unparsed.size()==6||unparsed.size()==7){//3d-coordinatescountco=6;
ifitdoes,storetheminanarrayofdoublesdouble[]bbox=newdouble[countco];for(inti=0;i<countco;i++){try{bbox[i]=Double.parseDouble((String)unparsed.get(i));
if(countco==6){minz=bbox[2];maxx=bbox[3];maxy=bbox[4];maxz=bbox[5];
else{maxx=bbox[2];maxy=bbox[3];
if(unparsed.size()>countco){//mergebacktheCRSdefinition,incaseitisanAUTOoneStringBuildersb=newStringBuilder();for(inti=countco;i<unparsed.size();i++){sb.append(unparsed.get(i));
if(i<(unparsed.size()-1)){sb.append(",");
if(minx>maxx){thrownewServiceException("illegalbbox,minX:"+minx+"is"+"greaterthanmaxX:"+maxx);
if(miny>maxy){thrownewServiceException("illegalbbox,minY:"+miny+"is"+"greaterthanmaxY:"+maxy);
if(minz>maxz){thrownewServiceException("illegalbbox,minZ:"+minz+"is"+"greaterthanmaxZ:"+maxz);
if(countco==6){CoordinateReferenceSystemcrs=srs!=null?CRS.decode(srs):null;returnnewReferencedEnvelope3D(minx,maxx,miny,maxy,minz,maxz,crs);
else{CoordinateReferenceSystemcrs=srs!=null?CRS.decode(srs):null;
if(crs==null||crs.getCoordinateSystem().getDimension()==2){returnnewSRSEnvelope(minx,maxx,miny,maxy,srs);
else
if(crs.getCoordinateSystem().getDimension()==3){returnnewReferencedEnvelope3D(minx,maxx,miny,maxy,-Double.MAX_VALUE,Double.MAX_VALUE,crs);
else{thrownewWFSException("UnexpectedBBOX,canonlyhandle2Dor3Dones","bbox","InvalidParameterValue");
if(ascending){returnresult;
else{returnresult*-1;
if(id1==null){
if(id2==null){return0;
else{return-1;
else
if(id2==null){return1;
else{returnid1.compareTo(id2);
if(get("loginform")!=null){get("loginform").setVisible(false);
if(parameters.get("error").toBoolean()){Exceptionexception=getAuthenticationException();
if(exceptioninstanceofConcurrentAuthenticationException){ConcurrentAuthenticationExceptioncae=(ConcurrentAuthenticationException)exception;error(newParamResourceModel("concurrentAuthenticationError",this,cae.getCount()).getString());
else{error(newParamResourceModel("error",this).getString());
if(request==null||!(request.getContainerRequest()instanceofHttpServletRequest)){returnnull;
if(session==null){returnnull;
if(exceptioninstanceofAuthenticationException){return(AuthenticationException)exception;
else{returnnull;
if("oseo".equalsIgnoreCase(request.getService())){
if(kvp.isEmpty()){
if("description".equals(request.getRequest())){kvp.put("service","oseo");//therawkvpisnormallynoteveninitializedrequest.setRawKvp(kvp);
else
if("search".equals(request.getRequest())){kvp.put("service","oseo");kvp.put("httpAccept",AtomSearchResponse.MIME);
iftherequesthasnosearchparams)request.setRawKvp(kvp);
else{//skipeverythingthathasanemptyvalue,inOpenSearchitshouldbeignored//(clientsfollowingthetemplatetotheletterwillcreatekeyswithemptyvalue)for(Stringkey:newHashSet<String>(request.getRawKvp().keySet())){Objectvalue=rawKvp.get(key);
if(!(valueinstanceofString)||StringUtils.isEmpty((String)value)){rawKvp.remove(key);kvp.remove(key);
if(INSTANCE==null){return;//notyetinitialized
if(INSTANCE==null){return;//notyetinitialized
if(exception==null){INSTANCE.post(command,retVal);
else{INSTANCE.error(command,exception);
if(context==null){returnnull;
if(repository==null){returnnull;
if(location==null){returnnull;
if("file".equals(location.getScheme())){try{Filef=newFile(location);
if(f.getName().equals(".geogig")){f=f.getParentFile();uri=f.toURI().toString();
if(refs.isEmpty()){sb.append("alreadyuptodate");
else{for(Iterator<Entry<String,Collection<RefDiff>>>it=refs.entrySet().iterator();it.hasNext();){Entry<String,Collection<RefDiff>>entry=it.next();StringremoteUrl=entry.getKey();Collection<RefDiff>changedRefs=entry.getValue();sb.append("From").append(remoteUrl).append(":[");print(changedRefs,sb);sb.append("]");
if(ref.getType()==CHANGED_REF){sb.append(oldRef.getName()).append("");sb.append(toString(oldRef.getObjectId()));sb.append("->");sb.append(toString(newRef.getObjectId()));
else
if(ref.getType()==ADDED_REF){Stringreftype=(newRef.getName().startsWith(Ref.TAGS_PREFIX))?"tag":"branch";sb.append("*[new").append(reftype).append("]").append(newRef.getName()).append("->").append(toString(newRef.getObjectId()));
else
if(ref.getType()==REMOVED_REF){sb.append("x[deleted]").append(oldRef.getName());
else{sb.append("[deepened]"+newRef.getName());
if(it.hasNext()){sb.append(",");
if(config.isJndi()){StringjndiName=config.getJndiName();try{ContextinitialContext=newInitialContext();datasource=(DataSource)initialContext.lookup(jndiName);
else{BasicDataSourcebds=newBasicDataSource();bds.setDriverClassName(config.getDriverClassName());bds.setUrl(config.getConnectURL());bds.setUsername(config.getUserName());bds.setPassword(config.getPassword());bds.setDefaultAutoCommit(false);bds.setDefaultTransactionIsolation(DEFAULT_ISOLATION_LEVEL);bds.setMaxActive(10);datasource=bds;
if(con.getAutoCommit())con.setAutoCommit(false);
if(con.getTransactionIsolation()!=DEFAULT_ISOLATION_LEVEL)con.setTransactionIsolation(DEFAULT_ISOLATION_LEVEL);returncon;
ifanyoftheparametresisnotnull,trytocloseitandthrowawaya*possible{@linkSQLException}**@paramcon*@paramps*@paramrs*/protectedvoidcloseFinally(Connectioncon,PreparedStatementps,ResultSetrs){try{
if(rs!=null)rs.close();
if(ps!=null)ps.close();
if(con!=null)closeConnection(con);
ifkeydoesnotexist*@throwsSQLException*/protectedPreparedStatementgetJDBCStatement(Stringkey,Propertiesprops,Connectioncon)throwsIOException,SQLException{StringstatementString=props.getProperty(key);
if(statementString==null||statementString.trim().length()==0)thrownewIOException("Nosqlstatementforkey:"+key);returncon.prepareStatement(statementString.trim());
if(booleanString==null)returnfalse;return"y".equalsIgnoreCase(booleanString);
if(this.canCreateStore()==false)return;
if(config.isCreatingTables()==false)return;
if(tablesAlreadyCreated())return;Connectioncon=null;PreparedStatementps=null;try{con=datasource.getConnection();
if(con.getAutoCommit()==true)con.setAutoCommit(false);con=getConnection();for(Stringstmt:getOrderedNamesForCreate()){ps=getDDLStatement(stmt,con);ps.execute();ps.close();
ifthetablesarealreadycreated**@paramcon*@throwsIOException*/publicbooleantablesAlreadyCreated()throwsIOException{ResultSetrs=null;Connectioncon=null;try{con=getConnection();DatabaseMetaDatamd=con.getMetaData();StringschemaName=null;StringtableName=ddlProps.getProperty("check.table");
if(tableName.contains(".")){StringTokenizertok=newStringTokenizer(tableName,".");schemaName=tok.nextToken();tableName=tok.nextToken();
if(rs.next())returntrue;//trywithuppercaselettersrs.close();schemaName=schemaName==null?null:schemaName.toUpperCase();tableName=tableName.toUpperCase();rs=md.getTables(null,schemaName,tableName,null);
if(rs.next())returntrue;//trywithlowercaselettersrs.close();schemaName=schemaName==null?null:schemaName.toLowerCase();tableName=tableName.toLowerCase();rs=md.getTables(null,schemaName,tableName,null);
if(rs.next())returntrue;returnfalse;
if(rs!=null)rs.close();
if(con!=null)closeConnection(con);
ifthesqlstatementscontainedinpropscanbepreparedagainstthedb**@paramprops*@returnreturnerrorprotocolcontainingkey,statementand{@linkSQLException}.Thekeyis*createdasfollows:*<p>propertykey+"|"+statementstring*@throwsIOException*/protectedMap<String,SQLException>checkSQLStatements(Propertiesprops)throwsIOException{Map<String,SQLException>reportMap=newHashMap<String,SQLException>();Connectioncon=null;try{con=getConnection();for(Objectkey:props.keySet()){Stringstmt=props.getProperty(key.toString()).trim();try{con.prepareStatement(stmt.trim());
ifthefileexistsdonothing.**<p>Ifthefiledoesnotexist,checkforatemplatefilecontainedinthejarwiththesame*name,
iffound,useit.**<p>Ifnotemplatewasfound,usethedefaulttemplate**@paramfileNametargetlocation*@paramnamedRootparentdir
iffileNameisrelative*@paramdefaultResourcethestandardtemplate*@throwsIOException*@returnthefiletouse*/protectedResourcecheckORCreateJDBCPropertyFile(StringfileName,ResourcenamedRoot,StringdefaultResource)throwsIOException{Resourceresource;fileName=fileName!=null?fileName:defaultResource;Filefile=newFile(fileName);
if(file.isAbsolute()){resource=Files.asResource(file);
else{resource=namedRoot.get(fileName);
if(Resources.exists(resource)){returnresource;//wearehappy
if(is!=null)IOUtils.copy(is,resource.out());
else//usethedefaulttemplateFileUtils.copyURLToFile(getClass().getResource(defaultResource),file);returnresource;}}
if(ranges==null||ranges.size()==0){return;
if(size>1){result=ff.or(timeFilters);
else{result=timeFilters.get(0);
if(filter==null){filter=result;
else{filter=ff.and(filter,result);
if(value==null){filter=Filter.INCLUDE;
else
if(valueinstanceofRange){Rangerange=(Range)value;
if(endAttribute==null){filter=ff.between(attribute,ff.literal(range.getMinValue()),ff.literal(range.getMaxValue()));
else{//Rangeintersectsvalidrangeoffeature//@todoaddinganotheroptiontodimensionInfoallowscontains,versusintersectsLiteralqlower=ff.literal(range.getMinValue());Literalqupper=ff.literal(range.getMaxValue());Filterlower=ff.lessOrEqual(attribute,qupper);Filterupper=ff.greaterOrEqual(endAttribute,qlower);returnff.and(lower,upper);
else{//Singleelementisequalto
if(endAttribute==null){filter=ff.equal(attribute,ff.literal(value),true);
else{//SingleelementiscontainedbyvalidrangeoffeatureFilterlower=ff.greaterOrEqual(ff.literal(value),attribute);Filterupper=ff.lessOrEqual(ff.literal(value),endAttribute);filter=ff.and(lower,upper);
if(filter==null){returnFilter.INCLUDE;
ifthefilealreadyexists.*@paramrequestTherequest.*@returnThefileobjectrepresentingthenewlywrittenfile.*@throwsIOExceptionAnyI/Oerrorsthatoccur.*<p>TODO:movethistoIOUtils.*/publicstaticorg.geoserver.platform.resource.ResourcehandleBinUpload(StringfileName,org.geoserver.platform.resource.Resourcedirectory,booleandeleteDirectoryContent,HttpServletRequestrequest)throwsIOException{returnhandleBinUpload(fileName,directory,deleteDirectoryContent,request,null);
ifthefilealreadyexists.*@paramrequestTherequest.*@returnThefileobjectrepresentingthenewlywrittenfile.*@throwsIOExceptionAnyI/Oerrorsthatoccur.*<p>TODO:movethistoIOUtils.*/publicstaticorg.geoserver.platform.resource.ResourcehandleBinUpload(StringfileName,org.geoserver.platform.resource.Resourcedirectory,booleandeleteDirectoryContent,HttpServletRequestrequest,StringworkSpace)throwsIOException{//CreationofaStringBuilderfortheselectedfileStringBuilderitemPath=newStringBuilder(fileName);//MediatypeassociatedtotheinputfileMediaTypemediaType=request.getContentType()==null?null:MediaType.valueOf(request.getContentType());//Onlyzipfilesarenotremapped
if(mediaType==null||!isZipMediaType(mediaType)){StringbaseName=FilenameUtils.getBaseName(fileName);StringitemName=FilenameUtils.getName(fileName);//StoreparametersusedformappingthefilepathMap<String,String>storeParams=newHashMap<>();//Mappingitempathremapping(workSpace,baseName,itemPath,itemName,storeParams);
if(Resources.exists(newFile)){
if(deleteDirectoryContent){for(Resourcefile:directory.list()){file.delete();
else{//deletethefile,otherwisereplacingitwithasmalleronewillleavebytesat//theendnewFile.delete();
if(mediaType==null||!isZipMediaType(mediaType)){StringbaseName=FilenameUtils.getBaseName(fileName);//StoreparametersusedformappingthefilepathMap<String,String>storeParams=newHashMap<>();StringitemName=FilenameUtils.getName(fileName);//Mappingitempathremapping(workSpace,baseName,itemPath,itemName,storeParams);
ifneededwefaillaterwhilecopyingorg.geoserver.platform.resource.ResourcenewFile=directory.get(itemPath.toString());//gettheURLforthisfiletouploadfinalInputStreaminStream=request.getInputStream();finalStringstringURL=IOUtils.getStringFromStream(inStream);finalURLfileURL=newURL(stringURL);////////Nowdotherealupload//////finalInputStreaminputStream=fileURL.openStream();finalOutputStreamoutStream=newFile.out();IOUtils.copyStream(inputStream,outStream,true,true);returnnewFile;
if(!inputFile.exists()){URLfileURL=newURL(stringURL);inputFile=IOUtils.URLToFile(fileURL);
if(inputFile==null||!inputFile.exists()){thrownewRestException("Failedtolocatetheinputfile"+stringURL,HttpStatus.BAD_REQUEST);
else
if(!inputFile.canRead()){thrownewRestException("Inputfileisnotreadable,checkfilesystempermissions:"+stringURL,HttpStatus.BAD_REQUEST);
ifthespecifiedrequestcontainsazipstream.*/publicstaticbooleanisZipMediaType(HttpServletRequestrequest){returnZIP_MIME_TYPES.contains(request.getContentType());
ifthespecifiedmediatyperepresentsazipstream.*/publicstaticbooleanisZipMediaType(MediaTypemediaType){returnZIP_MIME_TYPES.contains(mediaType.toString());
if(outputDirectory==null){outputDirectory=zipFile.parent();
ifitexistsandisavalidURL-encodedstring,ornull*otherwise*/publicstaticStringgetAttribute(HttpServletRequestrequest,Stringname){Objecto=request.getAttribute(name);returndecode(o);
if(value==null){returnnull;
ifpresent////////////////////////////////////////item=extractMapItem(loadMapfromStore(storeName,catalog),key);//////////////////////////////////////////CheckWorkSpaceinfo
ifnotfound//insidetheStoreInfo////////////////////////////////////////
if(item==null){item=extractMapItem(loadMapfromWorkSpace(workspaceName,catalog),key);
if(item==null){item=extractMapItem(loadMapFromGlobal(),key);
if(storeInfo==null){storeInfo=catalog.getStoreByName(storeName,DataStoreInfo.class);
if(storeInfo!=null){returnstoreInfo.getMetadata();
if(wsInfo!=null){GeoServergs=GeoServerExtensions.bean(GeoServer.class);SettingsInfoinfo=gs.getSettings(wsInfo);returninfo!=null?info.getMetadata():null;
if(gsInfo!=null){SettingsInfoinfo=gsInfo.getSettings();returninfo!=null?info.getMetadata():null;
if(map!=null&&!map.isEmpty()){Stringitem=map.get(key,String.class);
if(item!=null&&!item.isEmpty()){returnitem;
if(rootDir!=null){//Check
ifitalreadyexistsFilerootFile=newFile(rootDir);
if(rootFile.isAbsolute()){
if(!rootFile.exists()){
if(!rootFile.mkdirs()){rootFile.delete();returnnull;
else{
if(!rootFile.isDirectory()){LOGGER.info(rootDir+"ROOTpathisnotadirectory");returnnull;
if(!isStarted()){//waitforservicetobefullystartedbeforeprocessingevents.
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer(format("Ignoringmessage:%s.Serviceisnotstarted.",event));
if(localAddress(cluster.getHz()).equals(event.getSource())){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer(format("%s-Skippingmessagegeneratedlocally:%s",nodeId(),event));
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(format("%s-Receivedevent%s",nodeId(),event));
if(!isStarted()){return;
if(ws!=null){ev.setWorkspaceId(ws.getId());
if(store!=null){ev.setStoreId(store.getId());
if(subjinstanceofResourceInfo){ev.setNativeName(((ResourceInfo)subj).getNativeName());
if(propertyNames.size()==1&&propertyNames.contains("updateSequence")){return;
if(format==null){return"image/tiff";
else{CoverageResponseDelegatedelegate=responseFactory.encoderFor(format);
if(delegate==null){thrownewWCS20Exception("Unsupportedformat"+format,OWSExceptionCode.InvalidParameterValue,"format");
else{returnformat;
if(!(firstParaminstanceofGetCoverageType)){//weonlyhandleWCS2.0requestsreturnfalse;
if(format==null){format="image/tiff";
if(extension!=null){finalEList<ExtensionItemType>extensions=extension.getContents();for(ExtensionItemTypeext:extensions){encodingParameters.put(ext.getName(),ext.getSimpleContent());
if(coverageId!=null){encodingParameters.put(COVERAGE_ID_PARAM,coverageId);
if(format==null){format="image/tiff";
ifthereisamore*efficientwayofmovingtogivenindexthanre-readingtheinputusing{@link#doRead()}.**@paramitemIndexindexofitem(0based)tojumpto.*@throwsExceptionAllowssubclassestothrowcheckedexceptionsforinterpretationbythe*framework*/protectedvoidjumpToItem(intitemIndex)throwsException{for(inti=0;i<itemIndex;i++){read();
if(currentItemCount>=maxItemCount){returnnull;
if(iteminstanceofItemCountAware){((ItemCountAware)item).setItemCount(currentItemCount);
if(!isSaveState()){return;
if(executionContext.containsKey(getExecutionContextKey(READ_COUNT_MAX))){maxItemCount=executionContext.getInt(getExecutionContextKey(READ_COUNT_MAX));
if(executionContext.containsKey(getExecutionContextKey(READ_COUNT))){itemCount=executionContext.getInt(getExecutionContextKey(READ_COUNT));
else
if(currentItemCount>0){itemCount=currentItemCount;
if(itemCount>0&&itemCount<maxItemCount){try{jumpToItem(itemCount);
if(saveState){Assert.notNull(executionContext,"ExecutionContextmustnotbenull");executionContext.putInt(getExecutionContextKey(READ_COUNT),currentItemCount);
if(maxItemCount<Integer.MAX_VALUE){executionContext.putInt(getExecutionContextKey(READ_COUNT_MAX),maxItemCount);
if(rd.canHandle(item)){rd.readAdditionalResources(backupFacade,Files.asResource(resource.getFile()),item);
switchthistofalse
ifyoudon'twanttosaveanystatefromthisstream,andyoudon'tneed*ittoberestartable.Alwayssetittofalse
ifthereaderisbeingusedinaconcurrent*environment.**@paramsaveStateflagvalue(defaulttrue).*/publicvoidsetSaveState(booleansaveState){this.saveState=saveState;
iftheflagwasset*/publicbooleanisSaveState(){returnsaveState;}}
if(!(objectinstanceofFeature)){//cannothandlethis,makeit"transparent"returnColor.BLACK;
if(eventinstanceofContextLoadedEvent){this.jobOperator=(JobOperator)context.getBean("jobOperator");this.jobLauncher=(JobLauncher)context.getBean("jobLauncherAsync");this.jobRepository=(JobRepository)context.getBean("jobRepository");this.backupJob=(Job)context.getBean(BACKUP_JOB_NAME);this.restoreJob=(Job)context.getBean(RESTORE_JOB_NAME);
if(backupJob!=null){this.setTotalNumberOfBackupSteps(backupJob.getStepNames().size());
if(restoreJob!=null){this.setTotalNumberOfRestoreSteps(restoreJob.getStepNames().size());
ifarchiveFileexists
if(archiveFile.file().exists()){
if(!overwrite&&FileUtils.sizeOf(archiveFile.file())>0){//UnlesstheuserexplicitlywantstooverwritethearchiveFile,throwanexception//wheneveritalreadyexiststhrownewIOException("Thetargetarchivefilealreadyexists.Use'overwrite=TRUE'
ifyouwanttooverwriteit.");
else{FileUtils.forceDelete(archiveFile.file());
else{//Makesuretheparentpathexists
if(!archiveFile.file().getParentFile().exists()){try{archiveFile.file().getParentFile().mkdirs();
if(!archiveFile.file().getParentFile().exists()){thrownewIOException("Thepathtotargetarchivefileisunreachable.");
if(filter!=null){paramsBuilder.addString("filter",ECQL.toCQL(filter));
if(getRestoreRunningExecutions().isEmpty()&&getBackupRunningExecutions().isEmpty()){synchronized(jobOperator){//StartanewJobJobExecutionjobExecution=jobLauncher.run(backupJob,jobParameters);backupExecution=newBackupExecutionAdapter(jobExecution,totalNumberOfBackupSteps);backupExecutions.put(backupExecution.getId(),backupExecution);backupExecution.setArchiveFile(archiveFile);backupExecution.setOverwrite(overwrite);backupExecution.setFilter(filter);backupExecution.getOptions().add("OVERWRITE="+overwrite);for(EntryjobParam:jobParameters.toProperties().entrySet()){
if(!PARAM_OUTPUT_FILE_PATH.equals(jobParam.getKey())&&!PARAM_INPUT_FILE_PATH.equals(jobParam.getKey())&&!PARAM_TIME.equals(jobParam.getKey())){backupExecution.getOptions().add(jobParam.getKey()+"="+jobParam.getValue());
else{thrownewIOException("CouldnotstartanewBackupJobExecutionsincetherearecurrentlyRunningjobs.");
if(filter!=null){paramsBuilder.addString("filter",ECQL.toCQL(filter));
if(getRestoreRunningExecutions().isEmpty()&&getBackupRunningExecutions().isEmpty()){synchronized(jobOperator){//StartanewJobJobExecutionjobExecution=jobLauncher.run(restoreJob,jobParameters);restoreExecution=newRestoreExecutionAdapter(jobExecution,totalNumberOfRestoreSteps);restoreExecutions.put(restoreExecution.getId(),restoreExecution);restoreExecution.setArchiveFile(archiveFile);restoreExecution.setFilter(filter);for(EntryjobParam:jobParameters.toProperties().entrySet()){
if(!PARAM_OUTPUT_FILE_PATH.equals(jobParam.getKey())&&!PARAM_INPUT_FILE_PATH.equals(jobParam.getKey())&&!PARAM_TIME.equals(jobParam.getKey())){restoreExecution.getOptions().add(jobParam.getKey()+"="+jobParam.getValue());
else{thrownewIOException("CouldnotstartanewRestoreJobExecutionsincetherearecurrentlyRunningjobs.");
if(this.backupExecutions.get(executionId)!=null){jobExecution=this.backupExecutions.get(executionId).getDelegate();
else
if(this.restoreExecutions.get(executionId)!=null){jobExecution=this.restoreExecutions.get(executionId).getDelegate();
if(jobExecution!=null){finalBatchStatusstatus=jobExecution.getStatus();
if(!status.isGreaterThan(BatchStatus.STARTED)){jobExecution.setStatus(BatchStatus.STOPPING);jobExecution.setEndTime(newDate());jobRepository.update(jobExecution);
if(this.backupExecutions.get(executionId)!=null){jobExecution=this.backupExecutions.get(executionId).getDelegate();
else
if(this.restoreExecutions.get(executionId)!=null){jobExecution=this.restoreExecutions.get(executionId).getDelegate();
if(jobExecution!=null){jobExecution.setStatus(BatchStatus.ABANDONED);jobExecution.setEndTime(newDate());jobRepository.update(jobExecution);
if(params!=null){for(Entry<Object,Object>param:params.entrySet()){
if(param.getKey()instanceofHints.OptionKey){finalSet<String>key=((Hints.OptionKey)param.getKey()).getOptions();for(Stringk:key){
switch(k){casePARAM_PASSWORD_TOKENS:paramsBuilder.addString(k,(String)param.getValue());break;casePARAM_PARAMETERIZE_PASSWDS:casePARAM_SKIP_SETTINGS:casePARAM_CLEANUP_TEMP:casePARAM_DRY_RUN_MODE:casePARAM_BEST_EFFORT_MODE:
if(paramsBuilder.toJobParameters().getString(k)==null){paramsBuilder.addString(k,"true");
if(!citeConformance){//HACK:asperGEOS-1816,
ifstrictcitecomplianceisnotset,and//theuserspecifiedatypeNamewithnonamespaceprefix,wewant//ittobeinterpretedasbeingintheGeoServer's"default//namespace".Yet,thexmlparserdiditsjobandsinceTypeNameis//ofQNametype,nothavingansprefixmeansitgotparsedasa//QNameinthedefaultnamespace.Thatis,inthewfsnamespace.List<QName>hackedNames=newArrayList<QName>(names.size());finalNamespaceInfodefaultNameSpace=catalog.getDefaultNamespace();
if(defaultNameSpace==null){thrownewIllegalStateException("NodefaultnamespaceconfiguredinGeoServer");
if(XMLConstants.NULL_NS_URI.equals(nsUri)||org.geoserver.wfs.xml.v1_1_0.WFS.NAMESPACE.equals(nsUri)||org.geotools.wfs.v2_0.WFS.NAMESPACE.equals(nsUri)){//forthisoneweneedtoassignthedefaultgeoserver//namespacename=newQName(defaultNsUri,name.getLocalPart());
if(names.isEmpty()){//
iftherearenospecificrequestedtypesthengetalltheonesthat//areenabledfinalbooleanskipMisconfigured=ResourceErrorHandling.SKIP_MISCONFIGURED_LAYERS.equals(getWFS().getGeoServer().getGlobal().getResourceErrorHandling());for(FeatureTypeInfoftInfo:newArrayList<FeatureTypeInfo>(catalog.getFeatureTypes())){
if(ftInfo.enabled()){try{ftInfo.getFeatureType();//checkthatwecangetaconnectiontothisftyperequested.add(ftInfo);
if(skipMisconfigured){LOGGER.log(Level.WARNING,"SkippingDescribeFeaturefor"+ftInfo.getPrefixedName()+"becausewecouldn'tconnect",ioe);
else{thrownewWFSException(ioe);
else{for(QNamename:names){StringnamespaceURI=name.getNamespaceURI();StringtypeName=name.getLocalPart();FeatureTypeInfotypeInfo;
if(citeConformance&&XMLConstants.NULL_NS_URI.equals(namespaceURI)){//underciteconformance,thetypeNameshallbecompletelyresolved.Ifthere's//nonamespaceURIandweaskthecatalogwithonlythelocalName,thecatalog//willtrytomatchagainstthedefaultnamespacetypeInfo=null;
else{typeInfo=catalog.getFeatureTypeByName(namespaceURI,typeName);
if(typeInfo!=null&&typeInfo.enabled()){requested.add(typeInfo);
else{//notfoundStringmsg="Couldnotfindtype:"+name;
if(citeConformance){msg+=".\nStrictWFSprotocolconformanceisbeingapplied.\n"+"Makesurethetypenameiscorrectlyqualified";
if(links==null){//Noneedtoupdatethefeaturereturn;
if(links!=null){try{links.close();
if(REFERENCES.equalsIgnoreCase(prop.getName().getLocalPart())){insertReferences=true;
else
if(insertReferences){//linkStringshouldcontainthelastlinkgenerated//let'srecycleittogeneratethefulldownloadlinknewReferencesList.add(createReferencesElement(downloadLinkHandler.extractFullDownloadLink(link)));//appendnewreferencestothecurrentcollection//beforegoingtootherelementspropertyList.addAll(newReferencesList);insertReferences=false;
if(!config.isEncrypting()){returntoBytes(passwd);
if(!config.isEncrypting()){returnpasswd;
if("file".equalsIgnoreCase(url.getProtocol())){Filef=URLs.urlToFile(url);
if(!f.isAbsolute()){//makerelativetoconfigdirreturnconfigDir.get(f.getPath()).out();
else{returnnewFileOutputStream(f);
else{URLConnectioncx=url.openConnection();cx.setDoOutput(true);returncx.getOutputStream();
if("file".equalsIgnoreCase(url.getProtocol())){Filef=URLs.urlToFile(url);//check
ifthefileisrelative
if(!f.isAbsolute()){//makeitrelativetotheconfigdirectoryforthispasswordproviderResourceres=configDir.get(f.getPath());
if(res.getType()!=Type.RESOURCE){//filemustalreadyexist.thrownewFileNotFoundException();
else{returnnewFileInputStream(f);
else{returnurl.openStream();
if(url==null){thrownewURLMasterPasswordProviderException(URL_REQUIRED);
if(config.isReadOnly()){//read-only,assurewecanreadfromurltry{InputStreamin=input(url,manager.masterPasswordProvider().get(config.getName()));try{in.read();
if(hash.equalsIgnoreCase(hashedName)){result.add(mainFile);List<File>supportFile=fileGroup.getSupportFiles();
if(supportFile!=null&&!supportFile.isEmpty()){result.addAll(supportFile);
if(supportFile!=null&&!supportFile.isEmpty()){result.addAll(supportFile);
if(info==null){thrownewServiceException("Noobjectavailableforthespecifiedname:"+coverageName);
if(fileId==null&&readerinstanceofStructuredGridCoverage2DReader){//AddtheserviceInfocontenttothereturnedfiles//(Asaninstance,shapefileindex,indexers,propertyfiles...)getExtraFiles(reader,result);
if(result==null||result.isEmpty()){thrownewServiceException("UnabletogetanydataforresourceId="+resourceId+"andfile="+fileId);
if(infoinstanceofFileServiceInfo){FileServiceInfofileInfo=(FileServiceInfo)info;FileGroupProviderprovider=(FileGroupProvider)fileInfo;FilesCollectorcollector=newFilesCollector(provider);collector.collectFull(result);
else{thrownewServiceException("UnabletogetfilesfromthespecifiedServiceInfowhich"+"doesn'timplementFileServiceInfo");
if(resourceInfoinstanceofFileResourceInfo){FileResourceInfofileResourceInfo=(FileResourceInfo)resourceInfo;//GettheresourcefilesFileGroupProviderfileGroupProvider=(FileGroupProvider)fileResourceInfo;FilesCollectorcollector=newFilesCollector(fileGroupProvider);//OnlystructuredReaderscansupportmultiplecoverages//Standardreadersdealwithonecoverage
if(readerinstanceofStructuredGridCoverage2DReader&&fileId!=null){collector.collectSubset(fileId,result);
else{//Simplereadercase.collector.collectFull(result);
else{thrownewServiceException("UnabletogetfilesfromthespecifiedResourceInfowhich"+"doesn'timplementFileResourceInfo");
if(fileList!=null&&!fileList.isEmpty()&&sizeLimit>0){longcumulativeSize=0;for(Filefile:fileList){cumulativeSize+=file.length();
if(cumulativeSize>sizeLimit){thrownewCSWException(LIMIT_MESSAGE+"Thelimitis"+formatBytes(sizeLimit)+"buttheamountofrawdatatobedownloadedis"+formatBytes(cumulativeSize));
if(bytes<KILO){returnbytes+"B";
else
if(bytes<MEGA){returnnewDecimalFormat("#.##").format(bytes/1024.0)+"KB";
else
if(bytes<GIGA){returnnewDecimalFormat("#.##").format(bytes/1048576.0)+"MB";
else{returnnewDecimalFormat("#.##").format(bytes/1073741824.0)+"GB";
if(files!=null){try{//Makesuretoclosetheiteratorfiles.close();
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Exceptionoccurredwhileclosingthefileiterator:\n"+t.getLocalizedMessage());
if(coverageInfo!=null){name=coverageInfo.getNativeCoverageName();
if(name==null){name=coverageInfo.getName();
if(name==null){name=coverageInfo.getNativeName();
if("".equals(string.trim())){filters.add(Filter.INCLUDE);
else{Filterfilter;finalbyte[]rawContent=string.getBytes();InputStreaminput=newByteArrayInputStream(rawContent);try{//createtheparserConfigurationconfiguration=newOGCConfiguration();Parserparser_1_0_0=newParser(configuration);parser_1_0_0.setEntityResolver(resolverProvider.getEntityResolver());filter=(Filter)parser_1_0_0.parse(input);
if(filter==null){thrownewNullPointerException();
ifloadismade//asynchornot//reloadingshouldhavebeentriggeredticker.setMillisec(700);System.out.println("sleeping...");Thread.sleep(500);System.out.println(cachedRuleReader.getStats());assertEquals(hitExp,cachedRuleReader.getStats().hitCount());assertEquals(missExp,cachedRuleReader.getStats().missCount());assertEquals(evictExp,cachedRuleReader.getStats().evictionCount());//assertEquals(2,cachedRuleReader.getStats().loadSuccessCount());//uhm,thisdoesnot//work
if(2!=cachedRuleReader.getStats().loadSuccessCount())LOGGER.log(Level.SEVERE,"***BadsuccessCountcheck,expected2,found{0}",cachedRuleReader.getStats().loadSuccessCount());ticker.setMillisec(800);cachedRuleReader.getAccessInfo(filter1);System.out.println(cachedRuleReader.getStats());ticker.setMillisec(2000);cachedRuleReader.getAccessInfo(filter1);System.out.println(cachedRuleReader.getStats());
if(PreAuthenticatedUserNameRoleSource.Header.equals(getRoleSource())){StringconverterName=authConfig.getRoleConverterName();
if(converterName==null||converterName.length()==0)setConverter(GeoServerExtensions.bean(GeoServerRoleConverter.class));
elsesetConverter((GeoServerRoleConverter)GeoServerExtensions.bean(converterName));
if(request.getAttribute(UserNameAlreadyRetrieved)!=null)return(String)request.getAttribute(UserName);Stringprincipal=getPreAuthenticatedPrincipalName(request);
if(principal!=null&&principal.trim().length()==0)principal=null;try{
if(principal!=null&&PreAuthenticatedUserNameRoleSource.UserGroupService.equals(getRoleSource())){GeoServerUserGroupServiceservice=getSecurityManager().loadUserGroupService(getUserGroupServiceName());GeoServerUseru=service.getUserByUsername(principal);
if(u!=null&&u.isEnabled()==false){principal=null;handleDisabledUser(u,request);
if(principal!=null)request.setAttribute(UserName,principal);returnprincipal;
if(PreAuthenticatedUserNameRoleSource.RoleService.equals(getRoleSource()))returngetRolesFromRoleService(request,principal);
if(PreAuthenticatedUserNameRoleSource.UserGroupService.equals(getRoleSource()))returngetRolesFromUserGroupService(request,principal);
if(PreAuthenticatedUserNameRoleSource.Header.equals(getRoleSource()))returngetRolesFromHttpAttribute(request,principal);thrownewRuntimeException("Nevershouldreachthispoint");
iftheprincipalisnotfound,an*emptycollectionisreturned**@paramrequest*@paramprincipal*@throwsIOException*/protectedCollection<GeoServerRole>getRolesFromUserGroupService(HttpServletRequestrequest,Stringprincipal)throwsIOException{Collection<GeoServerRole>roles=newArrayList<GeoServerRole>();GeoServerUserGroupServiceservice=getSecurityManager().loadUserGroupService(getUserGroupServiceName());UserDetailsdetails=null;try{details=service.loadUserByUsername(principal);
if(details!=null){for(GrantedAuthorityauth:details.getAuthorities())roles.add((GeoServerRole)auth);
ifnorolestringis*found,anemptycollectionisreturned**<p>Theresultcontainspersonalizedroles**@paramrequest*@paramprincipal*@throwsIOException*/protectedCollection<GeoServerRole>getRolesFromHttpAttribute(HttpServletRequestrequest,Stringprincipal)throwsIOException{Collection<GeoServerRole>roles=newArrayList<GeoServerRole>();StringrolesString=request.getHeader(getRolesHeaderAttribute());
if(rolesString==null||rolesString.trim().length()==0){LOGGER.log(Level.WARNING,"Norolesinheaderattribute:"+getRolesHeaderAttribute());returnroles;
ifeverythingisintheheader
if(PreAuthenticatedUserNameRoleSource.Header.equals(getRoleSource()))returnnull;returnsuper.getCacheKey(request);
if(getCoverage.getIdentifier()==null)thrownewWcsException("identifierparameterismandatory",MissingParameterValue,"identifier");//buildthedomainsubsetgetCoverage.setDomainSubset(parseDomainSubset(kvp));//buildoutputelementgetCoverage.setOutput(parseOutputElement(kvp));returngetCoverage;
if(timeSequence==null&&bbox==null)thrownewWcsException("Boundingboxcannotbenull,TimeSequencehasnotbeenspecified",WcsExceptionCode.MissingParameterValue,"BoundingBox");domainSubset.setBoundingBox(bbox);domainSubset.setTemporalSubset(timeSequence);returndomainSubset;
if(store!=null)output.setStore(store.booleanValue());//checkandsetformatStringformat=(String)kvp.get("format");
if(format==null)thrownewWcsException("formatparameterismandatory",MissingParameterValue,"format");output.setFormat(format);//settheothergridcrspropertiesfinalGridCrsTypegridCRS=output.getGridCRS();gridCRS.setGridBaseCRS((String)kvp.get("gridBaseCrs"));StringgridType=(String)kvp.get("gridType");
if(gridType==null){gridType=gridCRS.getGridType();
if(gridCS==null){gridCS=gridCRS.getGridCS();
iftheObjectisnotencodeable.*/publicvoidencode(Objecto)throwsIllegalArgumentException{
if(!(oinstanceofGetCapabilitiesType)){thrownewIllegalArgumentException(newStringBuffer("NotaGetCapabilitiesType:").append(o).toString());
if(request.getUpdateSequence()!=null){try{requestedUpdateSequence=Long.parseLong(request.getUpdateSequence());
if(request.getUpdateSequence().length()==0)requestedUpdateSequence=0;
elsethrownewWcsException("Invalidupdatesequencenumberformat,"+"shouldbeaninteger",WcsExceptionCode.InvalidUpdateSequence,"updateSequence");
if(requestedUpdateSequence>updateSequence){thrownewWcsException("Invalidupdatesequencevalue,it'shigher"+"thanthecurrentvalue,"+updateSequence,WcsExceptionCode.InvalidUpdateSequence,"updateSequence");
if(requestedUpdateSequence==updateSequence){thrownewWcsException("WCScapabilitiesdocumentiscurrent(updateSequence="+updateSequence+")",WcsExceptionCode.CurrentUpdateSequence,"");
if(request.getSection()==null){allSections=true;section=CapabilitiesSectionType.get("/");
else{section=request.getSection();allSections=(section.get("/").equals(section));
if(!knownSections.contains(section.getLiteral()))thrownewWcsException("Unknownsection"+section,WcsExceptionCode.InvalidParameterValue,"Sections");//encodetheactualcapabilitiescontentstakingintoconsideration//thesections
if(requestedUpdateSequence<updateSequence){
if(allSections||section.equals(CapabilitiesSectionType.WCS_CAPABILITIES_SERVICE_LITERAL)){handleService(allSections);
if(allSections||section.equals(CapabilitiesSectionType.WCS_CAPABILITIES_CAPABILITY_LITERAL))handleCapabilities(allSections);
if(allSections||section.equals(CapabilitiesSectionType.WCS_CAPABILITIES_CONTENT_METADATA_LITERAL))handleContentMetadata(allSections);
if(!allSections){attributes.addAttribute("","version","version","",CUR_VERSION);
if(wcs.getMetadataLink()!=null){handleMetadataLink(wcs.getMetadataLink(),"simple");
if((fees==null)||"".equals(fees)){fees="NONE";
if((accessConstraints==null)||"".equals(accessConstraints)){accessConstraints="NONE";
if((mdl.getAbout()!=null)&&(mdl.getAbout()!="")){attributes.addAttribute("","about","about","",mdl.getAbout());
if((linkType!=null)&&(linkType!="")){attributes.addAttribute("","xlink:type","xlink:type","",linkType);
if((mdl.getMetadataType()!=null)&&(mdl.getMetadataType()!="")){attributes.addAttribute("","metadataType","metadataType","",mdl.getMetadataType());
if((mdl.getContent()!=null)&&(mdl.getContent()!="")){attributes.addAttribute("","xlink:href","xlink:href","",ResponseUtils.proxifyMetadataLink(mdl,request.getBaseUrl()));
if(attributes.getLength()>0){element("wcs:metadataLink",null,attributes);
if(kwords==null||kwords.isEmpty()){return;
if(kwords!=null){for(Iteratorit=kwords.iterator();it.hasNext();){element("wcs:keyword",it.next().toString());
if(((contact!=null)&&(contact.getContactPerson()!=""))||((contact.getContactOrganization()!=null)&&(contact.getContactOrganization()!=""))){start("wcs:responsibleParty");tmp=contact.getContactPerson();
if((tmp!=null)&&(tmp!="")){element("wcs:individualName",tmp);
else{//notoptionalelement("wcs:individualName","");
if((tmp!=null)&&(tmp!="")){element("wcs:organisationName",tmp);
if((tmp!=null)&&(tmp!="")){element("wcs:positionName",tmp);
if((tmp!=null)&&(tmp!="")){element("wcs:voice",tmp);
if((tmp!=null)&&(tmp!="")){element("wcs:facsimile",tmp);
if((tmp!=null)&&(tmp!="")){Stringaddr="";addr=contact.getAddress();
if((addr!=null)&&(addr!="")){element("wcs:deliveryPoint",tmp+""+addr);
else{tmp=contact.getAddress();
if((tmp!=null)&&(tmp!="")){element("wcs:deliveryPoint",tmp);
if((tmp!=null)&&(tmp!="")){element("wcs:city",tmp);
if((tmp!=null)&&(tmp!="")){element("wcs:administrativeArea",tmp);
if((tmp!=null)&&(tmp!="")){element("wcs:postalCode",tmp);
if((tmp!=null)&&(tmp!="")){element("wcs:country",tmp);
if((tmp!=null)&&(tmp!="")){element("wcs:electronicMailAddress",tmp);
if((tmp!=null)&&(tmp!="")){AttributesImplattributes=newAttributesImpl();attributes.addAttribute("","xlink:href","xlink:href","",tmp);start("wcs:onlineResource",attributes);end("wcs:onlineResource");
ifitendsby*?,&ornothing**@paramurl*@return*/privateStringmakeURLAppendable(Stringurl){
if(url.endsWith("?")||url.endsWith("&")){returnurl;
else
if(url.contains("?")){returnurl+"&";
else{returnurl+"?";
if(exceptionFormats==null||exceptionFormats.isEmpty()){exceptionFormats.add("application/vnd.ogc.se_xml");
if(timeInfo!=null&&timeInfo.isEnabled()){SimpleDateFormattimeFormat=dimensions.getTimeFormat();element("gml:timePosition",timeFormat.format(dimensions.getMinTime()));element("gml:timePosition",timeFormat.format(dimensions.getMaxTime()));
if(o1.equals(o2))return0;return(Double.parseDouble(o1)>Double.parseDouble(o2)?1:-1);
if(o1.equals(o2))return0;Dated1=getDate(o1);Dated2=getDate(o2);
if(d1==null||d2==null)return0;return(d1.getTime()>d2.getTime()?1:-1);
if(value.equalsIgnoreCase("current"))returnnull;for(inti=0;i<PATTERNS.length;i++){//rebuildformatsateachparse,dateformatsarenotthreadsafeSimpleDateFormatformat=newSimpleDateFormat(PATTERNS[i],Locale.CANADA);/*WedonotusethestandardmethodDateFormat.parse(String),because
iftheparsing*stopsbeforetheendofthestring,theremainingcharactersarejustignoredand*noexceptionisthrown.Sowehavetoensurethatthewholestringiscorrectfor*theformat.*/ParsePositionpos=newParsePosition(0);Datetime=format.parse(value,pos);
if(pos.getIndex()==value.length()){returntime;
if(!allSections){attributes.addAttribute("","version","version","",CUR_VERSION);
if(skipMisconfigured){reset();LOGGER.log(Level.SEVERE,"Skippingcoverage:"+cvInfo.getPrefixedName()+"asitscapabilitiesgenerationfailed",e);
else{thrownewRuntimeException("Capabilitiesdocumentgenerationfailedoncoverage"+cvInfo.getPrefixedName(),e);
if(cv.isEnabled()){start("wcs:CoverageOfferingBrief");Stringtmp;for(MetadataLinkInfomdl:cv.getMetadataLinks())handleMetadataLink(mdl,"simple");tmp=cv.getDescription();
if((tmp!=null)&&(tmp!="")){element("wcs:description",tmp);
if((tmp!=null)&&(tmp!="")){element("wcs:name",tmp);
if((tmp!=null)&&(tmp!="")){element("wcs:label",tmp);
if(csinfo==null){thrownewWcsException("Unabletoacquirecoveragestoreresourceforcoverage:"+cv.getName());
if(reader==null)thrownewWcsException("Unabletoacquireareaderforthiscoveragewithformat:"+csinfo.getFormat().getName());DimensionInfotimeInfo=cv.getMetadata().get(ResourceInfo.TIME,DimensionInfo.class);ReaderDimensionsAccessordimensions=newReaderDimensionsAccessor(reader);handleEnvelope(cv.getLatLonBoundingBox(),timeInfo,dimensions);handleKeywords(cv.getKeywords());end("wcs:CoverageOfferingBrief");
ifandonly
ifthecontentisnotnullandnotempty**@paramelementName*@paramcontent*/privatevoidelementIfNotEmpty(StringelementName,Stringcontent){
if(content!=null&&!"".equals(content.trim()))element(elementName,content);
iftheexceptionisnotforaparticularservice.*/publicOWS11ServiceExceptionHandler(){super(Collections.EMPTY_LIST);
iftheexceptionisforaparticularservice.**@paramservicesListofservicesthishandlerhandlesexceptionsfor.*/publicOWS11ServiceExceptionHandler(Listservices){super(services);
iftheexceptionisforaparticularservice.**@paramserviceServicesthishandlerhandlesexceptionsfor*/publicOWS11ServiceExceptionHandler(Serviceservice){super(Arrays.asList(service));
if(useServiceVersion&&request.getServiceDescriptor()!=null){version=request.getServiceDescriptor().getVersion().toString();
if(!request.isSOAP()){//therewillalreadybeaSOAPmimetyperesponse.setContentType("application/xml");
if(insertinstanceofWFS11){return(InsertElementType)insert.getAdaptee();
if(pinstanceofComplexAttribute){Stringprefix=MetaDataDescriptor.NAMESPACES.getPrefix(p.getName().getNamespaceURI());AttributesImplatts=newAttributesImpl();for(Propertyp2:((ComplexAttribute)p).getProperties()){
if(p2.getName().getLocalPart().substring(0,1).equals("@")){Stringname=p2.getName().getLocalPart().substring(1);atts.addAttribute("",name,name,"",p2.getValue().toString());
if(!p2.getName().getLocalPart().substring(0,1).equals("@")){encodeProperty(f,p2);
else
if(MetaDataDescriptor.RECORD_BBOX_NAME.equals(p.getName())){//grabtheoriginalboundingboxesfromtheuserdata(thegeometryisan//aggregate)List<ReferencedEnvelope>originalBoxes=(List<ReferencedEnvelope>)p.getUserData().get(GenericRecordBuilder.ORIGINAL_BBOXES);for(ReferencedEnvelopere:originalBoxes){try{ReferencedEnvelopewgs84re=re.transform(CRS.decode(AbstractRecordDescriptor.DEFAULT_CRS_NAME),true);Stringminx=String.valueOf(wgs84re.getMinX());Stringminy=String.valueOf(wgs84re.getMinY());Stringmaxx=String.valueOf(wgs84re.getMaxX());Stringmaxy=String.valueOf(wgs84re.getMaxY());AttributesImplattributes=newAttributesImpl();addAttribute(attributes,"crs",AbstractRecordDescriptor.DEFAULT_CRS_NAME);start("gmd:EX_GeographicBoundingBox",attributes);element("gmd:westBoundLongitude",minx);element("gmd:southBoundLatitude",miny);element("gmd:eastBoundLongitude",maxx);element("gmd:northBoundLatitude",maxy);end("gmd:EX_GeographicBoundingBox");
else{encodeSimpleLiteral(p);
if(r.equals(orig)){r.setRoot(rule.getRoot());r.setGlobalGroupRule(rule.isGlobalGroupRule());r.setLayer(rule.getLayer());r.setAccessMode(rule.getAccessMode());r.getRoles().clear();r.getRoles().addAll(rule.getRoles());
if(result==null){thrownewIllegalArgumentException("Badrangedefinition'"+sRange+"'");
if(value==null||value.isEmpty())returnnull;try{returnFloat.parseFloat(value);
if(value==null){returnnull;
else{String[]strings=StringUtils.split(value,"\r\n");List<Float>floats=newArrayList<Float>(strings.length);for(Strings:strings){floats.add((Float)FLOAT.convertToObject(s,locale));
if(i.hasNext()){sb.append(FLOAT.convertToString(i.next(),locale));
if(List.class.isAssignableFrom(type)){return(IConverter<S>)CONVERT;
if(Float.class.isAssignableFrom(type)){return(IConverter<S>)FLOAT;
if("file".equalsIgnoreCase(destination.getProtocol())){Filefile=URLs.urlToFile(destination);
if(maxSize>0&&maxSize<file.length()){thrownewWPSException("Input"+getInputId()+"size"+file.length()+"exceedsmaximumallowedsizeof"+maxSize,"NoApplicableCode",getInputId());
else
if("http".equalsIgnoreCase(destination.getProtocol())){//setuptheclientHttpClientclient=newHttpClient();HttpConnectionManagerParamsparams=newHttpConnectionManagerParams();params.setSoTimeout(timeout);params.setConnectionTimeout(timeout);//TODO:makethehttpclientawellbehavedhttpclient,nomorethanxconnections//perserver(xadminconfigurablemaybe),persistentconnectionsandsoonHttpConnectionManagermanager=newSimpleHttpConnectionManager();manager.setParams(params);client.setHttpConnectionManager(manager);//prepareeitheraGEToraPOSTrequest
if(ref.getMethod()==null||ref.getMethod()==MethodType.GET_LITERAL){GetMethodget=newGetMethod(ref.getHref());get.setFollowRedirects(true);method=get;
else{Stringencoding=ref.getEncoding();
if(encoding==null){encoding="UTF-8";
if(body==null){
if(ref.getBodyReference()!=null){URLrefDestination=newURL(ref.getBodyReference().getHref());
if("http".equalsIgnoreCase(refDestination.getProtocol())){//openwithcommonshttpclientrefMethod=newGetMethod(ref.getBodyReference().getHref());refMethod.setFollowRedirects(true);client.executeMethod(refMethod);refInput=refMethod.getResponseBodyAsStream();
else{//openwiththebuilt-inurlmanagementURLConnectionconn=refDestination.openConnection();conn.setConnectTimeout(timeout);conn.setReadTimeout(timeout);refInput=conn.getInputStream();
else{thrownewWPSException("APOSTrequestshouldcontainanonemptybody");
else
if(bodyinstanceofString){post.setRequestEntity(newStringRequestEntity((String)body,complexPPIO.getMimeType(),encoding));
else{thrownewWPSException("TherequestbodyshouldbecontainedinaCDATAsection,"+"otherwiseitwillgetparsedasXMLinsteadofbeingpreservedasis");
if(ref.getHeader()!=null){for(Iteratorit=ref.getHeader().iterator();it.hasNext();){HeaderTypeheader=(HeaderType)it.next();method.setRequestHeader(header.getKey(),header.getValue());
if(code==200){try{Headerlength=method.getResponseHeader(HttpHeaders.CONTENT_LENGTH);
if(maxSize>0&&length!=null&&Long.parseLong(length.getValue())>maxSize){thrownewWPSException("Input"+getInputId()+"size"+length.getValue()+"exceedsmaximumallowedsizeof"+maxSize+"accordingtoHTTPContent-Lenghtresponseheader","NoApplicableCode",getInputId());
if(maxSize>0){input=newMaxSizeInputStream(input,getInputId(),maxSize);
else{thrownewWPSException("Errorgettingremoteresourcesfrom"+ref.getHref()+",httperror"+code+":"+method.getStatusText());
else{//usethenormalurlconnectionmethodsthen...URLConnectionconn=destination.openConnection();conn.setConnectTimeout(timeout);conn.setReadTimeout(timeout);input=conn.getInputStream();
if(maxSize>0){input=newMaxSizeInputStream(input,getInputId(),maxSize);
if(input!=null){CancellingInputStreamis=newCancellingInputStream(input,listener);returncomplexPPIO.decode(is);
else{thrownewWPSException("Couldnotfindameantoreadinput"+inputId);
if(refInput!=null){refInput.close();
if(input!=null){input.close();
if(method!=null){method.releaseConnection();
if(refMethod!=null){refMethod.releaseConnection();
ifthefinallistexceedsmaxElevations**@parammaxElevationsMaximumnumberofelevationstoparse,oranonpositivenumbertohave*nolimit*/publicElevationParser(intmaxElevations){this.maxElevations=maxElevations;
ifthestringcannotbeparsed.*/@SuppressWarnings({"unchecked","rawtypes"})publicCollectionparse(Stringvalue)throwsParseException{
if(value==null){returnCollections.emptyList();
if(value.length()==0){returnCollections.emptyList();
if(o1Double){finalDoubleleft=(Double)o1;
if(o2Double){//o2datereturnleft.compareTo((Double)o2);
if(o2Double){//o2datereturnleft.getMinValue().compareTo(((Double)o2));
if(d.indexOf("/")<=0){addValue(values,Double.valueOf(d.trim()));
else{//periodString[]period=d.split("/");//Onlyonevaluegiven.
if(period.length==2){//PeriodcontinuousfinalDoublebegin=Double.valueOf(period[0]);finalDoubleend=Double.valueOf(period[1]);addPeriod(values,NumberRange.create(begin,end));
else
if(period.length==3){//PerioddiscretefinalDoublebegin=Double.valueOf(period[0]);finalDoubleend=Double.valueOf(period[1]);finalDoubleincrement=Double.valueOf(period[2]);Doublestep;intj=0;while((step=j*increment+begin)<=end){addValue(values,step);j++;checkMaxElevations(values,maxValues);
else{thrownewParseException("Invalidelevationparameter:"+period,0);
if(maxElevations!=null){returnmaxElevations;
else{returnDEFAULT_MAX_ELEMENTS_ELEVATIONS_KVP;
if(maxValues>0&&result.size()>maxValues){thrownewServiceException("Morethan"+maxValues+"elevationsspecifiedintherequest,bailingout.",ServiceException.INVALID_PARAMETER_VALUE,"elevation");
if(elementinstanceofDouble){//convertfinalDoublelocal=(Double)element;
if(local.equals(step))return;
else{//convertfinalDateRangelocal=(DateRange)element;
if(local.contains(step))return;
if(elementinstanceofDouble){//convert
if(newRange.contains((Number)element)){it.remove();
else{//convertfinalNumberRange<Double>local=(NumberRange<Double>)element;
if(local.contains(newRange))return;
if(newRange.contains(local))it.remove();
if(!RENDERING_FEATUREINFO_ENABLED){LOGGER.info("RenderingbasedGetFeatureInfodisabledsince"+FEATURE_INFO_RENDERING_ENABLED_KEY+"issetto"+value);
if(!RENDERING_FEATUREINFO_ENABLED){returnfalse;
if(!(params.getLayer().getFeatureSource(true).getSchema()instanceofSimpleFeatureType)){returnfallback.identify(params,maxFeatures);
if(rules.size()==0){returnnull;
if(radius<buffer){radius=buffer;
if(hitAreaSize>paintAreaSize){hitAreaSize=paintAreaSize;
if(wms.getMaxBuffer()<=0){returnuserBuffer;
else{returnMath.min(userBuffer,wms.getMaxBuffer());
if(requestedDpi!=null){rendererParams.put(StreamingRenderer.DPI_KEY,requestedDpi);
ifnecessarydoublestandardDpi=RendererUtilities.getDpi(rendererParams);
if(requestedDpi!=null&&standardDpi!=requestedDpi){doublescaleFactor=requestedDpi/standardDpi;DpiRescaleStyleVisitordpiVisitor=newGraphicsAwareDpiRescaleStyleVisitor(scaleFactor);for(inti=0;i<rules.size();i++){rules.get(i).accept(dpiVisitor);Rulerescaled=(Rule)dpiVisitor.getCopy();rules.set(i,rescaled);
if(list==null){list=newArrayList<Feature>();map.put(type,list);
if(typeinstanceofSimpleFeatureType){result.add(newListFeatureCollection((SimpleFeatureType)type,newArrayList<SimpleFeature>((List)list)));
else{result.add(newListComplexFeatureCollection(type,list));
ifweneedtoreproject
if(!wms.isFeaturesReprojectionDisabled()){//trytoreprojecttotargetCRSreturnLayerIdentifierUtils.reproject(result,targetcrs);
if(layerFilter==null){filter=dimensionFilter;
else
if(dimensionFilter==null){filter=layerFilter;
else{filter=FF.and(Arrays.asList(layerFilter,dimensionFilter));
if(viewParams!=null){definitionQuery.setHints(newHints(Hints.VIRTUAL_TABLE_PARAMETERS,viewParams));
if(startIndex!=null){QueryCapabilitiesqueryCapabilities=featureSource.getQueryCapabilities();
if(queryCapabilities.isOffsetSupported()){//fsourceisrequiredtosupport//SortBy.NATURAL_ORDERsowedon'tbothercheckingdefinitionQuery.setStartIndex(startIndex);
else{//source=newPagingFeatureSource(source,//request.getStartIndex(),limit);thrownewServiceException("startIndexisnotsupportedforthe"+layer.getName()+"layer");
if(requestBuffer>0){returnrequestBuffer;
if(layerInfo!=null){//itisalocallayerlayerBuffer=layerInfo.getMetadata().get(LayerInfo.BUFFER,Integer.class);
if(layerBuffer!=null&&layerBuffer>0){returnlayerBuffer;
if(estimator.isEstimateAccurate()){
if(estimatedRadius<MIN_BUFFER_SIZE){returnMIN_BUFFER_SIZE;
else{returnestimatedRadius;
else{//ok,sowehaveanestimatebasedonthestaticportionofthestyle,//let'sextractthedynamiconeDynamicSizeStyleExtractorextractor=newDynamicSizeStyleExtractor();finalList<Rule>dynamicRules=newArrayList<Rule>();for(Rulerule:rules){rule.accept(extractor);Rulecopy=(Rule)extractor.getCopy();
if(copy!=null){dynamicRules.add(copy);
if(dynamicRules.size()==0){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Nodynamicrulesfound,even
iftheestimatorinitiallythoughso,"+"usingthestaticanalysisresult:"+estimatedRadius);
iftheyaresimplelinkstoattributes//ordirectproportionalitieswecouldjustcomputethemaxvalueofthefields//involvedFeatureSource<?,?>fs=layer.getFeatureSource();EnvelopetargetRasterSpace=newEnvelope(-estimatedRadius,params.getWidth()+estimatedRadius,-estimatedRadius,params.getWidth()+estimatedRadius);Envelopeexpanded=JTS.transform(targetRasterSpace,newAffineTransform2D(screenToWorld));ReferencedEnveloperenderingBBOX=newReferencedEnvelope(expanded,getMap.getCrs());ReferencedEnvelopequeryBBOX=renderingBBOX.transform(fs.getSchema().getCoordinateReferenceSystem(),true);//setupthequeryQueryquery=layer.getQuery();BBOXbbox=FF.bbox(FF.property(""),queryBBOX);
if(query.getFilter()==null||query.getFilter()==Filter.INCLUDE){query.setFilter(bbox);
else{Filterand=FF.and(query.getFilter(),bbox);query.setFilter(and);
ifthefeaturesjustrenderedhitthetargetarea,andcollectsthem.Stopsthe*renderingonceenoughfeaturesarecollected**@authorAndreaAime-GeoSolutions*/staticfinalclassFeatureInfoRenderListenerimplementsRenderListener{privatefinalintscanlineStride;privateRectanglehitArea;List<SimpleFeature>features=newArrayList<SimpleFeature>();String[]propertyNames;SimpleFeatureBuilderretypeBuilder;privateintmaxFeatures;ColorModelcm;BufferedImagebi;StreamingRendererrenderer;Featureprevious;Graphics2Dgraphics;publicFeatureInfoRenderListener(BufferedImagebi,RectanglehitArea,intmaxFeatures,String[]propertyNames){verifyColorModel(bi);Rasterraster=getRaster(bi);this.scanlineStride=raster.getDataBuffer().getSize()/raster.getHeight();this.hitArea=hitArea;this.maxFeatures=maxFeatures;this.cm=bi.getColorModel();this.bi=bi;
if(!(cminstanceofDirectColorModel)){thrownewIllegalArgumentException("Invalidcolormodel,itshouldbeaDirectColorModel");
if(dcm.getNumColorComponents()!=3||!dcm.hasAlpha()){thrownewIllegalArgumentException("Invalidcolormodel,itshouldbea3bandsDirectColorModelwithalpha");
if(raster.getParent()!=null){thrownewIllegalArgumentException("Theprovidedrasterisachildofanotherimage");
else{returnraster;
if(feature==previous){//cleanthehitareaanywaysbeforereturning,asthefeaturemight//havebeenrenderedtwiceinarowcoloringthehitareatwicecleanHitArea();return;
ifhwaccelerationkicksinRasterraster=getRaster(bi);int[]pixels=((java.awt.image.DataBufferInt)raster.getDataBuffer()).getData();//scanandcleanthehitarea,bailoutearly
ifwefindahitbooleanhit=false;for(introw=hitArea.y;row<(hitArea.y+hitArea.height)&&!hit;row++){intidx=row*scanlineStride+hitArea.x;for(intcol=hitArea.x;col<(hitArea.x+hitArea.width)&&!hit;col++){finalintcolor=pixels[idx];finalintalpha=cm.getAlpha(color);
if(!hit&&alpha>0){hit=true;
if(hit){previous=feature;
if(features.size()<maxFeatures){SimpleFeatureretyped=retype(feature);features.add(retyped);
else{//we'redone,stoprenderingrenderer.stopRendering();
if(propertyNames==null){returnfeature;
else{
if(retypeBuilder==null){SimpleFeatureTypetargetType=SimpleFeatureTypeBuilder.retype(feature.getFeatureType(),propertyNames);retypeBuilder=newSimpleFeatureBuilder(targetType);
if(query.getHints()!=null){HintsnewHints=newHints(query.getHints());newHints.remove(Hints.SCREENMAP);q.setHints(newHints);
if(propertyNames==null||propertyNames.length==0){//nopropertyselection,wereturnthemallq.setProperties(Query.ALL_PROPERTIES);
else{//propertiesgotselected,mixthemwiththeonesneededbytherenderer
if(query.getPropertyNames()==null||query.getPropertyNames().length==0){q.setPropertyNames(propertyNames);
else{Set<String>names=newLinkedHashSet<>(Arrays.asList(propertyNames));names.addAll(Arrays.asList(q.getPropertyNames()));String[]newNames=names.toArray(newString[names.size()]);q.setPropertyNames(newNames);
if(hints==null){result=newHashSet<RenderingHints.Key>();
else{result=newHashSet<RenderingHints.Key>(hints);
if(map!=null)map.remove(cacheKey);Map<String,Integer[]>map2=expireMap.get(filterName);
if(map2!=null)map.remove(cacheKey);
if(map!=null)returndeserializeAuthentication(map.get(cacheKey));
elsereturnnull;
if(map!=null)result=map.get(cacheKey);
if(result==null)returnnewInteger[]{DEFAULT_IDLE_SECS,DEFAULT_LIVE_SECS};returnresult;
if(timeToIdleSeconds!=null||timeToLiveSeconds!=null){Map<String,Integer[]>map=expireMap.get(filterName);
if(map==null){map=newHashMap<String,Integer[]>();expireMap.put(filterName,map);
if(map==null){map=newHashMap<String,byte[]>();cache.put(filterName,map);
if(bytes==null)returnnull;try{ByteArrayInputStreambin=newByteArrayInputStream(bytes);ObjectInputStreamin=newObjectInputStream(bin);Authenticationauth=(Authentication)in.readObject();in.close();returnauth;
if(amt==2&&value<10){buf.append('0');
else
if(amt==4&&value<1000){
if(value>=100){buf.append("0");
else
if(value>=10){buf.append("00");
else{buf.append("000");
else
if(amt==3&&value<100){
if(value>=10){buf.append('0');
else{buf.append("00");
ifit'saDate,orasacontinuous*interval,
ifit'saDateRange(andwillthrowan{@linkIllegalArgumentException}otherwise)**@paramdate*/publicStringformat(Objectdate){
if(dateinstanceofDate){returnformat((Date)date);
else
if(dateinstanceofDateRange){DateRangerange=(DateRange)date;StringBuildersb=newStringBuilder();format(range.getMinValue(),sb);sb.append("/");format(range.getMaxValue(),sb);sb.append("/PT1S");returnsb.toString();
else{thrownewIllegalArgumentException("DateargumentshouldbeeitheraDateora"+"DateRange,howeverthisoneisneither:"+date);
if(cal.get(Calendar.ERA)==GregorianCalendar.BC){
if(year>1){buf.append('-');
if((reqPath.length()>1)&&reqPath.startsWith("/")){reqPath=reqPath.substring(1);
if(reqPath.startsWith("styles/")&&(reqPath.length()>7)){Resourceresource=null;GeoServerResourceLoaderresources=catalog.getResourceLoader();GeoServerDataDirectorydata=newGeoServerDataDirectory(resources);StringstylePath=reqPath.substring(7);intslash=stylePath.indexOf('/');
if((slash>-1)&&(stylePath.length()>(slash+1))){//workspacedstyleStringwsName=stylePath.substring(0,slash);WorkspaceInfoworkspace=catalog.getWorkspaceByName(wsName);
if(workspace!=null){StringwsStylePath=stylePath.substring(slash+1);resource=data.getStyles(workspace,wsStylePath);
if(resource.getType()==Type.UNDEFINED){//workspacestylenotfound,trytheglobalstylesdirectoryasafallbackresource=data.getStyles(wsStylePath);
if((resource==null)||(resource.getType()==Type.UNDEFINED)){//globalstyleresource=data.getStyles(stylePath);
switch(resource.getType()){caseRESOURCE:returnURLs.fileToUrl(resource.file());caseDIRECTORY:caseUNDEFINED:default:returnnull;
ifyoustoretheeventandtrytoaccessthecollectionlaterthereis*noguaranteeitwillstillbeusable.*/publicSimpleFeatureCollectiongetAffectedFeatures(){returnaffectedFeatures;
if(buffer==null){buffer=newStringBuffer();
if(parent==null||!("ComplexData".equals(parent.getComponent().getName()))){returnfalse;
if(delegateinstanceofComplexDataHandler){continue;
if(delegateinstanceofParserDelegate2&&((ParserDelegate2)delegate).canHandle(elementName,attributes,handler,parent)){returnfalse;
else
if(delegate.canHandle(elementName)){returnfalse;
if(this.delegates==null){this.delegates=container.getComponentInstancesOfType(ParserDelegate.class);
ifitwheretheresultofa*GetFeatureWFSrequest.**@authorNielsCharlier*/publicclassGML3FeatureInfoOutputFormatextendsGetFeatureInfoOutputFormat{/***TheMIMEtypeoftheformatthisresponseproduces:<code>"application/vnd.ogc.gml"</code>*/publicstaticfinalStringFORMAT="application/vnd.ogc.gml/3.1.1";privateGML3OutputFormatoutputFormat;/**Defaultconstructor,setsupthesupportedoutputformatstring.*/publicGML3FeatureInfoOutputFormat(finalGML3OutputFormatoutputFormat){this(outputFormat,FORMAT);
if(crs!=null){finalStringsrsName="EPSG:"+crs;try{qt.setSrsName(newURI(srsName));
ifwewanttoremoveitornotyetPDTilingPatterntilingPattern=getTilingPattern(response.getContentAsByteArray());assertNull(tilingPattern);
if(context.getGraphicsState().getNonStrokingColorSpace()instanceofPDPattern){PDPatterncolorSpace=(PDPattern)context.getGraphicsState().getNonStrokingColorSpace();PDAbstractPatternap=colorSpace.getPattern(color);
if(apinstanceofPDTilingPattern){pattern.set((PDTilingPattern)ap);
if(input!=null&&!input.isEmpty()){file=newFile(input);
if(returnNull){returnnull;
if(SI.RADIAN.equals(standardUnit)){pm=newPrecisionModel(1e6);//truncatecoordsat6decimals
else
if(SI.METRE.equals(standardUnit)){pm=newPrecisionModel(100);//truncatecoordsat2decimals
if(pm!=null){precisionReducerFilter=newCoordinatePrecisionReducerFilter(pm);
if(precisionReducerFilter!=null){aGeom.apply(precisionReducerFilter);
if(value==null){jsonWriter.value(null);
else{jsonWriter.value(value);
if(out.isInMemory()){byte[]data=out.getData();length=data.length;map=newRawMap(mapContent,data,MIME_TYPE);
else{Filef=out.getFile();length=f.length();map=newDeferredFileOutputStreamWebMap(mapContent,out,MIME_TYPE);
ifit'sanumberandequalsto14.*/publicbooleansupportsVersion(Stringversion){
if(super.supportsVersion(version))returntrue;try{intv=Integer.parseInt(version);returnv==14;
if(geometryAsBlock){for(Stringname:blockNames.values())writeInsert(layer,name);
else{//iteratesthroughalltheitemsFeatureIterator<SimpleFeature>iter=coll.features();try{while(iter.hasNext()){SimpleFeaturef=iter.next();Stringfid=f.getID();//
ifit'sablockinsertit,
elsewritethegeometry//directly
if(blockNames.containsKey(fid)){Stringname=blockNames.get(fid);writeInsert(layer,name);
else{writeGeometry(layer,"1F",(Geometry)f.getDefaultGeometry());Stringname=blockNames.get(coll.hashCode()+"");
if(writeAttributes){StringownerHandle=blockHandles.get(coll.hashCode()+"");StringattributesLayer=layer+"_attributes";//writeInsert(layer,name);writeInsertWithAttributes(attributesLayer,ownerHandle,name,f);
if(!(p.getValue()instanceofGeometry)){writeAttribute(layer,ownerHandle,name.getLocalPart(),p.getValue(),intPoint);
if(value!=null){valueString=value.toString();
if(blockNames.containsKey(fid)){StringownerHandle=blockHandles.get(fid);Stringname=blockNames.get(fid);StringstartHandle=getNewHandle("Block");StringendHandle=getNewHandle("Block");writeStartBlock(startHandle,ownerHandle,false,"0",name);writeGeometry(layer,ownerHandle,(Geometry)f.getDefaultGeometry());writeEndBlock(endHandle,ownerHandle,false,"0",name);
if(blockNames.containsKey(coll.hashCode()+"")){StringownerHandle=blockHandles.get(coll.hashCode()+"");Stringname=blockNames.get(coll.hashCode()+"");StringstartHandle=getNewHandle("Block");StringendHandle=getNewHandle("Block");writeStartBlock(startHandle,ownerHandle,false,"0",name);StringattributesLayer=getLayerName(coll)+"_attributes";writeGeometryStart("POINT",attributesLayer,ownerHandle);//writeGeometryStart("CIRCLE",attributesLayer,ownerHandle);writeSubClass("AcDbPoint");//writeSubClass("AcDbCircle");writePoint(0.0,0.0,0.0);//writeDoubleGroup(40,1.0);writeAttributeDefinitions(attributesLayer,ownerHandle,coll);writeEndBlock(endHandle,ownerHandle,false,"0",name);
if(!(p.getType()instanceofGeometryType)){writeAttrDef(layer,ownerHandle,name.getLocalPart());
if(geominstanceofGeometryCollection){GeometryCollectioncoll=(GeometryCollection)geom;for(intcount=0;count<coll.getNumGeometries();count++)writeGeometry(layer,ownerHandle,coll.getGeometryN(count));
else
if(geominstanceofPolygon){Polygonp=(Polygon)geom;writeGeometry(layer,ownerHandle,p.getExteriorRing());for(intcount=0;count<p.getNumInteriorRing();count++)writeGeometry(layer,ownerHandle,p.getInteriorRingN(count));
else
if(geominstanceofLineString){LineStringl=(LineString)geom;Coordinate[]coords=l.getCoordinates();writePolylineGeometry(layer,ownerHandle,coords,false);
else
if(geominstanceofPoint){Pointp=(Point)geom;writePointGeometry(layer,ownerHandle,p);
if(closed)writeIntegerGroup(70,1);for(Coordinatecoord:coords)writePoint(coord.x,coord.y,Double.NaN);
if(paperSpace)writeIntegerGroup(67,1);writeSubClass("AcDbBlockBegin");writeName(name);writeIntegerGroup(70,0);writeIntegerGroup(71,0);writePoint(0.0,0.0,0.0);writeGroup(3,name);writePath("");
if(paperSpace)writeIntegerGroup(67,1);writeLayer(layer);writeSubClass("AcDbBlockEnd");
if(blockNames!=null){for(Stringfid:blockNames.keySet())blockHandles.put(fid,writeBlockRecord(blockNames.get(fid)));
if(blockNames==null){//initializesblockcache//fornamesandhandlesblockNames=newHashMap<String,String>();blockHandles=newHashMap<String,String>();//cyclethroughfeaturetoaccumulate//blocksfor(Objectcoll:featureList)addBlocks((FeatureCollection)coll);
ifthegeometryiscomplex,itwillbe//exportedasablock;weusefidtocache//thisforfurtherusing(blocksandentities//sections)
if(geometryAsBlock||isBlockGeometry(geom)){LOGGER.warning("added");blockNames.put(f.getID(),(blockCounter++)+"");
if(writeAttributes){//addattributedefinitionblocksblockNames.put(coll.hashCode()+"",(blockCounter++)+"");
ifageometryiscomplexandshouldbeexportedasablock.**@paramgeom*/privatebooleanisBlockGeometry(Geometrygeom){
if(geom!=null){//collectionsareexportedasblocks//quickfix:generatesafalsereferencetoablock"0"/*
if(GeometryCollection.class.isAssignableFrom(geom.getClass()))returntrue;*///polygonswithholesareexportedasblocks
if(Polygon.class.isAssignableFrom(geom.getClass())){return((Polygon)geom).getNumInteriorRing()>0;
if(writeAttributes){for(Objectcoll:featureList){writeAttributeLayer((FeatureCollection)coll);
if(color!=-1)writeColor(color);//linetype
if(ltype!=-1)writeLineType(ltype);
if(e!=null){writeVariable("EXTMIN");writePoint(e.getMinX(),e.getMinY(),0.0);writeVariable("EXTMAX");writePoint(e.getMaxX(),e.getMaxY(),0.0);
ifwereallyneeditprivatebyte[][]ctable=null;/**Doweneedareprojection.*/privatebooleanneedReprojection;privateAffineTransformconcatenatedForwardTransform;privateAffineTransformconcatenatedBackwardTransform;privateintkwidth;privateintkheight;privateintmaxX;privateintmaxY;privateRandomIteriter;privateintlpad;privateinttpad;privateintrpad;privateintbpad;/***Wrapthesrccoverageinthedstlayout.<br>*TheresultingRenderedImagewillcontainthedatainsrc,andwillbeaccessibleviathegrid*specsofdst,**@paramsrcthedatacoveragetoberemappedondstgrid*@paramdsttheproviderofthefinalgrid*@paramnodatathenodatavaluetosetforcellsnotcoveredbysrcbutincludedindst.All*bandswillsharethesamenodatavalue.*@returnaninstanceofCoverage2RenderedImageAdapter*/publicstaticGridCoverage2DRIAcreate(finalGridCoverage2Dsrc,finalGridCoverage2Ddst,finaldoublenodata){Utilities.ensureNonNull("dst",dst);returnGridCoverage2DRIA.create(src,dst.getGridGeometry(),nodata);
if(interp!=null){lpad=interp.getLeftPadding();rpad=interp.getRightPadding();tpad=interp.getTopPadding();bpad=interp.getBottomPadding();
else{lpad=rpad=tpad=bpad=0;
if(extender==null){extender=GridCoverage2DRIA.DEFAULT_BORDEREXTENDER;
if(!(lpad==rpad&&rpad==tpad&&tpad==bpad&&bpad==0)){//thereisneedtoextendminX=srcImage.getMinX();maxX=srcImage.getMaxX()-1;minY=srcImage.getMinY();maxY=srcImage.getMaxY()-1;Rectanglebounds=newRectangle(srcImage.getMinX()-lpad,srcImage.getMinY()-tpad,srcImage.getWidth()+lpad+rpad,srcImage.getHeight()+tpad+bpad);iter=RandomIterFactory.create(srcImage.getExtendedData(bounds,extender),bounds);
else{minX=srcImage.getMinX();maxX=srcImage.getMaxX()-1;minY=srcImage.getMinY();maxY=srcImage.getMaxY()-1;iter=RandomIterFactory.create(srcImage,srcImage.getBounds());
if(!CRS.equalsIgnoreMetadata(sourceCRS,targetCRS)){src2dstCRSTransform=CRS.findMathTransform(sourceCRS,targetCRS,true);dst2srcCRSTransform=src2dstCRSTransform.inverse();
if(!src2dstCRSTransform.isIdentity()){needReprojection=true;return;
ifwegotherewedon'tneedtoreproject,let'sconcatenatethetransforms//wedon'treproject,let'ssimplifyneedReprojection=false;concatenatedForwardTransform=(AffineTransform)w2gd.clone();concatenatedForwardTransform.concatenate(g2ws);concatenatedBackwardTransform=concatenatedForwardTransform.createInverse();
if(XAffineTransform.isIdentity(concatenatedForwardTransform,1E-6)){//TODOimprovethischeckconcatenatedForwardTransform=newAffineTransform();//identityconcatenatedBackwardTransform=newAffineTransform();//identity
if(srcPt==null){thrownewIllegalArgumentException("Baddestpt");//JaiI18N.getString("Generic0"));
else
if(sourceIndex<0||sourceIndex>=getNumSources()){thrownewIndexOutOfBoundsException("Badsrc");//JaiI18N.getString("Generic1"));
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,"Errortransformingcoords",e);
if(dstGridGeometry.getGridRange2D().contains(ret))returnret;
else{LOGGER.log(Level.WARNING,"{0}mappedto{1}liesoutside{2},{3}+{4}x{5}",newObject[]{srcPt,ret,dstGridGeometry.getGridRange2D().x,dstGridGeometry.getGridRange2D().y,dstGridGeometry.getGridRange2D().width+dstGridGeometry.getGridRange2D().x,dstGridGeometry.getGridRange2D().height+dstGridGeometry.getGridRange2D().y});returnnull;
iftheboundingboxisunknown.*@throwsIllegalArgumentException
if<code>sourceIndex</code>isnegativeorgreaterthanthe*indexofthelastsource.*@throwsIllegalArgumentException
if<code>sourceRect</code>is<code>null</code>.*/@OverrideprotectedRectangleforwardMapRect(RectanglepxRect,inti){//transformationfromouttargetcoveragetowardthesourceone.//notethatsource/targetnamesfromOpImagearereversedwithrespecttoour//definitions//iisnotused,onlyonesourcerasterfloat[]pts=rect2PointArr(pxRect);try{g2ws.transform(pts,0,pts,0,4);src2dstCRSTransform.transform(pts,0,pts,0,4);w2gd.transform(pts,0,pts,0,4);
if(destPt==null){thrownewIllegalArgumentException("Baddestpt");//JaiI18N.getString("Generic0"));
if(sourceIndex<0||sourceIndex>=getNumSources()){thrownewIndexOutOfBoundsException("Badsrc");//JaiI18N.getString("Generic1"));
if(src.getGridGeometry().getGridRange2D().contains(coords[0],coords[1]))returnret;
elsereturnnull;
if(!needReprojection){
if(!concatenatedBackwardTransform.isIdentity()){concatenatedBackwardTransform.transform(coords,0,coords,0,npoints);
if(!needReprojection){
if(!concatenatedForwardTransform.isIdentity()){concatenatedForwardTransform.transform(coords,0,coords,0,npoints);
if*theboundingboxisunknown.*@throwsIllegalArgumentException
if<code>sourceIndex</code>isnegativeorgreaterthanthe*indexofthelastsource.*@throwsIllegalArgumentException
if<code>destRect</code>is<code>null</code>.*/@OverrideprotectedRectanglebackwardMapRect(RectangledestRect,intsourceIndex){float[]pts=rect2PointArr(destRect);try{g2wd.transform(pts,0,pts,0,4);dst2srcCRSTransform.transform(pts,0,pts,0,4);w2gs.transform(pts,0,pts,0,4);
if(interpinstanceofInterpolationNearest){s_x0=(int)Math.floor(f_sx0);s_y0=(int)Math.floor(f_sy0);//Fixforbug4485920wastoadd"+0.05"tothefollowing//twolines.Itshouldbenotedthatthefixwasmadebased//onempiricalevidenceandtestedthoroughly,butitisnot//knownwhetherthisistherootcause.s_x1=(int)Math.ceil(f_sx1+0.5);s_y1=(int)Math.ceil(f_sy1+0.5);
else{s_x0=(int)Math.floor(f_sx0-0.5);s_y0=(int)Math.floor(f_sy0-0.5);s_x1=(int)Math.ceil(f_sx1);s_y1=(int)Math.ceil(f_sy1);
switch(d.getDataType()){caseDataBuffer.TYPE_BYTE:computeRectByte(sources[0],d);break;caseDataBuffer.TYPE_USHORT:computeRectUShort(sources[0],d);break;caseDataBuffer.TYPE_SHORT:computeRectShort(sources[0],d);break;caseDataBuffer.TYPE_INT:computeRectInt(sources[0],d);break;caseDataBuffer.TYPE_FLOAT:computeRectFloat(sources[0],d);break;caseDataBuffer.TYPE_DOUBLE:computeRectDouble(sources[0],d);break;
if(d.isDataCopy()){d.clampDataArrays();d.copyDataToRaster();
if(ctable==null){//sourcedoesnothaveIndexColorModel//==cycleondestinationimageintminx=dst.getX(),x=0;intminy=dst.getY(),y=0;finaldoublecoords[]=newdouble[2];//temppoint//==cycleonYfor(inth=0;h<dstHeight;h++){intpixelOffset=lineOffset;lineOffset+=lineStride;y=miny+h;//---cycleonXfor(intw=0;w<dstWidth;w++){x=minx+w;//mapdestinatonpointtosourcepointtry{coords[0]=x;coords[1]=y;mapDestPoint(coords);
if(xint<minX||xint>maxX||yint<minY||yint>maxY){/*Fillwithabackgroundcolor.*/
if(setBackground){for(intb=0;b<dstBands;b++){data[b][pixelOffset+bandOffsets[b]]=backgroundByte[b];
else{//---optimizenearestinterpolation
if(interpinstanceofInterpolationNearest){for(intb=0;b<dstBands;b++){data[b][pixelOffset+bandOffsets[b]]=ImageUtil.clampByte(iter.getSample(xint,yint,b));
else{xint-=lpad;yint-=tpad;for(intb=0;b<dstBands;b++){for(intj=0;j<kheight;j++){for(inti=0;i<kwidth;i++){samples[j][i]=iter.getSample(xint+i,yint+j,b)&0xFF;
else{//sourcehasIndexColorModel//==cycleondestinationimageintminx=dst.getX(),x=0;intminy=dst.getY(),y=0;finaldoublecoords[]=newdouble[2];//temppoint//---cycleonYfor(inth=0;h<dstHeight;h++){intpixelOffset=lineOffset;lineOffset+=lineStride;y=miny+h;//ycoordinthepositiontosetindestspace//---cycleonXfor(intw=0;w<dstWidth;w++){x=minx+w;//xcoordinthepositiontosetindestspace//mapdestinatonpointtosourcespaceforgettingthevaluestry{coords[0]=x;coords[1]=y;mapDestPoint(coords);
if(xint<minX||xint>=maxX||yint<minY||yint>=maxY){/*Fillwithabackgroundcolor.*/
if(setBackground){for(intb=0;b<dstBands;b++){data[b][pixelOffset+bandOffsets[b]]=backgroundByte[b];
else{xint-=lpad;yint-=tpad;for(intb=0;b<dstBands;b++){byte[]t=ctable[b];for(intj=0;j<kheight;j++){for(inti=0;i<kwidth;i++){samples[j][i]=t[iter.getSample(xint+i,yint+j,0)&0xFF]&0xFF;
if(xint<minX||xint>maxX||yint<minY||yint>maxY){/*Fillwithabackgroundcolor.*/
if(setBackground){for(intb=0;b<dstBands;b++){data[b][pixelOffset+bandOffsets[b]]=backgroundUShort[b];
else{//---optimizenearestinterpolation
if(interpinstanceofInterpolationNearest){for(intb=0;b<dstBands;b++){data[b][pixelOffset+bandOffsets[b]]=ImageUtil.clampUShort(iter.getSample(xint,yint,b));
else{xint-=lpad;yint-=tpad;for(intb=0;b<dstBands;b++){for(intj=0;j<kheight;j++){for(inti=0;i<kwidth;i++){samples[j][i]=iter.getSample(xint+i,yint+j,b)&0xFFFF;
if(xint<minX||xint>maxX||yint<minY||yint>maxY){/*Fillwithabackgroundcolor.*/
if(setBackground){for(intb=0;b<dstBands;b++){data[b][pixelOffset+bandOffsets[b]]=backgroundShort[b];
else{//---optimizenearestinterpolation
if(interpinstanceofInterpolationNearest){for(intb=0;b<dstBands;b++){data[b][pixelOffset+bandOffsets[b]]=ImageUtil.clampShort(iter.getSample(xint,yint,b));
else{xint-=lpad;yint-=tpad;for(intb=0;b<dstBands;b++){for(intj=0;j<kheight;j++){for(inti=0;i<kwidth;i++){samples[j][i]=iter.getSample(xint+i,yint+j,b);
if(xint<minX||xint>maxX||yint<minY||yint>maxY){/*Fillwithabackgroundcolor.*/
if(setBackground){for(intb=0;b<dstBands;b++){data[b][pixelOffset+bandOffsets[b]]=backgroundInt[b];
else{//---optimizenearestinterpolation
if(interpinstanceofInterpolationNearest){for(intb=0;b<dstBands;b++){data[b][pixelOffset+bandOffsets[b]]=iter.getSample(xint,yint,b);
else{xint-=lpad;yint-=tpad;for(intb=0;b<dstBands;b++){for(intj=0;j<kheight;j++){for(inti=0;i<kwidth;i++){samples[j][i]=iter.getSample(xint+i,yint+j,b);
if(xint<minX||xint>maxX||yint<minY||yint>maxY){/*Fillwithabackgroundcolor.*/
if(setBackground){for(intb=0;b<dstBands;b++){dstData[b][pixelOffset+dstBandOffsets[b]]=(float)backgroundValues[b];
else{//---optimizenearestinterpolation
if(interpinstanceofInterpolationNearest){for(intb=0;b<dstBands;b++){dstData[b][pixelOffset+dstBandOffsets[b]]=iter.getSampleFloat(xint,yint,b);
else{//genericinterpolationxint-=lpad;yint-=tpad;for(intb=0;b<dstBands;b++){for(intj=0;j<kheight;j++){for(inti=0;i<kwidth;i++){samples[j][i]=iter.getSampleFloat(xint+i,yint+j,b);
if(xint<minX||xint>maxX||yint<minY||yint>maxY){/*Fillwithabackgroundcolor.*/
if(setBackground){for(intb=0;b<dstBands;b++){data[b][pixelOffset+bandOffsets[b]]=backgroundValues[b];
else{//---optimizenearestinterpolation
if(interpinstanceofInterpolationNearest){for(intb=0;b<dstBands;b++){data[b][pixelOffset+bandOffsets[b]]=iter.getSampleDouble(xint,yint,b);
else{xint-=lpad;yint-=tpad;for(intb=0;b<dstBands;b++){for(intj=0;j<kheight;j++){for(inti=0;i<kwidth;i++){samples[j][i]=iter.getSampleDouble(xint+i,yint+j,b);
ifitisnon-<code>null</code>,or*anew<code>float</code>arrayotherwise.*/publicfloat[]warpSparseRect(intx0,inty0,intwidth,intheight,intperiodX,intperiodY,float[]destRect){//XXX:Thismethodshoulddoitscalculationsindoubles
if(destRect==null){destRect=newfloat[((width+periodX-1)/periodX)*((height+periodY-1)/periodY)*2];
if(iter!=null){iter.done();
if(line.matches("\\s*-f\".*")){Stringformat=line.substring(line.indexOf('"')+1,line.lastIndexOf('"'));formats.add(format);
ifogr2ogrisavailable,thatis,
ifexecuting"ogr2ogr--version"returns0as*theexitcode*/publicbooleanisAvailable(){List<String>commands=newArrayList<String>();commands.add(getExecutable());commands.add("--version");try{returnrun(commands,null)==0;
if(crsFile!=null){cmd.add("-a_srs");cmd.add(crsFile.getAbsolutePath());
if(crsFile!=null){crsFile.delete();crsFile=null;
if("wms".equals(s.getId().toLowerCase())){
if(!s.getOperations().contains(GET_TIME_SERIES_OP_NAME)){s.getOperations().add(GET_TIME_SERIES_OP_NAME);
if(name.endsWith(supportedExtension)){returntrue;
if(name.endsWith(supportedExtension)){returnsupportedExtension;
if(extension.length()>0){extension="."+extension;
if(fsManager.canCreateFileSystem(resolvedFile)){fileSystem=fsManager.createFileSystem(resolvedFile);
else{fileSystem=resolvedFile;
if(file.exists()&&file.isDirectory()){return"file://";
if(name.endsWith(".zip")||name.endsWith(".kmz")){return"zip://";
if(name.endsWith(".tar")){return"tar://";
if(name.endsWith(".tgz")||name.endsWith(".tar.gz")){return"tgz://";
if(name.endsWith(".tbz2")||name.endsWith(".tar.bzip2")||name.endsWith(".tar.bz2")){return"tbz2://";
if(name.endsWith(".gz")){return"gz://";
if(name.endsWith(".bz2")){return"bz2://";
if(name.endsWith(".jar")){return"jar://";
if(manager.canCreateFileSystem(source)){source=manager.createFileSystem(source);
if(provider.getException()!=null){ParamResourceModelrm=newParamResourceModel("GWC.diskQuotaLoadFailed",null,provider.getException().getMessage());error(rm.getString());
if(diskQuotaModuleDisabled){diskQuotaConfig=newDiskQuotaConfig();//fakediskQuotaConfig.setDefaults();
else{diskQuotaConfig=gwc.getDiskQuotaConfig().clone();
if(gwc.getJDBCDiskQuotaConfig()==null){jdbcQuotaConfiguration=newJDBCConfiguration();JDBCConfiguration.ConnectionPoolConfigurationconfiguration=newJDBCConfiguration.ConnectionPoolConfiguration();configuration.setMinConnections(1);configuration.setMaxConnections(10);configuration.setConnectionTimeout(10000);configuration.setMaxOpenPreparedStatements(50);jdbcQuotaConfiguration.setConnectionPool(configuration);
else{jdbcQuotaConfiguration=gwc.getJDBCDiskQuotaConfig();
if(diskQuotaModuleDisabled){diskQuotaConfigPanel.setEnabled(false);super.warn(newResourceModel("DiskQuotaSettingsPage.disabledWarning").getObject());
if(!diskQuotaModuleDisabled){StorageUnitchosenUnit=diskQuotaConfigPanel.getStorageUnit();//REVISIT:itseemsWicketissendingbackaplainstringinsteadofaStringchosenQuotaStr=String.valueOf(diskQuotaConfigPanel.getQuotaValue());DoublechosenQuota;try{chosenQuota=Double.valueOf(chosenQuotaStr);
if(chosenQuota.doubleValue()<=0D){form.error("Quotahastobe>0");return;
if(dqConfig.getQuotaStore()!=null&&dqConfig.getQuotaStore().equals("JDBC")){try{gwc.testQuotaConfiguration(jdbcConfig);
if(null==imageIOFileCachingThreshold||0L>=imageIOFileCachingThreshold.longValue()){StringwarningMsg=newResourceModel("GWC.ImageIOFileCachingThresholdUnsetWarning").getObject();super.warn(warningMsg);
if(null!=titleKey){AttributeModifierattributeModifier=newAttributeModifier("title",newStringResourceModel(titleKey,(Component)null,null));checkBox.add(attributeModifier);
if(XMPPClient.PRIMITIVE_NAME_TYPE_MAP.get(type)!=null){Objectsample=((Object[])XMPPClient.PRIMITIVE_NAME_TYPE_MAP.get(type))[2];
if(sampleinstanceofStreamRawData){finalStringfileName=FilenameUtils.getBaseName(((String)value))+"_"+pID+"."+((StreamRawData)sample).getFileExtension();LOGGER.finest("[XMPPRawDataOutput-ProduceOutput]StreamRawData:"+fileName);value=newStreamRawData(((StreamRawData)sample).getMimeType(),newFileInputStream(((String)value)),((StreamRawData)sample).getFileExtension());
if(publish){finalFiletempFile=newFile(FileUtils.getTempDirectory(),fileName);FileUtils.copyInputStreamToFile(((StreamRawData)value).getInputStream(),tempFile);try{xmppClient.importLayer(tempFile,type,null,name+"_"+pID,title,description,defaultStyle,targetWorkspace,metadata);
else
if(sampleinstanceofResourceRawData){finalStringfileName=FilenameUtils.getBaseName(((String)value))+"_"+pID+"."+((ResourceRawData)sample).getFileExtension();LOGGER.finest("[XMPPRawDataOutput-ProduceOutput]FileRawData:"+fileName);FileoutputFile=getOutputFile(xmppClient,(String)value);
if(outputFile.renameTo(newFile(outputFile.getParentFile(),fileName))){outputFile=newFile(outputFile.getParentFile(),fileName);outputFile.setLastModified(System.nanoTime());
if(publish){try{xmppClient.importLayer(outputFile,type,null,name+"_"+pID,title,description,defaultStyle,targetWorkspace,metadata);
else
if(sampleinstanceofStringRawData){LOGGER.finest("[XMPPRawDataOutput-ProduceOutput]StringRawData:"+type);
if(type.equals("application/owc")){value=encodeAsPlainOWCMapContext(value,type,pID,baseURL,xmppClient,publish,name+"_"+pID,title,description,defaultStyle,targetWorkspace,metadata);
else{value=encodeAsPlainRawData(value,type,pID,baseURL,xmppClient,publish,name+"_"+pID,title,description,defaultStyle,targetWorkspace,metadata);
if(file!=null&&file.exists()&&file.canRead()&&file.isFile()){returnfile;
else{//1.tryfirst
iftheyarepresenton"uploadedFilesBasePath"
if(xmppClient.getConfiguration().get("uploadedFilesBasePath")!=null){finalStringuploadedFilesBasePath=xmppClient.getConfiguration().get("uploadedFilesBasePath");finalFileuploadedFile=newFile(uploadedFilesBasePath,value);
if(uploadedFile!=null&&/*uploadedFile.isAbsolute()&&*/uploadedFile.exists()&&uploadedFile.canRead()&&uploadedFile.isFile()){returnuploadedFile;
ifthefilehasstoredontheGeoServerDataDirfinalFileuploadedFile=xmppClient.getGeoServer().getCatalog().getResourceLoader().find(value);
if(uploadedFile!=null&&/*uploadedFile.isAbsolute()&&*/uploadedFile.exists()&&uploadedFile.canRead()&&uploadedFile.isFile()){returnuploadedFile;
if(publish){finalFiletempFile=newFile(FileUtils.getTempDirectory(),fileName);LOGGER.finest("[XMPPRawDataOutput-ProduceOutput]encodeAsPlainRawData:"+tempFile.getAbsolutePath());FileUtils.writeStringToFile(tempFile,((StringRawData)value).getData());FileUtils.waitFor(tempFile,5);StringwsName=xmppClient.getGeoServer().getCatalog().getDefaultWorkspace().getName();DataStoreInfoh2DataStore=xmppClient.createH2DataStore(wsName,FilenameUtils.getBaseName(fileName));try{xmppClient.importLayer(tempFile,type,h2DataStore,name+"_"+pID,title,description,defaultStyle,targetWorkspace,metadata);
if(layerToPublish!=null&&layerToPublish.length>0){finalGeoServergeoServer=xmppClient.getGeoServer();finalCatalogcatalog=geoServer.getCatalog();for(intfi=0;fi<layerToPublish.length;fi++){finalStringlayerBaseName=layerToPublish[fi];finalStringlayerStyle=styles[fi];finalStringlayerWorkspace=workspaces[fi];LOGGER.finest("[XMPPRawDataOutput-ProduceOutput]lookingforLayerInfo:"+layerBaseName+"_"+pID);LayerInfolayerInfo=(catalog.getLayerByName(layerBaseName+"_"+pID)!=null?catalog.getLayerByName(layerBaseName+"_"+pID):catalog.getLayerByName(newNameImpl(layerWorkspace,layerBaseName+"_"+pID)));
if(layerInfo==null){LOGGER.warning("[XMPPRawDataOutput-ProduceOutput]cuoldnotfindLayerInfo["+layerBaseName+"_"+pID+"]...goingtoscanthewholeCatalog!");for(LayerInfolayer:catalog.getLayers()){LOGGER.info("[XMPPRawDataOutput-ProduceOutput]lookingforLayerInfo:"+layer.getName());
if(layer.getName().contains(layerBaseName)&&layer.getName().contains(pID)){LOGGER.info("[XMPPRawDataOutput-ProduceOutput]foundcandidateLayerInfo:"+layer.getName());layerInfo=layer;break;
if(layerInfo!=null){LOGGER.finest("[XMPPRawDataOutput-ProduceOutput]foundLayerInfo:"+layerBaseName+"_"+pID);
if(layerStyle.trim().length()>0){StyleInfostyle=catalog.getStyleByName(layerStyle);
if(style!=null){layerInfo.setDefaultStyle(style);
if(layerWorkspace.trim().length()>0){WorkspaceInfoworkspace=catalog.getWorkspaceByName(layerWorkspace);NamespaceInfonamespace=catalog.getNamespace(layerInfo.getResource().getNamespace().getId());
if(workspace!=null&&(!workspace.getName().equals(namespace.getPrefix())||namespace==null)){namespace=catalog.getNamespaceByPrefix(workspace.getName());
if(namespace!=null){layerInfo.getResource().setNamespace(namespace);
else{LOGGER.finest("[XMPPRawDataOutput-ProduceOutput]couldnotfindanyLayerInfo:"+layerBaseName+"_"+pID);
if(wmcTemplatePath!=null){try{//fillingthemodelfinalHashMap<String,Object>map=newHashMap<String,Object>();Map<String,Object>featureList=newHashMap<String,Object>();ReferencedEnveloperenderingArea=null;for(LayerInfolayer:wmc){WmcFeaturefeature=wrapFeature(xmppClient,baseURL,layer);featureList.put(layer.getId(),feature);
if(renderingArea==null){renderingArea=newReferencedEnvelope(layer.getResource().getLatLonBoundingBox());
else{renderingArea.expandToInclude(layer.getResource().getLatLonBoundingBox());
if(refEnvelope==null)return"[[]]";//"[[[-2,45],[8,45],[8,55],[-2,55],[-2,45]]]"doubleminx=refEnvelope.getLowerCorner().getOrdinate(0);doubleminy=refEnvelope.getLowerCorner().getOrdinate(1);doublemaxx=refEnvelope.getUpperCorner().getOrdinate(0);doublemaxy=refEnvelope.getUpperCorner().getOrdinate(1);return"[[["+minx+","+miny+"],["+maxx+","+miny+"],["+maxx+","+maxy+"],["+minx+","+maxy+"],["+minx+","+miny+"]]]";
if(baseUrl.endsWith("/")){returnbaseUrl.substring(0,baseUrl.length()-1);
else{returnbaseUrl;
ifthisclientalreadymadeotherconnectionsCookieidCookie=null;Cookie[]cookies=request.getHttpRequest().getCookies();
if(cookies!=null){for(Cookiecookie:cookies){
if(cookie.getName().equals(COOKIE_NAME)){idCookie=cookie;break;
ifwehavethatqueuealready
if(idCookie==null){idCookie=newCookie(COOKIE_NAME,COOKIE_PREFIX+newUID().toString());
if(types!=null){List<String>result=newArrayList<String>();for(FeatureTypeft:types){result.add(ft.getName().toString());
if(connectionTimeout>0){executionManager.setConnectionTimeout((int)connectionTimeout*1000);
else{//specifiedtimeout==-1representsinfinitetimeout.//byconvention,forinfiniteURLConnectiontimeouts,weneedtousezero.executionManager.setConnectionTimeout(0);
if(expirationTimeout<0){//usethedefaultoffiveminutesexpirationTimeout=5*60*1000;
if(maxSynch>0){processManager.setMaxSynchronousProcesses(maxSynch);
else{processManager.setMaxSynchronousProcesses(defaultMaxProcesses);
if(maxAsynch>0){processManager.setMaxAsynchronousProcesses(maxAsynch);
else{processManager.setMaxAsynchronousProcesses(defaultMaxProcesses);
if(resources.getArtifactsStore()instanceofDefaultProcessArtifactsStore){WPSInfowps=geoServer.getService(WPSInfo.class);StringoutputStorageDirectory=wps.getStorageDirectory();FileSystemResourceStoreresourceStore;
if(outputStorageDirectory==null||outputStorageDirectory.trim().isEmpty()){Resourcetemp=resourceLoader.get("temp/wps");resourceStore=newFileSystemResourceStore(temp.dir());
else{Filestorage=newFile(outputStorageDirectory);//
ifit'sapathrelativetothedatadirectory,makeitabsolute
if(!storage.isAbsolute()){storage=resourceLoader.url(outputStorageDirectory);
if(storage.exists()&&!storage.isDirectory()){thrownewIllegalArgumentException("Invalidwpsstoragepath,"+"itrepresentsafile:"+storage.getPath());
if(!storage.exists()){
if(!storage.mkdirs()){thrownewIllegalArgumentException("Invalidwpsstoragepath,itdoesnotexistsandcannotbecreated:"+storage.getPath());
if(configured.getFactoryClass().equals(available.getFactoryClass())){found=true;break;
if(!found){//additnewGroups.add(available);
ifwehaveanythingnewtoadd
if(!newGroups.isEmpty()){info.getProcessGroups().addAll(newGroups);geoServer.save(info);
if(o1==null){returno2==null?0:-1;
else
if(o2==null){return1;
else{returno1.getClass().getName().compareTo(o2.getClass().getName());
if(values==null){returnCollections.emptyList();
if(values==null){returnnewTreeSet<>();
if(readerinstanceofStructuredGridCoverage2DReader){//goodwehaveastructuredcoveragereaderreturnnewWrapStructuredGridCoverageDimensions2DReader((StructuredGridCoverage2DReader)reader);
if(dimensionName.equalsIgnoreCase(descriptor.getName())){//descriptorfoundstartAttributeName=descriptor.getStartAttribute();endAttributeName=descriptor.getEndAttribute();
if*theprovidedfilterisNULLnothingwillbefiltered.*/@OverridepublicTuple<String,FeatureCollection>getValues(StringdimensionName,Queryquery,DataTypedataType){try{//openingthesourceanddescriptorsforourrasterGranuleSourcesource=reader.getGranules(reader.getGridCoverageNames()[0],true);List<DimensionDescriptor>descriptors=reader.getDimensionDescriptors(reader.getGridCoverageNames()[0]);//let'sfindourdimensionandquerythedatafor(DimensionDescriptordescriptor:descriptors){
if(dimensionName.equalsIgnoreCase(descriptor.getName())){//wefoundourdimensiondescriptor,creatingaqueryquery=newQuery(query);query.setTypeName(source.getSchema().getName().getLocalPart());query.getHints().put(StructuredCoverageViewReader.QUERY_FIRST_BAND,true);//readingthefeaturesusingthebuildqueryFeatureCollectionfeatureCollection=source.getGranules(query);//getthefeaturesattributethatcontainourdimensionvaluesStringattributeName=descriptor.getStartAttribute();returnTuple.tuple(attributeName,featureCollection);
if(filter!=null){query.setFilter(filter);
if(rawValue.contains("/")){String[]parts=rawValue.split("/");returnnewDateRange(formatDate(parts[0]),formatDate(parts[1]));
else{returnformatDate(rawValue);
if(rawValue.contains("/")){String[]parts=rawValue.split("/");returnnewNumberRange<>(Double.class,Double.parseDouble(parts[0]),Double.parseDouble(parts[1]));
else{returnDouble.parseDouble(rawValue);
if(metaDataValue==null||metaDataValue.isEmpty()){returnTuple.tuple(getDimensionAttributesNames(dimensionName).first,null);
if(query.getFilter()==null||query.getFilter().evaluate(feature)){memoryCollection.add(feature);
if(query.getPropertyNames()!=Query.ALL_NAMES){SimpleFeatureTypetarget=SimpleFeatureTypeBuilder.retype(memoryCollection.getSchema(),query.getPropertyNames());features=newRetypingFeatureCollection(memoryCollection,target);
if(dataType.equals(DataType.CUSTOM)){try{TEMPORAL_CONVERTER.apply(rawValue);returnDataType.TEMPORAL;
switch(dataType){caseTEMPORAL:featureTypeBuilder.add(getDimensionAttributesNames(dimensionName).first,TEMPORAL_CONVERTER.apply(rawValue).getClass());returnTuple.tuple(featureTypeBuilder.buildFeatureType(),TEMPORAL_CONVERTER);caseNUMERIC:featureTypeBuilder.add(getDimensionAttributesNames(dimensionName).first,NUMERICAL_CONVERTER.apply(rawValue).getClass());returnTuple.tuple(featureTypeBuilder.buildFeatureType(),NUMERICAL_CONVERTER);
if(mimeType==null){//tryguessingfromdatatry(InputStreamis=newBufferedInputStream(resource.in())){mimeType=URLConnection.guessContentTypeFromStream(is);
ifSSLisenabled.Also,settingthekeystorepasswordisrequired.**@see#setSSLCertificateKeystorePassword*@paramkeystorePaththepathtotheJavakeystore*@throwsIOException*/publicvoidsetSSLCertificateKeystore(ResourcekeystorePath)throwsIOException{sslKeystorePath=keystorePath.getFile().getAbsolutePath();
ifSSLisenabled.Also,settingthekeystorepasswordisrequired.**@see#setSSLCertificateKeystorePassword*@paramkeystorePaththepathtotheJavakeystore*/publicvoidsetSSLCertificateKeystore(StringkeystorePath){sslKeystorePath=keystorePath;
ifSSLisenabled.Also,thekeystoremustbesetusing{@link*#setSSLCertificateKeystore(String)}
if(contextPath==null)contextPath="/";this.contextPath=contextPath;
if(isSSLEnabled){//SSLContextFactoryforHTTPS//SSLrequiresacertificatesoweconfigureafactoryforsslcontents//withinformationpointingtowhatkeystorethesslconnectionneeds//toknowabout.Muchmoreconfigurationisavailablethesslcontext,//includingthingslikechoosingtheparticularcertificateoutofa//keystoretobeused.SslContextFactorysslContextFactory=newSslContextFactory();sslContextFactory.setKeyStorePath(sslKeystorePath);sslContextFactory.setKeyManagerPassword(sslKeystorePassword);sslContextFactory.setKeyStorePassword(sslKeystorePassword);//HTTPSConfiguration//AnewHttpConfigurationobjectisneededforthenextconnectorand//youcanpasstheoldoneasanargumenttoeffectivelyclonethe//contents.OnthisHttpConfigurationobjectweadda//SecureRequestCustomizerwhichishowanewconnectorisableto//resolvethehttpsconnectionbeforehandingcontrolovertotheJetty//Server.HttpConfigurationhttps_config=newHttpConfiguration(http_config);SecureRequestCustomizersrc=newSecureRequestCustomizer();//src.setStsMaxAge(2000);//src.setStsIncludeSubDomains(true);https_config.addCustomizer(src);//HTTPSconnector//WecreateasecondServerConnector,passinginthehttpconfiguration//wejustmadealongwiththepreviouslycreatedsslcontextfactory.//Nextwesettheportandalongeridletimeout.connector=newServerConnector(server,newSslConnectionFactory(sslContextFactory,HttpVersion.HTTP_1_1.asString()),newHttpConnectionFactory(https_config));connector.setIdleTimeout(500000);
else{connector=newServerConnector(server,newHttpConnectionFactory(http_config));connector.setIdleTimeout(30000);
if(exinstanceofPropertyName){Stringname=((PropertyName)ex).getPropertyName();Stringrenamed=rename(aliases.get(idx),name);returnff.property(renamed);
else{returnsuper.visit(ex,extraData);
if(query.getAliases()!=null&&!query.getAliases().isEmpty()){aliases=newArrayList<>(query.getAliases());
else{replaced=true;aliases=newArrayList<>();for(inti=0;i<metas.size();i++){aliases.add(String.valueOf((char)('a'+i)));
ifnecessaryfor(inti=0;i<aliases.size();i++){Stringalias=aliases.get(i);Stringbase=alias;intj=0;while(reservedWords.contains(alias)){replaced=true;alias=base+(j++);
if(replaced){returnnewAliasedQuery(query,originalAliases,aliases);
else{returnquery;
if(originalAliases!=null&&!originalAliases.isEmpty()){Map<String,String>renameMap=buildRenameMap(originalAliases,aliases);this.filter=(Filter)query.getFilter().accept(newAliasRenameVisitor(renameMap),null);
if(query.getPropertyNames()!=null){this.propertyNames=newArrayList<>();for(Stringname:query.getPropertyNames()){this.propertyNames.add(rename(renameMap,name));
else{//CITEtestshack,wasisaselfjoinquerywithnoaliases?List<QName>typeNames=query.getTypeNames();
if(typeNames.size()==2&&newHashSet<>(typeNames).size()==1){this.filter=(Filter)query.getFilter().accept(newSelfJoinRenameVisitor(aliases),null);
else{this.filter=query.getFilter();
if(!a1.equals(a2)){map.put(a1,a2);
if(idx>0){Stringprefix=name.substring(0,idx);Stringrenamed=renameMap.get(prefix);
if(renamed!=null){name=renamed+name.substring(idx);
if(idx>0){name=renamedPrefix+name.substring(idx);
if(templates||TaskManagerBeans.get().getDao().getConfigurations(true).isEmpty()){Configurationconfiguration=TaskManagerBeans.get().getFac().createConfiguration();configuration.setTemplate(templates);setResponsePage(newConfigurationPage(configuration));
else{dialog.setTitle(newParamResourceModel("addNewDialog.title",getPage()));dialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){privatestaticfinallongserialVersionUID=-5552087037163833563L;privateDropDownPanelpanel;@OverrideprotectedComponentgetContents(Stringid){ArrayList<String>list=newArrayList<String>();for(Configurationtemplate:TaskManagerBeans.get().getDao().getConfigurations(true)){list.add(template.getName());
if(choice==null){configuration=TaskManagerBeans.get().getFac().createConfiguration();
else{configuration=TaskManagerBeans.get().getDao().copyConfiguration(choice);configuration.setTemplate(false);configuration.setName(null);
if(be!=null){error(newParamResourceModel("taskInUse",AbstractConfigurationsPage.this,config.getName(),be.getTask().getName(),be.getBatch().getName()).getString());someCant=true;
else
if(!TaskManagerBeans.get().getDataUtil().isDeletable(config)){error(newParamResourceModel("stillRunning",AbstractConfigurationsPage.this,config.getName()).getString());someCant=true;
else
if(!TaskManagerBeans.get().getSecUtil().isAdminable(AbstractConfigurationsPage.this.getSession().getAuthentication(),config)){error(newParamResourceModel("noDeleteRights",AbstractConfigurationsPage.this,config.getName()).getString());someCant=true;
if(someCant){addFeedbackPanels(target);
else{dialog.setTitle(newParamResourceModel("confirmDeleteDialog.title",getPage()));dialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){privatestaticfinallongserialVersionUID=-5552087037163833563L;privateStringerror=null;privateIModel<Boolean>shouldCleanupModel=newModel<Boolean>();@OverrideprotectedComponentgetContents(Stringid){StringBuildersb=newStringBuilder();sb.append(newParamResourceModel("confirmDeleteDialog.content",getPage()).getString());for(Configurationconfig:configurationsPanel.getSelection()){sb.append("\n&nbsp;&nbsp;");sb.append(escapeHtml(config.getName()));
if(shouldCleanupModel.getObject()){
if(TaskManagerBeans.get().getTaskUtil().canCleanup(config)){
if(TaskManagerBeans.get().getTaskUtil().cleanup(config)){info(newParamResourceModel("cleanUp.success",getPage(),config.getName()).getString());
else{error(newParamResourceModel("cleanUp.failed",getPage(),config.getName()).getString());
else{info(newParamResourceModel("cleanUp.ignore",getPage(),config.getName()).getString());
if(error!=null){error(error);addFeedbackPanels(target);
if(wi==null||!TaskManagerBeans.get().getSecUtil().isAdminable(AbstractConfigurationsPage.this.getSession().getAuthentication(),wi)){copy.setWorkspace(null);
if(property.equals(ConfigurationsModel.NAME)){returnnewSimpleAjaxLink<String>(id,(IModel<String>)property.getModel(itemModel)){privatestaticfinallongserialVersionUID=-9184383036056499856L;@OverrideprotectedvoidonClick(AjaxRequestTargettarget){setResponsePage(newConfigurationPage(itemModel));
if(element.getBatch().getConfiguration()==null&&element.getBatch().isActive()){returnelement;
if(md.storesUpperCaseIdentifiers()){schema=schema.toUpperCase();pattern=pattern.toUpperCase();
if(!method.getName().equals("visit"))continue;
if(method.getParameterTypes().length!=1)continue;Class<?>clazz=method.getParameterTypes()[0];
if(CatalogInfo.class.isAssignableFrom(method.getParameterTypes()[0])){@SuppressWarnings("unchecked")InvocationHandlerhandler=newRemovedObjectProxy("Test","Test",(Class<?extendsCatalogInfo>)clazz);CatalogInfoinfo=(CatalogInfo)Proxy.newProxyInstance(clazz.getClassLoader(),newClass[]{clazz},handler);//Checkthatthemethodiscalledbyacceptwhentheproxyismimickingthe//appropriatetypeCatalogVisitorvisitor=createMock(CatalogVisitor.class);System.err.println(method);method.invoke(visitor,same(info));expectLastCall();replay(visitor);info.accept(visitor);verify(visitor);
if(bill!=null){ugStore.removeUser(bill);ugStore.store();
else{ugStore.load();
if(dataSourceinstanceofHikariDataSource){((HikariDataSource)dataSource).close();
else
if(dataSourceinstanceofSingleConnectionDataSource){try{((SingleConnectionDataSource)dataSource).conn.close();
if(maxConnectionsProp!=null){try{maxConnections=Integer.parseInt(maxConnectionsProp);checkArgument(maxConnections>0,"maxConnectionsmustbeaninteger>0:%s",maxConnections);
if(jdbcUrl.startsWith("jdbc:sqlite")){//sqlitemustbeusedwithasingleconnectionsharedamongallthreadsConnectionconnection;try{connection=DriverManager.getConnection(jdbcUrl);
else{HikariConfigconfig=newHikariConfig();config.setJdbcUrl(jdbcUrl);config.setUsername(username);config.setPassword(password);config.setMaximumPoolSize(maxConnections);dataSource=newHikariDataSource(config);
if(!resource.getType().equals(Resource.Type.UNDEFINED)){return;
if(line.startsWith("#")||line.startsWith("-")||line.isEmpty()){continue;
if(line.endsWith(";")){statements.add(sb.toString());sb.setLength(0);
if("close".equals(method.getName())){returnnull;
ifthecontentanddatatypeistheone//weexpectFeatureIteratorfi=fs.getFeatures().features();SimpleFeaturesf=(SimpleFeature)fi.next();fi.close();//...astringcellCellcell=sheet.getRow(1).getCell(1);assertEquals(Cell.CELL_TYPE_STRING,cell.getCellType());assertEquals(sf.getAttribute(0),cell.getRichStringCellValue().toString());//...ageomcellcell=sheet.getRow(1).getCell(4);assertEquals(Cell.CELL_TYPE_STRING,cell.getCellType());assertEquals(sf.getAttribute(3).toString(),cell.getRichStringCellValue().toString());//...anumbercellcell=sheet.getRow(1).getCell(6);assertEquals(Cell.CELL_TYPE_NUMERIC,cell.getCellType());assertEquals(((Number)sf.getAttribute(5)).doubleValue(),cell.getNumericCellValue());//...adatecell(theyaremappedasnumericinxms?)cell=sheet.getRow(1).getCell(10);assertEquals(Cell.CELL_TYPE_NUMERIC,cell.getCellType());assertEquals(sf.getAttribute(9),cell.getDateCellValue());//...abooleancell(theyaremappedasnumericinxms?)cell=sheet.getRow(1).getCell(12);assertEquals(Cell.CELL_TYPE_BOOLEAN,cell.getCellType());assertEquals(sf.getAttribute(11),cell.getBooleanCellValue());//...anemptycell(originalvalueisnull->nocell)cell=sheet.getRow(1).getCell(3);assertNull(cell);
if(!m.matches()){uName=username;
else{uName=m.group(1).replace("\\@","@");//Stringservice=m.group(2);
if(authentication.getDetails()instanceofGeoServerWebAuthenticationDetails){StringuserGroupServiceName=((GeoServerWebAuthenticationDetails)authentication.getDetails()).getUserGroupServiceName();
if(userGroupServiceName==null||userGroupServiceName.trim().length()==0)return"";//noservicespecified-->noremembermereturnencode(super.retrieveUserName(authentication),userGroupServiceName);
elsereturn"";//noremembermefeaturewithoutausergroupservicename};Stringencode(Stringusername,StringuserGroupServiceName){
if(userGroupServiceName==null){returnusername;
if(username.endsWith("@"+userGroupServiceName)){returnusername;
if(userinstanceofRememberMeUserDetails)user=((RememberMeUserDetails)user).getWrappedObject();Collection<GrantedAuthority>roles=newHashSet<GrantedAuthority>();
if(user.getAuthorities().contains(GeoServerRole.AUTHENTICATED_ROLE)){roles.addAll(user.getAuthorities());
else{roles=newHashSet<GrantedAuthority>();roles.addAll(user.getAuthorities());roles.add(GeoServerRole.AUTHENTICATED_ROLE);
if(layer==null){layer=catalog.getFactory().createLayer();
if(layer.getId()==null){catalog.add(layer);
else{catalog.save(layer);
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine("Incomingevent");
ifproducerisnotEnabled
if(!isEnabled()){
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine("skippingincomingevent:contextisnotinitted");
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE)){LOGGER.severe(e.getLocalizedMessage());
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine("Incomingevent");
ifproducerisnotEnabled
if(!isEnabled()){
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine("skippingincomingevent:contextisnotinitted");
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE)){LOGGER.severe(e.getLocalizedMessage());
ifpossiblelogaboutthereceivedevent
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine(String.format("Incomingservice'%s'modifiedeventoftype'%s'.",event.getSource().getId(),event.getEventType()));
ifproducerisnotenabled
if(!isEnabled()){
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine(String.format("Skippingincomingservice'%s'modifiedeventoftype'%s'sinceproducerisnotenabled.",event.getSource().getId(),event.getEventType()));
ifpossiblelogaboutthereceivedevent
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine(String.format("Incomingsettings'%s'modifiedeventoftype'%s'.",event.getSource().getId(),event.getEventType()));
ifproducerisnotenabled
if(!isEnabled()){
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine(String.format("Skippingincomingsettings'%s'modifiedeventoftype'%s'sinceproducerisnotenabled.",event.getSource().getId(),event.getEventType()));
if(!isEnabled()){
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine("skippingincomingevent:contextisnotinitted");
if(typeNames!=null){
if(typeNames.size()==1){return(QName)typeNames.get(0);
else
if(typeNames.size()>0){thrownewIllegalArgumentException("Multipletypenamesonsinglelocknotsupported");
if(typeNames!=null){typeNames.clear();typeNames.add(typeName);
ifnotconfigured*/privatestaticfinalintEXPAND_LIMIT_MAX_DEFAULT=Integer.getInteger(EXPAND_LIMIT_MAX_KEY,100000);/**Configurationkeyforexpand_limit,
ifnoneisprovided*/publicstaticfinalStringEXPAND_LIMIT_KEY="MD_DOMAIN_EXPAND_LIMIT";/**Defaultvalueforthemaximumallowedvalueofexpand_limit,
ifnotconfigured*/privatestaticfinalintEXPAND_LIMIT_DEFAULT=Integer.getInteger(EXPAND_LIMIT_KEY,1000);publicstaticfinalStringEXPAND_LIMIT="expandLimit";privatefinalFilterFactoryfilterFactory=CommonFactoryFinder.getFilterFactory();privatefinalGeoServergeoServer;privateTileLayerDispatchertileLayerDispatcher;privatefinalWMSwms;privatefinalCatalogcatalog;publicMultiDimensionalExtension(GeoServergeoServer,WMSwms,Catalogcatalog,TileLayerDispatchertileLayerDispatcher){this.geoServer=geoServer;this.wms=wms;this.catalog=catalog;this.tileLayerDispatcher=tileLayerDispatcher;
ifwecanhandlethisrequestStringoperationName=(String)parameters.get("request");returnOperation.match(operationName,request,response,storageBroker,parameters);
if(!(candidateConveyorinstanceofSimpleConveyor)){returnfalse;
switch(conveyor.getOperation()){caseDESCRIBE_DOMAINS:try{executeDescribeDomainsOperation(conveyor);
if(exceptioninstanceofOWSException){throw(OWSException)exception;
if(layerInfo==null){//dimensionarenotsupportedforthislayer(maybeisalayergroup)return;
ifwehaveaspatiallimitationReferencedEnvelopeboundingBox=(ReferencedEnvelope)conveyor.getParameter("bbox",false);//
ifwehaveaboundingboxweneedtosetthecrsbasedonthetilematrixset
if(boundingBox!=null){StringprovidedTileMatrixSet=(String)conveyor.getParameter("tileMatrixSet",true);//gettingthelayergridsetcorrespondingtotheprovidedtilematrixsetGridSubsetgridSubset=tileLayer.getGridSubset(providedTileMatrixSet);
if(gridSubset==null){//theprovidedtilematrixsetisnotsupportedbythislayerthrownewRuntimeException(String.format("Unknowngridset'%s'.",providedTileMatrixSet));
if(restriction!=null){Tuple<String,String>attributes=DimensionsUtils.getAttributes(resource,dimension);filter=appendDomainRestrictionsFilter(filter,attributes.first,attributes.second,restriction);
if(requestedDomains==ALL_DOMAINS||requestedDomains.contains(SPACE_DIMENSION)){spatialDomain=DimensionsUtils.getBounds(resource,filter);
if(clientExpandLimit!=null){Integervalue=Converters.convert(clientExpandLimit,Integer.class);
if(value==null){thrownewOWSException(400,"InvalidParameterValue",EXPAND_LIMIT,"Invalid"+EXPAND_LIMIT+""+"value"+clientExpandLimit+",expectedanintegervalue");
if(value<expandLimitMax){returnvalue;
else{Stringmessage="Clientprovidedaexpandvaluehigherthantheconfiguredmax,usingthe"+"internalvalue(provided/max):"+value+"/"+expandLimitMax;LOGGER.log(Level.INFO,message);response.addHeader(HttpHeaders.WARNING,"299"+message);returnexpandLimitMax;
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Clientdidnotprovideaexpansionlimit,usingtheinternaldefaultvalue:"+expandLimitDefault);
if(limit==null){MetadataMapserviceMetadata=wmts.getMetadata();limit=Optional.ofNullable(serviceMetadata.get(limitKey,Integer.class)).orElse(defaultValue);
if(domains==null){returnALL_DOMAINS;
ifwecangetthelayerinfofromthetilelayer
if(tileLayer!=null&&tileLayerinstanceofGeoServerTileLayer){PublishedInfopublishedInfo=((GeoServerTileLayer)tileLayer).getPublishedInfo();
if(!(publishedInfoinstanceofLayerInfo)){//dimensionsarenotsupportedforlayersgroupsreturnnull;
ifweareinthecontextofavirtualserviceWorkspaceInfolocalWorkspace=LocalWorkspace.get();
if(localWorkspace!=null){//weneedtomakesurethatthelayernameisprefixedwiththelocalworkspacelayerName=CatalogConfiguration.removeWorkspacePrefix(layerName,catalog);layerName=localWorkspace.getName()+":"+layerName;
if(layerInfo==null){//thecatalogisnotawareofthislayer,thereisnothingwecandothrownewServiceException(String.format("Unknownlayer'%s'.",layerName));
ifthelayerdimensionareNULLorempty*nothingwillbedone.*/privatevoidencodeLayerDimensions(XMLBuilderxml,List<Dimension>dimensions)throwsIOException{for(Dimensiondimension:dimensions){//encodeeachdimensionastopelementencodeLayerDimension(xml,dimension);
ifthedimensionisNULLnothingwillbedone.*AlloptionalattributesthatareNULLwillbeignored.*/privatevoidencodeLayerDimension(XMLBuilderxml,Dimensiondimension)throwsIOException{xml.indentElement("Dimension");//identifierismandatoryxml.simpleElement("ows:Identifier",dimension.getDimensionName(),true);//defaultvalueismandatoryxml.simpleElement("Default",dimension.getDefaultValueAsString(),true);intlimit=DimensionsUtils.NO_LIMIT;
if(dimension.getDimensionInfo().getPresentation()!=DimensionPresentation.LIST){//forceittoreturnamin/maxrepresentationlimit=0;
if(props==null||props.isEmpty())return;buff.append(getRoleParameterStartString());booleanfirstTime=true;for(Entry<Object,Object>entry:props.entrySet()){
if(firstTime==true)firstTime=false;
elsebuff.append(getRoleParameterDelimiterString());buff.append(entry.getKey()).append(getRoleParameterAssignmentString());buff.append(entry.getValue()==null?"":entry.getValue());
if(firstTime==true)firstTime=false;
elsebuff.append(getRoleDelimiterString());writeRole(buff,(GeoServerRole)role);
if(index==-1){result.add(theString.substring(startIndex));break;
else{result.add(theString.substring(startIndex,index));startIndex=index+delim.length();
if(role!=null)roles.add(role);
if(roleString==null)returnnull;roleString=roleString.trim();
if(roleString.isEmpty())returnnull;checkDelimiters();List<String>working=splitString(roleString.trim(),getRoleParameterStartString());GeoServerRoleresult=newGeoServerRole(working.get(0));
if(working.size()==1){returnresult;
if(working.get(1).endsWith(getRoleParameterEndString())==false)throwcreateExcpetion(roleString+"doesnotendwith"+getRoleParameterEndString());intindex=working.get(1).lastIndexOf(getRoleParameterEndString());StringroleParamString=working.get(1).substring(0,index).trim();working=splitString(roleParamString,getRoleParameterDelimiterString());for(Stringkvp:working){List<String>tmp=splitString(kvp.trim(),getRoleParameterAssignmentString());
if(tmp.size()!=2)throwcreateExcpetion(roleString+"Invalidrolestring:"+roleString);result.getProperties().put(tmp.get(0).trim(),tmp.get(1).trim());
if(checked)return;
if(roleDelimiterString==null||roleDelimiterString.isEmpty())throwcreateExcpetion("MissingroleDelimiterString");
if(roleParameterDelimiterString==null||roleParameterDelimiterString.isEmpty())throwcreateExcpetion("MissingroleParameterDelimiterString");
if(roleParameterStartString==null||roleParameterStartString.isEmpty())throwcreateExcpetion("MissingroleParameterStartString");
if(roleParameterEndString==null||roleParameterEndString.isEmpty())throwcreateExcpetion("MissingroleParameterEndString");
if(roleParameterAssignmentString==null||roleParameterAssignmentString.isEmpty())throwcreateExcpetion("MissingroleParameterAssignmentString");Set<String>set=newHashSet<String>();set.add(roleDelimiterString);set.add(roleParameterDelimiterString);set.add(roleParameterStartString);set.add(roleParameterEndString);set.add(roleParameterAssignmentString);
if(set.size()<5)throwcreateExcpetion("Delimitersmustbeunique");checked=true;
if(mainProcess){AttributesImplattributes=attributes("version","1.0.0","service","WPS","xmlns:xsi",XSI_URI,"xmlns",WPS_URI,"xmlns:wfs",WFS_URI,"xmlns:wps",WPS_URI,"xmlns:ows",OWS.NAMESPACE,"xmlns:gml",GML.NAMESPACE,"xmlns:ogc",OGC.NAMESPACE,"xmlns:wcs",WCS_URI,"xmlns:xlink",XLINK.NAMESPACE,"xsi:schemaLocation",WPS.NAMESPACE+""+"http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd");start("wps:Execute",attributes);
else{AttributesImplattributes=attributes("version","1.0.0","service","WPS");start("wps:Execute",attributes);
if(value==null||value.value==null){continue;
if(pv.isBoundingBox()){ReferencedEnvelopeenv=(ReferencedEnvelope)value.value;start("wps:Data");Stringcrs=null;
if(env.getCoordinateReferenceSystem()!=null){try{crs="EPSG:"+CRS.lookupEpsgCode(env.getCoordinateReferenceSystem(),false);
if(crs==null){start("wps:BoundingBoxData",attributes("dimensions","2"));
else{start("wps:BoundingBoxData",attributes("crs",crs,"dimensions","2"));
else
if(pv.isComplex()){
if(value.type==ParameterType.TEXT){handleTextInput(value);
else
if(value.type==ParameterType.VECTOR_LAYER){handleVectorInput(value);
else
if(value.type==ParameterType.RASTER_LAYER){handleRasterLayerInput(value);
else
if(value.type==ParameterType.REFERENCE){handleReferenceInput(value);
else
if(value.type==ParameterType.SUBPROCESS){handleSubprocessInput(value);
else{//writeoutawarningwithoutblowingpuchar[]comment="Can'thandlethisdatatypeyet".toCharArray();try{((LexicalHandler)contentHandler).comment(comment,0,comment.length);
else
if(pv.isCoordinateReferenceSystem()){handleCoordinateReferenceSystem(value);
else{start("wps:Data");element("wps:LiteralData",Converters.convert(value.value,String.class));end("wps:Data");
if(raster!=null&&raster.getLayerName()!=null){start("wcs:GetCoverage",attributes("service","WCS","version","1.1.1"));element("ows:Identifier",raster.getLayerName());start("wcs:DomainSubset");ReferencedEnvelopebbox=raster.getSpatialDomain();StringsrsUri=GML2EncodingUtils.toURI(bbox.getCoordinateReferenceSystem());start("ows:BoundingBox",attributes("crs",srsUri));element("ows:LowerCorner",bbox.getMinX()+""+bbox.getMinY());element("ows:UpperCorner",bbox.getMaxX()+""+bbox.getMaxY());end("ows:BoundingBox");end("wcs:DomainSubset");element("wcs:Output",null,attributes("format","image/tiff"));end("wcs:GetCoverage");
ifthelayernameisqualfiiedweshouldincludeanamespacemappingonthe//GetFeaturerequest
if(catalog!=null&&vector.layerName!=null&&vector.layerName.contains(":")){Stringprefix=vector.layerName.split(":")[0];NamespaceInfons=catalog.getNamespaceByPrefix(prefix);
if(ns!=null){atts.addAttribute("","","xmlns:"+prefix,null,ns.getURI());
if(vector.layerName==null){start("wfs:Query");
else{start("wfs:Query",attributes("typeName",vector.layerName));
if(reference.mime!=null){start("wps:Reference",attributes("mimeType",reference.mime,"xlink:href",reference.url,"method",reference.method.toString()));
else{start("wps:Reference",attributes("xlink:href",reference.url,"method",reference.method.toString()));
if(reference.method==ReferenceConfiguration.Method.POST){start("wps:Body");cdata(reference.body);end("wps:Body");
if(data!=null){Documentdocument=parseAsXML(data);
if(document!=null){dumpAsXML(document);
else{try{((LexicalHandler)contentHandler).startCDATA();chars(data);((LexicalHandler)contentHandler).endCDATA();
if(!data.startsWith("<?xml")){data="<?xmlversion=\"1.0\"encoding=\"UTF-16\"?>\n"+data;
ifwehaveasingleoutputwereturnitinrawform,otherwise//goforafulloutputdocument
if(outputs.size()>1){start("wps:ResponseDocument");for(OutputParameterop:outputs){
if(op.isComplex()){
if(op.isComplex()){start("wps:Output",attributes("mimeType",op.mimeType));
else{start("wps:Output");
else
if(outputs.size()==1){OutputParameterop=outputs.get(0);
if(op.isComplex()){start("wps:RawDataOutput",attributes("mimeType",op.mimeType));
else{start("wps:RawDataOutput");
if(data==null){KvpRequestReaderkvpReader=Dispatcher.findKvpRequestReader(GetFeatureType.class);ObjectrequestBean=kvpReader.createRequest();feature=(GetFeatureType)kvpReader.read(requestBean,data.getKvp(),data.getRawKvp());
else{byte[]bytes=data.getPostRequest().getBytes(StandardCharsets.UTF_8.name());ByteArrayInputStreaminput=newByteArrayInputStream(bytes);feature=(GetFeatureType)wfsXmlReader.read(null,newInputStreamReader(input),Collections.emptyMap());
if(!config.isEnabled()){LOGGER.info("jdbcloaderisdisabled");returnconfig;
if(loadConfigFromURL(config)){returnconfig;
if(loadConfigFromSysProps(config)){returnconfig;
if(loadConfigFromDataDir(config)){returnconfig;
if(jdbcUrl!=null){config.setJdbcUrl(jdbcUrl);config.setInitDb(Boolean.getBoolean(replacePrefix(INITDB_SYSPROP)));config.setImport(Boolean.getBoolean(replacePrefix(IMPORT_SYSPROP)));
if(LOGGER.isLoggable(Level.INFO)){StringBuildermsg=newStringBuilder("Configuringjdbcloaderfromsystemproperties:\n");msg.append("").append(replacePrefix(JDBCURL_SYSPROP)).append("=").append(jdbcUrl).append("\n");msg.append("").append(replacePrefix(INITDB_SYSPROP)).append("=").append(config.isInitDb()).append("\n");msg.append("").append(replacePrefix(IMPORT_SYSPROP)).append("=").append(config.isImport()).append("\n");LOGGER.info(msg.toString());
if(propUrl==null){returnfalse;
if(f.canRead()&&f.exists()){url=URLs.fileToUrl(f);
if(url!=null){LOGGER.info("Configuringjdbcloaderfrom"+url.toString());InputStreamin=url.openStream();try{config.load(in);
if(Resources.exists(propFile)){LOGGER.info("Loadingjdbcloaderpropertiesfrom"+propFile.path());InputStreamstream=propFile.in();try{config.load(stream);returntrue;
if(!Resources.exists(target)){IOUtils.copy(scope.getResourceAsStream(scriptName),target.out());
if(!Resources.exists(target)){IOUtils.copy(Thread.currentThread().getContextClassLoader().getResourceAsStream(sampleConfig),target.out());
if(dataDirectory==null){
if(resourceStoreinstanceofGeoServerResourceLoader){dataDirectory=((GeoServerResourceLoader)resourceStore).getBaseDirectory().getAbsolutePath();
else{thrownewIllegalStateException("Datadirectorycouldnotbedetermined.");
if(!writableAttributes.contains(name)){Objectvalue=next.getAttribute(name);
if(value!=null){StringtypeName=getSchema().getName().getLocalPart();
if(response==Response.CHALLENGE){throwSecureCatalogImpl.unauthorizedAccess(typeName);
else{thrownewUnsupportedOperationException("Tryingtowriteonthewriteprotectedattribute"+name);
if(reader!=null){reader.close();
if(reader!=null){reader.close();
if(GeofenceTestUtils.class.getResource("/"+fileName)!=null){Filefile=newFile(GeofenceTestUtils.class.getResource("/"+fileName).toURI());FileWriterwriter=null;try{writer=newFileWriter(file);writer.write("");returnfile;
if(writer!=null){writer.close();
if(!TurboJpegUtilities.isTurboJpegAvailable()){thrownewIllegalStateException(ERROR_LIB_MESSAGE);
if(LOGGER.isLoggable(Level.FINE))LOGGER.fine("EncodinginputimagetowriteoutasJPEGusing.");//gotocomponentcolormodel
ifneededColorModelcm=image.getColorModel();finalbooleanhasAlpha=cm.hasAlpha();forceComponentColorModel();cm=image.getColorModel();//rescaleto8bitrescaleToBytes();cm=image.getColorModel();//removetransparentbandfinalintnumBands=image.getSampleModel().getNumBands();
if(hasAlpha){finalintrequestedBands=numBands-1;
if(ImageUtilities.isMediaLibAvailable()){retainBands(requestedBands);
else
if(getNumBands()>requestedBands){removeAlpha(requestedBands);
if(LOGGER.isLoggable(Level.FINE))LOGGER.fine("CreatingaTURBOJPEGwriterandconfiguringit.");finalTurboJpegImageWriterwriter=(TurboJpegImageWriter)TURBO_JPEG_SPI.createWriterInstance();//CompressionisavailableonbothlibTurboJpegImageWriteParamiwp=(TurboJpegImageWriteParam)writer.getDefaultWriteParam();finalImageOutputStreamAdapter2outStream=newImageOutputStreamAdapter2(destination);iwp.setCompressionMode(ImageWriteParam.MODE_EXPLICIT);iwp.setCompressionType("JPEG");iwp.setCompressionQuality(compressionRate);//Wecancontrolqualityhere.
if(LOGGER.isLoggable(Level.FINE))LOGGER.fine("Writingimageout...");try{writer.setOutput(outStream);writer.write(null,newIIOImage(image,null,null),iwp);
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,e.getLocalizedMessage(),e);
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,e.getLocalizedMessage(),e);
if(hints.containsKey(JAI.KEY_IMAGE_LAYOUT)){layout=(ImageLayout)hints.get(JAI.KEY_IMAGE_LAYOUT);
else{layout=newImageLayout();hints.put(JAI.KEY_IMAGE_LAYOUT,layout);
if(errors==null){this.errorList=Collections.emptyList();
else{this.errorList=Collections.unmodifiableList(newArrayList<RuntimeException>(errors));
if(!isValid()){intn=errorList.size();Stringmsg=errorList.get(0).getMessage();thrownewRuntimeException("Validationfailedwith"+n+"errors.Firsterrormessageis:"+msg);
if(layerType==EoLayerType.BITMASK||layerType==EoLayerType.COVERAGE_OUTLINE){List<StyleInfo>styles=newArrayList<StyleInfo>();for(Stringname:EoStyles.EO_STYLE_NAMES){StyleInfosi=catalog.getStyleByName(name);
if(si!=null){styles.add(si);
else{//TODO:limitthestylestotheonesinthecurrentworkspaceand//globalonesreturncatalog.getStyles();
ifnone*/privatestaticvoidparsePropertyIsLike(StringexpectedLiteral,StringencodedLiteral,BooleanmatchCase)throwsException{StringencodedXml="%3Cfes:Filter"//+"%20xmlns:fes=%22http://www.opengis.net/fes/2.0%22%3E"//+"%3Cfes:PropertyIsLike"//+"%20wildCard=%22*%22"//+"%20singleChar=%22%25%22"//+"%20escapeChar=%22!%22"//+(matchCase==null?"":"%20matchCase=%22"+matchCase+"%22")//+"%3E"//+"%3Cfes:ValueReference%3E"//+"topp:STATE_NAME"//+"%3C/fes:ValueReference%3E"//+"%3Cfes:Literal%3E"//+encodedLiteral//+"%3C/fes:Literal%3E%"//+"3C/fes:PropertyIsLike%3E"//+"%3C/fes:Filter%3E";Stringxml=URLDecoder.decode(encodedXml,"UTF-8");@SuppressWarnings("unchecked")List<Filter>filters=(List<Filter>)newFilter_2_0_0_KvpParser(null).parse(xml);Assert.assertEquals(1,filters.size());PropertyIsLikepropertyIsLike=(PropertyIsLike)filters.get(0);Assert.assertEquals("*",propertyIsLike.getWildCard());Assert.assertEquals("%",propertyIsLike.getSingleChar());Assert.assertEquals("!",propertyIsLike.getEscape());Assert.assertEquals(matchCase==null?true:matchCase,propertyIsLike.isMatchingCase());Assert.assertEquals("topp:STATE_NAME",((PropertyName)propertyIsLike.getExpression()).getPropertyName());Assert.assertEquals(expectedLiteral,propertyIsLike.getLiteral());
if(property==GeofenceRulesModel.BUTTONS){returnnewButtonPanel(id,(ShortRule)itemModel.getObject());
if(location==null||!(location.getComponent().getDefaultModel().getObject()instanceofShortRule)){return;
if(movedRule.getId().equals(targetRule.getId())){return;
if(movedRule.getPriority()<targetRule.getPriority()){movedRule.setPriority(targetRule.getPriority()+1);
else{movedRule.setPriority(targetRule.getPriority());
if(rulesModel.canUp(rule)){tag.put("style","visibility:visible");
else{tag.put("style","visibility:hidden");
if(rulesModel.canDown(rule)){tag.put("style","visibility:visible");
else{tag.put("style","visibility:hidden");
if(times.isEmpty()||times.size()>1){thrownewServiceException("Invalidtimespecification,mustbeasingletime,oratimerange",ServiceException.INVALID_PARAMETER_VALUE,"time");
if(filteredProcesses!=null){clone.setFilteredProcesses(newArrayList<ProcessInfo>(filteredProcesses));
if(metadata!=null){clone.metadata=newMetadataMap(newHashMap<String,Serializable>(metadata));
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;ProcessGroupInfoImplother=(ProcessGroupInfoImpl)obj;
if(enabled!=other.enabled)returnfalse;
if(factoryClass==null){
if(other.factoryClass!=null)returnfalse;
else
if(!factoryClass.equals(other.factoryClass))returnfalse;
if(filteredProcesses==null){
if(other.filteredProcesses!=null)returnfalse;
else
if(!filteredProcesses.equals(other.filteredProcesses))returnfalse;
if(metadata==null){
if(other.metadata!=null)returnfalse;
else
if(!metadata.equals(other.metadata))returnfalse;
if(roles==null){
if(other.roles!=null)returnfalse;
else
if(!roles.equals(other.roles))returnfalse;returntrue;}}
if(selection.size()==0)return;dialog.setTitle(newParamResourceModel("confirmRemoval",this));//
ifthereissomethingtocancel,let'swarntheuseraboutwhat//couldgowrong,and
iftheuseraccepts,let'sdeletewhat'sneededdialog.showOkCancel(target,delegate=newGeoServerDialog.DialogDelegate(){protectedComponentgetContents(Stringid){//showaconfirmationpanelforalltheobjectswehavetoremovereturnremovePanel=newConfirmRemovalServicePanel(id,selection){@OverrideprotectedIModel<String>canRemove(ServiceAccessRuleservice){returnSelectionServiceRemovalLink.this.canRemove(service);
iftheselectionhasbeenclearedoutit'ssignadeletion//occurred,sorefreshthetable
if(services.getSelection().size()==0){setEnabled(false);target.add(SelectionServiceRemovalLink.this);target.add(services);
ifkmlOutput,reprojectrequesttoWGS84(testisdoneindirectlytomakethecodework//shouldKMLnotbe//available)AbstractMapOutputFormatkmlOutputFormat=(AbstractMapOutputFormat)GeoServerExtensions.bean("KMZMapProducer");booleankmlOutput=kmlOutputFormat.getOutputFormatNames().contains(format);
if(kmlOutput){bbox=bbox.transform(DefaultGeographicCRS.WGS84,true);
if(progressListener==null){progressListener=newDefaultProgressListener();
if(kmlOutput){returnbuildKMLResponse(bbox,result,mapContent,operation);
else{RawDataresponse=buildImageResponse(format,result,mapContent,operation);
if(response!=null){returnresponse;
if(encoder.canHandle(operation)){ByteArrayOutputStreambos=newByteArrayOutputStream();encoder.formatImageOutputStream(result,bos,mapContent);//trytobuildanextensionfromtheformat,pleasingWindowsclientsaspossibleStringextension=encoder.getExtension(result,mapContent);returnnewByteArrayRawData(bos.toByteArray(),format,extension);
if(time!=null){template.put("time",time);
if(crs==null){thrownewWPSException("TheBBOXparametermusthaveacoordinatereferencesystem");
else{//handlepossibleaxisflippingbychangingtheWMSversionaccordinglyIntegercode=CRS.lookupEpsgCode(crs,false);
if(CRS.getAxisOrder(crs)==CRS.AxisOrder.EAST_NORTH){template.put("version","1.1.0");template.put("srs","EPSG:"+code);
else{template.put("version","1.3.0");template.put("crs","EPSG:"+code);
if(layer.getCapabilities()==null){RenderedImageMapmap=renderInternalLayer(layer,template);image=map.getImage();map.getMapContext().dispose();
else{image=getImageFromWebMapServer(layer,template,bbox,serverCache);
if(result==null){result=image;
else{result=mergeImage(result,image);
switchtransparencyontoallowoverlayingtemplate.put("transparent","true");//trackprogressandbailout
ifnecessaryprogressListener.progress(95f*(++i)/layers.length);
if(time!=null){//allowtextdecorationtimestampingrequest.getEnv().put("time",time);
if(decorationName!=null){request.setFormatOptions(Collections.singletonMap("layout",decorationName));WMSMapContentcontent=newWMSMapContent(request);try{content.setMapWidth(width);content.setMapHeight(height);content.setTransparent(true);content.getViewport().setBounds(bbox);RenderedImageMapOutputFormatrenderer=newRenderedImageMapOutputFormat(wms);RenderedImageMapmap=renderer.produceMap(content);result=mergeImage(result,map.getImage());
ifweareusing1.3wemightneedtoflipthebbox,
ifversion1.1andthe//originalbboxwasflipped,we'llneedtoun-flip(whatamess...)Integercode=CRS.lookupEpsgCode(bbox.getCoordinateReferenceSystem(),false);CoordinateReferenceSystemepsgOrderCrs=CRS.decode("urn:ogc:def:crs:EPSG:"+code,false);CRS.AxisOrderaxisOrder=CRS.getAxisOrder(epsgOrderCrs);getMap.setSRS("EPSG:"+code);//takesintoaccounttheversionalreadyherebooleanflipNeeded=!template.containsKey("crs")&&newVersion(server.getCapabilities().getVersion()).compareTo(newVersion("1.3.0"))>=0;booleanunflipNeeded=template.containsKey("crs")&&newVersion(server.getCapabilities().getVersion()).compareTo(newVersion("1.3.0"))<0;
if(flipNeeded||unflipNeeded){
if(flipNeeded&&axisOrder==CRS.AxisOrder.NORTH_EAST){getMap.setBBox(bbox.getMinY()+","+bbox.getMinX()+","+bbox.getMaxY()+","+bbox.getMaxX());
else
if(unflipNeeded&&axisOrder==CRS.AxisOrder.NORTH_EAST){getMap.setBBox(bbox.getMinX()+","+bbox.getMinY()+","+bbox.getMaxX()+","+bbox.getMaxY());
if(image==null){thrownewIOException("GetMapfailed:"+getMap.getFinalURL());
if(server==null){HTTPClientclient=httpClientSupplier.get();server=newWebMapServer(newURL(layer.getCapabilities()),client);cache.put(capabilitiesUrl,server);
if(format.toLowerCase().contains("image/png")||"png".equalsIgnoreCase(format)){requestFormat=format;break;
ifwedidnotfindanyformatlookinglikePNGchooseanythatImageIOwouldlikelyread
if(requestFormat==null){for(Stringformat:formats){StringloFormat=format.toLowerCase();
if(loFormat.contains("jpeg")||loFormat.contains("gif")||loFormat.contains("tif")){requestFormat=format;break;
if(requestFormat==null){thrownewWPSException("CouldnotfindasuitableWMScascadingformatamongserversupportedformats:"+formats);
if(!(resultinstanceofBufferedImage)){result=PlanarImage.wrapRenderedImage(result).getAsBufferedImage();
if(exceptions!=null&&exceptions.size()>0){thrownewWPSException("Failedtobuildmapforlayer:"+layer.getName(),exceptions.get(0));
if(service==null){thrownewRuntimeException("CouldnotfindaWMSservice");
ifno<code>RULE</code>parameterwaspassedandthestylehasmorethanone*applicableRulefortheactualscalefactor,therewillbegeneratedalegendgraphicofthe*specifiedwidth,butwithasmanystackedgraphicsasapplicableruleswerefound,providingby*thiswayarepresentativeenoughlegend.**@authorGabrielRoldan*@authorSimoneGiannecchini,GeoSolutionsSAS*@version$Id$*/publicclassBufferedImageLegendGraphicBuilder{LoggerLOGGER=Logger.getLogger("org.geoserver.wms.legendgraphic");/**Toleranceusedtocomparedoublesforequality*/publicstaticfinaldoubleTOLERANCE=1e-6;/***Singletonshapepaintertoservealllegendrequests.Wecanuseasingleshapepainter*instanceaslongasitremainsthreadsafe.*/privatestaticfinalStyledShapePaintershapePainter=newStyledShapePainter();/**usedtocreatesamplepointshapeswithLiteShape(notlinesnorpolygons)*/privatestaticfinalGeometryFactorygeomFac=newGeometryFactory();/***Justaholdertoavoidcreatingmanylineshapesfrominside<code>getSampleShape()</code>*/privateLiteShape2sampleLine;/***Justaholdertoavoidcreatingmanypointshapesfrominside<code>getSampleShape()</code>*/privateLiteShape2samplePoint;/***Defaultminimumsizeforsymbolsrendering.CanbeoverriddenusingLEGEND_OPTIONS*(minSymbolSize).*/privatefinaldoubleMINIMUM_SYMBOL_SIZE=3.0;/***Defaultconstructor.SubclassesmayprovideitsownwithaStringparametertoestablishits*desiredoutputformat,
iftheysupportmorethanone(e.g.aJAIbasedone)*/publicBufferedImageLegendGraphicBuilder(){super();
ifthereareproblemscreatinga"sample"featureinstanceforthe*FeatureType<code>request</code>returnsastherequiredlayer(whichshouldnotoccur).*/publicBufferedImagebuildLegendGraphic(GetLegendGraphicRequestrequest)throwsServiceException{//listofimagestoberenderedforthelayers(morethanone
if//alayergroupisgiven)List<RenderedImage>layersImages=newArrayList<RenderedImage>();List<LegendRequest>layers=request.getLegends();booleanforceLabelsOn=false;booleanforceLabelsOff=false;
if(request.getLegendOptions().get("forceLabels")instanceofString){StringforceLabelsOpt=(String)request.getLegendOptions().get("forceLabels");
if(forceLabelsOpt.equalsIgnoreCase("on")){forceLabelsOn=true;
else
if(forceLabelsOpt.equalsIgnoreCase("off")){forceLabelsOff=true;
if(request.getLegendOptions().get("forceTitles")instanceofString){StringforceTitlesOpt=(String)request.getLegendOptions().get("forceTitles");
if(forceTitlesOpt.equalsIgnoreCase("off")){forceTitlesOff=true;
if(Boolean.TRUE.equals(request.getLegendOption(GetLegendGraphicRequest.COUNT_MATCHED_KEY,Boolean.class))){countProcessor=newFeatureCountProcessor(request);
if(gt2Style==null){thrownewNullPointerException("request.getStyle()");
if(dpi!=standardDpi){doublescaleFactor=dpi/standardDpi;w=(int)Math.round(w*scaleFactor);h=(int)Math.round(h*scaleFactor);DpiRescaleStyleVisitordpiVisitor=newDpiRescaleStyleVisitor(scaleFactor);dpiVisitor.visit(gt2Style);gt2Style=(Style)dpiVisitor.getCopy();
ifwehaveascale
if(request.getScale()>0){doublepixelsPerMeters=RendererUtilities.calculatePixelsPerMeterRatio(request.getScale(),request.getLegendOptions());UomRescaleStyleVisitorrescaleVisitor=newUomRescaleStyleVisitor(pixelsPerMeters);rescaleVisitor.visit(gt2Style);gt2Style=(Style)rescaleVisitor.getCopy();
ifwehavemorethanonelayer,weputatitleontopofeachlayerlegend
if(layers.size()>1&&!forceTitlesOff){titleImage=getLayerTitle(legend,w,h,transparent,request);
if(exp!=null){ProcessFunctionprocessFunction=(ProcessFunction)exp;NameprocessName=processFunction.getProcessName();Map<String,Parameter<?>>outputs=Processors.getResultInfo(processName,null);
if(outputs.isEmpty()){continue;
if(SimpleFeatureCollection.class.isAssignableFrom(output.getType())){hasVectorTransformation=true;break;
else
if(GridCoverage2D.class.isAssignableFrom(output.getType())){hasRasterTransformation=true;break;
if(useProvidedLegend){legendImage=getLayerLegend(legend,w,h,transparent,request);
if(buildRasterLegend){finalRasterLayerLegendHelperrasterLegendHelper=newRasterLayerLegendHelper(request,gt2Style,ruleName);finalBufferedImageimage=rasterLegendHelper.getLegend();
if(image!=null){
if(titleImage!=null){layersImages.add(titleImage);
else
if(useProvidedLegend&&legendImage!=null){
if(titleImage!=null){layersImages.add(titleImage);
else{finalFeaturesampleFeature;
if(layer==null||hasVectorTransformation){sampleFeature=createSampleFeature();
else{sampleFeature=createSampleFeature(layer);
if(ruleName!=null){Rulerule=LegendUtils.getRule(ftStyles,ruleName);
if(rule==null){thrownewServiceException("Specifiedstyledoesnotcontainsarulenamed"+ruleName);
else{applicableRules=LegendUtils.getApplicableRules(ftStyles,scaleDenominator);
if(countProcessor!=null&&!forceLabelsOff){applicableRules=updateRuleTitles(countProcessor,legend,applicableRules);
ifdefined
if(request.getLegendOptions().get("minSymbolSize")instanceofString){StringminSymbolSizeOpt=(String)request.getLegendOptions().get("minSymbolSize");try{minimumSymbolSize=Double.parseDouble(minSymbolSizeOpt);
if(actualMax==actualMin||((actualMin/actualMax)*defaultSize)>minimumSymbolSize){rescaler=size->(size/actualMax)*defaultSize;
else{doublefinalMinimumSymbolSize=minimumSymbolSize;rescaler=size->(size-actualMin)/(actualMax-actualMin)*(defaultSize-finalMinimumSymbolSize)+finalMinimumSymbolSize;
if(graphic!=null){
if(this.samplePoint==null){Coordinatecoord=newCoordinate(w/2,h/2);try{this.samplePoint=newLiteShape2(geomFac.createPoint(coord),null,null,false);
else{for(intsIdx=0;sIdx<symbolizers.length;sIdx++){Symbolizersymbolizer=symbolizers[sIdx];
if(symbolizerinstanceofRasterSymbolizer){//skipit
else{//rescalesymbols
ifneededLiteShape2shape=getSampleShape(symbolizer,w,h,w,h);
if(rescalingRequired&&(symbolizerinstanceofPointSymbolizer||symbolizerinstanceofLineSymbolizer)){doublesize=getSymbolizerSize(estimator,symbolizer,Math.min(w,h)-4);doublenewSize=rescaler.apply(size);symbolizer=rescaleSymbolizer(symbolizer,size,newSize);
else
if(symbolizerinstanceofPolygonSymbolizer){//needtomakeroomforthestrokeinthesymbol,thus,a//smallerrectdoublesymbolizerSize=getSymbolizerSize(estimator,symbolizer,0);intrescaledWidth=(int)Math.ceil(Math.max(minimumSymbolSize,w-symbolizerSize));intrescaledHeight=(int)Math.ceil(Math.max(minimumSymbolSize,h-symbolizerSize));shape=getSampleShape(symbolizer,rescaledWidth,rescaledHeight,w,h);symbolizer=rescaleSymbolizer(symbolizer,w,(double)rescaledWidth);
if(style2d!=null){shapePainter.paint(graphics,shape,style2d,scaleDenominator);
if(image!=null&&titleImage!=null){layersImages.add(titleImage);titleImage=null;
if(!StringUtils.isEmpty(request.getLegendOptions().get("labelMargin"))){labelMargin=Integer.parseInt(request.getLegendOptions().get("labelMargin").toString());
if(ruleCount>0){BufferedImageimage=LegendMerger.mergeLegends(applicableRules,request,options);
if(image!=null){layersImages.add(image);
ifwehavealayergroupBufferedImagefinalLegend=mergeGroups(layersImages,null,request,forceLabelsOn,forceLabelsOff,forceTitlesOff);
if(finalLegend==null){thrownewIllegalArgumentException("nolegendpassed");
if(expr==null){returnnull;
else
if(exprinstanceofLiteral){Doublevalue=expr.evaluate(null,Double.class);returnff.literal(value*scaleFactor);
else{returnff.multiply(expr,ff.literal(scaleFactor));
iffeatureisnull)*@paramfeatureFeaturetobeusedforsizeextractioninexpressions(ifnullasample*FeaturewillbecreatedfromfeatureType)*@paramrulessetofrulestoscanforsymbols*@paramminimumSymbolSizelowerconstraintforthesymbolssize*/privatedouble[]calcSymbolSize(doubledefaultMaxSize,doubledefaultMinSize,FeatureTypefeatureType,Featurefeature,finalRule[]rules){//checkformaxandminsizeinrenderedsymbolsdoubleminSize=defaultMaxSize;doublemaxSize=defaultMinSize;finalintruleCount=rules.length;for(inti=0;i<ruleCount;i++){Featuresample=getSampleFeatureForRule(featureType,feature,rules[i]);MetaBufferEstimatorestimator=newMetaBufferEstimator(sample);finalSymbolizer[]symbolizers=rules[i].getSymbolizers();for(intsIdx=0;sIdx<symbolizers.length;sIdx++){finalSymbolizersymbolizer=symbolizers[sIdx];
if(symbolizerinstanceofPointSymbolizer||symbolizerinstanceofLineSymbolizer){doublesize=getSymbolizerSize(estimator,symbolizer,defaultMaxSize);//alinesymbolizerisdepictedasalineoftherequestedsize,sodon'tgo//belowmin
if(size<minSize&&!(symbolizerinstanceofLineSymbolizer)){minSize=size;
if(size>maxSize){maxSize=size;
if(buffer>0){returnbuffer;
else{returndefaultSize;
ifasampleis*givenininputisreturnedinoutput-
ifasampleisnotgivenininput,scantherule*symbolizerstofindtheonewiththemaxdimensionality,andreturnasampleforthat*dimensionality.**@paramfeatureTypefeatureTypeusedtocreateasample,
ifnoneisgivenasinput*@paramsamplefeaturesampletobereturnedasisinoutput,
ifdefined*@paramrulerulecontainingsymbolizerstoscanformaxdimensionality*/privateFeaturegetSampleFeatureForRule(FeatureTypefeatureType,Featuresample,finalRulerule){Symbolizer[]symbolizers=rule.getSymbolizers();//
ifwedon'thaveasampleasinput,weneedtocreateasampleFeature//lookingattherequestedsymbolizers(wechosetheonewiththemax//dimensionalityandcreateacongruentsample)
if(sample==null){intdimensionality=1;for(intsIdx=0;sIdx<symbolizers.length;sIdx++){finalSymbolizersymbolizer=symbolizers[sIdx];
if(LineSymbolizer.class.isAssignableFrom(symbolizer.getClass())){dimensionality=2;
if(PolygonSymbolizer.class.isAssignableFrom(symbolizer.getClass())){dimensionality=3;
else{returnsample;
if(legendInfo==null){returnnull;//nothingprovidedwillneedtodynamicallygenerate
if(onlineResource==null||onlineResource.isEmpty()){returnnull;//nothingprovidedwillneedtodynamicallygenerate
if(image.getWidth()==w&&image.getHeight()==h){returnimage;
ifthelistisempty*/privateBufferedImagemergeGroups(List<RenderedImage>imageStack,Rule[]rules,GetLegendGraphicRequestreq,booleanforceLabelsOn,booleanforceLabelsOff,booleanforceTitlesOff){LegendMerger.MergeOptionsoptions=LegendMerger.MergeOptions.createFromRequest(imageStack,0,0,0,0,req,forceLabelsOn,forceLabelsOff,forceTitlesOff);options.setLayout(LegendUtils.getGroupLayout(req));returnLegendMerger.mergeGroups(rules,options);
ifanunknownsymbolizerimplwaspassedin.*/privateLiteShape2getSampleShape(Symbolizersymbolizer,intlegendWidth,intlegendHeight,intareaWidth,intareaHeight){LiteShape2sampleShape;finalfloathpad=(areaWidth*LegendUtils.hpaddingFactor)+(areaWidth-legendWidth)/2f;finalfloatvpad=(areaHeight*LegendUtils.vpaddingFactor)+(areaHeight-legendHeight)/2f;;
if(symbolizerinstanceofLineSymbolizer){
if(this.sampleLine==null){Coordinate[]coords={newCoordinate(hpad,legendHeight-vpad-1),newCoordinate(legendWidth-hpad-1,vpad)};LineStringgeom=geomFac.createLineString(coords);try{this.sampleLine=newLiteShape2(geom,null,null,false);
else
if((symbolizerinstanceofPolygonSymbolizer)||(symbolizerinstanceofRasterSymbolizer)){finalfloatw=areaWidth-(2*hpad)-1;finalfloath=areaHeight-(2*vpad)-1;Coordinate[]coords={newCoordinate(hpad,vpad),newCoordinate(hpad,vpad+h),newCoordinate(hpad+w,vpad+h),newCoordinate(hpad+w,vpad),newCoordinate(hpad,vpad)};LinearRingshell=geomFac.createLinearRing(coords);Polygongeom=geomFac.createPolygon(shell,null);try{returnnewLiteShape2(geom,null,null,false);
else
if(symbolizerinstanceofPointSymbolizer||symbolizerinstanceofTextSymbolizer){
if(this.samplePoint==null){Coordinatecoord=newCoordinate(legendWidth/2d,legendHeight/2d);try{this.samplePoint=newLiteShape2(geomFac.createPoint(coord),null,null,false);
else{thrownewIllegalArgumentException("Unknownsymbolizer:"+symbolizer);
if(schemainstanceofSimpleFeatureType){schema=cloneWithDimensionality(schema,dimensionality);
if(isMixedGeometry(desc)){GeometryDescriptorgeomDescriptor=(GeometryDescriptor)desc;GeometryTypegeomType=geomDescriptor.getType();Class<?>geometryClass=getGeometryForDimensionality(dimensionality);GeometryTypegt=newGeometryTypeImpl(geomType.getName(),geometryClass,geomType.getCoordinateReferenceSystem(),geomType.isIdentified(),geomType.isAbstract(),geomType.getRestrictions(),geomType.getSuper(),geomType.getDescription());builder.add(newGeometryDescriptorImpl(gt,geomDescriptor.getName(),geomDescriptor.getMinOccurs(),geomDescriptor.getMaxOccurs(),geomDescriptor.isNillable(),geomDescriptor.getDefaultValue()));
else{builder.add(desc);
if(dimensionality==1){returnPoint.class;
if(dimensionality==2){returnLineString.class;
if(schemainstanceofSimpleFeatureType){
if(hasMixedGeometry((SimpleFeatureType)schema)){//wecan'tcreateasampleforagenericGeometrytypesampleFeature=null;
else{sampleFeature=SimpleFeatureBuilder.template((SimpleFeatureType)schema,null);
else{sampleFeature=DataUtilities.templateFeature(schema);
ifthegivenschemacontainsaGeometryDescriptorthathasagenericGeometrytype.**@paramschema*/privatebooleanhasMixedGeometry(SimpleFeatureTypeschema){for(AttributeDescriptorattDesc:schema.getAttributeDescriptors()){
if(isMixedGeometry(attDesc)){returntrue;
ifthegivenAttributeDescriptordescribesagenericGeometry.**@paramattDesc*/privatebooleanisMixedGeometry(AttributeDescriptorattDesc){
if(attDescinstanceofGeometryDescriptor&&attDesc.getType().getBinding()==Geometry.class){returntrue;
if(previous!=null){cat.remove(cat.getLayerByName("waterView"));cat.remove(previous);
if(connection==null)connection=super.getConnection();returnconnection;
if(connection!=null){connection.close();connection=null;
if(user.getProperties().size()==0)return;//nothingtodoPreparedStatementps=getDMLStatement("userprops.insert",con);try{for(Objectkey:user.getProperties().keySet()){ObjectpropertyVal=user.getProperties().get(key);ps.setString(1,user.getUsername());ps.setString(2,key.toString());ps.setObject(3,propertyVal);ps.execute();
if(PasswordValidatorImpl.passwordStartsWithEncoderPrefix(passwordArray)!=null)return;//donothing,passwordalreadyencoded//wehaveaplaintextpassword//validateitgetSecurityManager().loadPasswordValidator(getPasswordValidatorName()).validatePassword(passwordArray);//validationok,initializerencoderandsetencodedpasswordGeoServerPasswordEncoderenc=getSecurityManager().loadPasswordEncoder(getPasswordEncoderName());enc.initializeFor(this);user.setPassword(enc.encodePassword(user.getPassword(),null));
if(user.getPassword()!=null){ps.setString(2,user.getPassword());
else{ps.setNull(2,Types.VARCHAR);
if(SystemUtils.IS_OS_WINDOWS){//sillyIknow,butunderWindowsnotevencommonscandetect
ifadirectory//wasreallyremoved...longstart=System.currentTimeMillis();while(directory.exists()&&(System.currentTimeMillis()-start)<10000){//wedoaquietremovebecauseduringthedeletionafilecanbereported//asexisting,andthendisappearbeforeJavacantrytoremoveit...FileUtils.deleteQuietly(directory);
if(directory.exists()){thrownewIOException("Couldnotremovedirectory"+directory.getPath()+"afterrepeatedattempts");
else{//aaah,sanityFileUtils.deleteDirectory(directory);
if(Resources.isHidden(f)||f.getType()==Type.DIRECTORY){continue;
if(hook==null){LOGGER.fine("Skipping"+f.name()+",nohookfound");
else{//thebasenameistheprocessname,thenamespacedependsonthe//conditionNameImplname=newNameImpl(getScriptNamespace(f),getBaseName(f.name()));
if(names.contains(name)){thrownewRuntimeException("Script"+f.path()+"conflictswithanalreadyexistingprocessnamed"+name);
if(Resources.isHidden(directory)||directory.getType()!=Type.DIRECTORY){continue;
ifprocesshasnodescription(WPS*specsaysprocessabstractisoptional).*/publicInternationalStringgetDescription(Namename){Stringdesc;try{desc=process(name).getDescription();
if(process==null){synchronized(this){process=processes.get(name);
if(process==null){try{ScriptManagerscriptMgr=scriptMgr();//see
iftheprocessisarootleveloneStringlocalName=name.getLocalPart();Stringnamespace=name.getNamespaceURI();Resourcef=scriptMgr.wps().get(localName+"."+namespace);
if(!Resources.exists(f)){//see
ifit'snestedinadirectorythenResourcedirectory=scriptMgr.wps().get(namespace);
if(!Resources.exists(directory)){thrownewFileNotFoundException("Couldnotfindscriptfile"+f.name()+"noradirectoryofscriptsnamed"+directory.name());
if(Resources.isHidden(file)||file.getType()!=Type.RESOURCE){continue;
if(localName.equals(getBaseName(file.name()))){script=file;
if(script==null){thrownewFileNotFoundException("Couldnotfindscriptfile"+f.name()+"norascriptnamed"+localName+"inthe"+directory.name()+"sub-directory");
if(mime.startsWith("image")&&idx>=0&&idx<mime.length()-1){extension=mime.substring(idx+1);
if(value==null||(valueinstanceofCollection&&((Collection)value).isEmpty())||(valueinstanceofMap&&((Map)value).isEmpty())){continue;
if(valueinstanceofEObject&&(level<3)){log.append(property.getName());log.append(":");log((EObject)value,level+1,log);
else
if(valueinstanceofCollection){log(property.getName(),(Collection)value,level+1,log);
else{log.append(property.getName());log.append("="+value);
if(oinstanceofEObject){log.append(pc);log.append(":");log((EObject)o,level,log);
else
if(oinstanceofCollection){log(pc,(Collection)o,level+1,log);
else{log.append(pc).append("="+o);
if(cf==null){thrownewIllegalStateException("UnabletoloadaconnectionFactory");
if(jmsTopic==null){thrownewIllegalStateException("UnabletoloadaJMSdestination");
if(entry.getName().endsWith(".asc")){ArcGridFormatformat=newArcGridFormat();GridCoverage2Dgc=format.getReader(is).read(null);assertTrue(newEnvelope(-145.4,145.6,-41.8,-42.1).contains(newReferencedEnvelope(gc.getEnvelope())));double[]valueInside=(double[])gc.evaluate(newDirectPosition2D(145.55,-42));assertEquals(615.0,valueInside[0],1E-12);double[]valueOutside=(double[])gc.evaluate(newDirectPosition2D(145.57,-41.9));//thisshouldreallybeNoData...(-9999&0xFFFF)assertEquals(55537.0,valueOutside[0],1E-12);gc.dispose(true);arcGridFound=true;
if(x==145.55&&y==-42&&!valueInsideFound){assertEquals(550.0,value,1E-12);valueInsideFound=true;
if(x==145.57&&y==-41.9&&!valueOutsideFound){assertEquals(55537.0,value,1E-12);valueOutsideFound=true;
ifthedownloadrequestdoesnotexceedsthe*definedlimits.**@author"AlessioFabiani-alessio.fabiani@geo-solutions.it"*/@DescribeProcess(title="EstimatorProcess",description="Checks
iftheinputfiledoesnotexceedthelimits")publicclassDownloadEstimatorProcessimplementsGSProcess{/**TheConstantLOGGER.*/privatestaticfinalLoggerLOGGER=Logging.getLogger(DownloadEstimatorProcess.class);privateDownloadServiceConfigurationGeneratordownloadServiceConfigurationGenerator;/**Thecatalog.*/privatefinalCatalogcatalog;/***@paramreadLimits*@paramwriteLimits*@paramhardOutputLimit*@paramgeoserver*/publicDownloadEstimatorProcess(DownloadServiceConfigurationGeneratordownloadServiceConfigurationGenerator,GeoServergeoserver){this.catalog=geoserver.getCatalog();this.downloadServiceConfigurationGenerator=downloadServiceConfigurationGenerator;
iftherequesteddownloaddoesnot*exceedtheimposedlimits,
ifpresent**@paramlayerNamethelayername*@paramfilterthefilter*@paramemailtheemail*@paramoutputFormattheoutputformat*@paramtargetCRSthetargetcrs*@paramroiCRStheroicrs*@paramroitheroi*@paramclipthecroptogeometry*@paramtargetSizeXthesizeofthetargetimagealongtheXaxis*@paramtargetSizeYthesizeofthetargetimagealongtheYaxis*@parambandIndicesthebandindicesselectedforoutput,incaseofrasterinput*@paramprogressListenertheprogresslistener*@returntheboolean*/@DescribeResult(name="result",description="DownloadLimitsarerespectedornot!")publicBooleanexecute(@DescribeParameter(name="layerName",min=1,description="Originallayertodownload")StringlayerName,@DescribeParameter(name="filter",min=0,description="OptionalVectorialFilter")Filterfilter,@DescribeParameter(name="targetCRS",min=0,description="TargetCRS")CoordinateReferenceSystemtargetCRS,@DescribeParameter(name="RoiCRS",min=0,description="RegionOfInterestCRS")CoordinateReferenceSystemroiCRS,@DescribeParameter(name="ROI",min=0,description="RegionOfInterest")Geometryroi,@DescribeParameter(name="cropToROI",min=0,description="CroptoROI")Booleanclip,@DescribeParameter(name="targetSizeX",min=0,minValue=1,description="XSizeoftheTargetImage(appliestorasterdataonly)")IntegertargetSizeX,@DescribeParameter(name="targetSizeY",min=0,minValue=1,description="YSizeoftheTargetImage(appliestorasterdataonly)")IntegertargetSizeY,@DescribeParameter(name="selectedBands",description="BandSelectionIndices",min=0)int[]bandIndices,ProgressListenerprogressListener)throwsException{////initialchecksonmandatoryparams////layername
if(layerName==null||layerName.length()<=0){thrownewIllegalArgumentException("EmptyornulllayerNameprovided!");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Estimatorprocesscalledonresource:"+layerName);
if(clip==null){clip=false;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Clippingdisabled");
if(roi!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"ROIpresent");
if(roiCRS==null){thrownewIllegalArgumentException("ROIwithoutaCRSisnotusable!");
if(layerInfo==null){//couldnotfindanylayer...abruptlyinterrupttheprocessthrownewIllegalArgumentException("Unabletolocatelayer:"+layerName);
if(resourceInfo==null){//couldnotfindanydatastoreassociatedtothespecifiedlayer...abruptly//interrupttheprocessthrownewIllegalArgumentException("UnabletolocateResourceInfoforlayer:"+layerName);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Gettingconfigurationlimits");
if(resourceInfoinstanceofFeatureTypeInfo){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"WorkingwithVectorialdataset");
else
if(resourceInfoinstanceofCoverageInfo){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"WorkingwithRasterdataset");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"WorkingwithawrongResource");
ifpresent
if(progressListener!=null){progressListener.exceptionOccurred(ex);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;AbstractRawDataother=(AbstractRawData)obj;
if(extension==null){
if(other.extension!=null)returnfalse;
else
if(!extension.equals(other.extension))returnfalse;
if(mimeType==null){
if(other.mimeType!=null)returnfalse;
else
if(!mimeType.equals(other.mimeType))returnfalse;returntrue;
if(p.metadata!=null&&p.metadata.get(MIME_TYPES)!=null){StringmimeTypes=(String)p.metadata.get(MIME_TYPES);
if(!mimeTypes.trim().isEmpty()){returnmimeTypes.split("\\s*,\\s*");
if(RawData.class.isAssignableFrom(p.getType())){Stringattribute=(String)p.metadata.get(SELECTION_ATTRIBUTE);
if(attribute!=null){
if(result.containsValue(attribute)){LOGGER.warning("Inprocess"+processName+"tworawresultsparameterareusingthesameinputattribute"+attribute+"tonotifytheprocessoftheuserchosenmimetype");
else{result.put(p.key,attribute);
if(parameter==null){LOGGER.warning("Lookeduprawresult"+resultName+"inprocess"+processName+"butfoundnone,returneddefaultmimetype");returnBINARY_MIME;
if(store==null){returnCollections.emptyList();
iftheBlobStorehasbeenconfigured*/privateAtomicBooleanconfigured;/**Mapcontainingmappingfor{@linkCacheConfiguration}sassociatedtoeachCacheProvider*/privateMap<String,CacheConfiguration>internalCacheConfigs;/**Mapcontainingmappingfor{@linkCacheProvider}names*/privateMap<String,String>cacheProvidersNames;/**Mapcontainingmappingfor{@linkCacheProvider}s*/privateMap<String,CacheProvider>cacheProviders;/**Savethelistenerstore-applythemtothedelegateblobstoreuponconfigchanges*/privateBlobStoreListenerListlisteners=newBlobStoreListenerList();publicConfigurableBlobStore(BlobStoredefaultStore,MemoryBlobStorememoryStore,NullBlobStorenullStore){//Initializationconfigured=newAtomicBoolean(false);actualOperations=newAtomicLong(0);this.delegate=defaultStore;this.defaultStore=defaultStore;this.memoryStore=memoryStore;this.nullStore=nullStore;//Creatingthreemaps://1containingamappingkey-cacheProvider//2containingamappingkey-cacheProviderdescription//3containingamappingkey-cacheConfiguration//wherekeyisthecacheProviderclassnameHashMap<String,CacheProvider>cacheProviders=newHashMap<String,CacheProvider>();HashMap<String,String>cacheProvidersNames=newHashMap<String,String>();List<CacheProvider>extensions=GeoServerExtensions.extensions(CacheProvider.class);for(CacheProviderprovider:extensions){
if(provider.isAvailable()){cacheProviders.put(provider.getClass().toString(),provider);cacheProvidersNames.put(provider.getClass().toString(),provider.getName());
iftheblobstorehasalreadybeenconfigured,theusermust//alwayscallsetConfig()for//settingthenewconfiguration
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//DeletetheselectedLayerreturndelegate.delete(layerName);
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//DeletetheTileObjectsrelatedtotheselectedgridsetreturndelegate.deleteByGridsetId(layerName,gridSetId);
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//DeletesthesingleTileObjectreturndelegate.delete(obj);
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//DeletesthisTileRangereturndelegate.delete(obj);
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//GetaTileObjectreturndelegate.get(obj);
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//PuttheTileObjectdelegate.put(obj);
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//CleartheBlobStoredelegate.clear();
if(configured.getAndSet(false)){//AvoidtocalltheWhilecyclebeforehavingstartedanoperation//withconfigured==trueactualOperations.incrementAndGet();actualOperations.decrementAndGet();//Waituntilalltheoperationsarefinishedwhile(actualOperations.get()>0){}//Destroyallsuper.destroy();delegate.destroy();cache.reset();
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//AddanewListenertotheNullBlobStoredelegate.addListener(listener);
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//RemoveaListenerfromtheBlobStorereturndelegate.removeListener(listener);
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//RenameaLayerreturndelegate.rename(oldLayerName,newLayerName);
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//GetTheLayermetadatareturndelegate.getLayerMetadata(layerName,key);
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//PuttheLayermetadatadelegate.putLayerMetadata(layerName,key,value);
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//GetCacheStatisticsreturncache.getStatistics();
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//Clearthecachecache.clear();
iftheblobstorehasalreadybeenconfigured
if(configured.get()){//Incrementthenumberofcurrentoperations//Thisbehaviorisusedinordertowait//theendofalltheoperationsaftersetting//theconfiguredparametertofalseactualOperations.incrementAndGet();try{//Returnsthecacheobjectusedreturncache;
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("ConfiguringBlobStore");
ifitispresent,
elseusetheGuavaCacheProviderasdefault
if(!getCacheProviders().containsKey(cacheProvider)){
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("WrongCacheProviderdefined,usingdefaultone");
if(!initialization){gwcConfig.setCacheProviderClass(cacheProvider);try{GWC.get().saveConfig(gwcConfig);
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.log(Level.SEVERE,e.getMessage(),e);
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("Configuringcache");
iftheCacheProvidercanbemodified
if(!cache.isImmutable()){CacheConfigurationinternalCacheConfig=internalCacheConfigs.get(cacheProvider);
if(internalCacheConfig==null){internalCacheConfig=newCacheConfiguration();internalCacheConfig.setConcurrencyLevel(cacheConfiguration.getConcurrencyLevel());internalCacheConfig.setEvictionTime(cacheConfiguration.getEvictionTime());internalCacheConfig.setHardMemoryLimit(cacheConfiguration.getHardMemoryLimit());internalCacheConfig.setPolicy(cacheConfiguration.getPolicy());cache.configure(cacheConfiguration);internalCacheConfigs.put(cacheProvider,internalCacheConfig);
else
if(!internalCacheConfig.equals(cacheConfiguration)){internalCacheConfig.setConcurrencyLevel(cacheConfiguration.getConcurrencyLevel());internalCacheConfig.setEvictionTime(cacheConfiguration.getEvictionTime());internalCacheConfig.setHardMemoryLimit(cacheConfiguration.getHardMemoryLimit());internalCacheConfig.setPolicy(cacheConfiguration.getPolicy());cache.configure(internalCacheConfig);
if(!initialization){Iterable<GeoServerTileLayer>geoServerTileLayers=GWC.get().getGeoServerTileLayers();for(GeoServerTileLayerlayer:geoServerTileLayers){
if(layer.getInfo().isEnabled()&&!layer.getInfo().isInMemoryCached()){cache.addUncachedLayer(layer.getName());
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("ConfiguringBlobStoredelegate");
if(gwcConfig.isInnerCachingEnabled()){memoryStore.setCacheProvider(cache);
if(!gwcConfig.isPersistenceEnabled()){memoryStore.setStore(nullStore);
else{memoryStore.setStore(defaultStore);
else{delegate=defaultStore;
if(gridSet!=null){//thisgridsetalreadyexistsreturn;
if(data!=null){this.baseDirectory=newFile(data);
else{thrownewIllegalStateException("Unabletodeterminedatadirectory");
iftheurlisinvalidforuseasaLink*@paramurl*/publicstaticvoidvalidate(Stringurl){
if(url==null)return;URLdummy;try{dummy=newURL("http://dummy/");
if(!protocols.contains(protocol)){thrownewIllegalArgumentException("Protocol"+protocol+"isnotsupportedinurl"+url);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofDataLinkInfo)){returnfalse;
if(about==null){
if(other.getAbout()!=null)returnfalse;
else
if(!about.equals(other.getAbout()))returnfalse;
if(content==null){
if(other.getContent()!=null)returnfalse;
else
if(!content.equals(other.getContent()))returnfalse;
if(type==null){
if(other.getType()!=null)returnfalse;
else
if(!type.equals(other.getType()))returnfalse;returntrue;
if(property==LayerGroupProvider.NAME){returncreateLayerGroupLink(id,itemModel);
if(property==LayerGroupProvider.WORKSPACE){returncreateWorkspaceLink(id,itemModel);
if(!getSelection().isEmpty()){
if(!isAuthenticatedAsAdmin()){//
ifanygloballayergroupsareselected,don'talloweditfor(LayerGroupInfolg:getSelection()){
if(lg.getWorkspace()==null){canEdit=false;break;
else{canEdit=false;
if(editSelectionLinks!=null){for(AbstractLinklink:editSelectionLinks){link.setEnabled(canEdit);target.add(link);
if(wsName!=null){returnnewSimpleBookmarkableLink(id,WorkspaceEditPage.class,newModel(wsName),"name",wsName);
else{returnnewWebMarkupContainer(id);
if(!selector.allowProcess(name)){it.remove();
if(selector.allowProcess(name)){returndelegate.create(name);
else{returnnull;
if(selector.allowProcess(name)){returndelegate.getDescription(name);
else{returnnull;
if(selector.allowProcess(name)){returndelegate.getParameterInfo(name);
else{returnnull;
if(selector.allowProcess(name)){returndelegate.getResultInfo(name,parameters);
else{returnnull;
if(selector.allowProcess(name)){returndelegate.getTitle(name);
else{returnnull;
if(selector.allowProcess(name)){returndelegate.getVersion(name);
else{returnnull;
if(selector.allowProcess(name)){returndelegate.supportsProgress(name);
else{returnfalse;
if(((GetDomainType)request).getParameterName()!=null&&!((GetDomainType)request).getParameterName().isEmpty()){StringparameterNameElement="csw:ParameterName";element(parameterNameElement,((GetDomainType)request).getParameterName());
else
if(((GetDomainType)request).getPropertyName()!=null&&!((GetDomainType)request).getPropertyName().isEmpty()){StringpropertyNameElement="csw:PropertyName";element(propertyNameElement,((GetDomainType)request).getPropertyName());
if(value!=null){attributes.addAttribute("",name,name,"",valueinstanceofString?(String)value:String.valueOf(value));
if(canonicalSchemaLocation){returnCSW_ROOT_LOCATION+schema;
else{returnbuildSchemaURL(request.getBaseUrl(),"csw/2.0.2/"+schema);
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("lookingatfeatureId"+fid);
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("addingtypename:"+typeName+"fromfid");
ifthelistisunspecified(ie.isnull)orisunconstrained(ie.is''),*thenthemethodreturnsanemptylist.**@paramrawListThetokenizedstring.*@paramdelimiterThedelimeterforthestringtokens.*@returnAlistofthetokenizedstring.*/protectedstaticListreadFlat(StringrawList,Stringdelimiter){returnKvpUtils.readFlat(rawList,delimiter);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("cleanrequestis"+cleanRequest);
if(kvpPair.toUpperCase().startsWith("FILTER")){StringfilterVal=kvpPair.substring(7);//intindex=filterVal.lastIndexOf("</Filter>");//Stringfilt2=kvpPair.subString
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("puttingfiltervalue"+filterVal);
else
if(kvpPair.toUpperCase().startsWith("SLD_BODY")){StringsldBodyVal=kvpPair.substring(9);kvps.put("SLD_BODY",sldBodyVal);
else{//handlesallotherstandardcasesbylookingforthecorrect//delimeterandthenstickingtheKVPsintothehashtableStringTokenizerrequestValues=newStringTokenizer(kvpPair,VALUE_DELIMITER);//makesurethatthereisakeytoken
if(requestValues.hasMoreTokens()){//assignkeyasuppercasetoeliminatecaseconflictkey=requestValues.nextToken().toUpperCase();//makesurethatthereisavaluetoken
if(requestValues.hasMoreTokens()){//assignvalueandstoreinhashwithkeyvalue=requestValues.nextToken();LOGGER.finest("puttingkvppair:"+key+":"+value);kvps.put(key,value);
else{kvps.put(key,"");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("returningparsed"+kvps);
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("rawrequest:"+raw);
if(raw!=null){try{clean=java.net.URLDecoder.decode(raw,"UTF-8");
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Badencodingfordecoder"+e);
else{return"";
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("cleanedrequest:"+raw);
ifthevalueoftheBBOXrequestparametercan'tbeparsedasfour*<code>double</code>'s*/protectedEnvelopeparseBbox(StringbboxParam)throwsServiceException{Envelopebbox=null;Object[]bboxValues=readFlat(bboxParam,INNER_DELIMETER).toArray();
if(bboxValues.length!=4){thrownewServiceException(bboxParam+"isnotavalidpairofcoordinates",getClass().getName());
if(minx>maxx){thrownewServiceException("illegalbbox,minX:"+minx+"is"+"greaterthanmaxX:"+maxx);
if(miny>maxy){thrownewServiceException("illegalbbox,minY:"+miny+"is"+"greaterthanmaxY:"+maxy);
if(next.trim().equals("")){filters.add(Filter.INCLUDE);
else{filters.add(parseXMLFilter(newStringReader(next)));
if(e.getException()!=null&&e.getCause()==null){e.initCause(e.getException());
if(groups.contains(group.getGroupname())){returngroup;
if(userGroups.isEmpty()){return;
if(!groups.contains(userGroup.getGroupname())){Stringmsg=newUserGroupServiceException(USER_IN_OTHER_GROUP_NOT_MODIFIABLE_$1,newObject[]{user}).getMessage();thrownewIOException(msg);
if(archiveFile==null){LOGGER.log(Level.WARNING,"Couldnotfindsourcearchivefile.");
else{Stringjson="{\"restore\":{"+"\"archiveFile\":\""+archiveFile.path()+"\","+"\"options\":{\"option\":[\"BK_DRY_RUN=true\",\"BK_BEST_EFFORT=true\"]}"+"}"+"}";JSONObjectrestore=postNewRestore(json);Assert.notNull(restore);JSONObjectexecution=readExecutionStatus(restore.getJSONObject("execution").getLong("id"));assertTrue("STARTED".equals(execution.getString("status"))||"STARTING".equals(execution.getString("status")));while("STARTED".equals(execution.getString("status"))||"STARTING".equals(execution.getString("status"))){execution=readExecutionStatus(execution.getLong("id"));Thread.sleep(100);
if(request.getServletPath().equalsIgnoreCase("/geofence")){
if(!SecurityContextHolder.getContext().getAuthentication().getAuthorities().contains(GeoServerRole.ADMIN_ROLE)){thrownewAccessDeniedException("Youmustbeadministrator.");
if(visitor.hasLimits()){counter.incrementAndGet();
if(fieldFilter!=null){xml=xml+"<ogc:Filter>\n"+"<ogc:PropertyIsLikewildCard=\"*\"singleChar=\"?\"escape=\"\\\\\"matchCase=\"false\">\n"+"<ogc:PropertyName>"+fieldName+"</ogc:PropertyName>\n"+"<ogc:Literal>"+fieldFilter+"</ogc:Literal>\n"+"</ogc:PropertyIsLike>\n"+"</ogc:Filter>\n";
if(sort!=null){xml=xml+"<ogc:SortBy>\n"+"<ogc:SortProperty>\n"+"<ogc:PropertyName>"+fieldName+"</ogc:PropertyName>\n"+"<ogc:SortOrder>"+sort+"</ogc:SortOrder>\n"+"</ogc:SortProperty>\n"+"</ogc:SortBy>\n";
if(startIndex!=null){xml=xml+"<wps:Input>\n"+"<ows:Identifier>startIndex</ows:Identifier>\n"+"<wps:Data>\n"+"<wps:LiteralData>"+startIndex+"</wps:LiteralData>\n"+"</wps:Data>\n"+"</wps:Input>\n";
if(maxFeatures!=null){xml=xml+"<wps:Input>\n"+"<ows:Identifier>maxFeatures</ows:Identifier>\n"+"<wps:Data>\n"+"<wps:LiteralData>"+maxFeatures+"</wps:LiteralData>\n"+"</wps:Data>\n"+"</wps:Input>\n";
iffoundorthepassedone(localized)*/publicstaticWorkspaceInfolocalizeWorkspace(finalWorkspaceInfoinfo,finalCatalogcatalog){
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");finalWorkspaceInfolocalObject=catalog.getWorkspaceByName(info.getName());
if(localObject!=null){returnlocalObject;
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");finalNamespaceInfolocalObject=catalog.getNamespaceByURI(info.getURI());
if(localObject!=null){returnlocalObject;
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");finalStyleInfolocalObject=catalog.getStyleByName(info.getWorkspace(),info.getName());
if(localObject!=null){returnlocalObject;
else{
if(LOGGER.isLoggable(java.util.logging.Level.INFO)){LOGGER.info("Nosuchstylecalled\'"+info.getName()+"\'canbefound:LOCALIZATION");
if(stileSet==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");finalSet<StyleInfo>localStileSet=newHashSet<StyleInfo>();finalIterator<StyleInfo>deserStyleSetIterator=stileSet.iterator();while(deserStyleSetIterator.hasNext()){finalStyleInfodeserStyle=deserStyleSetIterator.next();finalStyleInfolocalStyle=localizeStyle(deserStyle,catalog);
if(localStyle!=null){localStileSet.add(localStyle);
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");finalList<LayerInfo>localLayerList=newArrayList<LayerInfo>(info.size());finalIterator<LayerInfo>it=localLayerList.iterator();while(it.hasNext()){finalLayerInfolayer=it.next();finalLayerInfolocalLayer=localizeLayer(layer,catalog);
if(localLayer!=null){localLayerList.add(localLayer);
else{
if(LOGGER.isLoggable(java.util.logging.Level.WARNING)){LOGGER.warning("Nosuchlayercalled\'"+layer.getName()+"\'canbefound:SKIPPING");
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");//makesureweusetheprefixednametoincludetheworkspacefinalLayerInfolocalObject=catalog.getLayerByName(info.prefixedName());
if(localObject!=null){returnlocalObject;
if(resource!=null){resource=localizeResource(resource,catalog);
else{thrownewNullPointerException("Noresourcefound!!!");
if(deserDefaultStyle!=null){finalStyleInfolocalDefaultStyle=localizeStyle(deserDefaultStyle,catalog);
if(localDefaultStyle==null){thrownewNullPointerException("Nomatchingstylecalled\'"+deserDefaultStyle.getName()+"\'foundlocally.");
else{//thedefaultstyleissetbythebuilder//TODO:check:thishappenswhenconfiguringalayerusingGeoServerRESTmanager(see//ImageMosaicTest)
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");finalMapInfolocalObject=catalog.getMapByName(info.getName());
if(localObject!=null){returnlocalObject;//
elseobjectismodified:continuewithlocalization
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");//makesureweusetheprefixednametoincludetheworkspacefinalLayerGroupInfolocalObject=catalog.getLayerGroupByName(info.prefixedName());
if(localObject!=null){returnlocalObject;
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(e.getLocalizedMessage());throwe;
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(e.getLocalizedMessage());throwe;
if(layers!=null){for(PublishedInfolayer:layers){
if(layerinstanceofLayerInfo){ResourceInforesource=((LayerInfo)layer).getResource();
if(resource==null){continue;
if(storeinstanceofStoreInfoImpl){//settingthecatalog((StoreInfoImpl)store).setCatalog(catalog);
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");
if(infoinstanceofCoverageStoreInfo){returnlocalizeCoverageStore((CoverageStoreInfo)info,catalog);
else
if(infoinstanceofDataStoreInfo){returnlocalizeDataStore((DataStoreInfo)info,catalog);
else
if(infoinstanceofWMSStoreInfo){returnlocalizeWMSStore((WMSStoreInfo)info,catalog);
else{thrownewIllegalArgumentException("Unabletoprovidelocalizationforthepassedinstance");
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");finalDataStoreInfolocalObject=catalog.getDataStoreByName(info.getWorkspace(),info.getName());finalCatalogBuilderbuilder=newCatalogBuilder(catalog);
if(localObject!=null){returnlocalObject;
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");finalWMSStoreInfolocalObject=catalog.getStoreByName(info.getWorkspace(),info.getName(),WMSStoreInfo.class);finalCatalogBuilderbuilder=newCatalogBuilder(catalog);
if(localObject!=null){returnlocalObject;
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");finalCoverageStoreInfolocalObject=catalog.getCoverageStoreByName(info.getWorkspace(),info.getName());finalCatalogBuilderbuilder=newCatalogBuilder(catalog);
if(localObject!=null){returnlocalObject;
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");
if(infoinstanceofCoverageInfo){//coveragereturnlocalizeCoverage((CoverageInfo)info,catalog);
else
if(infoinstanceofFeatureTypeInfo){//featurereturnlocalizeFeatureType((FeatureTypeInfo)info,catalog);
else
if(infoinstanceofWMSLayerInfo){//wmslayerreturnlocalizeWMSLayer((WMSLayerInfo)info,catalog);
else{thrownewIllegalArgumentException("Unabletoprovidelocalizationforthepassedinstance");
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");finalWMSLayerInfolocalObject=catalog.getResourceByName(info.getNamespace(),info.getName(),WMSLayerInfo.class);
if(localObject!=null){returnlocalObject;
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");finalFeatureTypeInfolocalObject=catalog.getFeatureTypeByName(info.getNamespace(),info.getName());
if(localObject!=null){returnlocalObject;
if(info==null||catalog==null)thrownewNullArgumentException("Argumentsmayneverbenull");finalCoverageInfolocalObject=catalog.getCoverageByName(info.getNamespace(),info.getName());
if(localObject!=null){returnlocalObject;
if(Resources.exists(file=directory.get(getFilename()))){//xstreamitintry(BufferedInputStreamin=newBufferedInputStream(file.in())){XStreamPersisterxp=xpf.createXMLPersister();initXStreamPersister(xp,gs);returninitialize(xp.load(in,getServiceClass()));
else{//createan'empty'objectServiceInfoservice=createServiceFromScratch(gs);returninitialize((T)service);
if(serviceinstanceofServiceInfoImpl){//initializeallcollectionstoServiceInfoImplimpl=(ServiceInfoImpl)service;
if(impl.getClientProperties()==null){impl.setClientProperties(newHashMap());
if(impl.getExceptionFormats()==null){impl.setExceptionFormats(newArrayList());
if(impl.getKeywords()==null){impl.setKeywords(newArrayList());
if(impl.getMetadata()==null){impl.setMetadata(newMetadataMap());
if(impl.getVersions()==null){impl.setVersions(newArrayList());
ifthecharacterencodingistheoneexpectedassertTrue("UTF-8".equals(response.getCharacterEncoding()));//ContentStringresult=response.getContentAsString();assertNotNull(result);assertTrue(result.startsWith(JSONType.CALLBACK_FUNCTION));assertTrue(result.endsWith(")"));assertTrue(result.indexOf("GreenForest")>0);result=result.substring(0,result.length()-1);result=result.substring(JSONType.CALLBACK_FUNCTION.length()+1,result.length());JSONObjectrootObject=JSONObject.fromObject(result);assertEquals(rootObject.get("type"),"FeatureCollection");JSONArrayfeatureCol=rootObject.getJSONArray("features");JSONObjectaFeature=featureCol.getJSONObject(0);assertEquals(aFeature.getString("geometry_name"),"the_geom");
ifthecharacterencodingistheoneexpectedassertTrue("UTF-8".equals(response.getCharacterEncoding()));//ContentStringresult=response.getContentAsString();//System.out.println(result);assertNotNull(result);assertTrue(result.startsWith("custom("));assertTrue(result.endsWith(")"));assertTrue(result.indexOf("GreenForest")>0);result=result.substring(0,result.length()-1);result=result.substring("custom".length()+1,result.length());JSONObjectrootObject=JSONObject.fromObject(result);assertEquals(rootObject.get("type"),"FeatureCollection");JSONArrayfeatureCol=rootObject.getJSONArray("features");JSONObjectaFeature=featureCol.getJSONObject(0);assertEquals(aFeature.getString("geometry_name"),"the_geom");
ifthecharacterencodingistheoneexpectedassertTrue("UTF-8".equals(response.getCharacterEncoding()));//ContentStringresult=response.getContentAsString();assertNotNull(result);JSONObjectrootObject=JSONObject.fromObject(result);assertEquals(rootObject.get("type"),"FeatureCollection");JSONArrayfeatureCol=rootObject.getJSONArray("features");JSONObjectaFeature=featureCol.getJSONObject(0);assertEquals(aFeature.getString("geometry_name"),"the_geom");
ifthecharacterencodingistheoneexpectedassertTrue("UTF-8".equals(response.getCharacterEncoding()));//ContentStringresult=response.getContentAsString();assertNotNull(result);JSONObjectrootObject=JSONObject.fromObject(result);print(rootObject);assertEquals(rootObject.get("type"),"FeatureCollection");JSONArrayfeatureCol=rootObject.getJSONArray("features");JSONObjectaFeature=featureCol.getJSONObject(0);assertTrue(aFeature.getJSONObject("geometry").isNullObject());JSONObjectproperties=aFeature.getJSONObject("properties");assertTrue(properties.getJSONObject("FID").isNullObject());assertEquals("GreenForest",properties.get("NAME"));
if("identifier".equalsIgnoreCase(i)){name=request.getParameter(i);break;
if(null==name){thrownewWPSException("NoApplicableCode","NoIdentifierkeyandvalue.");
if(null==stream){thrownewWPSException("NoApplicableCode","NoSchema'"+name+"'.");
if(((MockHttpServletResponse)item).getContentType().startsWith("image")){description.appendText("\nwasanimage");
if(!SecurityContextHolder.getContext().getAuthentication().getAuthorities().contains(GeoServerRole.ADMIN_ROLE)){thrownewAccessDeniedException("Youmustbeadministrator.");
if(scanner.hasNextLine()){Stringline=scanner.nextLine();String[]attNames=line.split(SPLIT_BY);while(scanner.hasNextLine()){line=scanner.nextLine();String[]split=line.split(SPLIT_BY);Map<String,String>record=newHashMap<String,String>();for(inti=0;i<Math.min(attNames.length,split.length);i++){record.put(attNames[i],split[i]);
if(config==null){config=dao.copyConfiguration(template);config.setName(configName);
if(record.containsKey("description")){config.setDescription(record.remove("description"));
if(record.containsKey("workspace")){config.setWorkspace(record.remove("workspace"));
if(!errors.isEmpty()){for(ValidationErrorerror:errors){LOGGER.warning("Failedtoimportconfiguration"+config.getName()+",validationerror:"+error.toString());
else{config.setValidated(true);try{bjService.saveAndSchedule(config);
if(!be.getTask().isActive()){thrownewIllegalArgumentException("Cannotsave&scheduleabatchwithinactivetasks!");
if(!batch.isActive()){
if(exists){scheduler.deleteJob(jobKey);
else{
if(!exists){JobDetailjobDetail=JobBuilder.newJob(BatchJobImpl.class).withIdentity(jobKey).storeDurably().build();scheduler.addJob(jobDetail,true);
if(batch.isEnabled()&&batch.getFrequency()!=null&&!batch.getElements().isEmpty()&&(batch.getConfiguration()==null||batch.getConfiguration().isValidated())){Triggertrigger=TriggerBuilder.newTrigger().withIdentity(triggerKey).forJob(jobKey).withSchedule(CronScheduleBuilder.cronSchedule(batch.getFrequency())).build();scheduler.scheduleJob(trigger);
if(batch.getConfiguration()==null||!batch.getConfiguration().isTemplate()){try{schedule(batch);
if(!config.isTemplate()){try{for(Batchbatch:config.getBatches().values()){schedule(batch);
if(init){reloadFromData();
else{LOGGER.info("Skippinginitializationasspecifiedinconfiguration.");
if(!batchRun.getStatus().isClosed()){
if(batchRun.getSchedulerReference()!=null){try{TriggerKeytriggerKey=TriggerKey.triggerKey(batchRun.getSchedulerReference());Triggertrigger=scheduler.getTrigger(triggerKey);booleanlastFire=trigger!=null?(trigger.getNextFireTime()==null):true;TriggerStatestate=scheduler.getTriggerState(triggerKey);//theblockedcheckonlyworksthanksto@DisallowConcurrentExecution//otherwiseitwouldgostraightbacktowaitingandwewouldn'tknow//whenthejobwasfinished.
if((lastFire&&state==TriggerState.NONE)||(!lastFire&&state!=TriggerState.BLOCKED)){dataUtil.closeBatchRun(batchRun,"manuallyclosedduetoinactivity");return;
ifaScanlineissupportedbythewriterbooleanisScanlineSupported=writer.isScanlineSupported(image);//Ifitisnotsupported,thentheimageisrescaledtobytes
if(!isScanlineSupported){image=newImageWorker(image).rescaleToBytes().forceComponentColorModel().getRenderedImage();
ifthestylehasarastersymbolizer,don'ttrustthelayertypeas//wedon'tknowinadvance
ifthereisarenderingtransformation//WMScascadingisauglycase,wemightbecascadingamapthatisvector,but//wedon'tgettoknowStylestyle=layer.getStyle();
if(style!=null){style.accept(visitor);
if(visitor.highChangeRasterSymbolizer){returnFilterType.FILTER_SUB;
ifthestylecontainsa"highchange"rastersymbolizer,thatis,onethatgeneratesa*continuoussetofvaluesforwhichSUBfilteringprovidesbetterresults**@authorAndreaAime-GeoSolutions*/classRasterSymbolizerVisitorextendsAbstractStyleVisitor{booleanhighChangeRasterSymbolizer;publicvoidvisit(org.geotools.styling.RasterSymbolizerraster){
if(raster.getColorMap()==null){highChangeRasterSymbolizer=true;return;
if(cmType!=ColorMap.TYPE_INTERVALS&&cmType!=ColorMap.TYPE_VALUES){highChangeRasterSymbolizer=true;
if(policy.level==AccessLevel.METADATA)throwSecureCatalogImpl.unauthorizedAccess(this.getName());//gothroughthesecuredreaderGridCoverageReaderreader=getGridCoverageReader(listener,hints);returngetCatalog().getResourcePool().getGridCoverage(this,reader,null,hints);
if(policy.level==AccessLevel.METADATA)throwSecureCatalogImpl.unauthorizedAccess(this.getName());//gothroughthesecuredreaderGridCoverageReaderreader=getGridCoverageReader(listener,hints);returngetCatalog().getResourcePool().getGridCoverage(this,reader,envelope,hints);
if(policy.level==AccessLevel.METADATA&&(request==null||!"GetCapabilities".equalsIgnoreCase(request.getRequest()))){throwSecureCatalogImpl.unauthorizedAccess(this.getName());
if(maxSize>0){renderer.addRenderListener(newRenderListener(){publicvoidfeatureRenderer(SimpleFeaturefeature){
if(pdfBytes.size()>maxSize){renderer.stopRendering();
ifthememoryusedbythePDFbufferexceedsthemaxmemorysettings*/publicbooleanexceedsMaxSize(){returnmaxSize>0&&pdfBytes.size()>maxSize;
ifthemodifiedobjectwasaResource*/StringstoreId;/**classofobject*/Class<?extendsInfo>clazz;/**typeofconfigchange*/Typetype;privateStringnativeName;publicConfigChangeEvent(Stringid,Stringname,Class<?extendsInfo>clazz,Typetype){super();this.id=id;this.name=name;this.clazz=clazz;this.type=type;
if(source!=null){sb.append('(').append(source).append(")");
if(!(oinstanceofConfigChangeEvent)){returnfalse;
if(clazz==null&&ServiceInfo.class.isAssignableFrom(getObjectClass())){clazz=ServiceInfo.class;
if(clazz==null){for(Class<?extendsInfo>realClazz:INTERFACES.values()){
if(realClazz.isAssignableFrom(getObjectClass())){clazz=realClazz;break;
if(!(webRequestinstanceofServletWebRequest)){return;
if(Boolean.parseBoolean(quietOnNotFound)){message="";
else{LOGGER.log(Level.SEVERE,e.getMessage(),e);
if(e.getStatus().is4xxClientError()){response.sendError(e.getStatus().value(),e.getMessage());
else{response.setStatus(e.getStatus().value());
if{@codestr}can'tbeparsedtoaJSONArray*/publicstaticList<AuthorityURLInfo>fromString(Stringstr)throwsIllegalArgumentException{try{finalJSONArrayarray;array=JSONArray.fromObject(str);finalintsize=array.size();List<AuthorityURLInfo>list=newArrayList<AuthorityURLInfo>(size);JSONObjectjsonAuth;for(inti=0;i<size;i++){jsonAuth=array.getJSONObject(i);AuthorityURLauth=newAuthorityURL();auth.setName(jsonAuth.getString(NAME));auth.setHref(jsonAuth.getString(HREF));list.add(auth);
if{@codelist}isnull,emptyorcontainsonlynullobjects;theJSON*arrayrepresentationof{@codelist}otherwise,withanynullelementstrippedoff.*/publicstaticStringtoString(List<AuthorityURLInfo>obj){
if(obj==null||obj.isEmpty()){returnnull;
if(auth==null){continue;
if(array.size()==0){//listwasmadeofonlynullobjects?returnnull;
if(byteArray==null)return;ByteArrayInputStreamin=newByteArrayInputStream(byteArray);ObjectInputStreamoin=newObjectInputStream(in);try{helper.roleMap=(TreeMap<String,GeoServerRole>)oin.readObject();helper.role_parentMap=(HashMap<GeoServerRole,GeoServerRole>)oin.readObject();helper.user_roleMap=(TreeMap<String,SortedSet<GeoServerRole>>)oin.readObject();helper.group_roleMap=(TreeMap<String,SortedSet<GeoServerRole>>)oin.readObject();
if(existingAutocompleteSetting!=null){System.setProperty(LoginFormHTMLInclude.GEOSERVER_LOGIN_AUTOCOMPLETE,existingAutocompleteSetting);
if(versionMapUR==null)initializeSchemataUR();XPathExpressionexpr=XMLXpathFactory.Singleton.getVersionExpressionUR();StringversionString=null;try{versionString=expr.evaluate(doc);
if(versionMapRR==null)initializeSchemataRR();XPathExpressionexpr=XMLXpathFactory.Singleton.getVersionExpressionRR();StringversionString;try{versionString=expr.evaluate(doc);
if(versionMapUR!=null)return;//anothertreadwasfasterversionMapUR=newHashMap<String,Schema>();SchemaFactoryfactory=SchemaFactory.newInstance(javax.xml.XMLConstants.W3C_XML_SCHEMA_NS_URI);Schemaschema=null;try{schema=factory.newSchema(this.getClass().getResource(XMLConstants.FILE_UR_SCHEMA));
if(versionMapRR!=null)return;//anothertreadwasfasterversionMapRR=newHashMap<String,Schema>();SchemaFactoryfactory=SchemaFactory.newInstance(javax.xml.XMLConstants.W3C_XML_SCHEMA_NS_URI);Schemaschema=null;try{schema=factory.newSchema(this.getClass().getResource(XMLConstants.FILE_RR_SCHEMA));
if(output==null||output.getType()==Type.UNDEFINED){thrownewWPSException("Unknownoutput"+request.getOutputId()+"forexecutionid"+request.getExecutionId()+",eithertheexecutionwasneversubmittedortoomuchtime"+"elapsedsincetheprocesscompleted");
iftheservicebeanimplementstheoptional{@linkDirectInvocationService}*operation,thenthedispatcherexecutestheoperationthroughits{@link*DirectInvocationService#invokeDirect}methodinsteadofthrough{@linkMethod#invoke*reflection}.*/publicvoidtestDirectInvocationService()throwsThrowable{URLurl=getClass().getResource("applicationContext.xml");FileSystemXmlApplicationContextcontext=newFileSystemXmlApplicationContext(url.toString());Dispatcherdispatcher=(Dispatcher)context.getBean("dispatcher");finalAtomicBooleaninvokeDirectCalled=newAtomicBoolean();DirectInvocationServiceserviceBean=newDirectInvocationService(){@OverridepublicObjectinvokeDirect(StringoperationName,Object[]parameters)throwsIllegalArgumentException,Exception{invokeDirectCalled.set(true);
if("concat".equals(operationName)){Stringparam1=(String)parameters[0];Stringparam2=(String)parameters[1];returnconcat(param1,param2);
ifanerrorwasthrownthrownewError("TestDispatcherCallbackFailFinished");
if(resourceInfoinstanceofFeatureTypeInfo){result=extractDimensions(wms,layerInfo,(FeatureTypeInfo)resourceInfo);
if(resourceInfoinstanceofCoverageInfo){result=extractDimensions(wms,layerInfo,(CoverageInfo)resourceInfo);
if(requestedDimensions!=MultiDimensionalExtension.ALL_DOMAINS){Set<String>availableDimensions=result.stream().map(d->d.getDimensionName()).collect(Collectors.toSet());HashSet<String>unknownDimensions=newHashSet<>(requestedDimensions);unknownDimensions.removeAll(availableDimensions);unknownDimensions.remove(MultiDimensionalExtension.SPACE_DIMENSION);
if(!unknownDimensions.isEmpty()){StringdimensionList=unknownDimensions.stream().map(s->"'"+s+"'").collect(Collectors.joining(","));thrownewOWSException(400,"InvalidParameterValue","Domains","Unknowndimensionsrequested"+dimensionList);
else{result=result.stream().filter(d->requestedDimensions.contains(d.getDimensionName())).collect(Collectors.toList());
if(timeDimension!=null){checkAndAddDimension(dimensions,newVectorTimeDimension(wms,layerInfo,timeDimension));
if(elevationDimension!=null){checkAndAddDimension(dimensions,newVectorElevationDimension(wms,layerInfo,elevationDimension));
if(key.equals(ResourceInfo.TIME)){DimensionInfodimensionInfo=Converters.convert(value,DimensionInfo.class);checkAndAddDimension(dimensions,newRasterTimeDimension(wms,layerInfo,dimensionInfo));
else
if(key.equals(ResourceInfo.ELEVATION)){DimensionInfodimensionInfo=Converters.convert(value,DimensionInfo.class);checkAndAddDimension(dimensions,newRasterElevationDimension(wms,layerInfo,dimensionInfo));
else
if(key.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){DimensionInfodimensionInfo=Converters.convert(value,DimensionInfo.class);StringdimensionName=key.substring(ResourceInfo.CUSTOM_DIMENSION_PREFIX.length());checkAndAddDimension(dimensions,newRasterCustomDimension(wms,layerInfo,dimensionName,dimensionInfo));
ifthedimensionisenabled.*/privatestaticvoidcheckAndAddDimension(List<Dimension>dimensions,Dimensiondimension){//somelayerscanhaveadimensionconfiguredbutnotenable
if(dimension.getDimensionInfo().isEnabled()){dimensions.add(dimension);
if(summary.getMin()==null&&(summary.getUniqueValues()==null||summary.getUniqueValues().isEmpty())){//nodomainvaluessohejustreturnanemptycollectionreturnCollections.emptyList();
if(summary.getUniqueValues()!=null){//thedimensionrepresentationforthisvaluesrequiresthatallthevaluesarelistedfor(Objectvalue:summary.getUniqueValues()){stringValues.add(formatDomainValue(value));
else{//thedimensionrepresentationforthisvaluesrequireacompactrepresentationObjectminValue=summary.getMin();ObjectmaxValue=summary.getMax();stringValues.add(formatDomainSimpleValue(minValue)+"--"+formatDomainSimpleValue(maxValue));
if(valueinstanceofRange){//thisdomainvalueisarange,weusetheminandmaxvalueObjectminValue=((Range)value).getMinValue();ObjectmaxValue=((Range)value).getMaxValue();returnformatDomainSimpleValue(minValue)+"--"+formatDomainSimpleValue(maxValue);
if(valueinstanceofDate){//FIXME:istheISOformatterthreadsafeorcanhebereusedmultipletimes?ISO8601Formatterformatter=newISO8601Formatter();returnformatter.format(value);
if(minValueinstanceofRange){return((Range)minValue).getMinValue();
if(maxValueinstanceofRange){return((Range)maxValue).getMaxValue();
if(limit>0&&limit<Integer.MAX_VALUE){uniqueVisitor.setMaxFeatures(limit);
if(resourceinstanceofFeatureTypeInfo){FeatureSourcefeatureSource=((FeatureTypeInfo)resource).getFeatureSource(null,null);FeatureCollectionfeatures=featureSource.getFeatures(filter);returnfeatures.getBounds();
else
if(resourceinstanceofCoverageInfo){CoverageDimensionsReaderreader=CoverageDimensionsReader.instantiateFrom((CoverageInfo)resource);returnreader.getBounds(filter);
else{//forallotherresourcetypes(WMS/WMTScascading)wecannotdoanything//intelligentreturnresource.getNativeBoundingBox();
iftheboundingboxisnull*/publicstaticFiltergetBoundingBoxFilter(ResourceInforesource,ReferencedEnvelopeboundingBox,FilterFactoryfilterFactory){StringgeometryName=getGeometryPropertyName(resource);
if(boundingBox==null||geometryName==null){returnFilter.INCLUDE;
if(resourceinstanceofFeatureTypeInfo){geometryName=((FeatureTypeInfo)resource).getFeatureType().getGeometryDescriptor().getLocalName();
else
if(resourceinstanceofCoverageInfo){CoverageDimensionsReaderreader=CoverageDimensionsReader.instantiateFrom((CoverageInfo)resource);returnreader.getGeometryAttributeName();
if(resourceinstanceofFeatureTypeInfo){DimensionInfodi=dimension.getDimensionInfo();returnTuple.tuple(di.getAttribute(),di.getEndAttribute());
else
if(resourceinstanceofCoverageInfo){CoverageDimensionsReaderreader=CoverageDimensionsReader.instantiateFrom((CoverageInfo)resource);StringdimensionName=dimension.getDimensionName();Tuple<String,String>attributes=reader.getDimensionAttributesNames(dimensionName);
if(attributes.first==null){thrownewRuntimeException(String.format("Couldnotfoundstartattributenamefordimension'%s'inraster'%s'.",dimensionName,resource.prefixedName()));
else{thrownewRuntimeException("Cannotgetrestrictionattributesonthisresource:"+resource);
if((reqPath.length()>1)&&reqPath.startsWith("/")){reqPath=reqPath.substring(1);
if(file==null&&scloader!=null){//tryloadingasaservletresourceServletContextResourceresource=(ServletContextResource)scloader.getResource(reqPath);
if(resource!=null&&resource.exists()){file=resource.getFile();
if(file!=null){returnURLs.fileToUrl(file);
else{returnnull;
if(layer==null){thrownewNullPointerException();
if(it.hasNext()){sb.append(',');
if(this.envelope==null){this.envelope=reader.getOriginalEnvelope();
if(this.adjustedTargetSizeX==null&&this.adjustedTargetSizeY==null){//noscalingshouldbedone,returnreturn;
ifneeded
if((this.adjustedTargetSizeX==null&&this.adjustedTargetSizeY!=null)||(this.adjustedTargetSizeY==null&&this.adjustedTargetSizeX!=null)){//targetsizewasspecifiedforasingleaxis:calculatetargetsizealongtheother//axispreservingoriginalaspectratioMathTransformg2w=reader.getOriginalGridToWorld(PixelInCell.CELL_CENTER);GridGeometry2Dgg=newGridGeometry2D(PixelInCell.CELL_CENTER,g2w,envelope,GeoTools.getDefaultHints());doublewidth=gg.getGridRange2D().getWidth();doubleheight=gg.getGridRange2D().getHeight();doublewhRatio=width/height;
if(this.adjustedTargetSizeY!=null){//calculateXsizethis.adjustedTargetSizeX=(int)Math.round(this.adjustedTargetSizeY*whRatio);
else{//calculateYsizethis.adjustedTargetSizeY=(int)Math.round(this.adjustedTargetSizeX/whRatio);
iftheselectedinterpolationmethodisnotNearestNeighbor,interpolation*isperformed.**@paramreadParametersthereadparameterstopasstothecoveragereader*@returnthescaledcoverage*@throwsIOException*/publicGridCoverage2Dscale(GeneralParameterValue[]readParameters)throwsIOException{
if(readParameters==null){readParameters=newGeneralParameterValue[]{};
iftheselectedinterpolationmethodisnotNearestNeighbor,interpolation*isperformed.**@paramsourceGCthescaledcoverage*@throwsIOException*//**Codeadaptedfromorg.geoserver.wcs2_0.ScalingPolicy.ScaleToSize*/publicGridCoverage2Dscale(GridCoverage2DsourceGC)throwsIOException{checkNotNull(sourceGC,"sourceGC)");
if(!isTargetSizeSet()&&(interpolationinstanceofInterpolationNearest)){returnsourceGC;
if((isTargetSizeSet()&&this.adjustedTargetSizeX.equals(sourceGE.width)&&this.adjustedTargetSizeY==sourceGE.height)||(!isTargetSizeSet())){//NONEEDTOSCALE,doweneedinterpolation?
if(interpolationinstanceofInterpolationNearest){returnsourceGC;
else{//interpolatecoverage
ifrequestedandnotnearest!!!!finalOperationoperation=CoverageProcessor.getInstance().getOperation("Warp");finalParameterValueGroupparameters=operation.getParameters();parameters.parameter("Source").setValue(sourceGC);parameters.parameter("warp").setValue(newWarpAffine(AffineTransform.getScaleInstance(1,1)));//identityparameters.parameter("interpolation").setValue(interpolation);parameters.parameter("backgroundValues").setValue(CoverageUtilities.getBackgroundValues(sourceGC));//TODOcheckand//improvereturn(GridCoverage2D)CoverageProcessor.getInstance().doOperation(parameters,hints);
if(!isTargetSizeSet()){returncomputeNativeResolution();
if(param==null){thrownewIllegalArgumentException(paramName+"parametermustbespecified");
if(value!=null&&value<=0){thrownewIllegalArgumentException(dim+"targetsizemustbe>0");
ifnoneisfound,a{@linkDefaultNetCDFEncoder}will*beusedinstead*/publicinterfaceNetCDFEncoderFactory{/***Attemptstobuildanencoderforthegivenparameters(see{@link*CoverageResponseDelegate#encode(GridCoverage2D,String,Map,OutputStream)}**@returnA{@linkNetCDFEncoder},ornull
ifthisfactorycouldnotgenerateone*@throwsIOException*/NetCDFEncodergetEncoderFor(GranuleStackgranuleStack,Filefile,Map<String,String>encodingParameters,StringoutputFormat)throwsIOException;/***Buildsafilenamefromtheobjecttobeencoded,orreturnsnull**@paramgranuleStack*@paramid*@return*/defaultStringgetOutputFileName(GranuleStackgranuleStack,StringcoverageId,Stringformat){returnnull;}}
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(authenticationinstanceofUsernamePasswordAuthenticationToken){UsernamePasswordAuthenticationTokenup=(UsernamePasswordAuthenticationToken)authentication;
if("foo".equals(up.getPrincipal())&&"bar".equals(up.getCredentials())){authentication=newUsernamePasswordAuthenticationToken("foo","bar",Collections.<GrantedAuthority>emptyList());
ifthisencoderhasencodedencPass*/booleanisResponsibleForEncoding(StringencPass);/***Decodesanencodedpassword.Onlysupportedfor{@linkPasswordEncodingType#ENCRYPT}and*{@linkPasswordEncodingType#PLAIN}encoders,iethosethatreturn<code>true</code>from*{@link#isReversible()}.**@paramencPassTheencodedpassword.*@throwsUnsupportedOperationException*/Stringdecode(StringencPass)throwsUnsupportedOperationException;/***Decodesanencodedpasswordtoachararray.**@see#decode(String)*/char[]decodeToCharArray(StringencPass)throwsUnsupportedOperationException;/***Encodesarawpasswordfromachararray.**@see#encodePassword(String,Object)*/StringencodePassword(char[]password,Objectsalt);/***Validatesaspecified"raw"password(aschararray)againstanencodedpassword.**@see{@link#isPasswordValid(String,String,Object)}*/booleanisPasswordValid(StringencPass,char[]rawPass,Objectsalt);/***@returnaprefixwhichisstoredwiththepassword.Thisprefixmustbeuniquewithinall*{@linkGeoServerPasswordEncoder}implementations.*<p>Reserved:*<p>plaindigest1crypt1*<p>Aplaintextpasswordisstoredas*<p>plain:password*/StringgetPrefix();/***Isthisencoderavailablewithoutinstallingtheunrestrictedpolicyfilesofthejava*cryptographicextension*/booleanisAvailableWithoutStrongCryptogaphy();/***Flagindicating
iftheencodercandecodeanencryptedpasswordbackintoitsoriginalplain*textform.*/booleanisReversible();}
if(requestFeatureId!=null){try{WFS3_FEATURE_ID.set(requestFeatureId);writeSingleFeature((FeatureCollectionResponse)value,output,operation);
else{super.write(value,output,operation);
ifit'smissingortherequestisnotaWFS3one**@return*/privateStringgetWFS3FeatureId(){Requestdr=Dispatcher.REQUEST.get();StringfeatureId=null;
if(dr!=null&&(newVersion(dr.getVersion()).getMajor().equals(3))){ObjectfeatureIdValue=dr.getKvp().get("featureId");
if(featureIdValueinstanceofList){featureId=(String)((List)featureIdValue).get(0);
if(featureId!=null){writeLinks(operation,jw,featureId);
if(featureId!=null){path+="/"+featureId;
if(format.equals(MIME)){linkType=Link.REL_SELF;linkTitle="Thisdocument";
ifneeded
if(!CRS.equalsIgnoreMetadata(DefaultGeographicCRS.WGS84,crs)){super.writeCollectionCRS(jsonWriter,crs);
if(featureCount!=null){jsonWriter.key("numberMatched").value(featureCount);
if(!service.getVersions().contains(version_1_1_1)){service.getVersions().add(version_1_1_1);
if(!service.getVersions().contains(version_1_3_0)){service.getVersions().add(version_1_3_0);
if(service.getSRS()==null){((WMSInfoImpl)service).setSRS(newArrayList<String>());
if(service.getGetFeatureInfoMimeTypes()==null){((WMSInfoImpl)service).setGetFeatureInfoMimeTypes(newHashSet<String>());
if(service.getGetMapMimeTypes()==null){((WMSInfoImpl)service).setGetMapMimeTypes(newHashSet<String>());
if(service.getInterpolation()==null){service.setInterpolation(WMSInterpolation.Nearest);
if(null!=authUrlsSerializedForm){//service.getMetadata().put("authorityURLs",//authUrlsSerializedForm);//
if(null!=identifiersSerializedForm){//service.getMetadata().put("identifiers",//identifiersSerializedForm);//
iftheauthurlsand//identifiersarestoredinthemetadatamap
if(service.getAuthorityURLs()==null&&metadata!=null){Stringserialized=metadata.get("authorityURLs",String.class);List<AuthorityURLInfo>authorities;
if(serialized==null){authorities=newArrayList<AuthorityURLInfo>(1);
else{authorities=AuthorityURLInfoInfoListConverter.fromString(serialized);
if(service.getIdentifiers()==null&&metadata!=null){Stringserialized=metadata.get("identifiers",String.class);List<LayerIdentifierInfo>identifiers;
if(serialized==null){identifiers=newArrayList<LayerIdentifierInfo>(1);
else{identifiers=LayerIdentifierInfoListConverter.fromString(serialized);
if(layer==null){returnlayer;
else{returnnewSecuredWMSLayer(layer,policy);
if(layers!=null){for(Layerl:layers){map.addLayer(l);
if(Objects.nonNull(buffer)){map.setBuffer(buffer);
if(requestEnvelope.getCoordinateReferenceSystem()==WGS84){request.setSRS("EPSG:4326");
else
if(requestEnvelope.getCoordinateReferenceSystem()==WEB_MERCATOR){request.setSRS("EPSG:3857");
else{thrownewIllegalArgumentException("PleaseuseoneofthetestCRS's");
if(type.getDescriptor(i)instanceofGeometryDescriptor){
if(valueinstanceofString){value=newWKTReader2().read((String)value);
if(!config.isDirectWMSIntegrationEnabled()){return(WebMap)invocation.proceed();
if(!tiled){return(WebMap)invocation.proceed();
if(cachedTile==null){WebMapdynamicResult=(WebMap)invocation.proceed();dynamicResult.setResponseHeader("geowebcache-cache-result",MISS.toString());dynamicResult.setResponseHeader("geowebcache-miss-reason",requestMistmatchTarget.toString());returndynamicResult;
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("GetMaprequestintercepted,servingcachedcontent:"+request);
if(mapContentsinstanceofByteArrayResource){tileBytes=((ByteArrayResource)mapContents).getContents();
else{ByteArrayOutputStreamout=newByteArrayOutputStream();mapContents.transferTo(Channels.newChannel(out));tileBytes=out.toByteArray();
if(etag.equals(ifNoneMatch)){//ClientalreadyhasthecurrentversionLOGGER.finer("ETagmatches,returning304");thrownewHttpErrorCodeException(HttpServletResponse.SC_NOT_MODIFIED);
if(cacheAgeMax!=null){map.setResponseHeader("Cache-Control","max-age="+cacheAgeMax);
else{map.setResponseHeader("Cache-Control","no-cache");
if(ifModSinceHeader!=null&&ifModSinceHeader.length()>0){try{ifModifiedSince=DateUtil.parseDate(ifModSinceHeader);//theHTTPheaderhassecondprecisionlongifModSinceSeconds=1000*(ifModifiedSince.getTime()/1000);longtileTimeStampSeconds=1000*(tileTimeStamp/1000);
if(ifModSinceSeconds>=tileTimeStampSeconds){thrownewHttpErrorCodeException(HttpServletResponse.SC_NOT_MODIFIED);
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Can'tparseclient'sIf-Modified-Sinceheader:'"+ifModSinceHeader+"'");
if(layerinstanceofGeoServerTileLayer){LayerInfolayerInfo=((GeoServerTileLayer)layer).getLayerInfo();//configuringcachingdoesnotappearpossibleforlayergroup
if(layerInfo!=null){MetadataMapmetadata=layerInfo.getResource().getMetadata();Booleanenabled=metadata.get(ResourceInfo.CACHING_ENABLED,Boolean.class);
if(enabled!=null&&enabled){cacheAge=layerInfo.getResource().getMetadata().get(ResourceInfo.CACHE_AGE_MAX,Integer.class);
if(resourceDirectory==null){thrownewNullPointerException("rootresourcedirectoryrequired");
if(resourceDirectory.isFile()){thrownewIllegalArgumentException("Directoryrequired,filepresentatthislocation"+resourceDirectory);
if(!resourceDirectory.exists()){booleancreate=resourceDirectory.mkdirs();
if(!create){thrownewIllegalArgumentException("Unabletocreatedirectory"+resourceDirectory);
if(resourceDirectory.exists()&&resourceDirectory.isDirectory()){this.baseDirectory=resourceDirectory;
else{thrownewIllegalArgumentException("Unabletoacessdirectory"+resourceDirectory);
if(!file.exists()&&!dest.exists()){returntrue;//movinganundefinedresource
if(!actualFile.exists()){thrownewIllegalStateException("Filenotfound"+actualFile);
if(TRACE_ENABLED){tracer=newException();tracer.fillInStackTrace();
else{tracer=null;
if(!closed){Stringwarn="Thereiscodeleavingresourceinputstreamsopen,locksaroundthemmightnotbecleared!";
if(!TRACE_ENABLED){warn+="Add-D"+TRACE_ENABLED+"=truetoyourJVMoptionstogetafullstacktraceofthecodethatacquiredtheinputstream";
if(TRACE_ENABLED){LOGGER.log(Level.WARNING,"Theunclosedinputstreamoriginatedonthisstacktrace",tracer);
if(!actualFile.exists()){thrownewIllegalStateException("Cannotaccess"+actualFile);
ifalreadyclosed,thereshouldbenoexception(seespecCloseable)
if(temp.exists()){Locklock=lock();try{//noerrors,overwritetheoriginalfileFiles.move(temp,actualFile);
if(!file.exists()){try{Fileparent=file.getParentFile();
if(!parent.exists()){booleancreated=parent.mkdirs();
if(!created){thrownewIllegalStateException("Unabletocreate"+parent.getAbsolutePath());
if(parent.isDirectory()){Locklock=lock();booleancreated;try{created=file.createNewFile();
if(!created){thrownewFileNotFoundException("Unabletocreate"+file.getAbsolutePath());
else{thrownewFileNotFoundException("Unabletocreate"+file.getName()+"-notadirectory"+parent.getAbsolutePath());
if(file.isDirectory()){thrownewIllegalStateException("Directory(notafile)at"+path);
else{returnfile;
if(!file.exists()){try{Fileparent=file.getParentFile();
if(!parent.exists()){booleancreated=parent.mkdirs();
if(!created){thrownewIllegalStateException("Unabletocreate"+parent.getAbsolutePath());
if(parent.isDirectory()){Locklock=lock();booleancreated;try{created=file.mkdir();
if(!created){thrownewFileNotFoundException("Unabletocreate"+file.getAbsolutePath());
else{thrownewFileNotFoundException("Unabletocreate"+file.getName()+"-notadirectory"+parent.getAbsolutePath());
if(file.isFile()){thrownewIllegalStateException("File(notadirectory)at"+path);
else{returnfile;
if(!file.exists()){returnCollections.emptyList();
if(file.isFile()){returnCollections.emptyList();
if(array==null){returnCollections.emptyList();
if(split==-1){returnFileSystemResourceStore.this.get(Paths.BASE);//root
else{returnFileSystemResourceStore.this.get(path.substring(0,split));
if(resourcePath==null){thrownewNullPointerException("Resourcepathrequired");
if("".equals(resourcePath)){returnthis;
if(attributes.isDirectory()){returnType.DIRECTORY;
else
if(attributes.isRegularFile()){returnType.RESOURCE;
else{thrownewIllegalStateException("Pathdoesnotrepresentaconfigurationresource:"+path);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;FileSystemResourceother=(FileSystemResource)obj;
if(path==null){
if(other.path!=null)returnfalse;
else
if(!path.equals(other.path))returnfalse;returntrue;
if(dest.parent().path().contains(path())){LOGGER.log(Level.FINE,"Cannotrenamearesourcetoadescendantofitself");returnfalse;
if(destinstanceofFileSystemResource){rename(file,((FileSystemResource)dest).file);
else
if(destinstanceofFiles.ResourceAdaptor){rename(file,((Files.ResourceAdaptor)dest).file);
else{returnResources.renameByCopy(this,dest);
if(!actualFile.exists()){thrownewIllegalStateException("Cannotaccess"+actualFile);
if(watcher==null){watcher=newFileSystemWatcher(newFileSystemWatcher.FileExtractor(){@OverridepublicFilegetFile(Stringpath){returnPaths.toFile(baseDirectory,path);
if(wms==null)returnnull;
else
if(policy.level==AccessLevel.METADATA)throwSecureCatalogImpl.unauthorizedAccess(this.getName());
elsereturn(WebMapServer)SecuredObjects.secure(wms,policy);}}
if(mapLayers.size()==1){ResourceInfor=mapLayers.get(0).getResource();metadata.setDescription(r.getDescription());metadata.setType(MBTilesMetadata.t_type.BASE_LAYER);
else{Stringdescr="";for(MapLayerInfol:mapLayers){descr+=l.getResource().getDescription()+",";
if(get("editor")!=null){remove("editor");
if(pt==ParameterType.TEXT){//dataasplaintextFragmentf=newFragment("editor","text",this);DropDownChoicemimeChoice=newDropDownChoice("mime",newPropertyModel(getDefaultModel(),"mime"),mimeTypes);f.add(mimeChoice);f.add(newTextArea("textarea",valueModel));add(f);
else
if(pt==ParameterType.VECTOR_LAYER){//aninternalvectorlayervalueModel.setObject(newVectorLayerConfiguration());Fragmentf=newFragment("editor","vectorLayer",this);DropDownChoicelayer=newDropDownChoice("layer",newPropertyModel(valueModel,"layerName"),getVectorLayerNames());f.add(layer);add(f);
else
if(pt==ParameterType.RASTER_LAYER){//aninternalrasterlayervalueModel.setObject(newRasterLayerConfiguration());Fragmentf=newFragment("editor","rasterLayer",this);finalDropDownChoicelayer=newDropDownChoice("layer",newPropertyModel(valueModel,"layerName"),getRasterLayerNames());f.add(layer);add(f);//weneedtoupdatetherasterownboundingboxaswcsrequests//mandateaspatialextent(whyohwhy???)layer.add(newAjaxFormComponentUpdatingBehavior("change"){@OverrideprotectedvoidonUpdate(AjaxRequestTargettarget){Stringname=layer.getDefaultModelObjectAsString();LayerInfoli=GeoServerApplication.get().getCatalog().getLayerByName(name);ReferencedEnvelopespatialDomain=li.getResource().getNativeBoundingBox();((RasterLayerConfiguration)valueModel.getObject()).setSpatialDomain(spatialDomain);
else{error("Unsupportedparametertype");
if(li.getResource()instanceofFeatureTypeInfo){result.add(li.getResource().getPrefixedName());
if(li.getResource()instanceofCoverageInfo){result.add(li.getResource().getPrefixedName());
if(request.context!=null){Stringfirst=request.context;Stringlast=null;intslash=first.indexOf('/');
if(slash>-1){last=first.substring(slash+1);first=first.substring(0,slash);
ifthecontextmatchesaworkspacews=catalog.getWorkspaceByName(first);
if(ws!=null){LocalWorkspace.set(ws);//setthelocallayer
ifitexists
if(last!=null){//hackupaqualifiednameNamespaceInfons=catalog.getNamespaceByPrefix(ws.getName());
if(ns!=null){//canhaveextrabits,likews/layer/gwc/serviceintslashInLayer=last.indexOf('/');
if(slashInLayer!=-1){last=last.substring(0,slashInLayer);
if(l!=null){LocalPublished.set(l);
else{lg=catalog.getLayerGroupByName(ws,last);
if(lg!=null){LocalPublished.set(lg);
else{//TODO:perhapsthrowanexception?
else{lg=catalog.getLayerGroupByName((WorkspaceInfo)null,first);
if(lg!=null){LocalPublished.set(lg);
if(ws==null&&lg==null){//
ifnoworkspacecontextspecifiedandserverconfigurationnotallowingglobal//servicesthrowanerror
if(!gs.getGlobal().isGlobalServices()){thrownewServiceException("Nosuchworkspace'"+request.context+"'");
else
if(!gs.getGlobal().isGlobalServices()){thrownewServiceException("Noworkspacespecified");
if(link==null){link=newArrayList<LinkType>();
if(!m.matches()){thrownewUsernameNotFoundException("Nodelimiter'@'foundinusername:"+username);
if(null==version||version.length()==0){version=(String)rawKvp.get("WMTVER");
ifitdoesnotmatch//anavailablewmsversion
if(rawKvp.containsKey("VERSION")&&rawKvp.containsKey("WMTVER")){Stringver=(String)rawKvp.get("VERSION");Stringwmtver=(String)rawKvp.get("WMTVER");
if(WMS.version(ver,true)!=null&&WMS.version(wmtver,true)==null){version=ver;
else
if(WMS.version(ver,true)==null&&WMS.version(wmtver,true)!=null){version=wmtver;
ifwe're*talkingofanewStore*/publicStoreNameValidator(finalFormComponentworkspaceFormComponent,finalFormComponentstoreNameFormComponent,finalStringedittingStoreId){this(workspaceFormComponent,storeNameFormComponent,edittingStoreId,true);
ifwe're*talkingofanewStore*@paramrequiredtrue
ifstorenameisrequired*/publicStoreNameValidator(finalFormComponentworkspaceFormComponent,finalFormComponentstoreNameFormComponent,finalStringedittingStoreId,booleanrequired){this.workspaceComponent=workspaceFormComponent;this.storeNameComponent=storeNameFormComponent;this.edittingStoreId=edittingStoreId;this.required=required;
if(name==null){
if(required){nameComponent.error(newValidationError("StoreNameValidator.storeNameRequired").addKey("StoreNameValidator.storeNameRequired"));
if(existing!=null){finalStringexistingId=existing.getId();
if(!existingId.equals(edittingStoreId)){IValidationErrorerror=newValidationError("StoreNameValidator.storeExistsInWorkspace").addKey("StoreNameValidator.storeExistsInWorkspace").setVariable("workspace",workspace.getName()).setVariable("storeName",name);nameComponent.error(error);
if(group){returnnewPreviewLayer(GeoServerApplication.get().getCatalog().getLayerGroup(id));
else{returnnewPreviewLayer(GeoServerApplication.get().getCatalog().getLayer(id));
ifnoSimpleFeatureattributeswerefound*/publicstaticSimpleFeatureCollectionflatten(SimpleFeatureCollectioncollection){SimpleFeatureTypeschema=collection.getSchema();//collecttheattributesList<AttributeDescriptor>attributeDescriptors=newArrayList<AttributeDescriptor>();scanAttributeDescriptors(attributeDescriptors,schema,null);//buildtheflattenedfeaturetypeSimpleFeatureTypeBuilderbuilder=newSimpleFeatureTypeBuilder();builder.setName(schema.getName());for(AttributeDescriptordesc:attributeDescriptors)builder.add(desc);SimpleFeatureTypeflattenedType=builder.buildFeatureType();//
ifthenumberofattributesisthesame,wedidnotencounteranewattribute
if(collection.getSchema().getAttributeCount()==flattenedType.getAttributeCount()){returncollection;
if(joinedSchema!=null){//goforthandharvestfeatureattributetypesscanAttributeDescriptors(attributeDescriptors,joinedSchema,name);
else{//thisisacommon(non-feature)attributetypeAttributeTypeBuilderbuild=newAttributeTypeBuilder();build.init(ad);AttributeDescriptordescriptor=build.buildDescriptor(name);attributeDescriptors.add(descriptor);
if(attrinstanceofSimpleFeature){//goforthandharvestattrubutesaccumulateAttributes((SimpleFeature)attr);
else{builder.add(attr);
if(requestinstanceofHttpServletRequest){HttpServletRequestreq=(HttpServletRequest)request;
if(req.getRemoteUser()!=null){QueryBand.local().put(QueryBand.CLIENT_USER,req.getRemoteUser());
if(req.getRemoteHost()!=null){QueryBand.local().put(QueryBand.CLIENT_HOST,req.getRemoteHost());
if(parameters!=null){storeCRSAsWKT="true".equals(parameters.getProperty("storeCRSAsWKT"));
if(value==null){//LOGGER.severe("DISASSEMBLEnull");//
else{//LOGGER.severe("DISASSEMBLE"+value.getClass().getSimpleName()+""+value);//
if(blob!=null){CoordinateReferenceSystemcrs=null;
if(s!=null){try{
if(storeCRSAsWKT){crs=CRS.parseWKT(s);
else{crs=CRS.decode(s);
if(minx>maxx){returnnull;//re.setToNull();
if(box==null){//settonullst.setDouble(index,1);st.setDouble(index+1,1);st.setDouble(index+2,-1);st.setDouble(index+3,-1);st.setNull(index+4,Types.VARCHAR);//st.setBlob(index+4,(Blob)null);return;
if(box.getCoordinateReferenceSystem()!=null){CoordinateReferenceSystemcrs=box.getCoordinateReferenceSystem();
if(storeCRSAsWKT){st.setString(index+4,crs.toWKT());
else{try{st.setString(index+4,"EPSG:"+CRS.lookupEpsgCode(crs,true));
else{st.setNull(index+4,Types.VARCHAR);//st.setBlob(index+4,(Blob)null);
if(authKey==null){//nothingtodo//chain.doFilter(request,response);//return;//
if(SecurityContextHolder.getContext().getAuthentication()==null){doAuthenticate((HttpServletRequest)request,(HttpServletResponse)response,cacheKey);AuthenticationpostAuthentication=SecurityContextHolder.getContext().getAuthentication();
if(postAuthentication!=null&&cacheKey!=null){
if(cacheAuthentication(postAuthentication,(HttpServletRequest)request)){getSecurityManager().getAuthenticationCache().put(getName(),cacheKey,postAuthentication);
if(authKey==null)return;GeoServerUseruser=mapper.getUser(authKey);
if(user==null){return;
if(GeoServerUser.ROOT_USERNAME.equals(user.getUsername())){LOGGER.warning("Authenticationkeylogindoesaccepttherootuser");return;
if(roles.contains(GeoServerRole.AUTHENTICATED_ROLE)==false)roles.add(GeoServerRole.AUTHENTICATED_ROLE);KeyAuthenticationTokenresult=newKeyAuthenticationToken(authKey,authKeyParamName,user,roles);SecurityContextHolder.getContext().setAuthentication(result);
if(StringUtils.hasLength(authKey)==false)returnnull;returnauthKey;
if(keyParamName.equalsIgnoreCase(paramName)){returnreq.getParameter(paramName);
ifnoHTTPsessionisavailable
if(request.getSession(false)!=null)returnfalse;returntrue;
if(javaVendor.contains("IBM")){IOUtils.copy(newFile(secDir,"geoserver.jceks.ibm"),newFile(secDir,"geoserver.jceks"));
else{IOUtils.copy(newFile(secDir,"geoserver.jceks.default"),newFile(secDir,"geoserver.jceks"));
iftheworkspaceandassociatednamespaceareisolated*@paramcatalogthecatalogweretostore\updatetheworkspaceandassociatednamespace*/publicvoidaddWorkspace(Stringname,Stringuri,booleanisolated,Catalogcatalog){//let'ssee
iftheworkspacealreadyexistsWorkspaceInfows=catalog.getWorkspaceByName(name);
if(ws==null){//newworkspace,weneedtocreateanewonews=catalog.getFactory().createWorkspace();ws.setName(name);ws.setIsolated(isolated);catalog.add(ws);
else{//existingworkspace,let'supdatetheisolationstatews.setIsolated(isolated);catalog.save(ws);
ifthenamespaceassociatedwiththeworkspacealreadyexistsNamespaceInfons=catalog.getNamespaceByPrefix(name);
if(ns==null){//newnamespace,weneedtocreateanewonens=catalog.getFactory().createNamespace();ns.setPrefix(name);ns.setURI(uri);ns.setIsolated(isolated);catalog.add(ns);
else{//existingnamespace,let'supdatetheURIandisolationstatens.setURI(uri);ns.setIsolated(isolated);catalog.save(ns);
if(style==null){style=catalog.getFactory().createStyle();style.setName(name);style.setWorkspace(ws);
if(style.getId()==null){catalog.add(style);
else{catalog.save(style);
if*itdoesnotexist.Theresultingstoreisa{@linkPropertyDataStore}thatpointsatthe*directory<code>getDataDirectoryRoot()/qName.getPrefix()</code>.Similarilythelayerand*storearecreatedwithinaworkspacenamed<code>qName.getPrefix()</code>,whichiscreated*
ifitdoesnotalreadyexist.**<p>Thepropertiesdataforthelayeriscopiedfromtheclasspath,withafilenameof"*<code>qName.getLocalPart()</code>.properties".The<tt>scope</tt>parameterisusedasthe*classfromwhichtoloadthepropertiesfilerelativeto.**<p>The<tt>props</tt>parameterisusedtodefinecustompropertiesforthelayer.Seethe*{@linkLayerProperty}classforsupportedproperties.*/publicvoidaddVectorLayer(QNameqName,Map<LayerProperty,Object>props,Classscope,Catalogcatalog)throwsIOException{addVectorLayer(qName,props,qName.getLocalPart()+".properties",scope,catalog);
if*itdoesnotexist.Theresultingstoreisa{@linkPropertyDataStore}thatpointsatthe*directory<code>getDataDirectoryRoot()/qName.getPrefix()</code>.Similarilythelayerand*storearecreatedwithinaworkspacenamed<code>qName.getPrefix()</code>,whichiscreated*
ifitdoesnotalreadyexist.**<p>Thepropertiesdataforthelayeriscopiedfromtheclasspath,withafilenameof"*<code>filename</code>.properties".The<tt>scope</tt>parameterisusedastheclassfrom*whichtoloadthepropertiesfilerelativeto.**<p>The<tt>props</tt>parameterisusedtodefinecustompropertiesforthelayer.Seethe*{@linkLayerProperty}classforsupportedproperties.*/publicvoidaddVectorLayer(QNameqName,Map<LayerProperty,Object>props,Stringfilename,Classscope,Catalogcatalog)throwsIOException{Stringprefix=qName.getPrefix();Stringname=qName.getLocalPart();Stringuri=qName.getNamespaceURI();//configureworkspace
ifitdoesn;talreadyexist
if(catalog.getWorkspaceByName(prefix)==null){addWorkspace(prefix,uri,catalog);
ifitdoesn'talreadyexistFilestoreDir=catalog.getResourceLoader().findOrCreateDirectory(prefix);DataStoreInfostore=catalog.getDataStoreByName(prefix);
if(store==null){store=catalog.getFactory().createDataStore();store.setName(prefix);store.setWorkspace(catalog.getWorkspaceByName(prefix));store.setEnabled(true);store.getConnectionParameters().put(PropertyDataStoreFactory.DIRECTORY.key,storeDir);store.getConnectionParameters().put(PropertyDataStoreFactory.NAMESPACE.key,uri);catalog.add(store);
if(srs==null){srs=4326;
if(ft==null){ft=featureType;catalog.add(featureType);
else{
if(layer==null){//handlesthecaseoflayerremoved,butfeaturetypenotcatalog.remove(ft);ft=featureType;catalog.add(featureType);
else{newCatalogBuilder(catalog).updateFeatureType(ft,featureType);catalog.save(ft);
if(layer==null||!layer.getResource().getNamespace().equals(catalog.getNamespaceByPrefix(prefix))){layer=catalog.getFactory().createLayer();
if(LayerProperty.STYLE.get(props,null)!=null){defaultStyle=catalog.getStyleByName(LayerProperty.STYLE.get(props,null));
else{//lookforastylematchingthelayernamedefaultStyle=catalog.getStyleByName(name);
if(defaultStyle==null){//see
iftheresourceexistsandwejustneedtocreateit
if(getClass().getResource(name+".sld")!=null){addStyle(name,catalog);defaultStyle=catalog.getStyleByName(name);
if(defaultStyle==null){defaultStyle=catalog.getStyleByName(DEFAULT_VECTOR_STYLE);
if(layer.getId()==null){catalog.add(layer);
else{catalog.save(layer);
if(name.equals(TASMANIA_DEM)){addRasterLayer(name,"tazdem.tiff",null,catalog);
else
if(name.equals(TASMANIA_BM)){addRasterLayer(name,"tazbm.tiff",null,catalog);
else
if(name.equals(ROTATED_CAD)){addRasterLayer(name,"rotated.tiff",null,catalog);
else
if(name.equals(WORLD)){addRasterLayer(name,"world.tiff",null,catalog);
else
if(name.equals(MULTIBAND)){addRasterLayer(name,"multiband.tiff",null,catalog);
else{thrownewIllegalArgumentException("Unknowndefaultrasterlayer:"+name);
ifthe*<tt>filename</tt>doesnotrefertoazipfile.**<p>The<tt>props</tt>parameterisusedtodefinecustompropertiesforthelayer.Seethe*{@linkLayerProperty}classforsupportedproperties.**@paramqNameThenameoftherasterlayer.*@paramfilenameThenameofthefilecontainingtheraster,tobeloadedfromtheclasspath.*@paramextensionThefileextension(withouta".")ofthemainrasterfile.Thisparameter*mybe<code>null</code>only
if<tt>filename</tt>doesnotrefertoazipfile.*@parampropsCustompropertiestoassigntothecreatedrasterlayer.*@paramscopeTheclassfromwhichtoloadthe<tt>filename</tt>resourcefrom.*/publicvoidaddRasterLayer(QNameqName,Stringfilename,Stringextension,Map<LayerProperty,Object>props,Classscope,Catalogcatalog)throwsIOException{Stringprefix=qName.getPrefix();Stringname=qName.getLocalPart();//setupthedataFiledir=newFile(data,name);FileUtils.deleteQuietly(dir);dir.mkdirs();Filefile=newFile(dir,filename);
if(!file.getParentFile().exists()){file.getParentFile().mkdirs();
if("zip".equalsIgnoreCase(ext)){//unpackthearchiveIOUtils.decompress(file,dir);//deletearchivefile.delete();
if(extension==null){//zipwithnoextension,wejustthedirectoryasthefilefile=dir;
else{//filesmayhavebeentoplevel,oronedirectoryleveldeepfile=newFile(dir,FilenameUtils.getBaseName(filename)+"."+extension);
if(!file.exists()){Filefile2=newFile(newFile(dir,dir.getName()),file.getName());
if(file2.exists()){file=file2;
if(!file.exists()){thrownewFileNotFoundException(file.getPath());
if(format==null){thrownewRuntimeException("Noformatfor"+file.getCanonicalPath());
if(reader==null){thrownewRuntimeException("Noreaderfor"+file.getCanonicalPath()+"withformat"+format.getName());
ifitdoesn;talreadyexist
if(catalog.getWorkspaceByName(prefix)==null){addWorkspace(prefix,qName.getNamespaceURI(),catalog);
if(store==null){store=catalog.getFactory().createCoverageStore();
if(store.getId()==null){catalog.add(store);
else{catalog.save(store);
if(readerinstanceofStructuredGridCoverage2DReader&&coverageNames!=null&&coverageNames.length>1){for(StringcoverageName:coverageNames){addCoverage(store,builder,reader,catalog,format,coverageName,newQName(qName.getPrefix(),coverageName),props,coverageName);
else{addCoverage(store,builder,reader,catalog,format,name,qName,props,null);
if(reader!=null){reader.dispose();
if(formatinstanceofImageMosaicFormat){//makesureweworkinimmediatemodecoverage.getParameters().put(AbstractGridFormat.USE_JAI_IMAGEREAD.getName().getCode(),Boolean.FALSE);
if(cov==null){catalog.add(coverage);
else{builder.updateCoverage(cov,coverage);catalog.save(cov);coverage=cov;
if(layer==null){layer=catalog.getFactory().createLayer();
if(layer.getId()==null){catalog.add(layer);
else{catalog.save(layer);
if(serviceClass.equals(loader.getServiceClass())){//createanewoneTcreated=(T)loader.create(geoServer);//grabtheoldone,
ifitexistsTold=null;WorkspaceInfows=null;
if(workspace!=null){ws=catalog.getWorkspaceByName(workspace);old=geoServer.getService(ws,serviceClass);
else{old=geoServer.getService(serviceClass);
if(old!=null){//updatetheoldcopyOwsUtils.copy(created,old,serviceClass);geoServer.save(old);
else{//addthenewonecreated.setWorkspace(ws);geoServer.add(created);
if(settings==null){settings=geoServer.getFactory().createSettings();
if(ws!=null){
if(settings.getId()!=null){geoServer.save(settings);
else{geoServer.add(settings);
else{//globalgeoServer.save(global);
if((SystemUtils.IS_OS_WINDOWS&&WINDOWS_LENIENCY)||Boolean.getBoolean("testdata.force.delete")){intMAX_ATTEMPTS=100;for(inti=0;i<MAX_ATTEMPTS;i++){try{deleteFilesOnExit(data);break;
if(i>=MAX_ATTEMPTS&&data.exists()){Stringtree=printFileTree(data);thrownewIOException("Failedtocleanuptestdatadirafter"+MAX_ATTEMPTS+"attempts",e);
else{deleteFilesOnExit(data);
if(!data.exists()){//gonesomeotherway?good...
else{Stringtree=printFileTree(data);thrownewIOException("Failedtodeletetree\n"+tree,e);
if(listFile!=null){for(inti=0;i<listFile.length;i++){booleanlast=i==listFile.length-1;Filefile=listFile[i];StringfirstChar=last?"└":"├";sb.append(prefix).append(firstChar).append("──").append(file.getName()).append("\n");
if(file.isDirectory()){printFileTree_(sb,prefix+(last?"":"|")+"",file);
if(settings==null){map.getMap().put(DirectDownloadSettings.DIRECTDOWNLOAD_KEY,setDefaultSettings(GeoServerExtensions.bean(GeoServer.class).getService(CSWInfo.class)));
if(info!=null){MetadataMapserviceInfoMetadata=info.getMetadata();DirectDownloadSettingsinfoSettings=DirectDownloadSettings.getSettingsFromMetadata(serviceInfoMetadata,null);//createacopyoftheCSWInfosettings
if(infoSettings!=null){returnnewDirectDownloadSettings(infoSettings);
if(auth!=null&&!(authinstanceofAnonymousAuthenticationToken)){Stringname=auth.getName();envVars.put("GSUSER",name);
if(envVars.size()>0){EnvFunction.setLocalValues(envVars);
if(prjFile!=null){all.add(prjFile);
if(styleFile!=null){all.add(styleFile);
if(f.equals(file)){continue;
if(!f.getName().startsWith(baseName)){continue;
if(!f.isFile()){continue;
if(ext.charAt(0)=='.'){
if(".prj".equalsIgnoreCase(ext)){prjFile=f;
else
if(styleFile==null&&styleExtensions.contains(ext.substring(1))){//TODO:dealwithmultiplestylefiles?fornowwejustgrabthefirststyleFile=f;
else{suppFiles.add(f);
if(format==null){format=DataFormat.lookup(file);
if(crs==null){return;
if(epsgCode!=null){epsgCrs=CRS.decode("EPSG:"+epsgCode);
if(epsgCrs!=null){StringepsgWKT=epsgCrs.toWKT();FileUtils.writeStringToFile(getPrjFile(),epsgWKT);
if(prj==null||!prj.exists()){returnnull;
if(parentFolder!=null&&parentFolder.exists()&&parentFolder.isDirectory()){IOUtils.delete(parentFolder);
if(this==obj)returntrue;
if(!super.equals(obj))returnfalse;
if(getClass()!=obj.getClass())returnfalse;SpatialFileother=(SpatialFile)obj;
if(suppFiles==null){
if(other.suppFiles!=null)returnfalse;
else
if(!suppFiles.equals(other.suppFiles))returnfalse;returntrue;
if(oid!=null){for(Map<String,Object>result:helper.multiSelectQuery(TABLE_RESOURCES,newFieldSelector<Integer>(PARENT,oid),NAME)){list.add(createEntry(path,(String)result.get(NAME.getFieldName())));
if(md.oid==null){LOGGER.warning("Attemptingtodeleteundefinedentry"+toString());returnfalse;
if(!deleteChildren(md.oid)){LOGGER.warning("Deleteoperationfailedorincompleteforentry"+toString());returnfalse;
if(helper.deleteQuery(TABLE_RESOURCES,newFieldSelector<Integer>(OID,md.oid))<=0){LOGGER.warning("Deleteoperationfailedorincompleteforentry"+toString());returnfalse;
if(md.oid==null){LOGGER.warning("Attemptedtorenameundefinedentry:"+toString());returnfalse;
if(destParentOid!=null){
if(config.isDeleteDestinationOnRename()){
if(!dest.delete()){LOGGER.warning("Renameoperationfailedforentry"+toString()+":unabletodeletedestinationofrenameoperation.");returnfalse;
else{LOGGER.warning("Renameoperationfailedforentry"+toString()+":destinationofrenameoperationisdefined.");returnfalse;
else{EntrydestParent=dest.getParent();try{destParent.createDirectory();
if(helper.updateQuery(TABLE_RESOURCES,newFieldSelector<Integer>(OID,md.oid),newAssignment<String>(NAME,dest.getName()),newAssignment<Integer>(PARENT,destParentOid))<=0){LOGGER.warning("Unabletoperformrenameoperationforentry"+toString());returnfalse;
if(is==null){thrownewIllegalStateException("Couldnotfindcontentforentry"+toString());
if(helper.updateQuery(TABLE_RESOURCES,newPathSelector(path),newAssignment<InputStream>(CONTENT,is),newAssignment<Timestamp>(LAST_MODIFIED,md.lastModified))<=0){LOGGER.warning("Unabletowritecontenttoentry"+toString());
if(helper.updateQuery(TABLE_RESOURCES,newPathSelector(parentPath),newAssignment<Timestamp>(LAST_MODIFIED,md.lastModified))<=0){LOGGER.warning("Unabletoupdatelastmodifiedfordirectory"+toString());
if(record==null){parentOid=helper.insertQuery(TABLE_RESOURCES,newAssignment<String>(NAME,name),newAssignment<Integer>(PARENT,parentOid));
else{
if(!(Boolean)record.get(DIRECTORY.getFieldName())){thrownewIllegalStateException("Couldnotcreatedirectoryat"+toString()+":oneofitsparentsexistsandisnotadirectory.");
if(md.dir!=null){
if(md.dir){thrownewIllegalStateException("Couldnotcreateresourceat"+toString()+":alreadyadirectory.");
else{returnfalse;
if(md.oid==null){thrownewIllegalStateException("DidnotgetOIDfornewentry"+toString());
if(i>0){//noleadingslashbuf.append("/");
if(this==obj){returntrue;
if(obj==null){returnfalse;
if(!(objinstanceofEntry)){returnfalse;
if(config.isInitDb()){LOGGER.log(Level.INFO,"InitializingResourceStoreDatabase.");helper.runScript(config.getInitScript());config.setInitDb(false);try{config.save();
if(entryCache==null){CacheProvidercacheProvider=DefaultCacheProvider.findProvider();entryCache=cacheProvider.getCache("resourceEntries");
if(record!=null){md.oid=(Integer)record.get(OID.getFieldName());md.dir=(Boolean)record.get(DIRECTORY.getFieldName());md.lastModified=(Timestamp)record.get(LAST_MODIFIED.getFieldName());
if(children.size()>0){//recursivelyapplytochildrenfor(Integerchild:children){
if(!deleteChildren(child)){returnfalse;
if(helper.deleteQuery(TABLE_RESOURCES,newFieldSelector<Integer>(PARENT,oid))<children.size()){returnfalse;
if(i>0){builder.append("SELECToidFROM"+TABLE_RESOURCES+"WHEREparent=(");oidQuery(builder,i-1);builder.append(")andname=?");builder.addParameter(newParameter<String>(TYPE_STRING,path.get(i)));
else{builder.append("SELECToidFROM"+TABLE_RESOURCES+"WHEREparent=?andname=?");builder.addParameter(newParameter<Integer>(TYPE_INT,contextOid));builder.addParameter(newParameter<String>(TYPE_STRING,path.get(i)));
if(path.size()>0){qb.append("oid=(");oidQuery(qb,path.size()-1);qb.append(")");
else{qb.append("oid=?");qb.addParameter(newParameter<Integer>(TYPE_INT,contextOid));
if(CONNECTION_JNDI.equals(connectionType)){factory=newOracleNGJNDIDataStoreFactory();fillInJndiParams(params,jndiParamPanel);
else
if(CONNECTION_OCI.equals(connectionType)){factory=newOracleNGOCIDataStoreFactory();params.put(ALIAS.key,ociParamPanel.alias);params.put(USER.key,ociParamPanel.username);params.put(PASSWD.key,ociParamPanel.password);
else{factory=newOracleNGDataStoreFactory();//basicparamsparams.put(HOST.key,basicParamPanel.host);params.put(OracleNGDataStoreFactory.PORT.key,basicParamPanel.port);params.put(USER.key,basicParamPanel.username);params.put(PASSWD.key,basicParamPanel.password);params.put(DATABASE.key,basicParamPanel.database);
if(!CONNECTION_JNDI.equals(connectionType)){//connectionpoolparamscommontoOCIanddefaultconnectionsfillInConnPoolParams(params,basicParamPanel);
else{params.put(JDBCDataStoreFactory.SCHEMA.key,otherParamsPanel.schema);
if(basicParamPanel.schema!=null){params.put(JDBCDataStoreFactory.SCHEMA.key,basicParamPanel.schema);
if(converterName==null||converterName.length()==0)converter=GeoServerExtensions.bean(GeoServerRoleConverter.class);
elseconverter=(GeoServerRoleConverter)GeoServerExtensions.bean(converterName);
if(context!=null){Authenticationauth=context.getAuthentication();
if(auth!=null){StringroleString=converter.convertRolesToString(auth.getAuthorities());((HttpServletResponse)response).setHeader(headerAttribute,roleString);
if(!Number.class.isAssignableFrom(binding)){thrownewIllegalArgumentException("Numberisnotassignablefrom:"+binding);
if(!ruleModel.isEchoOnly()){RulesDao.saveOrUpdateRule(ruleModel.toRule());
if(!ruleModel.getEcho()){EchoParametersDao.deleteEchoParameters(ruleModel.getId());
if(ruleModel.getEcho()||ruleModel.isEchoOnly()){EchoParametersDao.saveOrUpdateEchoParameter(ruleModel.toEchoParameter());
if(ruleModel.getId().equals(echoParameter.getId())){Utils.checkCondition(echoParameter.getParameter().equals(ruleModel.getParameter()),"Ruleandechoparameterwithid'%s'shouldhavethesameparameter.",ruleModel.getId());Utils.checkCondition(echoParameter.getActivated()==ruleModel.getActivated(),"Ruleandechoparameterwithid'%s'shouldbothbedeactivatedoractivated.",ruleModel.getId());ruleModel.setEcho(true);return;
if(imp==null){
if(allowAll){returnimporter.getAllContexts();
if(optional){returnnull;
else{ImportContextcontext=null;context=importer.getContext(imp);
if(context==null&&!optional){thrownewRestException("Nosuchimport:"+imp.toString(),HttpStatus.NOT_FOUND);
if(taskNumber==null){
if(!optional&&!allowAll){thrownewRestException("Notaskspecified",HttpStatus.NOT_FOUND);
else{task=context.task(taskNumber);
if(task==null){
if(allowAll){returncontext.getTasks();
if(!optional){thrownewRestException("Nosuchtask:"+taskNumber+"forimport:"+context.getId(),HttpStatus.NOT_FOUND);
if(transformId!=null){try{tx=(ImportTransform)task.getTransform().getTransforms().get(transformId);
if(tx==null&&!optional){thrownewRestException("Nosuchtransform",HttpStatus.NOT_FOUND);
if(ex==null){returndef;
if(serviceStrategy==null){//noneset,lookupinwebapplicationcontextserviceStrategy=GeoServerExtensions.getProperty("serviceStrategy");
if(serviceStrategy!=null){theStrategy=(ServiceStrategy)context.getBean(serviceStrategy);
if(theStrategy==null){//defaulttopartialbuffer2theStrategy=(ServiceStrategy)context.getBean("PARTIAL-BUFFER2");
if(theStrategyinstanceofPartialBufferStrategy2){
if(partialBufferSize==0){Stringsize=getServletContext().getInitParameter("PARTIAL_BUFFER_STRATEGY_SIZE");
if(size!=null){try{partialBufferSize=Integer.valueOf(size).intValue();
if(partialBufferSize<=0){LOGGER.warning("Invalidpartialbuffersize,defaultingto"+PartialBufferedOutputStream2.DEFAULT_BUFFER_SIZE+"(was"+partialBufferSize+")");partialBufferSize=0;
ifthisobjectisactuallyproxied,weneedtoabigmorework
if(sinstanceofProxy){Class[]interfaces=s.getClass().getInterfaces();for(inti=0;m==null&&i<interfaces.length;i++){m=OwsUtils.getter(interfaces[i],"serviceInfo",ServiceInfo.class);
else{m=OwsUtils.getter(s.getClass(),"serviceInfo",ServiceInfo.class);
if(m!=null){try{ServiceInfoinfo=(ServiceInfo)m.invoke(s,null);
if(info==null){//logawarning,wecouldnotperformanimportantcheckLOGGER.warning("CouldnotgetaServiceInfoforservice"+service.getId()+"even
iftheserviceimplementsServiceInfo,thuscouldnotcheck
iftheserviceisenabled");
else{//check
iftheserviceisenabled
if(!info.isEnabled()){thrownewServiceException("Service"+info.getName()+"isdisabled");
else{//logawarning,wecouldnotperformanimportantcheckLOGGER.warning("CouldnotgetaServiceInfoforservice"+service.getId()+"thuscouldnotcheck
iftheserviceisenabled");
if(request.getBaseUrl()!=null){response.setServiceInstance(ResponseUtils.appendQueryString(ResponseUtils.buildURL(request.getBaseUrl(),"ows",null,URLType.SERVICE),""));
ifwesetitsidentifieron//anotherobject!(Iguess,followingsomestrictownershiprule...)process.setIdentifier((CodeType)EMFUtils.clone(request.getIdentifier(),Ows11Factory.eINSTANCE,true));process.setProcessVersion(pf.getVersion(processName));process.setTitle(Ows11Util.languageString(pf.getTitle(processName)));process.setAbstract(Ows11Util.languageString(pf.getDescription(processName)));//statusresponse.setStatus(f.createStatusType());XMLGregorianCalendargc=Converters.convert(status.getCreationTime(),XMLGregorianCalendar.class);response.getStatus().setCreationTime(gc);
if(status==null){
if(status.getException()!=null){setResponseFailed(response,getException(ProcessState.FAILED));
else
if(outputs==null){response.getStatus().setProcessAccepted("Processaccepted.");
else{response.getStatus().setProcessSucceeded("Processsucceeded.");
else{
if(status.getPhase()==ProcessState.QUEUED){response.getStatus().setProcessAccepted("Processaccepted.");
else
if(status.getPhase()==ProcessState.RUNNING){ProcessStartedTypestartedType=f.createProcessStartedType();intprogressPercent=Math.round(status.getProgress());
if(progressPercent<0){LOGGER.warning("Progressreportedisbelowzero,fixingitto0:"+progressPercent);progressPercent=0;
else
if(progressPercent>100){LOGGER.warning("Progressreportedisabove100,fixingitto100:"+progressPercent);progressPercent=100;
else
if(status.getPhase()==ProcessState.SUCCEEDED){response.getStatus().setProcessSucceeded("Processsucceeded.");
else{ServiceExceptionreportException=getException(status.getPhase());setResponseFailed(response,reportException);
ifasynch
if(status.isAsynchronous()&&request.getBaseUrl()!=null&&status.getExecutionId()!=null){Map<String,String>kvp=newLinkedHashMap<String,String>();kvp.put("service","WPS");kvp.put("version","1.0.0");kvp.put("request","GetExecutionStatus");kvp.put("executionId",status.getExecutionId());response.setStatusLocation(ResponseUtils.buildURL(request.getBaseUrl(),"ows",kvp,URLType.SERVICE));
ifrequested,theresponseshouldcontainit//even
iftheprocessisnotdonecomputing.Fromthespec://*Iflineageis"true"theservershallincludeintheexecuteresponseacompletecopy//of//theDataInputsandOutputDefinitionelements_asreceivedintheexecuterequest_.//*Iflineageis"false"then/theseelementsshallbeomittedfromtheresponse
if(helper.isLineageRequested()){//inputs
if(request.getDataInputs()!=null&&request.getDataInputs().getInput().size()>0){response.setDataInputs(f.createDataInputsType1());for(Iteratori=request.getDataInputs().getInput().iterator();i.hasNext();){InputTypeinput=(InputType)i.next();response.getDataInputs().getInput().add(EMFUtils.clone(input,f,true));
ifanywasrequestedexplicitlyList<OutputDefinitionType>outputList=helper.getRequestedOutputs();
if(outputList!=null){OutputDefinitionsTypeoutputs=f.createOutputDefinitionsType();response.setOutputDefinitions(outputs);for(OutputDefinitionTypeoutput:outputList){outputs.getOutput().add(EMFUtils.clone(output,f,true));
if(status.getException()==null&&outputs!=null){ProcessOutputsType1processOutputs=f.createProcessOutputsType1();response.setProcessOutputs(processOutputs);Map<String,Parameter<?>>resultInfo=pf.getResultInfo(processName,null);
if(request.getResponseForm()!=null&&request.getResponseForm().getResponseDocument()!=null&&request.getResponseForm().getResponseDocument().getOutput()!=null&&request.getResponseForm().getResponseDocument().getOutput().size()>0){//wehaveaselectionofoutputs,possiblywithindicationofmimetype//andreferenceencodingEListoutputs=request.getResponseForm().getResponseDocument().getOutput();for(Objectobject:outputs){
if(listener.isCanceled()){break;
if(outputParam==null){thrownewWPSException("Unknownoutput"+key+"possiblevaluesare:"+resultInfo.keySet());
else{//encodeallasinlineforthemomentfor(Stringkey:outputs.keySet()){
if(listener.isCanceled()){break;
if(mimeType==null){mimeType=getOutputMimeType(key);
if(ppio==null){thrownewWPSException("Don'tknowhowtoencodeoutput"+key+"inmimetype"+mimeType);
if(reference&&ppioinstanceofComplexPPIO){//encodeasreferenceOutputReferenceTypeoutputReference=f.createOutputReferenceType();output.setReference(outputReference);ComplexPPIOcppio=(ComplexPPIO)ppio;Stringname=key+"."+cppio.getFileExtension(o);ResourceoutputResource=resourceManager.getOutputResource(status.getExecutionId(),name);//writeouttheoutput,wrappingtheoutputstreamandotherwellknown//objectinclassesthatwillfailuponcancellationtry(OutputStreamos=newCancellingOutputStream(outputResource.out(),listener)){
if(oinstanceofFeatureCollection){o=CancellingFeatureCollectionBuilder.wrap((FeatureCollection)o,listener);
if(oinstanceofRawData){RawDatarawData=(RawData)o;mime=rawData.getMimeType();
else{mime=cppio.getMimeType();
else{//encodeasdataDataTypedata=f.createDataType();output.setData(data);
if(ppioinstanceofLiteralPPIO){LiteralDataTypeliteral=f.createLiteralDataType();data.setLiteralData(literal);literal.setValue(((LiteralPPIO)ppio).encode(o));
else
if(ppioinstanceofBoundingBoxPPIO){BoundingBoxTypebbox=((BoundingBoxPPIO)ppio).encode(o);data.setBoundingBoxData(bbox);
else
if(ppioinstanceofComplexPPIO){ComplexDataTypecomplex=f.createComplexDataType();data.setComplexData(complex);ComplexPPIOcppio=(ComplexPPIO)ppio;complex.setMimeType(cppio.getMimeType());
if(o==null){complex.getData().add(null);
else
if(cppioinstanceofRawDataPPIO){RawDatarawData=(RawData)o;complex.setMimeType(rawData.getMimeType());complex.setEncoding("base64");complex.getData().add(newRawDataEncoderDelegate(rawData));
else
if(cppioinstanceofXMLPPIO){//encodedirectlycomplex.getData().add(newXMLEncoderDelegate((XMLPPIO)cppio,o));
else
if(cppioinstanceofCDataPPIO){complex.getData().add(newCDataEncoderDelegate((CDataPPIO)cppio,o));
else
if(cppioinstanceofBinaryPPIO){complex.setEncoding("base64");complex.getData().add(newBinaryEncoderDelegate((BinaryPPIO)cppio,o));
else{thrownewWPSException("Don'tknowhowtoencodeanoutputwhosePPIOis"+cppio);
if(request.getResponseForm()==null){returnnull;
if(responseDocument!=null&&odt==null){Iteratorit=responseDocument.getOutput().iterator();while(it.hasNext()){OutputDefinitionTypecurr=(OutputDefinitionType)it.next();
if(curr.getIdentifier().getValue().equals(key)){odt=curr;break;
if(odt!=null){returnodt.getMimeType();
else{returnnull;
if(phase==ProcessState.DISMISSING){returnnewWPSException("Processwascancelledbytheadministrator");
else{
if(status.getException()instanceofWPSException){return(WPSException)status.getException();
else{returnnewWPSException("Processfailedduringexecution",status.getException());
if(byteArray==null)return;ByteArrayInputStreamin=newByteArrayInputStream(byteArray);ObjectInputStreamoin=newObjectInputStream(in);try{helper.userMap=(TreeMap<String,GeoServerUser>)oin.readObject();helper.groupMap=(TreeMap<String,GeoServerUserGroup>)oin.readObject();helper.user_groupMap=(TreeMap<GeoServerUser,SortedSet<GeoServerUserGroup>>)oin.readObject();helper.group_userMap=(TreeMap<GeoServerUserGroup,SortedSet<GeoServerUser>>)oin.readObject();helper.propertyMap=(TreeMap<String,SortedSet<GeoServerUser>>)oin.readObject();
if(enc.getEncodingType()==PasswordEncodingType.ENCRYPT){KeyStoreProviderprov=getSecurityManager().getKeyStoreProvider();Stringalias=prov.aliasForGroupService(name);
if(prov.containsAlias(alias)==false){prov.setUserGroupKey(name,getSecurityManager().getRandomPassworddProvider().getRandomPasswordWithDefaultLength());prov.storeKeyStore();
if(repoInfo==null){repoInfo=newModel<>(newRepositoryInfo());
if(data!=null){this.base=newFile(data);
else{thrownewIllegalStateException("Unabletodeterminedatadirectory");
iftheparserisnotincontext(see*GEOS-6402).**@authormbarto*/publicclassLayersKvpParserextendsKvpParser{publicstaticbooleanparseAsList=false;publicLayersKvpParser(Stringkey,Classbinding){super(key,binding);
if(parseAsList){returnKvpUtils.readFlat(value,",");
else{returnvalue;
iftheydo,thewholecontentwill//beunconditionallystoredininternalbuffer,resulting//inadditional(andmostprobablyvain)memoryimpact.////@authorNeilGraham,IBM//@authorGlennMarcy,IBM//packageorg.geoserver.ows.util;importjava.io.IOException;importjava.io.InputStream;publicclassRewindableInputStreamextendsInputStream{/***Defaultbuffersizebeforewe'vefinishedwiththeXMLDecl:Ithinkthenameshouldbeleft*unchangedtogiveahintforpossibleuseofthisclass:)*/publicstaticfinalintDEFAULT_XMLDECL_BUFFER_SIZE=64;/***Tellswhether<code>read(byte[],int,int)</code>methodisallowedtoreadmultiplebytes*beyondtheinternalbuffer(<code>true</code>)ornot(<code>true</code>isthedefault)*/protectedbooleanfMayReadChunks;/**Sourceinputstreamwearewrappingwithrewindableone.*/protectedInputStreamfInputStream;/***Internalbufferofbytesalreadyreadfromsourceinputstream.Allowstoaccessthesame*bytemorethanonce.*/protectedbyte[]fData;/***Positioninthestreamthattowhichstreampointercanberesetwith<code>rewind</code>*methodinvocation.*/protectedintfStartOffset;/***Positionwheretheendofunderlyingstreamwasencountered.Potentiallyin<code>*RewindableInputStream</code>instancestream's"end"couldbereachedmorethanonce,soit*isagoodthingtoknowwhereoriginalstreamendedtoavoid<code>IOExceptions</code>.*/protectedintfEndOffset;/***Offsetofthenextbytetobereadfromthestreamrelativetothebeginningofthestream*(and<code>fData</code>arrayaswell)*/protectedintfOffset;/***Numberofreadbytescurrentlystoredin<code>fData</code>buffer.Sizeofthebufferitself*canbegreaterthanthisvalue,obviously.*/protectedintfLength;/**Offsetofthe"marked"positioninthestreamrelativetoitsbeginning.*/protectedintfMark;/***Createsnew<code>RewindableInputStream</code>objectwithinternalbufferofdefaultsize*anddefaultvalueofchunkedreadingflag(whichis_currently_<code>true</code>).**@paramisInputStreamthatneedsbasicreset/rewindfunctionality.*/publicRewindableInputStream(InputStreamis){this(is,true,DEFAULT_XMLDECL_BUFFER_SIZE);
if(0>=initialSize){initialSize=DEFAULT_XMLDECL_BUFFER_SIZE;
ifyouusespecializedmethodsto*enable/disablechunkreadmode.*/publicvoidenableChunkedMode(){fMayReadChunks=true;
ifyouusespecializedmethodsto*enable/disablechunkreadmode.*/publicvoiddisableChunkedMode(){fMayReadChunks=false;
ifendofstreamisreached.*@throwsIOExceptionincaseofanyI/Oerrors.*/publicintread()throwsIOException{intb=0;//Bytetobereadisalreadyinoutbuffer,simplyreturningit
if(fOffset<fLength){returnfData[fOffset++]&0xff;
if(fOffset==fEndOffset){return-1;
ifbufferarrayshouldbe*expanded.Eachtimebuffersizeisdoubled.*/
if(fOffset==fData.length){byte[]newData=newbyte[fOffset<<1];System.arraycopy(fData,0,newData,0,fOffset);fData=newData;
if(b==-1){fEndOffset=fOffset;return-1;
ifin"non-chunked"mode(*<code>fMayReadChunks==false</code>).Afterreachingtheendofthebuffer,eachinvocation*ofthismethodwillreadexactly1bytethen.In"chunked"modethismethod<em>may</em>*returnmorethan1byte,butitdoesn'tbuffertheresult.**<p>Fromtheotherhand,forthetaskofreadingxmldeclaration,suchbehaviormaybe*desirable,asweprobablydon'tneedreset/rewindfunctionalityafterwefinishedwith*charsetdeduction.Itisgoodideatocall<code>enableChunkedMode</code>afterthat,in*ordertoimproveperfomanceandlessenmemoeryconsumptionwhenreadingtherestofthedata.**@returnTotalnumberofbytesactuallyreador<code>-1</code>
ifendofstreamhasbeen*reached.*@throwsIOExceptionwhenanI/Oerroroccurswhilereadingdata*@throwsIndexOutOfBoundsExceptionincaseofinvalid<code>off</code>,<code>len</code>and*<code>b.length</code>combination*/publicintread(byte[]b,intoff,intlen)throwsIOException{
if(null==b){thrownewNullPointerException("Destinationbytearrayisnull.");
else
if(0==len){return0;
else
if((b.length<off)||(b.length<(off+len))||(0>off)||(0>len)){thrownewIndexOutOfBoundsException();
if(bytesLeft==0){
if(fOffset==fEndOffset){return-1;
if(fMayReadChunks){//Hmm,thiscanbebufferedintheory.Butinmany//casesthiswouldbeundesirable,soletitbeasitis.returnfInputStream.read(b,off,len);
if(returnedVal==-1){fEndOffset=fOffset;return-1;
if(fMayReadChunks){//CountofbytestogetformbufferintreadFromBuffer=(len<bytesLeft)?len:bytesLeft;System.arraycopy(fData,fOffset,b,off,readFromBuffer);intreadFromStream=0;
if(len>bytesLeft){readFromStream=fInputStream.read(b,off+bytesLeft,len-bytesLeft);
else{////Thiswillpreventreturningmorebytesthantheremainderof//thebufferarray.
if(len>bytesLeft){len=bytesLeft;
ifanI/Oerroroccurs.*/publiclongskip(longn)throwsIOException{intbytesLeft;
if(n<=0){return0;
if(bytesLeft==0){
if(fOffset==fEndOffset){return0;
if(n<=bytesLeft){fOffset+=n;returnn;
if(fOffset==fEndOffset){returnbytesLeft;
iftherearenounread*bytesinthebuffer.*<li><code>-1</code>
ifendofstreamisreached.*</ul>**@returnthenumberofbytesthatcanbereadfromthisinputstreamwithoutblocking.*@throwsIOExceptionwhenanI/Oerroroccurs.*/publicintavailable()throwsIOException{intbytesLeft=fLength-fOffset;
if(bytesLeft==0){//Again,thesamethingasin`read()`.Doweneedtothrow//anexception
iffOffset>fEndOffset???
if(fOffset==fEndOffset){return-1;
iftherewereno<code>mark</code>methodcalls).*/publicvoidreset(){fOffset=fMark;
ifthisstreaminstancesupportsthemarkandresetmethods;<code>*false</code>otherwise.*/publicbooleanmarkSupported(){returntrue;
ifanI/Oerroroccurs.*/publicvoidclose()throwsIOException{
if(fInputStream!=null){fInputStream.close();fInputStream=null;fData=null;
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
iftheObjectisnotencodeable.*/publicvoidencode(Objecto)throwsIllegalArgumentException{
if(!(oinstanceofGetCapabilitiesType)){thrownewIllegalArgumentException("NotaGetCapabilitiesType:"+o!=null?o.toString():"null");
if(request.getUpdateSequence()!=null){try{requestedUpdateSequence=Long.parseLong(request.getUpdateSequence());
if(requestedUpdateSequence>updateSequence){thrownewWcsException("Invalidupdatesequencevalue,it'shigher"+"thanthecurrentvalue,"+updateSequence,WcsException.WcsExceptionCode.InvalidUpdateSequence,"updateSequence");
if(request.getSections()==null){sections=Collections.emptyList();allSections=true;
else{sections=request.getSections().getSection();allSections=sections.contains(SECTIONS.All.name());for(Stringsection:sections){
if(!SECTIONS.names.contains(section))thrownewWcsException("Unknownsection"+section,WcsException.WcsExceptionCode.InvalidParameterValue,"Sections");
if(requestedUpdateSequence<updateSequence){
if(allSections||sections.contains(SECTIONS.ServiceIdentification.name()))handleServiceIdentification();
if(allSections||sections.contains(SECTIONS.ServiceProvider.name()))handleServiceProvider();
if(allSections||sections.contains(SECTIONS.OperationsMetadata.name()))handleOperationsMetadata();
if(allSections||sections.contains(SECTIONS.ServiceMetadata.name()))handleServiceMetadata(request);
if(allSections||sections.contains(SECTIONS.Contents.name()))handleContents();
if(allSections||sections.contains(SECTIONS.Languages.name()))handleLanguages();
if(ct.getAcceptVersions()==null||ct.getAcceptVersions().getVersion()==null||ct.getAcceptVersions().getVersion().isEmpty()||ct.getAcceptVersions().getVersion().contains("2.0.1")){Set<String>formats=newTreeSet<String>();for(Stringformat:responseFactory.getOutputFormats()){CoverageResponseDelegatedelegate=responseFactory.encoderFor(format);Stringmime=delegate.getMimeType(format);try{newURI(mime);formats.add(mime);
if(wcs.getSRS()==null||wcs.getSRS().isEmpty()){codes=CRS.getSupportedCodes("EPSG");
else{codes=wcs.getSRS();
if(!code.equals("WGS84(DD)")){element("wcscrs:crsSupported","http://www.opengis.net/def/crs/EPSG/0/"+code);
if(isBlank(fees)){fees="NONE";
if(isBlank(accessConstraints)){accessConstraints="NONE";
if(extensions!=null&&extensions.size()>0){try{for(WCSExtendedCapabilitiesProviderprovider:extensions){provider.encodeExtendedOperations(translator,wcs,request);
if(parameters!=null&&!parameters.isEmpty()){for(Map.Entry<String,List<String>>param:parameters.entrySet()){attributes=newAttributesImpl();attributes.addAttribute("","name","name","",param.getKey());start("ows:Parameter",attributes);start("ows:AllowedValues");for(Stringvalue:param.getValue()){element("ows:Value",value);
if(kwords!=null&&!kwords.isEmpty()){start("ows:Keywords");for(KeywordInfokword:kwords){element("ows:Keyword",kword.getValue());
if(isNotBlank(or)){AttributesImplattributes=newAttributesImpl();attributes.addAttribute("","xlink:href","xlink:href","",or);start("ows:OnlineResource",attributes);end("OnlineResource");
if(!cv.enabled()){it.remove();
if(skipMisconfigured){reset();LOGGER.log(Level.SEVERE,"Skippingcoverage"+cv.prefixedName()+"asitscapabilitiesgenerationfailed",e);
else{thrownewRuntimeException("Capabilitiesdocumentgenerationfailedoncoverage"+cv.prefixedName(),e);
if(extensions!=null&&extensions.size()>0){start("wcs:Extension");try{for(WCSExtendedCapabilitiesProviderprovider:extensions){provider.encodeExtendedContents(translator,wcs,newArrayList<CoverageInfo>(coverages),request);
ifandonly
ifthecontentisnotnullandnotempty**@paramelementName*@paramcontent*/privatevoidelementIfNotEmpty(StringelementName,Stringcontent){
if(isNotBlank(content))element(elementName,content);
if(StringUtils.hasLength(redirectUrl))logoutSuccessHandler.setDefaultTargetUrl(redirectUrl);StringformLogoutChain=(((LogoutFilterConfig)config).getFormLogoutChain()!=null?((LogoutFilterConfig)config).getFormLogoutChain():GeoServerSecurityFilterChain.FORM_LOGOUT_CHAIN);pathInfos=formLogoutChain.split(",");
if(getRequestPath(request).startsWith(pathInfo)){doLogout=true;break;
if(doLogout)doLogout(request,response);return;
if(authentication!=null){List<LogoutHandler>logoutHandlers=calculateActiveLogoutHandlers(skipHandlerName);for(LogoutHandlerh:logoutHandlers){h.logout(request,response,authentication);
if(StringUtils.hasLength(redirectUrl)){SimpleUrlLogoutSuccessHandlerh=newSimpleUrlLogoutSuccessHandler();h.setDefaultTargetUrl(redirectUrl);h.onLogoutSuccess(request,response,authentication);return;
if(logoutFilterNames.contains(filterName))handlerNames.add(filterName);
if(Dispatcher.REQUEST.get()!=null&&Dispatcher.REQUEST.get().isSOAP()){output.write(("<wfs:DescribeFeatureTypeResponsexmlns:wfs='"+getWFSNamespaceURI()+"'>").getBytes());ByteArrayOutputStreambout=newByteArrayOutputStream();doWrite(featureTypeInfos,bout,describeFeatureType);output.write(Base64.encodeBase64(bout.toByteArray()));output.write("</wfs:DescribeFeatureTypeResponse>".getBytes());
else{//normalwritedoWrite(featureTypeInfos,output,describeFeatureType);
if(tmpFolder==null){this.tmpFolder=newTemporaryFolder();try{this.tmpFolder.create();
else{this.tmpFolder=tmpFolder;
if(geogig!=null){geogig.close();geogig=null;
if(tmpFolder!=null){tmpFolder.delete();
if(paths!=null){for(Stringpath:paths){command.addPattern(path);
if(isNullOrEmpty(attValue)){attValue=null;
if(treeName.equals(parentTreePath)){ObjectIdmetadataId=featureTypeTrees.get(i).getMetadataId();RevFeatureTyperevType=((Optional<RevFeatureType>)run(geogig.command(RevObjectParse.class).setObjectId(metadataId))).get();SimpleFeatureTypefeatureType=(SimpleFeatureType)revType.type();returnfeatureType;
if(responseType!=null){responseType=responseType.toUpperCase();
if(responseType.equals("GETCAPABILITIES")||responseType.equals("CAPABILITIES")){returnDispatcher.GET_CAPABILITIES_REQUEST;
else
if(responseType.equals("DESCRIBEFEATURETYPE")){returnDispatcher.DESCRIBE_FEATURE_TYPE_REQUEST;
else
if(responseType.equals("GETFEATURE")){returnDispatcher.GET_FEATURE_REQUEST;
else
if(responseType.equals("TRANSACTION")){returnDispatcher.TRANSACTION_REQUEST;
else
if(responseType.equals("GETFEATUREWITHLOCK")){returnDispatcher.GET_FEATURE_LOCK_REQUEST;
else
if(responseType.equals("LOCKFEATURE")){returnDispatcher.LOCK_REQUEST;
else
if(responseType.equals("GETMAP")||responseType.equals("MAP")){returnDispatcher.GET_MAP_REQUEST;
else
if(responseType.equals("GETFEATUREINFO")){returnDispatcher.GET_FEATURE_INFO_REQUEST;
else
if(responseType.equals("DESCRIBELAYER")){returnDispatcher.DESCRIBE_LAYER_REQUEST;
else
if(responseType.equals("GETLEGENDGRAPHIC")){returnDispatcher.GET_LEGEND_GRAPHIC_REQUEST;
else{returnDispatcher.UNKNOWN;
else{returnDispatcher.UNKNOWN;
if(serviceType!=null){serviceType=serviceType.toUpperCase();
if(serviceType.equals("WFS")){returnDispatcher.WFS_SERVICE;
else
if(serviceType.equals("WMS")){returnDispatcher.WMS_SERVICE;
else{returnDispatcher.UNKNOWN;
else{returnDispatcher.UNKNOWN;
if(requestParams.containsKey("SERVICE")){return(String)requestParams.get("SERVICE");
else{returnnull;
if(requestParams.containsKey("REQUEST")){return(String)requestParams.get("REQUEST");
else{returnnull;
if(map.size()>1){handler.startElement(null,"map","map",null);encode((Map)object,handler);handler.endElement(null,"map","map");
else{encode((Map)object,handler);
if(val!=null){
if(valinstanceofMap){encode((Map)val,h);
else{Stringstr=val.toString();h.characters(str.toCharArray(),0,str.length());
else{//nil(s);
if(beaninstanceofAbstractEntityManagerFactoryBean){init((AbstractEntityManagerFactoryBean)bean);
if(!Resources.exists(f)){//copyoneoutfromPropertiesprops=newProperties();props.putAll(factory.getJpaVendorAdapter().getJpaPropertyMap());props.putAll(factory.getJpaPropertyMap());Resourcemonitoring=data.get("monitoring");Resourcefile=monitoring.get("hibernate.properties");OutputStreamfout=file.out();props.store(fout,"hibernateconfiguration");fout.flush();fout.close();
else{//useconfigtooveridePropertiesprops=newProperties();InputStreamfin=f.in();props.load(fin);fin.close();HibernateJpaVendorAdapteradapter=(HibernateJpaVendorAdapter)factory.getJpaVendorAdapter();adapter.setDatabase(Database.valueOf((String)props.get("database")));adapter.setDatabasePlatform((String)props.get("databasePlatform"));adapter.setShowSql(Boolean.valueOf((String)props.getProperty("showSql")));adapter.setGenerateDdl(Boolean.valueOf((String)props.getProperty("generateDdl")));for(Map.Entrye:props.entrySet()){
if(((String)e.getKey()).startsWith("hibernate")){factory.getJpaPropertyMap().put((String)e.getKey(),e.getValue());
if(beaninstanceofAbstractEntityManagerFactoryBean){init((AbstractEntityManagerFactoryBean)bean);
if(reqinstanceofHttpServletRequest){HttpServletRequestrequest=(HttpServletRequest)req;chain.doFilter(newSessionDebugWrapper(request),res);
else{chain.doFilter(req,res);
if(session!=null||!create){returnsession;
if(getPathInfo().startsWith("/web")||Boolean.TRUE.equals(allow)){
if(LOGGER.isLoggable(Level.FINE)){Exceptione=newException("Fullstacktraceforthesessioncreationpath");e.fillInStackTrace();LOGGER.log(Level.FINE,"CreatinganewhttpsessioninsidethewebUI(normalbehavior)",e);
else{
if(LOGGER.isLoggable(Level.INFO)){Exceptione=newException("Fullstacktraceforthesessioncreationpath");e.fillInStackTrace();LOGGER.log(Level.INFO,"CreatinganewhttpsessionoutsideofthewebUI!"+"(normallynotdesirable),thepathis"+getPathInfo(),e);
if(method==UploadMethod.file){//wewanttodeletethepreviousdircontentsonlyincaseofPUT,not//incaseofPOST(harvest,availableonlyforrasterdata)booleancleanPreviousContents=HttpMethod.PUT.name().equals(request.getMethod());
if(filename==null){filename=buildUploadedFilename(store,format);
else
if(method==UploadMethod.url){uploadedFile=RESTUtils.handleURLUpload(buildUploadedFilename(store,format),workspace,directory,request);
else
if(method==UploadMethod.external){uploadedFile=RESTUtils.handleEXTERNALUpload(request);external=true;
else{thrownewRestException("Unrecognizedfileuploadmethod:"+method,HttpStatus.BAD_REQUEST);
if(tinstanceofRestException){throw(RestException)t;
else{thrownewRestException("Errorwhilestoringuploadedfile:",HttpStatus.INTERNAL_SERVER_ERROR,t);
ifsounzipit
if(RESTUtils.isZipMediaType(request)){//renameto.zip
ifneedbe
if(!uploadedFile.name().endsWith(".zip")){ResourcenewUploadedFile=uploadedFile.parent().get(FilenameUtils.getBaseName(uploadedFile.path())+".zip");StringoldFileName=uploadedFile.name();
if(!uploadedFile.renameTo(newUploadedFile)){StringerrorMessage="Errorrenamingzipfilefrom"+oldFileName+"->"+newUploadedFile.name();thrownewRestException(errorMessage,HttpStatus.INTERNAL_SERVER_ERROR);
ifitisaPOSTrequest,fillingoftheFileListRESTUtils.unzipFile(uploadedFile,directory,workspace,store,request,files,external);//lookforthe"primary"file//TODO:doabettercheckResourceprimaryFile=findPrimaryFile(directory,format);
if(primaryFile!=null){uploadedFile=primaryFile;
else{thrownewRestException("Couldnotfindappropriate"+format+"fileinarchive",HttpStatus.BAD_REQUEST);
if(files.isEmpty()&&uploadedFile!=null){files.clear();files.add(uploadedFile);
else{files.add(0,uploadedFile);
if("h2".equalsIgnoreCase(format)){returnstore+".data.db";
else{returnstore+"."+format;
if(other==this)returntrue;
if(!(otherinstanceofAuthenticationCacheKey))returnfalse;AuthenticationCacheKeyotherKey=(AuthenticationCacheKey)other;return(filterName==otherKey.filterName||(filterName!=null&&filterName.equals(otherKey.filterName)))&&(cacheKey==otherKey.cacheKey||(cacheKey!=null&&cacheKey.equals(otherKey.cacheKey)));
if(document==null){thrownewServiceException("Codingerrorindecorator"+decorator+",documentobjectscannotbesettonull");
if(folder==null){break;
if(folder==null){continue;
if(!(fcinstanceofSimpleFeatureCollection)){thrownewServiceException("TheKMLoutputformatcanonlybeappliedtosimplefeatures");
if(sourceCRS!=null&&!CRS.equalsIgnoreMetadata(sourceCRS,DefaultGeographicCRS.WGS84)){sfc=newReprojectingFeatureCollection(sfc,DefaultGeographicCRS.WGS84);
ifthereisnosuchdescriptor
if(pd==null){//thisisaspecialcaseusedbytheNamespaceInfoImplsetURI//thepropertyNamecomingfromtheModificationProxyissetto'uRI'//letssetittouripropertyName=propertyName.toUpperCase();pd=PropertyUtils.getPropertyDescriptor(info,propertyName);
if(pd==null){return;
if(pd.getWriteMethod()!=null){PropertyUtils.setProperty(info,propertyName,value);
else{//Tinterfacedonotdeclaresettermethodforthisproperty//letsusegettermethodstogetthepropertyreferencefinalObjectproperty=PropertyUtils.getProperty(info,propertyName);//checktypeofpropertytoapplynewvalue
if(Collection.class.isAssignableFrom(pd.getPropertyType())){finalCollection<?>liveCollection=(Collection<?>)property;liveCollection.clear();liveCollection.addAll((Collection)value);
else
if(Map.class.isAssignableFrom(pd.getPropertyType())){finalMap<?,?>liveMap=(Map<?,?>)property;liveMap.clear();liveMap.putAll((Map)value);
else{
if(CatalogUtils.LOGGER.isLoggable(java.util.logging.Level.SEVERE))CatalogUtils.LOGGER.severe("Skippingunwritableproperty"+propertyName+"withpropertytype"+pd.getPropertyType());
ifnotdisablethepanelandemitwarningmessagebooleanisAdmin=getSecurityManager().checkAuthenticationForAdminRole();setEnabled(isAdmin);add(newLabel("message",isAdmin?newModel():newStringResourceModel("notAdmin",this,null)));
if(!isAdmin){get("message").add(newAttributeAppender("class",newModel("info-link"),""));
iftheconfigurationobjectrepresentsanewconfiguration,oranexistingone.*/protectedbooleanisNew(){returnconfigModel.getObject().getId()==null;
if(name.toLowerCase().endsWith("shp"))shapeFileName=outName;//copyeachfiletotempfolderFileOutputStreamoutFile=newFileOutputStream(outName);copyStream(zis,outFile);outFile.close();zis.closeEntry();
if(Geometry.class.isAssignableFrom(attrValue.getClass()))assertFalse("Emptygeometry",((Geometry)attrValue).isEmpty());
elseassertFalse("Emptyvalueforattribute",attrValue.toString().trim().equals(""));
if(file.exists()){file.delete();
if(name.toLowerCase().endsWith(".txt")){//notpartoftheshapefile,it'stherequestdumpcontinue;
if(name.toLowerCase().endsWith(fileName.toLowerCase())){StringunzippedFileContents=IOUtils.toString(zis);assertEquals(expectedContent,unzippedFileContents);return;
if(entry.getName().endsWith(".cst")){zis.read(bytes);
if(bytes==null)returnnull;
elsereturnnewString(bytes).trim();
if(entry.getName().endsWith(".txt")){zis.read(bytes);
if(bytes==null)returnnull;
elsereturnnewString(bytes).trim();
if(featureType==null){//lookupincatalogFeatureTypeInfometa=catalog.getFeatureTypeByName(name);
if(meta!=null){try{featureType=meta.getFeatureType();//throwintothecacheput(featureType);
ifitdoesn'texistinstoreassertFalse(noiconFile.exists());//GEOS-7741:verifytheiconfileiscreated
ifitdoesexistinstoreassertTrue(iconFile.exists());ctx.destroy();ctx.close();}}
if(secMgr.listFilters().contains("custom")){secMgr.removeFilter(secMgr.loadFilterConfig("custom"));
if(pos==Pos.FIRST)mgrConfig.getFilterChain().insertFirst("/**","custom");
if(pos==Pos.LAST)mgrConfig.getFilterChain().insertLast("/**","custom");
if(pos==Pos.BEFORE)mgrConfig.getFilterChain().insertBefore("/**","custom",relativeTo);
if(pos==Pos.AFTER)mgrConfig.getFilterChain().insertAfter("/**","custom",relativeTo);secMgr.saveSecurityConfig(mgrConfig);
if(assertAuth){//assertNotNull(auth);//
else{//assertNull(auth);//
if(service.getWorkspace()==null){//createthepanelthathasthedropdownlistto
switchbetweenworkspaceform.add(newGlobalWorkspacePanel("workspace"));
else{//createjustapanelwithalabelthatsignifiestheworkspaceform.add(newLocalWorkspacePanel("workspace",service));
ifGeoServerEnvParametrizationisenabled!
if(gsEnvironment==null||!GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){onlineResource.add(newUrlValidator());
if(!getServiceClass().equals(panel.getServiceClass())){it.remove();
ifneedbe.**@paraminfo*/protectedvoidhandleSubmit(Tinfo){
if(info.getId()!=null){getGeoServer().save(info);
else{//meansanonattachedinstancewaspassedtous,donothing,uptocallertoaddit//toconfiguration
if(this.id==null){this.service=service;
if(id!=null){return(T)getGeoServer().getService(id,getServiceClass());
if(serviceClass!=null){
if(workspaceName!=null){WorkspaceInfows=getCatalog().getWorkspaceByName(workspaceName);return(T)getGeoServer().getService(ws,getServiceClass());
if(id==null&&serviceClass==null){//keepreferenceserializeserviceobjectservice=getObject();
else{service=null;
if(gs.getService(it.next(),getServiceClass())==null){it.remove();
if(ws!=null){pp.add("workspace",ws.getName());
ifneededforeachspecificOWStoincludeadditionalmetadataforeachtypeofdataset.Ifneeded,thistypeshouldfirstberestrictedforeachspecificOWStochangethemultiplicity(oroptionality)ofsomeelements.&lt;/documentation&gt;*&lt;/annotation&gt;*&lt;complexContent&gt;*&lt;extensionbase="ows:DescriptionType"&gt;*&lt;sequence&gt;*&lt;elementminOccurs="0"ref="ows:Identifier"&gt;*&lt;annotation&gt;*&lt;documentation&gt;Optionaluniqueidentifierornameofthisdataset.&lt;/documentation&gt;*&lt;/annotation&gt;*&lt;/element&gt;*&lt;elementmaxOccurs="unbounded"minOccurs="0"ref="ows:BoundingBox"&gt;*&lt;annotation&gt;*&lt;documentation&gt;Unorderedlistofzeroormoreboundingboxeswhoseuniondescribestheextentofthisdataset.&lt;/documentation&gt;*&lt;/annotation&gt;*&lt;/element&gt;*&lt;elementmaxOccurs="unbounded"minOccurs="0"ref="ows:OutputFormat"&gt;*&lt;annotation&gt;*&lt;documentation&gt;Unorderedlistofzeroormorereferencestodataformatssupportedforserveroutputs.&lt;/documentation&gt;*&lt;/annotation&gt;*&lt;/element&gt;*&lt;elementmaxOccurs="unbounded"minOccurs="0"ref="ows:AvailableCRS"&gt;*&lt;annotation&gt;*&lt;documentation&gt;Unorderedlistofzeroormoreavailablecoordinatereferencesystems.&lt;/documentation&gt;*&lt;/annotation&gt;*&lt;/element&gt;*&lt;elementmaxOccurs="unbounded"minOccurs="0"ref="ows:Metadata"&gt;*&lt;annotation&gt;*&lt;documentation&gt;Optionalunorderedlistofadditionalmetadataaboutthisdata(set).AlistofoptionalmetadataelementsforthisdataidentificationcouldbespecifiedintheImplementationSpecificationforthisservice.&lt;/documentation&gt;*&lt;/annotation&gt;*&lt;/element&gt;*&lt;/sequence&gt;*&lt;/extension&gt;*&lt;/complexContent&gt;*&lt;/complexType&gt;**</code>*</pre>**@generated*/publicclassIdentificationTypeBindingextendsAbstractComplexBinding{Ows10Factoryowsfactory;publicIdentificationTypeBinding(Ows10Factoryowsfactory){this.owsfactory=owsfactory;
if(eventinstanceofLoggingInfo)returntrue;
elsereturnfalse;
switchbetweenconfigurationsdropdownPanel=newDropDownChoiceParamPanel("configChoicePanel",newDropDownModel(model),newResourceModel("RepositoryImportPanel.repositoryType","RepositoryType"),DropDownModel.CONFIG_LIST,true);finalDropDownChoice<Serializable>dropDownChoice=dropdownPanel.getFormComponent();dropDownChoice.add(newAjaxFormComponentUpdatingBehavior("change"){privatestaticfinallongserialVersionUID=1L;@OverrideprotectedvoidonUpdate(AjaxRequestTargettarget){finalStringvalue=dropDownChoice.getModelObject().toString();repoDirectoryComponent.setVisible(DropDownModel.DIRECTORY_CONFIG.equals(value));pgPanel.setVisible(DropDownModel.PG_CONFIG.equals(value));repoNamePanel.setVisible(DropDownModel.PG_CONFIG.equals(value));target.add(settingsPanel);
if(RepositoryManager.get().repoExistsByName(repo.getRepoName())){error.addKey("errRepositoryNameExists");validatable.error(error);return;
if(RepositoryManager.get().repoExistsByLocation(location)){error.addKey("errRepositoryAlreadyConfigured");return;
if(error.getKeys().isEmpty()){finalRepositoryResolverresolver=RepositoryResolver.lookup(location);finalStringscheme=location.getScheme();
if("file".equals(scheme)){FilerepoDir=newFile(location);
if(!repoDir.exists()||!repoDir.isDirectory()){error.addKey("errRepositoryDirectoryDoesntExist");
if(!isGeogigDirectory(repoDir)){error.addKey("notAGeogigRepository");
else
if("postgresql".equals(scheme)){try{
if(!resolver.repoExists(location)){error.addKey("errRepositoryDoesntExist");
if(!error.getKeys().isEmpty()){validatable.error(error);
if(null!=repoTypeChoice){
switch(repoTypeChoice){caseDropDownModel.PG_CONFIG://PGconfigusedPostgresConfigBeanbean=pgPanel.getConvertedInput();//buildaURIoutoftheconfigURIuri=bean.buildUriForRepo(repoNamePanel.getFormComponent().getConvertedInput().toString().trim());repoInfo.setLocation(uri);break;caseDropDownModel.DIRECTORY_CONFIG://localdirectoryusedImportRepositoryFormBeanformBean=repoDirectoryComponent.getConvertedInput();PathuriPath=Paths.get(formBean.getRepoDirectory());repoInfo.setLocation(uriPath.toUri());break;default:thrownewIllegalStateException(String.format("Unknownrepositrytype'%s',expectedoneof%s,%s",repoTypeChoice,DropDownModel.PG_CONFIG,DropDownModel.DIRECTORY_CONFIG));
if(repoDir!=null&&!repoDir.trim().isEmpty()){repoDirFile=newFile(repoDir);
if("admin".equals(entry.getValue()))adminKey=(String)entry.getKey();
if("cite".equals(entry.getValue()))citeKey=(String)entry.getKey();
if(adminKey==null)thrownewRuntimeException("Missingadminkey");
if(citeKey==null)thrownewRuntimeException("Missingcitekey");
if(property!=null){InputStreamresourceAsStream=newFileInputStream(property);prop.load(resourceAsStream);
if(piinstanceofLayerInfo){LayerInfoli=(LayerInfo)pi;
if(li.getResource()instanceofCoverageInfo){CoverageStoreInfostore=(CoverageStoreInfo)li.getResource().getStore();
if(IMAGE_MOSAIC_FORMAT_NAME.equals(store.getType())){result.add(entry);
if{@codecommitted==false},thetransactionresultobjecttobe*sentbacktotheclientotherwise.*@paramcommittedtrue
ifthetransactionwassuccessful,false
ifthetransactionwasaborted*foranyreason*/voidafterTransaction(TransactionRequestrequest,TransactionResponseresult,booleancommitted);@OverridedefaultintgetPriority(){returnExtensionPriority.LOWEST;}}
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Savingstatus"+status);
if(oldStatus!=null){ProcessStatepreviousPhase=oldStatus.getPhase();ProcessStatecurrPhase=status.getPhase();
if(!currPhase.isValidSuccessor(previousPhase)){thrownewWPSException("Cannot
switchprocessstatusfrom"+previousPhase+"to"+currPhase);
else{ExecutionStatusprevious=statuses.put(status.getExecutionId(),status);succeded=previous==null;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Removingstatusforexecutionid:"+executionId);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Removingstatusesmatching:"+filter);
ifwehavepost-filteringwearegoingtorunanentryprocessor,//tofilterintheclusterandaccumulate,otherwisewearegoingtorunthepredicate//ontheclusterandpage
ifweneed/can
if(postFilter!=null&&postFilter!=Filter.INCLUDE){FilteringEntryProcessorfilterProcessor=newFilteringEntryProcessor(postFilter);Map<String,Object>entries=statuses.executeOnEntries(filterProcessor);List<ExecutionStatus>result=newArrayList(entries.values());returnpostProcessResults(query,maxFeatures,startIndex,needsSorting,result);
else{//see
ifwecanhandlepaging.Wedopaging
ifwehavetheelementstodoitand//thepostfilter
if((maxFeatures<Integer.MAX_VALUE||startIndex>0)&&postFilter!=null){//handlesortingduringpaging
ifpossibleComparator<Map.Entry>pagingComparator=null;
if(needsSorting){pagingComparator=getComparator("value.",query.getSortBy());
if(pagingComparator!=null){predicate=newPagingPredicate(predicate,pagingComparator,maxFeatures);
else{predicate=newPagingPredicate(predicate,maxFeatures);
if(predicateinstanceofPagingPredicate){intposition=0;PagingPredicatepp=(PagingPredicate)predicate;while(position<startIndex-maxFeatures){pp.nextPage();position+=maxFeatures;
if(startIndex>position){page=page.subList(startIndex-position,page.size());
if(result.size()<maxFeatures){intmissing=maxFeatures-result.size();pp.nextPage();List<ExecutionStatus>nextPage=newArrayList<>(statuses.values(pp));page=nextPage.subList(0,Math.min(missing,nextPage.size()));result.addAll(page);
if(needsSorting){Comparator<ExecutionStatus>comparator=getComparator("",query.getSortBy());Collections.sort(result,comparator);
if(startIndex>0){
if(startIndex>result.size()){result.clear();
else{result=newArrayList<>(result.subList(startIndex,result.size()));
if(maxFeatures<Integer.MAX_VALUE&&maxFeatures<result.size()){result=newArrayList<>(result.subList(0,maxFeatures));
if(sorts==null||sorts.length==0){returnnull;
if(sort==SortBy.NATURAL_ORDER){comparators.add(newBeanComparator(prefix+"creationTime"));
else
if(sort==SortBy.REVERSE_ORDER){comparators.add(Collections.reverseOrder(newBeanComparator(prefix+"creationTime")));
else{Stringproperty=sort.getPropertyName().getPropertyName();Comparatorcomparator=newBeanComparator(prefix+property);
if(sort.getSortOrder()==SortOrder.DESCENDING){comparator=Collections.reverseOrder(comparator);
if(comparators.size()>1){returnnewCompositeComparator(comparators);
else{returncomparators.get(0);
if(preFilter==Filter.INCLUDE){predicate=TruePredicate.INSTANCE;
else{FilterToCriteriatransformer=newFilterToCriteria();predicate=(Predicate<String,ExecutionStatus>)preFilter.accept(transformer,null);
if(this.filter==null){try{this.filter=ECQL.toFilter(cql);
if(getFilter().evaluate(entry.getValue())){map.remove(entry.getKey());return1;
if(getFilter().evaluate(entry.getValue())){returnentry.getValue();
if(dimension.getDimensionName().equalsIgnoreCase(histogram)){returndimension.getHistogram(filter,resolution);
if(resourceInfoinstanceofFeatureTypeInfo){//accessingthefeaturesofavectorreturnnewFilteredFeatureType((FeatureTypeInfo)resourceInfo,filter).getFeatureSource(null,null).getFeatures();
if(!(readerinstanceofStructuredGridCoverage2DReader)){thrownewRuntimeException("Isnotpossibletoobtainafeaturecollectionfromanonstructuredreader.");
if(filter!=null){query.setFilter(filter);
if(finalServiceinstanceofJmsTestServiceInfoImpl){getGeoServer().remove(finalService);
if(workspaceName!=null){//thisisavirtualserviceserviceInfo.setWorkspace(getCatalog().getWorkspace(workspaceName));
if(workspaceName==null){//globalservicereturnModificationProxy.unwrap(getGeoServer().getServiceByName(serviceName,ServiceInfo.class));
if((request!=null)&&(request.getAcceptFormats()!=null)){//lookforanacceptedformatList<String>formats=request.getAcceptFormats().getOutputFormat();for(Stringformat:formats){
if(format.endsWith("/xml")){returnformat;
if(this==obj)returntrue;
if(!super.equals(obj))returnfalse;
if(getClass()!=obj.getClass())returnfalse;WMTSAccessLimitsother=(WMTSAccessLimits)obj;
if(rasterFilter==null){
if(other.rasterFilter!=null)returnfalse;
else
if(!rasterFilter.equals(other.rasterFilter))returnfalse;returntrue;}}
if(auth!=null&&!(authinstanceofAnonymousAuthenticationToken)){Stringname=auth.getName();
if(envVars==null){envVars=newHashMap<String,Object>();
if(envVars!=null){EnvFunction.setLocalValues(envVars);
if(SRSProvider.CODE.equals(property)){ComponentlinkForCode=createLinkForCode(id,itemModel);returnlinkForCode;
else
if(SRSProvider.DESCRIPTION.equals(property)){Stringdescription=srs.getDescription();returnnewLabel(id,description.trim());
else{thrownewIllegalArgumentException("Unknownproperty:"+property);
if(cmap!=null&&cmap.getColorMapEntries()!=null*&&cmap.getColorMapEntries().length>0){**//passingadditionaloptions*cmapLegendBuilder.setAdditionalOptions(request.getLegendOptions());***//settingtypeofcolormap*cmapLegendBuilder.setColorMapType(cmap.getType());**//isthiscolormapusingextendedcolors*cmapLegendBuilder.setExtended(cmap.getExtendedColors());***//settingtherequestedcolormapentries*cmapLegendBuilder.setRequestedDimension(newDimension(width,height));**//settingtransparencyandbackgroundbkgColor*cmapLegendBuilder.setTransparent(transparent);*cmapLegendBuilder.setBackgroundColor(bgColor);**//settingband**//SettinglabelfontandfontbkgColor*cmapLegendBuilder.setLabelFont(LegendUtils.getLabelFont(request));*cmapLegendBuilder.setLabelFontColor(LegendUtils.getLabelFontColor(request));***//setband*finalChannelSelectionchannelSelection=rasterSymbolizer.getChannelSelection();*cmapLegendBuilder.setBand(channelSelection!=null?channelSelection.getGrayChannel():null);**//addingthecolormapentries*finalColorMapEntry[]colorMapEntries=cmap.getColorMapEntries();*for(ColorMapEntryce:colorMapEntries)*
if(ce!=null)*cmapLegendBuilder.addColorMapEntry(ce);**cMapLegendCreator=cmapLegendBuilder.create();*
switch(colorMapType){caseUNIQUE_VALUES:element=newSingleColorMapEntryLegendBuilder(Arrays.asList(cEntry),hAlign,vAlign,backgroundColor,1.0,grayChannelName,requestedDimension,labelFont,labelFontColor,extended,borderColor,unit,digits,alternativeColorMapEntryBuilder);break;caseRAMP:element=newRampColorMapEntryLegendBuilder(Arrays.asList(previousCMapEntry,cEntry),hAlign,vAlign,backgroundColor,1.0,grayChannelName,requestedDimension,labelFont,labelFontColor,extended,borderColor,unit,digits,alternativeColorMapEntryBuilder);break;caseCLASSES:element=newClassesEntryLegendBuilder(Arrays.asList(previousCMapEntry,cEntry),hAlign,vAlign,backgroundColor,1.0,grayChannelName,requestedDimension,labelFont,labelFontColor,extended,borderColor,unit,digits,alternativeColorMapEntryBuilder);break;default:thrownewIllegalArgumentException("Unrecognizedcolormaptype");
if(grayChannel!=null)this.grayChannelName=grayChannel.getChannelName().evaluate(null,String.class);
if(grayChannelName==null)this.grayChannelName=LegendUtils.DEFAULT_CHANNEL_NAME;
if(additionalOptions.get("fontAntiAliasing")instanceofString){StringaaVal=(String)additionalOptions.get("fontAntiAliasing");
if(aaVal.equalsIgnoreCase("on")||aaVal.equalsIgnoreCase("true")||aaVal.equalsIgnoreCase("yes")||aaVal.equalsIgnoreCase("1")){fontAntiAliasing=true;
if(additionalOptions.get("dx")instanceofString){columnMarginPercentage=Double.parseDouble((String)additionalOptions.get("dx"));
if(additionalOptions.get("absoluteMargins")instanceofString){absoluteMargins=Boolean.parseBoolean((String)additionalOptions.get("absoluteMargins"));
if(additionalOptions.get("bandInfo")instanceofString){bandInformation=Boolean.parseBoolean((String)additionalOptions.get("bandInfo"));
if(additionalOptions.get("dy")instanceofString){rowMarginPercentage=Double.parseDouble((String)additionalOptions.get("dy"));
if(additionalOptions.get("mx")instanceofString){hMarginPercentage=Double.parseDouble((String)additionalOptions.get("mx"));
if(additionalOptions.get("my")instanceofString){vMarginPercentage=Double.parseDouble((String)additionalOptions.get("my"));
if(additionalOptions.get("borderColor")instanceofString){borderColor=LegendUtils.color((String)additionalOptions.get("borderColor"));
if(additionalOptions.get("border")instanceofString){border=Boolean.valueOf((String)additionalOptions.get("border"));
if(additionalOptions.get("forceRule")instanceofString){forceRule=Boolean.parseBoolean((String)additionalOptions.get("forceRule"));
ifallthelabelsarenull,weMUSTdrawtherules
if(!forceRule)for(ColorMapEntryLegendBuilderrow:bodyRows){////rownumberi////labelfinalCelllabelM=row.getLabelManager();
if(labelM==null)forceRule=true;
else{forceRule=false;break;
if(value.equalsIgnoreCase("intervals"))returnCLASSES;
else
if(value.equalsIgnoreCase("ramp")){returnRAMP;
else
if(value.equalsIgnoreCase("values")){returnUNIQUE_VALUES;
elsereturnColorMapType.valueOf(value);
switch(value){caseColorMap.TYPE_INTERVALS:returnColorMapType.CLASSES;caseColorMap.TYPE_RAMP:returnColorMapType.RAMP;caseColorMap.TYPE_VALUES:returnColorMapType.UNIQUE_VALUES;default:thrownewIllegalArgumentException("UnabletocreateColorMapTypeforvalue"+value);
if(legend==null){//initallthevaluesinit();//nowbuildtheindividualslegends////header////XXXnoheaderforthemoment////body//finalQueue<BufferedImage>body=createBody();////footer//
if(bandInformation){finalQueue<BufferedImage>footer=createFooter();body.addAll(footer);
if(bandInformation){finalStringbandNameString="Bandselectionis"+this.grayChannelName;footerRows.add(newCell.TextManager(bandNameString,vAlign,hAlign,backgroundColor,requestedDimension,labelFont,labelFontColor,fontAntiAliasing,borderColor));//setfooterstringsfinalStringcolorMapTypeString="ColorMaptypeis"+this.colorMapType.toString();footerRows.add(newCell.TextManager(colorMapTypeString,vAlign,hAlign,backgroundColor,requestedDimension,labelFont,labelFontColor,fontAntiAliasing,borderColor));//extendedcolorsornotfinalStringextendedCMapString="ColorMapis"+(this.extended?"":"not")+"extended";footerRows.add(newCell.TextManager(extendedCMapString,vAlign,hAlign,backgroundColor,requestedDimension,labelFont,labelFontColor,fontAntiAliasing,borderColor));cycleFooterRows(graphics);
if(forceRule){finalCellruleM=row.getRuleManager();finalDimensionruleDim=ruleM.getPreferredDimension(graphics);rowH=Math.max(rowH,ruleDim.getHeight());ruleW=Math.max(ruleW,ruleDim.getWidth());
if(labelM==null)continue;finalDimensionlabelDim=labelM.getPreferredDimension(graphics);rowH=Math.max(rowH,labelDim.getHeight());labelW=Math.max(labelW,labelDim.getWidth());
if(forceRule){//getelementforrulefinalCellruleCell=row.getRuleManager();//drawitruleCellLegend=newBufferedImage(ruleWidth,rowHeight,BufferedImage.TYPE_INT_ARGB);rlg=ruleCellLegend.createGraphics();rlg.setRenderingHint(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_ON);rlg.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_ON);ruleCell.draw(rlg,clipboxB,borderRule);rlg.dispose();
ifitispresent
if(labelWidth>0){//getelementforlabelfinalCelllabelCell=row.getLabelManager();
if(labelCell!=null){finalBufferedImagelabelCellLegend=newBufferedImage(labelWidth,rowHeight,BufferedImage.TYPE_INT_ARGB);rlg=labelCellLegend.createGraphics();rlg.setRenderingHint(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_ON);rlg.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_ON);labelCell.draw(rlg,clipboxC,borderLabel);rlg.dispose();////mergethebodyCellsforthisrow////finalMap<Key,Object>hintsMap=newHashMap<Key,Object>();queue.add(LegendUtils.hMergeBufferedImages(colorCellLegend,ruleCellLegend,labelCellLegend,hintsMap,transparent,backgroundColor,dx));
else{finalMap<Key,Object>hintsMap=newHashMap<Key,Object>();queue.add(LegendUtils.hMergeBufferedImages(colorCellLegend,ruleCellLegend,null,hintsMap,transparent,backgroundColor,dx));
else{////mergethebodyCellsforthisrow////finalMap<Key,Object>hintsMap=newHashMap<Key,Object>();queue.add(LegendUtils.hMergeBufferedImages(colorCellLegend,ruleCellLegend,null,hintsMap,transparent,backgroundColor,dx));
if(colorMapType==ColorMapType.RAMP){finalMap<Key,Object>hintsMap=newHashMap<Key,Object>();Graphics2DfinalGraphics=ImageUtils.prepareTransparency(transparent,backgroundColor,finalLegend,hintsMap);hintsMap.put(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_ON);finalGraphics.setRenderingHints(hintsMap);inttopOfRow=(int)(margin+0.5);for(inti=0;i<numRows;i++){finalBufferedImageimg=legendsQueue.remove();//drawtheimagefinalGraphics.drawImage(img,(int)(margin+0.5),topOfRow,null);topOfRow+=img.getHeight()+dy;
if(this.layout==LegendLayout.HORIZONTAL){BufferedImagenewImage=newBufferedImage(totalHeight,totalWidth,finalLegend.getType());Graphics2Dg2=newImage.createGraphics();g2.rotate(-Math.PI/2,0,0);g2.drawImage(finalLegend,null,-totalWidth,0);finalLegend=newImage;g2.dispose();finalGraphics.dispose();
else{List<RenderedImage>imgs=newArrayList<RenderedImage>(legendsQueue);LegendMerger.MergeOptionsoptions=newLegendMerger.MergeOptions(imgs,(int)dx,(int)dy,(int)margin,0,backgroundColor,transparent,true,layout,rowWidth,rows,columnHeight,columns,null,false,false,false);finalLegend=LegendMerger.mergeRasterLegends(options);
if("".equals(name)){returnexpression;
if(sourceName==null){thrownewServiceException("Simplefeaturetranslationfailed,couldnotback-map'"+name+"'toasourceproperty");
else{returnff.property(sourceName);
iftrue,nosinglesignonpossible*/privatebooleansendRenew;/***TheCASserverURLincludingcontextroot**<p>example"https://localhost:9443/cas"*/privateStringcasServerUrlPrefix;/***Thegeoserverurlfortheproxycallback**<p>example:http://localhost:8080/geoserver*/privateStringproxyCallbackUrlPrefix;/***Optional:**<p>AfterasuccessfulCASlogouttriggeredbygeoserver,acasresponsepageisrendered.**<p>ThisurlshouldberenderedasalinkintheCASresponsepage.**<p>example:https://myhost:8443/geoserver*/privateStringurlInCasLogoutPage;/**ParticipateinSingleSignOut.*/privatebooleansingleSignOut;publicbooleanisSendRenew(){returnsendRenew;
if(featureinstanceofGridCoverage2D){GridCoverage2Dcoverage=(GridCoverage2D)feature;val=evaluate(coverage,bandIndex,propertyName);
if(val!=null){returnval;
if("minimum".equalsIgnoreCase(statName)){returnensureNotNull(sd,bandIndex,statName,getMinimum(sd));
else
if("maximum".equalsIgnoreCase(statName)){returnensureNotNull(sd,bandIndex,statName,getMaximum(sd));
else{thrownewIllegalArgumentException("Invalidproperty"+statName+",supportedvaluesare'minimum'and'maximum'");
if(value!=null){returnvalue;
else{thrownewRuntimeException("Couldnotfindthe"+statName+"from"+sd+"ofband"+bandIndex);
if(!Category.NODATA.getName().equals(cat.getName())&&!Double.isNaN(result)){returnresult;
if(!Category.NODATA.getName().equals(cat.getName())&&!Double.isNaN(result)){returnresult;
if(item==null){//byspecwehavetoreturna404thrownewHttpErrorCodeException(404,"Norepositoryitemfoundforid"+request.getId());
ifthecontainerhasbeencreatedImageDecoderContainercontainer=context.getBean(ImageDecoderContainer.class);Assert.assertNotNull(container);}}
if(input==null){ServletInputStreamdelegateTo=super.getInputStream();input=newMonitorInputStream(delegateTo,maxSize);
if(encoding==null){returnnewBufferedReader(newInputStreamReader(getInputStream()));
else{returnnewBufferedReader(newInputStreamReader(getInputStream(),encoding));
if(maxSize>0){buffer=newByteArrayOutputStream();
if(!bufferIsFull()){buffer.write((byte)b);
if(b>=0)nbytes+=1;//IncrementbytecountunlessEoFmarkerreturnb;
if(len<0)return;
if(!bufferIsFull()){
if(maxSize>0){longresidual=maxSize-buffer.size();len=len<residual?len:(int)residual;
ifthereisnoauthenticatedprincipal*/@OverridepublicvoiddoFilter(ServletRequestrequest,ServletResponseresponse,FilterChainchain)throwsIOException,ServletException{//Searchforanaccess_tokenontherequest(simulatingSSO)finalStringaccessToken=getParameterValue("access_token",request);OAuth2AccessTokentoken=restTemplate.getOAuth2ClientContext().getAccessToken();
if(accessToken!=null&&token!=null&&!token.getValue().equals(accessToken)){restTemplate.getOAuth2ClientContext().setAccessToken(null);
if(accessToken==null&&customSessionCookie==null&&(authentication!=null&&(authenticationinstanceofPreAuthenticatedAuthenticationToken)&&!(authorities.size()==1&&authorities.contains(GeoServerRole.ANONYMOUS_ROLE)))){finalAccessTokenRequestaccessTokenRequest=restTemplate.getOAuth2ClientContext().getAccessTokenRequest();
if(accessTokenRequest!=null&&accessTokenRequest.getStateKey()!=null){restTemplate.getOAuth2ClientContext().removePreservedState(accessTokenRequest.getStateKey());
if((authentication==null&&accessToken!=null)||authentication==null||(authentication!=null&&authorities.size()==1&&authorities.contains(GeoServerRole.ANONYMOUS_ROLE))){doAuthenticate((HttpServletRequest)request,(HttpServletResponse)response);AuthenticationpostAuthentication=authentication;
if(postAuthentication!=null){
if(cacheAuthentication(postAuthentication,(HttpServletRequest)request)){getSecurityManager().getAuthenticationCache().put(getName(),getCacheKey((HttpServletRequest)request),postAuthentication);
if(paramName.equalsIgnoreCase(param)){returnrequest.getParameter(param);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("InspectingthehttprequestlookingfortheCustomSessionID.");
if(cookies!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Found"+cookies.length+"cookies!");
if(c.getName().equalsIgnoreCase(SESSION_COOKIE_NAME)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("FoundCustomSessioncookie:"+c.getValue());
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Foundnocookies!");
if((token!=null&&token.getTokenType().equalsIgnoreCase(OAuth2AccessToken.BEARER_TYPE))||request.getRequestURI().endsWith(filterConfig.getLogoutEndpoint())){finalAccessTokenRequestaccessTokenRequest=restTemplate.getOAuth2ClientContext().getAccessTokenRequest();
if(accessTokenRequest!=null&&accessTokenRequest.getStateKey()!=null){restTemplate.getOAuth2ClientContext().removePreservedState(accessTokenRequest.getStateKey());
if(name.equalsIgnoreCase("JSESSIONID")){CookiecookieToDelete=allCookies[i];cookieToDelete.setMaxAge(-1);cookieToDelete.setPath("/");cookieToDelete.setComment("EXPIRINGCOOKIEat"+System.currentTimeMillis());response.addCookie(cookieToDelete);
if(principal==null||principal.trim().length()==0){result=newPreAuthenticatedAuthenticationToken(principal,null,Collections.singleton(GeoServerRole.ANONYMOUS_ROLE));
else{
if(GeoServerUser.ROOT_USERNAME.equals(principal)){result=newPreAuthenticatedAuthenticationToken(principal,null,Arrays.asList(GeoServerRole.ADMIN_ROLE,GeoServerRole.GROUP_ADMIN_ROLE,GeoServerRole.AUTHENTICATED_ROLE));
else{Collection<GeoServerRole>roles=null;try{roles=getRoles(request,principal);
if(roles.contains(GeoServerRole.AUTHENTICATED_ROLE)==false)roles.add(GeoServerRole.AUTHENTICATED_ROLE);RoleCalculatorcalc=newRoleCalculator(getSecurityManager().getActiveRoleService());
if(calc!=null){try{roles.addAll(calc.calculateRoles(principal));
if(req.getAttribute(UserNameAlreadyRetrieved)!=null)return(String)req.getAttribute(UserName);*///Searchforanaccess_tokenontherequest(simulatingSSO)finalStringaccessToken=getParameterValue("access_token",req);
if(accessToken!=null){restTemplate.getOAuth2ClientContext().setAccessToken(newDefaultOAuth2AccessToken(accessToken));
if(einstanceofUserRedirectRequiredException){
if(filterConfig.getEnableRedirectAuthenticationEntryPoint()||req.getRequestURI().endsWith(filterConfig.getLoginEndpoint())){//Interceptinga"UserRedirectRequiredException"andredirecttotheOAuth2//ProviderloginURIthis.aep.commence(req,resp,null);
else{
if(resp.getStatus()!=302){//AEPredirectionfailedfinalAccessTokenRequestaccessTokenRequest=restTemplate.getOAuth2ClientContext().getAccessTokenRequest();
if(accessTokenRequest.getPreservedState()!=null&&accessTokenRequest.getStateKey()!=null){//restTemplate.getOAuth2ClientContext().removePreservedState(accessTokenRequest.getStateKey());accessTokenRequest.remove("state");accessTokenRequest.remove(accessTokenRequest.getStateKey());accessTokenRequest.setPreservedState(null);
else
if(einstanceofBadCredentialsException||einstanceofResourceAccessException){
if(e.getCause()instanceofOAuth2AccessDeniedException){LOGGER.log(Level.WARNING,"ErrorwhiletryingtoauthenticatetoOAuth2ProviderwiththefollowingExceptioncause:",e.getCause());
else
if(einstanceofResourceAccessException){LOGGER.log(Level.SEVERE,"CouldnotAuthorizeOAuth2Resourceduetothefollowingexception:",e);
else
if(einstanceofResourceAccessException||e.getCause()instanceofOAuth2AccessDeniedException){LOGGER.log(Level.WARNING,"Itisworthnoticethat
ifyoutrytovalidatecredentialsagainstanSSHprotectedEndpoint,youneedeitheryourserverexposedonasecureSSLchannelorOAuth2ProviderCertificatetobetrustedonyourJVM!");LOGGER.info("PleaserefertotheGeoServerOAuth2PluginDocumentationinordertofindthestepsforimportingtheSSHcertificates.");
else{LOGGER.log(Level.SEVERE,"CouldnotAuthorizeOAuth2Resourceduetothefollowingexception:",e.getCause());
if(principal!=null&&principal.trim().length()==0)principal=null;try{
if(principal!=null&&PreAuthenticatedUserNameRoleSource.UserGroupService.equals(getRoleSource())){GeoServerUserGroupServiceservice=getSecurityManager().loadUserGroupService(getUserGroupServiceName());GeoServerUseru=service.getUserByUsername(principal);
if(u!=null&&u.isEnabled()==false){principal=null;handleDisabledUser(u,req);
if(principal!=null)req.setAttribute(UserName,principal);returnprincipal;
if(values.size()<2)thrownewWcsException("Invalidgridoffset,shouldhaveatleasttwovalues",WcsExceptionCode.InvalidParameterValue,"GridOffsets");Double[]offsets=newDouble[values.size()];for(inti=0;i<offsets.length;i++){try{offsets[i]=Double.valueOf((String)values.get(i));
ifanystylepropertiesin*thegivenstylearedynamic.Thismethodisintendedtoworkwithstylesthathavebeen*preprocessedbyIconPropertyExtractorandIconPropertyInjector.**@paramstyle*/publicstaticBufferedImagerenderIcon(Stylestyle){intsize=findIconSize(style)+2;//sizeisanintbecauseiconsarealwayssquareMapContentmapContent=newMapContent();mapContent.addLayer(newFeatureLayer(sampleData,style));BufferedImageimage=newBufferedImage(size*Icons.RENDER_SCALE_FACTOR,size*Icons.RENDER_SCALE_FACTOR,BufferedImage.TYPE_INT_ARGB);Graphics2Dgraphics=image.createGraphics();graphics.setRenderingHint(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_ON);graphics.scale(Icons.RENDER_SCALE_FACTOR,Icons.RENDER_SCALE_FACTOR);StreamingRendererrenderer=newStreamingRenderer();renderer.setMapContent(mapContent);try{try{renderer.paint(graphics,newRectangle(size,size),sampleArea);
if(style.featureTypeStyles().isEmpty())thrownewIllegalArgumentException("Featuretypestylelistwasempty");for(FeatureTypeStyleftStyle:style.featureTypeStyles()){
if(ftStyle.rules().isEmpty())thrownewIllegalArgumentException("Rulelistwasempty");for(Rulerule:ftStyle.rules()){
if(rule.symbolizers().isEmpty())thrownewIllegalArgumentException("Symbolizerlistwasempty");for(Symbolizersymbolizer:rule.symbolizers()){
if(symbolizerinstanceofPointSymbolizer){Graphicg=((PointSymbolizer)symbolizer).getGraphic();
if(g!=null){Doublerotation=g.getRotation()!=null?g.getRotation().evaluate(null,Double.class):null;size=Math.max(size,getGraphicSize(g,rotation));
else{thrownewIllegalArgumentException("IconRendereronlysupportsPointSymbolizer");
if(result==null){return(int)Icons.DEFAULT_SYMBOL_SIZE;
else{return(int)Math.ceil(result);
if(!dsFactory.isAvailable()){thrownewServiceException("SpatiaLitesupportnotavaialable,ensureallrequired"+"nativelibrariesareinstalled");
if(outputFileName==null){outputFileName=request.getQueries().get(0).getTypeNames().get(0).getLocalPart()+".db";
if("band".equals(property.getName())){Fragmentf=newFragment(id,"bandtext",CoverageBandsConfigurationPanel.this);Componenttext=newTextField<>("bandtext",(IModel<String>)property.getModel(itemModel));f.add(text);returnf;
if("nullValues".equals(property.getName())){Fragmentf=newFragment(id,"nulltext",CoverageBandsConfigurationPanel.this);Componenttext=newDecimalListTextField("nulltext",(IModel<List>)property.getModel(itemModel));f.add(text);returnf;
if("unit".equals(property.getName())){Fragmentf=newFragment(id,"text",CoverageBandsConfigurationPanel.this);Componenttext=buildUnitField("text",property.getModel(itemModel));f.add(text);returnf;
if("minRange".equals(property.getName())){Fragmentf=newFragment(id,"minRange",CoverageBandsConfigurationPanel.this);Componentmin=newDecimalTextField("minRange",(IModel<Double>)property.getModel(itemModel));f.add(min);returnf;
if("maxRange".equals(property.getName())){Fragmentf=newFragment(id,"maxRange",CoverageBandsConfigurationPanel.this);Componentmax=newDecimalTextField("maxRange",(IModel<Double>)property.getModel(itemModel));f.add(max);returnf;
if(metadata!=null&&metadata.containsKey(CoverageView.COVERAGE_VIEW)){GridCoverage2DReaderreader=(GridCoverage2DReader)catalog.getResourcePool().getGridCoverageReader(ci,nativeName,GeoTools.getDefaultHints());rebuilt=cb.buildCoverage(reader,nativeName,null);
else{rebuilt=cb.buildCoverage(nativeName);
if(Strings.isEmpty(input)){List<String>emptyList=Collections.emptyList();returnemptyList.iterator();
if(name.toLowerCase().startsWith(input.toLowerCase())){choices.add(name);
if(type==null){return"-";
else{Stringname=type.name();try{Stringkey=CoverageBandsConfigurationPanel.class.getSimpleName()+"."+name;ParamResourceModelrm=newParamResourceModel(key,null);returnrm.getString();
if(item.getRange()==null){returnnull;
if(min!=null){NumberRangerange=item.getRange();NumberRange<Double>newRange=NumberRange.create(min,range!=null?range.getMaximum():min);item.setRange(newRange);
if(item.getRange()==null){returnnull;
if(max!=null){NumberRangerange=item.getRange();NumberRange<Double>newRange=NumberRange.create(range!=null?range.getMinimum():max,max);item.setRange(newRange);
if(ci.getDimensions()!=null){returnci.getDimensions();
else{returnCollections.emptyList();
ifthespecifiedoutputformatissupported,falseotherwise**@paramoutputFormat*/booleancanProduce(StringoutputFormat);/***Returnsthecontenttypeforthespecifiedoutputformat**@paramoutputFormat*/StringgetMimeType(StringoutputFormat);/***Returnsanappropriatefileextensionforthecoveragesencodedwiththisdelegate(used*mainlywhenstoringthecoverageondiskforlaterretrieval).ForexampleaGeoTiffencoding*delegatemightreturn"tif"(noperiod,justextension).*/StringgetFileExtension(StringoutputFormat);/***Encodesthecoverageinthespecifiedoutputformatontotheoutputstream**@paramcoverage*@paramoutputFormat*@paramoutput*@throwsServiceException*@throwsIOException*/voidencode(GridCoverage2Dcoverage,StringoutputFormat,Map<String,String>econdingParameters,OutputStreamoutput)throwsServiceException,IOException;/**Returnsthelistofoutputformatsmanagedbythisdelegate*/List<String>getOutputFormats();/***True
iftheencoderisavailable,falseotherwise(possiblyduetomissinglibrariesandthe*like)*/booleanisAvailable();/***ReturnstheGMLconformanceclassforthisoutputformat.**@paramformat*/StringgetConformanceClass(Stringformat);/***Allowsthedelegatetospecifytheoutputformatgiventheobjecttoencodeandthe**@paramvalue*@paramcoverageId*@paramformat*@return*/defaultStringgetFileName(GridCoverage2Dvalue,StringcoverageId,Stringformat){returncoverageId+"."+getFileExtension(format);}}
if(data!=null)IOUtils.delete(data);
ifgdalwarpisavailable**@throwsIOException*/publicstaticbooleanisAvailable()throwsIOException{returnnewGdalWarpTransform(newArrayList<String>()).checkAvailable();
ifweneedtoupdatethelayerdefinition,wejustchangedtheCRSafterallLayerInfolayer=task.getLayer();ResourceInforesource=layer.getResource();StringoriginalSRS=resource.getSRS();//dosoonly
ifit'sadirectimport
if(layer.getId()!=null||resource==null||resource.getCatalog()==null){return;
if(tasks==null||tasks.isEmpty()){return;
ifthelayersrsisincompatiblewiththeonewejustreprojectedto,update
if//necessary
if(originalSRS==null||(!originalSRS.equals(updatedSRS)&&updatedSRS!=null)){resource.setSRS(updatedSRS);resource.setNativeCRS(updatedResource.getNativeCRS());resource.setNativeBoundingBox(updatedResource.getNativeBoundingBox());resource.setLatLonBoundingBox(updatedResource.getLatLonBoundingBox());
if(datainstanceofFileData){FileDatafd=(FileData)data;returnfd.getFile();
else{thrownewIOException("Canrungdalwarponlyagainstfiledata");
if(token.getPrincipal()==null||token.getPrincipal().toString().isEmpty())returnnull;Stringuser=token.getPrincipal().toString();Stringpassword=token.getCredentials()==null?"":token.getCredentials().toString();UserDetailsdetails=null;
if(userGroupServiceName!=null){try{GeoServerUserGroupServiceservice=getSecurityManager().loadUserGroupService(userGroupServiceName);details=service.loadUserByUsername(user);
if(details.isEnabled()==false){log(newDisabledException("User"+user+"isdisabled"));returnnull;
if(con!=null){try{con.close();
if(details!=null){roles.addAll(details.getAuthorities());
else{RoleCalculatorcalc=newRoleCalculator(getSecurityManager().getActiveRoleService());try{roles.addAll(calc.calculateRoles(newGeoServerUser(user)));
ifmissing.*/@TestpublicvoidtestCachedLegendURLFolderCreated()throwsException{GeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);FilesamplesFolder=newFile(loader.getBaseDirectory().getAbsolutePath()+File.separator+LegendSampleImpl.LEGEND_SAMPLES_FOLDER);removeFileOrFolder(samplesFolder);TransformerBasetr=createTransformer();tr.setIndentation(2);Documentdom=WMSTestSupport.transform(req,tr);assertTrue(samplesFolder.exists());
ifrelatedSLDisnewer.*/@TestpublicvoidtestCachedLegendURLUpdatedSize()throwsException{GeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);ResourcesldResource=loader.get(Paths.path("styles","Bridges.sld"));FilesampleFile=getSampleFile("Bridges");longlastTime=sampleFile.lastModified();longlastLength=sampleFile.length();longpreviousTime=sldResource.lastmodified();sldResource.file().setLastModified(lastTime+1000);//forcecleaningofsamplescache,togetupdatesonfiles((LegendSampleImpl)GeoServerExtensions.bean(LegendSample.class)).reloaded();TransformerBasetr=createTransformer();tr.setIndentation(2);Documentdom=WMSTestSupport.transform(req,tr);NodeListlegendURLs=XPATH.getMatchingNodes(getLegendURLXPath("cite:Bridges"),dom);assertEquals(1,legendURLs.getLength());ElementlegendURL=(Element)legendURLs.item(0);assertTrue(legendURL.hasAttribute("width"));assertEquals("20",legendURL.getAttribute("width"));assertTrue(legendURL.hasAttribute("height"));assertEquals("20",legendURL.getAttribute("height"));assertFalse(getSampleFile("Bridges").length()==lastLength);sldResource.file().setLastModified(previousTime);
ifrelatedSLDisnewer(usingCatalogevents).*/@TestpublicvoidtestCachedLegendURLUpdatedSize2()throwsException{GeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);ResourcesldResource=loader.get(Paths.path("styles","Bridges.sld"));FilesampleFile=getSampleFile("Bridges");longlastTime=sampleFile.lastModified();longlastLength=sampleFile.length();longpreviousTime=sldResource.lastmodified();sldResource.file().setLastModified(lastTime+1000);catalog.firePostModified(catalog.getStyleByName("Bridges"),newArrayList<String>(),newArrayList(),newArrayList());TransformerBasetr=createTransformer();tr.setIndentation(2);Documentdom=WMSTestSupport.transform(req,tr);NodeListlegendURLs=XPATH.getMatchingNodes(getLegendURLXPath("cite:Bridges"),dom);assertEquals(1,legendURLs.getLength());ElementlegendURL=(Element)legendURLs.item(0);assertTrue(legendURL.hasAttribute("width"));assertEquals("20",legendURL.getAttribute("width"));assertTrue(legendURL.hasAttribute("height"));assertEquals("20",legendURL.getAttribute("height"));assertFalse(getSampleFile("Bridges").length()==lastLength);sldResource.file().setLastModified(previousTime);
if(!file.exists()){return;
if(!file.isDirectory()){file.delete();
else{String[]list=file.list();for(inti=0;i<list.length;i++){removeFileOrFolder(newFile(file.getAbsolutePath()+File.separator+list[i]));
iftheschemaisbundledwithinthe*serverthelocationcanbearelativepathsuchas<tt>foo/foo.xsd</tt>.Inthelattercase*thepathwillbeappendedtothebaseurlfromwhichthecapabilitiesdocumentisbeing*requestedfrom.**@paramschemaBaseURL*/String[]getSchemaLocations(StringschemaBaseURL);/***Registersthexmlnsnamespaceprefix:urimappingsforanyelementsusedbytheextended*capabilities.*/voidregisterNamespaces(NamespaceSupportnamespaces);/***Encodestheextendedcoveragemetadata**@paramtxthetranslatorusedtoencodetheextendedcapabilitiesto*@paramcontexttheencodingcontext,eithera{@linkGridCoverage2DReader}ora{@link*GridCoverage2D}dependingonwhatisavailableonthecallerside*/voidencode(Translatortx,Objectcontext)throwsIOException;/**InterfaceforclientstoencodeXML.*/publicinterfaceTranslator{/***Startsanelementcreatingtheopeningtag.**@paramelementThenameoftheelement.*/voidstart(Stringelement);/***Startsanelementwithattributes,creatingtheopeningtag.**@paramelementThenameoftheelement.*@paramattributesTheattributesoftheelement.*/voidstart(Stringelement,Attributesattributes);/***Createsatextnodewithinanelement.**@paramtextThecharactertext.*/voidchars(Stringtext);/***Endsanelementcreatingaclosingtag.**@paramelement*/voidend(Stringelement);}}
ifthenamespacegivenbythequalifiednameprefix*exists*@paramstrict
if{@codetrue}andtheqnamebeingparsedcontainsanamespaceprefixthat*doesnotmatchanamespacefrom{@codecatalog},anexceptionwillbethrown,otherwisea*{@codeQName}withprefixandlocalNamebutwithoutnamespacewillbereturned.*/protectedQNameKvpParser(Stringkey,Catalogcatalog,booleanstrict){super(key,QName.class);this.catalog=catalog;this.strict=strict;
if(i!=-1){Stringprefix=token.substring(0,i);Stringlocal=token.substring(i+1);Stringuri=null;
if(prefix!=null&&!"".equals(prefix)){finalNamespaceInfonamespace=catalog.getNamespaceByPrefix(prefix);
if(strict&&namespace==null){thrownewWFSException("Unknownnamespace["+prefix+"]");
else{/*Stringuri=catalog.getDefaultNamespace().getURI();Stringprefix=catalog.getDefaultNamespace().getPrefix();Stringlocal=token;returnnewQName(uri,local,prefix);*/returnnewQName(token);
if(invocation.getMethod().getName().equals("describeEOCoverageSet")&&isEarthObservationEnabled()){try{DescribeEOCoverageSetTypedcs=(DescribeEOCoverageSetType)invocation.getArguments()[0];returndescribeEOCoverageSet(dcs);
if(einstanceofServiceException){throwe;
else{thrownewServiceException(e);
else{returninvocation.proceed();
if(dcs.getEoId()==null||dcs.getEoId().isEmpty()){thrownewOWS20Exception("RequiredparametereoIDmissing",newOWSExceptionCode("emptyEoIdList",404),"eoid");
if(layer==null){badCoverageIds.add(datasetId);
if(!badCoverageIds.isEmpty()){StringmergedIds=StringUtils.merge(badCoverageIds);thrownewWCS20Exception("Couldnotfindtherequestedcoverage(s):"+mergedIds,newOWSExceptionCode("noSuchEODataset",404),"eoid");
if(node.hasAttribute("service")){getCapabilities.setService((String)node.getAttributeValue("service"));
if(property==TYPE){Fragmentf=newFragment(id,"iconFragment",CachedLayersPage.this);PackageResourceReferencelayerIcon;TileLayerlayer=(TileLayer)itemModel.getObject();layerIcon=(PackageResourceReference)property.getPropertyValue(layer);f.add(newImage("layerIcon",layerIcon));returnf;
else
if(property==NAME){returnnameLink(id,itemModel);
else
if(property==QUOTA_LIMIT){IModel<Quota>quotaLimitModel=(IModel<Quota>)property.getModel(itemModel);returnquotaLink(id,quotaLimitModel);
else
if(property==QUOTA_USAGE){IModel<Quota>quotaUsageModel=(IModel<Quota>)property.getModel(itemModel);returnquotaLink(id,quotaUsageModel);
else
if(property==ENABLED){TileLayerlayerInfo=(TileLayer)itemModel.getObject();booleanenabled=layerInfo.isEnabled();PackageResourceReferenceicon;
if(enabled){icon=GWCIconFactory.getEnabledIcon();
else{icon=GWCIconFactory.getDisabledIcon();
else
if(property==PREVIEW_LINKS){returnpreviewLinks(id,itemModel);
else
if(property==ACTIONS){returnactionsLinks(id,itemModel);
else
if(property==BLOBSTORE){returnnull;
if(null==imageIOFileCachingThreshold||0L>=imageIOFileCachingThreshold.longValue()){StringwarningMsg=newResourceModel("GWC.ImageIOFileCachingThresholdUnsetWarning").getObject();super.warn(warningMsg);
if(null==quota){formattedQuota=newResourceModel("CachedLayersPage.quotaLimitNotSet").getObject();
else{formattedQuota=quota.toNiceString();
if(layerinstanceofGeoServerTileLayer){link=newConfigureCachedLayerAjaxLink(id,itemModel,CachedLayersPage.class);
else{link=newLabel(id,layerName);
if(usedQuota==null){usedQuota=newQuota();
if(!layer.isEnabled()){returnnewLabel(id,newResourceModel("previewDisabled"));
if(selection.isEmpty()){return;
ifthereissomethingtocancel,let'swarntheuseraboutwhat//couldgowrong,and
iftheuseraccepts,let'sdeletewhat'sneededdialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){privatestaticfinallongserialVersionUID=1L;@OverrideprotectedComponentgetContents(finalStringid){//showaconfirmationpanelforalltheobjectswehavetoremovefinalGWCgwcFacade=GWC.get();QuotatotalQuota=newQuota();for(StringlayerName:selectedNames){QuotausedQuota=gwcFacade.getUsedQuota(layerName);
if(usedQuota!=null){totalQuota.add(usedQuota);
iftheselectionhasbeenclearedoutit'ssignadeletion//occurred,sorefreshthetableList<TileLayer>selection=table.getSelection();
if(selection.isEmpty()){setEnabled(false);target.add(CachedLayerSelectionRemovalLink.this);target.add(table);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;ImportDataother=(ImportData)obj;
if(charsetEncoding==null){
if(other.charsetEncoding!=null)returnfalse;
else
if(!charsetEncoding.equals(other.charsetEncoding))returnfalse;
if(format==null){
if(other.format!=null)returnfalse;
else
if(!format.equals(other.format))returnfalse;
if(message==null){
if(other.message!=null)returnfalse;
else
if(!message.equals(other.message))returnfalse;returntrue;
if(property.equals(ParametersModel.VALUE)){returnnewAutoCompleteTextFieldPanel(id,(IModel<String>)property.getModel(itemModel),attModel.getItems().stream().map(s->"${"+s.getName()+"}").collect(Collectors.toList()));
if(sql.startsWith("CALL")){StringformattedSP="{"+sql+"}";this.run(formattedSP);continue;
if(node.hasAttribute("expiry")){getFeatureWithLock.setExpiry((BigInteger)node.getAttributeValue("expiry"));
if(node.hasAttribute("resultType")){getFeatureWithLock.setResultType((ResultTypeType)node.getAttributeValue("resultType"));
if(node.hasAttribute("outputFormat")){getFeatureWithLock.setOutputFormat((String)node.getAttributeValue("outputFormat"));
if(node.hasAttribute("maxFeatures")){getFeatureWithLock.setMaxFeatures((BigInteger)node.getAttributeValue("maxFeatures"));
if(node.hasAttribute("traverseXlinkDepth")){getFeatureWithLock.setTraverseXlinkDepth((String)node.getAttributeValue("traverseXlinkDepth"));
if(node.hasAttribute("traverseXlinkExpiry")){getFeatureWithLock.setTraverseXlinkExpiry((BigInteger)node.getAttributeValue("traverseXlinkExpiry"));
if(idx==-1){typeName=qualifiedString;//see
ifwehaveadefaultnamespaceuri=namespaces.getURI("");
else{typeName=qualifiedString.substring(idx+1);prefix=qualifiedString.substring(0,idx);uri=namespaces.getURI(prefix);
if(prefix!=null){qname=newQName(uri,typeName,prefix);
else{qname=newQName(uri,typeName);
if(className==null)thrownewSecurityConfigException(CLASSNAME_REQUIRED,newObject[]{});//TODO:removethecalltoextensions,havetehsecuritymanagerbepassedinreturnprov.createConfigurationValidator(GeoServerExtensions.bean(GeoServerSecurityManager.class));
if(isNotEmpty(encrypterName)==false){throwcreateSecurityException(PASSWORD_ENCODER_REQUIRED);
if(encoder==null){throwcreateSecurityException(INVALID_PASSWORD_ENCODER_$1,encrypterName);
if(!encoder.isReversible()){throwcreateSecurityException(INVALID_PASSWORD_ENCODER_$1,encrypterName);
if(!manager.isStrongEncryptionAvailable()){
if(encoder!=null&&encoder.isAvailableWithoutStrongCryptogaphy()==false){throwcreateSecurityException(INVALID_STRONG_CONFIG_PASSWORD_ENCODER);
if(roleServiceName==null)roleServiceName="";try{
if(manager.listRoleServices().contains(roleServiceName)==false)throwcreateSecurityException(ROLE_SERVICE_NOT_FOUND_$1,roleServiceName);
if(authProviders.contains(authProvName)==false)throwcreateSecurityException(AUTH_PROVIDER_NOT_FOUND_$1,authProvName);
if(chain==null){throwcreateSecurityException(SecurityConfigException.FILTER_CHAIN_NULL_ERROR);
if(chain.getRequestChainByName(oldRequestChain.getName())==null){
if(oldRequestChain.canBeRemoved()==false){throwcreateSecurityException(SecurityConfigException.FILTER_CHAIN_NOT_REMOVEABLE_$1,oldRequestChain.getName());
if(isNotEmpty(requestChain.getName())==false){throwcreateSecurityException(SecurityConfigException.FILTER_CHAIN_NAME_MANDATORY);
if(chainNames.contains(requestChain.getName())){throwcreateSecurityException(SecurityConfigException.FILTER_CHAIN_NAME_NOT_UNIQUE_$1,requestChain.getName());
if(isNotEmpty(requestChain.getName())==false){throwcreateSecurityException(SecurityConfigException.FILTER_CHAIN_NAME_MANDATORY);
if(requestChain.getPatterns().isEmpty()){throwcreateSecurityException(SecurityConfigException.PATTERN_LIST_EMPTY_$1,requestChain.getName());
if(StringUtils.hasLength(roleFilterName)){try{
if(proxy.lookupFilter(roleFilterName)==null){throwcreateSecurityException(SecurityConfigException.UNKNOWN_ROLE_FILTER_$2,requestChain.getName(),roleFilterName);
if(requestChaininstanceofVariableFilterChain){
if(requestChain.isDisabled()==false&&requestChain.getFilterNames().isEmpty())throwcreateSecurityException(SecurityConfigException.FILTER_CHAIN_EMPTY_$1,requestChain.getName());StringinterceptorFilterName=((VariableFilterChain)requestChain).getInterceptorName();
if(StringUtils.hasLength(interceptorFilterName)){try{
if(proxy.lookupFilter(interceptorFilterName)==null){throwcreateSecurityException(SecurityConfigException.UNKNOWN_INTERCEPTOR_FILTER_$2,requestChain.getName(),interceptorFilterName);
else{throwcreateSecurityException(SecurityConfigException.INTERCEPTOR_FILTER_MANDATORY_$1,requestChain.getName());
if(StringUtils.hasLength(exceptionTranslationName)){try{
if(proxy.lookupFilter(exceptionTranslationName)==null){throwcreateSecurityException(SecurityConfigException.UNKNOWN_EXCEPTION_FILTER_$2,requestChain.getName(),exceptionTranslationName);
else{throwcreateSecurityException(SecurityConfigException.EXCEPTION_FILTER_MANDATORY_$1,requestChain.getName());
if(index!=-1&&index!=requestChain.getFilterNames().size()-1)throwcreateSecurityException(SecurityConfigException.ANONYMOUS_NOT_LAST_$1,requestChain.getName());for(StringfilterName:requestChain.getFilterNames()){GeoServerSecurityFilterfilter=null;try{filter=(GeoServerSecurityFilter)proxy.lookupFilter(filterName);
if(filter==null)throwcreateSecurityException(SecurityConfigException.UNKNOWN_FILTER_$2,requestChain.getName(),filterName);
if(filterinstanceofGeoServerAuthenticationFilter==false)throwcreateSecurityException(SecurityConfigException.NOT_AN_AUTHENTICATION_FILTER_$2,requestChain.getName(),filterName);GeoServerAuthenticationFilterauthFilter=(GeoServerAuthenticationFilter)filter;
if(requestChaininstanceofHtmlLoginFilterChain&&authFilter.applicableForHtml()==false){throwcreateSecurityException(SecurityConfigException.NOT_A_HTML_AUTHENTICATION_FILTER_$2,requestChain.getName(),filterName);
if(requestChaininstanceofServiceLoginFilterChain&&authFilter.applicableForServices()==false){throwcreateSecurityException(SecurityConfigException.NOT_A_SERVICE_AUTHENTICATION_FILTER_$2,requestChain.getName(),filterName);
if(isNotEmpty(className)==false){throwcreateSecurityException(CLASSNAME_REQUIRED);
if(extensionPoint.isAssignableFrom(aClass)==false){throwcreateSecurityException(CLASS_WRONG_TYPE_$2,extensionPoint,className);
if(name==null||name.isEmpty())throwcreateSecurityException(NAME_REQUIRED);
if(extensionPoint==GeoServerUserGroupService.class)returnmanager.listUserGroupServices();
if(extensionPoint==GeoServerRoleService.class)returnmanager.listRoleServices();
if(extensionPoint==GeoServerAuthenticationProvider.class)returnmanager.listAuthenticationProviders();
if(extensionPoint==AuthenticationProvider.class)returnmanager.listAuthenticationProviders();
if(extensionPoint==GeoServerSecurityFilter.class)returnmanager.listFilters();
if(extensionPoint==PasswordValidator.class)returnmanager.listPasswordValidators();
if(extensionPoint==MasterPasswordProvider.class){returnmanager.listMasterPasswordProviders();
if(names.contains(config.getName()))throwcreateSecurityException(alreadyExistsErrorCode(extensionPoint),config.getName());
if(names.contains(config.getName())==false)throwcreateSecurityException(notFoundErrorCode(extensionPoint),config.getName());
if(isNotEmpty(userGroupService)){
if(authConfig.getUserGroupServiceName().equals(config.getName()))throwcreateSecurityException(USERGROUP_SERVICE_ACTIVE_$2,config.getName(),authConfig.getName());
if(manager.getActiveRoleService().getName().equals(config.getName())){throwcreateSecurityException(ROLE_SERVICE_ACTIVE_$1,config.getName());
if(PasswordValidator.MASTERPASSWORD_NAME.equals(config.getName()))throwcreateSecurityException(PASSWD_POLICY_MASTER_DELETE);try{for(Stringname:manager.listUserGroupServices()){SecurityUserGroupServiceConfigugConfig=manager.loadUserGroupServiceConfig(name);
if(ugConfig.getPasswordPolicyName().equals(config.getName()))throwcreateSecurityException(PASSWD_POLICY_ACTIVE_$2,config.getName(),ugConfig.getName());
if(prov.getName().equals(config.getName()))throwcreateSecurityException(AUTH_PROVIDER_ACTIVE_$1,config.getName());
if(patterns.isEmpty()==false){throwcreateSecurityException(SecurityConfigException.FILTER_STILL_USED,config.getName(),StringUtils.arrayToCommaDelimitedString(patterns.toArray()));
if(isNotEmpty(config.getUserGroupServiceName())){
if(getNamesFor(GeoServerUserGroupService.class).contains(config.getUserGroupServiceName())==false)throwcreateSecurityException(USERGROUP_SERVICE_NOT_FOUND_$1,config.getUserGroupServiceName());
if(systemRole.getAuthority().equals(config.getAdminRoleName()))throwcreateSecurityException(RESERVED_ROLE_NAME,systemRole.getAuthority());
if(systemRole.getAuthority().equals(config.getGroupAdminRoleName()))throwcreateSecurityException(RESERVED_ROLE_NAME,systemRole.getAuthority());
if(isNotEmpty(encoderName)){try{encoder=manager.loadPasswordEncoder(encoderName);
if(encoder==null){throwcreateSecurityException(INVALID_CONFIG_PASSWORD_ENCODER_$1,encoderName);
else{throwcreateSecurityException(PASSWD_ENCODER_REQUIRED_$1,config.getName());
if(!manager.isStrongEncryptionAvailable()){
if(encoder!=null&&encoder.isAvailableWithoutStrongCryptogaphy()==false){throwcreateSecurityException(INVALID_STRONG_PASSWORD_ENCODER);
if(isNotEmpty(policyName)==false){throwcreateSecurityException(PASSWD_POLICY_REQUIRED_$1,config.getName());
if(getNamesFor(PasswordValidator.class).contains(policyName)==false){throwcreateSecurityException(PASSWD_POLICY_NOT_FOUND_$1,policyName);
if(config.getMinLength()<0)throwcreateSecurityException(INVALID_MIN_LENGTH);
if(config.getMaxLength()!=-1){
if(config.getMinLength()>config.getMaxLength())throwcreateSecurityException(INVALID_MAX_LENGTH);
if(GeoServerAuthenticationProvider.class==extPoint)returnAUTH_PROVIDER_ALREADY_EXISTS_$1;
if(PasswordValidator.class==extPoint)returnPASSWD_POLICY_ALREADY_EXISTS_$1;
if(GeoServerRoleService.class==extPoint)returnROLE_SERVICE_ALREADY_EXISTS_$1;
if(GeoServerUserGroupService.class==extPoint)returnUSERGROUP_SERVICE_ALREADY_EXISTS_$1;
if(GeoServerSecurityFilter.class==extPoint)returnAUTH_FILTER_ALREADY_EXISTS_$1;thrownewRuntimeException("Unknownextensionpoint:"+extPoint.getName());
if(GeoServerAuthenticationProvider.class==extPoint)returnAUTH_PROVIDER_NOT_FOUND_$1;
if(PasswordValidator.class==extPoint)returnPASSWD_POLICY_NOT_FOUND_$1;
if(GeoServerRoleService.class==extPoint)returnROLE_SERVICE_NOT_FOUND_$1;
if(GeoServerUserGroupService.class==extPoint)returnUSERGROUP_SERVICE_NOT_FOUND_$1;
if(GeoServerSecurityFilter.class==extPoint)returnAUTH_FILTER_NOT_FOUND_$1;thrownewRuntimeException("Unknownextensionpoint:"+extPoint.getName());
if(otherSymbolizers||otherRenderingTransformations)returnCollections.emptyList();
elsereturnsymbolizers;
if(slinstanceofUserLayer){((UserLayer)sl).accept(this);
else
if(slinstanceofNamedLayer){((NamedLayer)sl).accept(this);
if(rule.getMinScaleDenominator()<scaleDenominator&&rule.getMaxScaleDenominator()>scaleDenominator){for(Symbolizers:rule.symbolizers())s.accept(this);
ifaftsisactive
if(featureType==null||(featureType.getName().getLocalPart()!=null)&&(featureType.getName().getLocalPart().equalsIgnoreCase(fts.getFeatureTypeName())||FeatureTypes.isDecendedFrom(featureType,null,fts.getFeatureTypeName()))){Expressiontx=fts.getTransformation();
if(tx!=null){booleanrasterTransformation=false;
if(txinstanceofFunction){Functionf=(Function)tx;FunctionNamename=f.getFunctionName();
if(name!=null){Parameter<?>result=name.getReturn();
if(result!=null){
if(GridCoverage2D.class.isAssignableFrom(result.getType())){rasterTransformation=true;this.rasterTransformation=tx;
if(syminstanceofRasterSymbolizer){visit((RasterSymbolizer)sym);
else{otherSymbolizers=true;
if("hello.xml".equals(location)){helloServiceSaved=true;
if(opts==null){opts=KmlCentroidOptions.DEFAULT;
if(opts.isClip()){
if(bbox!=null){g=clipGeometry(g,bbox);
else{LOG.warning("Clipoptionspecifiedforkmlcentroids,butnobboxavailable");
if(ginstanceofGeometryCollection){g=selectRepresentativeGeometry((GeometryCollection)g);
if(g==null){returnnull;
else
if(ginstanceofPoint){//simplecasereturng.getCoordinate();
else
if(ginstanceofLineString){//makesurethepointwereturnisactuallyonthelineLineStringline=(LineString)g;LengthIndexedLinelil=newLengthIndexedLine(line);returnlil.extractPoint(line.getLength()/2.0);
else
if(ginstanceofPolygon){
if(opts.isContain()){try{Pointp=RendererUtilities.sampleForInternalPoint((Polygon)g,null,null,null,-1,opts.getSamples());
if(p!=null&&!p.isEmpty()){returnp.getCoordinate();
if(gc.isEmpty()){returnnull;
if(gc.getNumGeometries()==1||ginstanceofMultiPoint){returnfirst;
else{//getthegeometrywiththelargestbboxdoublemaxAreaSoFar=first.getEnvelope().getArea();GeometrygeometryToReturn=first;for(intt=0;t<gc.getNumGeometries();t++){Geometrycurr=gc.getGeometryN(t);doublearea=curr.getEnvelope().getArea();
if(area>maxAreaSoFar){maxAreaSoFar=area;geometryToReturn=curr;
if(groups==null)returnemptyGroups;returnCollections.unmodifiableSortedSet(groups);
if(users==null)returnemptyUsers;returnCollections.unmodifiableSortedSet(users);
if(StringUtils.hasLength(propname)==false)returnemptyUsers;SortedSet<GeoServerUser>users=propertyMap.get(propname);
if(users==null)returnemptyUsers;returnCollections.unmodifiableSortedSet(users);
if(StringUtils.hasLength(propname)==false)return0;SortedSet<GeoServerUser>users=propertyMap.get(propname);
if(users==null)return0;
elsereturnusers.size();
if(StringUtils.hasLength(propname)==false)returnemptyUsers;SortedSet<GeoServerUser>users=getUsersHavingProperty(propname);SortedSet<GeoServerUser>result=newTreeSet<GeoServerUser>();result.addAll(userMap.values());result.removeAll(users);returnCollections.unmodifiableSortedSet(result);
if(StringUtils.hasLength(propname)==false)returnuserMap.size();returnuserMap.size()-getUserCountHavingProperty(propname);
if(StringUtils.hasLength(propname)==false)returnemptyUsers;
if(StringUtils.hasLength(propvalue)==false)returnemptyUsers;SortedSet<GeoServerUser>result=newTreeSet<GeoServerUser>();for(GeoServerUseruser:getUsersHavingProperty(propname)){
if(propvalue.equals(user.getProperties().getProperty(propname)))result.add(user);
if(StringUtils.hasLength(propname)==false)returncount;
if(StringUtils.hasLength(propvalue)==false)returncount;for(GeoServerUseruser:getUsersHavingProperty(propname)){
if(propvalue.equals(user.getProperties().getProperty(propname)))count++;
if(property==ATTR_MAPTYPE){Fragmentf=newFragment(id,"parameterMappingType",CascadedWFSStoredQueryAbstractPage.this);ArrayList<ParameterMappingType>choices=newArrayList<ParameterMappingType>();for(ParameterMappingTypepmt:ParameterMappingType.values()){choices.add(pmt);
else
if(property==ATTR_VALUE){Fragmentf=newFragment(id,"parameterMappingValue",CascadedWFSStoredQueryAbstractPage.this);TextField<String>textField=newTextField<>("text",newPropertyModel<>(itemModel,"value"));f.add(textField);returnf;
switch(i.getMappingType()){caseBLOCKED:mapping=newParameterMappingBlockValue(name);break;caseDEFAULT:mapping=newParameterMappingDefaultValue(name,false,i.getValue());break;caseSTATIC:mapping=newParameterMappingDefaultValue(name,true,i.getValue());break;caseEXPRESSION_CQL:mapping=newParameterMappingExpressionValue(name,"CQL",i.getValue());break;caseNONE:default:mapping=null;
if(mapping!=null){ret.getStoredQueryParameterMappings().add(mapping);
if(dainstanceofWrapper){try{da=((Wrapper)da).unwrap(DataAccess.class);
if(title==null){title=t;
else
if(title.getValue()==null||title.getValue().length()==0){title=t;
if(title!=null){ret.append(title.getValue()).append("(").append(object.getId()).append(")");
else{ret.append(object.getId());
if(a==null&&b==null){returntrue;
if(a==null&&b!=null){returnfalse;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;StoredQueryParameterAttributeother=(StoredQueryParameterAttribute)obj;
if(!nullSafeCompare(this.parameterName,other.parameterName)){returnfalse;
if(!nullSafeCompare(this.title,other.title)){returnfalse;
if(!nullSafeCompare(this.type,other.type)){returnfalse;
if(!nullSafeCompare(this.mappingType,other.mappingType)){returnfalse;
if(!nullSafeCompare(this.value,other.value)){returnfalse;
if(t.getValue()!=null&&t.getValue().length()>0){title.append(t.getValue());break;
if(storedQueryId!=null){StoredQueryDescriptionTypedesc;try{WFSDataStorecontentStore=getContentDataStore();desc=contentStore.getStoredQueryDescriptionType(storedQueryId);
if(geoServer.getSettings().getContact()==null){thrownewResourceNotFoundException("Nocontactinformationavailable");
if(iteminstanceofHttpServletResponse){HttpStatusvalue=HttpStatus.valueOf(((HttpServletResponse)item).getStatus());returnvalue==expectedStatus;
else{returnfalse;
if(iteminstanceofHttpServletResponse){HttpStatusvalue=HttpStatus.valueOf(((HttpServletResponse)item).getStatus());description.appendText("statuswas").appendValue(value.value()).appendText("").appendValue(value.getReasonPhrase());
else{description.appendText("wasnotanHttpServletResponse");
if(iteminstanceofHttpServletResponse){Stringvalue=((HttpServletResponse)item).getHeader(name);return!Objects.isNull(value)&&valueMatcher.matches(value);
else{returnfalse;
if(iteminstanceofHttpServletResponse){Stringvalue=((HttpServletResponse)item).getHeader(name);
if(Objects.isNull(value)){description.appendText("didnothaveheader").appendValue("name");
else{description.appendText("header").appendValue(name).appendText("");valueMatcher.describeMismatch(value,description);
else{description.appendText("wasnotanHttpServletResponse");
if{@link#isJndi()}isfalse.*/publicStringgetDriverClassName(){returndriverClassName;
if{@link#isJndi()}isfalse.*/publicStringgetConnectURL(){returnconnectURL;
iftheuserforgottoaddthefinalnewlinelet'sjustaddit
if(!arcgrid.endsWith("\n")){arcgrid+="\n";
ifpossible
if(RemoteOWSTestSupport.isRemoteWMSStatesAvailable(LOGGER)){//setupthewmsstore,resourceandlayerCatalogBuildercb=newCatalogBuilder(getCatalog());WMSStoreInfowms=cb.buildWMSStore("demo");wms.setCapabilitiesURL(RemoteOWSTestSupport.WMS_SERVER_URL+"service=WMS&request=GetCapabilities");getCatalog().save(wms);cb.setStore(wms);WMSLayerInfostates=cb.buildWMSLayer("topp:states");states.setName("rstates");getCatalog().add(states);LayerInfolayer=cb.buildLayer(states);getCatalog().add(layer);
ifthecharacterencodingistheoneexpectedassertTrue("UTF-8".equals(response.getCharacterEncoding()));
ifitwasn'tthatwesaythemax//bufferat50//intheWMSconfigurationdom=getAsDOM(base+"&x=85&y=230&buffer=300");XMLAssert.assertXpathEvaluatesTo("1","count(/html/body/table/tr/td[starts-with(.,'BasicPolygons.')])",dom);XMLAssert.assertXpathEvaluatesTo("1","count(/html/body/table/tr/td[.='BasicPolygons.1107531493630'])",dom);
ifmorethanonelayeris//selectedassertTrue(result.indexOf("<styletype=\"text/css\">")>0);
iftheformatisnotknown,insteadofreturningthe*textformatasinhttps://osgeo-org.atlassian.net/browse/GEOS-1924*/@TestpublicvoidtestUknownFormat()throwsException{Stringlayer=MockData.FORESTS.getPrefix()+":"+MockData.FORESTS.getLocalPart();Stringrequest="wms?version=1.1.1&bbox=-0.002,-0.002,0.002,0.002&styles=&format=jpeg&info_format=unknown/format&request=GetFeatureInfo&layers="+layer+"&query_layers="+layer+"&width=20&height=20&x=10&y=10";Documentdoc=dom(get(request),true);//print(doc);XMLAssert.assertXpathEvaluatesTo("1","count(//ServiceExceptionReport/ServiceException)",doc);XMLAssert.assertXpathEvaluatesTo("InvalidFormat","/ServiceExceptionReport/ServiceException/@code",doc);XMLAssert.assertXpathEvaluatesTo("info_format","/ServiceExceptionReport/ServiceException/@locator",doc);
iftheworkspaceDocumentdom=getAsDOM("cdf/"+url);assertEquals("ServiceExceptionReport",dom.getDocumentElement().getNodeName());
if(!RemoteOWSTestSupport.isRemoteWMSStatesAvailable(LOGGER)){LOGGER.log(Level.WARNING,"SkippingtestPropertySelectionWmsCascade");return;
ifit'snonnull,theempty*stringotherwise*<li>name(String)*<li>type(String)*<li>isGeometry(Boolean)*</ul>*</ul>*</ul>**Exampleofatemplateprocessingafeaturecollectionwhichwillprintoutthefeaturesidof*everyfeatureinthecollection.**<pre><code>*&lt;#listfeaturesasfeature&gt;*FeatureId:${feature.fid}*&lt;/#list&gt;*</code></pre>**<p>Tousethiswrapper,usethe{@link*Configuration#setObjectWrapper(freemarker.template.ObjectWrapper)}method:**<pre>*<code>*//featureswewanttoapplytemplateto*FeatureCollectionfeatures=...;*//createtheconfigurationandsetthewrapper*Configurationcfg=newConfiguration();*cfg.setObjectWrapper(newFeatureWrapper());*//getthetemplateandgo*Templatetemplate=cfg.getTemplate(&quot;foo.ftl&quot;);*template.process(features,System.out);*</code>*</pre>**@authorJustinDeoliveira,TheOpenPlanningProject,jdeolive@openplans.org*@authorAndreaAime,TOPP*@authorGabrielRoldan,TOPP*/publicclassFeatureWrapperextendsBeansWrapper{staticCataloggsCatalog;/**factorytocreateCollectionTemplateModelfromFeatureCollection*/protectedTemplateFeatureCollectionFactorytemplateFeatureCollectionFactory;publicFeatureWrapper(){setSimpleMapWrapper(true);this.templateFeatureCollectionFactory=copyTemplateFeatureCollectionFactory;
if(gsCatalog!=null)returngsCatalog;try{return(gsCatalog=(Catalog)GeoServerExtensions.bean("catalog2"));
if(o==null){//nullsthrowtempaltesoff,useemptystringreturn"";
if(oinstanceofDate){
if(oinstanceofTimestamp){returnDateFormat.getDateTimeInstance().format((Date)o);
if(oinstanceofTime){returnDateFormat.getTimeInstance().format((Date)o);
if(oinstanceofBoolean){return((Boolean)o).booleanValue()?"true":"false";
if(oinstanceofGeometry){returnString.valueOf(o);
if(cat==null){return"";
if(name.getNamespaceURI()==null){return"";
if(objectinstanceofFeatureCollection){//createamodelwithjustonevariablecalled'features'SimpleHashmap=newSimpleHash();map.put("features",templateFeatureCollectionFactory.createTemplateFeatureCollection((FeatureCollection)object,this));map.put("type",wrap(((FeatureCollection)object).getSchema()));returnmap;
else
if(objectinstanceofComplexType){returnbuildType((ComplexType)object);
else
if(objectinstanceofFeature){returnbuildComplex((Feature)object);
if(cat!=null){info=cat.getResourceByName(att.getType().getName().getNamespaceURI(),att.getType().getName().getLocalPart(),FeatureTypeInfo.class);
if(info!=null){map.put("type",info);
if(info==null){map.put("type",buildDummyFeatureTypeInfo(att));
if(att.getIdentifier()!=null){map.put("fid",att.getIdentifier().getID());
else{map.put("fid","");
if(finstanceofFeature){finalGeometryDescriptorgd=((Feature)f).getType().getGeometryDescriptor();
if(gd!=null){dummy.put("nativeCRS",gd.getCoordinateReferenceSystem());
if(entrySet==null){entrySet=newLinkedHashSet<MapEntry>();finalCollection<PropertyDescriptor>types=feature.getType().getDescriptors();NameattName;MapattributesMap;for(Iterator<PropertyDescriptor>iterator=types.iterator();iterator.hasNext();){attName=iterator.next().getName();attributesMap=newAttributeMap(attName,feature);entrySet.add(newMapEntry<Object,Object>(attName.getLocalPart(),attributesMap));
if(entrySet==null){entrySet=newLinkedHashSet<MapEntry>();finalComplexTypefeatureType=feature.getType();PropertyDescriptorattributeDescr=featureType.getDescriptor(attributeName);Propertyproperty=feature.getProperty(attributeName);
if(property==null){//maybepolymorphism?let'stry@SuppressWarnings("unchecked")List<AttributeDescriptor>substitutionGroup=(List<AttributeDescriptor>)attributeDescr.getUserData().get("substitutionGroup");
if(substitutionGroup!=null){Iterator<AttributeDescriptor>it=substitutionGroup.iterator();while(property==null&&it.hasNext()){property=feature.getProperty(it.next().getName());
if(property!=null){attributeDescr=property.getDescriptor();
if(propertyinstanceofComplexAttribute){value=buildComplex((ComplexAttribute)property);
else
if(property!=null){value=property.getValue();
if(attributeDescr.getType()instanceofComplexType){entrySet.add(newMapEntry<Object,Object>("type",buildType((ComplexType)attributeDescr.getType())));
else{entrySet.add(newMapEntry<Object,Object>("type",attributeDescr.getType().getBinding().getName()));
if(signalArgs!=null&&signalArgs.get("topic")!=null)returnsignalArgs.get("topic").equals("progress");returnfalse;
if(!isEmpty(ldapConfig.getAdminGroup())){this.adminGroup=ldapConfig.getAdminGroup();
if(!isEmpty(ldapConfig.getGroupAdminGroup())){this.groupAdminGroup=ldapConfig.getGroupAdminGroup();
if(role!=null){set.add(role);
if(roleStr.startsWith("ROLE_")){//removestandardroleprefixroleStr=roleStr.substring(5);
if(roleObj!=null){Object[]usernames=roleObj.getObjectAttributes(groupMembershipAttribute);
if(usernames!=null){for(Objectusername:usernames){Stringuser=username.toString();Matcherm=userMembershipPattern.matcher(user);
if(m.matches()){user=m.group(1);
if(role.startsWith("ROLE_")){//removestandardroleprefixrole=role.substring(5);
if(roles.size()==1){returncreateRoleObject(role);
if(adminGroup==null){returnnull;
if(groupAdminGroup==null){returnnull;
ifitdoesn'texist,populated*witholddefaultsglobalconfigurationforgwclayersbasedongeoserverlayersandlayer*groups.*<li>Configuresagwc{@linkGeoServerTileLayerInfoImpltilelayer}forevery{@linkLayerInfo}*and{@linkLayerGroupInfo}matchingtheolddefaults,alsoonly
if{@codegwc-gs.xml}*didn'talreadyexist.*<li>UpgradesthedirectWMSintegrationconfigurationfromanoldconfig.Beforeusing{@code*gwc-gs.xml}toholdtheintegratedGWCconfiguration,theonlypropertyconfiguredwas*whetherthedirectWMSintegrationoptionwasenabled,anditwassavedaspartofthe*{@linkWMSInfo}metadatamapunderthe{@codeGWC_WMS_Integration}key.Thismethodremoves*thatkeyfromWMSInfo
ifpresentandsetsitsvaluetothe{@codeGWCConfig}instead.*</ul>**@authorgroldan*@seeGeoServerInitializer*/publicclassGWCInitializerimplementsGeoServerInitializer{privatestaticfinalLoggerLOGGER=Logging.getLogger(GWCInitializer.class);/***{@linkWMSInfo#getMetadata()WMSInfometadata}keyusedin<2.1.2toholdthegwcdirectwms*integrationenablementflag*/staticStringWMS_INTEGRATION_ENABLED_KEY="GWC_WMS_Integration";privatefinalGWCConfigPersisterconfigPersister;privatefinalCatalograwCatalog;privatefinalTileLayerCatalogtileLayerCatalog;privateConfigurableBlobStoreblobStore;publicGWCInitializer(GWCConfigPersisterconfigPersister,CatalograwCatalog,TileLayerCatalogtileLayerCatalog){this.configPersister=configPersister;this.rawCatalog=rawCatalog;this.tileLayerCatalog=tileLayerCatalog;
if(configFile==null||configFile.getType()!=Type.RESOURCE){LOGGER.fine("GWC'sGeoServerspecificconfigurationnotfound,creatingwitholddefaults");GWCConfigoldDefaults=GWCConfig.getOldDefaults();oldDefaults.setVersion(currentVersion.toString());upgradeWMSIntegrationConfig(geoServer,oldDefaults);createDefaultTileLayerInfos(oldDefaults);configPersister.save(oldDefaults);
if(version.compareTo(newVersion("2.0.0"))<0&&config.isWMTSEnabled()!=null){//settingWMTSenablinginformationbasedonoldGWCconfigurationsettingWMTSInfoglobalServiceInfo=geoServer.getFacade().getService(WMTSInfo.class);globalServiceInfo.setEnabled(config.isWMTSEnabled());geoServer.save(globalServiceInfo);//overridingconfigurationconfig.setWMTSEnabled(null);configPersister.save(config);
if(currentVersion.compareTo(version)>0){//gottheglobalconfigfile,soolddefaultsarealreadyinplace
ifneedbe.Now//checkwhetherweneedtomigratetheconfigurationfromtheLayer/GroupInfometadata//mapstothetilelayercatalogstoremoveTileLayerInfosToTileLayerCatalog();config.setVersion(currentVersion.toString());configPersister.save(config);
ifnotpresent
if(gwcConfig.getCacheProviderClass()==null||gwcConfig.getCacheProviderClass().isEmpty()){gwcConfig.setCacheProviderClass(GuavaCacheProvider.class.toString());configPersister.save(gwcConfig);
if(gwcConfig.getCacheConfigurations()==null){
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("SettingdefaultCacheConfiguration");
else{
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("CacheConfigurationloaded");
if(blobStore!=null){StringcacheProviderClass=gwcConfig.getCacheProviderClass();
if(!blobStore.getCacheProviders().containsKey(cacheProviderClass)){gwcConfig.setCacheProviderClass(GuavaCacheProvider.class.toString());configPersister.save(gwcConfig);
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("Unabletofind:"+cacheProviderClass+",useddefaultconfiguration");
if(!CatalogConfiguration.isLayerExposable(layer)){continue;
if(tileLayerInfo!=null){tileLayerCatalog.save(tileLayerInfo);MetadataMapmetadata=layer.getMetadata();LegacyTileLayerInfoLoader.clear(metadata);rawCatalog.save(layer);
if(tileLayerInfo!=null){tileLayerCatalog.save(tileLayerInfo);MetadataMapmetadata=layer.getMetadata();LegacyTileLayerInfoLoader.clear(metadata);rawCatalog.save(layer);
if(!CatalogConfiguration.isLayerExposable(layer)){continue;
if(metadata.containsKey(LegacyTileLayerInfoLoader.CONFIG_KEY_ENABLED)){LegacyTileLayerInfoLoader.clear(metadata);rawCatalog.save(layer);
if(metadata.containsKey(LegacyTileLayerInfoLoader.CONFIG_KEY_ENABLED)){LegacyTileLayerInfoLoader.clear(metadata);rawCatalog.save(layer);
ifpresentandsetsitsvaluetothe{@codegwcConfig}*instead.*/privatevoidupgradeWMSIntegrationConfig(finalGeoServergeoServer,finalGWCConfiggwcConfig)throwsIOException{//Checkwhetherwe'reusingtheoldwayofstoringthisinformation,andgetridofitWMSInfoservice=geoServer.getService(WMSInfo.class);
if(service!=null){MetadataMapmetadata=service.getMetadata();
if(service!=null&&metadata!=null){BooleanstoredValue=metadata.get(WMS_INTEGRATION_ENABLED_KEY,Boolean.class);
if(storedValue!=null){booleanenabled=storedValue.booleanValue();gwcConfig.setDirectWMSIntegrationEnabled(enabled);metadata.remove(WMS_INTEGRATION_ENABLED_KEY);geoServer.save(service);
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("AddingLayerstoavoidInMemoryCaching");
iftheLayermustnotbecachedGeoServerTileLayerInfotileLayerInfo=tileLayerCatalog.getLayerById(layer.getId());
if(tileLayerInfo!=null&&tileLayerInfo.isEnabled()&&!tileLayerInfo.isInMemoryCached()){//Addittothecachesynchronized(cache){cache.addUncachedLayer(tileLayerInfo.getName());
if(jdominstanceofDocumentFile)returntrue;
elsereturnfalse;
if(elements!=null&&!element.isEmpty()){//briefandsummaryhaveaspecificorderfor(Namename:elements){Collection<Property>properties=f.getProperties(name);
if(properties!=null&&!properties.isEmpty()){for(Propertyp:properties){encodeProperty(f,p);
else
if(DC_TITLE.getName().equals(name)){//dc:titleismandatoryeven
ifwedon'thaveavalueforitelement("dc:title",null);
else{//csw:Recordhasfreeformorderfor(Propertyp:f.getProperties()){
if(elements==null||elements.contains(p.getName())){encodeProperty(f,p);
ifpresent
if(elements==null||elements.contains(CSWRecordDescriptor.RECORD_BBOX_NAME)){Propertybboxes=f.getProperty(CSWRecordDescriptor.RECORD_BBOX_NAME);
if(bboxes!=null){//grabtheoriginalboundingboxesfromtheuserdata(thegeometryisan//aggregate)List<ReferencedEnvelope>originalBoxes=(List<ReferencedEnvelope>)bboxes.getUserData().get(GenericRecordBuilder.ORIGINAL_BBOXES);for(ReferencedEnvelopere:originalBoxes){try{ReferencedEnvelopewgs84re=re.transform(CRS.decode(CSWRecordDescriptor.DEFAULT_CRS_NAME),true);Stringminx=String.valueOf(wgs84re.getMinX());Stringminy=String.valueOf(wgs84re.getMinY());Stringmaxx=String.valueOf(wgs84re.getMaxX());Stringmaxy=String.valueOf(wgs84re.getMaxY());AttributesImplattributes=newAttributesImpl();addAttribute(attributes,"crs",CSWRecordDescriptor.DEFAULT_CRS_NAME);start("ows:BoundingBox",attributes);element("ows:LowerCorner",minx+""+miny);element("ows:UpperCorner",maxx+""+maxy);end("ows:BoundingBox");
if(p.getType()==CSWRecordDescriptor.SIMPLE_LITERAL){encodeSimpleLiteral(p);
else
if(CSWRecordDescriptor.RECORD_BBOX_NAME.equals(p.getName())){//skipitforthemoment,itisconstrainedtobelast
else{thrownewIllegalArgumentException("Don'tknowhowtoencodeproperty"+p+"inrecord"+f);
if(scheme==null){element(prefix+":"+name,value);
else{AttributesImplattributes=newAttributesImpl();addAttribute(attributes,"scheme",scheme);element(prefix+":"+name,value,attributes);
switch(response.getElementSet()){caseBRIEF:return"BriefRecord";caseSUMMARY:return"SummaryRecord";default:return"Record";
switch(response.getElementSet()){caseBRIEF:returnCSWRecordDescriptor.BRIEF_ELEMENTS;caseSUMMARY:returnCSWRecordDescriptor.SUMMARY_ELEMENTS;default:returnnull;
if("wfs".equals(rule.getService())&&"GetFeatureWithLock".equals(rule.getMethod())){foundRule=rule;break;
if(s.equals(searchValue))returnindex;index++;
if(debugMode){print(page,true,true);
if(this.getXp()==null){setXp(this.xstream.getXStream());
iftheinputresourcedoesnotexist.**@paramstrictfalsebydefault*/publicvoidsetStrict(booleanstrict){this.strict=strict;
iftheResource,FragmentDeserializeror*FragmentRootElementNameisnull,or
iftherootelementisempty.*@throwsIllegalStateException
iftheResourcedoesnotexist.*/@OverridepublicvoidafterPropertiesSet()throwsException{Assert.notEmpty(fragmentRootElementNames,"TheFragmentRootElementNamesmustnotbeempty");for(QNamefragmentRootElementName:fragmentRootElementNames){Assert.hasText(fragmentRootElementName.getLocalPart(),"TheFragmentRootElementNamesmustnotcontainemptyelements");
ifnextfragmentwasfound,<code>false</code>otherwise.*@throwsNonTransientResourceException
ifthecursorcouldnotbemoved.Thiswillbetreated*asfatalandsubsequentcallstoreadwillreturnnull.*/protectedbooleanmoveCursorToNextFragment(XMLEventReaderreader){try{while(true){while(reader.peek()!=null&&!reader.peek().isStartElement()){reader.nextEvent();
if(reader.peek()==null){returnfalse;
if(isFragmentRootElementName(startElementName)){returntrue;
if(fragmentReader!=null){fragmentReader.close();
if(inputStream!=null){inputStream.close();
if(!resource.exists()){
if(strict){thrownewIllegalStateException("Inputresourcemustexist(readerisin'strict'mode)");
if(!resource.isReadable()){
if(strict){thrownewIllegalStateException("Inputresourcemustbereadable(readerisin'strict'mode)");
if(noInput){returnnull;
if(success){fragmentReader.markStartFragment();try{@SuppressWarnings("unchecked")TmappedFragment=(T)unmarshal(StaxUtils.getSource(fragmentReader));item=mappedFragment;try{firePostRead(item,resource);
if(itemIndex==(i+1)){//wecanpresumeaNoSuchElementExceptiononthelastitemmeanstheEOFwas//reachedonthelastrunreturn;
else{//
ifNoSuchElementExceptionoccursonanitemotherthanthelastone,this//indicatesaproblemlogValidationExceptions((T)null,e);
if(nextEvent.isStartElement()&&isFragmentRootElementName(((StartElement)nextEvent).getName())){return((StartElement)nextEvent).getName();
if(nextEvent.isEndElement()&&fragmentRootElementName.equals(((EndElement)nextEvent).getName())){return;
if(fragmentRootElementName.getLocalPart().equals(name.getLocalPart())){
if(!StringUtils.hasText(fragmentRootElementName.getNamespaceURI())||fragmentRootElementName.getNamespaceURI().equals(name.getNamespaceURI())){returntrue;
if(fragmentRootElementName.contains("{")){nameSpace=fragmentRootElementName.replaceAll("\\{(.*)\\}.*","$1");name=fragmentRootElementName.replaceAll("\\{.*\\}(.*)","$1");
iftheaddressthesamedata,
ifyouneedfull*comparison,use{@link#equalsExact(WpsAccessRule)}*/@SuppressWarnings("serial")publicclassWpsAccessRuleimplementsComparable<WpsAccessRule>,Serializable{/**Anylayer,oranyworkspace,oranyrole*/publicstaticfinalStringANY="*";publicstaticWpsAccessRuleEXECUTE_ALL=newWpsAccessRule(ANY,ANY,ANY);privateStringgroupName;privateStringwpsName;privateSet<String>roles;/**Buildsanewrule*/publicWpsAccessRule(StringgroupName,StringwpsName,Set<String>roles){super();this.groupName=groupName;this.wpsName=wpsName;
if(roles==null)this.roles=newHashSet<String>();
elsethis.roles=newHashSet<String>(roles);
if(roles.isEmpty()){returnWpsAccessRule.ANY;
else{StringBuffersb=newStringBuffer();for(Stringrole:roles){sb.append(role);sb.append(",");
ifanything
elseisequal,readcomesbeforewrite*/publicintcompareTo(WpsAccessRuleother){intcompareGroup=compareCatalogItems(groupName,other.groupName);
if(compareGroup!=0)returncompareGroup;intcompareName=compareCatalogItems(wpsName,other.wpsName);returncompareName;
if(!(objinstanceofWpsAccessRule))returnfalse;return0==compareTo((WpsAccessRule)obj);
if(0!=compareTo(obj))returnfalse;
elsereturnroles.equals(obj.roles);
if(item.equals(otherItem))return0;
else
if(ANY.equals(item))return-1;
else
if(ANY.equals(otherItem))return1;
elsereturnitem.compareTo(otherItem);
if(value!=null){attributes.addAttribute("",name,name,"",valueinstanceofString?(String)value:String.valueOf(value));
if(canonicalSchemaLocation){returnCSW_ROOT_LOCATION+schema;
else{returnbuildSchemaURL(request.getBaseUrl(),"csw/2.0.2/"+schema);
if(bean==null){thrownewNoSuchBeanDefinitionException(name);
ifnotfoundornotwritable*/publicFilegetTempDir(){StringtempPath=System.getProperty("java.io.tmpdir");
if(tempPath==null)returnnull;FiletempDir=newFile(tempPath);
if(tempDir.exists()==false)returnnull;
if(tempDir.isDirectory()==false)returnnull;
if(tempDir.canWrite()==false)returnnull;returntempDir;
ifthefilecanbecreated.Forrelativefilenames,{@link#getTempDir()}isused(if*thereisatempdir)**<p>returnstrue
iffilecanbecreatedor
ifthetestisnotpossibleduetoamissingtemp*dir**<p>false
iffilecreationcausesan{@linkIOException}**@paramfile*@throwsSecurityConfigException*/protectedbooleancheckFile(Filefile)throwsSecurityConfigException{FiletestFile=null;try{
if(file.isAbsolute()){testFile=file;
else{FiletempDir=getTempDir();
if(tempDir==null)returntrue;//cannotcheckrelativefilenametestFile=newFile(tempDir,file.getPath());
if(testFile.exists()==false){testFile.createNewFile();testFile.delete();
iffound,or*returningthedefaultpriorityotherwise.Theheadermustcontainaintegervalue(thepriority*itself)*/publicclassHttpHeaderPriorityProviderimplementsPriorityProvider{staticfinalLoggerLOGGER=Logging.getLogger(HttpHeaderPriorityProvider.class);privatefinalStringheaderName;privatefinalintdefaultPriority;publicHttpHeaderPriorityProvider(StringheaderName,intdefaultPriority){this.headerName=headerName;this.defaultPriority=defaultPriority;
if(request!=null&&request.getHttpRequest()!=null&&request.getHttpRequest().getHeader(headerName)!=null){StringpriorityString=request.getHttpRequest().getHeader(headerName);try{intpriority=Integer.parseInt(priorityString);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Foundpriorityheader"+headerName+"inrequestwithvalue"+priority);
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Didnotfindpriorityheader"+headerName+"inrequest,usingdefaultpriorirty");
elseworksStyleInfotarget=((List<StyleInfo>)newStylesModel().getObject()).get(0);FormTesterft=tester.newFormTester("form");ft.select("panel:styles:defaultStyle",0);ft.submit();tester.assertModelValue("form:panel:styles:defaultStyle",target);
if(property==PREVIEW_IMAGE){BufferedDynamicImageResourceimage=previewFont.getPreviewImage();Fragmentf=newFragment(id,"previewImageFragment",JVMFontsPage.this);f.add(newImage("previewImage",image));returnf;
if*noinitializationisneeded).It'sadvisabletoprepareasqlscriptthatfirstdrops*alltablesandviewsandthenrecreatesthem,
ifastatementfailsit'llbeloggedand*skippedanyways.Thismakesitpossibletoinspectthedatabasecontents**@paramdataDirSourceDirectory*@paramfilterMap*@paramsqlScript*/publicLiveDbmsData(FiledataDirSourceDirectory,StringfixtureId,FilesqlScript)throwsIOException{super(dataDirSourceDirectory);this.fixture=lookupFixture(fixtureId);this.fixtureId=fixtureId;this.sqlScript=sqlScript;
if(property!=null&&"false".equals(property.toLowerCase())){returnnull;
if(!base.exists())base.mkdir();FilefixtureFile=newFile(base,fixtureId+".properties");
if(!fixtureFile.exists()){finalStringwarning="Disablingtestbasedonfixture"+fixtureId+"sincethefile"+fixtureFile+"couldnotbefound";disableTest(warning);returnnull;
ifthetestwasdisabledwedon'tneedtorunthesetup
if(fixture==null)return;super.setUp();//loadthepropertiesfromthefixturepathandloadthemintoa//Map<String,String>Propertiesp=newProperties();p.load(newFileInputStream(fixture));Map<String,String>filters=newHashMap(p);//replacethekeyscontainedincatalog.xmlwiththeactualvalues
if(filteredPaths!=null&&filteredPaths.size()>0){for(Stringpath:filteredPaths){Filefrom=newFile(source,path);Fileto=newFile(data,path);IOUtils.filteredCopy(from,to,filters);
if(sqlScript!=null){DataStoreds=null;Connectionconn=null;Statementst=null;BufferedReaderreader=null;try{ds=DataStoreFinder.getDataStore(filters);
if(ds==null){finalStringwarning="Disablingonlinetestbasedon'"+fixtureId+"',"+"couldnotfindadatastorecompatible"+"withthefollowingconnectionproperties:"+filters;disableTest(warning);return;
if(conn==null){finalStringwarning="Disablingonlinetestbasedon'"+fixtureId+"',"+"couldnotextractaJDBCconnectionfromthedatastore'"+ds.getClass()+"obtainedusingthefollowing"+"connectionproperties:"+filters;disableTest(warning);return;
if("".equals(command)||command.startsWith("--")||command.startsWith("#"))continue;//executebutdonotcomplain,onlylogthefailurestry{st.execute(command);
if(ds!=null)ds.dispose();
if(reader!=null)reader.close();
if(dsinstanceofJDBCDataStore){return((JDBCDataStore)ds).getConnection(Transaction.AUTO_COMMIT);
else{returnnull;
if(myStream==null){
if(myReader==null){myStream=newBufferedRequestStream(myBuffer);
else{thrownewIOException("Requestingastreamafterareaderisalreadyinuse!!");
if(myReader==null){
if(myStream==null){myReader=newBufferedReader(newInputStreamReader(newBufferedRequestStream(myBuffer),charset));
else{thrownewIOException("Requestingareaderafterastreamisalreadyinuse!!");
if(allValues!=null&&allValues.size()>0){return(String)allValues.get(0);
elsereturnnull;
if(allValues!=null&&allValues.size()>0){return(String[])allValues.toArray(newString[0]);
elsereturnnull;
if(myParameterMap!=null)return;StringcontentType=myWrappedRequest.getContentType();
if(myWrappedRequest.getMethod().equals("POST")&&contentType!=null&&contentType.startsWith("application/x-www-form-urlencoded")){parseFormBody();
else{myParameterMap=newHashMap(super.getParameterMap());for(Objectkey:myParameterMap.keySet()){Objectvalue=myParameterMap.get(key);
if(valueinstanceofList){//ok,nothingtodo
else
if(valueinstanceofString[]){myParameterMap.put(key,Arrays.asList(((String[])value)));
else{myParameterMap.put(key,Converters.convert(value,List.class));
if(myWrappedRequest.getQueryString()!=null){pairs=myWrappedRequest.getQueryString().split("\\&");for(inti=0;i<pairs.length;i++){parsePair(pairs[i]);
if(!myParameterMap.containsKey(key)){myParameterMap.put(key,newArrayList());
if(catalog==null){try{catalog=mockCreator.createCatalog(this);
if(secMgr==null){try{secMgr=mockCreator.createSecurityManager(this);
if(datastore!=null){datastore.dispose();
if(Arrays.asList(datastore.getTypeNames()).contains(getStatusTable())){datastore.removeSchema(getStatusTable());
if(datastore==null){thrownewRuntimeException("failedtocreatedataStorewith\n"+props);
if(statusStore!=null)statusStore.remove(Filter.INCLUDE);
if(datastore!=null)datastore.dispose();
iftheGetMapfailsforanyreason.**@paramt*/voidfailed(Throwablet);}
if(table!=null){((GSFeatureTypeEncoder)re).setNativeName(SqlUtil.notQualified(table.getTableName()));
ifneeded(wehavemessyinputsstoredthatdonotalwaysstart//with//file://butsometimeswithfile:/andsometimeswithfile:(no/atall)
if(input.startsWith("file:")){
if(input.startsWith("file:/")){
if(input.startsWith("file://")){input=input.substring(7);
else{input=input.substring(6);
else{input=input.substring(5);
if(idx>=0){base=input.substring(0,idx);name=input.substring(idx+1,input.length()).toLowerCase();
else{base=separator;name=input.toLowerCase();
if(dataDirectoryPath){base=Paths.convert(base);
if(dataDirectoryPath&&localBase.startsWith(separator)){localBase=base.substring(1);
if(localBase.endsWith(separator)){returnprefix+localBase+name;
else{returnprefix+localBase+separator+name;
if(!hideFileSystem){roots.addAll(Arrays.asList(File.listRoots()));
if(includeDataDir){roots.add(0,dataDirectory);
ifitwaspossibletodetermineitatall
if(!hideFileSystem&&GeoServerFileChooser.USER_HOME!=null){roots.add(1,GeoServerFileChooser.USER_HOME);
if(pathInRoot.startsWith(root.getPath())){pathInRoot=pathInRoot.substring(root.getPath().length());
if(pathInRoot.startsWith(File.separator)){pathInRoot=pathInRoot.substring(1);
else{continue;
if(names!=null){Stream<String>rootPaths=Arrays.stream(names).filter(fileName->fileFilter==null||fileFilter.accept(newFile(fsSplitter.base,fileName))).map(fileName->fsSplitter.buildPath(fileName));result=Stream.concat(result,rootPaths);
if(!(oinstanceofRemoteInfo)){returnfalse;
if(o==this){returntrue;
if(password!=null){password=Remote.decryptPassword(password);
if(filter.applicableForHtml())result.add(filterName);
if("getid".equalsIgnoreCase(method.getName())){returnid;
if("getname".equalsIgnoreCase(method.getName())){returnname;
if("getNativeName".equalsIgnoreCase(method.getName())){returnnativeName;
if("accept".equals(method.getName())){proxyVisitory(proxy,method,(CatalogVisitor)args[0]);
if(catalogCollaborators.containsKey(method.getName())){returncatalogCollaborators.get(method.getName());
if(List.class.isAssignableFrom(returnType)){returnCollections.EMPTY_LIST;
if(NamespaceInfo.class.equals(infoInterface)){catalogVisitor.visit((NamespaceInfo)proxy);
else
if(WorkspaceInfo.class.equals(infoInterface)){catalogVisitor.visit((WorkspaceInfo)proxy);
else
if(CoverageInfo.class.equals(infoInterface)){catalogVisitor.visit((CoverageInfo)proxy);
else
if(FeatureTypeInfo.class.equals(infoInterface)){catalogVisitor.visit((FeatureTypeInfo)proxy);
else
if(WMSLayerInfo.class.equals(infoInterface)){catalogVisitor.visit((WMSLayerInfo)proxy);
else
if(CoverageStoreInfo.class.equals(infoInterface)){catalogVisitor.visit((CoverageStoreInfo)proxy);
else
if(DataStoreInfo.class.equals(infoInterface)){catalogVisitor.visit((DataStoreInfo)proxy);
else
if(WMSStoreInfo.class.equals(infoInterface)){catalogVisitor.visit((WMSStoreInfo)proxy);
else
if(StyleInfo.class.equals(infoInterface)){catalogVisitor.visit((StyleInfo)proxy);
else
if(LayerInfo.class.equals(infoInterface)){catalogVisitor.visit((LayerInfo)proxy);
else
if(LayerGroupInfo.class.equals(infoInterface)){catalogVisitor.visit((LayerGroupInfo)proxy);
else
if(Catalog.class.equals(infoInterface)){catalogVisitor.visit((Catalog)proxy);
if(autofit!=null&&Converters.convert(autofit,Boolean.class)){doublewidth=mapContent.getMapWidth();doubleheight=mapContent.getMapHeight();ReferencedEnvelopebbox=mapContent.getViewport().getBounds();doublebbox_width=bbox.getWidth();doublebbox_height=bbox.getHeight();//beonthesafeside
if(bbox_width>0&&bbox_height>0&width>0&height>0){doubleratio=bbox_width/bbox_height;
if(bbox_width>bbox_height){height=width/ratio;inth=(int)Math.ceil(height);mapContent.setMapHeight(h);mapContent.getRequest().setHeight(h);
else{width=height*ratio;intw=(int)Math.ceil(width);mapContent.setMapWidth(w);mapContent.getRequest().setWidth(w);
if(!CRS.equalsIgnoreMetadata(viewport.getCoordinateReferenceSystem(),DefaultGeographicCRS.WGS84)){viewport.setCoordinateReferenceSystem(DefaultGeographicCRS.WGS84);GetMapRequestreq=mc.getRequest();req.setSRS("EPSG:4326");req.setBbox(viewport.getBounds());
if(kmplacemark!=null){returnConverters.convert(kmplacemark,Boolean.class);
else{returnwms.getKmlPlacemark();
if(kmattr==null){kmattr=request.getRawKvp().get("kmattr");
if(kmattr!=null){returnConverters.convert(kmattr,Boolean.class);
else{returnwms.getKmlKmAttr();
if(kmScoreObj!=null){kmScore=(Integer)kmScoreObj;
iftheextendeddataisenabledornot**@paramrequest*/booleancomputeExtendedDataEnabled(){MapformatOptions=request.getFormatOptions();BooleanextendedData=Converters.convert(formatOptions.get("extendedData"),Boolean.class);
if(extendedData==null){extendedData=Boolean.FALSE;
ifthesuperoverlayisenabledornot**@paramrequest*/booleancomputeSuperOverlayEnabled(){MapformatOptions=request.getFormatOptions();Booleansuperoverlay=(Boolean)formatOptions.get("superoverlay");
if(superoverlay==null){superoverlay=Boolean.FALSE;
if(overlayMode!=null){returnoverlayMode;
if(overlayMode!=null){returnoverlayMode;
else{returnwms.getKmlSuperoverlayMode();
if(decorator!=null){result.add(decorator);
if(originalFeatures==null||originalFeatures.size()==0){folder.setFeature(features);
else{//inthiscase,composethealreadyexistingfeatureswiththe//dynamicallygeneratedonesfolder.setFeature(newCompositeList<Feature>(originalFeatures,features));
if(originalFeatures==null||originalFeatures.size()==0){document.setFeature(features);
else{//inthiscase,composethealreadyexistingfeatureswiththe//dynamicallygeneratedonesdocument.setFeature(newCompositeList<Feature>(originalFeatures,features));
if(!kmz){thrownewIllegalStateException("Cannotaddground"+"overlaylayers,theoutputisnotsupposedtobeaKMZ");
if(layerinstanceofFeatureLayer){results.add((SimpleFeatureType)layer.getFeatureSource().getSchema());
else{results.add(null);
if(currentLayerinstanceofFeatureLayer){FeatureLayerfl=(FeatureLayer)currentLayer;return(SimpleFeatureType)fl.getFeatureSource().getSchema();
if(envinstanceofReferencedEnvelope){re=(ReferencedEnvelope)env;
if(re.getCoordinateReferenceSystem()==null){re=newReferencedEnvelope(re,DefaultGeographicCRS.WGS84);
else{
if(request.getCrs()!=null){re=newReferencedEnvelope(env,request.getCrs());
else
if(request.getSRS()!=null){CoordinateReferenceSystemcrs=CRS.decode(request.getSRS());re=newReferencedEnvelope(env,crs);
else{re=newReferencedEnvelope(env,DefaultGeographicCRS.WGS84);
if(!CRS.equalsIgnoreMetadata(re.getCoordinateReferenceSystem(),DefaultGeographicCRS.WGS84)){returnre.transform(DefaultGeographicCRS.WGS84,true);
else{returnre;
if(br!=null&&br.getStatus().isClosed()){//reloadpagesetResponsePage(newConfigurationPage(InitConfigUtil.unwrap(configurationModel.getObject())));
if(value==null){thrownewServiceException("Novaluetobewrittenhasbeenprovided");
if(valueinstanceofList){files=(List<File>)value;
else
if(valueinstanceofFile){files=Collections.singletonList((File)value);
else{thrownewIllegalArgumentException(value.getClass()+"typeisn'tsupportedyet");
ifthepropertywasnotfound*/publicstaticCollectionLayerbuildCollectionLayerFromFeature(Featurefeature){//maptoasinglebeanCollectionLayerlayer=null;Propertyp=feature.getProperty(OpenSearchAccess.LAYER);
if(p!=null&&pinstanceofFeature){Featurelf=(Feature)p;layer=newCollectionLayer();layer.setWorkspace((String)getAttribute(lf,"workspace"));layer.setLayer((String)getAttribute(lf,"layer"));layer.setSeparateBands(Boolean.TRUE.equals(getAttribute(lf,"separateBands")));layer.setBands((String[])getAttribute(lf,"bands"));layer.setBrowseBands((String[])getAttribute(lf,"browseBands"));layer.setHeterogeneousCRS(Boolean.TRUE.equals(getAttribute(lf,"heterogeneousCRS")));layer.setMosaicCRS((String)getAttribute(lf,"mosaicCRS"));
if(p!=null){returnp.getValue();
else{returnnull;
ifnetcdfdataaresupported.*/publicclassNetCDFDataTestextendsTestCase{@TestpublicvoidtestFormatSupported()throwsFileNotFoundException,IOException{//SelectionoftheinputfileFilefile=TestData.file(this,"2DLatLonCoverage.nc");//Check
ifthegribfileisacceptedbytheNetCDFdriverAbstractGridFormatformat=newNetCDFFormat();Assert.assertTrue(format.accepts(file));//Check
ifthenetcdfreaderspiobjectcanreadtheinputfileImageReaderSpispi=newNetCDFImageReaderSpi();Assert.assertTrue(spi.canDecodeInput(file));
ifalmostonecoverageispresentAssert.assertNotNull(coverageNames);Assert.assertTrue(coverageNames.length>0);//ReadingofonecoverageGridCoverage2Dcoverage=reader.read(coverageNames[0],null);//Check
ifthecoverageexistsAssert.assertNotNull(coverage);
if(reader!=null){try{reader.dispose();
if(controllerBeaninstanceofAbstractCatalogController||controllerBeaninstanceofAbstractGeoServerController){AdminRequest.start(this);
if(!getManager().checkAuthenticationForAdminRole()){thrownewRestException("Amdinistrativeprivelegesrequired",HttpStatus.FORBIDDEN);
if(mode==null)thrownewResourceNotFoundException("Element"+MODE_ELEMENT+"ismissing");CatalogModemodeValue=null;for(CatalogModem:CatalogMode.values()){
if(m.toString().equals(mode)){modeValue=m;break;
if(modeValue==null)thrownewRestException("Notavalidmode:"+mode,HttpStatus.UNPROCESSABLE_ENTITY);ruleDAO.setCatalogMode(modeValue);ruleDAO.storeRules();}}
if(lastaccessedtime+idletime)<currenttime*/privateinttimeToIdleSeconds;/**Timeinseconds,Theentryexpires
if(creationtime+livetime)<currenttime*/privateinttimeToLiveSeconds;/**Timestampoflastaccessinmilliseconds*/privatelonglastAccessed;/**Timestampofcreationinmilliseconds*/privatelongcreated;publicAuthenticationCacheEntry(Authenticationauthentication,inttimeToIdleSeconds,inttimeToLiveSeconds){super();this.authentication=authentication;this.timeToIdleSeconds=timeToIdleSeconds;this.timeToLiveSeconds=timeToLiveSeconds;created=lastAccessed=System.currentTimeMillis();
iftheentryhasexpired,falseotherwise**@paramtimeInMilliSecs*/publicbooleanhasExpired(longtimeInMilliSecs){
if(lastAccessed+timeToIdleSeconds*1000<timeInMilliSecs)returntrue;
if(created+timeToLiveSeconds*1000<timeInMilliSecs)returntrue;returnfalse;
if(this==o)returntrue;
if(oinstanceofAuthenticationCacheEntry==false)returnfalse;AuthenticationCacheEntryother=(AuthenticationCacheEntry)o;
if(authentication==other.authentication)returntrue;
if(authentication==null||other.authentication==null)returnfalse;returnauthentication.equals(other.authentication);}}
if(!getSchema().equals(fc.getSchema())){thrownewIllegalArgumentException("Allfeaturecollectionsmusthavethesametype,found"+getSchema()+"and"+fc.getSchema()+"instead");
if(closeinstanceofCompositeIterator){((CompositeIterator)close).close();
if(processResult.getGroupByAttributes()==null||processResult.getGroupByAttributes().isEmpty()){//
ifthereisnogroupbyattributesweonlytoencodetheaggregationsfunction//resultsjson.put("GroupByAttributes",newString[0]);json.put("AggregationResults",newNumber[][]{encodeSimpleResult(processResult)});
else{//thereisgroupbyvaluessoweneedtoencodeallthegroupedresultsjson.put("GroupByAttributes",processResult.getGroupByAttributes().toArray());json.put("AggregationResults",processResult.getGroupByResult().toArray());
if(it.hasNext()){returntrue;
else{it.close();returnfalse;
if(pre==null){returnnewEnumeration(){@OverridepublicbooleanhasMoreElements(){returnfalse;
if(!result.contains(ows.getId()))result.add(ows.getId());
if(form.findSubmittingButton()!=form.get("save")){return;
if((roleInputString==null||roleInputString.trim().isEmpty())&&!rolesFormComponent.isHasAnyRole()){form.error(newParamResourceModel("emptyRoles",getPage()).getString());
if(ows.getId().equals(service)){for(Stringoperation:ows.getOperations()){
if(!result.contains(operation)){result.add(operation);
if(pathname.isFile()){Stringname=pathname.getName().toUpperCase();for(Stringextension:extensions){
if(name.endsWith(extension)){returntrue;
if(!pathname.isDirectory()){returnfalse;
if(pathname.isHidden()){returnfalse;
if(home!=null){hf=newFile(home);
if(hf!=null&&hf.exists()){USER_HOME=hf;
if(initialDirectory.getObject()==null){FilelastUsed=getSession().getMetaData(LAST_VISITED_DIRECTORY);initialDirectory.setObject(lastUsed);
ifitwaspossibletodetermineitatall
if(USER_HOME!=null){roots.add(1,USER_HOME);
ifthefileisarelativereferenceintothedatadir
if(selection!=null){FilerelativeToDataDir=loader.url(selection.getPath());
if(relativeToDataDir!=null){selection=relativeToDataDir;
if(selection!=null&&selection.exists()){for(Fileroot:roots){
if(isSubfile(root,selection.getAbsoluteFile())){selectionRoot=root;break;
ifthefileisnotpartoftheknownsearchpaths,giveup//and
switchbacktothedatadirectory
if(selectionRoot==null){selectionRoot=dataDirectory;initialDirectory=newModel<>(selectionRoot);
else{
if(!selection.isDirectory()){initialDirectory=newModel<>(selection.getParentFile());
else{initialDirectory=newModel<>(selection);
else{selectionRoot=dataDirectory;initialDirectory=newModel<>(selectionRoot);
if(RepositoryManager.isGeogigDirectory(file)){geogigDirectoryClicked(file,target);
else{getSession().setMetaData(LAST_VISITED_DIRECTORY,file);directoryClicked(file,target);
if(selection==null||"".equals(selection.getPath()))returnfalse;
if(selection.equals(root))returntrue;returnisSubfile(root,selection.getParentFile());
ifyoudon'twantfixedheightwithoverflow,*andtoavalidCSSmeasure
ifyouwantitinstead.Defaultvalueis"25em"**@paramheight*/publicvoidsetFileTableHeight(Stringheight){directoryListingTable.setTableHeight(height);
if(f==USER_HOME){returnnewParamResourceModel("userHome",DirectoryChooser.this).getString();
else{GeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);
if(f.equals(loader.getBaseDirectory())){returnnewParamResourceModel("dataDirectory",DirectoryChooser.this).getString();
if(displayName!=null&&displayName.length()>0){returndisplayName;
if(file.isDirectory()){
if(RepositoryManager.isGeogigDirectory(file)){returnfile.getName();
else{returnfile.getName();
if(lastModified==0L)returnnull;
else{returnDateFormat.getDateTimeInstance(DateFormat.MEDIUM,DateFormat.SHORT).format(newDate(file.lastModified()));
if("file".equals(uri.getScheme())){Fileconfigured=newFile(uri);Filecanonical;try{canonical=configured.getCanonicalFile();
if(isGeogigDirectory){
if(alreadyImported){link.setEnabled(false);Filedupicate=existing.get(canonicalFile);nameLabel.add(AttributeModifier.replace("title",newParamResourceModel("DirectoryChooser$DirectoryDataView.repoExists",DirectoryDataView.this,dupicate.getAbsolutePath()).getObject()));
else{link.setEnabled(DirectoryDataView.this.allowSelectingRepositories);
if(tableHeight!=null){tag.getAttributes().put("style","overflow:auto;height:"+tableHeight);
ifthistaskiscurrentlyrunning,waitRunrun=null;while((run=beans.getDataUtil().runIfPossible(element,batchRun))==null){try{Thread.sleep(100);
if(batchRun.isInterruptMe()){LOGGER.log(Level.INFO,"Batch"+batch.getFullName()+"manuallycancelled,rollingback.");rollback=true;
if(rollback){while(!resultStack.isEmpty()){RunrunPop=beans.getDao().reload(runStack.pop());runPop.setStatus(Run.Status.ROLLING_BACK);runPop=beans.getDao().save(runPop);try{resultStack.pop().rollback();runPop.setStatus(Run.Status.ROLLED_BACK);
if(!rollback){LOGGER.log(Level.INFO,"Committingbatch"+batch.getFullName());
ifthistaskiscurrentlystillwaitingforacommit,//waitwhile((runTemp=beans.getDataUtil().startCommitIfPossible(runPop))==null){try{Thread.sleep(100);
if(reportService.getFilter().matches(report.getType())){reportService.sendReport(report);
iftheMetadataMapalreadycontainstheNetCDFSettingsMetadataMapmap=info.getMetadata();NetCDFLayerSettingsContainercontainer=map.get(NetCDFSettingsContainer.NETCDFOUT_KEY,NetCDFLayerSettingsContainer.class);//Ifnotpresent,addittothemap
if(isNew||container==null){//container=newNetCDFLayerSettingsContainer();//GettingNetCDFSettingsfromtheGlobalonesGeoServergs=GeoServerExtensions.bean(GeoServer.class);MetadataMapglobalMap=gs.getGlobal().getSettings().getMetadata();NetCDFSettingsContainerglobalContainer=globalMap.get(NetCDFSettingsContainer.NETCDFOUT_KEY,NetCDFSettingsContainer.class);//Ifnotpresent,createanewcontainer
if(globalContainer==null){globalContainer=newNetCDFSettingsContainer();
if(node.hasAttribute("srsName")){URIsrs=(URI)node.getAttributeValue("srsName");crs=CRS.decode(srs.toString());
if(crs!=null){returnnewReferencedEnvelope(envelope,crs);
else{returnenvelope;
if(!actualFile.exists()){thrownewIllegalStateException("Cannotaccess"+actualFile);
if(!actualFile.exists()){thrownewIllegalStateException("Cannotaccess"+actualFile);
ifalreadyclosed,thereshouldbenoexception(seespecCloseable)
if(temp.exists()){Files.move(temp,file);
if(file.isDirectory()){thrownewIllegalStateException("Cannotcreatefile:isalreadyadirectory.");
if(!file.exists()&&!((file.getParentFile()==null||file.getParentFile().exists()||file.getParentFile().mkdirs())&&file.createNewFile())){thrownewIllegalStateException("Couldnotcreatefile.");
if(file.exists()&&!file.isDirectory()){thrownewIllegalStateException("Cannotcreatedirectory:isalreadyafile.");
if(!file.exists()&&!file.mkdirs()){thrownewIllegalStateException("Couldnotcreatedirectory.");
if(!file.isDirectory()){returnCollections.emptyList();
if(destinstanceofFileSystemResourceStore.FileSystemResource){returnfile.renameTo(((FileSystemResourceStore.FileSystemResource)dest).file);
else
if(destinstanceofResourceAdaptor){returnfile.renameTo(((ResourceAdaptor)dest).file);
else{returnResources.renameByCopy(this,dest);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;ResourceAdaptorother=(ResourceAdaptor)obj;
if(file==null){
if(other.file!=null)returnfalse;
else
if(!file.equals(other.file))returnfalse;returntrue;
if(res==null){returnnull;
if(file==null){returnnewFile(baseDirectory,res.path());
if(file==null){thrownewIllegalArgumentException("Filerequired");
if(temp.exists()){temp.delete();
ifsourcefilemovedtodest*/publicstaticbooleanmove(Filesource,Filedest)throwsIOException{
if(source==null||!source.exists()){thrownewNullPointerException("Filesourcerequired");
if(dest==null){thrownewNullPointerException("Filedestrequired");
if(samePath)returntrue;//windowsneedsspecialtreatment,wecannotrenameontoanexistingfile
if(win&&dest.exists()){//windowsdoesnotdoatomicrenames,andcannotrenameafile
ifthedestfile//exists
if(!dest.delete()){thrownewIOException("Failedtomove"+source.getAbsolutePath()+"-unabletoremoveexisting:"+dest.getCanonicalPath());
if(!source.renameTo(dest)){thrownewIOException("Failedtomove"+source.getAbsolutePath()+"to"+dest.getAbsolutePath());
ifanyfilepresentisremoved*/publicstaticbooleandelete(Filefile){
if(file.isDirectory()){emptyDirectory(file);
ifallthedirectorycontentscouldbedeleted,falseotherwise*/privatestaticbooleanemptyDirectory(Filedirectory){
if(!directory.isDirectory()){thrownewIllegalArgumentException(directory+"doesnotappeartobeadirectoryatall...");
if(files[i].isDirectory()){allClean&=delete(files[i]);
else{
if(!files[i].delete()){LOGGER.log(Level.WARNING,"Couldnotdelete{0}",files[i].getAbsolutePath());allClean=false;
if(requestinstanceofHttpServletRequest){HttpServletRequestrequestHTTP=(HttpServletRequest)request;
if(requestNeedsWrapper(requestHTTP)){try{request=newRequestWrapper(requestHTTP);
if(pathInfo.equals("/")||pathInfo.equals("")){request="landingPage";
else
if(pathInfo.equals("/api")||pathInfo.equals("/api/")){request="api";
else
if(pathInfo.endsWith("/conformance")||pathInfo.endsWith("/conformance/")){request="conformance";
else
if(pathInfo.startsWith("/collections")){List<Function<String,Boolean>>matchers=newArrayList<>();matchers.add(path->{Matchermatcher=Pattern.compile("/collections/([^/]+)/items/(.+)").matcher(path);booleanmatches=matcher.matches();
if(matches){request="getFeature";StringlayerName=matcher.group(1);setLayerName(layerName);this.featureId=matcher.group(2);
if(matches){request="getFeature";StringlayerName=matcher.group(1);setLayerName(layerName);
if(matches){request="collections";StringlayerName=matcher.group(1);setLayerName(layerName);
if(matches){request="collections";
if(matcher.apply(pathInfo)){matched=true;break;
ifnonematches,complain
if(!matched){thrownewHttpErrorCodeException(HttpStatus.NOT_FOUND.value(),"Unsupportedpath"+pathInfo);
else{thrownewHttpErrorCodeException(HttpStatus.NOT_FOUND.value(),"Unsupportedpath"+pathInfo);
if(f!=null){
if("json".equalsIgnoreCase(f)){this.outputFormat="getFeature".equals(request)?RFCGeoJSONFeaturesResponse.MIME:BaseRequest.JSON_MIME;
else
if("yaml".equalsIgnoreCase(f)){this.outputFormat=BaseRequest.YAML_MIME;
else
if("html".equalsIgnoreCase(f)){this.outputFormat=BaseRequest.HTML_MIME;
else{this.outputFormat=f;
else
if("getFeature".equals(request)){this.outputFormat=RFCGeoJSONFeaturesResponse.MIME;
if(limit!=null){this.limit=limit;
if(!layers.isEmpty()){typeName=layers.get(0).prefixedName();
else{thrownewHttpErrorCodeException(HttpStatus.NOT_FOUND.value(),"Couldnotfindlayer"+layerName);
if(bbox!=null){try{//isitparseable?BBoxKvpParserparser=newBBoxKvpParser();ReferencedEnvelopeenvelope=(ReferencedEnvelope)parser.parse(bbox);//
if2DandlackingaCRS,forceWGS84
if(envelope.getCoordinateReferenceSystem()==null&&envelope.getDimension()==2){filtered.put("bbox",bbox+",EPSG:4326");
if(typeName!=null){filtered.put("typeName",typeName);
if(outputFormat!=null){filtered.put("outputFormat",outputFormat);
if(featureId!=null&&!featureId.isEmpty()){filtered.put("featureId",featureId);
if(limit!=null&&!limit.isEmpty()){filtered.put("count",limit);
if(values==null||values.length==0){returnnull;
else{returnvalues[0];
ifnooverridetrytoloadfromtheGeoServerloader
if(baseDirPath!=null){baseDir=Resources.fromPath(baseDirPath);
else{baseDir=loader.get("cluster");
if(store==null){thrownewServiceException("CatalogservicecouldnotfindaCatalogStoreimplementationregisteredintheSpringapplicationcontext",ServiceException.NO_APPLICABLE_CODE);
if(storeCandidates!=null&&storeCandidates.size()>0){StringdefaultStore=System.getProperty("DefaultCatalogStore");
if(defaultStore!=null){for(CatalogStorestore:storeCandidates){
if(store.getClass().getName().equals(defaultStore)){this.store=store;break;
if(store==null){store=storeCandidates.get(0);
iftheresolutionisto*high.*/privatestaticlonggetHistogramMaxThreshold(){Stringvalue=System.getProperty(HISTOGRAM_MAX_THRESHOLD_VARIABLE);
if(value==null){//nouserprovidedvalue,solet'sreturnthedefaultvaluereturnHISTOGRAM_MAX_THRESHOLD_DEFAULT;
if(domainValues.isEmpty()){//FIXME:Howtorepresentadomainwithnovalues?returnTuple.tuple("",Collections.emptyList());
if(index>=0){histogramValues.set(index,histogramValues.get(index)+1);
else
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Bucketnotfoundforvalue:"+value);
switch(findHistogramType(domainValues)){caseNUMERIC:returngetNumericBuckets(domainValues,resolution);caseTIME:returngetTimeBuckets(domainValues,resolution);default:returngetEnumeratedBuckets(domainValues);
if(valueinstanceofRange){//thisisarangesoletsusetheminvaluevalue=((Range)value).getMinValue();
if(valueinstanceofNumber){returnHistogramType.NUMERIC;
if(valueinstanceofDate){returnHistogramType.TIME;
ifthemaxvalueisattheveryedgeofthelastinterval,thenaddonemore(weare//goingto//useintervalsthatcontainfirstbutnotlasttoavoidoverlaps
if((max-min)%finalResolution==0){max+=finalResolution;
if((max-min)/finalResolution==1){//onebucketcatchesallbooleanincludeLast=(max-min)<finalResolution;returnTuple.tuple(domainString,Collections.singletonList(NumberRange.create(min,true,max,includeLast)));
if(limit>max){buckets.add(NumberRange.create(step,true,max,true));break;
ifthemaxvalueisattheveryedgeofthelastinterval,thenaddonemore(weare//goingto//useintervalsthatcontainfirstbutnotlasttoavoidoverlapsresolution=resolution!=null?resolution:TIME_DEFAULT_RESOLUTION;longdifference=max.getTime()-min.getTime();longresolutionInMs;try{resolutionInMs=org.geoserver.ows.kvp.TimeParser.parsePeriod(resolution);
if(difference%resolutionInMs==0){//
ifthemaxvalueisattheveryedgeofthelastinterval,thenaddonemore(we//aregoingto//useintervalsthatcontainfirstbutnotlasttoavoidoverlapsmax=newDate(max.getTime()+resolutionInMs);
if(intervals.size()==1){booleanincludeLast=difference<resolutionInMs;returnTuple.tuple(intervalsAndSpec.first,Collections.singletonList(newDateRange(min,true,max,includeLast)));
if(last.getTime()<minMax.second.getTime()){intervals.add(newDate(last.getTime()+resolutionInMs));
if(buckets.get(i).contains(value)){returni;
if*theprovidedvaluesisequaltotheenumeratedvalue.*/privatestaticfinalclassEnumeratedRangeextendsRange<String>{publicEnumeratedRange(Stringvalue){super(String.class,value,true,value,true);
if(workspace!=null){workspace.detach();
if(value==null){//checkwearenotgoingabovethelimit
if(maxItems>0&&providers.size()>maxItems){thrownewWPSException("Toomanyvaluesforinput"+getInputId()+",themaxis"+maxItems,"NoApplicableCode",getInputId());
if(providerLongSteps>0){subListener=newSubProgressListener(listener,(stepsSoFar/totalSteps)*100,(providerLongSteps/totalSteps)*100);
else{subListener=newNullProgressListener();
if(List.class.isAssignableFrom(type)){return(IConverter<C>)newSRSListConverter();
if(srsList.isEmpty())return"";StringBuffersb=newStringBuffer();for(Stringsrs:srsList){sb.append(srs).append(",");
if(value==null||value.trim().equals(""))returnCollections.emptyList();returnnewArrayList<String>(Arrays.asList(COMMA_SEPARATED.split(value)));
if(invalid.size()>0){IValidationErrorerr=newValidationError("SRSListTextArea.unknownEPSGCodes").addKey("SRSListTextArea.unknownEPSGCodes").setVariable("codes",invalid.toString());validatable.error(err);
ifthefeature.*IfaduplicateexiststhentheWFSshouldraisean*exception.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:enumeration&gt;*&lt;xsd:enumerationvalue="ReplaceDuplicate"&gt;*&lt;xsd:annotation&gt;*&lt;xsd:documentation&gt;*TheReplaceDuplicatevalueindicatesthatWFSshould*notgenerateanewfeatureidentifierforthefeature*beinginsertedintotherepositry.Instead,theWFS*shouldusetheidentifierencoded
ifthefeature.*IfaduplicateexiststhentheWFSshouldreplacethe*existingfeatureinstancewiththeoneencodedinthe*Insertaction.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:enumeration&gt;*&lt;xsd:enumerationvalue="GenerateNew"&gt;*&lt;xsd:annotation&gt;*&lt;xsd:documentation&gt;*TheGenerateNewvalueindicatesthatWFSshould*generateanewuniquefeatureidentifierforthe*featurebeinginsertedintotherepositry.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:enumeration&gt;*&lt;/xsd:restriction&gt;*&lt;/xsd:simpleType&gt;**</code>*</pre>**@generated*/publicclassIdentifierGenerationOptionTypeBindingextendsAbstractSimpleBinding{WfsFactorywfsfactory;publicIdentifierGenerationOptionTypeBinding(WfsFactorywfsfactory){this.wfsfactory=wfsfactory;
if("UseExisting".equals(value)){returnIdentifierGenerationOptionType.USE_EXISTING_LITERAL;
if("ReplaceDuplicate".equals(value)){returnIdentifierGenerationOptionType.REPLACE_DUPLICATE_LITERAL;
if("GenerateNew".equals(value)){returnIdentifierGenerationOptionType.GENERATE_NEW_LITERAL;
if(item==null){return"Finished";
ifnomatchisfound**@paramname*/publicstaticGeoToolsLoggingRedirectionfindValue(Stringname){for(GeoToolsLoggingRedirectionvalue:values()){
if(value.name().equalsIgnoreCase(name))returnvalue;
if(!(appenderinstanceofConsoleAppender||appenderinstanceofFileAppender)){//saveitappenders.add(appender);
if(!suppressFileLogging){Appendergslf=org.apache.log4j.Logger.getRootLogger().getAppender("geoserverlogfile");
if(gslfinstanceoforg.apache.log4j.FileAppender){
if(logFileName==null){logFileName=loader.get("logs").get("geoserver.log").file().getAbsolutePath();
else{
if(!newFile(logFileName).isAbsolute()){logFileName=newFile(loader.getBaseDirectory(),logFileName).getAbsolutePath();LoggingInitializer.LOGGER.fine("Non-absolutepathnamedetectedforlogfile.Settinglogfilerelativetodatadir.");
else
if(gslf!=null){LoggingInitializer.LOGGER.warning("'log4j.appender.geoserverlogfile'appenderisdefined,butisn'taFileAppender.GeoServerwon'tcontrolthefile-basedlogging.");
else{LoggingInitializer.LOGGER.warning("'log4j.appender.geoserverlogfile'appenderisn'tdefined.GeoServerwon'tcontrolthefile-basedlogging.");
if(suppressStdOutLogging){LoggingInitializer.LOGGER.info("SuppressingStdOutlogging.IfyouwanttoseeGeoServerlogs,besuretolookin'"+logFileName+"'");EnumerationallAppenders=org.apache.log4j.Logger.getRootLogger().getAllAppenders();AppendercurApp;while(allAppenders.hasMoreElements()){curApp=(Appender)allAppenders.nextElement();
if(curAppinstanceoforg.apache.log4j.ConsoleAppender){org.apache.log4j.Logger.getRootLogger().removeAppender(curApp);
ifthesuppressstdoutloggingistrue.LoggingInitializer.LOGGER.fine("CONFIGURINGGEOSERVERLOGGING-------------------------");
if(configFileName==null){configFileName="DEFAULT_LOGGING.properties";LoggingInitializer.LOGGER.warning("Nolog4jConfigFiledefinedinservices.xml:using'DEFAULT_LOGGING.properties'");
if(resource==null||resource.getType()==Type.UNDEFINED){//hmm,well,wedon'thavealog4jconfigfileandthiscouldbeduetothefact//thatthisisadata-dirupgrade.WecancountontheDEFAULT_LOGGING.propertiesfile//beingpresentontheclasspath,sowe'llupgradetheirdata_dirandthenusethe//defaultDEFAULT_LOGGING.propertiesconfiguration.LoggingInitializer.LOGGER.warning("log4jConfigFile'"+configFileName+"'couldn'tbefoundinthedatadir,soGeoServerwill"+"installthevariousloggingconfigfileintothedatadir,andthentrytofinditagain.");Resourcelogs=resourceLoader.get("logs");Filelcdir=logs.dir();//nowwecopyinthevariousloggingconfigfilesfromthebaserepolocationonthe//classpathfinalString[]lcfiles=newString[]{"DEFAULT_LOGGING.properties","GEOSERVER_DEVELOPER_LOGGING.properties","GEOTOOLS_DEVELOPER_LOGGING.properties","PRODUCTION_LOGGING.properties","QUIET_LOGGING.properties","TEST_LOGGING.properties","VERBOSE_LOGGING.properties"};for(inti=0;i<lcfiles.length;i++){Filetarget=newFile(lcdir.getAbsolutePath(),lcfiles[i]);
if(!target.exists()){resourceLoader.copyFromClassPath(lcfiles[i],target);
if(resource.getType()!=Type.RESOURCE){LoggingInitializer.LOGGER.warning("Stillcouldn'tfindlog4jConfigFile'"+configFileName+"'.UsingDEFAULT_LOGGING.propertiesinstead.");
if(resource==null||resource.getType()!=Type.RESOURCE){thrownewConfigurationException("Unabletoloadloggingconfiguration'"+configFileName+"'.Inaddition,anattempt"+"wasmadetocreatethe'logs'directoryinyourdatadir,andtousetheDEFAULT_LOGGINGconfiguration,but"+"thisfailedaswell.Isyourdatadirwriteable?");
if(loggingConfigStream==null){LoggingInitializer.LOGGER.warning("Couldn'topenLog4Jconfigurationfile'"+resource);return;
else{LoggingInitializer.LOGGER.fine("GeoServerloggingprofile'"+resource.name()+"'enabled.");
if(location==null){returnbaseLocation;
else{returnlocation;
ifno*converterisgiven,rolesareparsedbythedefaultconverter{@link*GeoServerRoleConverter}**@authorchristian*/publicabstractclassPreAuthenticatedUserNameFilterConfigextendsSecurityFilterConfigimplementsSecurityAuthFilterConfig{privateRoleSourceroleSource;privateStringrolesHeaderAttribute;privateStringuserGroupServiceName;privateStringroleConverterName;privateStringroleServiceName;/***RoleSourcelistvaluescommontoallPreAuthenticatedUserNameFilterConfighierarchy.**@authorMauroBartolomeoli(mauro.bartolomeoli@geo-solutions.it)*/publicstaticenumPreAuthenticatedUserNameRoleSourceimplementsRoleSource{Header,UserGroupService,RoleService;@Overridepublicbooleanequals(RoleSourceother){returnother!=null&&other.toString().equals(toString());
ifthelayerexistenceshouldbeadvertised(truebydefault,unlessotherwise*set)*/booleanisAdvertised();/***Settotrue
ifthelayershouldbeadvertised,falseotherwise**@paramadvertised*/voidsetAdvertised(booleanadvertised);/***ThedefaultWMSinterpolationmethod.**<p>Ifnotspecifed(i.e.{@codenull}),theservicedefaultwillbeused.*/WMSInterpolationgetDefaultWMSInterpolationMethod();/***SetsthedefaultWMSinterpolationmethod.**<p>Admissiblevaluesare:**<ul>*<li><strong>Nearest</strong>-NearestNeighborInterpolation*<li><strong>Bilinear</strong>-BilinearInterpolation*<li><strong>Bicubic</strong>-BicubicInterpolation*</ul>**@paraminterpolationMethodtheinterpolationmethodusedbydefault*/voidsetDefaultWMSInterpolationMethod(WMSInterpolationinterpolationMethod);}
if(list.isEmpty()){//suspicious,didthecollectionactuallyexist?queryCollection(collection,q->{});
if(productPayload==null){thrownewRestException("product.jsonfileismissingfromthezip",HttpStatus.BAD_REQUEST);
if(rawLinks!=null){OgcLinkslinks=parseJSON(OgcLinks.class,rawLinks);linksCollection=beansToLinksCollection(links);
else{linksCollection=null;
if(rawGranules!=null){granulesCollection=parseGeoJSONFeatureCollection("granules.json",rawGranules);
else{granulesCollection=null;
if(description!=null){StringdescriptionString=newString(description);fs.modifyFeatures(newNameImpl(nsURI,OpenSearchAccess.DESCRIPTION),descriptionString,filter);
if(metadata!=null){StringdescriptionString=newString(metadata);fs.modifyFeatures(OpenSearchAccess.METADATA_PROPERTY_NAME,descriptionString,filter);
if(linksCollection!=null){fs.modifyFeatures(OpenSearchAccess.OGC_LINKS_PROPERTY_NAME,linksCollection,filter);
if(thumbnail!=null){fs.modifyFeatures(OpenSearchAccess.QUICKLOOK_PROPERTY_NAME,thumbnail,filter);
if(granulesCollection!=null){fs.modifyFeatures(newNameImpl(nsURI,OpenSearchAccess.GRANULES),granulesCollection,filter);
ifgothere,allisfinereturnreturnCreatedProductReference(collection,request,productId);
if(OpenSearchAccess.METADATA_PROPERTY_NAME.equals(propertyName)||OpenSearchAccess.OGC_LINKS_PROPERTY_NAME.equals(propertyName)||OpenSearchAccess.DESCRIPTION.equals(propertyName.getLocalPart())){continue;
if(metadataProperty!=null&&metadataProperty.getValue()instanceofString){Stringvalue=(String)metadataProperty.getValue();response.setContentType("text/xml");StreamUtils.copy(value,Charset.forName("UTF-8"),response.getOutputStream());
else{throwProductNotFound(collection,product,"Metadataforproduct");
if(descriptionProperty!=null&&descriptionProperty.getValue()instanceofString){Stringvalue=(String)descriptionProperty.getValue();response.setContentType("text/html");StreamUtils.copy(value,Charset.forName("UTF-8"),response.getOutputStream());
else{throwProductNotFound(collection,product,"Product");
if(thumbnailProperty!=null&&thumbnailProperty.getValue()instanceofbyte[]){byte[]value=(byte[])thumbnailProperty.getValue();response.setContentType(DefaultOpenSearchEoService.guessImageMimeType(value));StreamUtils.copy(value,response.getOutputStream());
else{throwProductNotFound(collection,product,"Thumbnailforproduct");
if(feature==null){throwProductNotFound(collection,product,"Product");
if(disassociateRoles)return".*"+getRemoveableObject().getUsername()+".*"+GeoServerRole.ADMIN_ROLE+".*";
elsereturn".*"+getRemoveableObject().getUsername()+".*";}}
if(GeoServerFunctionalTestContext.class.isAssignableFrom(parent.context.getClass())){this.context=GeoServerFunctionalTestContext.class.cast(parent.context);
if(repoName!=null){try{Repositoryrepo=this.context.getRepo(repoName);
if(repo!=null){repo.close();
if(t!=null)returnt;//otherwise,buildaloaderanddothelookupGeoServerTemplateLoadertemplateLoader=newGeoServerTemplateLoader(lookup!=null?lookup:getClass());templateLoader.setFeatureType(featureType);//Configurationisnotthreadsafesynchronized(templateConfig){templateConfig.setTemplateLoader(templateLoader);t=templateConfig.getTemplate(template);t.setEncoding("UTF-8");
iftherequiredtemplateisemptyorhasitsdefaultcontent**@paramfeatureType*@paramtemplate*@paramlookup*@throwsIOException*/publicbooleanisTemplateEmpty(SimpleFeatureTypefeatureType,Stringtemplate,Class<FeatureTemplate>lookup,StringdefaultContent)throwsIOException{Templatet=lookupTemplate(featureType,template,lookup);
if(t==null){returntrue;
ifthetemplateisemptyStringWritersw=newStringWriter();t.dump(sw);//anemptytemplatecanonicalformis"0\n"..weird!StringtemplateText=sw.toString();return"".equals(templateText)||(defaultContent!=null&&defaultContent.equals(templateText));
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;finalTemplateKeyother=(TemplateKey)obj;
if(template==null){
if(other.template!=null)returnfalse;
else
if(!template.equals(other.template))returnfalse;
if(type==null){
if(other.type!=null)returnfalse;
else
if(!type.equals(other.type))returnfalse;returntrue;
ifnosuchstylecouldbefound.*/publicstaticStylestyle(StyledLayerDescriptorsld){for(inti=0;i<sld.getStyledLayers().length;i++){Style[]styles=null;
if(sld.getStyledLayers()[i]instanceofNamedLayer){NamedLayerlayer=(NamedLayer)sld.getStyledLayers()[i];styles=layer.getStyles();
else
if(sld.getStyledLayers()[i]instanceofUserLayer){UserLayerlayer=(UserLayer)sld.getStyledLayers()[i];styles=layer.getUserStyles();
if(styles!=null){for(intj=0;j<styles.length;j++){
if(!(styles[j]instanceofNamedStyle)){returnstyles[j];
if(format==null){thrownewIllegalArgumentException("Styleformatmustnotbenull");
if(format.equalsIgnoreCase(h.getFormat())){matches.add(h);
if(matches.isEmpty()){//lookbymimetypefor(StyleHandlerh:allHandlers){for(Versionver:h.getVersions()){
if(h.mimeType(ver).equals(format)){matches.add(h);
if(matches.isEmpty()){//lookbyfileextensionfor(StyleHandlerh:allHandlers){
if(format.equalsIgnoreCase(h.getFileExtension())){matches.add(h);
if(matches.isEmpty()){thrownewRuntimeException("Nosuchstylehandler:format="+format);
if(matches.size()==1){returnmatches.get(0);
if(GeoServerCompositeFilter.thisinstanceofAuthenticationCachingFilter&&currentPosition==0){StringcacheKey=authenticateFromCache((AuthenticationCachingFilter)GeoServerCompositeFilter.this,(HttpServletRequest)request);
if(cacheKey!=null)request.setAttribute(CACHE_KEY_ATTRIBUTE,cacheKey);
if(nestedFilters==null||currentPosition==nestedFilters.size()){AuthenticationpostAuthentication=SecurityContextHolder.getContext().getAuthentication();StringcacheKey=(String)request.getAttribute(CACHE_KEY_ATTRIBUTE);
if(postAuthentication!=null&&cacheKey!=null){IntegeridleSecs=(Integer)request.getAttribute(CACHE_KEY_IDLE_SECS);IntegerliveSecs=(Integer)request.getAttribute(CACHE_KEY_LIVE_SECS);getSecurityManager().getAuthenticationCache().put(getName(),cacheKey,postAuthentication,idleSecs,liveSecs);
else{currentPosition++;FilternextFilter=nestedFilters.get(currentPosition-1);nextFilter.doFilter(request,response,this);
if(nestedFilters==null||nestedFilters.size()==0){chain.doFilter(request,response);return;
if(coverageName==null){coverageName=this.coverageName;
if(coverageName==null){coverageName=this.coverageName;
if(caps!=null){return;
if(dcov!=null){qualifyLayerNames(dcov.getIdentifier(),ws);return;
if(gcov!=null){
if(gcov.getIdentifier()!=null&&gcov.getIdentifier().getValue()!=null){gcov.getIdentifier().setValue(qualifyName(gcov.getIdentifier().getValue(),ws));
ifweenablenearestmatchsetupVectorDimension(ResourceInfo.TIME,"time",DimensionPresentation.LIST,null,ResourceInfo.TIME_UNIT,null);BufferedImageimage=getAsImage("wms?service=WMS&version=1.1.1&request=GetMap"+"&bbox=-180,-90,180,90&styles=&Format=image/png&width=80&height=40&srs=EPSG:4326"+"&layers="+getLayerId(V_TIME_ELEVATION)+"&time=2011-05-02T01:00:00Z","image/png");//notanexactmatch,shouldnotgetanythingassertPixel(image,20,10,Color.WHITE);assertPixel(image,60,10,Color.WHITE);assertPixel(image,20,30,Color.WHITE);assertPixel(image,60,30,Color.WHITE);
ifweenablenearestmatchsetupVectorDimension(ResourceInfo.TIME,"time",DimensionPresentation.LIST,null,ResourceInfo.TIME_UNIT,null);setupNearestMatch(V_TIME_ELEVATION,ResourceInfo.TIME,true);BufferedImageimage=getAsImage("wms?service=WMS&version=1.1.1&request=GetMap"+"&bbox=-180,-90,180,90&styles=&Format=image/png&width=80&height=40&srs=EPSG:4326"+"&layers="+getLayerId(V_TIME_ELEVATION)+"&time=2011-05-02T01:00:00Z","image/png");assertWarningCount(1);assertNearestTimeWarning(getLayerId(V_TIME_ELEVATION),"2011-05-02T00:00:00.000Z");//weshouldgetonlythesecond(nearestmatch)assertPixel(image,20,10,Color.WHITE);assertPixel(image,60,10,Color.BLACK);assertPixel(image,20,30,Color.WHITE);assertPixel(image,60,30,Color.WHITE);
ifweenablenearestmatchsetupVectorDimension(ResourceInfo.TIME,"time",DimensionPresentation.LIST,null,ResourceInfo.TIME_UNIT,null);StringbaseURL="wms?service=WMS&version=1.1.1&request=GetMap"+"&bbox=-180,-90,180,90&styles=&Format=image/png&width=80&height=40&srs=EPSG:4326"+"&layers="+getLayerId(V_TIME_ELEVATION);//bigenoughrangesetupNearestMatch(V_TIME_ELEVATION,ResourceInfo.TIME,true,"P1D");getAsImage(baseURL+"&time=2011-05-02T01:00:00Z","image/png");assertWarningCount(1);assertNearestTimeWarning(getLayerId(V_TIME_ELEVATION),"2011-05-02T00:00:00.000Z");//toosmallrange,won'tmatchsetupNearestMatch(V_TIME_ELEVATION,ResourceInfo.TIME,true,"PT1M");getAsImage(baseURL+"&time=2011-05-02T01:00:00Z","image/png");assertWarningCount(1);assertNoNearestWarning(getLayerId(V_TIME_ELEVATION),ResourceInfo.TIME);//bigenoughtowardsfuturesetupNearestMatch(V_TIME_ELEVATION,ResourceInfo.TIME,true,"PT0M/P1D");getAsImage(baseURL+"&time=2011-05-02T01:00:00Z","image/png");assertWarningCount(1);assertNearestTimeWarning(getLayerId(V_TIME_ELEVATION),"2011-05-03T00:00:00.000Z");
ifweenablenearestmatchsetupVectorDimension(ResourceInfo.TIME,"time",DimensionPresentation.LIST,null,ResourceInfo.TIME_UNIT,null);setupNearestMatch(V_TIME_ELEVATION,ResourceInfo.TIME,true);BufferedImageimage=getAsImage("wms?service=WMS&version=1.1.1&request=GetMap"+"&bbox=-180,-90,180,90&styles=&Format=image/png&width=80&height=40&srs=EPSG:4326"+"&layers="+getLayerId(V_TIME_ELEVATION)+"&time=2013-05-02","image/png");assertWarningCount(1);assertNearestTimeWarning(getLayerId(V_TIME_ELEVATION),"2011-05-04T00:00:00.000Z");//weshouldgetonlythelastassertPixel(image,20,10,Color.WHITE);assertPixel(image,60,10,Color.WHITE);assertPixel(image,20,30,Color.WHITE);assertPixel(image,60,30,Color.BLACK);
ifweenablenearestmatchsetupVectorDimension(ResourceInfo.TIME,"time",DimensionPresentation.LIST,null,ResourceInfo.TIME_UNIT,null);setupNearestMatch(V_TIME_ELEVATION,ResourceInfo.TIME,true);BufferedImageimage=getAsImage("wms?service=WMS&version=1.1.1&request=GetMap"+"&bbox=-180,-90,180,90&styles=&Format=image/png&width=80&height=40&srs=EPSG:4326"+"&layers="+getLayerId(V_TIME_ELEVATION)+"&time=1990-05-02","image/png");assertWarningCount(1);assertNearestTimeWarning(getLayerId(V_TIME_ELEVATION),"2011-05-01T00:00:00.000Z");//weshouldgetonlythefirstassertPixel(image,20,10,Color.BLACK);assertPixel(image,60,10,Color.WHITE);assertPixel(image,20,30,Color.WHITE);assertPixel(image,60,30,Color.WHITE);
ifanimatedgifistrulytransparent//notethatinthistestBGCOLORshouldbewhite,
elseALListransparent//notebyuncommentinglinesbelowyoucanseeactualoutputsetupVectorDimension(ResourceInfo.TIME,"time",DimensionPresentation.LIST,null,null,null);MockHttpServletResponseresponse=getAsServletResponse("wms?service=WMS&version=1.1.1&request=GetMap"+"&bbox=-180,-90,180,90&styles=&width=80&height=40&srs=EPSG:4326"+"&layers="+getLayerId(V_TIME_ELEVATION)+"&time=2011-05-02,2011-05-04,2011-05-10&format="+GIFMapResponse.IMAGE_GIF_SUBTYPE_ANIMATED+"&TRANSPARENT=true&BGCOLOR=0xfffff");//checkwedidnotgetaserviceexceptionassertEquals("image/gif",response.getContentType());//checkitisaanimatedgifwiththreeframesByteArrayInputStreambis=getBinaryInputStream(response);ImageInputStreamiis=ImageIO.createImageInputStream(bis);ImageReaderreader=ImageIO.getImageReadersBySuffix("gif").next();reader.setInput(iis);assertEquals(3,reader.getNumImages(true));//creatingfilmstriptobeabletotestdifferentframesofanimatedgif//http://stackoverflow.com/questions/18908217/losing-transparency-when-using-imageinputstream-and-bufferedimage-to-create-pnginth=reader.getHeight(0);intw=reader.getWidth(0);intn=reader.getNumImages(true);BufferedImageimage=newBufferedImage(w*n,h,BufferedImage.TYPE_INT_ARGB);Graphics2Dg=image.createGraphics();for(inti=0;i<n;i++){BufferedImageimg=reader.read(i);g.drawImage(img,w*i,0,null);//wanttoseetheindividualframeimagesandthefilmstrip?uncommentbelow//Fileoutputfile=newFile("/tmp/geoserveranimatedtransparentframe"+i+".gif");//ImageIO.write(img,"gif",outputfile);
iftheserviceis*global.*/WorkspaceInfogetWorkspace();/**Setstheworkspacetheserviceisspecificorlocalto.*/voidsetWorkspace(WorkspaceInfoworkspace);/***Theglobalgeoserverconfiguration.**@uml.propertyname="geoServer"*@uml.associationEndinverse="service:org.geoserver.config.GeoServerInfo"*/GeoServergetGeoServer();/***Setstheglobalgeoserverconfiguration.**@uml.propertyname="geoServer"*/voidsetGeoServer(GeoServergeoServer);/**@uml.propertyname="citeCompliant"*/booleanisCiteCompliant();/**@uml.propertyname="citeCompliant"*/voidsetCiteCompliant(booleanciteCompliant);/**@uml.propertyname="enabled"*/booleanisEnabled();/**@uml.propertyname="enabled"*/voidsetEnabled(booleanenabled);/**@uml.propertyname="onlineResource"*/StringgetOnlineResource();/**@uml.propertyname="onlineResource"*/voidsetOnlineResource(StringonlineResource);/**@uml.propertyname="title"*/StringgetTitle();/**@uml.propertyname="title"*/voidsetTitle(Stringtitle);/**@uml.propertyname="abstract"*/StringgetAbstract();/**@uml.propertyname="abstract"*/voidsetAbstract(Stringabstrct);/**@uml.propertyname="maintainer"*/StringgetMaintainer();/**@uml.propertyname="maintainer"*/voidsetMaintainer(Stringmaintainer);/**@uml.propertyname="fees"*/StringgetFees();/**@uml.propertyname="fees"*/voidsetFees(Stringfees);/**@uml.propertyname="accessConstraints"*/StringgetAccessConstraints();/**@uml.propertyname="accessConstraints"*/voidsetAccessConstraints(StringaccessConstraints);/***Theversionsoftheservicethatareavailable.**<p>Thislistcontainsobjectsoftype{@linkVersion}.**@uml.propertyname="versions"*/List<Version>getVersions();/***Keywordsassociatedwiththeservice.**@uml.propertyname="keywords"*/List<KeywordInfo>getKeywords();/**Listofkeywordvalues,derivedfrom{@link#getKeywords()}.*/List<String>keywordValues();/***Exceptionformatstheservicecanprovide.**@uml.propertyname="exceptionFormats"*/List<String>getExceptionFormats();/***Theservicemetadatalink.**@uml.propertyname="metadataLink"*@uml.associationEndinverse="service:org.geoserver.catalog.MetadataLinkInfo"*/MetadataLinkInfogetMetadataLink();/***Setteroftheproperty<tt>metadataLink</tt>**@uml.propertyname="metadataLink"*/voidsetMetadataLink(MetadataLinkInfometadataLink);/***Setstheoutputstrategyusedbytheservice.**<p>Thisvalueisanidentifierwhichindicateshowtheoutputofaresponseshouldbehave.An*examplemightbe"performance",indicatingthattheresponseshouldbeencodedasquicklyas*possible.*/StringgetOutputStrategy();/**Setstheoutputstrategy.*/voidsetOutputStrategy(StringoutputStrategy);/**Thebaseurlfortheschemasdescribingtheservice.*/StringgetSchemaBaseURL();/**Setsthebaseurlfortheschemasdescribingtheservice.*/voidsetSchemaBaseURL(StringschemaBaseURL);/**Flagindicating
iftheserviceshouldbeverboseornot.*/booleanisVerbose();/**Setstheflagindicating
iftheserviceshouldbeverboseornot.*/voidsetVerbose(booleanverbose);/**@uml.propertyname="metadata"*/MetadataMapgetMetadata();Map<Object,Object>getClientProperties();}
if(messageTemplate==null){messageTemplate="Youforgottosetthe'message'option";
if(options.get("font-italic")!=null){this.fontItalic=Boolean.parseBoolean(options.get("font-italic"));
if(options.get("font-bold")!=null){this.fontBold=Boolean.parseBoolean(options.get("font-bold"));
if(options.get("font-size")!=null){try{this.fontSize=Float.parseFloat(options.get("font-size"));
if(options.get("font-color")!=null){try{this.fontColor=MapDecorationLayout.parseColor(options.get("font-color"));
if(fontColor==null){fontColor=Color.BLACK;
if(options.get("halo-radius")!=null){try{this.haloRadius=Float.parseFloat(options.get("halo-radius"));
if(options.get("halo-color")!=null){try{this.haloColor=MapDecorationLayout.parseColor(options.get("halo-color"));
if(haloRadius>0&&haloColor==null){haloColor=Color.WHITE;
if(fontFamily!=null){font=FontCache.getDefaultInstance().getFont(fontFamily);
if(font==null){LOGGER.log(Level.WARNING,"Font"+fontFamily+"notfound,fallingbackonthedefault");font=DEFAULT_FONT;
if(fontSize>0){font=font.deriveFont(fontSize);
if(fontItalic){font=font.deriveFont(Font.ITALIC);
if(fontBold){font=font.deriveFont(Font.BOLD);
if(value==null){Requestrequest=Dispatcher.REQUEST.get();
if(request!=null&&request.getRawKvp()!=null){Objectobj=request.getRawKvp().get(key);value=Converters.convert(obj,String.class);
if(obj!=null&&value==null){//tryalsoSpringconvertersasafallback,candosomething//GTconverters//cannotdo(e.garray->string).Didnotcreateabridgeto//GTconvertersasitmight//haveglobalconsequencesDefaultConversionService.getSharedInstance().convert(obj,String.class);
if(value!=null){returnnewStringModel(value,bw);
else{returnnull;
ifnecessary
if(haloRadius>0){g2d.setColor(haloColor);g2d.setStroke(newBasicStroke(2*haloRadius,BasicStroke.CAP_ROUND,BasicStroke.JOIN_ROUND));g2d.draw(outline);
ifdomainextractionforthisattributeis*notsupported*@throwsIOException*@see{@linkCatalogStoreCapabilities#getDomainQueriables(Name)}togetalistofthe*propertieswhichthestoresupportsthedomainextractionfrom*/CloseableIterator<String>getDomain(NametypeName,NameattributeName)throwsIOException;/***Addsanewrecordtothestore.Thismethodmightnotbesupported,see{@link*CatalogStoreCapabilities#supportsTransactions()}tocheck
ifthestoresupportstransactions**@paramf*@paramt*@throwsIOException*/List<FeatureId>addRecord(Featuref,Transactiont)throwsIOException;/***Removesrecordsfromthestore.Thismethodmightnotbesupported,see{@link*CatalogStoreCapabilities#supportsTransactions()}tocheck
ifthestoresupportstransactions**@paramf*@paramt*@throwsIOException*/voiddeleteRecord(Filterf,Transactiont)throwsIOException;/***Updatesrecordsinthestore.Thismethodmightnotbesupported,see{@link*CatalogStoreCapabilities#supportsTransactions()}tocheck
ifthestoresupportstransactions**@paramtypeName*@paramattributeNames*@paramattributeValues*@paramfilter*@paramt*@throwsIOException*/voidupdateRecord(NametypeName,Name[]attributeNames,Object[]attributeValues,Filterfilter,Transactiont)throwsIOException;/***Returnstherepositoryitemforthespecifiedrecordid,ornull
iftherepositoryitemis*notfound,ortheoperationisnotsupported**@paramrecordId*/RepositoryItemgetRepositoryItem(StringrecordId)throwsIOException;/**Returnsthestorecapabilities*/CatalogStoreCapabilitiesgetCapabilities();/**Mapsaqualifiednametoit'sequivalentpropertynameforthebackendstore.*/PropertyNametranslateProperty(RecordDescriptorrd,Namename);}
if(System.getProperty("testDatabase")!=null){//whenrunonline,gml:idisprefixedwithtablenameassertXpathEvaluatesTo("GEOLOGICUNIT.4","//gsml:GeologicUnit/@gml:id",doc);
else{assertXpathEvaluatesTo("4","//gsml:GeologicUnit/@gml:id",doc);
ifthedirectorydoesnotexistit*willbecreated.**@returndirectory(created
ifneeded)*/publicFilefindOrCreateDir(String...location)throwsIOException{returnget(Paths.path(location)).dir();
ifthefiledoesnotexistnullis*returned.*/publicFilefindFile(String...location)throwsIOException{Resourceresource=get(Paths.path(location));returnResources.find(resource);
ifthedirectorydoes*exist,nullisreturned.**<p>Thisdirectoryiscalled'data',andislocateddirectlyunder{@link#root()}*/publicFilefindDataRoot()throwsIOException{Resourcedirectory=get("data");returnResources.directory(directory);
ifthedirectorydoes*notexistitwillbecreated.**<p>Thisdirectoryiscalled'data',andislocateddirectlyunder{@link#root()}*/publicFilefindOrCreateDataRoot()throwsIOException{Resourcedirectory=get("data");returndirectory.dir();//willcreatedirectoryasneeded
ifthedirectorydoesnotexist*nullwillbereturned.*/publicFilefindDataDir(String...location)throwsIOException{Resourceresource=get(Paths.path("data",Paths.path(location)));returnResources.directory(resource);
ifthedirectorydoesnotexist*itwillbecreated.*/publicFilefindOrCreateDataDir(String...location)throwsIOException{Resourceresource=get(Paths.path("data",Paths.path(location)));returnresource.dir();
ifneeded*@paramlocationdirectorylocation*@returnDirectory(whichmaybenewlycreated)ornull
ifnotfound*@deprecatedUnused*/privateFiledataDir(booleancreate,String...location)throwsIOException{Resourcedirectory=get(Paths.path("data",Paths.path(location)));
if(create){returndirectory.dir();
else{returnResources.directory(directory);
ifthefiledoesnotexistnullis*returned.*/publicFilefindDataFile(String...location)throwsIOException{Resourceresource=get(Paths.path("data",Paths.path(location)));returnResources.file(resource);
ifthefiledoesnotexistitafile*objectwillstillbereturned.**@deprecatedUnused*/publicFilefindOrResolveDataFile(String...location)throwsIOException{Resourceresource=get(Paths.path("data",Paths.path(location)));returnresource.file();
ifneeded)ornull
ifnotfound*@deprecatedUnused*/privateFiledataFile(booleancreate,String...location)throwsIOException{Resourceresource=get(Paths.path("data",Paths.path(location)));
if(create){returnresource.file();
else{returnResources.file(resource);
ifthe*directorydoesexist,nullisreturned.**<p>Thisdirectoryiscalled'security',andislocateddirectlyunder{@link#root()}**@deprecatedAsofGeoServer2.6,replacedby@link{@link#getSecurity()}*/@DeprecatedpublicFilefindSecurityRoot()throwsIOException{returnResources.directory(getSecurity());
ifthe*directorydoesexistitiscreated.**<p>Thisdirectoryiscalled'security',andislocateddirectlyunder{@link#root()}**@deprecatedAsofGeoServer2.6,replacedby@link{@link#getSecurity()}*/@DeprecatedpublicFilefindOrCreateSecurityRoot()throwsIOException{returngetSecurity().dir();//willcreatedirectoryasneeded
if(create){f=directory.dir();
else{f=Resources.directory(directory);
ifthedirectorydoesnot*existnullwillbereturned.**@deprecatedAsofGeoServer2.6,replacedby@link{@link#getSecurity()}*/@DeprecatedpublicFilefindSecurityDir(String...location)throwsIOException{returnResources.directory(getSecurity(location));
ifthedirectorydoesnot*existitwillbecreated.**@deprecatedAsofGeoServer2.6,replacedby@link{@link#getSecurity()}*/@DeprecatedpublicFilefindOrCreateSecurityDir(String...location)throwsIOException{returngetSecurity(location).dir();
ifthedirectorydoesnotexistnullis*returned.**@deprecatedAsofGeoServer2.6,replacedby@link{@link#get(WorkspaceInfo)}*/@DeprecatedpublicFilefindWorkspaceDir(WorkspaceInfows)throwsIOException{Resourcedirectory=get(ws);returnResources.directory(directory);
ifthedirectorydoesnotexistitwillbe*created.**@paramcreateIfsettotruethedirectorywillbecreatedwhenitdoesnotexist.*@deprecatedAsofGeoServer2.6,replacedby{@link#get(WorkspaceInfo,String...)}*/@DeprecatedpublicFilefindOrCreateWorkspaceDir(WorkspaceInfows)throwsIOException{Resourcedirectory=get(ws);returndirectory.dir();
ifthefiledoesnotexistnull*isreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#config(WorkspaceInfo)}*/@DeprecatedpublicFilefindWorkspaceFile(WorkspaceInfows)throwsIOException{ResourceworkspaceFile=config(ws);returnResources.file(workspaceFile);
ifthefiledoesnotexistafile*objectwillstillbereturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#config(WorkspaceInfo)}*/@DeprecatedpublicFilefindOrResolveWorkspaceFile(WorkspaceInfows)throwsIOException{ResourceworkspaceFile=config(ws);returnworkspaceFile.file();
ifthefiledoesnotexistnull*isreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(WorkspaceInfo,String...)}*/@DeprecatedpublicFilefindSuppWorkspaceFile(WorkspaceInfows,Stringfilename)throwsIOException{Resourceresource=get(ws,filename);returnResources.file(resource);
ifthefiledoesnot*existnullisreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#getWorkspaces(String...)}*/@DeprecatedpublicFilefindSuppWorkspacesFile(WorkspaceInfows,Stringfilename)throwsIOException{Resourceresource=getWorkspaces(filename);returnResources.file(resource);
ifthedirectorydoesnot*existsnullisreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(StoreInfo,String...)}*/@DeprecatedpublicFilefindStoreDir(StoreInfostore)throwsIOException{Resourcedirectory=get(store);returnResources.directory(directory);
ifthedirectorydoesnot*existitiscreated.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(StoreInfo,String...)}*/@DeprecatedpublicFilefindOrCreateStoreDir(StoreInfostore)throwsIOException{Resourceresource=get(store);returnresource.dir();
ifthefiledoesnotexistnullis*returned.**@deprecatedAsofGeoServer2.6,replacedby{@link#config(DataStoreInfo)},{@link*#config(CoverageStoreInfo)},and{@link#config(WMSStoreInfo)}*/@DeprecatedpublicFilefindStoreFile(StoreInfostore)throwsIOException{Resourceresource=config(store);returnResources.file(resource);
ifthefiledoesnotexistafile*objectisstillreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(StoreInfo,String...)}*/@DeprecatedpublicFilefindOrResolveStoreFile(StoreInfostore)throwsIOException{Resourceresource=get(store);returnresource.file();
ifthefiledoesnotexistnullis*returned.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(StoreInfo,String...)}*/@DeprecatedpublicFilefindSuppStoreFile(StoreInfostore,Stringfilename)throwsIOException{Resourceresource=get(store,filename);returnResources.file(resource);
ifthedirectorydoes*notexistnullisreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(ResourceInfo,String...)}*/@DeprecatedpublicFilefindResourceDir(ResourceInforesource)throwsIOException{Resourcedirectory=get(resource);returnResources.directory(directory);
ifitcouldnotbefound.*/publicFilefindLegacyResourceDir(ResourceInforesource)throwsIOException{StoreInfostore=resource.getStore();Stringdirname=store.getName()+"_"+resource.getName();Filedir=null;
if(resourceinstanceofFeatureTypeInfo){dir=resourceLoader.find("featureTypes",dirname);
else
if(resourceinstanceofCoverageInfo){dir=resourceLoader.find("coverages",dirname);
ifthedirectorydoes*notexistitwillbecreated.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(ResourceInfo,String...)}*/publicFilefindOrCreateResourceDir(ResourceInfor)throwsIOException{Resourcedirectory=get(r);returndirectory.dir();
ifthefiledoesnotexistnullis*returned.**@deprecatedAsofGeoServer2.6,replacedby{@link#config(FeatureTypeInfo,String...)},*{@link#config(CoverageInfo,String...)},{@link#config(WMSLayerInfo,String...)}*/@DeprecatedpublicFilefindResourceFile(ResourceInfor)throwsIOException{Resourceresource=config(r);returnResources.file(resource);
ifthefiledoesnotexistafile*objectisstillreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#config(FeatureTypeInfo,String...)},*{@link#config(CoverageInfo,String...)},{@link#config(WMSLayerInfo,String...)}*/@DeprecatedpublicFilefindOrResolveResourceFile(ResourceInfor)throwsIOException{Resourceresource=config(r);returnresource.file();
ifthefiledoesnotexistnullis*returned.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(ResourceInfo,String...)}*/@DeprecatedpublicFilefindSuppResourceFile(ResourceInfor,Stringfilename)throwsIOException{Resourceresource=get(r,filename);returnResources.file(resource);
if(rdir!=null){Filefile=newFile(rdir,filename);returnfile.exists()?file:null;
else{returnnull;
ifthefiledoesnotexistnull*isreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(WorkspaceInfo,String...)}*/@DeprecatedpublicFilefindNamespaceFile(WorkspaceInfows)throwsIOException{Resourcedirectory=get(ws);returnResources.directory(directory);
ifthefiledoesnotexistafile*objectisstillreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(WorkspaceInfo,String...)}*/@DeprecatedpublicFilefindOrResolveNamespaceFile(WorkspaceInfows)throwsIOException{Resourcedirectory=get(ws);returndirectory.dir();
ifthefiledoesnotexistnullis*returned.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(LayerInfo,String...)}*/@DeprecatedpublicFilefindLayerFile(LayerInfolayer)throwsIOException{Resourceresource=get(layer);returnResources.file(resource);
ifthefiledoesnotexistafile*objectisstillreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(LayerInfo,String...)}*/publicFilefindOrResolveLayerFile(LayerInfolayer)throwsIOException{Resourceresource=get(layer);returnresource.file();
ifthedirectorydoesnotexist*nullisreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(StyleInfo,String...)}*/publicFilefindStyleDir()throwsIOException{Resourcestyles=get(STYLE_DIR);returnResources.directory(styles);
ifthedirectorydoesnotexist*itwillbecreated.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(StyleInfo,String...)}*/publicFilefindOrCreateStyleDir()throwsIOException{Resourcestyles=get(STYLE_DIR);returnstyles.dir();
ifneeded*@paramstyleInfo*@throwsIOException*@deprecatedAsofGeoServer2.6,replacedby{@link#get(StyleInfo,String...)}*/FilestyleDir(booleancreate,StyleInfostyleInfo)throwsIOException{Resourcestyles=get(styleInfo);returnResources.directory(styles,create);
ifworkspace*notprovided).**<p>Packagevisibilityfor{@linkGeoServerConfigPersister}.**@paramcreateCreatedirectory
ifrequired*@paramworkspaceInfoWorkspaceusedtoaccessstylesdirectory*@returnstylesdirectory*@throwsIOException*@deprecatedAsofGeoServer2.6,replacedby{@link#get(StyleInfo,String...)}*/FilestyleDir(booleancreate,WorkspaceInfoworkspaceInfo)throwsIOException{Resourcestyles=get(workspaceInfo,STYLE_DIR);returnResources.directory(styles,create);
ifthefiledoesnotexistnullis*returned.**@deprecatedAsofGeoServer2.6,replacedby{@link#config(StyleInfo,String...)}*/publicFilefindStyleFile(StyleInfos)throwsIOException{Resourceresource=config(s);returnResources.file(resource);
ifthefiledoesnotexistnullisreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#style(StyleInfo,String...)}*/publicFilefindStyleSldFile(StyleInfos)throwsIOException{Resourceresource=style(s);returnResources.file(resource);
ifthefiledoesnotexistafile*objectisstillreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#config(StyleInfo,String...)}*/publicFilefindOrCreateStyleFile(StyleInfos)throwsIOException{Resourceresource=config(s);returnresource.file();
ifthefiledoesnotexistafileobjectis*stillreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#style(StyleInfo,String...)}*/publicFilefindOrCreateStyleSldFile(StyleInfos)throwsIOException{Resourceresource=style(s);returnresource.file();
if(ws==null){r=get(Paths.path(path));
else{r=getWorkspaces(ws.getName(),Paths.path(path));
if(ns==null){r=get(Paths.path(path));
else{r=getWorkspaces(ns.getPrefix(),Paths.path(path));
if(siinstanceofDataStoreInfo){r=config((DataStoreInfo)si);
else
if(siinstanceofCoverageStoreInfo){r=config((CoverageStoreInfo)si);
else
if(siinstanceofWMTSStoreInfo){r=config((WMTSStoreInfo)si);
else
if(siinstanceofWMSStoreInfo){r=config((WMSStoreInfo)si);
else{//It'dbenice
ifwecouldbegenericandcoverpotentialfutureStoreInfotypes.thrownewIllegalArgumentException("OnlyDataStoreInfo,CoverageStoreInfo,andWMS/WMTSStoreInfoaresupported.");
if(siinstanceofFeatureTypeInfo){r=config((FeatureTypeInfo)si);
else
if(siinstanceofCoverageInfo){r=config((CoverageInfo)si);
else
if(siinstanceofWMTSLayerInfo){r=config((WMTSLayerInfo)si);
else
if(siinstanceofWMSLayerInfo){r=config((WMSLayerInfo)si);
else{//It'dbenice
ifwecouldbegenericandcoverpotentialfutureResourceInfotypes.thrownewIllegalArgumentException("OnlyFeatureTypeInfo,CoverageInfo,andWMS/WMTSLayerInfoaresupported.");
if(l.getResource()instanceofFeatureTypeInfo){r=get(l.getResource(),path);
else
if(l.getResource()instanceofCoverageInfo){r=get(l.getResource(),path);
else
if(l.getResource()instanceofWMTSLayerInfo){r=get(l.getResource(),path);
else
if(l.getResource()instanceofWMSLayerInfo){r=get(l.getResource(),path);
else{//It'dbenice
ifwecouldbegenericandcoverpotentialfutureResourceInfotypes.thrownewIllegalArgumentException("OnlyFeatureTypeInfo,CoverageInfo,andWMS/WMTSLayerInfoaresupported.");
ifthefilename(minusthesuffix)matchestheidofthestyle//andthesuffixisxml(ratherthansld)weneedtoavoidoverwrittingtheactual//stylefilefinalStringfilename;
if(s.getFilename()!=null&&s.getFilename().endsWith(".xml")&&s.getFilename().startsWith(s.getName()+".")){//appendasecond.xmlsuffixfilename=s.getName()+".xml.xml";
else{filename=s.getName()+".xml";
if(styleResource.getType()==Type.UNDEFINED){thrownewFileNotFoundException("Nosuchresource:"+s.getFilename());
if(styleResource.getType()==Type.UNDEFINED){thrownewIOException("Nosuchresource:"+s.getFilename());
if(url!=null&&url.getProtocol().equalsIgnoreCase("resource")){Resourceresource=resourceLoader.fromURL(url);Filefile;
if(Resources.exists(resource)){//GEOS-7741:cacheresourceasfile,otherwiseitcan'tbefoundfile=resource.file();
else{//GEOS-7025:Justgetthepath;don'ttrytocreatethefilefile=Paths.toFile(root(),resource.path());
if(url.getQuery()!=null){try{u=newURL(u.toString()+"?"+url.getQuery());
if(url.getRef()!=null){try{u=newURL(u.toString()+"#"+url.getRef());
else{returnurl;
if(relativeUrl.getProtocol().equalsIgnoreCase("resource")){returnrelativeUrl;
else{returnsuper.validateRelativeURL(relativeUrl);
if(provider!=null){resolver=provider.getEntityResolver();
ifthedirectorydoesnot*existnullisreturned.**@deprecatedAsofGeoServer2.6,replacedby{@link#get(LayerGroupInfo,String...)}*/publicFilefindLayerGroupDir()throwsIOException{Resourceresource=getLayerGroups();returnResources.directory(resource);
if(exgr.getOnlineResource()==null){return;
if(r!=null&&r.getType()!=Type.UNDEFINED){resources.add(r);
if(cs.getGrayChannel()!=null){cs.getGrayChannel().accept(this);
if(ch!=null)ch.accept(this);
if(!file.getPath().contains("${")){//guardagainstsituationsinwhichbracesareusedbutnotforCQLtemplatesreturnurl;
else{try{returnnewURL(url.toExternalForm().replace("%7B","{").replace("%7D","}"));
ifnotexistsFileServicefileService=fileServices.get(FILE_SERVICE);
if(!fileService.checkFileExists(FILE_LOCATION)){fileService.create(FILE_LOCATION,TestData.class.getResource("world.tiff").openStream());
if(root.exists())FileUtils.deleteDirectory(root);child=newFile(root,"child");child.mkdirs();one=newFile(child,"one.txt");one.createNewFile();two=newFile(child,"two.sld");two.createNewFile();
if(!metadata.containsKey(NetCDFSettingsContainer.NETCDFOUT_KEY)){metadata.put(NetCDFSettingsContainer.NETCDFOUT_KEY,newNetCDFLayerSettingsContainer());
if(called.get()){fail("Inputgotretrievedtwice");
ifLayerGroupmustbehidden,falseotherwise*/booleanhideLayerGroup(LayerGroupInfogroup,List<PublishedInfo>filteredLayers);/**NeverhideaLayerGroup*/publicstaticfinalLayerGroupVisibilityPolicyHIDE_NEVER=newLayerGroupVisibilityPolicy(){@OverridepublicbooleanhideLayerGroup(LayerGroupInfogroup,List<PublishedInfo>filteredLayers){returnfalse;
ifitdoesn'tcontainLayersor
ifitsLayersareallhidden*/publicstaticfinalLayerGroupVisibilityPolicyHIDE_EMPTY=newLayerGroupVisibilityPolicy(){@OverridepublicbooleanhideLayerGroup(LayerGroupInfogroup,List<PublishedInfo>filteredLayers){returnfilteredLayers.size()==0;
ifitsLayersareallhidden*/publicstaticfinalLayerGroupVisibilityPolicyHIDE_IF_ALL_HIDDEN=newLayerGroupVisibilityPolicy(){@OverridepublicbooleanhideLayerGroup(LayerGroupInfogroup,List<PublishedInfo>filteredLayers){returnfilteredLayers.size()==0&&group.getLayers().size()>0;
ifthenamebelongstotheIsInstanceOfNAME,otherwisenull//isreturned
if(IsInstanceOf.NAME.getFunctionName().equals(name)){returnnewIsInstanceOf(args,fallback);
iffeaturecount>0**@authorArneKepp*@authorGabrielRoldan*@version$Id$*/publicclassGWCTransactionListenerimplementsTransactionCallback{privatestaticLoggerlog=Logging.getLogger(GWCTransactionListener.class);privatefinalGWCgwc;staticfinalStringGWC_TRANSACTION_INFO_PLACEHOLDER="GWC_TRANSACTION_INFO_PLACEHOLDER";/**@paramgwc*/publicGWCTransactionListener(finalGWCgwc){this.gwc=gwc;
if(!committed){return;
if(byLayerDirtyRegions.isEmpty()){return;
if(dirtyRegion==null){continue;
if(dirtyList.size()==0){returnnull;
if(envinstanceofReferencedEnvelope3D){env=newReferencedEnvelope(env,CRS.getHorizontalCRS(env.getCoordinateReferenceSystem()));
if(!(sourceinstanceofInsertElementType||sourceinstanceofUpdateElementType||sourceinstanceofDeleteElementType)){return;
if(TransactionEventType.POST_INSERT.equals(type)){//noneedtocomputethebounds,they'rethesamethanforPRE_INSERTreturn;
if(affectedTileLayers.isEmpty()){//eventdidn'ttouchacachedlayerreturn;
if(byLayerDirtyRegions==null){byLayerDirtyRegions=newHashMap<String,List<ReferencedEnvelope>>();extendedProperties.put(GWC_TRANSACTION_INFO_PLACEHOLDER,byLayerDirtyRegions);
if(layerDirtyRegion==null){layerDirtyRegion=newArrayList<ReferencedEnvelope>(2);byLayerDirtyRegions.put(tileLayerName,layerDirtyRegion);
if(ds==null){thrownewSQLException(jndiName+"notfoundinJNDIcontext.");
if(schema!=null){try(Connectionconn=ds.getConnection()){conn.createStatement().executeQuery("SELECTset_config('search_path','"+schema+",public',false);");
if(table!=null){Stringschema=SqlUtil.schema(table.getTableName());
if(schema!=null){((GSPostGISDatastoreEncoder)encoder).setSchema(schema);
if(isDirty())getStream().close();
if(isDirty())getStream().flush();
if(myStream!=null)returnmyStream;Stringtype=myResponse.getContentType();//
if(type==null){//logger.warning("Mimetypewasnotsetbeforefirstwrite!");//
if(type!=null&&isCompressible(type)){logger.log(Level.FINE,"Compressingoutputformimetype:{0}",type);myResponse.addHeader("Content-Encoding","gzip");myStream=newGZIPResponseStream(myResponse);
else{logger.log(Level.FINE,"Notcompressingoutputformimetype:{0}",type);
if(contentLength>=0){myResponse.setContentLength(contentLength);
if(matcher.matches())returntrue;
if(firstSemicolon!=-1){returnmimetype.substring(0,firstSemicolon);
if(blobstore!=null){blobstore.setChanged(gwcConfig,false);
if(null==imageIOFileCachingThreshold||0L>=imageIOFileCachingThreshold.longValue()){StringwarningMsg=newResourceModel("GWC.ImageIOFileCachingThresholdUnsetWarning").getObject();super.warn(warningMsg);
if(null!=titleKey){AttributeModifierattributeModifier=newAttributeModifier("title",newStringResourceModel(titleKey,(Component)null,null));checkBox.add(attributeModifier);
if(style!=null){//theteststyleexistssolet'sremoveitcatalog.remove(style);
if(style!=null){//theteststyleexistssolet'sremoveitcatalog.remove(style);
ifthenewaddedstylewascorrectlypublishedassertThat(messages.size(),is(2));//checkingthatthecorrectstylefilewaspublishedList<DocumentFile>styleFile=getMessagesForHandler(messages,CATALOG_STYLES_FILE_EVENT_HANDLER_KEY,styleFileHandler);assertThat(styleFile.size(),is(1));assertThat(styleFile.get(0).getResourceName(),is("test_style.sld"));//checkingthatthecorrectstylewaspublishedList<CatalogEvent>styleAddEvent=getMessagesForHandler(messages,CATALOG_ADD_EVENT_HANDLER_KEY,addEventHandler);assertThat(styleAddEvent.size(),is(1));assertThat(styleAddEvent.get(0).getSource(),instanceOf(StyleInfo.class));StyleInfostyleInfo=(StyleInfo)styleAddEvent.get(0).getSource();assertThat(styleInfo.getName(),is(TEST_STYLE_NAME));assertThat(styleInfo.getWorkspace(),nullValue());
ifthenewaddedstylewascorrectlypublishedassertThat(messages.size(),is(2));//checkingthatthecorrectstylefilewaspublishedList<DocumentFile>styleFile=getMessagesForHandler(messages,CATALOG_STYLES_FILE_EVENT_HANDLER_KEY,styleFileHandler);assertThat(styleFile.size(),is(1));assertThat(styleFile.get(0).getResourceName(),is("test_style.sld"));//checkingthatthecorrectstylewaspublishedList<CatalogEvent>styleAddEvent=getMessagesForHandler(messages,CATALOG_ADD_EVENT_HANDLER_KEY,addEventHandler);assertThat(styleAddEvent.size(),is(1));assertThat(styleAddEvent.get(0).getSource(),instanceOf(StyleInfo.class));StyleInfostyleInfo=(StyleInfo)styleAddEvent.get(0).getSource();assertThat(styleInfo.getName(),is(TEST_STYLE_NAME));assertThat(styleInfo.getWorkspace(),is(testWorkspace));
if(candidatePropertyName!=null&&candidatePropertyName.equalsIgnoreCase(propertyName)){propertyValue=event.getNewValues().get(i);
if(dir.dir().exists()){FileUtils.forceDelete(dir.dir());
if(file.exists()){FileUtils.forceDelete(file);
if(in!=null){in.close();
if(out!=null){out.flush();out.close();
if(!DEFAULT_STYLEs.contains(styleName)){removeStyle(null,styleName);
if("JDBC".equals(config.getQuotaStore())){JDBCConfigurationencrypted=passwordHelper.encryptPassword(jdbcConfig);try(OutputStreamos=configFile.out()){JDBCConfiguration.store(encrypted,os);
else{
if(Resources.exists(configFile)&&!configFile.delete()){LOGGER.log(Level.SEVERE,"Failedtodelete"+configFile+",thismightcausemisbehavioronGeoServerrestart");
if(!Resources.exists(configFile)){returnnull;
if(qs!=null){try{qs.close();
ifthepasswordencoderchanged,sowecheck
iftheencryptedpwdchanged//(unfortunatelysomepasswordencoderschangetheencryptedpasswordeverytimetheyare//called...)try{JDBCConfigurationconfig=getJDBCDiskQuotaConfig();
if(config!=null){ResourceconfigFile=configDir.get("geowebcache-diskquota-jdbc.xml");
if(!Resources.exists(configFile)){return;
if(c1==null||c1.getConnectionPool()==null){return;
if(originalEncrypted==null){return;
if(!originalEncrypted.equals(newEncrypted)){try(OutputStreamos=configFile.out()){JDBCConfiguration.store(c3,os);
ifthispropertyisnull,GeoServerAbstractTestSupport.oneTimeSetUp()//willblowawayourchangesSystem.setProperty("org.geotools.referencing.forceXY","false");//yes,weneedthistooHints.putSystemDefault(Hints.FORCE_LONGITUDE_FIRST_AXIS_ORDER,false);//
ifthisissettoanythingbut"http",GeoServerAbstractTestSupport.oneTimeSetUp()//willblowawayourchangesHints.putSystemDefault(Hints.FORCE_AXIS_ORDER_HONORING,"http");//applychangesCRS.reset("all");super.setUpTestData(testData);
if(type==URLType.SERVICE&&stripRemainingPath(path.toString()).equalsIgnoreCase(ows)){
if(LocalWorkspace.get()!=null){path.insert(0,LocalWorkspace.get().getName()+"/");
if(LocalPublished.get()!=null){inti=LocalWorkspace.get().getName().length()+1;path.insert(i,LocalPublished.get().getName()+"/");
if(obj==null){thrownewRuntimeException("No'app'functiondefined");
if(!(objinstanceofPyObject)){thrownewRuntimeException("'appnotcallable,founda"+obj.toString());
if(ret!=null){StringcontentType=wr.headers.get("content-type");
if(contentType==null){contentType="text/plain";
if(retinstanceofPyString){response.getWriter().write(ret.toString());
else
if(retinstanceofPyList){finalPyListlist=(PyList)ret;for(Iteratori=list.iterator();i.hasNext();){response.getWriter().write(i.next().toString());
if(i.hasNext()){response.getWriter().write('\n');
else
if(retinstanceofPyIterator){finalPyIteratoriter=(PyIterator)ret;for(Iteratori=iter.iterator();i.hasNext();){response.getWriter().write(i.next().toString());response.getWriter().write('\n');
else
if(retinstanceofPyObjectDerived){finalPyObjectDerivediter=(PyObjectDerived)ret;PyObjectnext=null;while((next=iter.__iternext__())!=null){response.getWriter().write(next.toString());response.getWriter().write('\n');
else{LOGGER.warning("Unsurehowtohandle"+ret+".Resortingtooutputingstring"+"representation.");response.setContentType(contentType);response.getWriter().write(ret.toString());
iftheapplicationcorrespondstothe*"root"oftheserver.*PATH_INFO*TheremainderoftherequestURL's"path",designatingthevirtual*"location"oftherequest'stargetwithintheapplication.Thismaybe*anemptystring,
iftherequestURLtargetstheapplicationrootand*doesnothaveatrailingslash.*QUERY_STRING*TheportionoftherequestURLthatfollowsthe"?",
ifany.Maybe*emptyorabsent.*CONTENT_TYPE*ThecontentsofanyContent-TypefieldsintheHTTPrequest.Maybe*emptyorabsent.*CONTENT_LENGTH*ThecontentsofanyContent-LengthfieldsintheHTTPrequest.Maybe*emptyorabsent.*SERVER_NAME,SERVER_PORT*WhencombinedwithSCRIPT_NAMEandPATH_INFO,thesevariablescanbe*usedtocompletetheURL.Note,however,thatHTTP_HOST,
ifpresent,*shouldbeusedinpreferencetoSERVER_NAMEforreconstructingthe*requestURL.SeetheURLReconstructionsectionbelowformoredetail.*SERVER_NAMEandSERVER_PORTcanneverbeemptystrings,andsoare*alwaysrequired.*SERVER_PROTOCOL*Theversionoftheprotocoltheclientusedtosendtherequest.*Typicallythiswillbesomethinglike"HTTP/1.0"or"HTTP/1.1"andmay*beusedbytheapplicationtodeterminehowtotreatanyHTTPrequest*headers.(ThisvariableshouldprobablybecalledREQUEST_PROTOCOL,*sinceitdenotestheprotocolusedintherequest,andisnot*necessarilytheprotocolthatwillbeusedintheserver'sresponse.*However,forcompatibilitywithCGIwehavetokeeptheexistingname.)*HTTP_Variables*Variablescorrespondingtotheclient-suppliedHTTPrequestheaders*(i.e.,variableswhosenamesbeginwith"HTTP_").Thepresenceor*absenceofthesevariablesshouldcorrespondwiththepresenceor*absenceoftheappropriateHTTPheaderintherequest.*wsgi.version*Thetuple(1,0),representingWSGIversion1.0.**wsgi.url_scheme*Astringrepresentingthe"scheme"portionoftheURLatwhichtheapplication*isbeinginvoked.Normally,thiswillhavethevalue"http"or"https",as*appropriate.**wsgi.input*Aninputstream(file-likeobject)fromwhichtheHTTPrequestbodycanbe*read.(Theserverorgatewaymayperformreadson-demandasrequestedbythe*application,oritmaypre-readtheclient'srequestbodyandbufferit*in-memoryorondisk,oruseanyothertechniqueforprovidingsuchaninput*stream,accordingtoitspreference.)**wsgi.errors*Anoutputstream(file-likeobject)towhicherroroutputcanbewritten,for*thepurposeofrecordingprogramorothererrorsinastandardizedand*possiblycentralizedlocation.Thisshouldbea"textmode"stream;i.e.,*applicationsshoulduse"\n"asalineending,andassumethatitwillbe*convertedtothecorrectlineendingbytheserver/gateway.**Formanyservers,wsgi.errorswillbetheserver'smainerrorlog.*Alternatively,thismaybesys.stderr,oralogfileofsomesort.The*server'sdocumentationshouldincludeanexplanationofhowtoconfigurethis*orwheretofindtherecordedoutput.Aserverorgatewaymaysupplydifferent*errorstreamstodifferentapplications,
ifthisisdesired.**wsgi.multithread*Thisvalueshouldevaluatetrue
iftheapplicationobjectmaybe*simultaneouslyinvokedbyanotherthreadinthesameprocess,andshould*evaluatefalseotherwise.**wsgi.multiprocess*Thisvalueshouldevaluatetrue
ifanequivalentapplicationobjectmaybe*simultaneouslyinvokedbyanotherprocess,andshouldevaluatefalse*otherwise.**wsgi.run_once*Thisvalueshouldevaluatetrue
iftheserverorgatewayexpects(butdoesnot*guarantee!)thattheapplicationwillonlybeinvokedthisonetimeduringthe*lifeofitscontainingprocess.Normally,thiswillonlybetrueforagateway*basedonCGI(orsomethingsimilar).*</pre>**@paramrequest*@throwsIOException*/PyObjectcreateEnviron(HttpServletRequestrequest)throwsIOException{PyDictionaryenviron=newPyDictionary();environ.put("REQUEST_METHOD",request.getMethod().toString());environ.put("SCRIPT_NAME",request.getPathInfo().substring(request.getPathInfo().lastIndexOf("/")));//forcetopystringsothatframeworksdon'ttrytoencodeasidnaenviron.put("SERVER_NAME",newPyString(request.getServerName()));environ.put("SERVER_PORT",String.valueOf(request.getServerPort()));environ.put("PATH_INFO",request.getPathInfo());//environ.put("PATH_INFO",);environ.put("QUERY_STRING",request.getQueryString());environ.put("wsgi.version",newPyTuple(newPyInteger(0),newPyInteger(1)));environ.put("wsgi.url_scheme",request.getScheme());environ.put("wsgi.input",newPyFile(request.getInputStream()));environ.put("wsgi.errors",newPyFile(System.err));environ.put("wsgi.multithread",true);environ.put("wsgi.multitprocess",false);environ.put("wsgi.run_once",false);returnenviron;
if(space!=-1){r.code=status.toString().substring(0,space);r.message=status.toString().substring(space+1);
else{r.code=status.toString();
if(objs.length>1){PyListheaders=(PyList)objs[1];for(Iteratori=headers.iterator();i.hasNext();){PyTupletup=(PyTuple)i.next();r.headers.put(tup.get(0).toString(),tup.get(1).toString());
if*{@link#isUseConnectionPooling()}is{@codetrue}.*/intgetMaxConnections();voidsetMaxConnections(intmaxConcurrentConnections);/**@returnnumberofsecondstowaitonreadbeforetimeout,defaultsto60*/intgetReadTimeout();/**@paramtimeoutSecondssecondstowaitbeforetimingoutareadrequest*/voidsetReadTimeout(inttimeoutSeconds);/**@returnsecondstowaitforconnectrequestsbeforetimingout,defaultsto30*/intgetConnectTimeout();/**@paramsecondstowaitforconnectrequestsbeforetimingout*/voidsetConnectTimeout(inttimeoutSeconds);/***@return{@codetrue}(default)
ifthestoreshalluseanhttpconnectionmanagedthatpools*connections,{@codefalse}otherwise.*@see#getMaxConnections()*/publicbooleanisUseConnectionPooling();/***@paramuseHttpConnectionPooling{@codetrue}
ifthestoreshalluseanhttpconnection*managedthatpoolsconnections,{@codefalse}otherwise.*@see#setMaxConnections(int)*/publicvoidsetUseConnectionPooling(booleanuseHttpConnectionPooling);}
ifwewereinproductionallthetime)System.setProperty("wicket.configuration","deployment");//makesurethatwechecktheenglishi18nwhenneededLocale.setDefault(Locale.ENGLISH);
if(args.size()<3||args.size()>4){thrownewIllegalArgumentException("QuerySinglefunctionrequires3or4arguments(featuretypequalifiedname,"+"cqlfilter,extractedattributenameandsortbyclause");
if(layerName==null){thrownewIllegalArgumentException("Thefirstargumentshouldbeavectorlayername");
if(ft==null){thrownewIllegalArgumentException("Couldnotfindvectorlayer"+layerName+"intheGeoServercatalog");
if(attribute==null){thrownewIllegalArgumentException("Thesecondargumentofthequery"+"functionshouldbetheattributename");
if(ad==null){thrownewIllegalArgumentException("Attribute"+attribute+"couldnotbefoundinlayer"+layerName);
else
if(adinstanceofGeometryDescriptor){crs=((GeometryDescriptor)ad).getCoordinateReferenceSystem();
if(crs==null){crs=ft.getCRS();
if(cql==null){thrownewIllegalArgumentException("Thethirdargumentofthequery"+"functionshouldbeavalid(E)CQLfilter");
ifwewentbeyondthelimitquery.setMaxFeatures(maxResults+1);FeatureSourcefs=ft.getFeatureSource(null,null);fi=fs.getFeatures(query).features();List<Object>results=newArrayList<Object>(maxResults);while(fi.hasNext()){Featuref=fi.next();Objectvalue=f.getProperty(attribute).getValue();
if(valueinstanceofGeometry&&crs!=null){//
ifthecrsisnotassociatedwiththegeometrydoso,this//wayothercodewillgettoknowthecrs(e.g.forreprojectionpurposes)Geometrygeom=(Geometry)value;geom.apply(newGeometryCRSFilter(crs));
if(results.size()==0){returnnull;
if(maxResults>0&&results.size()>maxResults&&!single){thrownewIllegalStateException("Thequeryin"+getName()+"returnstoomany"+"features,thelimitis"+maxResults);
if(maxResults==1){returnresults.get(0);
else{returnresults;
if(fi!=null){fi.close();
ifthe*URLdoesnothaveaquerystring.*/privateStringqueryString;/**ThebodyoftherequestinthecaseofaPUTorPOST*/privatebyte[]body;/**ThelengthoftherequestbodyintehcaseofaPUTorPOST*/privatelongbodyContentLength;/**Themimetypeoftherequestbody*/privateStringbodyContentType;/**TheHTTPmethodoftherequest*/privateStringhttpMethod;/***TherequeststarttimestampintheServer'slocaltime(asper{@link*System#currentTimeMillis()})*/privateDatestartTime;/***TherequestendtimestampintheServer'slocaltime(asper{@link*System#currentTimeMillis()})*/privateDateendTime;/**Thetotaltime,inmilliseconds,therequesttooktocomplete*/privatelongtotalTime;/**TheInternetProtocol(IP)addressoftheclientorlastproxythatsenttherequest.*/privateStringremoteAddr;/***Thefullyqualifiednameoftheclientorthelastproxythatsenttherequest.Iftheengine*cannotorchoosesnottoresolvethehostname(toimproveperformance),thethedotted-string*formoftheIPaddress.*/privateStringremoteHost;/**Username(ifavailable)specifiedwiththerequest*/privateStringremoteUser;/**Remoteuseragent(user-agentheaderfromrequest)*/privateStringremoteUserAgent;/**Countryrequestoriginatedfrom(ifavailable),obtainedviageoiplookup.*/privateStringremoteCountry;/**Cityrequestoriginatedfrom(ifavailable),obtainedviageoiplookup*/privateStringremoteCity;/**Latituderequestoriginatedfrom(ifavailable),obtainedviageoiplookup*/privatedoubleremoteLat;/**Longituderequestoriginatedfrom(ifavailable),obtainedviageoiplookup*/privatedoubleremoteLon;/**Theserverhost(usefulincasewearedealingwithaclusterofGeoServerinstances)*/privateStringhost;/**Theinternalserverhost(totheinternalnetwork)*/privateStringinternalHost;/**Theservicename,inthecaseofowsthisisWMS,WFS,WCS,WPS,etc...*/privateStringservice;/**Theoperationname,suchasGetMap,GetFeature,etc...*/privateStringoperation;/**TheOWSserviceversion,specifictoowsrequests*/privateStringowsVersion;/**Thesuboperation,exampleforWFStransactionbeingINSERT,UPDATE,etc...*/privateStringsubOperation;/**Therequestedresources*/privateList<String>resources=newArrayList<String>(1);/**TheHTTPresponselength,inbytes*/privatelongresponseLength;/**TheresponsecontentMIMEtype,mightbe{@codenull}*/privateStringresponseContentType;/**The{@linkServiceException}message,or{@codenull}*/privateStringerrorMessage;/**Theexceptionthatoccurredwhileprocessingtherequest,
ifany.*/privateThrowableerror;/**Theresponsestatus*/IntegerresponseStatus;/**TheRefereroftheHTTPrequest,
ifany*/privateStringhttpReferer;/**Aboundingboxfortheregiontherequestcovers
ifany(Maybeapproximate)*/privateBoundingBoxbbox;/***Whethertherequesthitormissthecacheforcache-ableprotocols(GWC,directintegration)*/privateStringcacheResult;/**Iftherewasacachemiss,thereasonforit*/privateStringmissReason;publiclonggetId(){returnid;
if(body!=null){returnnewString(body);
else{returnnull;
if(resources!=null&&resources.size()>0){Stringresult=resources.toString();returnresult.substring(1,result.length()-1);
else{returnnull;
if(reader==null){returnreader;
else{return(GridCoverage2DReader)SecuredObjects.secure(reader,policy);
if(reader==null){returnreader;
else{return(GridCoverage2DReader)SecuredObjects.secure(reader,policy);
if(policy.response==Response.CHALLENGE){returnSecureCatalogImpl.unauthorizedAccess();
elsereturnnewUnsupportedOperationException("Thisdataaccessisreadonly,servicecodeissupposedtoperformwritesviaFeatureStoreinstead");}}
if(ni.getName()!=null&&ni.getName().startsWith("vmnet")){//skippingvmwareinterfacescontinue;
if(!inetAddr.isLoopbackAddress()&&!(inetAddrinstanceofInet6Address)){
if(inetAddr.isSiteLocalAddress()){returninetAddr;
else
if(candidateAddress==null){candidateAddress=inetAddr;
if(candidateAddress!=null){returncandidateAddress;
if(jdkSuppliedAddress==null){thrownewUnknownHostException("TheJDKInetAddress.getLocalHost()methodunexpectedlyreturnednull.");
if(authentication!=null){this.userName=authentication.getName();
if(phase!=null&&phase.isExecutionCompleted()//
ifthereisalreadyacompletionTimedon'toverwriteit!&&this.completionTime==null){this.completionTime=newDate();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;ExecutionStatusother=(ExecutionStatus)obj;
if(asynchronous!=other.asynchronous)returnfalse;
if(completionTime==null){
if(other.completionTime!=null){returnfalse;
else
if(!completionTime.equals(other.completionTime))returnfalse;
if(creationTime==null){
if(other.creationTime!=null)returnfalse;
else
if(!creationTime.equals(other.creationTime))returnfalse;
if(executionId==null){
if(other.executionId!=null)returnfalse;
else
if(!executionId.equals(other.executionId))returnfalse;
if(lastUpdated==null){
if(other.lastUpdated!=null)returnfalse;
else
if(!lastUpdated.equals(other.lastUpdated))returnfalse;
if(nodeId==null){
if(other.nodeId!=null)returnfalse;
else
if(!nodeId.equals(other.nodeId))returnfalse;
if(phase!=other.phase)returnfalse;
if(processName==null){
if(other.processName!=null)returnfalse;
else
if(!processName.equals(other.processName))returnfalse;
if(Float.floatToIntBits(progress)!=Float.floatToIntBits(other.progress))returnfalse;
if(task==null){
if(other.task!=null)returnfalse;
else
if(!task.equals(other.task))returnfalse;
if(userName==null){
if(other.userName!=null)returnfalse;
else
if(!userName.equals(other.userName))returnfalse;returntrue;}}
if(myOutputStream==null)myOutputStream=newCapturingByteOutputStream();returnmyOutputStream;
if(adapteeinstanceofFeatureCollectionType){returnnewWFS11((EObject)adaptee);
else
if(adapteeinstanceofnet.opengis.wfs20.FeatureCollectionType){returnnewWFS20((EObject)adaptee);
if(target.equals(FeatureCollectionType.class)){returnadaptee;
else
if(target.equals(net.opengis.wfs20.FeatureCollectionType.class)){FeatureCollectionTypesource=(FeatureCollectionType)adaptee;net.opengis.wfs20.FeatureCollectionTyperesult=Wfs20Factory.eINSTANCE.createFeatureCollectionType();result.getMember().addAll(source.getFeature());result.setNumberReturned(source.getNumberOfFeatures());result.setLockId(source.getLockId());result.setTimeStamp(source.getTimeStamp());returnresult;
else{thrownewWFSException("Cannottransform"+adaptee+"tothespecifiedtargetclass"+target);
if(target.equals(net.opengis.wfs20.FeatureCollectionType.class)){returnadaptee;
else
if(target.equals(FeatureCollectionType.class)){net.opengis.wfs20.FeatureCollectionTypesource=(net.opengis.wfs20.FeatureCollectionType)adaptee;FeatureCollectionTyperesult=WfsFactory.eINSTANCE.createFeatureCollectionType();result.getFeature().addAll(source.getMember());result.setNumberOfFeatures(source.getNumberReturned());result.setLockId(source.getLockId());result.setTimeStamp(source.getTimeStamp());returnresult;
else{thrownewWFSException("Cannottransform"+adaptee+"tothespecifiedtargetclass"+target);
if(arrays!=null){SoftReference<?>arrayRef;while((arrayRef=arrays.poll())!=null){Objectarray=arrayRef.get();
if(array!=null){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.log(Level.FINER,"Recyclingtilehitontype:{1},banks:{2},arrayLength:{3}",newObject[]{arrayType,numBanks,arrayLength});
if(LOGGER.isLoggable(Level.FINER)){LOGGER.log(Level.FINER,"Recyclingtilemissontype:{1},banks:{2},arrayLength:{3}",newObject[]{arrayType,numBanks,arrayLength});
if(LOGGER.isLoggable(Level.FINER)){LOGGER.log(Level.FINER,"Recyclingtilehitontype:{1},banks:{2},arrayLength:{3}",newObject[]{db.getDataType(),db.getNumBanks(),db.getSize()});
if(arrays==null){arrays=newConcurrentLinkedQueue<SoftReference<?>>();arrays.add(getBankReference(db));put(key,arrays);return;
else{arrays.add(getBankReference(db));
if(sampleModel==null){thrownewNullPointerException("sampleModelcannotbenull");
if(location==null){location=newPoint(0,0);
if(sampleModelinstanceofComponentSampleModel){ComponentSampleModelcsm=(ComponentSampleModel)sampleModel;numBanks=getNumBanksCSM(csm);size=getBufferSizeCSM(csm);
else
if(sampleModelinstanceofMultiPixelPackedSampleModel){MultiPixelPackedSampleModelmppsm=(MultiPixelPackedSampleModel)sampleModel;numBanks=1;intdataTypeSize=DataBuffer.getDataTypeSize(type);size=mppsm.getScanlineStride()*mppsm.getHeight()+(mppsm.getDataBitOffset()+dataTypeSize-1)/dataTypeSize;
else
if(sampleModelinstanceofSinglePixelPackedSampleModel){SinglePixelPackedSampleModelsppsm=(SinglePixelPackedSampleModel)sampleModel;numBanks=1;size=sppsm.getScanlineStride()*(sppsm.getHeight()-1)+sppsm.getWidth();
if(size>0){//trytobuildanewdatabufferstartingfromObjectarray=recycledArrays.getRecycledArray(type,numBanks,size);
if(array!=null){
switch(type){caseDataBuffer.TYPE_BYTE:{byte[][]bankData=(byte[][])array;for(inti=0;i<numBanks;i++){Arrays.fill(bankData[i],(byte)0);
if(db==null){db=sampleModel.createDataBuffer();
if(maxBandOff>=0)size+=maxBandOff+1;intpixelStride=csm.getPixelStride();
if(pixelStride>0)size+=pixelStride*(csm.getWidth()-1);intscanlineStride=csm.getScanlineStride();
if(scanlineStride>0)size+=scanlineStride*(csm.getHeight()-1);returnsize;
if(bankIndex>maxIndex){maxIndex=bankIndex;
if(tile.getWidth()!=tile.getHeight()||tile.getWidth()>512){return;
if(this.getXp()==null){setXp(this.xstream.getXStream());
if(iteminstanceofWorkspaceInfo){getCatalog().add((WorkspaceInfo)item);
else
if(iteminstanceofNamespaceInfo){getCatalog().add((NamespaceInfo)item);
else
if(iteminstanceofDataStoreInfo){getCatalog().add((DataStoreInfo)item);
else
if(iteminstanceofCoverageStoreInfo){getCatalog().add((CoverageStoreInfo)item);
else
if(iteminstanceofResourceInfo){getCatalog().add((ResourceInfo)item);
else
if(iteminstanceofLayerInfo){getCatalog().add((LayerInfo)item);
else
if(iteminstanceofStyleInfo){getCatalog().add((StyleInfo)item);
else
if(iteminstanceofLayerGroupInfo){getCatalog().add((LayerGroupInfo)item);
if(propertyNames.contains("lockProviderName")){lockProviderName=(String)newValues.get(propertyNames.indexOf("lockProviderName"));reload=true;
if(reload){try{setLockProvider(lockProviderName);
if(lockProviderName==null){//forbackwardscompatibilitydelegate=newNullLockProvider();
else{Objectprovider=GeoServerExtensions.bean(lockProviderName);
if(provider==null){thrownewIllegalStateException("Couldnotfind"+lockProviderName+"lockproviderinspringapplicationcontext");
else
if(!(providerinstanceofLockProvider)){thrownewIllegalStateException("Found"+lockProviderName+"("+provider.getClass().getName()+")inapplicationcontext,butitwasnotaLockProvider");
if(lockProvider.getDelegate()!=delegate){lockProvider.setDelegate(delegate);
if(pf==null){thrownewIllegalArgumentException("Failedtolocatetheprocessfactory"+factoryClass);
if(property.getName().equals("enabled")){Fragmentfragment=newFragment(id,"enabledFragment",ProcessSelectionPage.this);CheckBoxenabled=newCheckBox("enabled",(IModel<Boolean>)property.getModel(itemModel));enabled.setOutputMarkupId(true);fragment.add(enabled);returnfragment;
else
if(property.getName().equals("title")){returnnewLabel(id,property.getModel(itemModel));
else
if(property.getName().equals("description")){returnnewLabel(id,property.getModel(itemModel));
else
if(property.getName().equals("roles")){Fragmentfragment=newFragment(id,"rolesFragment",ProcessSelectionPage.this);TextArea<?>roles=newTextArea("roles",property.getModel(itemModel)){public<CextendsObject>org.apache.wicket.util.convert.IConverter<C>getConverter(java.lang.Class<C>type){returnnewRolesConverter(availableRoles);};};StringBuilderselectedRoles=newStringBuilder();IAutoCompleteRenderer<String>roleRenderer=newRolesRenderer(selectedRoles);AutoCompleteBehavior<String>b=newRolesAutoCompleteBehavior(roleRenderer,settings,selectedRoles,availableRoles);roles.setOutputMarkupId(true);roles.add(b);fragment.add(roles);returnfragment;
else
if(property.getName().equals("validated")){finalIModel<Boolean>hasValidatorsModel=(IModel<Boolean>)property.getModel(itemModel);IModel<String>availableModel=newAbstractReadOnlyModel<String>(){@OverridepublicStringgetObject(){Booleanvalue=hasValidatorsModel.getObject();
if(Boolean.TRUE.equals(value)){return"*";
else{return"";
else
if(property.getName().equals("edit")){Fragmentfragment=newFragment(id,"linkFragment",ProcessSelectionPage.this);//weuseasubmitlinktoavoidlosingtheothereditsintheformLinklink=newLink("link"){@OverridepublicvoidonClick(){FilteredProcessfp=(FilteredProcess)itemModel.getObject();setResponsePage(newProcessLimitsPage(ProcessSelectionPage.this,fp));
if((process.getRoles()!=null&&!process.getRoles().isEmpty())||!process.getEnabled()||(process.getValidators()!=null&&!process.getValidators().isEmpty())){ProcessInfopai=process.toProcessInfo();pfi.getFilteredProcesses().add(pai);
if(availableCoverages==null){availableCoverages=newArrayList<String>();
if(numBands==1){//simplesyntaxforsimplecaseavailableCoverages.add(coverage);
else{for(inti=0;i<numBands;i++){availableCoverages.add(coverage+CoverageView.BAND_SEPARATOR+i);
if(coverageName!=null){newCoverage=false;//grabthecoverageviewcoverageViewInfo=coverageInfo!=null?coverageInfo:catalog.getResourceByStore(store,coverageName,CoverageInfo.class);CoverageViewcoverageView=coverageViewInfo.getMetadata().get(CoverageView.COVERAGE_VIEW,CoverageView.class);//thetypecanbestillnotsaved
if(coverageViewInfo!=null){coverageInfoId=coverageViewInfo.getId();
if(coverageView==null){thrownewIllegalArgumentException("Thespecifiedcoveragedoesnothaveacoverageviewattachedtoit");
else{outputBands=newArrayList<CoverageBand>();newCoverage=true;coverageViewInfo=null;envelopeCompositionType=EnvelopeCompositionType.INTERSECTION;selectedResolution=SelectedResolution.BEST;
if(resolutionReferenceCoverage!=null){finalintreferenceCoverageIndex=getReferenceCoverageIndex();view.setSelectedResolutionIndex(referenceCoverageIndex);
if(this.resolutionReferenceCoverage.equals(band.getInputCoverageBands().get(0).getCoverageName())){returni;
if(t==null){break;
if(t==null){returnoriginal.getMessage();
else{returnt.getMessage();
if(currvc!=null){
if(coverageInfoId==null||!coverageInfoId.equals(curr.getId())){
if(currvc.getName().equals(vcName)&&newCoverage){Map<String,Object>map=newHashMap<>();map.put("name",vcName);map.put("coverageName",curr.getName());IValidationErrorerr=newValidationError("duplicateCoverageViewName").addKey("duplicateCoverageViewName").setVariables(map);validatable.error(err);return;
if(query!=null){request.setQueryString(query);String[]kvps=query.split("&");for(Stringkvp:kvps){String[]tmp=kvp.split("=");request.addParameter(tmp[0],tmp[1]);
if(httpsServer==null){httpsServer=createAndStartHttpsServer();td.checkSSLServer();
if(headerName==null&&headerValue==null){//Nomoreheadersbreak;
if(name.equalsIgnoreCase(headerName)){returnheaderValue;
if(i==0){request.addParameter(GeoServerCasAuthenticationEntryPoint.CAS_REDIRECT,"false");request.setQueryString(request.getQueryString()+"&ticket="+proxyTicket+"&"+GeoServerCasAuthenticationEntryPoint.CAS_REDIRECT+"=false");
else{request.addHeader(GeoServerCasAuthenticationEntryPoint.CAS_REDIRECT,"false");request.setQueryString(request.getQueryString()+"&ticket="+proxyTicket);
if(i==0){request.addParameter(GeoServerCasAuthenticationEntryPoint.CAS_REDIRECT,"false");request.setQueryString(request.getQueryString()+"&ticket="+proxyTicket+"&"+GeoServerCasAuthenticationEntryPoint.CAS_REDIRECT+"=false");
else{request.addHeader(GeoServerCasAuthenticationEntryPoint.CAS_REDIRECT,"false");request.setQueryString(request.getQueryString()+"&ticket="+proxyTicket);
if(dependentValues.size()>0){fileService=fileServices.get(dependentValues.get(0));
else{fileService=null;
if(dependentValues.size()>0&&dependentValues.get(0)!=null){fileService=fileServices.get(dependentValues.get(0));
else{fileService=null;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;UniqueResourceIdentifierother=(UniqueResourceIdentifier)obj;
if(code==null){
if(other.code!=null)returnfalse;
else
if(!code.equals(other.code))returnfalse;
if(metadataURL==null){
if(other.metadataURL!=null)returnfalse;
else
if(!metadataURL.equals(other.metadataURL))returnfalse;
if(namespace==null){
if(other.namespace!=null)returnfalse;
else
if(!namespace.equals(other.namespace))returnfalse;returntrue;
switchtothemilitaryuser,thatshouldseeeverythinginsteadassertTrue(canAccess(manager,milUser,namedTreeA,AccessMode.READ));assertTrue(canAccess(manager,milUser,statesLayer,AccessMode.READ));assertTrue(canAccess(manager,milUser,roadsLayer,AccessMode.READ));assertTrue(canAccess(manager,milUser,containerTreeB,AccessMode.READ));assertTrue(canAccess(manager,milUser,nestedContainerE,AccessMode.READ));assertTrue(canAccess(manager,milUser,forestsLayer,AccessMode.READ));assertTrue(canAccess(manager,milUser,singleGroupC,AccessMode.READ));
switchtothemilitaryuser,thatshouldseeeverythinginsteadassertTrue(canAccess(manager,milUser,namedTreeA,AccessMode.READ));assertTrue(canAccess(manager,milUser,statesLayer,AccessMode.READ));assertTrue(canAccess(manager,milUser,roadsLayer,AccessMode.READ));assertTrue(canAccess(manager,milUser,containerTreeB,AccessMode.READ));assertTrue(canAccess(manager,milUser,singleGroupC,AccessMode.READ));
switchtothemilitaryuser,thatshouldseeeverythinginsteadassertTrue(canAccess(manager,milUser,namedTreeA,AccessMode.READ));assertTrue(canAccess(manager,milUser,statesLayer,AccessMode.READ));assertTrue(canAccess(manager,milUser,roadsLayer,AccessMode.READ));assertTrue(canAccess(manager,milUser,containerTreeB,AccessMode.READ));assertTrue(canAccess(manager,milUser,singleGroupC,AccessMode.READ));assertTrue(canAccess(manager,milUser,wsContainerD,AccessMode.READ));assertTrue(canAccess(manager,milUser,arcGridLayer,AccessMode.READ));
if(limits==null){returntrue;
else
if(mode==AccessMode.READ){returnlimits.getReadFilter()!=Filter.EXCLUDE;
else
if(mode==AccessMode.WRITE){
if(limitsinstanceofVectorAccessLimits){return((VectorAccessLimits)limits).getWriteFilter()!=Filter.EXCLUDE;
else{returnfalse;
else{thrownewRuntimeException("Unknownaccessmode"+mode);
if(limits==null){returntrue;
else
if(mode==AccessMode.READ){returnlimits.isReadable();
else
if(mode==AccessMode.WRITE){returnlimits.isWritable();
else
if(mode==AccessMode.ADMIN){returnlimits.isAdminable();
else{thrownewRuntimeException("Unknownaccessmode"+mode);
ifabsent.*/protectedvoidconfigureFixture(){
if(fixture==null){StringfixtureId=getDatabaseID();
if(fixtureId==null){return;//notavailable(turntestoff)
if(profile!=null&&!"".equals(profile)){base=newFile(base,profile);
if(exists==null||exists.booleanValue()){
if(fixtureFile.exists()){fixture=GSFixtureUtilitiesDelegate.loadProperties(fixtureFile);found.put(fixtureFile.getCanonicalPath(),true);System.setProperty("app-schema.properties",fixtureFile.getPath());
else{//nofixturefile,
ifnoprofilewasspecifiedwriteoutatemplate//fixtureusingtheofflinefixtureproperties
if(profile==null){PropertiesexampleFixture=createExampleFixture();
if(exampleFixture!=null){FileexFixtureFile=newFile(fixtureFile.getAbsolutePath()+".example");
if(!exFixtureFile.exists()){createExampleFixture(exFixtureFile,exampleFixture);
if(fixture==null&&exists==null){//onlyreport
ifexists==nullsinceitmeansthatthisis//thefirsttimetryingtoloadthefixtureGSFixtureUtilitiesDelegate.printSkipNotice(fixtureId,fixtureFile);
if(replaceNewLine){run(input);
else{super.run(input);
if(crs!=null){try{srid=CRS.lookupEpsgCode(crs,true);
if(String.class.isAssignableFrom(scopeAsObject.getClass())){StringscopeAsString=(String)scopeAsObject;Collections.addAll(scope,scopeAsString.split(""));
else
if(Collection.class.isAssignableFrom(scopeAsObject.getClass())){Collection<String>scopes=(Collection<String>)scopeAsObject;scope.addAll(scopes);
if(namespaces.length%2!=0){thrownewRuntimeException("Invalidnumberofnamespacesprovided.");
if(testRootDirectory==null){//initthetestdirectorytestRootDirectory=createTestRootDirectory();
if(baseURL==null){thrownewNullPointerException("serverBaseUrl");
ifitisthrownby<code>super.createTransformer()</code>*/publicTransformercreateTransformer()throwsTransformerException{Transformertransformer=super.createTransformer();StringdtdUrl=buildSchemaURL(baseURL,"wms/1.1.1/WMS_DescribeLayerResponse.dtd");transformer.setOutputProperty(OutputKeys.DOCTYPE_SYSTEM,dtdUrl);returntransformer;
iftheObjectisnotencodeable.*/publicvoidencode(Objecto)throwsIllegalArgumentException{
if(!(oinstanceofDescribeLayerRequest)){thrownewIllegalArgumentException();
if(requestVersion==null){thrownewNullPointerException("requestVersion");
if(MapLayerInfo.TYPE_VECTOR==layer.getType()){owsUrl=buildURL(baseURL,"wfs",null,URLType.SERVICE);owsUrl=appendQueryString(owsUrl,"");owsType="WFS";layerAtts.addAttribute("","wfs","wfs","",owsUrl);
else
if(MapLayerInfo.TYPE_RASTER==layer.getType()){owsUrl=buildURL(baseURL,"wcs",null,URLType.SERVICE);owsUrl=appendQueryString(owsUrl,"");owsType="WCS";
else{//nonvectornorrasterlayer,LayerDescriptionwillnotcontainthese//attributesowsUrl=owsType=null;
if(owsType!=null&&owsUrl!=null){//thelayerisdescribableonly
ifitsvectororrasterbased//inourcasethatmeanddirectlyassociatedtoaresourceInfo(ie,nobase//map)layerAtts.addAttribute("","owsURL","owsURL","",owsUrl);layerAtts.addAttribute("","owsType","owsType","",owsType);
if(ex!=null){for(DispatcherCallbackcallback:callbacks){callback.exception(request,response,ex);
if(getType()==BackupExecutionAdapter.class){returnnewArrayList<AbstractExecutionAdapter>(BackupRestoreWebUtils.backupFacade().getBackupExecutions().values());
else
if(getType()==RestoreExecutionAdapter.class){returnnewArrayList<AbstractExecutionAdapter>(BackupRestoreWebUtils.backupFacade().getRestoreExecutions().values());
if(user.getAuthorities()!=null){for(GrantedAuthorityauthority:user.getAuthorities()){finalStringuserRole=authority.getAuthority();
if(ROOT_ROLE.equals(userRole)||GeoServerRole.ADMIN_ROLE.getAuthority().equals(userRole)){returntrue;
if((user!=null)&&!(userinstanceofAnonymousAuthenticationToken)){//shortcut,
iftheuseristheadmin,hecandoeverything
if(isAdmin(user)){LOGGER.log(Level.FINE,"Adminlevelaccess,returning"+"fullrightsforworkspace{0}",workspace.getName());returnnewWorkspaceAccessLimits(DEFAULT_CATALOG_MODE,true,true);
if(sourceAddress!=null){ruleFilter.setSourceAddress(sourceAddress);
else{LOGGER.log(Level.WARNING,"NosourceIPaddressfound");ruleFilter.setSourceAddress(RuleFilter.SpecialFilterType.DEFAULT);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"AdminAuthfilter:{0}",ruleFilter);
if(http==null){LOGGER.log(Level.WARNING,"NoHTTPconnectionavailable.");returnnull;
if(forwardedFor!=null){String[]ips=forwardedFor.split(",");returnInetAddress.getByName(ips[0]).getHostAddress();
else{returnhttp.getRemoteAddr();
if(owsRequest!=null){HttpServletRequesthttpReq=owsRequest.getHttpRequest();StringsourceAddress=getSourceAddress(httpReq);
if(sourceAddress==null){LOGGER.log(Level.WARNING,"CouldnotretrievesourceaddressfromOWSRequest");
if(sourceAddress==null){LOGGER.log(Level.WARNING,"CouldnotretrievesourceaddresswithSpringRequest");
if(rule==null){//returnnewWorkspaceAccessLimits(DEFAULT_CATALOG_MODE,true,true);//
else{//returnnewWorkspaceAccessLimits(DEFAULT_CATALOG_MODE,rule.getGrant()==GrantType.ALLOW,//rule.getGrant()==GrantType.ALLOW);//
if((user!=null)&&!(userinstanceofAnonymousAuthenticationToken)){//shortcut,
iftheuseristheadmin,hecandoeverything
if(isAdmin(user)){LOGGER.log(Level.FINE,"Adminlevelaccess,returning"+"fullrightsforlayer{0}",resource.getPrefixedName());returnbuildAccessLimits(resource,AccessInfo.ALLOW_ALL);
if(owsRequest!=null){service=owsRequest.getService();request=owsRequest.getRequest();
if(service!=null){
if("*".equals(service)){ruleFilter.setService(RuleFilter.SpecialFilterType.ANY);
else{ruleFilter.setService(service);
else{ruleFilter.setService(RuleFilter.SpecialFilterType.DEFAULT);
if(request!=null){
if("*".equals(request)){ruleFilter.setRequest(RuleFilter.SpecialFilterType.ANY);
else{ruleFilter.setRequest(request);
else{ruleFilter.setRequest(RuleFilter.SpecialFilterType.DEFAULT);
if(sourceAddress!=null){ruleFilter.setSourceAddress(sourceAddress);
else{LOGGER.log(Level.WARNING,"NosourceIPaddressfound");ruleFilter.setSourceAddress(RuleFilter.SpecialFilterType.DEFAULT);
if(rule==null){rule=AccessInfo.DENY_ALL;
if(user!=null){GeoFenceConfigurationconfig=configurationManager.getConfiguration();
if(config.isUseRolesToFilter()&&config.getRoles().size()>0){Stringrole="UNKNOWN";for(GrantedAuthorityauthority:user.getAuthorities()){
if(config.getRoles().contains(authority.getAuthority())){role=authority.getAuthority();
else{Stringusername=user.getName();
if(username==null){ruleFilter.setUser(RuleFilter.SpecialFilterType.DEFAULT);
else{LOGGER.log(Level.FINE,"Settinguserforfilter:{0}",newObject[]{username});ruleFilter.setUser(username);
else{ruleFilter.setUser(RuleFilter.SpecialFilterType.DEFAULT);
if(rule.getCqlFilterRead()!=null){readFilter=ECQL.toFilter(rule.getCqlFilterRead());
if(rule.getCqlFilterWrite()!=null){writeFilter=ECQL.toFilter(rule.getCqlFilterWrite());
ifnecessaryGeometryarea=null;StringareaWkt=rule.getAreaWkt();
if(areaWkt!=null){try{//Geometryarea=rule.getArea();WKTReaderwktReader=newWKTReader();area=wktReader.read(areaWkt);
if(area!=null){//ruleareaisalwaysexpressedas4326CoordinateReferenceSystemgeomCrs=CRS.decode("EPSG:4326");CoordinateReferenceSystemresourceCrs=resource.getCRS();
if((resourceCrs!=null)&&!CRS.equalsIgnoreMetadata(geomCrs,resourceCrs)){MathTransformmt=CRS.findMathTransform(geomCrs,resourceCrs,true);area=JTS.transform(area,mt);
if(rule.getCatalogMode()!=null){
switch(rule.getCatalogMode()){caseCHALLENGE:catalogMode=CatalogMode.CHALLENGE;break;caseHIDE:catalogMode=CatalogMode.HIDE;break;caseMIXED:catalogMode=CatalogMode.MIXED;break;
if(resourceinstanceofFeatureTypeInfo){//mergetheareaamongthefilters
if(area!=null){FilterareaFilter=FF.intersects(FF.property(""),FF.literal(area));readFilter=mergeFilter(readFilter,areaFilter);writeFilter=mergeFilter(writeFilter,areaFilter);
else
if(resourceinstanceofCoverageInfo){MultiPolygonrasterFilter=buildRasterFilter(rule);returnnewCoverageAccessLimits(catalogMode,readFilter,rasterFilter,null);
else
if(resourceinstanceofWMSLayerInfo){MultiPolygonrasterFilter=buildRasterFilter(rule);returnnewWMSAccessLimits(catalogMode,readFilter,rasterFilter,true);
else{thrownewIllegalArgumentException("Don'tknowhowtohandleresource"+resource);
if(rule.getAreaWkt()!=null){WKTReaderreader=newWKTReader();Geometryarea=null;try{area=reader.read(rule.getAreaWkt());
if(rasterFilter==null){thrownewRuntimeException("Errorapplyingsecurityrules,cannotconvert"+"theGeofencearearestriction"+rule.getAreaWkt()+"toamulti-polygon");
if((filter==null)||(filter==Filter.INCLUDE)){returnareaFilter;
else
if(filter==Filter.EXCLUDE){returnfilter;
else{returnFF.and(filter,areaFilter);
if(attributes==null||attributes.isEmpty()){returnnull;
if((attribute.getAccess()==AccessType.READWRITE)||((mode==PropertyAccessMode.READ)&&(attribute.getAccess()==AccessType.READONLY))){PropertyNameproperty=FF.property(attribute.getName());result.add(property);
if((user!=null)&&!(userinstanceofAnonymousAuthenticationToken)){//shortcut,
iftheuseristheadmin,hecandoeverything
if(isAdmin(user)){LOGGER.log(Level.FINE,"Adminlevelaccess,notapplyingdefaultstyleforthisrequest");returnoperation;
else{username=user.getName();
if((request!=null)&&"WMS".equalsIgnoreCase(service)&&("GetMap".equalsIgnoreCase(request)||"GetFeatureInfo".equalsIgnoreCase(request))){//extractthegetmappartObjectro=operation.getParameters()[0];GetMapRequestgetMap;
if(roinstanceofGetMapRequest){getMap=(GetMapRequest)ro;
else
if(roinstanceofGetFeatureInfoRequest){getMap=((GetFeatureInfoRequest)ro).getGetMapRequest();
else{thrownewServiceException("Unrecognizedrequestobject:"+ro);
else
if((request!=null)&&"WMS".equalsIgnoreCase(service)&&"GetLegendGraphic".equalsIgnoreCase(request)){overrideGetLegendGraphicRequest(gsRequest,operation,service,request,user);
if(candidateLayer==null){
if(layerName.indexOf(":")==-1){//addnamespaceinfotocandidatelayergroupname
if(LocalWorkspace.get()!=null){layerName=LocalWorkspace.get().getName()+":"+layerName;
else
if(catalog.getDefaultWorkspace()!=null){layerName=catalog.getDefaultWorkspace().getName()+":"+layerName;
if(layerGroup!=null){for(PublishedInfopublishedInfo:layerGroup.getLayers()){
if(publishedInfoinstanceofLayerInfo){layers.add((LayerInfo)publishedInfo);
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Skippingpublishable"+publishedInfo);
else{layers.add(candidateLayer);
if(styleName==null){
if(rule.getDefaultStyle()!=null){try{StyleInfosi=catalog.getStyleByName(rule.getDefaultStyle());
if(si==null){thrownewServiceException("Couldnotfinddefaultstylesuggested"+"byGeoRepository:"+rule.getDefaultStyle());
else{checkStyleAllowed(rule,styleName);
if(gsRequest.getKvp().get("layers")==null&&gsRequest.getKvp().get("sld")==null&&gsRequest.getKvp().get("sld_body")==null){thrownewServiceException("GetMapPOSTrequestsareforbidden");
ifacertainstylewasrequestedexplicitlyordefaulted,and//weneedtotellapartthedefaultcasefromtheexplicitrequestcaseList<String>styleNameList=getRequestedStyles(gsRequest,getMap);//applytheoverride/securitycheckforeachlayerintherequestList<MapLayerInfo>layers=getMap.getLayers();for(inti=0;i<layers.size();i++){MapLayerInfolayer=layers.get(i);ResourceInfoinfo=null;
if(layer.getType()==MapLayerInfo.TYPE_VECTOR||layer.getType()==MapLayerInfo.TYPE_RASTER){info=layer.getResource();
else
if(!configurationManager.getConfiguration().isAllowRemoteAndInlineLayers()){thrownewServiceException("Remotelayersarenotallowed");
if(info!=null){ruleFilter.setWorkspace(info.getStore().getWorkspace().getName());ruleFilter.setLayer(info.getName());
else{ruleFilter.setWorkspace(RuleFilter.SpecialFilterType.ANY);ruleFilter.setLayer(RuleFilter.SpecialFilterType.ANY);
ifdefaultusegeofencedefault
if(styleName!=null){checkStyleAllowed(rule,styleName);
else
if((rule.getDefaultStyle()!=null)){try{StyleInfosi=catalog.getStyleByName(rule.getDefaultStyle());
if(si==null){thrownewServiceException("Couldnotfinddefaultstylesuggested"+"byGeofence:"+rule.getDefaultStyle());
iftherequestedstyleisallowedSet<String>allowedStyles=newHashSet<String>();
if(rule.getDefaultStyle()!=null){allowedStyles.add(rule.getDefaultStyle());
if(rule.getAllowedStyles()!=null){allowedStyles.addAll(rule.getAllowedStyles());
if((allowedStyles.size()>0)&&!allowedStyles.contains(styleName)){thrownewServiceException("The'"+styleName+"'styleisnotavailableonthislayer");
if(layerinstanceofLayerGroupInfo){//aLayerGroupdon'thavestylessowejustaddnullfor(inti=0;i<((LayerGroupInfo)layer).getLayers().size();i++){requestedStyles.add(null);
else{//thelayerisaLayerInfoorMapLayerInfo(ifitisaremotelayer)
if(styleIndex>=parsedStyles.size()){requestedStyles.add(null);
else{requestedStyles.add(parsedStyles.get(styleIndex));
if(rawLayersParameter!=null){List<String>layersNames=KvpUtils.readFlat(rawLayersParameter);returnnewLayersParser().parseLayers(layersNames,getMap.getRemoteOwsURL(),getMap.getRemoteOwsType());
if(rawStylesParameter!=null){returnKvpUtils.readFlat(rawStylesParameter);
if(trkpt==null){trkpt=newArrayList<WptType>();
if(getPriority()!=null){rule.setPriority(getPriority());
if(getPriority()!=null){rule.setPriority(getPriority());
if(getAccess()!=null){rule.setAccess(AdminGrantType.valueOf(getAccess()));
if(getUserName()!=null){rule.setUsername(convertAny(getUserName()));
if(getRoleName()!=null){rule.setRolename(convertAny(getRoleName()));
if(getAddressRange()!=null){rule.setAddressRange(newIPAddressRange(getAddressRange()));
if(getWorkspace()!=null){rule.setWorkspace(convertAny(getWorkspace()));
if(id!=null){rule.setId(id);
if("".equals(s)||"*".equals(s))returnnull;
elsereturns;}}
if(!logger.isLoggable(Level.INFO)){returninvocation.proceed();
if(invocation.getArguments().length>0){ObjectrequestBean=null;for(inti=0;i<invocation.getArguments().length;i++){Objectargument=(Object)invocation.getArguments()[i];
if(isRequestObject(argument)){requestBean=(Object)argument;break;
if(requestBean!=null){log(requestBean,1,log);
ifanobjectistherequestobject.**<p>Subclassesshouldoverridethistodoexplictchecksfortherequestobject.*/protectedbooleanisRequestObject(Objectobj){returntrue;
if("class".equalsIgnoreCase(prop))continue;Objectvalue=OwsUtils.get(object,prop);log.append("\n");for(inti=0;i<level;i++)log.append("\t");log.append(prop).append("=").append(value);
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(J2EERoleSource.J2EE.equals(rs)){container.addOrReplace(newRoleServicePanel("panel"));
else{super.addRoleSourceDropDown(container,rs);
if(J2EERoleSource.J2EE.equals(model)){returnnewRoleServicePanel("panel");
else{returnsuper.getRoleSourcePanel(model);
if(encodedEntries.isEmpty()){pw.println("\"\"");
else{pw.println("\"\",");for(Iterator<UTFGridEntry>it=encodedEntries.iterator();it.hasNext();){UTFGridEntryentry=(UTFGridEntry)it.next();pw.print("\"");pw.print(entry.getKey());
if(it.hasNext()){pw.println("\",");
else{pw.println("\"");
if(it.hasNext()){pw.println(",");
if(featureinstanceofSimpleFeature){SimpleFeaturesf=(SimpleFeature)feature;for(AttributeDescriptorad:sf.getFeatureType().getAttributeDescriptors()){
if(adinstanceofGeometryDescriptor){continue;
else{Stringname=ad.getLocalName();Objectvalue=sf.getAttribute(name);addAttribute(builder,name,value);
else{for(Propertyp:feature.getProperties()){
if(p.getType()instanceofGeometryPropertyType){continue;
if(valueinstanceofjava.util.Date||valueinstanceofCalendar){value=Converters.convert(value,String.class);
if(pixel==0){pw.print("");
else{UTFGridEntryentry=keyToFeature.get(pixel);
if(entry==null){thrownewRuntimeException("Couldnotfindentryforpixelvalue"+pixel+".Thisnormallymeansthereissomecoloralteringoptionatwork"+"thattheUTFGridcodefailedtoremove,likeopacity,blendingandthelike");
if(entryKey==-1){entryKey=key++;entry.setKey(entryKey);result.add(entry);
if(r<height-1){pw.println("\",");
else{pw.println("\"");
if(imageinstanceofBufferedImage){//copy-lessversionofdataaccessreturn((BufferedImage)image).getRaster();
else{returnimage.getData();
if(result>=34){result++;
if(result>=92){result++;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;SQLViewAttributeother=(SQLViewAttribute)obj;
if(name==null){
if(other.name!=null)returnfalse;
else
if(!name.equals(other.name))returnfalse;
if(pk!=other.pk)returnfalse;
if(srid==null){
if(other.srid!=null)returnfalse;
else
if(!srid.equals(other.srid))returnfalse;
if(type==null){
if(other.type!=null)returnfalse;
else
if(!type.equals(other.type))returnfalse;returntrue;
if(groupsinstanceofRangedClassifier)
if(open)returnopenRangedRules((RangedClassifier)groups,property,propertyType,normalize);
elsereturnclosedRangedRules((RangedClassifier)groups,property,propertyType,normalize);
else
if(groupsinstanceofExplicitClassifier)returnthis.explicitRules((ExplicitClassifier)groups,property,propertyType);
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,"FailedtobuildQuantileClassification"+e.getLocalizedMessage(),e);
if(groupsinstanceofRangedClassifier)
if(open)returnopenRangedRules((RangedClassifier)groups,property,propertyType,normalize);
elsereturnclosedRangedRules((RangedClassifier)groups,property,propertyType,normalize);
else
if(groupsinstanceofExplicitClassifier)returnthis.explicitRules((ExplicitClassifier)groups,property,propertyType);
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,"FailedtobuildEqualIntervalClassification"+e.getLocalizedMessage(),e);
if(groupsinstanceofRangedClassifier)returnthis.closedRangedRules((RangedClassifier)groups,property,propertyType,normalize);
else
if(groupsinstanceofExplicitClassifier){ExplicitClassifierexplicitGroups=(ExplicitClassifier)groups;
if(intervals>0&&explicitGroups.getSize()>intervals){thrownewIllegalArgumentException("Intervals:"+explicitGroups.getSize());
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,"FailedtobuildUniqueIntervalClassification"+e.getLocalizedMessage(),e);
if(einstanceofIllegalArgumentException){throw(IllegalArgumentException)e;
if(reverseColors){fillRamp.revert();
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,"FailedtobuildpolygonSymbolizer"+e.getLocalizedMessage(),e);
if(reverseColors){fillRamp.revert();
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,"FailedtobuildpolygonSymbolizer"+e.getLocalizedMessage(),e);
if(reverseColors){fillRamp.revert();
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,"FailedtobuildLineSymbolizer"+e.getLocalizedMessage(),e);
if(groups.getMin(0).equals(groups.getMax(0))){f=ff.equals(att,ff.literal(groups.getMax(0)));r.setFilter(f);r.setTitle(ff.literal(groups.getMax(0)).toString());list.add(r);
else{f=ff.lessOrEqual(att,ff.literal(groups.getMax(0)));r.setFilter(f);r.setTitle("<="+ff.literal(groups.getMax(0)));list.add(r);
if(groups.getMin(i).equals(groups.getMax(i))){f=ff.equals(att,ff.literal(groups.getMax(i)));r.setTitle(ff.literal(groups.getMin(i)).toString());r.setFilter(f);list.add(r);
else{f=ff.and(ff.greater(att,ff.literal(groups.getMin(i))),ff.lessOrEqual(att,ff.literal(groups.getMax(i))));r.setTitle(">"+ff.literal(groups.getMin(i))+"AND<="+ff.literal(groups.getMax(i)));r.setFilter(f);list.add(r);
if(groups.getMin(groups.getSize()-1).equals(groups.getMax(groups.getSize()-1))){f=ff.equals(att,ff.literal(groups.getMin(groups.getSize()-1)));r.setFilter(f);r.setTitle(ff.literal(groups.getMin(groups.getSize()-1)).toString());list.add(r);
else{f=ff.greater(att,ff.literal(groups.getMin(groups.getSize()-1)));r.setFilter(f);r.setTitle(">"+ff.literal(groups.getMin(groups.getSize()-1)));list.add(r);
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,"FailedtobuildOpenRangedrules"+e.getLocalizedMessage(),e);
if(normalize&&(Integer.class.isAssignableFrom(propertyType)||Long.class.isAssignableFrom(propertyType))){returnff.function("parseDouble",property);
if(i>0&&groups.getMax(i).equals(groups.getMax(i-1)))continue;
if(groups.getMin(i).equals(groups.getMax(i))){f=ff.equals(att,ff.literal(groups.getMin(i)));r.setTitle(ff.literal(groups.getMin(i)).toString());r.setFilter(f);list.add(r);
else{f=ff.and(i==0?ff.greaterOrEqual(att,ff.literal(groups.getMin(i))):ff.greater(att,ff.literal(groups.getMin(i))),ff.lessOrEqual(att,ff.literal(groups.getMax(i))));r.setTitle(">"+ff.literal(groups.getMin(i))+"AND<="+ff.literal(groups.getMax(i)));r.setFilter(f);list.add(r);
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,"FailedtobuildclosedRangedRules"+e.getLocalizedMessage(),e);
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,"FailedtobuildexplicitRules"+e.getLocalizedMessage(),e);
if(groupsinstanceofRangedClassifier)
if(open)returnopenRangedRules((RangedClassifier)groups,property,propertyType,normalize);
elsereturnclosedRangedRules((RangedClassifier)groups,property,propertyType,normalize);
else
if(groupsinstanceofExplicitClassifier)returnthis.explicitRules((ExplicitClassifier)groups,property,propertyType);
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,"FailedtobuildJenksclassification"+e.getLocalizedMessage(),e);
if((key!=null)&&keyinstanceofString){return((String)key).toUpperCase();
if(coverage!=null){coverage.dispose(true);
if(coverage!=null){coverage.dispose(true);
if(coverage!=null){coverage.dispose(true);
if(coverage!=null){coverage.dispose(true);
if(coverage!=null){coverage.dispose(true);
ifsuchis*thecase,thismethodshallreturnthemodeltobepassedtothe{@link*PublishedEditTabPanel}constructor.**<p>Thisdefaultimplementationjustreturns{@codenull}andassumesthe{@link*PublishedEditTabPanel}describedbythistabpanelinfoworksagainstthe{@link*ResourceConfigurationPage}LayerInfomodel.Subclassesmayoverrideasappropriate.**@parammodel*@paramisNew*@return{@codenull}
ifnoneedforacustommodelforthetab,themodeltouseotherwise*@seePublishedEditTabPanel#save()*/publicIModel<?>createOwnModel(IModel<?extendsT>model,booleanisNew){returnnull;
if(p!=null){this.x=p.getX();this.y=p.getY();
if(x!=null&&y!=null){setConvertedInput(gf.createPoint(newCoordinate(x,y)));
else{setConvertedInput(null);
if(idinstanceofFeatureId){FeatureIdfid=(FeatureId)id;
if(fid.getID()!=null){String[]split=fid.getID().split("\\.");
if(split.length>1){ResourceInfor=catalog.getResourceByName(split[0],ResourceInfo.class);
if(r!=null){typeNames.add(newQName(r.getNamespace().getURI(),r.getName()));
ifset.**@authorGabrielRoldan*/publicclassCachingExtendedCapabilitiesProviderimplementsExtendedCapabilitiesProvider{privatefinalGWCgwc;publicCachingExtendedCapabilitiesProvider(finalGWCgwc){this.gwc=gwc;
if(gwc.getConfig().isDirectWMSIntegrationEnabled()&&isTiled(request)){returnCollections.singletonList("TileSet*");
if(gwc.getConfig().isDirectWMSIntegrationEnabled()&&isTiled(request)){List<String>wmscElements=newArrayList<String>();wmscElements.add("<!ELEMENTTileSet(SRS,BoundingBox?,Resolutions,Width,Height,Format,Layers*,Styles*)>");wmscElements.add("<!ELEMENTResolutions(#PCDATA)>");wmscElements.add("<!ELEMENTWidth(#PCDATA)>");wmscElements.add("<!ELEMENTHeight(#PCDATA)>");wmscElements.add("<!ELEMENTLayers(#PCDATA)>");wmscElements.add("<!ELEMENTStyles(#PCDATA)>");returnwmscElements;
if(!gwc.getConfig().isDirectWMSIntegrationEnabled()){return;
if(!WMS.VERSION_1_1_1.equals(version)||!isTiled(request)){return;
if(localWorkspace==null){nsPrefix=null;
else{nsPrefix=localWorkspace.getName()+":";
if(nsPrefix!=null){
if(!advertisedName.startsWith(nsPrefix)){continue;
if(config.getId()!=null){try{for(GeoServerRolerole:GeoServerApplication.get().getSecurityManager().loadRoleService(config.getName()).getRoles()){roleNames.add(role.getAuthority());
ifwefindonefor(RepositoryInforepo:getRepositoryInfos()){
if(repo.getRepoName().equals(repoName)){returnrepo.getId();
if(repoId!=null){RepositoryManagermanager=RepositoryManager.get();manager.invalidate(repoId);
if(repositoryName!=null&&RepositoryManager.get().repoExistsByName(repositoryName)){//repoalreadyexiststhrownewCommandSpecException("Thespecifiedrepositorynameisalreadyinuse,pleasetryadifferentname",HttpStatus.CONFLICT);
if(initRepo.isPresent()){//initrequestwassufficientreturninitRepo.get();
if(importRepo.isPresent()){//importrequestwassufficientreturnimportRepo.get();
if(null==repoId){returnnull;
iftherequestisaPOST,andtherequestpathendsin"importExistingRepo"try{finalHintshints=InitRequestUtil.createHintsFromParameters(repositoryName,parameters);//nowbuildtherepowiththeHintsRepositoryInforepoInfo=newRepositoryInfo();//settherepolocationfromtheURI
if(!hints.get(Hints.REPOSITORY_URL).isPresent()){returnOptional.absent();
ifrepoisinitializedRepositoryResolverrepoResolver=RepositoryResolver.lookup(uri);
if(!repoResolver.repoExists(uri)){returnOptional.absent();
if(null!=repositoryName){Iterator<String>findRepositories=findRepositories();while(findRepositories.hasNext()){Stringnext=findRepositories.next();
if(next.equals(repositoryName)){returntrue;
if(isNew||tileLayer==null){/**Ensureasaneconfigfordefaults,incaseautomaticcacheofnewlayersisdefined*andthedefaultsismisconfigured*/finalGWCConfigsaneDefaults=defaultSettings.saneConfig();tileLayerInfo=TileLayerInfoUtil.loadOrCreate(layerInfo,saneDefaults);
else{GeoServerTileLayerInfoinfo=((GeoServerTileLayer)tileLayer).getInfo();tileLayerInfo=info.clone();
if(!initWithTileLayer){tileLayerInfo.setId(null);//indicatenottocreatethetilelayer
if(value.contains("/")){List<String>unparsed=KvpUtils.readFlat(value,newTokenizer("/"));IntervalTypeinterval=Wcs10Factory.eINSTANCE.createIntervalType();TypedLiteralTypemin=Wcs10Factory.eINSTANCE.createTypedLiteralType();TypedLiteralTypemax=Wcs10Factory.eINSTANCE.createTypedLiteralType();TypedLiteralTyperes=Wcs10Factory.eINSTANCE.createTypedLiteralType();
if(unparsed.size()==2){min.setValue(unparsed.get(0));max.setValue(unparsed.get(1));interval.setMin(min);interval.setMax(max);
else{min.setValue(unparsed.get(0));max.setValue(unparsed.get(1));res.setValue(unparsed.get(2));interval.setMin(min);interval.setMax(max);interval.setRes(res);
else{List<String>unparsed=KvpUtils.readFlat(value,KvpUtils.INNER_DELIMETER);
if(unparsed.size()==0){thrownewWcsException("Requestedaxissubsetcontainswrongnumberofvalues(shouldhaveatleast1):"+unparsed.size(),WcsExceptionCode.InvalidParameterValue,"band");
ifunspecified*/publicstaticVersionnegotiateVersion(finalVersionrequestedVersion){
if(null==requestedVersion){returnVERSION_1_3_0;
if(VERSION_1_1_1.equals(requestedVersion)){returnVERSION_1_1_1;
if(VERSION_1_3_0.equals(requestedVersion)){returnVERSION_1_3_0;
if(requestedVersion.compareTo(VERSION_1_3_0)<0){returnVERSION_1_1_1;
if(versions.size()>0){version=versions.get(0).toString();
else{//shouldn'taversionbeset?version="1.1.1";
ifcontinuousmapwrappingisenabledornot*/publicbooleanisContinuousMapWrappingEnabled(){//forbackwardscompatibilitywesettheconfigvaluetothesysvariableone
ifset,but//onceset,theconfigwinsBooleanenabled=getMetadataValue(MAP_WRAPPING_KEY,ENABLE_MAP_WRAPPING,Boolean.class);returnenabled;
ifadvancedprojectionhandlingisenabledornot*/publicbooleanisAdvancedProjectionHandlingEnabled(){//forbackwardscompatibilitywesettheconfigvaluetothesysvariableone
ifset,but//onceset,theconfigwinsBooleanenabled=getMetadataValue(ADVANCED_PROJECTION_KEY,ENABLE_ADVANCED_PROJECTION,Boolean.class);returnenabled;
if(parsedValue==null)returndefaultValue;intvalue=parsedValue.intValue();
if(value<0||value>100){LOGGER.warning("Invalidpercertagevaluefor'"+key+"',itshouldbebetween0and100");returndefaultValue;
if(getServiceInfo()==null){returndefaultValue;
if(parsedValue==null)returndefaultValue;returnparsedValue;
if(isAllowedGetMapFormat(producer)){result.add(producer);
if(isAllowedGetMapFormat(producer)==false){continue;//skipthisproducer,itsmimetypeisnotallowed
if(getServiceInfo().isGetMapMimeTypeCheckingEnabled()==false)returntrue;Set<String>mimeTypes=getServiceInfo().getGetMapMimeTypes();returnmimeTypes.contains(format.getMimeType());
if(getServiceInfo().isGetFeatureInfoMimeTypeCheckingEnabled()==false)returntrue;Set<String>mimeTypes=getServiceInfo().getGetFeatureInfoMimeTypes();returnmimeTypes.contains(format.getContentType());
if(ENABLE_MAP_WRAPPING==null){Stringwrapping=GeoServerExtensions.getProperty("ENABLE_MAP_WRAPPING",applicationContext);//defaulttotrue,butallowswitchingoff
if(wrapping==null)ENABLE_MAP_WRAPPING=true;
elseENABLE_MAP_WRAPPING=Boolean.valueOf(wrapping);
if(ENABLE_ADVANCED_PROJECTION==null){Stringprojection=GeoServerExtensions.getProperty("ENABLE_ADVANCED_PROJECTION",applicationContext);//defaulttotrue,butallowswitchingoff
if(projection==null)ENABLE_ADVANCED_PROJECTION=true;
elseENABLE_ADVANCED_PROJECTION=Boolean.valueOf(projection);
ifnone
iffound*/publicGetFeatureInfoOutputFormatgetFeatureInfoOutputFormat(StringrequestFormat){List<GetFeatureInfoOutputFormat>outputFormats;outputFormats=WMSExtensions.findFeatureInfoFormats(applicationContext);for(GetFeatureInfoOutputFormatformat:outputFormats){
if(format.canProduce(requestFormat)){returnformat;
if(isAllowedGetFeatureInfoFormat(format)==false){continue;//skipthisformat
ifnoneis*found*/publicGetMapOutputFormatgetMapOutputFormat(finalStringmimeType){GetMapOutputFormatoutputFormat;outputFormat=WMSExtensions.findMapProducer(mimeType,applicationContext);returnoutputFormat;
if*noneisfound*/publicGetLegendGraphicOutputFormatgetLegendGraphicOutputFormat(finalStringoutputFormat){GetLegendGraphicOutputFormatformat;format=WMSExtensions.findLegendGraphicFormat(outputFormat,applicationContext);returnformat;
if(version==null||0==version.trim().length()){returnnull;
if(VERSION_1_1_1.toString().equals(version)){returnVERSION_1_1_1;
else
if(VERSION_1_3_0.toString().equals(version)){returnVERSION_1_3_0;
if(VERSION_1_3_0.equals(version)){
if(srs!=null&&srs.toUpperCase().startsWith("EPSG:")){srs=srs.toUpperCase().replace("EPSG:","urn:ogc:def:crs:EPSG:");
ifthelayercanbequeried*/publicbooleanisQueryable(LayerInfolayer){try{
if(layer.getResource()instanceofWMSLayerInfo){WMSLayerInfoinfo=(WMSLayerInfo)layer.getResource();Layerwl=info.getWMSLayer(null);
if(!wl.isQueryable()){returnfalse;
if(featureInfo==null||!featureInfo.getFormats().contains("application/vnd.ogc.gml")){returnfalse;
else
if(layer.getResource()instanceofWMTSLayerInfo){returnfalse;
ifthelayerisqueryable,assumingit'snot",e);returnfalse;
ifthelayerisopaque*/publicbooleanisOpaque(LayerInfolayer){returnlayer.isOpaque();
if(!(layer.getResource()instanceofWMSLayerInfo)){returnnull;
if(layerGroup.isQueryDisabled())returnfalse;booleanqueryable=false;List<PublishedInfo>layers=getLayersForQueryableChecks(layerGroup);for(PublishedInfopublished:layers){
if(publishedinstanceofLayerInfo){queryable|=isQueryable((LayerInfo)published);
else{queryable|=isQueryable((LayerGroupInfo)published);
ifanylayerinsideofit,advertisedornot,*isqueriable(becausethenonadvertisedlayerisstillavailableinGetFeatureInfo).So,*justforthisusecase,wearegoingtounwrap{@link*org.geoserver.catalog.impl.AdvertisedCatalog.AdvertisedLayerGroup}andgettheoriginallist*oflayers.Thesecuritywrappersarebelowitbyconstruction,sothiswon'tcase,perse,*securityissues.**@paramlayerGroupthegroupwhosequery-abilityneedstobechecked*@returnalistof{@linkPublishedInfo}containedinthelayer(queryableornot)*/privateList<PublishedInfo>getLayersForQueryableChecks(LayerGroupInfolayerGroup){List<PublishedInfo>layers=layerGroup.getLayers();//directwrapper?
if(layerGroupinstanceofAdvertisedCatalog.AdvertisedLayerGroup){AdvertisedCatalog.AdvertisedLayerGroupwrapper=(AdvertisedCatalog.AdvertisedLayerGroup)layerGroup;layers=wrapper.getOriginalLayers();
else
if(layerGroupinstanceofWrapper){//hiddeninsidesomeotherwrapper?Wrapperwrapper=(Wrapper)layerGroup;
if(wrapper.isWrapperFor(AdvertisedCatalog.AdvertisedLayerGroup.class)){wrapper.unwrap(AdvertisedCatalog.AdvertisedLayerGroup.class);AdvertisedCatalog.AdvertisedLayerGroupalg=(AdvertisedCatalog.AdvertisedLayerGroup)layerGroup;layers=alg.getOriginalLayers();
ifpossible**@deprecatedUse{@link#getWMSReadParameters(GetMapRequest,MapLayerInfo,Filter,SortBy[],*List,List,GridCoverage2DReader,boolean)}instead*/@DeprecatedpublicGeneralParameterValue[]getWMSReadParameters(finalGetMapRequestrequest,finalMapLayerInfomapLayerInfo,finalFilterlayerFilter,finalList<Object>times,finalList<Object>elevations,finalGridCoverage2DReaderreader,booleanreadGeom)throwsIOException{returngetWMSReadParameters(request,mapLayerInfo,layerFilter,null,times,elevations,reader,readGeom);
ifpossible*/publicGeneralParameterValue[]getWMSReadParameters(finalGetMapRequestrequest,finalMapLayerInfomapLayerInfo,finalFilterlayerFilter,SortBy[]sortBy,finalList<Object>times,finalList<Object>elevations,finalGridCoverage2DReaderreader,booleanreadGeom)throwsIOException{//setupthescenefinalParameterValueGroupreadParametersDescriptor=reader.getFormat().getReadParameters();CoverageInfocoverage=mapLayerInfo.getCoverage();MetadataMapmetadata=coverage.getMetadata();GeneralParameterValue[]readParameters=CoverageUtils.getParameters(readParametersDescriptor,coverage.getParameters(),readGeom);ReaderDimensionsAccessordimensions=newReaderDimensionsAccessor(reader);//passdowntimefinalDimensionInfotimeInfo=metadata.get(ResourceInfo.TIME,DimensionInfo.class);//addthedescriptorsforcustomdimensionsfinalList<GeneralParameterDescriptor>parameterDescriptors=newArrayList<GeneralParameterDescriptor>(readParametersDescriptor.getDescriptor().descriptors());Set<ParameterDescriptor<List>>dynamicParameters=reader.getDynamicParameters();parameterDescriptors.addAll(dynamicParameters);
if(timeInfo!=null&&timeInfo.isEnabled()){//handle"default"List<Object>fixedTimes=newArrayList<Object>(times);for(inti=0;i<fixedTimes.size();i++){
if(fixedTimes.get(i)==null){fixedTimes.set(i,getDefaultTime(coverage));
if(timeInfo.isNearestMatchEnabled()){fixedTimes=getNearestMatches(coverage,timeInfo,fixedTimes,ResourceInfo.TIME);
if(elevationInfo!=null&&elevationInfo.isEnabled()){//handle"default"List<Object>fixedElevations=newArrayList<Object>(elevations);for(inti=0;i<fixedElevations.size();i++){
if(fixedElevations.get(i)==null){fixedElevations.set(i,getDefaultElevation(coverage));
if(layerFilter!=null&&readParameters!=null){//testfordefault[emptyisreplacedwithINCLUDEfilter]]filterfor(inti=0;i<readParameters.length;i++){GeneralParameterValueparam=readParameters[i];GeneralParameterDescriptorpd=param.getDescriptor();
if(pd.getName().getCode().equalsIgnoreCase("FILTER")){finalParameterValuepv=(ParameterValue)pd.createValue();//
ifsomethingdifferentfromthedefaultINCLUDEfilterisspecified
if(layerFilter!=Filter.INCLUDE){//overridethedefaultfilterpv.setValue(layerFilter);readParameters[i]=pv;
if(sortBy!=null&&readParameters!=null){//testfordefaultsortByfor(inti=0;i<readParameters.length;i++){GeneralParameterValueparam=readParameters[i];GeneralParameterDescriptorpd=param.getDescriptor();
if(pd.getName().getCode().equalsIgnoreCase("SORTING")){finalParameterValuepv=(ParameterValue)pd.createValue();
if(pdinstanceofParameterDescriptor&&String.class.equals(((ParameterDescriptor)pd).getValueClass())){//convertdowntostringStringsortBySpec=Arrays.stream(sortBy).map(sb->sb.getPropertyName().getPropertyName()+""+sb.getSortOrder().name().charAt(0)).collect(Collectors.joining(","));pv.setValue(sortBySpec);
else{pv.setValue(sortBy);
if(values!=null){intmaxValues=getMaxRequestedDimensionValues();
if(maxValues>0&&maxValues<values.size()){thrownewServiceException("Morethan"+maxValues+"dimensionvaluesspecifiedintherequest,bailingout.",ServiceException.INVALID_PARAMETER_VALUE,"DIM_"+domain.toUpperCase());
ifwehaveanycustomdomainforwhichwehavetosetthedefaultvalue
if(!customDomains.isEmpty()){for(Stringname:customDomains){finalDimensionInfocustomInfo=metadata.get(ResourceInfo.CUSTOM_DIMENSION_PREFIX+name,DimensionInfo.class);
if(customInfo!=null&&customInfo.isEnabled()){Objectval=dimensions.convertDimensionValue(name,getDefaultCustomDimensionValue(name,coverage,String.class));readParameters=CoverageUtils.mergeParameter(parameterDescriptors,readParameters,val,name);
if(time==null||!time.isEnabled()){thrownewServiceException("Layer"+coverage.getPrefixedName()+"doesnothavetimesupportenabled");
if(reader==null){thrownewServiceException("Unabletoacquireareaderforthiscoverage"+coverage.prefixedName());
if(time==null||!time.isEnabled()){thrownewServiceException("Layer"+typeInfo.prefixedName()+"doesnothavetimesupportenabled");
if(time.getPresentation()==DimensionPresentation.LIST){finalUniqueVisitorvisitor=newUniqueVisitor(time.getAttribute());collection.accepts(visitor,null);@SuppressWarnings("unchecked")Set<Date>values=visitor.getUnique();
if(values.size()<=0){result=null;
else{//wemightgetnullvaluesoutofthevisitor,stripthemvalues.remove(null);result.addAll(values);
else{finalMinVisitormin=newMinVisitor(time.getAttribute());collection.accepts(min,null);CalcResultminResult=min.getResult();//checkcalcresultfirsttoavoidpotentialIllegalStateException
ifnofeaturesarein//collection
if(minResult!=CalcResult.NULL_RESULT){result.add((Date)min.getMin());finalMaxVisitormax=newMaxVisitor(time.getAttribute());collection.accepts(max,null);result.add((Date)max.getMax());
if(elevation==null||!elevation.isEnabled()){thrownewServiceException("Layer"+coverage.prefixedName()+"doesnothaveelevationsupportenabled");
if(reader==null){thrownewServiceException("Unabletoacquireareaderforthiscoverage"+coverage.prefixedName());
if(elevation==null||!elevation.isEnabled()){thrownewServiceException("Layer"+typeInfo.prefixedName()+"doesnothaveelevationsupportenabled");
if(elevation.getPresentation()==DimensionPresentation.LIST||(elevation.getPresentation()==DimensionPresentation.DISCRETE_INTERVAL&&elevation.getResolution()==null)){finalUniqueVisitorvisitor=newUniqueVisitor(elevation.getAttribute());collection.accepts(visitor,null);@SuppressWarnings("unchecked")Set<Object>values=visitor.getUnique();
if(values.size()<=0){result=null;
else{for(Objectvalue:values){result.add(((Number)value).doubleValue());
else{finalMinVisitormin=newMinVisitor(elevation.getAttribute());collection.accepts(min,null);//checkcalcresultfirsttoavoidpotentialIllegalStateException
ifnofeaturesarein//collectionCalcResultcalcResult=min.getResult();
if(calcResult!=CalcResult.NULL_RESULT){result.add(((Number)min.getMin()).doubleValue());finalMaxVisitormax=newMaxVisitor(elevation.getAttribute());collection.accepts(max,null);result.add(((Number)max.getMax()).doubleValue());
if(di==null||!di.isEnabled()){thrownewServiceException("Layer"+typeInfo.prefixedName()+"doesnothave"+dimensionName+"supportenabled");
if(time==null||!time.isEnabled()){thrownewServiceException("Layer"+resourceInfo.prefixedName()+"doesnothavetimesupportenabled");
ifnotfound**@paramresourceInfo*@paramdimensionName*/publicDimensionInfogetDimensionInfo(ResourceInforesourceInfo,StringdimensionName){DimensionInfoinfo=resourceInfo.getMetadata().get(dimensionName,DimensionInfo.class);
if(info==null||!info.isEnabled()){thrownewServiceException("Layer"+resourceInfo.prefixedName()+"doesnothave"+dimensionName+"supportenabled");
if(customDim==null||!customDim.isEnabled()){thrownewServiceException("Layer"+resourceInfo.prefixedName()+"doesnothavesupportenabledfordimension"+dimensionName);
if(defaultDimensionValueFactory!=null){returndefaultDimensionValueFactory.getStrategy(resource,dimensionName,dimensionInfo);
else{returnnull;
ifthe*nativecapabilitiesallowforit**@paramtypeInfo*@paramdimension*@throwsIOException*/FeatureCollectiongetDimensionCollection(FeatureTypeInfotypeInfo,DimensionInfodimension)throwsIOException{FeatureSourcesource=getFeatureSource(typeInfo);//buildquerytograbthedimensionvaluesfinalQuerydimQuery=newQuery(source.getSchema().getName().getLocalPart());dimQuery.setPropertyNames(Arrays.asList(dimension.getAttribute()));returnsource.getFeatures(dimQuery);
if(timeInfo!=null&&timeInfo.isEnabled()&&times!=null){List<Object>defaultedTimes=newArrayList<>(times.size());for(Objectdatetime:times){
if(datetime==null){//thisis"default"datetime=getDefaultTime(typeInfo);
if(timeInfo.isNearestMatchEnabled()){List<Object>nearestMatchedTimes=getNearestMatches(typeInfo,timeInfo,defaultedTimes,ResourceInfo.TIME);builder.appendFilters(timeInfo.getAttribute(),timeInfo.getEndAttribute(),nearestMatchedTimes);
else{builder.appendFilters(timeInfo.getAttribute(),timeInfo.getEndAttribute(),defaultedTimes);
if(elevationInfo!=null&&elevationInfo.isEnabled()&&elevations!=null){List<Object>defaultedElevations=newArrayList<Object>(elevations.size());for(Objectelevation:elevations){
if(elevation==null){//thisis"default"elevation=getDefaultElevation(typeInfo);
ifthereisamaxrenderingtimeset,useitonthismatch,astheinputrequestmight//makethe//codegothroughalotofnearestmatchqueriesintmaxRenderingTime=getMaxRenderingTime();longmaxTime=maxRenderingTime>0?System.currentTimeMillis()+maxRenderingTime*1000:-1;NearestMatchFinderfinder=NearestMatchFinder.get(resourceInfo,dimension,dimensionName);List<Object>result=newArrayList<>();for(Objectvalue:values){Objectnearest=finder.getNearest(value);
if(nearest==null){//nowaytospecifythereisnomatchyet,sowe'llusetheoriginalvalue,which//willnotmatchNearestMatchWarningAppender.addWarning(resourceInfo.prefixedName(),dimensionName,null,dimension.getUnits(),NotFound);result.add(value);
else
if(value.equals(nearest)){result.add(value);
else{NearestMatchWarningAppender.addWarning(resourceInfo.prefixedName(),dimensionName,nearest,dimension.getUnits(),Nearest);result.add(nearest);
if(maxTime>0&&System.currentTimeMillis()>maxTime){thrownewServiceException("Nearestmatchingdimensionvaluesrequiredmoretimethanallowedandhasbeenforcefullystopped."+"Themaxrenderingtimeis"+(maxRenderingTime)+"s");
if(timeoutOption!=null){try{localMaxRenderingTime=Integer.parseInt(timeoutOption.toString());
if(timeoutOption!=null){try{localMaxRenderingTime=Integer.parseInt(timeoutOption.toString());
if(maxRenderingTime==null){returnlocalMaxRenderingTime;
else
if(localMaxRenderingTime==0){returnmaxRenderingTime.intValue();
else{returnMath.min(maxRenderingTime.intValue(),localMaxRenderingTime);
if(maxRenderingTime==0){maxRenderingTime=localMaxRenderingTime;
else
if(localMaxRenderingTime!=0){maxRenderingTime=Math.min(maxRenderingTime,localMaxRenderingTime);
ifwehavealat/loncrsswapitCoordinateReferenceSystemcrs=mapExtent.getCoordinateReferenceSystem();booleanswap=crs!=null&&CRS.getAxisOrder(crs)==AxisOrder.NORTH_EAST;
if(swap){mapExtent=newReferencedEnvelope(mapExtent.getMinY(),mapExtent.getMaxY(),mapExtent.getMinX(),mapExtent.getMaxX(),null);
ifweswappedconcatenateatransformthatswapsback
if(swap){at.concatenate(newAffineTransform(0,1,1,0,0,0));
ifthelayercanbedrawn,thatis,
ifit'sraster,orvectorwithageometry*attribute**@paramlyr*@return*/publicstaticbooleanisWmsExposable(LayerInfolyr){
if(lyr.getType()==PublishedType.RASTER||lyr.getType()==PublishedType.WMS||lyr.getType()==PublishedType.WMTS){returntrue;
if(lyr.getType()==PublishedType.VECTOR){finalResourceInforesource=lyr.getResource();try{for(AttributeTypeInfoatt:((FeatureTypeInfo)resource).attributes()){
if(att.getBinding()!=null&&Geometry.class.isAssignableFrom(att.getBinding())){returntrue;
ifthefile'sokay)*/publicListvalidateGETMAP(InputSourcexml,URLSchemaUrl){EntityResolverProviderprovider=GeoServerExtensions.bean(EntityResolverProvider.class);returnResponseUtils.validate(xml,SchemaUrl,true,provider.getEntityResolver());}}
if(parentRole!=null)checkExistingRoleName(parentRole.getAuthority());getStore().setParentRole(role,parentRole);}}
switchbetweenconfigurationsdropdownPanel=newDropDownChoiceParamPanel("configChoicePanel",newDropDownModel(model),newResourceModel("GeoGigRepositoryInfoFormComponent.repositoryType","RepositoryType"),DropDownModel.CONFIG_LIST,true);finalDropDownChoice<Serializable>dropDownChoice=dropdownPanel.getFormComponent();dropDownChoice.add(newAjaxFormComponentUpdatingBehavior("change"){privatestaticfinallongserialVersionUID=1L;@OverrideprotectedvoidonUpdate(AjaxRequestTargettarget){finalStringvalue=dropDownChoice.getModelObject().toString();directoryComponent.setVisible(DropDownModel.DIRECTORY_CONFIG.equals(value));pgPanel.setVisible(DropDownModel.PG_CONFIG.equals(value));target.add(settingsContainer);
if(null!=repoTypeChoice){StringrepoName=repoNamePanel.getFormComponent().getConvertedInput().toString().trim();modelObject.setRepoName(repoName);
switch(repoTypeChoice){caseDropDownModel.PG_CONFIG://PGconfigusedPostgresConfigBeanbean=pgPanel.getConvertedInput();//buildaURIoutoftheconfigURIuri=bean.buildUriForRepo(repoName);modelObject.setLocation(uri);break;caseDropDownModel.DIRECTORY_CONFIG:
if(modelObject.getLocation()==null){//localdirectoryusedStringpath=directoryComponent.getConvertedInput().trim();PathuriPath=Paths.get(path,UUID.randomUUID().toString());modelObject.setLocation(uriPath.toUri());
if(!fileField.getInput().trim().equals("")){file=newFile(fileField.getInput());
if(!file.exists())file=null;
if(oldStore!=null){//error(new//ParamResourceModel("ImporterError.duplicateStore",//DirectoryPage.this,generalParams.name,//workspace.getName()).getString());//return;//
if(preExisting!=null){//
if(!(preExistinginstanceofDataStoreInfo)){//error(newParamResourceModel("storeExistsNotVector",//this,generalParams.name));//return;//
if(!si.getType().equals(storeType)//||!si.getConnectionParameters().equals(params)){//error(newParamResourceModel("storeExistsNotSame",//this,generalParams.name));//return;//
else{//storeNew=true;//CatalogBuilderbuilder=newCatalogBuilder(getCatalog());//builder.setWorkspace(workspace);//si=builder.buildDataStore(generalParams.name);//si.setDescription(generalParams.description);//si.getConnectionParameters().putAll(params);//si.setEnabled(true);//si.setType(storeType);////getCatalog().add(si);//
ifneeded.**<pre>*<code>*Filefile=resourceStore.get("module/logo.png");*BufferedImageimg=ImageIO.read(file);*</code>*</pre>**Thebasedirectoryisavailableusing{@linkPaths#BASE}(as"")butrelativepaths("."and*"..")arenotsupported.**<p>Thisabstractionassumesaunixlikefilesystem,allpathsshoulduseforwardslash"/"as*theseparator.**@seeResources*@seeResource*/publicinterfaceResourceStore{/***EmptyplaceholderforResourceStore.**<p>Emptyplaceholderintendedfortestcases(usedasspringcontextdefaultwhenabase*directoryisnotprovided).Thisimplementationpreventsclientcodefromrequiringnull*checkson{@linkResourceStore#get(String)}.IllegalStateExceptionarethrownbyin(),out()*andfile()whicharetheusualmethodsclientsrequireerrorhandling.*/publicstaticResourceStoreEMPTY=newNullResourceStore();/***Pathbasedresourceaccess.**<p>ThereturnedResourceactsasahandle,andmaybeUNDEFINED.IngeneralResourcesare*createdinalazyfashionwhenusedforthefirsttime.**@parampathPath(usingunixconventions,forwardslashasseparator)ofrequestedresource*@returnResourceattheindicatedlocation(nullisneverreturnedalthoughResourcemaybe*UNDEFINED).*@throwsIllegalArgumentExceptionIfpathisinvalid*/Resourceget(Stringpath);/***Removeresourceatindicatedpath(includingindividualresourcesordirectories).**<p>Returns<code>true</code>
ifResourceexistedandwassuccessfullyremoved.Forread-only*content(or
ifasecuritycheck)preventstheresourcefrombeingremoved<code>false</code>*isreturned.**@parampathPathofresourcetoremove(usingunixconventions,forwardslashasseparator)*@return<code>false</code>
ifdoesn'texistorunabletoremove*/booleanremove(Stringpath);/***Moveresourceatindicatedpath(includingindividualresourcesordirectories).**@parampathPathofresourcetomove(usingunixconventions,forwardslashasseparator)*@paramtargetpathformovedresource*@returntrue
ifresourcewasmovedtargetpath*/booleanmove(Stringpath,Stringtarget);/***TheResourceNotificationDispatcher**@returnresourcenotificationdispatcher*/ResourceNotificationDispatchergetResourceNotificationDispatcher();}
if(code==p.getCode()){returnp;
ifwatermarkingisenabled.*/booleanisEnabled();/**Setsflagindicating
ifwatermarkingisenabled.*/voidsetEnabled(booleanenabled);/***Thepositionofthewatermarkonresultingwmsimages.**<p>**<pre>*O--O--O0--1--2*||||||*O--O--O==3--4--5*||||||*O--O--O6--7--8*</pre>*/PositiongetPosition();/**Setsthewatermarkposition.*/voidsetPosition(Positionposition);/***Theurlofthewatermark.**<p>Thisisusuallythelocationofsomelogo.*/StringgetURL();/**Setstheurlofthewatermark.*/voidsetURL(Stringurl);/**Thetransparencyofthewatermarklogo,rangingfrom0to255.*/intgetTransparency();/**Setsthetransparanecyofthewatermarklogo.*/voidsetTransparency(inttransparency);}
ifnotsavingalsotheassociatedresource,we'reassumingsavingthelayeralso//savesitsResourceInfo,whichiswrong,butworksonthein-memorycatalogbyaccidentcatalog.save(l2.getResource());l2=catalog.getLayerByName(l2.getName());assertFalse(l2.isEnabled());assertFalse(l2.enabled());assertFalse(l2.getResource().isEnabled());
ifwedon't//specifytheworkspaceassertEquals(lg1,catalog.getLayerGroupByName("lg"));assertEquals(lg1,catalog.getLayerGroupByName(ws.getName(),"lg"));assertEquals(lg1,catalog.getLayerGroupByName(ws,"lg"));assertEquals(lg1,catalog.getLayerGroupByName(ws.getName()+":lg"));assertEquals(lg2,catalog.getLayerGroupByName(ws2,"lg"));assertEquals(lg2,catalog.getLayerGroupByName(ws2,"lg"));assertEquals(lg2,catalog.getLayerGroupByName(ws2.getName()+":lg"));
if(throwCatalogException){thrownewCatalogException();
else{thrownewRuntimeException();
if(extraStyles!=null){for(StyleInfoes:extraStyles){l2.getStyles().add(es);
if(!(objectinstanceofDomains)){thrownewIllegalArgumentException("Expecteddomainsinfobutinsteadgot:"+object.getClass().getCanonicalName());
if(domains.getSpatialDomain()!=null&&!domains.getSpatialDomain().isEmpty()){handleBoundingBox(domains.getSpatialDomain());
if(boundingBox==null){return;
ifansrsNameissetforthisgeometry,putitinthecontextfor//children,sotheycanuseitaswell
if(node.hasAttribute("srsName")){try{CoordinateReferenceSystemcrs=GML2ParsingUtils.crs(node);
if(crs!=null){context.registerComponentInstance(CoordinateReferenceSystem.class,crs);
if(node.hasAttribute("srsName")){CRS.decode(node.getAttributeValue("srsName").toString());
if(geometry!=null){//1.ensureacrsisset
if(geometry.getUserData()==null){//nocrssetforthegeometry,didweinheritonefromaparent?
if(crs!=null){geometry.setUserData(crs);
else{//forthemomentwedon'tdoanythingsincewemisstheinformation//toinfertheCRSfromthefeaturetype
if(crs!=null)try{JTS.checkCoordinatesRange(geometry,crs);
if(SecurityUtils.isSecurityException(e)==false)fail("Shouldhavethrownasecurityexception...");
if(SecurityUtils.isSecurityException(e)==false)fail("Shouldhavethrownasecurityexception...");
if(priority!=null){hr.addHeader(PRIORITY_HEADER_NAME,String.valueOf(priority));
if(!optionalRuleModel.isPresent()||optionalRuleModel.get().isEchoOnly()){tabs.add(newWrappedTab("EchoParameter",echoParameterModel){publicPanelgetPanel(StringpanelId){returnnewEchoParameterPanel(panelId,echoParameterModel);
if(!optionalRuleModel.isPresent()||optionalRuleModel.get().getPosition()!=null){tabs.add(newWrappedTab("BasicRule",simpleRuleModel){publicPanelgetPanel(StringpanelId){returnnewSimpleRulePanel(panelId,simpleRuleModel);
if(!optionalRuleModel.isPresent()||optionalRuleModel.get().getMatch()!=null){tabs.add(newWrappedTab("AdvancedRule",complexRuleModel){publicPanelgetPanel(StringpanelId){returnnewComplexRulePanel(panelId,complexRuleModel);
ifthecontributedcontentisnotmeanttobevisibletoanonymoususers,etc.**@paramidtheidofthereturnedcomponent*@returnacomponentsuitabletobecontainedbythehomepagecentralbody,or{@codenull}*
ifnoextracontentisprovided.*/publicComponentgetPageBodyComponent(finalStringid);}
if(uw!=null){assertTrue("pickedupbyjdbc4extractor",uwinstanceofSpringUnWrapper);
if(uwinstanceofGenericUnWrapper){assertSame("Genericunwrapperisworking",connection,uw.unwrap(wrapper));
if(doPlacemarks){assertEquals(getFeatureSource(MockData.BASIC_POLYGONS).getFeatures().size(),document.getElementsByTagName("Placemark").getLength());XMLAssert.assertXpathEvaluatesTo("3","count(//kml:Placemark//kml:Point)",document);
else{assertEquals(0,document.getElementsByTagName("Placemark").getLength());
if(zipFile!=null){zipFile.close();
if(template!=null){template.delete();
if(template!=null){template.delete();
if(equalsRegardingNull(expectedText,text)){return;
if(expectedText!=null&&text!=null){StringexpectedCoordinates[]=expectedText.split("(\\s|,)");StringactualCoordiantes[]=text.split("(\\s|,)");
if(expectedCoordinates.length==actualCoordiantes.length){finalintLENGTH=actualCoordiantes.length;booleanchecked=true;LIST:for(inti=0;i<LENGTH;i++){Stringexpected=expectedCoordinates[i];Stringactual=actualCoordiantes[i];
if(expected.length()==actual.length()){
if(!expected.equals(actual)){checked=false;breakLIST;//normalequalscheckwillreportissue
else{try{doubleexpectedOrdinate=Double.parseDouble(expected);doubleactualOridnate=Double.parseDouble(actual);
if(Double.compare(expectedOrdinate,actualOridnate)!=0){//CoulddoaMath.abs(expectedOrdinate-actualOridnate)<=delta//checkbreakLIST;//normalequalscheckwillreportissue
if(checked){return;//doublebasedcomparisoncheckedallelements
if(expected==null){returnactual==null;
if(template!=null){template.delete();
if(url.indexOf('?')>0){url=url.substring(url.indexOf('?')+1);
if(value!=null){try{value=URLDecoder.decode(value,"UTF-8");
if(entry.getKey().equalsIgnoreCase("format_options")){FormatOptionsKvpParserparser=newFormatOptionsKvpParser();MapexpectedFormatOptions=(Map)parser.parse((String)entry.getValue());MapactualFormatOptions=(Map)parser.parse((String)actual.get(entry.getKey()));for(Objecto:expectedFormatOptions.entrySet()){Map.EntryformatOption=(Map.Entry)o;assertEquals(formatOption.getValue(),actualFormatOptions.get(formatOption.getKey()));
else{assertEquals(entry.getValue(),actual.get(entry.getKey()));
ifthetwoaltitudevaluesareobtainedfrom*thecorrespondingboundingbox.Thefirstvalue(//kml:Document/kml:LookAt/kml:altitude)is*calculatedfromtheinitialboundingbox.Thesecondvalue*(//kml:Document/kml:NetworkLink/kml:LookAt/kml:altitude)iscalculatedfromtheboundingbox*passedtotheWMSrequest.Testfails
ifthosevaluesareidentical.**@see<ahref="https://osgeo-org.atlassian.net/browse/GEOS-6410">GEOS-6410</a>*/@TestpublicvoidtestLookatOptionsWithRefreshMode()throwsException{StringlayerId=getLayerId(MockData.BASIC_POLYGONS);finalStringrequestUrl="wms/kml?layers="+layerId+"&styles=polygon&mode=refresh&bbox=10.56,46.99,11.50,47.26";Documentdoc=getAsDOM(requestUrl);//weexpectthatthosevaluesshouldnotbethesame,becausefirstvalueisobtainedfrom//initialbboxofthelayer,whilethesecondvaluefromthebboxoftherequestXMLAssert.assertXpathValuesNotEqual("//kml:Document/kml:LookAt/kml:altitude","//kml:Document/kml:NetworkLink/kml:LookAt/kml:altitude",doc);
ifthetimeparameteroftherequestisalsopassedtothe*KMLWMSrequest.**@see<ahref="https://osgeo-org.atlassian.net/browse/GEOS-6411">GEOS-6411</a>*/@TestpublicvoidtestWMSTimeRequest()throwsException{StringlayerId=getLayerId(MockData.BASIC_POLYGONS);StringexpectedTS="time=2014-03-01";finalStringrequestUrl="wms/kml?layers="+layerId+"&styles=polygon&mode=refresh&bbox=10.56,46.99,11.50,47.26&"+expectedTS;Documentdoc=getAsDOM(requestUrl);//weexpectthatthosevaluesshouldnotbethesame,becausefirstvalueisobtainedfrom//initialbboxofthelayer,whilethesecondvaluefromthebboxoftherequestNodeListnodes=doc.getElementsByTagName("href");for(inti=0;i<nodes.getLength();++i){Elemente=(Element)nodes.item(i);StringactualTS=e.getTextContent();Assert.assertTrue("Timeparametermissing",actualTS.contains(expectedTS));
iftheelevationparameteroftherequestisalsopassed*totheKMLWMSrequest.**@see<ahref="https://osgeo-org.atlassian.net/browse/GEOS-6411">GEOS-6411</a>*/@TestpublicvoidtestWMSElevationRequest()throwsException{StringlayerId=getLayerId(MockData.BASIC_POLYGONS);StringexpectedTS="elevation=500";finalStringrequestUrl="wms/kml?layers="+layerId+"&styles=polygon&mode=refresh&bbox=10.56,46.99,11.50,47.26&"+expectedTS;Documentdoc=getAsDOM(requestUrl);//weexpectthatthosevaluesshouldnotbethesame,becausefirstvalueisobtainedfrom//initialbboxofthelayer,whilethesecondvaluefromthebboxoftherequestNodeListnodes=doc.getElementsByTagName("href");for(inti=0;i<nodes.getLength();++i){Elemente=(Element)nodes.item(i);StringactualTS=e.getTextContent();Assert.assertTrue("Elevationparametermissing",actualTS.contains(expectedTS));
if(lg==null){error(newParamResourceModel("LayerGroupEditPage.notFound",this,groupName).getString());doReturn(LayerGroupPage.class);return;
if(!isAuthenticatedAsAdmin()&&!isNew){//globallayergroupsonlyeditablebyfulladmin
if(getPublishedInfo().getWorkspace()==null){//disableallformcomponentsbutcancelsetInputEnabled(false);info(newStringResourceModel("globalLayerGroupReadOnly",this,null).getString());
if(!isAuthenticatedAsAdmin()){wsChoice.setNullValid(false);wsChoice.setRequired(true);
if(crs!=null){//ensuretheboundscalculatedintermsoftheuserspecified//crsnewCatalogBuilder(getCatalog()).calculateLayerGroupBounds(lg,crs);
else{//calculatefromscratchnewCatalogBuilder(getCatalog()).calculateLayerGroupBounds(lg);
if(!isAuthenticatedAsAdmin()){
if(isNew){//defaulttofirstavailableworkspaceList<WorkspaceInfo>ws=getCatalog().getWorkspaces();
if(!ws.isEmpty()){wsChoice.setModelObject(ws.get(0));
else{//alwaysdisabletheworkspacetogglewsChoice.setEnabled(false);
if(other!=null&&(isNew||!other.getId().equals(getPublishedInfo().getId()))){IValidationErrorerr=newValidationError("duplicateGroupNameError").addKey("duplicateGroupNameError").setVariable("name",name);validatable.error(err);
if(lgEntryPanel.getEntries().size()==0){error((String)newParamResourceModel("oneLayerMinimum",getPage()).getObject());return;
if(!LayerGroupInfo.Mode.EO.equals(lg.getMode())){lg.setRootLayer(null);lg.setRootLayerStyle(null);
else{
if(lg.getRootLayerStyle()==null&&lg.getRootLayer()!=null){lg.setRootLayerStyle(lg.getRootLayer().getDefaultStyle());
if(isNew){catalog.add(lg);
else{catalog.save(lg);
if(ns!=null){ns.accept(this);
if(!layers.isEmpty()){for(LayerInfoli:layers){li.accept(this);
else{//nolayersfortheresource,deletedirectlyri.accept(this);
ifno//otherlayersremained,removethegroupaswellFiltergroupContainsLayer=Predicates.equal("layers.id",layer.getId(),MatchAction.ANY);try(CloseableIterator<LayerGroupInfo>groups=catalog.list(LayerGroupInfo.class,groupContainsLayer)){while(groups.hasNext()){LayerGroupInfogroup=groups.next();//parallelremoveoflayerandstylesintindex=group.getLayers().indexOf(layer);while(index!=-1){group.getLayers().remove(index);group.getStyles().remove(index);index=group.getLayers().indexOf(layer);
if(group.getLayers().size()==0){visit(catalog.getLayerGroup(group.getId()));
else{catalog.save(group);
if(style==null||style.equals(removedStyle)){returncatalog.getStyleByName(StyleInfo.DEFAULT_POINT);
if(layer.getStyles().remove(style)){dirty=true;
ifit'sthedefaultstyle,chooseanassociatedstyleorresetittothedefaultoneStyleInfods=layer.getDefaultStyle();
if(ds!=null&&ds.equals(style)){dirty=true;StyleInfonewDefaultStyle;
if(layer.getStyles().size()>0){newDefaultStyle=layer.getStyles().iterator().next();layer.getStyles().remove(newDefaultStyle);
else{newDefaultStyle=getResourceDefaultStyle(layer.getResource(),style);
if(dirty){catalog.save(layer);
if(style.equals(group.getRootLayerStyle())){group.setRootLayerStyle(getResourceDefaultStyle(group.getRootLayer().getResource(),style));dirty=true;
if(publishedStyle!=null&&publishedStyle.equals(style)){//
ifpublishedStyleisnotnull,wehavealayerLayerInfolayer=(LayerInfo)group.getLayers().get(i);
if(!layer.getDefaultStyle().equals(style)){//usedefaultstylestyles.set(i,layer.getDefaultStyle());
else{styles.set(i,getResourceDefaultStyle(layer.getResource(),style));
if(dirty){catalog.save(group);
if(group.getLayers().size()==0){//
ifgroupisempty,deleteitvisit(group);
else{catalog.save(group);
if(piinstanceofLayerGroupInfo&&id.equals(pi.getId())){returnidx;
if{@link*#isGetMapMimeTypeCheckingEnabled()}returns<code>true</code>*/Set<String>getGetMapMimeTypes();booleanisGetMapMimeTypeCheckingEnabled();voidsetGetMapMimeTypeCheckingEnabled(booleangetMapMimeTypeCheckingEnabled);/***AsetofmimetypesallowedforagetFeatureInforequest.Active
if{@link*#isGetFeatureInfoMimeTypeCheckingEnabled()}returns<code>true</code>*/Set<String>getGetFeatureInfoMimeTypes();booleanisGetFeatureInfoMimeTypeCheckingEnabled();voidsetGetFeatureInfoMimeTypeCheckingEnabled(booleangetFeatureInfoMimeTypeCheckingEnabled);/***FlagcontrollingwhethertheWMSservice,foreachlayer,shoulddeclareaboundingboxfor*everyCRSsupported,init'scapabilitiesdocument.**<p>BydefaultthenumberofCRS'ssupportedishugewhichdoesnotmakethisoption*practical.Thisflagisonlyrespectedincasesthere{@link#getSRS()}isnonempty.*/BooleanisBBOXForEachCRS();/***SetsflagcontrollingwhethertheWMSservice,foreachlayer,shoulddeclareaboundingbox*foreveryCRSsupported.**@see#isBBOXForEachCRS()*/voidsetBBOXForEachCRS(BooleanbboxForEachCRS);/**ThemaximumsearchradiusforGetFeatureInfo*/intgetMaxBuffer();/***SetsthemaximumsearchradiusforGetFeatureInfo(if0ornegativenomaximumisenforced)*/voidsetMaxBuffer(intbuffer);/***Returnsthemaxamountofmemory,inkilobytes,thateachWMSrequestcanallocate(each*outputformatwillmakeabesteffortattempttorespectit,buttherearenoguarantees)**@returnthelimit,or0
ifnolimit*/intgetMaxRequestMemory();/***Setsthemaxamountofmemory,inkilobytes,thateachWMSrequestcanallocate.Setitto0*
ifnolimitisdesired.*/voidsetMaxRequestMemory(intmax);/***Themaxtime,inseconds,aWMSrequestisallowedtospendrenderingthemap.Variousoutput*formatswilldoabestefforttorespectit(rasterformats,forexample,willaccountjust*renderingtime,butnotimageencodingtime)*/intgetMaxRenderingTime();/***Setsthemaxallowedrenderingtime,inseconds**@parammaxRenderingTime*/voidsetMaxRenderingTime(intmaxRenderingTime);/***Themaxnumberofrenderingerrorsthatwillbetoleratedbeforestatingtherendering*operationfailedbythrowingaserviceexceptionbacktotheclient*/intgetMaxRenderingErrors();/***Setsthemaxnumberofrenderingerrorstolerated**@parammaxRenderingTime*/voidsetMaxRenderingErrors(intmaxRenderingTime);/***DefinesthelistofauthorityURLsfortherootWMSlayer**@returnthelistofWMSrootlayer'sauthorityURLs*/List<AuthorityURLInfo>getAuthorityURLs();/**@returnthelistofidentifiersfortheWMSrootlayer*/List<LayerIdentifierInfo>getIdentifiers();/**@returnthetitleoftherootlayer*/StringgetRootLayerTitle();/***Setsthetitleoftherootlayer**@paramrootLayerTitle*/voidsetRootLayerTitle(StringrootLayerTitle);/**@returntheabstractoftherootlayer*/publicStringgetRootLayerAbstract();/***Setstheabstractoftherootlayer**@paramrootLayerAbstract*/publicvoidsetRootLayerAbstract(StringrootLayerAbstract);/***Setsthestatusofdynamicstyling(SLDandSLD_BODYparams)allowance**@paramdynamicStylesEnabled*/voidsetDynamicStylingDisabled(BooleandynamicStylesDisabled);/**@returnthestatusofdynamicstyling(SLDandSLD_BODYparams)allowance*/BooleanisDynamicStylingDisabled();/***IfsettoTRUEGetFeatureInforesultswillNOTbereprojected.**@paramfeaturesReprojectionDisabledfeaturesreprojectionallowance*/defaultvoidsetFeaturesReprojectionDisabled(booleanfeaturesReprojectionDisabled){//
ifnotimplementednothingisdone
ifGetFeatureInforesultsshouldNOTbereprojectedtothemapcoordinate*referencesystem.**@returnGetFeatureInfofeaturesreprojectionallowance*/defaultbooleanisFeaturesReprojectionDisabled(){//deactivatefeaturesreprojectionbydefaultreturntrue;
ifnotimplementednothingisdone}}
if<code>schemaBaseUrl</code>isnull;*/publicGetCapabilitiesTransformer(WMSwms,StringbaseURL,Set<String>getMapFormats,Set<String>getLegendGraphicFormats,Collection<ExtendedCapabilitiesProvider>extCapsProviders){super();Assert.notNull(wms);Assert.notNull(baseURL,"baseURL");Assert.notNull(getMapFormats,"getMapFormats");Assert.notNull(getLegendGraphicFormats,"getLegendGraphicFormats");this.wmsConfig=wms;this.getMapFormats=getMapFormats;this.getLegendGraphicFormats=getLegendGraphicFormats;this.baseURL=baseURL;this.extCapsProviders=extCapsProviders==null?Collections.EMPTY_LIST:extCapsProviders;this.setNamespaceDeclarationEnabled(false);setIndentation(2);finalCharsetencoding=wms.getCharSet();setEncoding(encoding);
ifitisthrownby<code>super.createTransformer()</code>*/@OverridepublicTransformercreateTransformer()throwsTransformerException{Transformertransformer=super.createTransformer();StringdtdUrl=buildSchemaURL(baseURL,"wms/1.1.1/WMS_MS_Capabilities.dtd");transformer.setOutputProperty(OutputKeys.DOCTYPE_SYSTEM,dtdUrl);returntransformer;
if{@codeo}isnotoftheexpectedtype*/publicvoidencode(Objecto)throwsIllegalArgumentException{
if(!(oinstanceofGetCapabilitiesRequest)){thrownewIllegalArgumentException();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(newStringBuffer("producingacapabilitiesdocumentfor").append(request).toString());
if(onlineResource==null||onlineResource.trim().length()==0){StringrequestBaseUrl=request.getBaseUrl();onlineResource=buildURL(requestBaseUrl,null,null,URLType.SERVICE);
else{try{newURL(onlineResource);
if(keywords!=null){for(Iterator<KeywordInfo>it=keywords.iterator();it.hasNext();){element("Keyword",it.next().getValue());
if(metadataURLs==null){return;
if(!SUPPORTED_MDLINK_TYPES.contains(link.getMetadataType())){continue;
if(dataURLs==null){return;
if(sortedFormats.contains("image/png")){sortedFormats.remove("image/png");sortedFormats.add(0,"image/png");
if(getUrl!=null){start("Get");element("OnlineResource",null,orAtts);end("Get");
if(postUrl!=null){orAtts.setAttribute(2,"","xlink:href","xlink:href","",postUrl);start("Post");element("OnlineResource",null,orAtts);end("Post");
if(JSONType.isJsonpEnabled()){element("Format",JSONType.jsonp);
ifit'stherebutnotdeclaredintheinternalDTD*/intnumberRoots=0;for(ExtendedCapabilitiesProvidercp:extCapsProviders){List<String>roots=cp.getVendorSpecificCapabilitiesRoots(request);
if(roots!=null){numberRoots+=roots.size();
if(numberRoots==0){return;
ifthereareatleast*acommonone,asneededbythespec:"<i>TherootLayerelementshallincludeasequence*ofzeroormore&lt;SRS&gt;elementslistingallSRSesthatarecommontoallsubsidiary*layers.UseasingleSRSelementwithemptycontent(likeso:"&lt;SRS&gt;&lt;/SRS&gt;")*
ifthereisnocommonSRS."</i>**<p>Bytheotherhand,thissearchisalsousedtocollectothewholelatlonbbox,as*statedbythespec:<i>"TheboundingboxmetadatainCapabilitiesXMLspecifytheminimum*enclosingrectangleforthelayerasawhole."</i>**@taskTODO:managethisdifferentlywhenwehavethelayerlistoftheWMSservice*decoupledfromthefeaturetypesconfiguredfortheserverinstance.(Thisinvolves*nestedlayers,gridcoverages,etc)*/privatevoidhandleLayers(){start("Layer");finalList<LayerInfo>layers;//filterthelayers
ifanamespacefilterhasbeenset
if(request.getNamespace()!=null){finalList<LayerInfo>allLayers=wmsConfig.getLayers();layers=newArrayList<LayerInfo>();Stringnamespace=wmsConfig.getNamespaceByPrefix(request.getNamespace());for(LayerInfolayer:allLayers){Namename=layer.getResource().getQualifiedName();
if(name.getNamespaceURI().equals(namespace)){layers.add(layer);
else{layers=wmsConfig.getLayers();
if(StringUtils.isBlank(serviceInfo.getRootLayerTitle())){element("Title",serviceInfo.getTitle());
else{element("Title",serviceInfo.getRootLayerTitle());
if(StringUtils.isBlank(serviceInfo.getRootLayerAbstract())){element("Abstract",serviceInfo.getAbstract());
else{element("Abstract",serviceInfo.getRootLayerAbstract());
if(srsList!=null){srs.addAll(srsList);
if(epsgCodes.isEmpty()){comment("AllsupportedEPSGprojections:");capabilitiesCrsIdentifiers=newLinkedHashSet<String>();for(Stringcode:CRS.getSupportedCodes("AUTO")){
if("WGS84(DD)".equals(code))continue;capabilitiesCrsIdentifiers.add("AUTO:"+code);
else{comment("LimitedlistofEPSGprojections:");capabilitiesCrsIdentifiers=newLinkedHashSet<String>(epsgCodes);
if(!"WGS84(DD)".equals(code)){currentSRS=qualifySRS(code);element("SRS",currentSRS);
if(layerBbox!=null)latlonBbox.expandToInclude(layerBbox);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("SummarizedLatLonBBoxis"+latlonBbox);
if(!layer.isEnabled()){returnfalse;
if(layer.enabled()&&!layersAlreadyProcessed.contains(layer)&&isExposable(layer)){try{mark();handleLayer(layer);commit();
if(skipping){reset();LOGGER.log(Level.WARNING,"Errorwritingmetadata;skippinglayer:"+layer.getName(),e);
else{//reportwhatlayerwefailedontohelptheadminlocateandfixitthrownewServiceException("Erroroccurredtryingtowriteoutmetadataforlayer:"+layer.getName(),e);
if(cascaded!=null){qatts.addAttribute("","cascaded","cascaded","",String.valueOf(cascaded));
if(bbox!=null){handleBBox(bbox,srs);handleAdditionalBBox(bbox,srs,layer);
if(layer.getType()==PublishedType.VECTOR){dimensionHelper.handleVectorLayerDimensions(layer);
else
if(layer.getType()==PublishedType.RASTER){dimensionHelper.handleRasterLayerDimensions(layer);
else
if(layer.getType()==PublishedType.WMTS){dimensionHelper.handleWMTSLayerDimensions(layer);
if(layer.getResource()instanceofWMSLayerInfo||layer.getResource()instanceofWMTSLayerInfo){//donothingforthemoment,wemaywanttolistthesetofcascadednamedstyles//inthefuture(whenweaddsupportforthat)
else{//addthelayerstylestart("Style");StyleInfodefaultStyle=layer.getDefaultStyle();
if(defaultStyle==null){thrownewNullPointerException("Layer"+layer.getName()+"hasnodefaultstyle");
if(ftStyle.getDescription()!=null){
if(ftStyle.getDescription().getTitle()!=null){element("Title",ftStyle.getDescription().getTitle());
else{//TitleisnotrequiredbytheSLDspec,butitisrequired//bytheWMS1.1DTDsowehavetoprovidesomething.element("Title",styleInfo.prefixedName());
if(is!=null){element(element,is.toString());
iftheminandmaxdenominatorshave//gotthedefault//valuestheScaleHintelementisnotgenerated
if((scaleDenominators.getMinimum()==0.0)&&(scaleDenominators.getMaximum()==Double.POSITIVE_INFINITY)){return;
if(scaleUnitPixel){//makesthescalehintcomputationtakingintoaccounttheOGCstandardized//renderingpixelsize"thatis0.28mm×0.28mm(millimeters).minScaleHint=CapabilityUtil.computeScaleHint(scaleDenominators.getMinValue());maxScaleHint=CapabilityUtil.computeScaleHint(scaleDenominators.getMaxValue());
else{minScaleHint=scaleDenominators.getMinValue();maxScaleHint=scaleDenominators.getMaxValue();
if(srs.indexOf(':')==-1){srs=EPSG+srs;
if(!LayerGroupInfo.Mode.CONTAINER.equals(layerGroup.getMode())){element("Name",layerName);
if(StringUtils.isEmpty(layerGroup.getTitle())){element("Title",layerName);
else{element("Title",layerGroup.getTitle());
if(StringUtils.isEmpty(layerGroup.getAbstract())){element("Abstract","Layer-Grouptypelayer:"+layerName);
else{element("Abstract",layerGroup.getAbstract());
if(LayerGroupInfo.Mode.EO.equals(layerGroup.getMode())){LayerInforootLayer=layerGroup.getRootLayer();//handledimensions
if(rootLayer.getType()==PublishedType.VECTOR){dimensionHelper.handleVectorLayerDimensions(rootLayer);
else
if(rootLayer.getType()==PublishedType.RASTER){dimensionHelper.handleRasterLayerDimensions(rootLayer);
if(metadataLinks==null||metadataLinks.isEmpty()){//Aggregatedmetadatalinks(seeGEOS-4500)Set<MetadataLinkInfo>aggregatedLinks=newHashSet<MetadataLinkInfo>();for(LayerInfolayer:Iterables.filter(layerGroup.getLayers(),LayerInfo.class)){List<MetadataLinkInfo>metadataLinksLayer=layer.getResource().getMetadataLinks();
if(metadataLinksLayer!=null){aggregatedLinks.addAll(metadataLinksLayer);
if(LayerGroupInfo.Mode.OPAQUE_CONTAINER.equals(layerGroup.getMode())){//justhidethelayersinthegrouplayersAlreadyProcessed.addAll(layerGroup.layers());
else
if(!LayerGroupInfo.Mode.SINGLE.equals(layerGroup.getMode())){for(PublishedInfochild:layerGroup.getLayers()){
if(childinstanceofLayerInfo){LayerInfolayer=(LayerInfo)child;
if(isExposable(layer)){handleLayer((LayerInfo)child);layersAlreadyProcessed.add((LayerInfo)child);
else{handleLayerGroup((LayerGroupInfo)child,layersAlreadyProcessed);
if(layerGroups==null||layerGroups.size()==0){returnlayersAlreadyProcessed;
if(skipping){
if(layerGroup!=null){LOGGER.log(Level.WARNING,"Skippinglayergroup"+layerGroup.getName()+"asitscapsdocumentelementfailedtogenerate",e);
else{LOGGER.log(Level.WARNING,"Skippinganulllayergroupduringcapsduringcapsdocumentgeneration",e);
else{thrownewServiceException("Erroroccurredtryingtowriteoutmetadataforlayergroup:"+layerGroup.getName(),e);
if(piinstanceofLayerGroupInfo){result.remove(pi);
if(attribution!=null){Stringtitle=attribution.getTitle();Stringurl=attribution.getHref();StringlogoURL=attribution.getLogoURL();StringlogoType=attribution.getLogoType();intlogoWidth=attribution.getLogoWidth();intlogoHeight=attribution.getLogoHeight();booleantitleGood=(title!=null),urlGood=(url!=null),logoGood=(logoURL!=null&&logoType!=null&&logoWidth>0&&logoHeight>0);
if(titleGood||urlGood||logoGood){start("Attribution");
if(titleGood)element("Title",title);
if(urlGood){AttributesImplurlAttributes=newAttributesImpl();urlAttributes.addAttribute("","xmlns:xlink","xmlns:xlink","",XLINK_NS);urlAttributes.addAttribute(XLINK_NS,"type","xlink:type","","simple");urlAttributes.addAttribute(XLINK_NS,"href","xlink:href","",url);element("OnlineResource",null,urlAttributes);
if(logoGood){AttributesImpllogoAttributes=newAttributesImpl();logoAttributes.addAttribute("","","height","",""+logoHeight);logoAttributes.addAttribute("","","width","",""+logoWidth);start("LogoURL",logoAttributes);element("Format",logoType);AttributesImplurlAttributes=newAttributesImpl();urlAttributes.addAttribute("","xmlns:xlink","xmlns:xlink","",XLINK_NS);urlAttributes.addAttribute(XLINK_NS,"type","xlink:type","","simple");urlAttributes.addAttribute(XLINK_NS,"href","xlink:href","",logoURL);element("OnlineResource",null,urlAttributes);end("LogoURL");
ifany,ortotheproper*GetLegendGraphicoperation
ifanURLwasnotsuppliedbyconfigurationfile.**<p>ItiscommonpracticetosupplyaURLtoaWMSaccesiblelegendgraphicwhenitis*difficulttocreateadynamiclegendforalayer.**@paramftTheFeatureTypeInfothatholdsthelegendURLtowriteout,or<code>null</code>*
ifdynamicallygenerated.*@taskTODO:figureouthowtounhacklegendparameterssuchasWIDTH,HEIGHTandFORMAT*/protectedvoidhandleLegendURL(LayerInfolayer,LegendInfolegend,StyleInfostyle,StyleInfosampleStyle){
if(legend!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("usingusersuppliedlegendURL");
if(styleWs!=null){legendUrl=buildURL(request.getBaseUrl(),appendPath("styles",styleWs.getName(),legend.getOnlineResource()),null,URLType.RESOURCE);
else{legendUrl=buildURL(request.getBaseUrl(),appendPath("styles",legend.getOnlineResource()),null,URLType.RESOURCE);
else{intlegendWidth=GetLegendGraphicRequest.DEFAULT_WIDTH;intlegendHeight=GetLegendGraphicRequest.DEFAULT_HEIGHT;
if(sampleStyle!=null){//delegatetolegendSamplethecalculusofproperlegendsizefor//thegivenstyleDimensiondimension;try{dimension=legendSample.getLegendURLSize(sampleStyle);
if(dimension!=null){legendWidth=(int)dimension.getWidth();legendHeight=(int)dimension.getHeight();
if(null==wmsConfig.getLegendGraphicOutputFormat(defaultFormat)){
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning(newStringBuffer("Defaultlegendformat(").append(defaultFormat).append(")isnotsupported(jainotavailable?),can'taddLegendURLelement").toString());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AddingGetLegendGraphiccallasLegendURL");
if(style!=null){params.put("style",style.getName());
if(serviceInfo.isBBOXForEachCRS()&&!serviceInfo.getSRS().isEmpty()){//outputboundingboxforeachsupportedservicesrsfor(Stringcrs:serviceInfo.getSRS()){crs=qualifySRS(crs);
if(srs!=null&&crs.equals(srs)){continue;//alreadydidthisone
if(handler==null){//Stillnoluck.ReporttheoriginalissueLOGGER.warning(String.format("Unabletotransformboundingboxfor'%s'layer"+"to%s",layer!=null?layer.getName():"root",crs));
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,e.getLocalizedMessage(),e);
else{ReferencedEnvelopetbbox=handler.transformEnvelope(bbox,targetCrs);handleBBox(tbbox,crs);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,e1.getLocalizedMessage(),e1);
if(authorityURLs==null||authorityURLs.isEmpty()){return;
if(name==null||href==null){LOGGER.warning("IgnoringAuthorityURL,name:"+name+",href:"+href);continue;
if(identifiers==null||identifiers.isEmpty()){return;
if(authority==null||id==null){LOGGER.warning("IgnoringlayerIdentifier,authority:"+authority+",identifier:"+id);continue;
if(result!=null){returnresult;
if(geom!=null&&geom.isEmpty()){result.setDefaultGeometry(null);
ifcancelled,thenreportnomorefeatures*/@OverridepublicbooleanhasNext(){
if(monitor.isCanceled()){returnfalse;
if(sessionMappingStorage==null){sessionMappingStorage=GeoServerCasAuthenticationFilter.getHandler().getSessionMappingStorage();
if(file.isDirectory()){contents=file.listFiles();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;Watchother=(Watch)obj;
if(file==null){
if(other.file!=null)returnfalse;
else
if(!file.equals(other.file))returnfalse;
if(path==null){
if(other.path!=null)returnfalse;
else
if(!path.equals(other.path))returnfalse;returntrue;
if(!file.exists()){
if(exsists){exsists=false;
if(contents!=null){//deletedirectoryList<File>deleted=Arrays.asList(contents);this.last=now;this.contents=null;returnnewDelta(file,Kind.ENTRY_DELETE,null,deleted,null);
else{//filehasbeendeleted!this.last=now;returnnewDelta(file,Kind.ENTRY_DELETE);
else{returnnull;//nochangefilestilldeleted!
if(file.isFile()){longfileModified=file.lastModified();
if(fileModified>last||!exsists){
if(exsists){this.last=fileModified;returnnewDelta(file,Kind.ENTRY_MODIFY);
else{exsists=true;this.last=fileModified;returnnewDelta(file,Kind.ENTRY_CREATE);
else{returnnull;//nochange!
if(file.isDirectory()){Kindkind=null;longfileModified=file.lastModified();
if(fileModified>last||!exsists){kind=exsists?Kind.ENTRY_MODIFY:Kind.ENTRY_CREATE;exsists=true;
else{//booleanwin=System.getProperty("os.name").startsWith("Windows");//if(!win){////notwindows-sononeedtocheckdirectorycontents//returnnull;//nochange//
if(!removed.isEmpty()){fileModified=Math.max(fileModified,last+1);
if(checkModified>last){modified.add(check);fileModified=Math.max(fileModified,checkModified);
if(kind==null){
if(removed.isEmpty()&&created.isEmpty()&&modified.isEmpty()){//winonlycheckofdirectorycontentsreturnnull;//nochangetodirectorycontents
else{kind=Kind.ENTRY_MODIFY;
if(this.file==null){
if(file!=null){returnfalse;
else
if(!this.file.equals(file)){returnfalse;
if(this.path==null){
if(path!=null){returnfalse;
else
if(!this.path.equals(path)){returnfalse;
if(watch.getListeners().isEmpty()){watchers.remove(watch);continue;
if(delta!=null){/**Createdbasedoncreated/removed/modifiedfiles*/List<ResourceNotification.Event>events=ResourceNotification.delta(watch.file,delta.created,delta.removed,delta.modified);ResourceNotificationnotify=newResourceNotification(watch.getPath(),delta.kind,watch.last,events);for(ResourceListenerlistener:watch.getListeners()){try{listener.changed(notify);
if(file==null||path==null){returnnull;
if(watch.isMatch(file,path)){returnwatch;
if(file==null){thrownewNullPointerException("Filetowatchisrequired");
if(path==null){thrownewNullPointerException("Pathfornotificationisrequired");
if(watch==null){watch=newWatch(file,path);watchers.add(watch);
if(monitor==null){monitor=pool.scheduleWithFixedDelay(sync,delay,delay,unit);
if(file==null){thrownewNullPointerException("Filetowatchisrequired");
if(path==null){thrownewNullPointerException("Pathfornotificationisrequired");
if(watch!=null){watch.removeListener(listener);
if(watch.getListeners().isEmpty()){removed=watchers.remove(watch);
if(removed&&watchers.isEmpty()){
if(monitor!=null){monitor.cancel(false);//stopwatchingnobodyislookingmonitor=null;
if(monitor!=null){monitor.cancel(false);monitor=pool.scheduleWithFixedDelay(sync,delay,delay,unit);
ifthe*passwordwasencrypted,ortheoriginalone,
ifthepasswordwasplaintext*/publicJDBCConfigurationunencryptPassword(JDBCConfigurationconfiguration){
if(configuration.getConnectionPool()!=null&&configuration.getConnectionPool().getPassword()!=null){Stringpassword=configuration.getConnectionPool().getPassword();try{Stringdecoded=passwords.decode(password);configuration=cloneAndSetPassword(configuration,decoded);
ifnotnull,usingtheGeoServerpasswordencoders.**@paramconfigurationAdeepcopyoftheconfiguration,withthepasswordencoded*/publicJDBCConfigurationencryptPassword(JDBCConfigurationconfiguration){ConnectionPoolConfigurationpool=configuration.getConnectionPool();
if(pool!=null&&pool.getPassword()!=null){Stringpassword=pool.getPassword();Stringencoded=passwords.encode(password);configuration=cloneAndSetPassword(configuration,encoded);
ifit'sempty,theydidn'tprovideanameorIdcheckArgument(!Strings.isNullOrEmpty(name),"NoGeoGigrepositoryNameorIDspecified");returnname;
if(info!=null){//getthenativeRepositoryResolverforthelocationandopenitdirectly//UsingtheRepositryManagertogettherepowouldcausetherepotobemanagedbythe//RepositoryManager,//whenthisreposhouldbemanagedbytheDataStore.TheDataStorewillclosethisrepo//instancewhen//GeoServerdecidestodisposetheDataStore.Repositoryrepo=RepositoryResolver.load(info.getLocation());checkState(repo.isOpen(),"RepositoryManagerreturnedaclosedrepositoryfor%s",name);returnrepo;
else{//didn'tfindarepoRepositoryConnectionExceptionrce=newRepositoryConnectionException("NoGeoGigrepositoryfoundwithNAMEorID:"+name);throwrce;
if(notification!=null){for(MessageProcessormessageProcessor:messageProcessors){messageProcessor.process(notification);
ifasetofvalidattributeis*provided,thattheexpressiononlyusesthoseattributes**@authorAndreaAime-GeoSolutions*/publicclassECQLValidatorimplementsIValidator<String>{privatestaticfinallongserialVersionUID=2268953695122233556L;Set<String>validAttributes;publicECQLValidatorsetValidAttributes(String...validAttributes){this.validAttributes=newLinkedHashSet<>(Arrays.asList(validAttributes));returnthis;
if(expression==null||expression.isEmpty()||expression.trim().isEmpty()){return;
if(ecql!=null&&validAttributes!=null){FilterAttributeExtractorfilter=newFilterAttributeExtractor();ecql.accept(filter,null);//Extractionoftheattributes,andfilteroutthevalidonesList<String>invalids=newArrayList<>(Arrays.asList(filter.getAttributeNames()));invalids.removeAll(validAttributes);//
ifandonly
ifaninvalidattributeispresent
if(!invalids.isEmpty()){StringinvalidList=commaSeparated(invalids);StringvalidList=commaSeparated(validAttributes);ValidationErrorerror=newValidationError(this);error.setVariable("expression",expression);error.setVariable("invalidAttributes",invalidList);error.setVariable("validAttributes",validList);error.setMessage("ecql.invalidAttributes");iv.error(error);
if(filterChain.getRequestChainByName(PROXYRECEPTORCHAIN)!=null)return;RequestFilterChaincasChain=newConstantFilterChain(GeoServerCasConstants.CAS_PROXY_RECEPTOR_PATTERN,GeoServerCasConstants.CAS_PROXY_RECEPTOR_PATTERN+"/");casChain.setFilterNames(pgtCallback.getName());casChain.setName(PROXYRECEPTORCHAIN);filterChain.getRequestChains().add(0,casChain);}}
if(df.canRead(fileData)){returndf;
ifformat%scanreadfile%s,"+df.getName(),file.getPath()),e);
if(factory!=null){returnnewDataStoreFormat(factory);
if(formats.size()>1){for(AbstractGridFormatf:formats){//preferGeoTIFFoverWorldImageFormat
if("GeoTIFF".equals(f.getName())){format=f;break;
if(format==null){thrownewRuntimeException("multipleformatsfoundbutnothandled"+formats);
else
if(formats.size()==1){format=formats.iterator().next();
if(format!=null&&!(formatinstanceofUnknownFormat)){returnnewGridFormat(format);
if(factory!=null){returnnewDataStoreFormat(factory);
ifapplicable.**@returnTherelativepath,ortheoriginalpath
ifitdoesnotcontainthedatadirectory*/protectedStringrelativeDataFileURL(Stringurl,Catalogcatalog){
if(catalog==null){returnurl;
ifwe'veuncoveredacausethatisaninstanceof//org.postgresql.util.PSQLException.booleanpsqlCauseFound=false;//startdiggingThrowablecause=t;while(cause!=null){//GetthetypeoftheThrowableClassclazz=cause.getClass();//IfwehaveanUnknownHostException,we'redone
if(UnknownHostException.class.isAssignableFrom(clazz)){return"UnknownHostException:"+cause.getLocalizedMessage();
ifwehaven'talreadyfoundaPSQLException,see
ifthiscauseisone.
if(!psqlCauseFound&&PSQLException.class.isAssignableFrom(clazz)){//it'saPSQLException,andit'sthefirstonefoundpsqlCauseFound=true;message=cause.getLocalizedMessage();
ifthespecwasnullorempty*/publicstaticAcceptableRangegetAcceptableRange(Stringspec,ClassdataType)throwsParseException{
if(spec==null||spec.trim().isEmpty()){returnnull;
if(split.length>2){thrownewIllegalArgumentException("Invalidacceptablerangespecification,mustbeeitherasingle"+"value,ortwovaluessplitbyaforwardslash");
if(split.length==2){after=parseValue(split[1],dataType);
if(before.doubleValue()==0&&after.doubleValue()==0){returnnull;
if(Date.class.isAssignableFrom(dataType)){returnTimeParser.parsePeriod(s);
if(valueinstanceofRange){Rangerange=(Range)value;Rangebefore=getSearchRangeOnSingleValue(range.getMinValue());Rangeafter=getSearchRangeOnSingleValue(range.getMaxValue());returnbefore.union(after);
else{returngetSearchRangeOnSingleValue(value);
if(Date.class.isAssignableFrom(dataType)){Datecenter=(Date)value;Calendarcal=Calendar.getInstance();cal.setTime(center);cal.setTimeInMillis(cal.getTimeInMillis()-before.longValue());Datemin=cal.getTime();cal.setTime(center);cal.setTimeInMillis(cal.getTimeInMillis()+after.longValue());Datemax=cal.getTime();returnnewDateRange(min,max);
if(items.indexOf(entry)==0){tag.put("style","visibility:hidden");
else{tag.put("style","visibility:visible");
if(items.indexOf(entry)==items.size()-1){tag.put("style","visibility:hidden");
else{tag.put("style","visibility:visible");
if(null==geometryDescriptor){continue;
if(!(pinstanceofAttribute)||(pinstanceofGeometryAttribute)){continue;
if(pinstanceofComplexAttribute){value=getProperties((ComplexAttribute)p);
else{value=p.getValue();
if(value!=null){props.put(name,value);
if(finalGeom.isEmpty()){continue;
if(LOGGER.isLoggable(Level.FINE)){Stringmsg=String.format("Added%,doutof%,dfeaturesof'%s'in%s",count,total,layer.getTitle(),sw);//System.err.println(msg);LOGGER.fine(msg);
if(includeIgnore){result.add(EoLayerType.IGNORE);
if(asynchronous){Resourcetmp=resourceManager.getTemporaryResource(".bin");IOUtils.copy(input,tmp.out());returnnewResourceRawData(tmp,mimeType);
else{returnnewStreamRawData(mimeType,input);
if(valueinstanceofRawDataEncoderDelegate){rd=((RawDataEncoderDelegate)value).getRawData();
else{rd=(RawData)value;
if(rd==null||rd.getFileExtension()==null){returnAbstractRawData.DEFAULT_EXTENSION;
else{returnrd.getFileExtension();
if(i!=-1){Stringp=path.substring(i+1);
if(GS_PROPERTIES.matcher(p).matches()){try{//processtheclasspathforpropertyfilesEnumeration<URL>urls=getClass().getClassLoader().getResources(p);//buildupasinglepropertiesfilePropertiesproperties=newProperties();while(urls.hasMoreElements()){URLurl=urls.nextElement();InputStreamin=url.openStream();properties.load(in);in.close();
else
if(GS_LOCAL_I18N.matcher(path).matches()){returnnull;
else
if(path.matches("org/geoserver/.*"+clazz.getName()+".*_.*.html")){returnnull;
iftheresourceunderthegeoserverorwicketnamespace?
if(path.startsWith("org/geoserver")||path.startsWith("org/apache/wicket")){Stringext=extension;
if(ext==null){//noextensionpassedin,stripitfromthepathext=FilenameUtils.getExtension(path);
if(ext!=null){//wehaveanextension,lookitupinthewhitelistextensions=PREFIXES.get(ext);
if(extensions!=null){//ensurethepathdoesn'tcontaintheextension,sometimesthismethodiscalledwith//extension==null,//inwhichcasetheextensionisusuallyinthepathpath=FilenameUtils.getPathNoEndSeparator(path)+"/"+FilenameUtils.getBaseName(path);returnnewResourceNameIterator(path,style,variation,null,extensions,false);
if(m.getTimeMode()!=TimeMode.NONE){//setupthetimedimensionobjectfor(ImportTasktask:tasks){DimensionInfodim=newDimensionInfoImpl();dim.setEnabled(true);dim.setAttribute("time");dim.setPresentation(DimensionPresentation.LIST);dim.setUnits("ISO8601");//TODO:isthereanenumerationforthis?ResourceInfor=task.getLayer().getResource();r.getMetadata().put(ResourceInfo.TIME,dim);
if(value==null){returnnull;
else{String[]strings=StringUtils.split(value,"\r\n");returnArrays.asList(strings);
if(i.hasNext()){sb.append(i.next());
if(List.class.isAssignableFrom(type)){return(IConverter<S>)CONVERT;
if(!canHandle(descriptor)){thrownewIllegalArgumentException("Cannothandleschema"+descriptor.getName());
if(csw.isCanonicalSchemaLocation()){schemaLocationRoot="http://schemas.opengis.net";
else{schemaLocationRoot=buildSchemaURL(request.getBaseUrl(),"");//removethetrailing/schemaLocationRoot=schemaLocationRoot.substring(0,schemaLocationRoot.length()-1);
if(statusObjinstanceofInteger){status=(Integer)statusObj;
if(headersObjinstanceofScriptableObject){headers=(ScriptableObject)headersObj;
if(bodyObjinstanceofString){//belenientandconvertstringstoarraysObject[]array={(String)bodyObj};Contextcx=CommonJSEngine.enterContext();try{bodyObj=cx.newArray(scope,array);
if(bodyObjinstanceofScriptable){body=(Scriptable)bodyObj;ObjectforEachObj=body.get("forEach",body);
if(forEachObjinstanceofFunction){forEach=(Function)forEachObj;
else{NativeArraybodyArray=null;
if(bodyinstanceofNativeArray){bodyArray=(NativeArray)body;
if(bodyArray!=null){forEach=(Function)bodyArray.getPrototype().get("forEach",bodyArray);
if(forEach==null){thrownewRuntimeException("JSGIappmustreturnanobjectwitha'body'memberthathasa'forEach'function.");
if(headers!=null){for(Objectid:headers.getIds()){Stringname=id.toString();Stringvalue=headers.get(name,headers).toString();
if(!name.equalsIgnoreCase("content-type")){response.addHeader(name,value);
if(type==null){mediaType=MediaType.TEXT_PLAIN;
else{mediaType=newMediaType(type);
if(partinstanceofString){bytes=((String)part).getBytes();
else{LOGGER.severe("Unsupportedresponsebodytype:"+part.toString());
if(bytes!=null){try{outputStream.write(bytes);
if(serializer.name.equals(nodeName)){try{sender=serializer.clazz.newInstance();sender=(NotificationSender)context.convertAnother(sender,serializer.clazz);break;
if(filterUser(user)!=null){delegateAsStore().addUser(user);
if(filterUser(user)!=null){delegateAsStore().updateUser(user);
if(filterUser(user)!=null){returndelegateAsStore().removeUser(user);
if(filterGroup(group)!=null){delegateAsStore().addGroup(group);
if(filterGroup(group)!=null){delegateAsStore().updateGroup(group);
if(filterGroup(group)!=null){returndelegateAsStore().removeGroup(group);
iftryingtoaddtofilteredgroup
if(filterUser(user)!=null&&filterGroup(group)!=null){delegateAsStore().associateUserToGroup(user,group);
iftryingtoaddtofilteredgroup
if(filterUser(user)!=null&&filterGroup(group)!=null){delegateAsStore().disAssociateUserFromGroup(user,group);
if(filterUser(it.next())==null){it.remove();
if(filterGroup(it.next())==null){it.remove();
if(steps.size()==1&&steps.get(0).getName().getLocalPart().equalsIgnoreCase("AnyText")){Expressionresult=ff.literal("");for(CatalogStoreMappingElementelement:mapping.elements()){ExpressionfieldIgnoreNull=ff.function("if_then_else",ff.function("isNull",element.getContent()),ff.literal(""),element.getContent());result=ff.function("strConcat",result,ff.function("strConcat",ff.literal(""),fieldIgnoreNull));
if(path.equalsIgnoreCase(rd.getBoundingBoxPropertyName())){returnff.property("boundingBox");
if(element==null){thrownewIllegalArgumentException("Unknownfieldinmapping:"+expression);
if(getDriverClassName()==null){synchronized(this){
if(getDriverClassName()==null){initializeDataSource();
if(dbprops.getType()!=Type.RESOURCE){//usethedefaultparametersandsavethemoutOutputStreamfout=dbprops.out();try{defaultParameters.store(fout,null);
else{InputStreamin=dbprops.in();db.load(in);in.close();
if(db.containsKey("username")){setUsername(db.getProperty("username"));
if(db.containsKey("password")){setPassword(db.getProperty("password"));
if(!getManager().checkAuthenticationForRole(SecurityContextHolder.getContext().getAuthentication(),GeoServerRole.AUTHENTICATED_ROLE))//yes,forbackwardscompat,it'sreallyMETHOD_NOT_ALLOWEDthrownewRestException("Amdinistrativeprivelgesrequired",HttpStatus.METHOD_NOT_ALLOWED);try{//LookfortheservicethathandlesthecurrentuserStringuserName=SecurityContextHolder.getContext().getAuthentication().getName();GeoServerUserGroupServiceugService=null;for(GeoServerUserGroupServiceservice:getManager().loadUserGroupServices()){
if(service.getUserByUsername(userName)!=null){ugService=service;break;
if(ugService==null){thrownewRestException("Cannotcalculate
ifPUTisallowed(servicenotfound)",HttpStatus.UNPROCESSABLE_ENTITY);
ifPUTisallowed("+e.getMessage()+")",HttpStatus.UNPROCESSABLE_ENTITY,e);
if(StringUtils.isBlank(newpass))thrownewRestException("Missing'"+UP_NEW_PW+"'",HttpStatus.BAD_REQUEST);GeoServerUseruser=null;GeoServerUserGroupServiceugService=null;try{//LookfortheauthenticationserviceStringuserName=SecurityContextHolder.getContext().getAuthentication().getName();for(GeoServerUserGroupServiceservice:getManager().loadUserGroupServices()){user=service.getUserByUsername(userName);
if(user!=null){ugService=service;break;
if(ugService==null){thrownewRestException("Userservicenotfound",HttpStatus.FAILED_DEPENDENCY);
iftheproviderallowsupdates
if(!ugService.canCreateStore()){thrownewRestException("Userservicedoesnotsupportchangingpw",HttpStatus.FAILED_DEPENDENCY);
switchandpagesubmitworkflowfunctionproperly*/@SuppressWarnings("serial")publicclassResourceConfigurationPanelextendsPanel{protectedstaticLoggerLOGGER=Logging.getLogger(ResourceConfigurationPanel.class);publicResourceConfigurationPanel(StringpanelId,IModelmodel){super(panelId,model);
ifitwas*previouslyscheduled.**<p>Batchesarescheduled
iftheyareACTIVE,ENABLEDandhaveaFREQUENCYset.Batcheswhich*areACTIVE,butnotENABLED_or_haveFREQUENCYsettoNULL,areknownbythequartz*schedulerbutarenevertriggeredunlessexplicitlydone.BatcheswhichareNOTACTIVE,are*entirelyremovedfromthequartzscheduler.**@parambatchthebatch.*@returnthesavedbatch.*/BatchsaveAndSchedule(Batchbatch);/**Refreshestheschedulercompletelybasedonallofthebatchesinthedatabase.*/voidreloadFromData();/***Savesthisconfigurationandupdatethescheduleaccordingtoitsnewsettingsofeachbatch.**@paramconfigtheConfiguration.*@returnthesavedconfig.*/ConfigurationsaveAndSchedule(Configurationconfig);/***Interruptabatchrun.Thismethodwillalsocheck
ifitcanverifythebatchrunhas*actuallyalreadyended(forexamplewhentheserverwasrestarted),and
ifthatisthecase*updateitsstatus.**@parambatchRunthebatchruntointerrupt*/voidinterrupt(BatchRunbatchRun);/***Startabatchrightnow.**@parambatch*@returna(unique)schedulerreferencethatcanbeusedtoidentifythebatchrun*/StringscheduleNow(Batchbatch);Configurationremove(Configurationconfig);Batchremove(Batchbatch);}
if(password!=null){user.setPassword(password);
if(enabled!=null){user.setEnabled(enabled);
if(request.targetCRS!=null){start("GridCRS");element("GridBaseCRS",epsgUrnCode(request.targetCRS));AffineTransformat=request.targetGridToWorld;
if(at.getTranslateX()==0&&at.getTranslateY()==0&&at.getShearX()==0&&at.getShearY()==0){//simplegridmodeelement("GridType","urn:ogc:def:method:WCS:1.1:2dSimpleGrid");element("GridOffsets",at.getScaleX()+""+at.getScaleY());
else{element("GridType","urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs");element("GridOrigin",at.getTranslateX()+""+at.getTranslateY());element("GridOffsets",at.getScaleX()+""+at.getShearX()+""+at.getShearY()+""+at.getScaleY());
if(LocalWorkspace.get()!=null){StyleInfostyle=super.getStyleByName(LocalWorkspace.get(),name);
if(style!=null){returnstyle;
if(LocalWorkspace.get()!=null){StringwsName=LocalWorkspace.get().getName();//prefixtheunqualifiedname
if(name.contains(":")){//namealreadyprefixed,ensureitisprefixedwiththecorrectone
if(name.startsWith(wsName+":")){//goodtogo,justpasscallthroughreturnwrap(super.getLayerByName(name));
else{//JD:perhapsstripofexistingprefix?
if(LocalWorkspace.get()!=null){//
iflocalworkspaceactivedroptheprefixreturngetLayerByName(name.getLocalPart());
else{returnsuper.getLayerByName(name);
if(useNameDequalifyingProxy()){returnNameDequalifyingProxy.createList(super.getLayers(),LayerInfo.class);
if(workspaceInfo==null){returnfalse;
if(LocalWorkspace.get()!=null){StringwsName=LocalWorkspace.get().getName();//prefixtheunqualifiedname
if(name.contains(":")){//namealreadyprefixed,ensureitisprefixedwiththecorrectone
if(name.startsWith(wsName+":")){//goodtogo,justpasscallthroughLayerGroupInfolayerGroup=super.getLayerGroupByName(name);
if(layerGroup!=null){returnwrap(layerGroup);
elsefallbackonunqualifiedlookup
else{//JD:perhapsstripofexistingprefix?
if(layerGroup!=null){returnwrap(layerGroup);
if(LocalWorkspace.get()!=null){
if(layerGroup.getWorkspace()!=null&&!LocalWorkspace.get().equals(layerGroup.getWorkspace())){returnnull;
if(obj==null){returnnull;
if(useNameDequalifyingProxy()){returnNameDequalifyingProxy.create(obj,clazz);
if(useNameDequalifyingProxy()){returnNameDequalifyingProxy.createList(layerGroups,LayerGroupInfo.class);
if("prefixedName".equals(method.getName())||"getPrefixedName".equals(method.getName())||"getName".equals(method.getName())){Stringval=(String)method.invoke(object,args);
if(val==null||val.indexOf(':')==-1){returnval;
ifpossible.**@see#wrap(Object,Class)*@seeorg.geoserver.catalog.Catalog#list(java.lang.Class,org.geoserver.catalog.Predicate,*java.lang.Integer,java.lang.Integer,org.geoserver.catalog.OrderBy)*/@Overridepublic<TextendsCatalogInfo>CloseableIterator<T>list(finalClass<T>of,finalFilterfilter,finalIntegeroffset,finalIntegercount,finalSortBysortBy){CloseableIterator<T>iterator=delegate.list(of,filter,offset,count,sortBy);
if(iterator.hasNext()&&useNameDequalifyingProxy()){returnCloseableIteratorAdapter.transform(iterator,obj->obj==null?null:NameDequalifyingProxy.create(obj,of));
if(LocalWorkspace.get()!=null){WorkspaceInfows=LocalWorkspace.get();NamespaceInfons=delegate.getNamespaceByPrefix(ws.getName());
if(ns!=null){returnns;
if(LocalWorkspace.get()!=null){returnLocalWorkspace.get();
if(parts[i].equals(WFS.NAMESPACE)){assertTrue(parts[i+1].endsWith("2.0/wfs.xsd"));
if(errors!=null&&errors.size()>0)throw(Exception)errors.get(0);returncaseInsensitiveKvp(input);
ifitdoesn'talreadyexistassertFalse(iconFile.exists());
ifitdoesn'talreadyexistassertFalse(iconFile.exists());
ifitdoesn'talreadyexistassertFalse(iconFile.exists());}}
if(store==null)returnnull;
elsereturn(DataAccess)SecuredObjects.secure(store,policy);
if(fc==null)returnnull;
elsereturn(FeatureCollection)SecuredObjects.secure(fc,policy);
if(fc==null){returnnull;
else{
if(limitedAttributeSize>0&&fc.getSchema().getDescriptors().size()>limitedAttributeSize){
if(fcinstanceofSimpleFeatureCollection){//thedatastoredidnothonourthequeryproperties??It'sbroken,butwecan//fixitSimpleFeatureCollectionsfc=(SimpleFeatureCollection)fc;SimpleFeatureTypetarget=SimpleFeatureTypeBuilder.retype(sfc.getSchema(),mixed.getPropertyNames());ReTypingFeatureCollectionretyped=newReTypingFeatureCollection(sfc,target);return(FeatureCollection)SecuredObjects.secure(retyped,policy);
else{//complexfeaturestoreeh?NowaytofixitatleastwarntheadminLOGGER.log(Level.SEVERE,"Complexstorereturnedmorepropertiesthanallowed"+"bysecurity(becausetheyarerequiredbytheschema)."+"Eitherthesecuritysetupisbrokenoryouhaveasecuritybreach");return(FeatureCollection)SecuredObjects.secure(fc,policy);
else{return(FeatureCollection)SecuredObjects.secure(fc,policy);
if(policy.getAccessLevel()==AccessLevel.HIDDEN||policy.getAccessLevel()==AccessLevel.METADATA){returnnewQuery(null,Filter.EXCLUDE);
else
if(policy.getLimits()==null){returnQuery.ALL;
else
if(policy.getLimits()instanceofVectorAccessLimits){VectorAccessLimitsval=(VectorAccessLimits)policy.getLimits();//Uglyhack:duringWFStransactionsthereadswedoareusedtocountthenumberof//features//wearedeleting/updating:usethewritefilterinsteadofthereadfilterRequestrequest=Dispatcher.REQUEST.get();
if(request!=null&&request.getService().equalsIgnoreCase("WFS")&&request.getRequest().equalsIgnoreCase("Transaction")){returnval.getWriteQuery();
else{returnval.getReadQuery();
else{thrownewIllegalArgumentException("SecureFeatureSourceshasbeenfed"+"withunexpectedAccessLimitsclass"+policy.getLimits().getClass());
if(securityProperties!=null&&securityProperties.size()>0){List<PropertyName>userProperties=userQuery.getProperties();
if(userProperties==null){result.setProperties(securityProperties);
else{for(PropertyNamepn:userProperties){
if(!securityProperties.contains(pn)){thrownewSecurityException("Attribute"+pn.getPropertyName()+"isnotavailable");
if(userQuery.getHints()==null){result.setHints(securityQuery.getHints());
else
if(securityQuery.getHints()==null){result.setHints(userQuery.getHints());
else{Hintsmix=userQuery.getHints();mix.putAll(securityQuery.getHints());result.setHints(mix);
if(SecurityContextHolder.getContext()!=null){SecurityContextHolder.getContext().setAuthentication(null);
if(!getManager().checkAuthenticationForAdminRole()){thrownewRestException("Amdinistrativeprivelgesrequired",HttpStatus.FORBIDDEN);
if(!getManager().checkAuthenticationForAdminRole()){//yes,forbackwardscompat,it'sreallyMETHOD_NOT_ALLOWEDthrownewRestException("Amdinistrativeprivelgesrequired",HttpStatus.METHOD_NOT_ALLOWED);
if(getManager().loadMasterPassswordProviderConfig(providerName).isReadOnly()){thrownewRestException("Masterpasswordproviderdoesnotallowwrites",HttpStatus.METHOD_NOT_ALLOWED);
if(!StringUtils.isNotBlank(current))thrownewRestException("nomasterpassword",HttpStatus.BAD_REQUEST);
if(!StringUtils.isNotBlank(newpass))thrownewRestException("nomasterpassword",HttpStatus.BAD_REQUEST);char[]currentArray=current.trim().toCharArray();char[]newpassArray=newpass.trim().toCharArray();GeoServerSecurityManagerm=getManager();try{m.saveMasterPasswordConfig(m.loadMasterPasswordConfig(),currentArray,newpassArray,newpassArray);
if(format.equals(outputFormat)||(outputFormat==null&&format.equals(BaseRequest.JSON_MIME))){linkType=Link.REL_SELF;linkTitle="Thisdocument";
if(featureType!=null){returnCollections.singleton(newCollectionDocument(request,featureType)).iterator();
if(next!=null){returntrue;
if(!hasNext){featureTypes.close();returnfalse;
else{try{FeatureTypeInfofeatureType=featureTypes.next();CollectionDocumentcollection=newCollectionDocument(request,featureType);next=collection;returntrue;
ifwehaveacomponentthatcalculatesasizewhichfitsintheimage,//doesitgetthatsize?dl.addBlock(newMapDecorationLayout.Block(newMockMapDecoration(newDimension(100,100),newRectangle(156,78,100,100)),MapDecorationLayout.Block.Position.CR,null,newPoint(0,0)));//
ifwehaveacomponentwithauser-mandatedsizewhichfitsintheimage,//doesitgetthatsize?dl.addBlock(newMapDecorationLayout.Block(newMockMapDecoration(newDimension(100,100),newRectangle(206,103,50,50)),MapDecorationLayout.Block.Position.CR,newDimension(50,50),newPoint(0,0)));dl.paint(g2d,newRectangle(0,0,256,256),null);
if(inputs==null){returnnull;
if(inputs.get(MONITOR)==null){returninputs;
if(listener!=null){Map<String,Parameter<?>>inputParams=hook.getInputs(fw.readIfModified());
if(inputParams.get(MONITOR)!=null){StatusMonitormonitor=newStatusMonitor(listener);Map<String,Object>inputReplacement=newHashMap<String,Object>(input);inputReplacement.put(MONITOR,monitor);input=inputReplacement;
if("idna".equals(arg0.toString())){//returnnewPyTuple(//newPyObject(){//publicPyObject__call__(PyObjectv){//returnnewPyTuple(new//PyString(IDN.toUnicode(v.toString())),newPyInteger(0));//
if(o!=null&&oinstanceofClass){clazz=(Class)o;
if(clazz!=null&&PyObject.class.isAssignableFrom(clazz)){try{PyObjectpyobj=(PyObject)clazz.newInstance();Objectobj=pyobj.__tojava__(Object.class);
if(obj!=null){clazz=obj.getClass();
if(clazz!=null&&PyObject.class.isAssignableFrom(clazz)){Classjclass=pyToJava.get(clazz);
if(jclass!=null){clazz=jclass;
if(clazz!=null&&clazz.getName().startsWith("org.python.proxies")){//getbasetypePyTypebase=(PyType)type.getBase();Classc=toJavaClass(base);
if(c!=null){clazz=c;
if(whitelistProp!=null){String[]wildcards=whitelistProp.split("\\s+|(\\s*;\\s*)");this.allowTypesByWildcard(wildcards);
if(original.getTypeName().equals(MockData.PRIMITIVEGEOFEATURE.getLocalPart()))returnprimitive;
elsereturnsuper.transformFeatureType(original);
if(originalName.equals(MockData.PRIMITIVEGEOFEATURE.getLocalPart()))returnprimitive.getTypeName();
elsereturnsuper.transformFeatureTypeName(originalName);
if(jobExecution.getStatus()!=BatchStatus.STOPPED){
if(!dryRun){backupFacade.getGeoServer().reload();
if(root==null){loadRules();
if(root==null){loadRules();
if(wps!=null){catalogMode=CatalogMode.HIDE;
if(wps.getCatalogMode()!=null){catalogMode=wps.getCatalogMode();
if(pf!=null){Set<Name>names=pf.getNames();for(Namename:names){prefixes.add(name.getNamespaceURI());
if(group.getRoles()!=null&&!group.getRoles().isEmpty()){result.add(newWpsAccessRule(prefix,ANY,newHashSet<String>(group.getRoles())));
if(process.getRoles()!=null&&!process.getRoles().isEmpty()){result.add(newWpsAccessRule(process.getName().getNamespaceURI(),process.getName().getLocalPart(),newHashSet<String>(process.getRoles())));
ifthesetisempty
if(result.size()==0){result.add(newWpsAccessRule(WpsAccessRule.EXECUTE_ALL));
if(ANY.equals(group)){node=root;
else{//getorcreatethegroupSecureTreeNodews=root.getChild(group);
if(ws==null){ws=root.addChild(group);
ifWPSis"*"theruleappliestothegroup,otherwise//get/createtheWPS
if("*".equals(name)){node=ws;
else{SecureTreeNodelayerNode=ws.getChild(name);
if(layerNode==null)layerNode=ws.addChild(name);node=layerNode;
if(node!=root){LOGGER.warning("Rule"+rule+"isoverridinganotherruletargettingthesameresource");
if(serviceinstanceofWPSInfo){this.root=null;
if(singleExternalGraphic!=null){returnsingleExternalGraphic;
else{returnembeddedIconProperties();
if(applicable){
if(singleRule==null){singleRule=rule;
else{returnnull;
if(singleRule==null){returnnull;
if(rule.symbolizers.size()!=1){returnnull;
if(g==null){returnnull;
if(g.graphicalSymbols().size()!=1){returnnull;
if(!(gSyminstanceofExternalGraphic)){returnnull;
if(size!=null)size=size/Icons.DEFAULT_SYMBOL_SIZE;Doublerotation=g.getRotation().evaluate(feature,Double.class);ExpressionurlExpression=ExpressionExtractor.extractCqlExpressions(exGraphic.getLocation().toExternalForm());returnIconProperties.externalReference(opacity,size,rotation,urlExpression.evaluate(feature,String.class));
if(rule.filter==null){matches=!rule.isElseFilter||props.isEmpty();
else{matches=rule.filter.evaluate(feature);
if(matches){for(intk=0;k<rule.symbolizers.size();k++){props.put(i+"."+j+"."+k,"");PointSymbolizersym=rule.symbolizers.get(k);
if(sym.getGraphic()!=null){addGraphicProperties(i+"."+j+"."+k,sym.getGraphic(),props);finalDoublegRotation=graphicRotation(sym.getGraphic());allRotated&=gRotation!=null;finalDoublegSize=Icons.graphicSize(sym.getGraphic(),gRotation,feature);
if(size==null||(gSize!=null&&gSize>size)){size=gSize;
if(size!=null)size=size/16d;//Ifallthesymbolsinthestackwererotated,forceittobeorientedtoabearing.finalDoublerotation=allRotated?0d:null;returnIconProperties.generator(null,size,rotation,props);
if(g.getRotation()!=null){returng.getRotation().evaluate(feature,Double.class);
else{returnnull;
if(g.getOpacity()!=null&&!isStatic(g.getOpacity())){props.put(prefix+OPACITY,g.getOpacity().evaluate(feature,String.class));
if(g.getRotation()!=null&&!isStatic(g.getRotation())){props.put(prefix+ROTATION,g.getRotation().evaluate(feature,String.class));
if(g.getSize()!=null&&!isStatic(g.getSize())){props.put(prefix+SIZE,g.getSize().evaluate(feature,String.class));
if(!g.graphicalSymbols().isEmpty()){
if(g.graphicalSymbols().get(0)instanceofMark){Markmark=(Mark)g.graphicalSymbols().get(0);addMarkProperties(prefix,mark,props);
else
if(g.graphicalSymbols().get(0)instanceofExternalGraphic){ExternalGraphicexGraphic=(ExternalGraphic)g.graphicalSymbols().get(0);addExternalGraphicProperties(prefix,exGraphic,props);
if(mark.getWellKnownName()!=null&&!isStatic(mark.getWellKnownName())){props.put(prefix+NAME,mark.getWellKnownName().evaluate(feature,String.class));
if(mark.getFill()!=null){addFillProperties(prefix+FILL,mark.getFill(),props);
if(mark.getStroke()!=null){addStrokeProperties(prefix+STROKE,mark.getStroke(),props);
if(fill.getColor()!=null&&!isStatic(fill.getColor())){props.put(prefix+COLOR,fill.getColor().evaluate(feature,String.class));
if(fill.getOpacity()!=null&&!isStatic(fill.getOpacity())){props.put(prefix+OPACITY,fill.getOpacity().evaluate(feature,String.class));
if(fill.getGraphicFill()!=null){addGraphicProperties(prefix+GRAPHIC,fill.getGraphicFill(),props);
if(stroke.getColor()!=null&&!isStatic(stroke.getColor())){props.put(prefix+COLOR,stroke.getColor().evaluate(feature,String.class));
if(stroke.getDashOffset()!=null&&!isStatic(stroke.getDashOffset())){props.put(prefix+DASHOFFSET,stroke.getDashOffset().evaluate(feature,String.class));
if(stroke.getLineCap()!=null&&!isStatic(stroke.getLineCap())){props.put(prefix+LINECAP,stroke.getLineCap().evaluate(feature,String.class));
if(stroke.getLineJoin()!=null&&!isStatic(stroke.getLineJoin())){props.put(prefix+LINEJOIN,stroke.getLineJoin().evaluate(feature,String.class));
if(stroke.getOpacity()!=null&&!isStatic(stroke.getOpacity())){props.put(prefix+OPACITY,stroke.getOpacity().evaluate(feature,String.class));
if(stroke.getWidth()!=null&&!isStatic(stroke.getWidth())){props.put(prefix+WIDTH,stroke.getWidth().evaluate(feature,String.class));
if(stroke.getGraphicStroke()!=null){addGraphicProperties(prefix+GRAPHIC,stroke.getGraphicStroke(),props);
if(stroke.getGraphicFill()!=null){addGraphicProperties(prefix+GRAPHIC,stroke.getGraphicFill(),props);
if(!isStatic(ex)){props.put(prefix+URL,ex.evaluate(feature,String.class));
if(csw.isCanonicalSchemaLocation()){schemaLocationRoot="http://schemas.opengis.net/csw/2.0.2";
else{schemaLocationRoot=buildSchemaURL(request.getBaseUrl(),"csw/2.0.2");
if(delegate.canHandle(descriptor)){delegate.writeSchemaComponent(request,writer,descriptor);break;
if(roleArray1.length!=roleArray2.length)returnfalse;Set<String>roleSet1=newHashSet<>();for(Stringrole:roleArray1)roleSet1.add(role.trim());Set<String>roleSet2=newHashSet<>();for(Stringrole:roleArray2)roleSet2.add(role.trim());for(Stringrole:roleSet1){
if(!roleSet2.contains(role))returnfalse;
ifnothingchangedDocumentdom=getAsDOM(DATA_URI_XML);checkXMLResponse(dom,rules);//addString[][]toBeAdded2={{"ws.layer1.w",TEST_ROLE1},{"ws.layer1.r",TEST_ROLELIST}};String[][]expected={rules[0],rules[1],toBeAdded2[0],toBeAdded2[1]};assertEquals(200,postAsServletResponse(DATA_URI_XML,createXMLBody(toBeAdded2),"text/xml").getStatus());dom=getAsDOM(DATA_URI_XML);checkXMLResponse(dom,expected);//servicerulesrules=getDefaultServiceRules();toBeAdded2=newString[][]{{"ws.*",TEST_ROLE1},{"ws2.GetFeature",TEST_ROLELIST}};assertEquals(200,postAsServletResponse(SERVICE_URI_XML,createXMLBody(toBeAdded2),"text/xml").getStatus());expected=newString[][]{rules[0],toBeAdded2[0],toBeAdded2[1]};dom=getAsDOM(SERVICE_URI_XML);checkXMLResponse(dom,expected);//checkconflictassertEquals(409,postAsServletResponse(SERVICE_URI_XML,createXMLBody(toBeAdded2),"text/xml").getStatus());//RESTrulesrules=getDefaultRestRules();toBeAdded=newString[][]{rules[0],{"/myworkspace/**:GET",TEST_ROLELIST}};//conflictassertEquals(409,postAsServletResponse(REST_URI_XML,createXMLBody(toBeAdded),"text/xml").getStatus());//check
ifnothingchangeddom=getAsDOM(REST_URI_XML);checkXMLResponse(dom,rules);//addtoBeAdded2=newString[][]{{"/myworkspace/**:PUT,POST",TEST_ROLE1},{"/myworkspace/**:GET",TEST_ROLELIST}};expected=newString[][]{rules[0],rules[1],toBeAdded2[0],toBeAdded2[1]};assertEquals(200,postAsServletResponse(REST_URI_XML,createXMLBody(toBeAdded2),"text/xml").getStatus());dom=getAsDOM(REST_URI_XML);checkXMLResponse(dom,expected);
ifnothingchangedJSONObjectjson=(JSONObject)getAsJSON(DATA_URI_JSON);checkJSONResponse(json,rules);//addString[][]toBeAdded2={{"ws.layer1.w",TEST_ROLE1},{"ws.layer1.r",TEST_ROLELIST}};String[][]expected={rules[0],rules[1],toBeAdded2[0],toBeAdded2[1]};assertEquals(200,postAsServletResponse(DATA_URI_JSON,createJSONBody(toBeAdded2),"text/json").getStatus());json=(JSONObject)getAsJSON(DATA_URI_JSON);checkJSONResponse(json,expected);//servicerulesrules=getDefaultServiceRules();toBeAdded2=newString[][]{{"ws.*",TEST_ROLE1},{"ws2.GetFeature",TEST_ROLELIST}};assertEquals(200,postAsServletResponse(SERVICE_URI_JSON,createJSONBody(toBeAdded2),"text/json").getStatus());expected=newString[][]{rules[0],toBeAdded2[0],toBeAdded2[1]};json=(JSONObject)getAsJSON(SERVICE_URI_JSON);checkJSONResponse(json,expected);//checkconflictassertEquals(409,postAsServletResponse(SERVICE_URI_JSON,createJSONBody(toBeAdded2),"text/json").getStatus());//RESTrulesrules=getDefaultRestRules();toBeAdded=newString[][]{rules[0],{"/myworkspace/**:GET",TEST_ROLELIST}};//conflictassertEquals(409,postAsServletResponse(REST_URI_JSON,createJSONBody(toBeAdded),"text/json").getStatus());//check
ifnothingchangedjson=(JSONObject)getAsJSON(REST_URI_JSON);checkJSONResponse(json,rules);//addtoBeAdded2=newString[][]{{"/myworkspace/**:PUT,POST",TEST_ROLE1},{"/myworkspace/**:GET",TEST_ROLELIST}};expected=newString[][]{rules[0],rules[1],toBeAdded2[0],toBeAdded2[1]};assertEquals(200,postAsServletResponse(REST_URI_JSON,createJSONBody(toBeAdded2),"text/json").getStatus());json=(JSONObject)getAsJSON(REST_URI_JSON);checkJSONResponse(json,expected);
ifnothingchangedJSONObjectjson=(JSONObject)getAsJSON(DATA_URI_JSON);checkJSONResponse(json,rules);//modifyString[][]toBeModified2={{rules[0][0],TEST_ROLE1},{rules[1][0],TEST_ROLELIST}};assertEquals(200,putAsServletResponse(DATA_URI_JSON,createJSONBody(toBeModified2),"text/json").getStatus());json=(JSONObject)getAsJSON(DATA_URI_JSON);checkJSONResponse(json,toBeModified2);//servicerulesrules=getDefaultServiceRules();toBeModified2=newString[][]{{"ws.*",TEST_ROLE1},{"ws2.GetFeature",TEST_ROLELIST}};//conflictassertEquals(409,putAsServletResponse(SERVICE_URI_JSON,createJSONBody(toBeModified2),"text/json").getStatus());json=(JSONObject)getAsJSON(SERVICE_URI_JSON);checkJSONResponse(json,rules);assertEquals(200,putAsServletResponse(SERVICE_URI_JSON,createJSONBody(newString[][]{}),"text/json").getStatus());//RESTrulesrules=getDefaultRestRules();toBeModified=newString[][]{rules[0],{"/myworkspace/**:GET",TEST_ROLELIST}};//conflictassertEquals(409,putAsServletResponse(REST_URI_JSON,createJSONBody(toBeModified),"text/json").getStatus());//check
ifnothingchangedjson=(JSONObject)getAsJSON(REST_URI_JSON);checkJSONResponse(json,rules);//modifytoBeModified2=newString[][]{{rules[0][0],TEST_ROLE1},{rules[1][0],TEST_ROLELIST}};assertEquals(200,putAsServletResponse(REST_URI_JSON,createJSONBody(toBeModified2),"text/json").getStatus());json=(JSONObject)getAsJSON(REST_URI_JSON);checkJSONResponse(json,toBeModified2);
ifnothingchangedDocumentdom=getAsDOM(DATA_URI_XML);checkXMLResponse(dom,rules);//modifyString[][]toBeModified2={{rules[0][0],TEST_ROLE1},{rules[1][0],TEST_ROLELIST}};assertEquals(200,putAsServletResponse(DATA_URI_XML,createXMLBody(toBeModified2),"text/xml").getStatus());dom=getAsDOM(DATA_URI_XML);checkXMLResponse(dom,toBeModified2);//servicerulesrules=getDefaultServiceRules();toBeModified2=newString[][]{{"ws.*",TEST_ROLE1},{"ws2.GetFeature",TEST_ROLELIST}};//conflictassertEquals(409,putAsServletResponse(SERVICE_URI_XML,createXMLBody(toBeModified2),"text/xml").getStatus());dom=getAsDOM(SERVICE_URI_XML);checkXMLResponse(dom,rules);assertEquals(200,putAsServletResponse(SERVICE_URI_XML,createXMLBody(newString[][]{}),"text/xml").getStatus());//RESTrulesrules=getDefaultRestRules();toBeModified=newString[][]{rules[0],{"/myworkspace/**:GET",TEST_ROLELIST}};//conflictassertEquals(409,putAsServletResponse(REST_URI_XML,createXMLBody(toBeModified),"text/xml").getStatus());//check
ifnothingchangeddom=getAsDOM(REST_URI_XML);checkXMLResponse(dom,rules);//modifytoBeModified2=newString[][]{{rules[0][0],TEST_ROLE1},{rules[1][0],TEST_ROLELIST}};assertEquals(200,putAsServletResponse(REST_URI_XML,createXMLBody(toBeModified2),"text/xml").getStatus());dom=getAsDOM(REST_URI_XML);checkXMLResponse(dom,toBeModified2);
ifnothingchangedDocumentdom=getAsDOM(DATA_URI_XML);checkXMLResponse(dom,rules);toBeAdded=newString[][]{{"ws.layer1.x",TEST_ROLELIST}};//conflictassertEquals(422,postAsServletResponse(DATA_URI_XML,createXMLBody(toBeAdded),"text/xml").getStatus());//check
ifnothingchangeddom=getAsDOM(DATA_URI_XML);checkXMLResponse(dom,rules);toBeAdded=newString[][]{{"*.layer1.r",TEST_ROLELIST}};//conflictassertEquals(422,postAsServletResponse(DATA_URI_XML,createXMLBody(toBeAdded),"text/xml").getStatus());//check
ifnothingchangeddom=getAsDOM(DATA_URI_XML);checkXMLResponse(dom,rules);toBeAdded=newString[][]{{"ws.layer1.a",TEST_ROLELIST}};//conflictassertEquals(422,postAsServletResponse(DATA_URI_XML,createXMLBody(toBeAdded),"text/xml").getStatus());//check
ifnothingchangeddom=getAsDOM(DATA_URI_XML);checkXMLResponse(dom,rules);//servicesrules=getDefaultServiceRules();toBeAdded=newString[][]{{"ws.getMap.c",TEST_ROLELIST}};//conflictassertEquals(422,postAsServletResponse(SERVICE_URI_XML,createXMLBody(toBeAdded),"text/xml").getStatus());//check
ifnothingchangeddom=getAsDOM(SERVICE_URI_XML);checkXMLResponse(dom,rules);toBeAdded=newString[][]{{"*.getMap",TEST_ROLELIST}};//conflictassertEquals(422,postAsServletResponse(SERVICE_URI_XML,createXMLBody(toBeAdded),"text/xml").getStatus());//check
ifnothingchangeddom=getAsDOM(SERVICE_URI_XML);checkXMLResponse(dom,rules);rules=getDefaultRestRules();toBeAdded=newString[][]{rules[0],{"/myworkspace/**!!!GET",TEST_ROLELIST}};//conflictassertEquals(422,postAsServletResponse(REST_URI_XML,createXMLBody(toBeAdded),"text/xml").getStatus());//check
ifnothingchangeddom=getAsDOM(REST_URI_XML);checkXMLResponse(dom,rules);
if(database!=null){//filebaseddatabasesmightbeafullpathtoafile(sqlite,h2,etc..)useonly//thelastpartdatabase=FilenameUtils.getBaseName(database);
if(factory==null){thrownewIOException("Unabletofinddatastoreforspecifiedparameters");
if(store==null){thrownewIOException("Unabletocreatedatastorefromspecifiedparameters");
if(parameters.containsKey(JDBCDataStoreFactory.USER.key)){sb.append(parameters.get(JDBCDataStoreFactory.USER.key)).append("@");
if(parameters.containsKey(JDBCDataStoreFactory.HOST.key)){sb.append(parameters.get(JDBCDataStoreFactory.HOST.key));
if(parameters.containsKey(JDBCDataStoreFactory.PORT.key)){sb.append(":").append(parameters.get(JDBCDataStoreFactory.PORT.key));
if(sb.length()>0){sb.append("/");
ifencodingdoesnotchangebetweenversionsassertTrue(encoder.isPasswordValid("digest1:CTBPxdfHvqy0K0M6uoYlb3+fPFrfMhpTm7+ey5rL/1xGI4s6g8n/OrkXdcyqzJ3D",testPassword,null));assertTrue(encoder2.isPasswordValid("digest1:CTBPxdfHvqy0K0M6uoYlb3+fPFrfMhpTm7+ey5rL/1xGI4s6g8n/OrkXdcyqzJ3D",testPassword,null));
if(getSecurityManager().isStrongEncryptionAvailable()){result.add(getStrongPBEPasswordEncoder());
else{LOGGER.warning("Skippingstrongencryptiontestsforconfigurationpasswords");
if(getSecurityManager().isStrongEncryptionAvailable()){result.add(getStrongPBEPasswordEncoder());
else{LOGGER.warning("Skippingstrongencryptiontestsforuserpasswords");
if(enc.getPrefix()!=null&&enc.getPrefix().equals("plain4711")){found=true;break;
if("startIndex".equalsIgnoreCase(k)){actualStartIndex=Integer.parseInt(v);
if("count".equalsIgnoreCase(k)){actualCount=Integer.parseInt(v);
if(values.size()<2)thrownewWcsException("Invalidgridorigin,shouldhaveatleasttwovalues",WcsExceptionCode.InvalidParameterValue,"GridOrigin");Double[]origins=newDouble[values.size()];for(inti=0;i<origins.length;i++){try{origins[i]=Double.parseDouble((String)values.get(i));
if(ref.getMethod()==MethodType.POST_LITERAL){getCoverage=ref.getBody();
else{//whatWCSversion?Stringversion=getVersion(ref.getHref());KvpRequestReaderreader;
if("1.0.0".equals(version)||"1.0".equals(version)){reader=(KvpRequestReader)context.getBean("wcs100GetCoverageRequestReader");
else
if("2.0.1".equals(version)||"2.0.0".equals(version)){reader=(KvpRequestReader)context.getBean("wcs20getCoverageKvpParser");
else{reader=(KvpRequestReader)context.getBean("wcs111GetCoverageRequestReader");
if(getCoverageinstanceofGetCoverageType){WebCoverageService111wcs=(WebCoverageService111)context.getBean("wcs111ServiceTarget");returnwcs.getCoverage((net.opengis.wcs11.GetCoverageType)getCoverage)[0];
else
if(getCoverageinstanceofnet.opengis.wcs10.GetCoverageType){WebCoverageService100wcs=(WebCoverageService100)context.getBean("wcs100ServiceTarget");returnwcs.getCoverage((net.opengis.wcs10.GetCoverageType)getCoverage)[0];
else
if(getCoverageinstanceofnet.opengis.wcs20.GetCoverageType){WebCoverageService20wcs=(WebCoverageService20)context.getBean("wcs20ServiceTarget");returnwcs.getCoverage((net.opengis.wcs20.GetCoverageType)getCoverage);
else{thrownewWPSException("Unrecognizedrequesttype"+getCoverage);
if(first==Pipeline.END){first=step;last=first;
else{last.setNext(step);last=step;
if(geominstanceofGeometryCollection&&geom.getNumGeometries()==1){returngeom.getGeometryN(0);
if(this.projectionHandler!=null){preProcessed=projectionHandler.preProcess(geom);
if(preProcessed==null||preProcessed.isEmpty()){returnEMPTY;
if(preProcessed.getDimension()>0){Envelopeenv=preProcessed.getEnvelopeInternal();
if(screenMap.canSimplify(env))
if(screenMap.checkAndSet(env)){returnEMPTY;
else{preProcessed=screenMap.getSimplifiedShape(env.getMinX(),env.getMinY(),env.getMaxX(),env.getMaxY(),preProcessed.getFactory(),preProcessed.getClass());
iffalse.*@paramtransformToScreenCoordinatesisthepipelineworkinginscreencoordinates*@return*/publicPipelineBuilderclip(booleanclipToMapBounds,booleantransformToScreenCoordinates){
if(clipToMapBounds){EnvelopeclippingEnvelope;
if(transformToScreenCoordinates){Rectanglescreen=context.paintArea;EnvelopepaintArea=newEnvelope(0,screen.getWidth(),0,screen.getHeight());paintArea.expandBy(clipBBOXSizeIncreasePixels+context.queryBuffer);clippingEnvelope=paintArea;
else{ReferencedEnveloperenderingArea=context.renderingArea;renderingArea.expandBy((clipBBOXSizeIncreasePixels+context.queryBuffer)*context.pixelSizeInTargetCRS);clippingEnvelope=renderingArea;
if(geom.getDimension()==0){returngeom;
if((geom==null)||(geom.isEmpty())){returnnull;
ifitsageometrycollectionwedoeachpieceindividually
if(geom.getGeometryType()=="GeometryCollection"){returncollectionClip((GeometryCollection)geom);
ifthere'snoresultinggeometry,don'tneedtodealwithit
if((result==null)||(result.isEmpty())){returnnull;
if((geominstanceofPoint)||(geominstanceofMultiPoint)){returnonlyPoints(result);
else
if((geominstanceofLineString)||(geominstanceofMultiLineString)){returnonlyLines(result);
else
if((geominstanceofPolygon)||(geominstanceofMultiPolygon)){returnonlyPolygon(result);
iftheinputisa*GeometryCollection(POLYGON(...),LINESTRING(...))thePOLYGON(...)willbeclipped(andonlypolygonspreserved)theLINESTRING(..)willbe*clipped(andonlylinespreserved)**Therearesomeedgecasesunhandledhere-
iftheinputcontainsmultiplepolygons,theresultmightbebetterreducedtoamultipolygon*insteadofaGeometryCollectwithmultiplepolygonsinit.However,thiswouldbecomputationallyexpensiveandunlikelytomakeany*difference.*/privateGeometrycollectionClip(GeometryCollectiongeom)throwsException{ArrayList<Geometry>result=newArrayList<Geometry>();for(intt=0;t<geom.getNumGeometries();t++){Geometryg=geom.getGeometryN(0);Geometryclipped=_run(g);//getsthenon-degenerativeoftheresult
if((clipped!=null)&&(!clipped.isEmpty())){result.add(clipped);
if(result.size()==0){returnnull;
if((resultinstanceofPolygon)||(resultinstanceofMultiPolygon)){returnresult;
if(polys.size()==0){returnnull;
if(polys.size()==1){return(Polygon)polys.get(0);
if((resultinstanceofLineString)||(resultinstanceofMultiLineString)){returnresult;
if(lines.size()==0){returnnull;
if(lines.size()==1){return(LineString)lines.get(0);
if((resultinstanceofPoint)||(resultinstanceofMultiPoint)){returnresult;
if(pts.size()==0){returnnull;
if(pts.size()==1){return(Point)pts.get(0);
if(splitted.length==1){uri=ns.getURI("");localName=splitted[0];
else{uri=ns.getURI(splitted[0]);localName=splitted[1];
ifwedon'thaveoneStringxpath;
if(prefix!=null&&!"".equals(prefix)){xpath=prefix+":"+localName;
else{xpath=localName;
if(e!=null){ex.initCause(e);
if(filename==null){filename="<UnknownSource>";
if(title==null){LOGGER.warning("Processmissingrequiredtitlein"+filename);//TODOprovideprocessnametitle="Untitled";
if(filename==null){filename="<UnknownSource>";
if(exportsObjinstanceofScriptable){exports=(Scriptable)exportsObj;
else{thrownewRuntimeException("Couldn'tgetexportsforprocessin"+filename);
if(processObjinstanceofWrapper){process=(MetaProcess)((Wrapper)processObj).unwrap();
else{thrownewRuntimeException("Missing'process'exportsfrom"+filename);
if(sourceFile==null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Originalsourceisnull");
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Originalsource:"+sourceFile.getAbsolutePath());
if(inStream==null){returnnull;
if(readers.hasNext()){reader=readers.next();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Foundreaderforformat:"+reader.getFormatName());
if(lcMime.contains("jpeg")||lcMime.contains("mrsid")||lcMime.contains("ecw")){returnnull;
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("Unabletomapmimetypeforcoverage:"+cInfo.toString());
if(inStream!=null){inStream.close();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,e.getLocalizedMessage(),e);
if(reader!=null){reader.dispose();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,e.getLocalizedMessage(),e);
if(name.equalsIgnoreCase(COVERAGE_VIEW_NAME)){thrownewIllegalArgumentException("Makesuretospecifyapropercoveragename,differentthat"+COVERAGE_VIEW_NAME);
if(coverageBands==null||coverageBands.isEmpty()){thrownewIllegalArgumentException("Nooutputbandshavebeenspecified");
if(lookup!=null){
if(lookupinstanceofBackupExecutionAdapter){returnwrapObject((BackupExecutionAdapter)lookup,BackupExecutionAdapter.class);
else{returnwrapList((List<BackupExecutionAdapter>)lookup,BackupExecutionAdapter.class);
if(lookup!=null){
if(lookupinstanceofBackupExecutionAdapter){
if(backupId.endsWith(".zip")){try{//getyourfileasInputStreamFilefile=((BackupExecutionAdapter)lookup).getArchiveFile().file();InputStreamis=newFileInputStream(file);//copyittoresponse'sOutputStreamorg.apache.commons.io.IOUtils.copy(is,response.getOutputStream());response.flushBuffer();
else{returnwrapObject((BackupExecutionAdapter)lookup,BackupExecutionAdapter.class);
else{returnwrapList((List<BackupExecutionAdapter>)lookup,BackupExecutionAdapter.class);
if(lookup!=null){
if(lookupinstanceofBackupExecutionAdapter){try{getBackupFacade().abandonExecution(Long.valueOf(executionId));
else{returnwrapList((List<BackupExecutionAdapter>)lookup,BackupExecutionAdapter.class);
if(backup.getId()!=null){Objectlookup=lookupBackupExecutionsContext(String.valueOf(backup.getId()),false,false);
if(lookup!=null){//Backupinstancealreadyexists...tryingtorestartit.try{getBackupFacade().restartExecution(backup.getId());LOGGER.log(Level.INFO,"Backuprestarted:"+backup.getArchiveFile());returnwrapObject((BackupExecutionAdapter)lookup,BackupExecutionAdapter.class);
else{//Startanewexecutionasynchronously.Youwillneedtoqueryforthestatusinorder//tofollowtheprogress.execution=getBackupFacade().runBackupAsync(backup.getArchiveFile(),backup.isOverwrite(),backup.getFilter(),asParams(backup.getOptions()));LOGGER.log(Level.INFO,"Backupfilegenerated:"+backup.getArchiveFile());returnwrapObject((BackupExecutionAdapter)execution,BackupExecutionAdapter.class);
ifenabledorfallsbacktoregularstore
ifdisabled.**@authorNielsCharlier*/publicclassJDBCResourceStoreFactoryBeanimplementsFactoryBean<ResourceStore>,InitializingBean{privateResourceStoreresourceStore;publicJDBCResourceStoreFactoryBean(ResourceStorefallbackStore,DataSourceds,JDBCResourceStorePropertiesconfig){
if(config.isEnabled()){resourceStore=newJDBCResourceStore(ds,config,fallbackStore);
else{resourceStore=fallbackStore;
if(resourceStoreinstanceofJDBCResourceStore){((JDBCResourceStore)resourceStore).setCache(cache);
if(resourceStoreinstanceofJDBCResourceStore){((JDBCResourceStore)resourceStore).setLockProvider(lockProvider);
if(resourceStoreinstanceofJDBCResourceStore){((JDBCResourceStore)resourceStore).setResourceNotificationDispatcher(resourceWatcher);
if(resourceStoreinstanceofJDBCResourceStore){JDBCResourceStorestore=((JDBCResourceStore)resourceStore);LockProviderlockProvider=store.getLockProvider();Preconditions.checkState(lockProvider!=null,"LockProviderhasnotbeenset.CheckyourapplicationContext.xmlconfigurationfileforJDBCResourceStoreFactoryBean");
if(crs==null){thrownewIllegalArgumentException("WCSEnvelopecoordinatereferencesystemcannotbenull");
ifwehavealongitude,thatisCoordinateSystemcs=crs.getCoordinateSystem();this.dimensions=cs.getDimension();this.ordinates=newdouble[dimensions*2];for(inti=0;i<dimensions;i++){CoordinateSystemAxisaxis=cs.getAxis(i);
if(CRS.equalsIgnoreMetadata(axis,DefaultCoordinateSystemAxis.LONGITUDE)){longitudeDimension=i;break;
if(minimum>maximum&&(longitudeDimension!=LONGIDUTE_NOT_FOUND&&dimension!=longitudeDimension)){//Makeanemptyenvelope(min==max)//whilekeepingitlegal(min<=max).minimum=maximum=0.5*(minimum+maximum);
else
if(dimension>=0&&dimension<ordinates.length/2){ordinates[dimension+ordinates.length/2]=maximum;ordinates[dimension]=minimum;
else{throwindexOutOfBounds(dimension);
iftheenvelopehasaemptyspanonatleastonedimension.Aspanisempty
if*itszeroornegative,butincaseadimensionisthelongitude,anegativespanwillbe*treatedasadatelinecrossing,andthustreatedasnonempty*/publicbooleanisEmpty(){for(inti=0;i<dimensions;i++){doublespan=getSpan(i);
if(span==0){returntrue;
else
if(span<0&&i!=longitudeDimension){returntrue;
if(dimension<this.dimensions){returnordinates[dimension];
else{throwindexOutOfBounds(dimension);
if(dimension<this.dimensions){returnordinates[dimension+ordinates.length/2];
else{throwindexOutOfBounds(dimension);
if(dimension<ordinates.length/2){return0.5*(ordinates[dimension]+ordinates[dimension+ordinates.length/2]);
else{throwindexOutOfBounds(dimension);
if(dimension<ordinates.length/2){returnordinates[dimension+ordinates.length/2]-ordinates[dimension];
else{throwindexOutOfBounds(dimension);
if(!isCrossingDateline()){returnnewGeneralEnvelope[]{newGeneralEnvelope(this)};
else{GeneralEnvelopee1=newGeneralEnvelope(crs);GeneralEnvelopee2=newGeneralEnvelope(crs);for(inti=0;i<dimensions;i++){
if(i==longitudeDimension){e1.setRange(i,getMinimum(i),180);
if(getSpan(longitudeDimension)<0){e2.setRange(i,-180,getMaximum(i));
else{e2.setRange(i,-180,getMaximum(i)-360);
else{e1.setRange(i,getMinimum(i),getMaximum(i));e2.setRange(i,getMinimum(i),getMaximum(i));
ifthisenvelopeintersectstheprovidedone,takingintoaccountthecaseofdateline*crossing.**@paramother*/publicvoidintersect(GeneralEnvelopeother){assertother.getDimension()==dimensions:other;assertCRS.equalsIgnoreMetadata(crs,other.getCoordinateReferenceSystem()):other;
if(isCrossingDateline()){GeneralEnvelope[]normalizedEnvelopes=getNormalizedEnvelopes();for(GeneralEnvelopege:normalizedEnvelopes){ge.intersect(other);
if(i==longitudeDimension){
if(normalizedEnvelopes[0].getSpan(i)==0){ordinates[i]=normalizedEnvelopes[1].getMinimum(i);ordinates[i+dimensions]=normalizedEnvelopes[1].getMaximum(i);
else
if(normalizedEnvelopes[1].getSpan(i)==0){ordinates[i]=normalizedEnvelopes[0].getMinimum(i);ordinates[i+dimensions]=normalizedEnvelopes[0].getMaximum(i);
else{ordinates[i]=normalizedEnvelopes[0].getMinimum(i);ordinates[i+dimensions]=normalizedEnvelopes[1].getMaximum(i);
else{ordinates[i]=normalizedEnvelopes[0].getMinimum(i);ordinates[i+dimensions]=normalizedEnvelopes[0].getMaximum(i);
else{for(inti=0;i<dimensions;i++){doublemin=Math.max(ordinates[i],other.getMinimum(i));doublemax=Math.min(ordinates[i+dimensions],other.getMaximum(i));
if(min>max){//Makeanemptyenvelope(min==max)//whilekeepingitlegal(min<=max).min=max=0.5*(min+max);
ifthisenvelopeiscrossingthedateline*/publicbooleanisCrossingDateline(){//TODO:handlethecasetheenvelopeisinaprojectedsystemandstill//crossingthedateline(e.g.polar,ormercatorcenteredaroundthedateline)returnlongitudeDimension!=LONGIDUTE_NOT_FOUND&&(getSpan(longitudeDimension)<0||(getMinimum(longitudeDimension)<180&&getMaximum(longitudeDimension)>180));
ifthespecifieddimensionindexismatchingthelongitudeaxis**@paramdimension*/publicbooleanisLongitude(intdimension){returnlongitudeDimension==dimension;}}
if(styleRoot!=null){List<String>styleNames=newArrayList<String>();Element[]styles=ReaderUtils.getChildElements(styleRoot,"style");for(Elementstyle:styles){styleNames.add(style.getTextContent().trim());
else{returnCollections.emptyList();
if(gridElement==null){returnnull;
if(geoTransformElement!=null){Map<String,Double>geoTransform=newHashMap<String,Double>();StringscaleX=ReaderUtils.getChildText(geoTransformElement,"scaleX");StringscaleY=ReaderUtils.getChildText(geoTransformElement,"scaleY");StringshearX=ReaderUtils.getChildText(geoTransformElement,"shearX");StringshearY=ReaderUtils.getChildText(geoTransformElement,"shearY");StringtranslateX=ReaderUtils.getChildText(geoTransformElement,"translateX");StringtranslateY=ReaderUtils.getChildText(geoTransformElement,"translateY");geoTransform.put("scaleX",scaleX!=null?newDouble(scaleX):null);geoTransform.put("scaleY",scaleY!=null?newDouble(scaleY):null);geoTransform.put("shearX",shearX!=null?newDouble(shearX):null);geoTransform.put("shearY",shearY!=null?newDouble(shearY):null);geoTransform.put("translateX",translateX!=null?newDouble(translateX):null);geoTransform.put("translateY",translateY!=null?newDouble(translateY):null);grid.put("geoTransform",geoTransform);
if(parameters==null){returnCollections.EMPTY_MAP;
if(sourceinstanceofStyleInfo){finalList<String>propertyNames=event.getPropertyNames();
if(!propertyNames.contains("name")&&!propertyNames.contains("workspace")){return;
if(nameIdx!=-1){//fornow,onlyhandletheeven
ifthenamechanges.mostlikelyweshouldalsodo//thetruncate
if//theworkspacechangestoo,butthatneedsamorethoroughinvestigationhandleStyleRenamed(oldStyleName,newStyleName);
else
if(sourceinstanceofWorkspaceInfo){PRE_MODIFY_EVENT.set(event);
if(oldStyleName.equals(newStyleName)){return;
if(layerInfo==null){//noextrastylesforlayergroupscontinue;
if(styleNames.contains(oldStyleName)){tl.resetParameterFilters();//pity,wedon'thaveawaytojustrenameastyleinGWCmediator.truncateByLayerAndStyle(tl.getName(),oldStyleName);Set<String>newStyles=newHashSet<String>(styleNames);newStyles.remove(oldStyleName);newStyles.add(newStyleName);StringdefaultStyle=layerInfo.getDefaultStyle()==null?null:layerInfo.getDefaultStyle().prefixedName();TileLayerInfoUtil.setCachedStyles(info,defaultStyle,newStyles);mediator.save(tl);
if(workspace!=null){returnworkspace+":"+name;
else{returnname;
if(sourceinstanceofStyleInfo){StyleInfosi=(StyleInfo)source;handleStyleChange(si);
else
if(sourceinstanceofWorkspaceInfo){WorkspaceInfows=(WorkspaceInfo)source;handleWorkspaceChange(ws);
if(nameIdx==-1){return;
if(request!=null&&request.getRequestCharset()!=null){StringrequestCharset=request.getRequestCharset();returnrequestCharset;
ifanerroroccursduringencoding*<p>publicvoidnewline()throwsIOException{super.write('\n');
ifanerroroccursduringencoding*@throwsAbortedException
iftheoperationisaborted*/publicvoidwriteFeatures(SimpleFeatureCollectionfColl,FeatureTypeStyle[]ftsList)throwsIOException,AbortedException{SimpleFeatureft;SimpleFeatureIteratoriter=null;try{SimpleFeatureTypefeatureType=fColl.getSchema();Class<?>gtype=featureType.getGeometryDescriptor().getType().getBinding();//iteratesthroughthesinglefeaturesiter=fColl.features();while(iter.hasNext()){ft=iter.next();Geometrygeo=(Geometry)ft.getDefaultGeometry();
if(!clippingBox.contains(geo)){try{GeometryclippedGeometry=clippingBox.intersection(geo);ft.setDefaultGeometry(clippedGeometry);
if(iter!=null){//makesurewealwayscloseiter.close();
if((rules==null)||(rules.length==0)){returnnewRule[0];
elsefiltersbooleanmatch=false;booleanhasElseFilter=false;for(inti=0;i<rules.length;i++){Rulerule=rules[i];LOGGER.finer(newStringBuffer("Applyingrule:").append(rule.toString()).toString());//doesthisrulehavean
elsefilter
if(rule.hasElseFilter()){hasElseFilter=true;continue;
if(!EncodeHTMLImageMap.isWithInScale(rule,scaleDenominator)){continue;
if((filter==null)||filter.evaluate(feature)){match=true;filtered.add(rule);
ifnorulesmachedthefeautre,re-runthroughtherulesapplying//any
elsefilters
if(!match&&hasElseFilter){//loopthroughagainandapplyallthe
elserulesfor(inti=0;i<rules.length;i++){Rulerule=rules[i];
if(rule.hasElseFilter()){filtered.add(rule);
ifthefeaturehastobeincludedinoutput.Ifthefeaturehastobeincluded,proceed*withthefollowingphases,
elsegotothenextfeature.3)startfeatureencoding4)pre*geometryencoding5)actualgeometryencoding6)postgeometryencoding7)endfeature*encoding**@paramftfeaturetoencode*@paramstylestyletousefortheencoding*@paramfts"cached"ftssmatchingtheFeatureTypeofthefeature*@throwsIOException
ifanerroroccursduringencoding*/protectedvoidwriteFeature(SimpleFeatureft,FeatureTypeStyle[]fts)throwsIOException{//anewfeaturebegins,resetaccumulatedinfo,suchasextraAttributesreset(ft);//processthesuppliedstyleandstorerenderinginfoforthefollowingphases//thestyleprocessingappliesfilterstothefeaturetodecide
ifithastobe//included//inoutput
if(processStyle(ft,fts)){try{Geometrygeo=(Geometry)ft.getDefaultGeometry();
if(geo!=null){//encodesstartingelementstartElement(ft,"");//pregeometryencodingphasestartGeometry(geo);//actualgeometryencodingphasewriteGeometry(geo,buffer);//postgeometryencodingphaseendGeometry(geo);//encodesendingelementendElement(ft);//
ifeverythinghasbeencorrectlyencoded,//wecommitthebuffercontenttothestreamcommitBuffer();
else{buffer=newStringBuffer();
if(LOGGER.isLoggable(Level.WARNING))LOGGER.warning("nullgeometry");
if(LOGGER.isLoggable(Level.WARNING))LOGGER.warning("Problemsencodingshape:"+e.getMessage());
if(LOGGER.isLoggable(Level.SEVERE))LOGGER.severe("Problemsencodingshape:"+t.getMessage());
ifthefeaturehastobeincludedinoutput.Ifthe*featurehastobeincluded,proceedwiththefollowingphases,
elsegotothenext*feature.3)loopsforallthegeometries,withthefollowingphasesforeverysingle*geometry.a)startfeatureencodingb)pregeometryencodingc)actualgeometryencoding*d)postgeometryencodinge)endfeatureencoding**@paramftfeaturetoencode*@paramstylestyletousefortheencoding*@paramfts"cached"ftssmatchingtheFeatureTypeofthefeature*@throwsIOException
ifanerroroccursduringencoding*/protectedvoidwriteMultiFeature(SimpleFeatureft,FeatureTypeStyle[]fts)throwsIOException{reset(ft);
if(processStyle(ft,fts)){GeometryCollectiongeomCollection=(GeometryCollection)ft.getDefaultGeometry();for(inti=0;i<geomCollection.getNumGeometries();i++){try{Geometrygeo=geomCollection.getGeometryN(i);
if(geo!=null){startElement(ft,"."+i);startGeometry(geo);writeGeometry(geo,buffer);endGeometry(geo);endElement(ft);commitBuffer();
else{
if(LOGGER.isLoggable(Level.WARNING))LOGGER.warning("Problemsencodingshape:nullgeometry");
if(LOGGER.isLoggable(Level.WARNING))LOGGER.warning("Problemsencodingshape:"+e.getMessage());
if(LOGGER.isLoggable(Level.SEVERE))LOGGER.severe("Problemsencodingshape:"+t.getMessage());
ifanerroroccuresduringencoding*/protectedvoidstartElement(SimpleFeaturefeature,Stringsuffix)throwsIOException{//eachfeature(multigeometryonesareanexception)isrepresentedbyan<area>tag//eachareataghasanid,equaltothefeatureid,andashape(rect,polyorcircle)writeToBuffer("<areashape=\""+getShape()+"\"id=\""+feature.getID()+suffix+"\"",buffer);
ifanerroroccuresduringencoding*/protectedvoidstartGeometry(Geometrygeom)throwsIOException{writeToBuffer("coords=\"",buffer);
ifanerroroccuresduringencoding*/protectedabstractStringgetShape()throwsIOException;/***Encodestheactualgeometry.**@paramgeomgeometrytoencode*@throwsIOException
ifanerroroccuresduringencoding*/protectedabstractvoidwriteGeometry(Geometrygeom,StringBufferbuffer)throwsIOException;/***Encodesthegeometry"ending"(closingquotes)**@paramgeomgeometrytoencode*@throwsIOException
ifanerroroccuresduringencoding*/protectedvoidendGeometry(Geometrygeom)throwsIOException{writeToBuffer("\"",buffer);
ifanerroroccuresduringencoding*/protectedvoidendElement(SimpleFeaturefeature)throwsIOException{Iterator<String>iter=extraAttributes.keySet().iterator();while(iter.hasNext()){StringattrName=iter.next();writeToBuffer(""+attrName+"=\""+extraAttributes.get(attrName)+"\"",buffer);
ifthesuppliedfeaturehastobeincludedintheoutputaccordingtostyle*filters.*@throwsIOException
ifanerroroccursduringtheprocess*/protectedbooleanprocessStyle(SimpleFeatureft,FeatureTypeStyle[]ftsList)throwsIOException{inttotal=0;for(inti=0;i<ftsList.length;i++){FeatureTypeStylefts=ftsList[i];Rule[]rules=filterRules(fts,ft);total+=rules.length;for(intj=0;j<rules.length;j++)processRule(ft,rules[j]);
if(total==0)returnfalse;returntrue;
ifanerroroccursduringtheprocess*/protectedvoidprocessRule(SimpleFeatureft,Rulerule)throwsIOException{Symbolizer[]symbolizers=rule.getSymbolizers();for(inti=0;i<symbolizers.length;i++){Symbolizersymbolizer=symbolizers[i];//processanygivensymbolizerprocessSymbolizer(ft,rule,symbolizer);
ifanerroroccursduringtheprocess*/protectedvoidprocessSymbolizer(SimpleFeatureft,Rulerule,Symbolizersymbolizer)throwsIOException{
if(symbolizerinstanceofTextSymbolizer){//TODO:anycheckforlabeldefinitionneededhere?Expressione=SLD.textLabel((TextSymbolizer)symbolizer);//evallabelactualvalueObjectobject=e.evaluate(ft);Stringvalue=null;
if(objectinstanceofString){value=(String)object;
else{
if(object!=null){value=object.toString();
ifanylabelisdefinedappendanewextraattribute//theattributenameisequaltothecurrentrulename(ifdefined,defaultsto//"title")//thevalueoftheattributeisthecurrentlabelvalue
if((value!=null)&&!"".equals(value.trim())){StringattrName=rule.getName();
if(attrName==null||attrName.trim().equals(""))attrName="title";extraAttributes.put(attrName,value);
ifanerroroccursduringencoding*/protectedvoidwritePathContent(Coordinate[]coords,StringBufferbuf)throwsIOException{StringBuffertempBuf=newStringBuffer();intnCoords=coords.length;for(inti=0;i<nCoords;i++){Coordinatecurr=coords[i];Stringp=getPoint(curr);tempBuf.append(""+p);
ifit'snotalreadyclosed
if(!coords[nCoords-1].equals2D(coords[0]))tempBuf.append(""+coords[0].x+","+coords[0].y);
if(tempBuf.length()>0)writeToBuffer(tempBuf.substring(1),buf);
elsethrownewIOException("Nocoordinates");
if(symbolizerinstanceofPointSymbolizer){Markmark=SLD.mark((PointSymbolizer)symbolizer);Graphicgraphic=SLD.graphic((PointSymbolizer)symbolizer);
if(graphic!=null&&mark!=null){ObjectoSize=graphic.getSize().evaluate(null);
if(oSize!=null)size=Double.parseDouble(oSize.toString());
ifanerroroccuresduringencoding*/protectedvoidwriteGeometry(Geometrygeom,StringBufferbuf)throwsIOException{
if(geominstanceofPoint){Pointp=(Point)geom;
if(p.getCoordinate()!=null){writeToBuffer(getPoint(p.getCoordinate())+","+(int)Math.round(size),buf);
elsethrownewIOException("nullpointcoordinate");
elsethrownewIOException("Wronggeometry:itshouldbeaPoint");
if(symbolizerinstanceofLineSymbolizer){buffer=SLD.width((LineSymbolizer)symbolizer);
ifanerroroccuresduringencoding*/protectedvoidwriteGeometry(Geometrygeom,StringBufferbuf)throwsIOException{
if(geominstanceofLineString){LineStringl=(LineString)geom;try{//transformbufferdimensiontoworldcoordinatesdoublebufferMultiplier=worldToScreen.createInverse().getScaleX();//getsbufferedlinestringGeometrybuffered=l.buffer(buffer*bufferMultiplier);
if(bufferedinstanceofPolygon){Polygonpoly=(Polygon)decimate(buffered);
if(poly!=null){LineStringshell=poly.getExteriorRing();
if(shell!=null&&shell.getCoordinates()!=null)writePathContent(shell.getCoordinates(),buf);
elsethrownewIOException("Nothingtoencode");
elsethrownewIOException("Nothingtoencode");
else{thrownewIOException("Impossibletoencode:"+buffered);//TODO:whatkindofgeometrycanabufferoperation//return?
elsethrownewIOException("Wronggeometry:itshouldbeaLineString");
ifanerroroccuresduringencoding*/protectedvoidwriteGeometry(Geometrygeom,StringBufferbuf)throwsIOException{Polygonpoly=null;
if(geominstanceofPolygon){poly=(Polygon)geom;//
ifwehaveanyhole//wecreateanewpolygonwithoutholes//usingtheHolesRemover
if(poly.getNumInteriorRing()>0){poly=HolesRemover.removeHoles(poly,1.0/worldToScreen.getScaleX());
elsethrownewIOException("Impossibletoencode:"+geom);
if(poly!=null){LineStringshell=poly.getExteriorRing();
if(shell!=null&&shell.getCoordinates()!=null)writePathContent(shell.getCoordinates(),buf);
elsethrownewIOException("Nothingtoencode");
elsethrownewIOException("Nothingtoencode");
ifanerroroccursduringencoding*/protectedvoidwriteFeature(SimpleFeatureft,FeatureTypeStyle[]fts)throwsIOException{reset(ft);GeometryCollectiongeomCollection=(GeometryCollection)ft.getDefaultGeometry();for(inti=0;i<geomCollection.getNumGeometries();i++){Geometrygeom=geomCollection.getGeometryN(i);
if(geom!=null){Class<?>gtype=geom.getClass();//retrievestherightfeaturewriter(basedonthecurrentgeometrytype)delegateWriter=(HTMLImageMapFeatureWriter)writers.get(gtype);
if(processStyle(ft,fts)){try{startElement(ft,"."+i);startGeometry(geom);writeGeometry(geom,buffer);endGeometry(geom);endElement(ft);commitBuffer();
if(LOGGER.isLoggable(Level.WARNING))LOGGER.warning("Problemsencodingshape:"+e.getMessage());
if(LOGGER.isLoggable(Level.SEVERE))LOGGER.severe("Problemsencodingshape:"+t.getMessage());
else{buffer=newStringBuffer();
if(LOGGER.isLoggable(Level.WARNING))LOGGER.warning("Problemsencodingshape:nullgeometry");
ifthestylefilters"accept"thefeature*@throwsIOException
ifanerroroccursduringtheprocess*/protectedbooleanprocessStyle(SimpleFeatureft,FeatureTypeStyle[]ftsList)throwsIOException{
if(delegateWriter.processStyle(ft,ftsList)){Iterator<String>iter=delegateWriter.extraAttributes.keySet().iterator();while(iter.hasNext()){StringattrName=(String)iter.next();extraAttributes.put(attrName,delegateWriter.extraAttributes.get(attrName));
elsereturnfalse;
if(geom!=null)delegateWriter.writeGeometry(geom,buf);
elsethrownewIOException("nullgeometry");
if(isStyleNewerThanSample(styleResource,sampleFile)){sampleFile.delete();
ifthegivenSLDresourceisnewerthanthegivensamplefile.**@paramstyleResource*@paramsampleFile*/privatebooleanisStyleNewerThanSample(ResourcestyleResource,ResourcesampleFile){returnstyleResource!=null&&styleResource.getType()==Resource.Type.RESOURCE&&styleResource.lastmodified()>sampleFile.lastmodified();
ifitexists,nullotherwise.**@paramstyle*@throwsIOException*/privateResourcegetSampleFile(StyleInfostyle)throwsIOException{StringfileName=getSampleFileName(style);returngetSampleFile(fileName);
if(style.getWorkspace()!=null){prefix=style.getWorkspace().getName()+"_";
if(style.getWorkspace()!=null){prefix=newString[]{"workspaces",style.getWorkspace().getName()};
if(isSampleExisting(sampleLegend)&&!isStyleSampleInvalid(style)){//usingexistingsample
ifsldhasnotbeenupdatedfrom//latestsampleupdatereturngetSizeFromSample(sampleLegend);
else{//generatesanewsample,andsaveitondisk(inthededicatedfolder)for//laterusagereturncreateNewSample(style,pngOutputFormat);
if(legendGraphicinstanceofBufferedImageLegendGraphic){BufferedImageimage=((BufferedImageLegendGraphic)legendGraphic).getLegend();PNGWriterwriter=newPNGWriter();OutputStreamoutStream=null;try{ResourcesampleFile=sampleLegendFolder.get(getSampleFileName(style));outStream=sampleFile.out();writer.writePNG(image,outStream,0.0f,FilterType.FILTER_NONE);removeStyleSampleInvalidation(style);returnnewDimension(image.getWidth(),image.getHeight());
if(outStream!=null){outStream.close();
if(pngReader!=null){pngReader.close();
if(event.getSource()instanceofStyleInfo){//invalidateremovedstyles(isthisneeded?)invalidateStyleSample((StyleInfo)event.getSource());
if(event.getSource()instanceofStyleInfo){//invalidateupdatedstylesinvalidateStyleSample((StyleInfo)event.getSource());
ifthegivenstylesampleismarkedasinvalid.**@paramstyle*/privatebooleanisStyleSampleInvalid(StyleInfostyle){returninvalidated.contains(getStyleName(style));
ifthestyleisglobal).**@paramstyleInfo*/privateStringgetStyleName(StyleInfostyleInfo){returnstyleInfo.getWorkspace()!=null?(styleInfo.getWorkspace().getName()+":"+styleInfo.getName()):styleInfo.getName();
ifwhateverthedefaultblobstoreisshallbeused*/@NullableStringgetBlobStoreId();/***@paramblobStoreIdthe{@linkBlobStoreInfo#getId()blobstoreid}forthislayer'stiles,or*{@codenull}
ifwhateverthedefaultblobstoreisshallbeused*/voidsetBlobStoreId(@NullableStringblobStoreId);/**@returntheXmetatilingfactor*/intgetMetaTilingX();/**@returntheYmetatilingfactor*/intgetMetaTilingY();/**@parammetaTilingYtheYmetatilingfactor*/voidsetMetaTilingY(intmetaTilingY);/**@parammetaTilingXtheXmetatilingfactor*/voidsetMetaTilingX(intmetaTilingX);/***Getsthedefaultexpirationtimefortilesinthecache.**@returntheexpirationtimefortilesinthecache*/intgetExpireCache();/***Setsthedefaultexpirationtimefortilesinthecache.**@paramexpireCachetheexpirationtime*/voidsetExpireCache(intexpireCache);/***Getsalistof{@linkExpirationRule}definingexpirationtimebyzoomlevel**@returnlistexpirationrulesfortilesinthecache*/List<ExpirationRule>getExpireCacheList();/***Setsthe{@linkExpirationRule}sforexpiringtilesinthecache**@paramexpireCacheListthelistofexpirationrules*/voidsetExpireCacheList(List<ExpirationRule>expireCacheList);/***Getstheexpirationtimetobedeclaredtoclients**@returntheexpirationtime,inseconds*/intgetExpireClients();/***Setstheexpirationtimetobedeclaredtoclients**@paramsecondstheexpirationtime,inseconds*/voidsetExpireClients(intseconds);/***Derivedpropertyfrom{@link#getParameterFilters()},returnstheconfiguredallowablevalues*foraparameterfilteroverthe{@codeSTYLE}key,
ifexists,ortheemptyset.**<p>Thereturnedsetisimmutableanddettachedfromthisobject'sinternalstate**<p>Thereturnedsetshallnotreturnthedefaultstyleforthelayer*/ImmutableSet<String>cachedStyles();/***@seeGeoServerTileLayer#getMimeTypes()*@returnsetofMIMEtypessupportedbythetilelayer*/Set<String>getMimeFormats();/***Getthelistofcached{@linkorg.geowebcache.grid.GridSubset}sforthe{@link*GeoServerTileLayer}**@returnThegridsubsets*/Set<XMLGridSubset>getGridSubsets();/***Setthelistofcached{@linkorg.geowebcache.grid.GridSubset}sforthe{@link*GeoServerTileLayer}**@paramgridSubsetslistofgridsubsetstocache*/voidsetGridSubsets(Set<XMLGridSubset>gridSubsets);/***Setswhetherthetilelayerisenabled**@paramenabled
ifthetilelayerisenabled*/voidsetEnabled(booleanenabled);/**@returntrue
ifthetilelayerisenabled*/booleanisEnabled();/***SetsthesizeoftheguttersurroundingMetaTiles,inpixels.**@seeorg.geowebcache.layer.MetaTile*@paramgutterthesizeofthegutter,inpixels*/voidsetGutter(intgutter);/***SetsthesizeoftheguttersurroundingMetaTiles,inpixels.**@seeorg.geowebcache.layer.MetaTile*@returnthesizeofthegutter,inpixels*/intgetGutter();/***Isthetilelayerconfiguredtoautomaticallycacheallstyles**@returntrue
ifthetilelayerautomaticallycachesallstyles*/booleanisAutoCacheStyles();/***Setwhetherthetilelayershouldautomaticalycacheallstyles**@paramautoCacheStyles
ifthetilelayershouldautomaticallycacheallstyles*/voidsetAutoCacheStyles(booleanautoCacheStyles);/**@returntheparameterFilters*/Set<ParameterFilter>getParameterFilters();/***Replacethesetofparameterfilters**@paramparameterFilters*/voidsetParameterFilters(Set<ParameterFilter>parameterFilters);/***Addaparameterfilter,replacinganyexistingfilterwiththesamekey.**@paramparameterFilter*@returntrue
ifanexistingfilterwasreplaced,falseotherwise.*/booleanaddParameterFilter(ParameterFilterparameterFilter);/***Removethefilterwiththespecifiedkey**@paramkey*@returntrue
ifthefilterexisted,falseotherwise*/booleanremoveParameterFilter(Stringkey);GeoServerTileLayerInfoclone();/***GettheParameterFilterwiththespecifiedkey**@paramkey*/ParameterFiltergetParameterFilter(Stringkey);/***Isthelayercachedin-memory**@returntrue
ifthelayeriscachedin-memory*/booleanisInMemoryCached();/***Setwhetherornotthelayeriscachedin-memory**@paraminMemoryCachedisthelayercachedin-memory*/voidsetInMemoryCached(booleaninMemoryCached);}
if(isStandardDocumentResponse(operation)){//normalexecuteresponseencodingreturnstandardResponse.getMimeType(value,operation);
else{//rawresponse,let'sseewhattheoutputisExecuteResponseTyperesponse=(ExecuteResponseType)value;
if(response.getProcessOutputs()==null){//justastatusreportorafailurereportreturn"text/xml";
if(literal!=null){//literalsareencodedasplainstringsreturn"text/plain";
else
if(complex!=null){//Executeshouldhaveproperlysetupthemimetypereturncomplex.getMimeType();
else{//bboxreturn"text/xml";
if(operation.getParameters()[0]instanceofExecuteType){ExecuteTypeexecute=(ExecuteType)operation.getParameters()[0];returnexecute.getResponseForm()==null||execute.getResponseForm().getRawDataOutput()==null;
if(mimeType!=null){//
ifthereisaBinaryEncoderwecouldexposeamethodthatallows//expressingpreferredtypeasopposedtothisugliness
if(mimeType.indexOf("image")==0){//tifffordownload
if(mimeType.indexOf("tiff")>0){disposition=DISPOSITION_ATTACH;
else
if(mimeType.equals("application/zip")){disposition=DISPOSITION_ATTACH;
else
if(mimeType.equals("application/arcgrid")){disposition=DISPOSITION_ATTACH;
if(isStandardDocumentResponse(operation)){return"execute.xml";
else{ExecuteTypeexecute=(ExecuteType)operation.getParameters()[0];ExecuteResponseTyperesponse=(ExecuteResponseType)value;
if(response.getProcessOutputs()==null){//justastatusreportorafailurereportreturn"execute.xml";
ifit'saliteral,usetext,otherwisegetthecomplexppioandaskfortheextension
if(literal!=null){fext="txt";
else
if(complex!=null){Namename=Ows11Util.name(response.getProcess().getIdentifier());ProcessFactoryfactory=GeoServerProcessors.createProcessFactory(name,true);
if(factory!=null){Map<String,Parameter<?>>resultInfo=factory.getResultInfo(name,null);Parameterp=resultInfo.get(result.getIdentifier().getValue());
if(p!=null){ProcessParameterIOppio=ProcessParameterIO.find(p,ctx,complex.getMimeType());
if(ppioinstanceofComplexPPIO){fext=((ComplexPPIO)ppio).getFileExtension(result.getData().getComplexData().getData().get(0));
if(fext==null){fext="bin";
if(isStandardDocumentResponse(operation)||response.getStatus().getProcessSucceeded()==null){//normalexecuteresponseencodingstandardResponse.write(value,output,operation);
else{//rawresponse,let'sseewhattheoutputisOutputDataTyperesult=(OutputDataType)response.getProcessOutputs().getOutput().get(0);LiteralDataTypeliteral=result.getData().getLiteralData();BoundingBoxTypebbox=result.getData().getBoundingBoxData();
if(literal!=null){writeLiteral(output,literal);
else
if(bbox!=null){writeBBox(output,bbox);
else{writeComplex(output,result);
if(rawResultinstanceofRawDataEncoderDelegate){RawDataEncoderDelegatedelegate=(RawDataEncoderDelegate)rawResult;delegate.encode(output);
else
if(rawResultinstanceofXMLEncoderDelegate){XMLEncoderDelegatedelegate=(XMLEncoderDelegate)rawResult;try{TransformerHandlerxmls=((SAXTransformerFactory)SAXTransformerFactory.newInstance()).newTransformerHandler();xmls.setResult(newStreamResult(output));delegate.encode(xmls);
else
if(rawResultinstanceofCDataEncoderDelegate){try{((CDataEncoderDelegate)rawResult).encode(output);
else
if(rawResultinstanceofBinaryEncoderDelegate){try{((BinaryEncoderDelegate)rawResult).encode(output);
else{thrownewWPSException("Cannotencodeanobjectofclass"+rawResult.getClass()+"inrawform");
if(GeoServerSecurityFilterChain.WEB_CHAIN_NAME.equals(chain.getName())||GeoServerSecurityFilterChain.WEB_LOGIN_CHAIN_NAME.equals(chain.getName())||GeoServerSecurityFilterChain.WEB_LOGOUT_CHAIN_NAME.equals(chain.getName()))assertTrue(chain.isAllowSessionCreation());
elseassertFalse(chain.isAllowSessionCreation());
if(chaininstanceofVariableFilterChain){VariableFilterChainvchain=(VariableFilterChain)chain;assertEquals(GeoServerSecurityFilterChain.DYNAMIC_EXCEPTION_TRANSLATION_FILTER,vchain.getExceptionTranslationName());
if(GeoServerSecurityFilterChain.REST_CHAIN_NAME.equals(vchain.getName())||GeoServerSecurityFilterChain.GWC_CHAIN_NAME.equals(vchain.getName()))assertEquals(GeoServerSecurityFilterChain.FILTER_SECURITY_REST_INTERCEPTOR,vchain.getInterceptorName());
elseassertEquals(GeoServerSecurityFilterChain.FILTER_SECURITY_INTERCEPTOR,vchain.getInterceptorName());
if(batchModel.getObject().getId()!=null&&!TaskManagerBeans.get().getSecUtil().isReadable(getSession().getAuthentication(),batchModel.getObject())){thrownewRestartResponseException(UnauthorizedPage.class);
if(wi.getName().equals(batchModel.getObject().getWorkspace())||TaskManagerBeans.get().getSecUtil().isAdminable(getSession().getAuthentication(),wi)){workspaces.add(wi.getName());
if(batchModel.getObject().getId()!=null&&!TaskManagerBeans.get().getSecUtil().isAdminable(getSession().getAuthentication(),batchModel.getObject())){form.get("name").setEnabled(false);form.get("workspace").setEnabled(false);form.get("description").setEnabled(false);form.get("configuration").setEnabled(false);form.get("frequency").setEnabled(false);form.get("enabled").setEnabled(false);form.get("addNew").setEnabled(false);remove.setEnabled(false);saveButton.setEnabled(false);elementsPanel.setEnabled(false);
if(config!=null){batchModel.getObject().setConfiguration(config);config.getBatches().put(batchModel.getObject().getName(),batchModel.getObject());
if(doReturn){doReturn();
else{form.success(newParamResourceModel("success",getPage()).getString());
if(batchModel.getObject().getConfiguration()!=null&&!batchModel.getObject().getConfiguration().getTasks().containsKey(task.getName())){//deletedinconfigcontinue;
if(!addedTasks.contains(task)&&TaskManagerBeans.get().getSecUtil().isWriteable(BatchPage.this.getSession().getAuthentication(),task.getConfiguration())){tasks.put(task.getFullName(),task);
if(!removedElements.remove(be)){addedTasks.add(task);
if(!addedTasks.remove(be.getTask())){removedElements.add(be);
if(property.equals(BatchElementsModel.INDEX)){returnnewPositionPanel(id,itemModel,this);
if(layerType==EoLayerType.COVERAGE_OUTLINE){//outlinesareonlyvector
if(!(layer.getResource()instanceofFeatureTypeInfo)){continue;
else{//wecanonlyaddrasterlayersfortheothertypes
if(!(layer.getResource()instanceofCoverageInfo)){continue;
if(existingLayerIds.contains(layer.getId())){continue;
if(layer.getResource().getMetadata().get(ResourceInfo.TIME,DimensionInfo.class)==null){continue;
if(orig.getLayerInfo()!=null){modified=newGeoServerTileLayer(orig.getLayerInfo(),gridSetBroker,newState);
else{modified=newGeoServerTileLayer(orig.getLayerGroupInfo(),gridSetBroker,newState);
if(resource.getType()!=Type.RESOURCE){thrownewResourceNotFoundException("Templatenotfound:'"+path+"'");
if(!removed){thrownewRestException("Template'"+path+"'notremoved",HttpStatus.INTERNAL_SERVER_ERROR);
if(resource.getType()!=Type.RESOURCE){thrownewResourceNotFoundException("Templatenotfound:'"+path+"'");
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("PUTtemplate:"+resource.path());
switch(directory.getType()){caseRESOURCE:caseUNDEFINED:thrownewResourceNotFoundException("Directorynotfound:'"+path+"'");default:List<Resource>files=Resources.list(directory,newResources.ExtensionFilter("FTL"),false);List<TemplateInfo>list=newArrayList<>();for(Resourcefile:files){list.add(newTemplateInfo(file));
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("PUTfile:mimetype="+request.getContentType()+",path="+directory.path());
if(workspace!=null){path.add(workspace);
if(store!=null){path.add(store);
if(type!=null){path.add(type);
ifpresentisusedforSASLexchange(optional)*@parampassword
ifpresentisusedforSASLexchange(optional)*@authorXandros*@seeFanoutRabbitMQSender*/publicabstractclassRabbitMQSenderimplementsNotificationSender,Serializable{privatestaticLoggerLOGGER=Logging.getLogger(RabbitMQSender.class);privatestaticfinallongserialVersionUID=1370640635300148935L;protectedStringhost;protectedStringvirtualHost;protectedintport;protectedStringusername;protectedStringpassword;protectedStringuri;protectedConnectionconn;protectedChannelchannel;publicvoidinitialize()throwsException{
if(uri==null){
if(this.username!=null&&!this.username.isEmpty()&&this.password!=null&&!this.password.isEmpty()){this.uri="amqp://"+this.username+":"+this.password+"@"+this.host+":"+this.port;
else{this.uri="amqp://"+this.host+":"+this.port;
if(this.channel!=null){this.channel.close();
if(this.conn!=null){this.conn.close();
if(value.matches(".*,\\s*,.*")){//twoconsequentcommasthrowInvalidSyntaxException();
else
if(value.startsWith(",")||value.endsWith(",")){throwInvalidSyntaxException();
if(component.contains(":")){String[]lowHigh=component.split(":");
if(lowHigh.length!=2){throwInvalidSyntaxException();
else{RangeItemTypeitem=Wcs20Factory.eINSTANCE.createRangeItemType();item.setRangeComponent(component);result.getRangeItems().add(item);
if(this.accountNonExpired!=accountNonExpired){this.accountNonExpired=accountNonExpired;
if(this.accountNonLocked!=accountNonLocked){this.accountNonLocked=accountNonLocked;//calculateGrantedAuthorities();
if(this.credentialsNonExpired!=credentialsNonExpired){this.credentialsNonExpired=credentialsNonExpired;//calculateGrantedAuthorities();
if(authorities==null)authorities=Collections.unmodifiableSet(newTreeSet<GrantedAuthority>());returnauthorities;
if(properties==null)properties=newProperties();returnproperties;
if(o==null)return1;returngetUsername().compareTo(o.getUsername());
ifthesuppliedobjectisa{@codeUser}instancewiththesame{@code*username}value.**<p>Inotherwords,theobjectsareequal
iftheyhavethesameusername,representingthe*sameprincipal.*/@Overridepublicbooleanequals(Objectrhs){
if(rhsinstanceofGeoServerUser){returnusername.equals(((GeoServerUser)rhs).username);
if(authorities!=null)sb.append(StringUtils.collectionToCommaDelimitedString(authorities));sb.append("]");returnsb.toString();}}
if(colors==null)thrownewException("Classnumnotsetted,colorrampnull");returncolors;
if(startColor==null||endColor==null)thrownewException("Startorendcolornotsettedunabletobuildcolorramp");
if(midColor==null){sRed=((double)endColor.getRed()-startColor.getRed())/(double)(classNum-1);sGreen=((double)endColor.getGreen()-startColor.getGreen())/(double)(classNum-1);sBlue=((double)endColor.getBlue()-startColor.getBlue())/(double)(classNum-1);for(inti=0;i<classNum-1;i++){red=(int)(sRed*i+startColor.getRed());green=(int)(sGreen*i+startColor.getGreen());blue=(int)(sBlue*i+startColor.getBlue());colors.add(newColor(red,green,blue));
else{mid=(classNum-1)/2;intrest=(classNum-1)%2;sRed=((double)midColor.getRed()-startColor.getRed())/(double)(mid);sGreen=((double)midColor.getGreen()-startColor.getGreen())/(double)(mid);sBlue=((double)midColor.getBlue()-startColor.getBlue())/(double)(mid);for(inti=0;i<mid;i++){red=(int)(sRed*i+startColor.getRed());green=(int)(sGreen*i+startColor.getGreen());blue=(int)(sBlue*i+startColor.getBlue());colors.add(newColor(red,green,blue));
ifgdaladdoisavailable**@throwsIOException*/publicstaticbooleanisAvailable()throwsIOException{returnnewGdalAddoTransform(newArrayList<String>(),Arrays.asList(2)).checkAvailable();
if(levels==null||levels.size()==0){thrownewValidationException("Levelsismissing,mustcontainatleastonevalue");
else{for(Integerlevel:levels){
if(level==null){thrownewValidationException("Invalidnulllevelfoundinthegdaladdooverviewslevels:"+levels);
if(level<=1){thrownewValidationException("Invalidlevelfoundinthegdaladdooverviewslevels,theymustbepositiveandgreaterthanone:"+level);
if(curr<=previous){thrownewValidationException("Invalidlevelsorder,theymustbeprovidedinincreasingorder,butwehave"+curr+"after"+previous+"in"+levels);
if(datainstanceofFileData){FileDatafd=(FileData)data;returnfd.getFile();
else{thrownewIOException("Canrungdaladdoonlyagainstfiledata");
iftheGHRSSTpluginisremovedandthe*configurationbeanisgone.Sousingplainjanekey/valuesinthesettingsmetadatamap*instead*/publicstaticStringSETTINGS_KEY="ghrsst";publicstaticStringSETTINGS_RDAC_KEY="ghrsst.rdac";publicstaticStringSETTINGS_PROCESSING_LEVEL_KEY="ghrsst.processingLevel";publicstaticStringSETTINGS_SST_TYPE="ghrsst.sstType";publicstaticStringSETTINGS_PRODUCT_STRING="ghrsst.productString";publicstaticfinalLoggerLOGGER=Logging.getLogger(GHRSSTEncoder.class);/**TheGHRSSTspecificationmandatesspecificvariabletypesforwellknownvariables*/privatestaticfinalMap<String,DataType>GHRSST_VARIABLE_TYPES=newHashMap<>();static{GHRSST_VARIABLE_TYPES.put("sea_surface_temperature",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("sea_surface_skin_temperature",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("sea_surface_subskin_temperature",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("sea_surface_foundation_temperature",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("sea_water_temperature",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("sst_dtime",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("sses_bias",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("sses_standard_deviation",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("dt_analysis",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("wind_speed",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("wind_speed_dtime_from_sst",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("sources_of_wind_speed",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("sea_ice_fraction",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("sea_ice_fraction_dtime_from_sst",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("sources_of_sea_ice_fraction",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("aerosol_dynamic_indicator",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("adi_dtime_from_sst",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("sources_of_adi",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("l2p_flags",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("quality_level",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("satellite_zenith_angle",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("solar_zenith_angle",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("surface_solar_irradiance",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("ssi_dtime_from_sst",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("sources_of_ssi",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("or_latitude",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("or_longitude",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("or_number_of_pixels",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("sum_sst",DataType.FLOAT);GHRSST_VARIABLE_TYPES.put("sum_square_sst",DataType.FLOAT);GHRSST_VARIABLE_TYPES.put("adjusted_sea_surface_temperature",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("adjusted_standard_deviation_error",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("bias_to_reference_sst",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("standard_deviation_to_reference_sst",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("sources_of_sst",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("analysed_sst",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("analysis_error",DataType.SHORT);GHRSST_VARIABLE_TYPES.put("sea_ice_fraction",DataType.BYTE);GHRSST_VARIABLE_TYPES.put("sea_ice_fraction_error",DataType.BYTE);
if(v!=null){version=v;
if(var==null){thrownewIllegalArgumentException("Therequestedvariabledoesn'texists:"+variableName);
if(sampleDimensions!=null&&sampleDimensions.length>0){GridSampleDimensionsampleDimension=sampleDimensions[0];inputUoM=sampleDimension.getUnits();double[]noData=sampleDimension.getNoDataValues();
if(noData!=null&&noData.length>0){noDataValue=noData[0];noDataSet=true;
if(!noDataSet){NoDataContainernoDataProperty=CoverageUtilities.getNoDataProperty(sampleGranule);
if(noDataProperty!=null){noDataValue=noDataProperty.getAsSingleValue();noDataSet=true;
if(originalDataType.compareTo(varDataType)>0&&!varDataType.isFloatingPoint()){
switch(varDataType){caseBOOLEAN:break;caseBYTE:dataPacking=DataPacking.BYTE;break;caseSHORT:dataPacking=DataPacking.SHORT;break;caseINT:dataPacking=DataPacking.INT;break;caseLONG:dataPacking=DataPacking.LONG;break;default:thrownewIllegalArgumentException("Don'tknowhowtohandlepackingfordatatype"+varDataType);
if(!(dataPacking==DataPacking.NONE)){
if(bandStatistics==null){bandStatistics=newArrayList<>();for(intj=0;j<sampleDimensions.length;j++){bandStatistics.add(newDataPacking.DataStats());
if(var.findAttribute(NetCDFUtilities.UNITS)==null){Stringunit=null;
if(inputUoM!=null){unit=inputUoM.toString();
if(unit!=null){writer.addVariableAttribute(var,newAttribute(NetCDFUtilities.UNITS,unit));bandVariable.variableUoM=unit;
ifnameandunitsarecf-compliant
if(checkCompliant(var)){writer.addVariableAttribute(var,newAttribute(NetCDFUtilities.STANDARD_NAME,bandName));
if(dataPacking!=DataPacking.NONE){//
ifcopyingattributes,wemightcopyovervalidminandmax,whichmightbeout//ofrangevsthecollectedstats
if(copyAttributes){try(NetcdfDatasetsource=getSourceNetcdfDataset(sampleGranule)){
if(source!=null){VariablesourceVar=source.findVariable(bandName);Doublemin=getDoubleAttribute(sourceVar,NetCDFUtilities.VALID_MIN);Doublemax=getDoubleAttribute(sourceVar,NetCDFUtilities.VALID_MAX);
if(min!=null&&max!=null){stats.update(min,max);
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("FailedtocopyfromsourceNetCDF:"+e.getMessage());
if(noDataSet){NumbernoData=dataPacker!=null?dataPacker.getReservedValue():noDataValue;writer.addVariableAttribute(var,newAttribute(NetCDFUtilities.FILL_VALUE,NetCDFUtilities.transcodeNumber(varDataType,noData)));
if(copyAttributes||extraVariables!=null&&!extraVariables.isEmpty()){try(NetcdfDatasetsource=getSourceNetcdfDataset(sampleGranule)){
if(source!=null){
if(copyAttributes){VariablesourceVar=source.findVariable(bandName);
if(sourceVar==null){LOGGER.info(String.format("Couldnotcopyattributesbecause"+"variable'%s'notfoundinNetCDF/GRIB%s",sampleGranule.getName().toString(),source.getLocation()));
else{for(Attributeatt:sourceVar.getAttributes()){//donotallowoverwriteorattributesinblacklist
if(var.findAttribute(att.getFullName())==null&&isBlacklistedAttribute(att,dataPacking)){writer.addVariableAttribute(var,att);
ifdatapackerissetandwehavemin/maxvalidvalue,repackthem
if(dataPacking!=DataPacking.NONE){VariablesourceVar=source.findVariable(bandName);addValidMinMax(sourceVar,var,dataPacker,writer,NetCDFUtilities.VALID_MIN);addValidMinMax(sourceVar,var,dataPacker,writer,NetCDFUtilities.VALID_MAX);
if(extraVariables!=null){for(NetCDFSettingsContainer.ExtraVariableextra:extraVariables){VariablesourceVar=source.findVariable(extra.getSource());
if(sourceVar==null){LOGGER.info(String.format("Couldnotfindextravariablesource'%s'"+"inNetCDF/GRIB%s",extra.getSource(),source.getLocation()));
else
if(!sourceVar.getDimensionsString().isEmpty()){LOGGER.info(String.format("Onlyscalarextravariablesaresupportedbutsource"+"'%s'inNetCDF/GRIB%shasdimensions'%s'",extra.getSource(),source.getLocation(),sourceVar.getDimensionsString()));
else
if(writer.findVariable(extra.getOutput())!=null){LOGGER.info(String.format("Extravariableoutput'%s'alreadyexists",extra.getOutput()));
else
if(extra.getDimensions().split("\\s").length>1){LOGGER.info(String.format("Extravariableoutput'%s'"+"hastoomanydimensions'%s'",extra.getOutput(),extra.getDimensions()));
else{VariableoutputVar=writer.addVariable(null,extra.getOutput(),sourceVar.getDataType(),extra.getDimensions());for(Attributeatt:sourceVar.getAttributes()){writer.addVariableAttribute(outputVar,att);
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("FailedtocopyfromsourceNetCDF:"+e.getMessage());
if(variableAttributes!=null){for(NetCDFSettingsContainer.VariableAttributeatt:variableAttributes){writer.deleteVariableAttribute(var,att.getKey());writer.addVariableAttribute(var,buildAttribute(att.getKey(),att.getValue()));
if(attribute!=null){returnattribute.getNumericValue().doubleValue();
else{returnnull;
if(attribute!=null){doublevalue=attribute.getNumericValue().doubleValue();intpackedValue=dataPacker.pack(value);writer.addVariableAttribute(var,newAttribute(attributeName,packedValue));
if(COPY_ATTRIBUTES_BLACKLIST.contains(shortName)){returnfalse;
if(dataPacking!=DataPacking.NONE){return!DATA_PACKING_ATTRIBUTES_BLACKLIST.contains(shortName);
if("sst_dtime".equalsIgnoreCase(variableName)&&(version==NetcdfFileWriter.Version.netcdf4_classic||version==NetcdfFileWriter.Version.netcdf4)){//TODO:shouldcheck
ifthisisaL3filereturnDataType.LONG;
if(outDataType==null){outDataType=getDataType(dataType);
if((j>=minY)&&(j<=maxY)){for(inttcol=0;tcol<tileWidth;tcol++){intcol=(tileX*tileWidth)+tcol;
if((col>=minX)&&(col<=maxX)){intk=col;finalintyPos=height-j+minY-1;//Simplysettinglatandlonindexing[numDimensions-1]=k-minX;indexing[numDimensions-2]=yPos;for(intbandIdx=0;bandIdx<bandVariables.length;bandIdx++){BandVariablebandVariable=bandVariables[bandIdx];finalIndexmatrixIndex=bandVariable.matrix.getIndex();matrixIndex.set(indexing);setPixel(k,j,sourceDataType,bandVariable.netCDFDataType,data,bandVariable.matrix,matrixIndex,bandVariable.dataPacker,bandVariable.noDataValue,null,bandIdx);
ifneeded*/protectedvoidinitializeGlobalAttributes(){copyGlobalAttribute();//addcomputedglobalattributeswriter.addGroupAttribute(null,newAttribute("uuid",UUID.randomUUID().toString()));writer.addGroupAttribute(null,newAttribute("netcdf_version_id",NETCDF_LIBRARY_VERSION));StringisoDate=toISODate(newDate());writer.addGroupAttribute(null,newAttribute("date_created",isoDate));writer.addGroupAttribute(null,newAttribute("spatial_resolution",getSpatialResolutionDescription()));DateRangestartEnd=getDatasetDateRange();
if(startEnd!=null){StringstartIsoTime=toISODate(startEnd.getMinValue());writer.addGroupAttribute(null,newAttribute("start_time",startIsoTime));writer.addGroupAttribute(null,newAttribute("time_coverage_start",startIsoTime));StringendIsoTime=toISODate(startEnd.getMaxValue());writer.addGroupAttribute(null,newAttribute("stop_time",endIsoTime));writer.addGroupAttribute(null,newAttribute("time_coverage_end",endIsoTime));
ifwehavetospecifytheunits,thecoordinatescanbesomething//other//thanWGS84,e.g.projected(otherwisetheunitwouldalwaysbedegrees,no?...thespec//isnotclearhere...)double[]resolutions=getResolutions();Stringunit=getAxisUnit();
if(resolutions!=null){writer.addGroupAttribute(null,newAttribute("geospatial_lat_units",unit));writer.addGroupAttribute(null,newAttribute("geospatial_lat_resolution",resolutions[0]));writer.addGroupAttribute(null,newAttribute("geospatial_lon_units",unit));writer.addGroupAttribute(null,newAttribute("geospatial_lon_resolution",resolutions[1]));
if("time".equalsIgnoreCase(dimension.getName())){TreeSet<Object>values=(TreeSet<Object>)dimension.getDimensionValues().getValues();Objectfirst=values.first();
if(firstinstanceofDate){startDate=(Date)first;
else
if(firstinstanceofDateRange){startDate=((DateRange)first).getMinValue();
else{thrownewIllegalArgumentException("Unrecognizeddatatypeforstartdate:"+first);
if(lastinstanceofDate){endDate=(Date)last;
else
if(lastinstanceofDateRange){endDate=((DateRange)first).getMaxValue();
else{thrownewIllegalArgumentException("Unrecognizeddatatypeforenddate:"+first);
if(startDate!=null&&endDate!=null){returnnewDateRange(startDate,endDate);
else{returnnull;
if(!(gridToCRS2DinstanceofAffineTransform2D)){returnnull;
if(resolutions==null){return"Unknown";
if(unit==null){return"";
else
if(unit==NonSI.DEGREE_ANGLE){return"degrees";
else{returnunit.toString();
if(secMgr.checkAuthenticationForAdminRole()){returnnewSecurityWarningsPanel(id);
if(ugService!=null){passwordEncoderName=ugService.getPasswordEncoderName();GeoServerUseruser=ugService.getUserByUsername(ADMIN_USERNAME);
if(user!=null){changeItPage=newEditUserPage(ugService.getName(),user);
if(changeItPage==null){changeItPage=newUserGroupRoleServicesPage();
if(manager.isStrongEncryptionAvailable()){add(newLabel("strongEncryptionMsg",newStringResourceModel("strongEncryption",newSecuritySettingsPage(),null)).add(newAttributeAppender("class",newModel("info-link"),"")));
else{add(newLabel("strongEncryptionMsg",newStringResourceModel("noStrongEncryption",newSecuritySettingsPage(),null)).add(newAttributeAppender("class",newModel("warning-link"),"")));
if(passwordEncoderName!=null){GeoServerPasswordEncoderencoder=manager.loadPasswordEncoder(passwordEncoderName);
if(encoder!=null){visibility=encoder.isReversible();
if(grids==null||grids.size()==0){error.setMessage(newResourceModel("TileMatrixSetEditor.validation.empty").getObject());validatable.error(error);return;
if(curr.getResolution()>=prev.getResolution()){Stringmessage="Eachresolutionshouldbelowerthanit'spriorone.Res["+i+"]=="+curr.getResolution()+",Res["+(i-1)+"]=="+prev.getResolution()+".";error.setMessage(message);validatable.error(error);return;
if(curr.getScaleDenominator()>=prev.getScaleDenominator()){Stringmessage="Eachscaledenominatorshouldbelower"+"thanit'spriorone.Scale["+i+"]=="+curr.getScaleDenominator()+",Scale["+(i-1)+"]=="+prev.getScaleDenominator()+".";error.setMessage(message);validatable.error(error);return;
if(res==null||extent==null){return"--";
if(TileMatrixSetEditor.this.readOnly){removeLink=newLabel("removeLink","");
else{removeLink=newImageAjaxLink<Void>("removeLink",GWCIconFactory.DELETE_ICON){privatestaticfinallongserialVersionUID=1L;@OverrideprotectedvoidonClick(AjaxRequestTargettarget){List<Grid>list=newArrayList<Grid>(grids.getModelObject());intindex=((Integer)getDefaultModelObject()).intValue();list.remove(index);grids.setModelObject(list);target.add(container);
if(null!=res){GridSetInfogridSetInfo=TileMatrixSetEditor.this.info.getObject();DoublemetersPerUnit=gridSetInfo.getMetersPerUnit();
if(metersPerUnit!=null){scaleDenominator=res.doubleValue()*metersPerUnit.doubleValue()/GridSetFactory.DEFAULT_PIXEL_SIZE_METER;
if(null!=scaleDenominator){GridSetInfogridSetInfo=TileMatrixSetEditor.this.info.getObject();finaldoublepixelSize=gridSetInfo.getPixelSize();DoublemetersPerUnit=gridSetInfo.getMetersPerUnit();
if(metersPerUnit!=null){res=pixelSize*scaleDenominator/metersPerUnit;
if(info==null||info.size()==0){setConvertedInput(newArrayList<Grid>(2));return;
if(list.isEmpty()){BoundingBoxextent=newBoundingBox(bbox.getMinX(),bbox.getMinY(),bbox.getMaxX(),bbox.getMaxY());finalintlevels=1;GridSettmpGridset=GridSetFactory.createGridSet("stub",SRS.getEPSG4326(),extent,false,levels,1D,GridSetFactory.DEFAULT_PIXEL_SIZE_METER,tileWidth,tileHeight,false);Gridgrid=tmpGridset.getGridLevels()[0];newGrid.setResolution(grid.getResolution());newGrid.setScaleDenominator(grid.getScaleDenominator());
else{Gridprev=list.get(list.size()-1);newGrid.setResolution(prev.getResolution()/2);newGrid.setScaleDenominator(prev.getScaleDenominator()/2);
ifthisDescribeLayerproducercangeneratetheformatspecifiedby<code>format*</code>,where<code>format</code>istheMIMEtypeoftherequestedresponse.**@paramformattheMIMEtypeoftherequiredoutputformat,mightbe{@codenull}*@returntrue
ifclasscanproduceaDescribeLayerinthepassedformat*/publicbooleancanProduce(Stringformat){returntype.equalsIgnoreCase(format);
if(opinstanceofDescribeLayerRequest){DescribeLayerRequestdlr=(DescribeLayerRequest)op;returndlr.getOutputFormat();
if(output!=null){try{output.flush();
if(layerIt.hasNext()){nextResource=layerIt.next();
else{nextResource=null;
if(layerGroupIt.hasNext()){nextLayerGroup=layerGroupIt.next();
else{nextLayerGroup=null;
if(!hasNext()){thrownewNoSuchElementException("Nomorerecordstoretrieve");
if(nextResource==null){returnnextLayerGroup();
if(nextLayerGroup==null){returnnextLayer();
if(comparator==null){returnnextLayer();
if(c<=0){returnnextLayer();
else{returnnextLayerGroup();
if(infoinstanceofResourceInfo){returnconvertToFeature((ResourceInfo)info);
else{returnconvertToFeature((LayerGroupInfo)info);
if(value!=null){
if(valueinstanceofCollection){((Collection)value).removeAll(Collections.singleton(null));
if(((Collection)value).size()>0){String[]elements=newString[((Collection)value).size()];inti=0;for(Objectelement:(Collection)value){elements[i++]=interpolate(interpolationProperties,element.toString());
else{builder.addElement(mappingElement.getKey(),interpolate(interpolationProperties,value.toString()));
if(mappingElement==mapping.getIdentifierElement()){id=interpolate(interpolationProperties,value.toString());
if(infoinstanceofCoverageInfo){CoverageInfocoverageInfo=((CoverageInfo)info);MetadataMapmetadata=coverageInfo.getMetadata();booleandirectDownloadEnabled=false;//LookforspecificsettingsforthislayerDirectDownloadSettingssettings=DirectDownloadSettings.getSettingsFromMetadata(metadata,GeoServerExtensions.bean(GeoServer.class).getService(CSWInfo.class));
if(settings!=null){directDownloadEnabled=settings.isDirectDownloadEnabled();
if(directDownloadEnabled){StringtypeName=recordDescriptor.getFeatureType().getName().getLocalPart();//customizer=FeatureCustomizer.getCustomizer(typeName);customizer=FeatureCustomizer.getCustomizer(typeName);
if(customizer==null){
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("NoMappingcustomizerhavebeenfoundfor"+typeName+".Mappingcustomizationswillnotbemade");
if(mapping.isIncludeEnvelope()){ReferencedEnvelopebbox=null;try{bbox=resource.boundingBox();
if(bbox!=null){builder.addBoundingBox(bbox);
if(customizer!=null){customizer.customizeFeature(feature,ModificationProxy.unwrap(resource));
if(mapping.isIncludeEnvelope()){ReferencedEnvelopebbox=null;bbox=resource.getBounds();
if(bbox!=null){builder.addBoundingBox(bbox);
if(propertyValue==null){thrownewRuntimeException("Interpolationfailedformissingproperty"+propertyName);
else{result=result.replace(matcher.group(),propertyValue).trim();matcher.reset(result);
if(uri==null){try{uri=newURI(getLocation(store));upload=uri.getScheme()==null||uri.getScheme().toLowerCase().equals("file");
if(upload){finalFilefile=Resources.fromURL(uri.toString()).file();returnrestManager.getPublisher().createStore(store.getWorkspace().getName(),storeType,name,UploadMethod.FILE,store.getType().toLowerCase(),Files.probeContentType(file.toPath()),file.toURI(),null);
else{returnrestManager.getStoreManager().create(store.getWorkspace().getName(),newGSGenericStoreEncoder(storeType,store.getWorkspace().getName(),store.getType(),name,uri.toString(),true));
if(storeInfoinstanceofCoverageStoreInfo){return((CoverageStoreInfo)storeInfo).getURL();
else{//thiswillworkforshapefiles,whichIbelieveistheonlypurelyfile-based//(non-database)vectorstorereturn((DataStoreInfo)storeInfo).getConnectionParameters().get("url").toString();
if(fileRef!=null){StringnativeName=FilenameUtils.getBaseName(fileRef.getLatestVersion());((GSCoverageEncoder)re).setNativeName(nativeName);((GSCoverageEncoder)re).setNativeCoverageName(nativeName);
if(!file.getParentFile().exists()){assertTrue(file.getParentFile().mkdirs());
if(geometry==null){returnnull;
if(geominstanceofPolygon){returnnewMultiPolygon(newPolygon[]{(Polygon)geom},geom.getFactory());
else
if(geominstanceofGeometryCollection){Polygon[]pols=newPolygon[((GeometryCollection)geom).getNumGeometries()];for(inti=0;i<pols.length;i++){pols[i]=(Polygon)((GeometryCollection)geom).getGeometryN(i);
if(value!=null&&!"-".equals(value.trim())){String[]values=value.split("\\s+");for(Strings:values){Doublev=converter.convertToObject(s,locale);
if(v!=null){result.add(v);
if(value==null||value.isEmpty()){return"-";
else{StringBuildersb=newStringBuilder();for(inti=0;i<value.size();i++){Stringstr=converter.convertToString(value.get(i),locale);sb.append(str);
if(i<value.size()-1){sb.append("");
if(width!=null){Doublew=width.evaluate(feature,Double.class);
if(w!=null&&w>buffer){buffer=w;
if(grSize!=null){Doublesize=grSize.evaluate(feature,Double.class);
if(size!=null){buffer=Math.max(buffer,size);
if(gsinstanceofExternalGraphic){ExternalGraphiceg=(ExternalGraphic)gs;Iconicon=null;
if(eg.getInlineContent()!=null){icon=eg.getInlineContent();
else{Stringlocation=eg.getLocation().toExternalForm();//expandembeddedcqlexpressionExpressionexpanded=ExpressionExtractor.extractCqlExpressions(location);Iterator<ExternalGraphicFactory>it=DynamicSymbolFactoryFinder.getExternalGraphicFactories();while(it.hasNext()){try{icon=it.next().getIcon(feature,expanded,eg.getFormat(),-1);
iffound,
ifnotSLDasksustogotothenextone
if(icon!=null){
if(icon!=null){intsize=Math.max(icon.getIconHeight(),icon.getIconWidth());
if(size>buffer){buffer=size;
else
if(gsinstanceofMark){//
ifwegethereitmeanssizewasnull
if(SLDStyleFactory.DEFAULT_MARK_SIZE>buffer){buffer=SLDStyleFactory.DEFAULT_MARK_SIZE;
if(typeName!=null){newView=false;//grabthevirtualtableDataStoreInfostore=getCatalog().getStore(storeId,DataStoreInfo.class);FeatureTypeInfofti=getCatalog().getResourceByStore(store,typeName,FeatureTypeInfo.class);//thetypecanbestillnotsaved
if(fti!=null){typeInfoId=fti.getId();
if(virtualTable==null){thrownewIllegalArgumentException("Thespecifiedfeaturetypedoesnothaveasqlviewattachedtoit");
if(!(dainstanceofJDBCDataStore)){error("CannotcreateaSQLview
ifthestoreisnotdatabasebased");doReturn(StorePage.class);return;
else{newView=true;
if(sql!=null&&!"".equals(sql.trim())){paramProvider.refreshFromSql(sql);parameters.setPageable(false);target.add(parameters);
if(property==SQLViewParamProvider.NAME){text.setRequired(true);
else
if(property==SQLViewParamProvider.REGEXP){text.add(newRegexpValidator());
if(property==SQLViewAttributeProvider.PK){//editorforpkstatusFragmentf=newFragment(id,"checkbox",SQLViewAbstractPage.this);f.add(newCheckBox("identifier",newPropertyModel<>(itemModel,"pk")));returnf;
else
if(property==SQLViewAttributeProvider.TYPE&&isGeometry){Fragmentf=newFragment(id,"geometry",SQLViewAbstractPage.this);f.add(newDropDownChoice<Class<?extendsGeometry>>("geometry",newPropertyModel<>(itemModel,"type"),GEOMETRY_TYPES,newGeometryTypeRenderer()));returnf;
else
if(property==SQLViewAttributeProvider.SRID&&isGeometry){Fragmentf=newFragment(id,"text",SQLViewAbstractPage.this);f.add(newTextField<Integer>("text",newPropertyModel<Integer>(itemModel,"srid")));returnf;
if(sql!=null&&!"".equals(sql.trim())){SimpleFeatureTypenewSchema=null;try{newSchema=testViewDefinition(guessGeometrySrid);
if(newSchema!=null){attProvider.setFeatureType(newSchema,null);target.add(attributes);
iftheviewcanbeusedJDBCDataStoreds=(JDBCDataStore)getCatalog().getDataStore(storeId).getDataStore(null);StringvtName=null;try{//useahighlyrandomnamedo{vtName=UUID.randomUUID().toString();
ifthatworksVirtualTablevt=newVirtualTable(vtName,sql);paramProvider.updateVirtualTable(vt);ds.createVirtualTable(vt);returnguessFeatureType(ds,vt.getName(),guessGeometrySrid);
if(vtName!=null){ds.dropVirtualTable(vtName);
iftheviewcanbeusedJDBCDataStoreds=(JDBCDataStore)getCatalog().getDataStore(storeId).getDataStore(null);StringvtName=null;try{//useahighlyrandomnamedo{vtName=UUID.randomUUID().toString();
ifthatworksds.createVirtualTable(newVirtualTable(vtName,vt));returnds.getSchema(vtName);
if(vtName!=null){ds.dropVirtualTable(vtName);
iftheviewcanbeusedJDBCDataStoreds=(JDBCDataStore)getCatalog().getDataStore(storeId).getDataStore(null);StringvtName=null;try{//useahighlyrandomnamedo{vtName=UUID.randomUUID().toString();
ifthatworksVirtualTablevt=newVirtualTable(vtName,virtualTable);//hidetheprimarykeydefinitionsorwe'llloosesomecolumnsvt.setPrimaryKeyColumns(Collections.emptyList());vt.setEscapeSql(escapeSql);ds.createVirtualTable(vt);returnguessFeatureType(ds,vt.getName(),guessGeometrySrid);
if(vtName!=null){ds.dropVirtualTable(name);
if(adinstanceofGeometryDescriptor){geometries.add(ad.getLocalName());
if(geometries.size()==0||!guessGeometrySrid){returnbase;
if(it.hasNext()){f=it.next();
if(it!=null){it.close();
if(f==null){returnbase;
ifso,trytobuildanoverridefeaturetypeConnectioncx=null;try{store.getConnection(Transaction.AUTO_COMMIT);SimpleFeatureTypeBuildertb=newSimpleFeatureTypeBuilder();tb.setName(base.getName());for(AttributeDescriptorad:base.getAttributeDescriptors()){
if(adinstanceofGeometryDescriptor){GeometryDescriptorgd=(GeometryDescriptor)ad;Geometryg=(Geometry)f.getAttribute(ad.getLocalName());
if(g==null){//nothingnewwecanlearntb.add(ad);
else{Class<?>binding=g.getClass();CoordinateReferenceSystemcrs=null;
if(g.getSRID()>0){//see
ifthedialectcanhandlethisonecrs=store.getSQLDialect().createCRS(g.getSRID(),cx);tb.userData(JDBCDataStore.JDBC_NATIVE_SRID,g.getSRID());
if(crs==null){crs=gd.getCoordinateReferenceSystem();
else{tb.add(ad);
if(t==null){break;
if(t==null){returnoriginal.getMessage();
else{returnt.getMessage();
if(value!=null){try{Pattern.compile(value);
if(currvt!=null){
if(typeInfoId==null||!typeInfoId.equals(curr.getId())){
if(currvt.getName().equals(vtName)){IValidationErrorerr=newValidationError("duplicateSqlViewName").addKey("duplicateSqlViewName").setVariable("name",vtName).setVariable("typeName",curr.getName());validatable.error(err);return;
if(index>=size())index%=size();returnindex;
if(prefix==null){//callothermethodforbackwardcompatabilitypostEncodeReference(obj,ref,writer,context);
if(streamDriver!=null){xs=newSecureXStream(reflectionProvider,streamDriver);
else{xs=newSecureXStream(reflectionProvider);
iflevelis<=forceLevel.*/voidlog(Levellevel,Stringmsg){
if((LOGGER.isLoggable(level)&&forceLevel.intValue()<=level.intValue())){LOGGER.log(level,msg);
if(objinstanceofCatalogImpl){((CatalogImpl)obj).resolve();
if(interfce==ServiceInfo.class){returnServiceInfoImpl.class;
if(interfce==StoreInfo.class){returnStoreInfoImpl.class;
if(interfce==ResourceInfo.class){returnResourceInfoImpl.class;
if(clazz==null){thrownewRuntimeException("Nodefaultmappingfor"+interfce);
if(valueinstanceofCollection&&((Collection)value).isEmpty()){return;
if(valueinstanceofMap&&((Map)value).isEmpty()){return;
if(encryptionFields==null){encryptionFields=Collections.emptySet();
if(entry.getValue()==null){continue;
if(entry.getValue()!=null){Objectvalue=entry.getValue();StringcomplexTypeId=getComplexTypeId(value.getClass());
if(complexTypeId==null){Stringstr=Converters.convert(value,String.class);
if(str==null){str=value.toString();
if(encryptionFields.contains(entry.getKey())&&secMgr!=null){str=secMgr.getConfigPasswordEncryptionHelper().encode(str);
else{writer.startNode(complexTypeId);context.convertAnother(value);writer.endNode();
if("entry".equals(key)){
if(reader.getAttribute("key")!=null){//thisiscase3key=reader.getAttribute("key");//inthiscasewealsosupportcomplexobjects
if(reader.hasMoreChildren()){reader.moveDown();StringtypeId=reader.getNodeName();value=context.convertAnother(null,getComplexTypeClass(typeId));reader.moveUp();
else{value=reader.getValue();
else
if(reader.hasMoreChildren()){//thisiscase4reader.moveDown();key=reader.getValue();reader.moveUp();reader.moveDown();value=reader.getValue();reader.moveUp();
else{booleanold=false;
if(reader.hasMoreChildren()){//thishandlescase2old=true;reader.moveDown();
if(old){reader.moveUp();
if(typeId==null){List<Class>matches=newArrayList<Class>();collectSuperclasses(clazz,matches);for(Iteratorit=matches.iterator();it.hasNext();){Classsper=(Class)it.next();
if(backwardBreifMap.get(sper)==null){it.remove();
if(matches.size()>1){Comparatorcomparator=newComparator<Class>(){publicintcompare(Classc1,Classc2){
if(c2.isAssignableFrom(c1)){return-1;
else{return1;
if(matches.size()>0){typeId=backwardBreifMap.get(matches.get(0));
if(clazz.getSuperclass()==null&&clazz.getInterfaces().length==0){return;
if(clazz.getSuperclass()!=null){collectSuperclasses(clazz.getSuperclass(),matches);
if(!"map".equals(nodeName)){thrownewIllegalArgumentException("Expected<map>butfound<"+nodeName+">");
if(sourceinstanceofMetadataMap){MetadataMapmdmap=(MetadataMap)source;source=mdmap.getMap();
if(!(mapinstanceofMetadataMap)){map=newMetadataMap(map);
if(v!=null){writer.startNode("entry");writer.addAttribute("key",key.toString());writeItem(v,context,writer);writer.endNode();
if(value!=null){map.put(key,value);
if(id!=null&&!referenceByName){writer.startNode("id");writer.setValue(id);writer.endNode();callback.postEncodeReference(source,id,null,writer,context);
else{//usename
ifnoidsetStringname=(String)OwsUtils.get(source,"name");//useworkspacenameasaprefix
ifavailableStringwsName=null;
if(OwsUtils.has(source,"workspace")){WorkspaceInfoworkspace=(WorkspaceInfo)OwsUtils.get(source,"workspace");
if(workspace!=null){wsName=workspace.getName();
ifavailableStringprefixedName;
if(wsName==null&&OwsUtils.has(source,"prefixedName")){prefixedName=(String)OwsUtils.get(source,"prefixedName");
if(prefixedName!=null&&prefixedName.indexOf(":")>0){wsName=prefixedName.substring(0,prefixedName.indexOf(":"));
if(name!=null){writer.startNode("name");
if(wsName==null){writer.setValue(name);
else{writer.setValue(wsName+":"+name);
else{thrownewIllegalArgumentException("Unabletomarshalreferencewithnoidorname.");
if(reader.hasMoreChildren()){while(reader.hasMoreChildren()){reader.moveDown();StringnodeName=reader.getNodeName();
if("workspace".equals(nodeName)){
if(reader.hasMoreChildren()){//specifiedas<workspace><name>[name]</name></workspace>reader.moveDown();pre=reader.getValue();reader.moveUp();
else{//specifiedas<workspace>[name]</workspace>pre=reader.getValue();
else
if("name".equals(nodeName)||"id".equals(nodeName)||"prefix".equals(nodeName)){ref=reader.getValue();
else{ref=reader.getValue();
if(catalog!=null){resolved=ResolvingProxy.resolve(catalog,proxy);
if(unwrapNulls){returnCatalogImpl.unwrap(resolved);
else{returnresolved!=null?CatalogImpl.unwrap(resolved):proxy;
if(elementName==null){elementName=cam.serializedClass(item.getClass());
if(item!=null){
if(subclasses!=null){ClasstheClass=null;for(Classclazz:subclasses){
if(clazz.isInstance(item)){theClass=clazz;break;
if(theClass==null){thrownewConversionException("Unexpecteditem"+item+"whosetypeisnotamong:"+subclasses);
else
if(writerinstanceofJettisonStaxWriter){/**GEOS-7771/GEOS-7873*Workaroundforanarrayserializationbuginjettison1.0.1*Canberemovedwhenweupgradetojettison1.2*/writer.setValue("null");try{FieldoutField=StaxWriter.class.getDeclaredField("out");FieldnodesField=MappedXMLStreamWriter.class.getDeclaredField("nodes");outField.setAccessible(true);nodesField.setAccessible(true);FastStacknodes=(FastStack)nodesField.get(outField.get(writer.underlyingWriter()));
if(nodes.peek()instanceofJSONArray){nodes.pop();
if(subclasses!=null){Stringattribute=reader.getAttribute("type");
if(attribute!=null){theClass=mapper().realClass(attribute);
if(epsg!=null){return"EPSG:"+epsg;
if(str.toUpperCase().startsWith("EPSG:")){try{returnCRS.decode(str);
else{try{returnCRS.parseWKT(str);
if(txinstanceofAffineTransform){AffineTransformatx=(AffineTransform)tx;writer.startNode("transform");writer.startNode("scaleX");writer.setValue(Double.toString(atx.getScaleX()));writer.endNode();writer.startNode("scaleY");writer.setValue(Double.toString(atx.getScaleY()));writer.endNode();writer.startNode("shearX");writer.setValue(Double.toString(atx.getShearX()));writer.endNode();writer.startNode("shearY");writer.setValue(Double.toString(atx.getShearY()));writer.endNode();writer.startNode("translateX");writer.setValue(Double.toString(atx.getTranslateX()));writer.endNode();writer.startNode("translateY");writer.setValue(Double.toString(atx.getTranslateY()));writer.endNode();writer.endNode();
if("range".equals(reader.getNodeName())){while(reader.hasMoreChildren()){reader.moveDown();
if("low".equals(reader.getNodeName())){low=toIntArray(reader.getValue());
else
if("high".equals(reader.getNodeName())){high=toIntArray(reader.getValue());
if("crs".equals(reader.getNodeName())){crs=(CoordinateReferenceSystem)context.convertAnother(null,CoordinateReferenceSystem.class,newSingleValueConverterWrapper(newSRSConverter()));
else
if("transform".equals(reader.getNodeName())){doublesx=1.0,sy=1.0,shx=0.0,shy=0.0,tx=0.0,ty=0.0;while(reader.hasMoreChildren()){reader.moveDown();
if("scaleX".equals(reader.getNodeName())){sx=Double.parseDouble(reader.getValue());
else
if("scaleY".equals(reader.getNodeName())){sy=Double.parseDouble(reader.getValue());
else
if("shearX".equals(reader.getNodeName())){shx=Double.parseDouble(reader.getValue());
else
if("shearY".equals(reader.getNodeName())){shy=Double.parseDouble(reader.getValue());
else
if("translateX".equals(reader.getNodeName())){tx=Double.parseDouble(reader.getValue());
else
if("translateY".equals(reader.getNodeName())){ty=Double.parseDouble(reader.getValue());
if(Double.isInfinite(((Number)range.getMinValue()).doubleValue())){context.convertAnother("-inf");
else{context.convertAnother(range.getMinValue());
if(Double.isInfinite(((Number)range.getMaxValue()).doubleValue())){context.convertAnother("inf");
else{context.convertAnother(range.getMaxValue());
if("min".equals(reader.getNodeName())){
if(!"-inf".equals(reader.getValue())){min=Double.parseDouble(reader.getValue());
if("max".equals(reader.getNodeName())){
if(!"inf".equals(reader.getValue())){max=Double.parseDouble(reader.getValue());
if(sourceinstanceofWorkspaceInfo){callback.postEncodeWorkspace((WorkspaceInfo)source,writer,context);
else{callback.postEncodeNamespace((NamespaceInfo)source,writer,context);
if(catalogObject!=null){Classi=callback.getObjectClass();
if(i!=null){unsafeCopy(catalogObject,emptyObject,i);
if(secMgr!=null&&secMgr.isInitialized()){//setthehintforthemapconverterastowhichfieldstoencodeintheconnection//parameterofthisstorecontext.put(BreifMapConverter.ENCRYPTED_FIELDS_KEY,secMgr.getConfigPasswordEncryptionHelper().getEncryptedFields((StoreInfo)source));
if(storeinstanceofDataStoreInfo){callback.postEncodeDataStore((DataStoreInfo)store,writer,context);
else
if(storeinstanceofCoverageStoreInfo){callback.postEncodeCoverageStore((CoverageStoreInfo)store,writer,context);
else
if(storeinstanceofWMSStoreInfo){callback.postEncodeWMSStore((WMSStoreInfo)store,writer,context);
else
if(storeinstanceofWMTSStoreInfo){callback.postEncodeWMTSStore((WMTSStoreInfo)store,writer,context);
else{thrownewIllegalArgumentException("Unknownstoretype:"+(store==null?"null":store.getClass().getName()));
if(storeinstanceofWMSStoreInfo){WMSStoreInfowmsStore=(WMSStoreInfo)store;MetadataMapmetadata=wmsStore.getMetadata();IntegermaxConnections=null;IntegerconnectTimeout=null;IntegerreadTimeout=null;
if(metadata!=null){maxConnections=metadata.get("maxConnections",Integer.class);connectTimeout=metadata.get("connectTimeout",Integer.class);readTimeout=metadata.get("readTimeout",Integer.class);metadata.remove("maxConnections");metadata.remove("connectTimeout");metadata.remove("readTimeout");
if(wmsStore.getMaxConnections()<=0){wmsStore.setMaxConnections(maxConnections!=null&&maxConnections.intValue()>0?maxConnections:WMSStoreInfoImpl.DEFAULT_MAX_CONNECTIONS);
if(wmsStore.getConnectTimeout()<=0){wmsStore.setConnectTimeout(connectTimeout!=null&&connectTimeout.intValue()>0?connectTimeout:WMSStoreInfoImpl.DEFAULT_CONNECT_TIMEOUT);
if(wmsStore.getReadTimeout()<=0){wmsStore.setReadTimeout(readTimeout!=null&&readTimeout.intValue()>0?readTimeout:WMSStoreInfoImpl.DEFAULT_READ_TIMEOUT);
else
if(storeinstanceofWMTSStoreInfo){WMTSStoreInfowmtsStore=(WMTSStoreInfo)store;MetadataMapmetadata=wmtsStore.getMetadata();IntegermaxConnections=null;IntegerconnectTimeout=null;IntegerreadTimeout=null;
if(metadata!=null){maxConnections=metadata.get("maxConnections",Integer.class);connectTimeout=metadata.get("connectTimeout",Integer.class);readTimeout=metadata.get("readTimeout",Integer.class);metadata.remove("maxConnections");metadata.remove("connectTimeout");metadata.remove("readTimeout");
if(wmtsStore.getMaxConnections()<=0){wmtsStore.setMaxConnections(maxConnections!=null&&maxConnections.intValue()>0?maxConnections:WMTSStoreInfoImpl.DEFAULT_MAX_CONNECTIONS);
if(wmtsStore.getConnectTimeout()<=0){wmtsStore.setConnectTimeout(connectTimeout!=null&&connectTimeout.intValue()>0?connectTimeout:WMTSStoreInfoImpl.DEFAULT_CONNECT_TIMEOUT);
if(wmtsStore.getReadTimeout()<=0){wmtsStore.setReadTimeout(readTimeout!=null&&readTimeout.intValue()>0?readTimeout:WMTSStoreInfoImpl.DEFAULT_READ_TIMEOUT);
if(secMgr!=null){secMgr.getConfigPasswordEncryptionHelper().decode(store);
if(vinstanceofDataStoreInfo){writer.startNode("dataStore");context.convertAnother(v);writer.endNode();
if(vinstanceofCoverageStoreInfo){writer.startNode("coverageStore");context.convertAnother(v);writer.endNode();
if("dataStore".equals(reader.getNodeName())){o=context.convertAnother(map,DataStoreInfoImpl.class);
else{o=context.convertAnother(map,CoverageStoreInfoImpl.class);
if(e.getKey()==null){continue;
if(map.get(null)==e.getValue()){writer.addAttribute("default","true");
if("namespace".equals(name)){NamespaceInfoImplns=(NamespaceInfoImpl)context.convertAnother(map,NamespaceInfoImpl.class);map.put(ns.getPrefix(),ns);
if(def){map.put(null,ns);
else{WorkspaceInfoImplws=(WorkspaceInfoImpl)context.convertAnother(map,WorkspaceInfoImpl.class);map.put(ws.getName(),ws);
if(def){map.put(null,ws);
if(featureType.getAttributes()==null){featureType.setAttributes(newArrayList());
if(featureType.getResponseSRS()==null){featureType.setResponseSRS(newArrayList());
if(featureType.getMetadata()==null){featureType.setMetadata(newMetadataMap());
if(l.getName()!=null){writer.setValue(l.getName());
if(null!=authUrlsSerializedForm){//l.getMetadata().put("authorityURLs",authUrlsSerializedForm);//
if(null!=identifiersSerializedForm){//l.getMetadata().put("identifiers",identifiersSerializedForm);//
if(li.getAuthorityURLs()==null&&metadata!=null){Stringserialized=metadata.get("authorityURLs",String.class);List<AuthorityURLInfo>authorities;
if(serialized==null){authorities=newArrayList<AuthorityURLInfo>(1);
else{authorities=AuthorityURLInfoInfoListConverter.fromString(serialized);
if(li.getIdentifiers()==null&&metadata!=null){Stringserialized=metadata.get("identifiers",String.class);List<LayerIdentifierInfo>identifiers;
if(serialized==null){identifiers=newArrayList<LayerIdentifierInfo>(1);
else{identifiers=LayerIdentifierInfoListConverter.fromString(serialized);
if(lgi.getMode()==null){lgi.setMode(Mode.SINGLE);
if(lgi.getTitle()==null&&metadata!=null){Stringtitle=metadata.get("title",String.class);
if(title!=null){lgi.setTitle(title);metadata.remove("title");
if(lgi.getAbstract()==null&&metadata!=null){StringabstractTxt=metadata.get("abstract",String.class);
if(abstractTxt!=null){lgi.setAbstract(abstractTxt);metadata.remove("abstract");
if(lgi.getAuthorityURLs()==null&&metadata!=null){Stringserialized=metadata.get("authorityURLs",String.class);List<AuthorityURLInfo>authorities;
if(serialized==null){authorities=newArrayList<AuthorityURLInfo>(1);
else{authorities=AuthorityURLInfoInfoListConverter.fromString(serialized);
if(lgi.getIdentifiers()==null&&metadata!=null){Stringserialized=metadata.get("identifiers",String.class);List<LayerIdentifierInfo>identifiers;
if(serialized==null){identifiers=newArrayList<LayerIdentifierInfo>(1);
else{identifiers=LayerIdentifierInfoListConverter.fromString(serialized);
if(null!=authUrlsSerializedForm){//l.getMetadata().put("authorityURLs",authUrlsSerializedForm);//
if(null!=identifiersSerializedForm){//l.getMetadata().put("identifiers",identifiersSerializedForm);//
if(vt.getPrimaryKeyColumns()!=null){for(Stringpk:vt.getPrimaryKeyColumns()){writer.startNode("keyColumn");writer.setValue(pk);writer.endNode();
if(vt.getGeometries()!=null){for(Stringgeom:vt.getGeometries()){writer.startNode("geometry");writer.startNode("name");writer.setValue(geom);writer.endNode();writer.startNode("type");writer.setValue(Geometries.getForBinding(vt.getGeometryType(geom)).getName());writer.endNode();writer.startNode("srid");writer.setValue(String.valueOf(vt.getNativeSrid(geom)));writer.endNode();writer.endNode();
if(vt.getParameterNames().size()>0){for(Stringname:vt.getParameterNames()){VirtualTableParameterparam=vt.getParameter(name);writer.startNode("parameter");writer.startNode("name");writer.setValue(name);writer.endNode();
if(param.getDefaultValue()!=null){writer.startNode("defaultValue");writer.setValue(param.getDefaultValue());writer.endNode();
if(param.getValidator()!=null){
if(param.getValidator()instanceofRegexpValidator){writer.startNode("regexpValidator");writer.setValue(((RegexpValidator)param.getValidator()).getPattern().pattern());writer.endNode();
else{thrownewRuntimeException("Cannothandlethistypeofvalidator,"+"pleaseextendtheVirtualTableConverter"+param.getValidator().getClass());
if(reader.getNodeName().equals("keyColumn")){primaryKeys.add(reader.getValue());
else
if(reader.getNodeName().equals("geometry")){StringgeomName=null;Classtype=null;intsrid=-1;while(reader.hasMoreChildren()){reader.moveDown();
if(reader.getNodeName().equals("name"))geomName=reader.getValue();
else
if(reader.getNodeName().equals("type")){GeometriesgeomType=Geometries.getForName(reader.getValue());type=geomType==null?Geometry.class:geomType.getBinding();
else
if(reader.getNodeName().equals("srid")){srid=Converters.convert(reader.getValue(),Integer.class);
else
if(reader.getNodeName().equals("parameter")){Stringpname=null;StringdefaultValue=null;Validatorvalidator=null;while(reader.hasMoreChildren()){reader.moveDown();
if(reader.getNodeName().equals("name")){pname=reader.getValue();
else
if(reader.getNodeName().equals("defaultValue")){defaultValue=reader.getValue();
else
if(reader.getNodeName().equals("regexpValidator")){validator=newRegexpValidator(reader.getValue());
if(pname==null){thrownewIllegalArgumentException("Expectnamebutcouldnotfinditinpropertytag");
else
if(reader.getNodeName().equals("escapeSql")){escapeSql=Boolean.valueOf(reader.getValue());
else
if(reader.getNodeName().equals("name")){name=reader.getValue();
else
if(reader.getNodeName().equals("sql")){sql=reader.getValue();
if(name==null){thrownewIllegalArgumentException("Expectnamebutcouldnotfindit");
if(sql==null){thrownewIllegalArgumentException("Expectsqlbutcouldnotfindit");
if(!m.matches()){thrownewIllegalArgumentException(String.format("%sdoesnotmatchregularexpression:%s",str,RE));
if(m.group(2)!=null){kw.setLanguage(m.group(2));
if(m.group(3)!=null){kw.setVocabulary(m.group(3));
if(kw.getLanguage()!=null){sb.append("\\@language=").append(kw.getLanguage()).append("\\;");
if(kw.getVocabulary()!=null){sb.append("\\@vocabulary=").append(kw.getVocabulary()).append("\\;");
if(obj.getMetadata()==null){obj.setMetadata(newMetadataMap());
if(obj.getContact()==null){obj.setContact(newContactInfoImpl());
if(obj.getClientProperties()==null){obj.setClientProperties(newHashMap<Object,Object>());
if(serviceObject!=null){Classi=callback.getObjectClass();
if(i!=null){OwsUtils.copy(serviceObject,emptyObject,i);
if(str==null){returnnull;
if(encryptPasswordFields){GeoServerSecurityManagersecMgr=getSecurityManager();
if(secMgr!=null){returnsecMgr.getConfigPasswordEncryptionHelper().decode(str);
if(obj==null){returnnull;
if(encryptPasswordFields){GeoServerSecurityManagersecMgr=getSecurityManager();
if(secMgr!=null){returnsecMgr.getConfigPasswordEncryptionHelper().encode((String)obj);
ifweareonthe"web"chainbooleanisOnWebChain=webChainMatcher1.matches(request)||webChainMatcher2.matches(request);
if(isOnWebChain==false)returnfalse;Mapparams=request.getParameterMap();
if(params.size()!=2)returnfalse;String[]pageClass=(String[])params.get("wicket:bookmarkablePage");
if(pageClass==null||pageClass.length!=1)returnfalse;
if(":org.geoserver.web.GeoServerLoginPage".equals(pageClass[0])==false)returnfalse;Stringerror[]=(String[])params.get("error");
if(error==null||error.length!=1)returnfalse;returntrue;
ifaconnectionispossible*/@OverridepublicbooleanisTestDataAvailable(){
if(available!=null)returnavailable;available=super.isTestDataAvailable();
if(!available)returnavailable;//falsePropertiesprops=null;try{props=Util.loadUniversal(newFileInputStream(fixture));
if(driverClassName==null){LOGGER.warning(msgPrefix+"property\"driver\"notfoundin"+fixture.getAbsolutePath());available=false;returnavailable;
if(url==null){LOGGER.warning(msgPrefix+"property\"url\"notfoundin"+fixture.getAbsolutePath());available=false;returnavailable;
if(user==null)user=props.getProperty("username");//tobesureStringpassword=props.getProperty("password");try{Class.forName(driverClassName);
if(user==null)con=DriverManager.getConnection(url);
elsecon=DriverManager.getConnection(url,user,password);con.close();
if(_layerInfo!=null){GeoServerApplicationapp=(GeoServerApplication)getApplication();FeatureTypeInfoft=(FeatureTypeInfo)getResourceInfo();//Override_isNewstate,basedonresourceinformationsintocatalog
if(ft.getId()!=null&&app.getCatalog().getResource(ft.getId(),ResourceInfo.class)!=null){_isNew=false;
else{_isNew=true;
if(fti.getId()==null){modal.add(newOpenWindowOnLoadBehavior());
if(first){ModalWindowwindow=(ModalWindow)getComponent();window.show(target);first=false;
if(!(operation.getParameters()[0]instanceofGetCoverageType))returnfalse;GetCoverageTypegetCoverage=(GetCoverageType)operation.getParameters()[0];returngetCoverage.getOutput().isStore();
if(delegate==null)thrownewWcsException("Couldnotfindencoderforoutputformat"+outputFormat);//grabthecoverageinfoforCoveragesdocumentencodingfinalGridCoverage2Dcoverage=(GridCoverage2D)coverages[0];CoverageInfocoverageInfo=catalog.getCoverageByName(request.getIdentifier().getValue());//writethecoveragetotemporarystorageinthedatadirResourcewcsStore=null;try{GeoServerResourceLoaderloader=geoServer.getCatalog().getResourceLoader();wcsStore=loader.get("temp/wcs");
ifsplittingthesame//nanosecond//withtworequestsshouldnoteverhappen...)ResourcecoverageFile=null;while(true){//TODO:findawaytogetgoodextensionscoverageFile=wcsStore.get(coverageInfo.getName().replace(':','_')+"_"+System.nanoTime()+"."+delegate.getFileExtension(outputFormat));
if(!Resources.exists(coverageFile))break;
if(Character.isDigit(typeName.charAt(0))){builder.append('_');
if(gd!=null){Classbinding=gd.getType().getBinding();
if(Geometry.class.equals(binding)){try{FeatureReaderr=(FeatureReader)format.read(data,item);try{
if(r.hasNext()){SimpleFeaturef=(SimpleFeature)r.next();
if(f.getDefaultGeometry()!=null){binding=f.getDefaultGeometry().getClass();
if(att.equals(gd)){continue;
if(attinstanceofGeometryDescriptor){to.setDefaultGeometry(obj);
else
if(containsAttribute(to,attName(att.getLocalName()))){to.setAttribute(attName(att.getLocalName()),obj);
if(att.getLocalName().equals(attName)){returntrue;
if(featureTypeName.length()>45){SimpleFeatureTypeBuildertypeBuilder=newSimpleFeatureTypeBuilder();featureTypeName=featureTypeName.substring(0,45);typeBuilder.setName(featureTypeName);typeBuilder.addAll(featureType.getAttributeDescriptors());converted=typeBuilder.buildFeatureType();
if(toAttrNames.contains(toName)){to.setAttribute(convertAttributeName(toName),from.getAttribute(name));
if(ORACLE_RESERVED_WORDS.contains(capitalized)){notReserved=capitalized+"_";
else{notReserved=capitalized;
ifitsresolutionisbetterthantheonespreviouslyvisited*/abstractstaticclassCoverageResolutionChooser{double[]resolution;booleanvisit(GridCoverage2Dcoverage)throwsIOException{MathTransform2Dmt=coverage.getGridGeometry().getGridToCRS2D();//cannotdoacomparison
if(!(mtinstanceofAffineTransform2D)){returnfalse;
if(resolution==null){this.resolution=newdouble[2];this.resolution[0]=scaleX;this.resolution[1]=scaleY;returntrue;
if(compare(scaleX,scaleY,resolution)){this.resolution[0]=scaleX;this.resolution[1]=scaleY;returntrue;
else{returnfalse;
if(resolution==null){resolution=reader.getResolutionLevels();referenceName=reader.getGridCoverageNames()[0];
else{double[][]tempRes=reader.getResolutionLevels();
if(tempRes[0][0]<resolution[0][0]&&tempRes[0][1]<resolution[0][1]){resolution=tempRes;referenceName=reader.getGridCoverageNames()[0];
if(resolution==null){resolution=reader.getResolutionLevels();referenceName=reader.getGridCoverageNames()[0];
else{double[][]tempRes=reader.getResolutionLevels();
if(tempRes[0][0]>resolution[0][0]&&tempRes[0][1]>resolution[0][1]){resolution=tempRes;referenceName=reader.getGridCoverageNames()[0];
if(env==null){env=envelope;
else{env.add(envelope);
if(env==null){env=envelope;
else{env.intersect(envelope);
ifthecomposingcoveragesrespecttheconstraintswhich*currentlyare:**<UL>*<LI>sameCRS*<LI>sameresolution*<LI>samebbox*<LI>samedatatype*<LI>samedimensions(samenumberofdimension,sametype,andsamename)*</UL>**WhenJAI-EXTBandMergeisavailable,constraintsonresolutionandbboxcanbeexcluded.*/staticclassCoveragesConsistencyChecker{privatestaticdoubleDELTA=1E-10;privateSet<ParameterDescriptor<List>>dynamicParameters;privateString[]metadataNames;privateGridEnvelopegridRange;privateGeneralEnvelopeenvelope;privateCoordinateReferenceSystemcrs;privateImageLayoutlayout;privatebooleancanSupportHeterogeneousCoverages=false;publicCoveragesConsistencyChecker(GridCoverage2DReaderreader,booleancanSupportHeterogeneousCoverages)throwsIOException{envelope=reader.getOriginalEnvelope();gridRange=reader.getOriginalGridRange();crs=reader.getCoordinateReferenceSystem();metadataNames=reader.getMetadataNames();dynamicParameters=reader.getDynamicParameters();layout=reader.getImageLayout();this.canSupportHeterogeneousCoverages=canSupportHeterogeneousCoverages;
if(!envelope.equals(this.envelope,DELTA,true)){//Throwanexceptionincasewearenotsupportingheterogeneouscoverages
if(!canSupportHeterogeneousCoverages){thrownewIllegalArgumentException("Thecoverageenvelopemustbethesameforallcoverages");
if(!envelope.intersects(this.envelope,true)){thrownewIllegalArgumentException("Thecoverageenvelopesneedtointersecteachother");
if(!thisRectangle.equals(thatRectangle)){
if(!canSupportHeterogeneousCoverages){thrownewIllegalArgumentException("ThecoveragegridRangeshouldbethesameforallcoverages");
if(metadataNames==null){
if(this.metadataNames!=null&&this.metadataNames.length>0){thrownewIllegalArgumentException("ThecoveragemetadataNamesshouldhavethesamesize");
else
if(this.metadataNames==null){
if(metadataNames!=null&&metadataNames.length>0){thrownewIllegalArgumentException("ThecoveragemetadataNamesshouldhavethesamesize");
else
if(metadataNames.length!=this.metadataNames.length){thrownewIllegalArgumentException("ThecoveragemetadataNamesshouldhavethesamesize");
else{finalSet<String>metadataSet=newHashSet<String>(Arrays.asList(metadataNames));for(StringmetadataName:this.metadataNames){
if(!metadataSet.contains(metadataName)){thrownewIllegalArgumentException("Thecoveragemetadataaredifferent");
if(!CRS.equalsIgnoreMetadata(crs,this.crs)){try{destinationToSourceTransform=CRS.findMathTransform(crs,this.crs,true);
if(destinationToSourceTransform!=null&&!destinationToSourceTransform.isIdentity()){thrownewIllegalArgumentException("ThecoveragecoordinateReferenceSystemshouldbethesameforallcoverages");
if(layout.getSampleModel(null).getDataType()!=this.layout.getSampleModel(null).getDataType()){thrownewIllegalArgumentException("ThecoveragedataTypeshouldbethesameforallcoverages");
if(checker==null){checker=newCoveragesConsistencyChecker(reader,supportHeterogeneousCoverages);
else{homogeneousCoverages&=checker.checkConsistency(reader);
if(homogeneousCoverages){returndelegate.getOriginalEnvelope(referenceName);
if(homogeneousCoverages){returndelegate.getResolutionLevels(referenceName);
if(homogeneousCoverages){returndelegate.getOriginalGridRange(referenceName);
if(homogeneousCoverages){returndelegate.getOriginalGridToWorld(referenceName,pixInCell);
if(pixInCell==PixelInCell.CELL_CENTER)returncoverageGridToWorld2D;//wedohavetochangethepixeldatum
if(coverageGridToWorld2DinstanceofAffineTransform){finalAffineTransformtr=newAffineTransform((AffineTransform)coverageGridToWorld2D);tr.concatenate(AffineTransform.getTranslateInstance(-0.5,-0.5));returnProjectiveTransform.create(tr);
switch(selectedResolution){caseWORST:returnnewWorstReaderResolutionComposer();caseBEST:returnnewBestReaderResolutionComposer();default:returnnewBestReaderResolutionComposer();
switch(envelopeCompositionType){caseINTERSECTION:returnnewIntersectionEnvelopeComposer();caseUNION:returnnewUnionEnvelopeComposer();default:returnnewUnionEnvelopeComposer();
if(!(sourceinstanceofFile)){returnfalse;
if(dir.isDirectory()){//Lookfordatastore.propertiesfilewith'type'property//specifyingthisformatFilepropertiesFile=newFile(dir,"datastore.properties");
if(propertiesFile.exists()){Propertiesprops=newProperties();FileInputStreamfis=null;try{fis=newFileInputStream(propertiesFile);props.load(fis);returnTYPE_NAME.equalsIgnoreCase(props.getProperty("type"));
ifthemediatypeprovidedis"included"byoneofthemediatypesdeclared//*in{@link#getSupportedMediaTypes()}//*///protectedbooleanisSupportedMediaType(MediaTypemediaType){//for(MediaTypesupported:getSupportedMediaTypes()){//if(supported.includes(mediaType)){//returntrue;//
elsestartsup*/publicclassGeoserverInitStartupListenerimplementsServletContextListener{staticfinalStringCOM_SUN_JPEG2000_PACKAGE="com.sun.media.imageioimpl.plugins.jpeg2000";privatestaticfinalLoggerLOGGER=Logging.getLogger("org.geoserver.logging");booleanrelinquishLoggingControl;privateIterator<Class<?>>products;privatestaticfinalStringCOMPARISON_TOLERANCE_PROPERTY="COMPARISON_TOLERANCE";privatestaticfinaldoubleDEFAULT_COMPARISON_TOLERANCE=1e-8;publicvoidcontextInitialized(ServletContextEventsce){//startuptctool-removeitbeforecommitting!!!!//newtilecachetool.TCTool().setVisible(true);//Registerlogging,andbridgetoJAIloggingGeoTools.init((Hints)null);//CustomGeoToolsImagingListenerusedtoignorecommonwarningsJAI.getDefaultInstance().setImagingListener(newImagingListener(){finalLoggerLOGGER=Logging.getLogger("javax.media.jai");@OverridepublicbooleanerrorOccurred(Stringmessage,Throwablethrown,Objectwhere,booleanisRetryable)throwsRuntimeException{
if(isSerializableRenderedImageFinalization(where,thrown)){LOGGER.log(Level.FINEST,message,thrown);
else
if(message.contains("ContinuinginpureJavamode")){LOGGER.log(Level.FINE,message,thrown);
else{LOGGER.log(Level.INFO,message,thrown);
if(!(whereinstanceofSerializableRenderedImage)){returnfalse;
ifit'sthefinalizerStackTraceElement[]elements=t.getStackTrace();for(StackTraceElementelement:elements){
if(element.getMethodName().equals("finalize")&&element.getClassName().endsWith("SerializableRenderedImage"))returntrue;
if(!(jaiDef.getOperationRegistry()instanceofConcurrentOperationRegistry||jaiDef.getOperationRegistry()instanceofit.geosolutions.jaiext.ConcurrentOperationRegistry)){jaiDef.setOperationRegistry(ConcurrentOperationRegistry.initializeRegistry());
if(!(jaiDef.getTileCache()instanceofConcurrentTileCacheMultiMap)){jaiDef.setTileCache(newConcurrentTileCacheMultiMap());
ifGeoServercontrolsloggingornotStringstrValue=GeoServerExtensions.getProperty(LoggingUtils.RELINQUISH_LOG4J_CONTROL,sce.getServletContext());relinquishLoggingControl=Boolean.valueOf(strValue);//
iftheserveradmindidnotsetitupotherwise,forceX/Yaxis//ordering//Thisoneisagoodplacebecauseweneedtoinitializethisproperty//beforeanyotheropeationcantriggertheinitializationoftheCRS//subsystem
if(System.getProperty("org.geotools.referencing.forceXY")==null){System.setProperty("org.geotools.referencing.forceXY","true");
if(Boolean.TRUE.equals(Hints.getSystemDefault(Hints.FORCE_LONGITUDE_FIRST_AXIS_ORDER))){Hints.putSystemDefault(Hints.FORCE_AXIS_ORDER_HONORING,"http");
if(comparisonToleranceProperty!=null){try{comparisonTolerance=Double.parseDouble(comparisonToleranceProperty);
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("UnabletoparsethespecifiedCOMPARISON_TOLERANCE"+"systemproperty:"+comparisonToleranceProperty+"whichshouldbeanumber.UsingDefault:"+DEFAULT_COMPARISON_TOLERANCE);
if(COM_SUN_JPEG2000_PACKAGE.equals(spi.getClass().getPackage().getName())){registry.deregisterServiceProvider(spi);
ifanyJDK*classreferencestooneoftheclassesloadedbythewebappclassloader,thentheclassloader*cannotbecollectedandneithercanalltheclassesloadedbyit(sinceeachclasskeepsa*backreferencetotheclassloaderthatloadedit).Thesamehappensforanyresidualthread*launchedbythewebapp.*/publicvoidcontextDestroyed(ServletContextEventsce){try{LOGGER.info("BeginningGeoServercleanupsequence");//thedreadedclassloaderClassLoaderwebappClassLoader=getClass().getClassLoader();//unloadallofthejdbcdriverswehaveloaded.Weneedtostorethemandunregister//latertoavoidconcurrentmodificationexceptionsEnumeration<Driver>drivers=DriverManager.getDrivers();Set<Driver>driversToUnload=newHashSet<Driver>();while(drivers.hasMoreElements()){Driverdriver=drivers.nextElement();try{//thedriverclassloadercanbenull
ifthedrivercomesfromtheJDK,suchas//the//sun.jdbc.odbc.JdbcOdbcDriverClassLoaderdriverClassLoader=driver.getClass().getClassLoader();
if(driverClassLoader!=null&&webappClassLoader.equals(driverClassLoader)){driversToUnload.add(driver);
if(o!=null&&oinstanceofExecutorService){finalThreadPoolExecutorexecutor=(ThreadPoolExecutor)o;try{executor.shutdown();
if(webappClassLoader.equals(provider.getClass().getClassLoader())){providersToUnload.add(provider);
if(factory==null){continue;
if(webappClassLoader.equals(factory.getClass().getClassLoader())){booleanunregistered=false;//weneedtoscanagainstall"products"tounregisterthefactoryVectororderedProductList=opRegistry.getOrderedProductList(mode,red.getName());
if(orderedProductList!=null){for(Iteratorproducts=orderedProductList.iterator();products!=null&&products.hasNext();){Stringproduct=(String)products.next();try{opRegistry.unregisterFactory(mode,red.getName(),product,factory);LOGGER.info("UnregisteringJAIfactory"+factory.getClass());
if(unregistered){unregisteredCount++;
ifallthefactorieswereunregistered,getridofthedescriptoraswell
if(factoryCount>0&&unregisteredCount==factoryCount){opRegistry.unregisterDescriptor(red);
if(!relinquishLoggingControl)LogManager.shutdown();LogFactory.release(Thread.currentThread().getContextClassLoader());//GeoTools/GeoServerhavealotoffinalizersanduntiltheyareruntheJVM//itselfwilkeepuptheclassloader...try{System.gc();System.runFinalization();System.gc();System.runFinalization();System.gc();System.runFinalization();
ifanythinggoessouthduringthecleanupproceduresIwanttoknowwhatitist.printStackTrace();
if(afinstanceofAbstractAuthorityFactory){LOGGER.info("Disposingreferencingfactory"+af);((AbstractAuthorityFactory)af).dispose();
if(!file.isAbsolute()){//inlinux,anabsolutepathmightappearrelative
iftherootslashhasbeenremoved.//Thiscanalsooccurwiththerootpath
ifjava.io.tmpdirisrelative.StringrootPath=folder.getRoot().getPath();StringrootPathWithoutSlash=rootPath.startsWith("/")?rootPath.substring(1):rootPath;
if(path.contains(rootPathWithoutSlash)){file=Paths.toFile(newFile("/"),path);
else{file=Paths.toFile(folder.getRoot(),path);
if(coverageBands==null||coverageBands.isEmpty()){thrownewIllegalArgumentException("Nooutputbandshavebeenspecified");
if(formatMatcher.find()){Stringformat=formatMatcher.group(1);formats.add(format);
ifgdal_translateisavailable,thatis,
ifexecuting"gdal_translate--version"*returns0astheexitcode.*/publicbooleanisAvailable(){List<String>commands=newArrayList<String>();commands.add(getExecutable());commands.add("--version");try{returnrun(commands,null)==0;
iftheidentifiercanhandlethislayer,falseotherwise**@paramlayer*/booleancanHandle(MapLayerInfolayer);/***Returnsafeaturecollectionidentifyingthe"features"foundatthespecifiedlocation**@paramparamsTherequestparameters*@parammaxFeaturesMaxnumberoffeaturestobereturnedforthisidentify*@returnAlistofFeatureCollectionobjects,eachfeatureinthemrepresentanitemtheuser*clickedon*/List<FeatureCollection>identify(FeatureInfoRequestParametersparams,intmaxFeatures)throwsException;}
if(data==null){returnnull;
if(bounds.getCoordinateReferenceSystem()==null){bounds=ReferencedEnvelope.create(bounds,bbox.getCoordinateReferenceSystem());
if(nameinstanceofQName){QNameqName=(QName)name;Stringprefix=qName.getPrefix();
if(prefix==null||"".equals(prefix)){prefix=qName.getNamespaceURI();
if(prefix==null||"".equals(prefix)){prefix=null;
else{returnname.toString();
if(OwsUtils.has(element,"typeName")){returncrsFromTypeName((QName)OwsUtils.get(element,"typeName"));
if(monitorConfig.getBboxMode()!=MonitorConfig.BboxMode.FULL){returnnull;
if(elements==null)returnnull;try{BoundingBoxresult=newReferencedEnvelope(monitorConfig.getBboxCrs());for(Objecte:elements){e=unwrapElement(e);//firstaskforaboundingboxdirectlyReferencedEnvelopebbox=getBBoxFromElement(e);
if(bbox==null){//trytoinferitfromafilteroftherequest//ThisisthedefaultCRSforthelayerbeingqueriedCoordinateReferenceSystemdefaultCrs=getCrsFromElement(e);
if(defaultCrs==null){continue;
if(f!=null){ReferencedEnvelopestartingBbox=newReferencedEnvelope(defaultCrs);bbox=(ReferencedEnvelope)f.accept(visitor,startingBbox);
if(bbox!=null){result.include(bbox.toBounds(monitorConfig.getBboxCrs()));
ifthesetofflowcontrollerschangedsincelastinvocationof{@link*#buildFlowControllers()}*/booleanisStale();}
if(property==NAME){returnnewSimpleAjaxLink<String>(id,(IModel<String>)NAME.getModel(itemModel)){privatestaticfinallongserialVersionUID=-2537227506881638001L;@OverridepublicvoidonClick(AjaxRequestTargettarget){handleStyle(style,target);
if(root.getType()==Type.RESOURCE){thrownewIllegalArgumentException("Gotanexistingreferenceonthefilesystem,butit'snotadirectory:"+root.path());
if(q.getStartIndex()!=null){startIndex=q.getStartIndex();
if(q.getFilter()!=null&&q.getFilter()!=Filter.INCLUDE){Filterfilter=q.getFilter();CSWAnyExpanderexpander=newCSWAnyExpander();Filterexpanded=(Filter)filter.accept(expander,null);records=newFilteringFeatureCollection<FeatureType,Feature>(records,expanded);
if(q.getSortBy()!=null&&q.getSortBy().length>0){Feature[]features=(Feature[])records.toArray(newFeature[records.size()]);Comparator<Feature>comparator=ComplexComparatorFactory.buildComparator(q.getSortBy());Arrays.sort(features,comparator);records=newMemoryFeatureCollection(records.getSchema(),Arrays.asList(features));
if(q.getMaxFeatures()<Query.DEFAULT_MAX){records=newMaxFeaturesFeatureCollection<FeatureType,Feature>(records,q.getMaxFeatures());
if(q.getProperties()!=null&&q.getProperties().size()>0){records=newRetypingFeatureCollection(records,q.getProperties());
if(recordId.equals(f.getIdentifier().getID())){finalResourceresource=it.getLastFile();returnnewRepositoryItem(){@OverridepublicStringgetMime(){return"application/xml";
if((buffer==null)||(response==null)){return;//shouldwethrowanExceptionhere
if(request.getAcceptVersions()!=null)accepted=request.getAcceptVersions().getVersion();Stringversion=RequestUtils.getVersionOws11(provided,accepted);//TODO:addsupportfor1.0.0inhere
if("1.1.0".equals(version)||"1.1.1".equals(version)){WCSCapsTransformercapsTransformer=newWCSCapsTransformer(geoServer);capsTransformer.setEncoding(Charset.forName((getServiceInfo().getGeoServer().getSettings().getCharset())));returncapsTransformer;
if("1.1.0".equals(version)||"1.1.1".equals(version)){WCSInfowcs=getServiceInfo();DescribeCoverageTransformerdescribeTransformer=newDescribeCoverageTransformer(wcs,catalog,responseFactory);describeTransformer.setEncoding(Charset.forName(wcs.getGeoServer().getSettings().getCharset()));returndescribeTransformer;
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest(newStringBuffer("executeCoverageRequestresponse.Calledrequestis:").append(request).toString());
if(identifier==null)thrownewWcsException("Internalerror,thecoverageidentifiermustnotbenull",InvalidParameterValue,"identifier");meta=catalog.getCoverageByName(identifier.getValue());
if(meta==null){thrownewWcsException("Nosuchcoverage:"+request.getIdentifier().getValue());
ifneededfinalGeneralEnvelopeoriginalEnvelope=reader.getOriginalEnvelope();finalBoundingBoxTypebbox=request.getDomainSubset().getBoundingBox();finalCoordinateReferenceSystemnativeCRS=originalEnvelope.getCoordinateReferenceSystem();finalGeneralEnveloperequestedEnvelopeInNativeCRS;finalGeneralEnveloperequestedEnvelope;
if(bbox!=null){//firstoff,parsetheenvelopecornersdouble[]lowerCorner=newdouble[bbox.getLowerCorner().size()];double[]upperCorner=newdouble[bbox.getUpperCorner().size()];for(inti=0;i<lowerCorner.length;i++){lowerCorner[i]=(Double)bbox.getLowerCorner().get(i);upperCorner[i]=(Double)bbox.getUpperCorner().get(i);
ifnocrshasbeensspecified,thenativeoneisassumed
if(bbox.getCrs()==null){requestedEnvelope.setCoordinateReferenceSystem(nativeCRS);requestedEnvelopeInNativeCRS=requestedEnvelope;
else{//otherwiseweneedtotransformfinalCoordinateReferenceSystembboxCRS=CRS.decode(bbox.getCrs());requestedEnvelope.setCoordinateReferenceSystem(bboxCRS);
if(!CRS.equalsIgnoreMetadata(bboxCRS,nativeCRS)){CoordinateOperationFactoryof=CRS.getCoordinateOperationFactory(true);CoordinateOperationco=of.createOperation(bboxCRS,nativeCRS);requestedEnvelopeInNativeCRS=CRS.transform(co,requestedEnvelope);
else{requestedEnvelopeInNativeCRS=newGeneralEnvelope(requestedEnvelope);
else{requestedEnvelopeInNativeCRS=reader.getOriginalEnvelope();requestedEnvelope=requestedEnvelopeInNativeCRS;
if(gridCRS==null){targetCRS=reader.getOriginalEnvelope().getCoordinateReferenceSystem();
else{targetCRS=CRS.decode(gridCRS.getGridBaseCRS());
if(temporalSubset!=null&&temporalSubset.getTimePosition()!=null&&temporalSubset.getTimePosition().size()>0){for(Iteratorit=temporalSubset.getTimePosition().iterator();it.hasNext();){Datetp=(Date)it.next();timeValues.add(tp);
else
if(temporalSubset!=null&&temporalSubset.getTimePeriod()!=null&&temporalSubset.getTimePeriod().size()>0){for(Iteratorit=temporalSubset.getTimePeriod().iterator();it.hasNext();){TimePeriodTypetp=(TimePeriodType)it.next();Datebeginning=(Date)tp.getBeginPosition();Dateending=(Date)tp.getEndPosition();timeValues.add(beginning);timeValues.add(ending);
iftheparameter"TIME"ispresentintheWMSrequest,andbythewayinthereadingparameters.Ifitisthecase,onecanadds*ittotherequest.Ifanexceptionisthrown,wehavenothingtodo.*/finalList<GeneralParameterDescriptor>parameterDescriptors=readParametersDescriptor.getDescriptor().descriptors();ParameterValuetime=null;booleanhasTime=timeValues.size()>0;ParameterValueelevation=null;booleanhasElevation=elevations!=null&&!Double.isNaN(elevations[0]);
if(hasElevation||hasTime){for(GeneralParameterDescriptorpd:parameterDescriptors){finalStringcode=pd.getName().getCode();////TIME//
if(code.equalsIgnoreCase("TIME")){time=(ParameterValue)pd.createValue();time.setValue(timeValues);
if(code.equalsIgnoreCase("ELEVATION")){elevation=(ParameterValue)pd.createValue();elevation.setValue(elevations[0]);
if((hasElevation&&elevation!=null&&hasTime&&time!=null)||!hasElevation&&hasTime&&time!=null||hasElevation&&elevation!=null&&!hasTime)break;
if(hasTime)readParametersClone[readParameters.length+addedParams--]=time;
if(hasElevation)readParametersClone[readParameters.length+addedParams--]=elevation;readParameters=readParametersClone;//Checkwe'renotbeingrequestedtoreadtoomuchdatafrominput(firstcheck,//guessesthegridsizeusingtheinformationcontainedinCoverageInfo)WCSUtils.checkInputLimits(wcs,meta,reader,requestedGridGeometry);////Check
ifwehaveafilteramongtheparams//Filterfilter=WCSUtils.getRequestFilter();
if(filter!=null){readParameters=CoverageUtils.mergeParameter(parameterDescriptors,readParameters,filter,"FILTER","Filter");
if((coverage==null)||!(coverageinstanceofGridCoverage2D)){thrownewIOException("Therequestedcoveragecouldnotbefound.");
if(!intersectionEnvelopeInSourceCRS.contains(coverage.getEnvelope2D(),true)){coverage=WCSUtils.crop(coverage,intersectionEnvelopeInSourceCRS);
if(request.getRangeSubset()!=null){
if(request.getRangeSubset().getFieldSubset().size()>1){thrownewWcsException("Multifieldcoveragesarenotsupportedyet");
if(field.getAxisSubset().size()>1){thrownewWcsException("Multiaxiscoveragesarenotsupportedyet");
if(field.getAxisSubset().size()==1){//prepareasupportstructuretoquicklygetthebandindex//ofa//keyList<CoverageDimensionInfo>dimensions=meta.getDimensions();Map<String,Integer>dimensionMap=newHashMap<String,Integer>();for(inti=0;i<dimensions.size();i++){StringkeyName=dimensions.get(i).getName().replace('','_');dimensionMap.put(keyName,i);
if(index==null)thrownewWcsException("Unknownfield/axis/keycombination"+field.getIdentifier().getValue()+"/"+axisSubset.getIdentifier()+"/"+key);bands[j]=index;
if(interpolationType!=null){
if(interpolationType.equalsIgnoreCase("linear")||interpolationType.equalsIgnoreCase("bilinear")){interpolation=Interpolation.getInstance(Interpolation.INTERP_BILINEAR);
else
if(interpolationType.equalsIgnoreCase("cubic")||interpolationType.equalsIgnoreCase("bicubic")){interpolation=Interpolation.getInstance(Interpolation.INTERP_BICUBIC);
else
if(interpolationType.equalsIgnoreCase("nearest")){interpolation=Interpolation.getInstance(Interpolation.INTERP_NEAREST);
if(reprojectionNeeded){CoordinateOperationFactoryof=CRS.getCoordinateOperationFactory(true);CoordinateOperationco=of.createOperation(nativeCRS,targetCRS);intersectionEnvelope=CRS.transform(co,intersectionEnvelopeInSourceCRS);
else{intersectionEnvelope=intersectionEnvelopeInSourceCRS;
if(gridCRS!=null){Double[]origin=(Double[])gridCRS.getGridOrigin();Double[]offsets=(Double[])gridCRS.getGridOffsets();//fromthespecification
ifgridoriginisomittedandthecrs//is2dthedefaultit's0,0
if(origin==null){origin=newDouble[]{0.0,0.0};
ifnooffsetshasbeenspecifiedwetrytodefaultonthe//nativeones
if(offsets==null){offsets=estimateOffsets(reader,gridCRS,gridToCRS,intersectionEnvelope,reprojectionNeeded);
if(gridCRS.getGridType().equals(GridType.GT2dSimpleGrid.getXmlConstant())){tx=newAffineTransform(offsets[0],0,0,offsets[1],origin[0],origin[1]);
else
if(gridCRS.getGridType().equals(GridType.GT2dGridIn2dCrs.getXmlConstant())){tx=newAffineTransform(offsets[0],offsets[1],offsets[2],offsets[3],origin[0],origin[1]);
else{tx=newAffineTransform(offsets[0],offsets[4],offsets[1],offsets[3],origin[0],origin[1]);
if(origin.length!=3||offsets.length!=6)thrownewWcsException("",InvalidParameterValue,"GridCRS");////ELEVATIONS////TODO:draftcode...itneedsmorestudy!elevationLevels=(int)Math.round(requestedEnvelope.getUpperCorner().getOrdinate(2)-requestedEnvelope.getLowerCorner().getOrdinate(2));//computetheelevationlevels,wehaveelevationLevelsvalues
if(elevationLevels>0){elevations=newdouble[elevationLevels];elevations[0]=requestedEnvelope.getLowerCorner().getOrdinate(2);//TODOputtheextremaelevations[elevationLevels-1]=requestedEnvelope.getUpperCorner().getOrdinate(2);
if(elevationLevels>2){finalintadjustedLevelsNum=elevationLevels-1;doublestep=(elevations[elevationLevels-1]-elevations[0])/adjustedLevelsNum;for(inti=1;i<adjustedLevelsNum;i++)elevations[i]=elevations[i-1]+step;
else{Double[]offsets=estimateOffsets(reader,gridCRS,gridToCRS,intersectionEnvelope,reprojectionNeeded);
if(offsets.length==2){pixelSizeX=Math.abs(offsets[0]);pixelSizeY=Math.abs(offsets[1]);AffineTransformtx=newAffineTransform(offsets[0],0,0,offsets[1],0,0);gridToCRS=newAffineTransform2D(tx);
else{AffineTransformtx=newAffineTransform(offsets[0],offsets[1],offsets[3],offsets[4],0,0);pixelSizeX=Math.abs(XAffineTransform.getScaleX0(tx));pixelSizeY=Math.abs(XAffineTransform.getScaleY0(tx));gridToCRS=newAffineTransform2D(tx);
if(intersectionEnvelope.getSpan(0)<Math.abs(pixelSizeX)){doubleminX=intersectionEnvelope.getMinimum(0);intersectionEnvelope.setRange(0,minX,minX+pixelSizeX);
if(intersectionEnvelope.getSpan(1)<Math.abs(pixelSizeY)){doubleminY=intersectionEnvelope.getMinimum(1);intersectionEnvelope.setRange(1,minY,minY+pixelSizeY);
ifnecessarybooleansameGridGeometry=bandSelectedCoverage.getGridGeometry().equals(destinationGridGeometry);
if(reprojectionNeeded||!sameGridGeometry){finalGridCoverage2DreprojectedCoverage=WCSUtils.resample(bandSelectedCoverage,nativeCRS,targetCRS,destinationGridGeometry,interpolation);returnnewGridCoverage[]{reprojectedCoverage};
else{returnnewGridCoverage[]{bandSelectedCoverage};
if(coverage!=null){CoverageCleanerCallback.addCoverages(coverage);
if(einstanceofWcsException){throw(WcsException)e;
else{thrownewWcsException(e);
if(!(gridToCRSinstanceofAffineTransform2D)&&!(gridToCRSinstanceofIdentityTransform))thrownewWcsException("Internalerror,thecoveragewe'replayingwithdoesnothaveanaffinetransform...");
if(!reprojectionNeeded){
if(gridCRS!=null){
if(gridToCRSinstanceofIdentityTransform){
if(gridCRS.getGridType().equals(GridType.GT2dSimpleGrid.getXmlConstant())||gridCRS.getGridType().equals(GridType.GT2dGridIn2dCrs.getXmlConstant()))offsets=newDouble[]{1.0,-1.0};
elseoffsets=newDouble[]{1.0,0.0,0.0,0.0,-1.0,0.0};
else{AffineTransform2Daffine=(AffineTransform2D)gridToCRS;
if(gridCRS.getGridType().equals(GridType.GT2dSimpleGrid.getXmlConstant())||gridCRS.getGridType().equals(GridType.GT2dGridIn2dCrs.getXmlConstant()))offsets=newDouble[]{affine.getScaleX(),affine.getScaleY()};
elseoffsets=newDouble[]{affine.getScaleX(),affine.getShearX(),affine.getShearY(),affine.getScaleY()};
else{AffineTransform2Dat=(AffineTransform2D)gridToCRS;offsets=newDouble[]{at.getScaleX(),at.getShearX(),0d,at.getShearY(),at.getScaleY(),0d};
else{//theinputresolutionisgoingtobecompletedunrelatedtotheoutputone//makeanestimateassumingwewanttokeeptheoutputrasterwithroughly//thesamesizeastheinputonedoubleteWidth=intersectionEnvelope.getSpan(0);doubleteHeight=intersectionEnvelope.getSpan(1);doubletargetRatio=teWidth/teHeight;GridEnvelopegr=reader.getOriginalGridRange();inttargetRasterWidth=gr.getSpan(0);inttargetRasterHeight=(int)Math.ceil(targetRasterWidth/targetRatio);doublescaleX=teWidth/targetRasterWidth;doublescaleY=-teHeight/targetRasterHeight;
if(gridCRS==null||gridCRS.getGridType().equals(GridType.GT2dSimpleGrid.getXmlConstant())||gridCRS.getGridType().equals(GridType.GT2dGridIn2dCrs.getXmlConstant())){offsets=newDouble[]{scaleX,scaleY};
else{offsets=newDouble[]{scaleX,0.0,0.0,0.0,scaleY,0.0};
if(bbox==null){return;
if("urn:ogc:def:crs:OGC:1.3:CRS84".equals(bbox.getCrs())){bbox.setCrs("EPSG:4326");
if(bboxCRsinstanceofGeographicCRS){try{CoordinateOperationFactorycof=CRS.getCoordinateOperationFactory(true);finalCoordinateOperationoperation=cof.createOperation(gridEnvelope.getCoordinateReferenceSystem(),bboxCRs);gridEnvelopeBboxCRS=CRS.transform(operation,gridEnvelope);
if(lower.get(i)>upper.get(i)){finalCoordinateSystemAxisaxis=bboxCRs.getCoordinateSystem().getAxis(i);//see
ifthecoordinatescanbefixed
if(bboxCRsinstanceofGeographicCRS&&axis.getDirection()==AxisDirection.EAST){
if(gridEnvelopeBboxCRS!=null){//trytoguesswhichoneneedstobefixedfinaldoubleenvMax=gridEnvelopeBboxCRS.getMaximum(i);
if(envMax>=lower.get(i))upper.set(i,upper.get(i)+(axis.getMaximumValue()-axis.getMinimumValue()));
elselower.set(i,lower.get(i)-(axis.getMaximumValue()-axis.getMinimumValue()));
else{//justfixtheupperandhope...upper.set(i,upper.get(i)+(axis.getMaximumValue()-axis.getMinimumValue()));
ifevenafterthefixwe'reinthewrongsituation,complain
if(lower.get(i)>upper.get(i)){thrownewWcsException("illegalbbox,minofdimension"+(i+1)+":"+lower.get(i)+"is"+"greaterthanmaxofsamedimension:"+upper.get(i),WcsExceptionCode.InvalidParameterValue,"BoundingBox");
if(output==null)return;Stringformat=output.getFormat();StringdeclaredFormat=getDeclaredFormat(meta.getSupportedFormats(),format);
if(declaredFormat==null)thrownewWcsException("format"+format+"isnotsupportedforthiscoverage",InvalidParameterValue,"format");finalGridCrsTypegridCRS=output.getGridCRS();
if(gridCRS!=null){//checkgridbasecrsisvalid,andeventuallydefaultitoutStringgridBaseCrs=gridCRS.getGridBaseCRS();
if(gridBaseCrs!=null){//makesuretherequestedisamongthesupportedones,by//makinga//codelevel//comparison(toavoidassumingepsg:xxxxand//http://www.opengis.net/gml/srs/epsg.xml#xxxaredifferent//ones.//We'llalsoconsidertheurnonecomparable,allowingeventual//axisfliponthe//geographiccrsStringactualCRS=null;finalStringgridBaseCrsCode=extractCode(gridBaseCrs);for(Iteratorit=meta.getResponseSRS().iterator();it.hasNext();){finalStringresponseCRS=(String)it.next();finalStringcode=extractCode(responseCRS);
if(code.equalsIgnoreCase(gridBaseCrsCode)){actualCRS=responseCRS;
if(actualCRS==null)thrownewWcsException("CRS"+gridBaseCrs+"isnotamongthesupportedonesforcoverage"+meta.getName(),WcsExceptionCode.InvalidParameterValue,"GridBaseCrs");gridCRS.setGridBaseCRS(gridBaseCrs);
else{Stringcode=GML2EncodingUtils.epsgCode(meta.getCRS());gridCRS.setGridBaseCRS("urn:x-ogc:def:crs:EPSG:"+code);
if(gridTypeValue!=null){type=null;for(GridTypegt:GridType.values()){
if(gt.getXmlConstant().equalsIgnoreCase(gridTypeValue))type=gt;
if(type==null)thrownewWcsException("Unknowngridtype"+gridTypeValue,InvalidParameterValue,"GridType");
else
if(type==GridType.GT2dGridIn3dCrs)thrownewWcsException("Unsupportedgridtype"+gridTypeValue,InvalidParameterValue,"GridType");
if(gridCS!=null){
if(!gridCS.equalsIgnoreCase(GridCS.GCSGrid2dSquare.getXmlConstant()))thrownewWcsException("Unsupportedgridcs"+gridCS,InvalidParameterValue,"GridCS");
if(!gridCRS.isSetGridOrigin()||gridCRS.getGridOrigin()==null){//
ifnotset,wehaveadefaultof"00"asastring,sinceI//cannot//findawaytomakeitdefaulttonewDouble[]{00}I'llfix//ithereDouble[]origin=newDouble[type.getOriginArrayLength()];Arrays.fill(origin,0.0);gridCRS.setGridOrigin(origin);
else{Double[]gridOrigin=(Double[])gridCRS.getGridOrigin();//makesuretheorigindimensionmatchestheoutputcrs//dimension
if(gridOrigin.length!=type.getOriginArrayLength())thrownewWcsException("Gridoriginsize("+gridOrigin.length+")inconsistentwithgridtype"+type.getXmlConstant()+"thatrequires("+type.getOriginArrayLength()+")",WcsExceptionCode.InvalidParameterValue,"GridOrigin");gridCRS.setGridOrigin(gridOrigin);
if(gridOffsets!=null){//makesuretheorigindimensionmatchesthegridtype
if(type.getOffsetArrayLength()!=gridOffsets.length)thrownewWcsException("Invalidoffsetslenght,gridtype"+type.getXmlConstant()+"requires"+type.getOffsetArrayLength(),InvalidParameterValue,"GridOffsets");
else{gridCRS.setGridOffsets(null);
if(srsName.startsWith("http://www.opengis.net/gml/srs/epsg.xml#"))returnsrsName.substring(40);
else
if(srsName.startsWith("urn:"))returnsrsName.substring(srsName.lastIndexOf(':')+1);
else
if(srsName.startsWith("EPSG:"))returnsrsName.substring(5);
elsereturnsrsName;
ifthesupportedformatstringlistcontainsthespecifiedformat,doingacase*insensitivesearch.Iffoundthedeclaredoutputformatnameisreturned,otherwisenullis*returned.**@paramsupportedFormats*@paramformat*/privateStringgetDeclaredFormat(ListsupportedFormats,Stringformat){//supportedformatsmaybesetupusingoldstyleformats,firstscan//the//configuredlistfor(Iteratorit=supportedFormats.iterator();it.hasNext();){Stringsf=(String)it.next();
if(sf.equalsIgnoreCase(format)){returnsf;
else{CoverageResponseDelegatedelegate=responseFactory.encoderFor(sf);
if(delegate!=null&&delegate.canProduce(format))returnsf;
ifnorangesubsethasbeenspecified(it'slegal)
if(rangeSubset==null)return;
if(rangeSubset.getFieldSubset().size()>1){thrownewWcsException("Multifieldcoveragesarenotsupportedyet",InvalidParameterValue,"RangeSubset");
if(!fieldId.equalsIgnoreCase("contents"))thrownewWcsException("Unknownfield"+fieldId,InvalidParameterValue,"RangeSubset");//checkinterpolationStringinterpolation=field.getInterpolationType();
if(interpolation!=null){booleaninterpolationSupported=false;
if(interpolation.equalsIgnoreCase("nearest")){interpolation="nearest";
else
if(interpolation.equalsIgnoreCase("cubic")||interpolation.equalsIgnoreCase("bicubic")){interpolation="bicubic";
else
if(interpolation.equalsIgnoreCase("linear")||interpolation.equalsIgnoreCase("bilinear")){interpolation="bilinear";
if(method.toLowerCase().startsWith(interpolation)){interpolationSupported=true;break;
if(!interpolationSupported)thrownewWcsException("TherequestedInterpolationmethodisnotsupportedbythisCoverage.",InvalidParameterValue,"RangeSubset");
if(field.getAxisSubset().size()>1){thrownewWcsException("Multiaxiscoveragesarenotsupportedyet",InvalidParameterValue,"RangeSubset");
else
if(field.getAxisSubset().size()==0)return;AxisSubsetTypeaxisSubset=(AxisSubsetType)field.getAxisSubset().get(0);finalStringaxisId=axisSubset.getIdentifier();
if(!axisId.equalsIgnoreCase("Bands"))thrownewWcsException("Unknownaxis"+axisId+"infield"+fieldId,InvalidParameterValue,"RangeSubset");//prepareasupportstructuretoquicklygetthebandindexofakey//(andrememberwereplacedspaceswithunderscoresinthekeysto//avoidissues//withthekvpparsingofindentifiersthatincludespaces)List<CoverageDimensionInfo>dimensions=info.getDimensions();Set<String>dimensionMap=newHashSet<String>();for(inti=0;i<dimensions.size();i++){StringkeyName=dimensions.get(i).getName().replace('','_');dimensionMap.add(keyName);
if(dimensionName.equalsIgnoreCase(key)){parsedKey=dimensionName;break;
if(parsedKey==null)thrownewWcsException("Unknownfield/axis/keycombination"+fieldId+"/"+axisSubset.getIdentifier()+"/"+key,InvalidParameterValue,"RangeSubset");
elsekeys.set(j,parsedKey);
ifwearenowinDST,backoffbythedelta.NotethatwearecheckingtheGMTdate,this//istheKEY.
if(tz.inDaylightTime(ret)){DatedstDate=newDate(ret.getTime()-tz.getDSTSavings());//checktomakesurewehavenotcrossedbackintostandardtime//thishappenswhenweareonthecuspofDST(7pmthedaybeforethechangeforPDT)
if(tz.inDaylightTime(dstDate)){ret=dstDate;
if(matcher.apply(request)){blocker.requestComplete(request);
if(matcher.apply(request)){try{retval=blocker.requestIncoming(request,timeout);
if(variableMap!=null){for(inti=0;i<variableMap.length;i+=2){Stringkey=variableMap[i];Stringvalue=variableMap[i+1];xml=xml.replace(key,value);
if(cacheProvider==null){cacheProvider=DefaultCacheProvider.findProvider();
if(dialect==null){this.dialect=Dialect.detect(dataSource);
if(resource!=null){runInitScript(resource);
if(configListener!=null)geoServer.removeListener(configListener);configListener=newConfigClearingListener();geoServer.addListener(configListener);
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Originalfilter:"+filter);LOGGER.finer("Supportedfilter:"+sqlBuilder.getSupportedFilter());LOGGER.finer("Unsupportedfilter:"+sqlBuilder.getUnsupportedFilter());
if(fullySupported){finalMap<String,Object>namedParameters=sqlBuilder.getNamedParameters();logStatement(sql,namedParameters);count=template.queryForObject(sql.toString(),namedParameters,Integer.class);
else{LOGGER.fine("Filterisnotfullysupported,doingscanofsupportedparttoreturnthenumberofmatches");//goingtheexpensiveroute,filteringasmuchaspossibleCloseableIterator<T>iterator=query(of,filter,null,null,(SortBy)null);try{returnIterators.size(iterator);
if(sortOrder==null){returnquery(of,filter,offset,limit,newSortBy[]{});
else{returnquery(of,filter,offset,limit,newSortBy[]{sortOrder});
if(simplifiedFilterinstanceofPropertyIsEqualTo){Stringid=null;PropertyIsEqualToisEqualTo=(PropertyIsEqualTo)simplifiedFilter;
if(isEqualTo.getExpression1()instanceofPropertyName&&isEqualTo.getExpression2()instanceofLiteral&&((PropertyName)isEqualTo.getExpression1()).getPropertyName().equals("id")){ids=Collections.singletonList(((Literal)isEqualTo.getExpression2()).getValue().toString());
if(isEqualTo.getExpression2()instanceofPropertyName&&isEqualTo.getExpression1()instanceofLiteral&&((PropertyName)isEqualTo.getExpression2()).getPropertyName().equals("id")){ids=Collections.singletonList(((Literal)isEqualTo.getExpression1()).getValue().toString());
if(ids==null){finalMap<String,Object>namedParameters=sqlBuilder.getNamedParameters();
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Originalfilter:"+filter);LOGGER.finer("Supportedfilter:"+sqlBuilder.getSupportedFilter());LOGGER.finer("Unsupportedfilter:"+sqlBuilder.getUnsupportedFilter());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(Joiner.on("").join("queryreturned",ids.size(),"recordsin",sw.toString()));
if(fullySupported){result=newCloseableIteratorAdapter<T>(iterator);
else{//Applythefilterresult=CloseableIteratorAdapter.filter(iterator,filter);//Theoffsetandlimitshouldnothavebeenappliedaspartofthequeryassert(!sqlBuilder.isOffsetLimitApplied());//Applyoffsetandlimitsafterfilteringresult=applyOffsetLimit(result,offset,limit);
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Originalfilter:"+filter);LOGGER.finer("Supportedfilter:"+sqlBuilder.getSupportedFilter());LOGGER.finer("Unsupportedfilter:"+sqlBuilder.getUnsupportedFilter());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("queryreturned"+ids.size()+"recordsin"+sw);
if(fullySupported){result=newCloseableIteratorAdapter<String>(iterator);
else{//Applythefilterresult=CloseableIteratorAdapter.filter(iterator,filter);//Theoffsetandlimitshouldnothavebeenappliedaspartofthequeryassert(!sqlBuilder.isOffsetLimitApplied());
if(offset!=null){Iterators.advance(iterator,offset.intValue());
if(limit!=null){iterator=CloseableIteratorAdapter.limit(iterator,limit.intValue());
if(key==null){key=keyHolder.getKey();
if(identityCache.getIfPresent(identity)==null){identityCache.put(identity,id);
else{//notauniqueidentityidentityCache.invalidate(identity);
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Storingpropertiesof"+id+"withpk"+infoPk);
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("Addingproperty"+prop.getPropertyName()+"='"+prop.getValue()+"'");
if(isRelationShip){InforelatedObject=lookUpRelatedObject(info,prop,colIndex);
if(relatedObject==null){concreteTargetPropertyOid=null;
else{//therelatedpropertymayrefertoanabstracttype(e.g.//LayerInfo.resource.name),soweneedtofindouttheactualpropertytypeid(for//example,whetheritbelongstoFeatureTypeInfoorCoverageInfo)relatedObject=ModificationProxy.unwrap(relatedObject);relatedObjectId=this.findObjectId(relatedObject);IntegertargetPropertyOid=prop.getPropertyType().getTargetPropertyOid();PropertyTypetargetProperty;StringtargetPropertyName;Class<?>targetQueryType;ClassMappingsclassMappings=ClassMappings.fromImpl(relatedObject.getClass());targetQueryType=classMappings.getInterface();targetProperty=dbMappings.getPropertyType(targetPropertyOid);targetPropertyName=targetProperty.getPropertyName();Set<Integer>propertyTypeIds;propertyTypeIds=dbMappings.getPropertyTypeIds(targetQueryType,targetPropertyName);checkState(propertyTypeIds.size()==1);concreteTargetPropertyOid=propertyTypeIds.iterator().next();
else{concreteTargetPropertyOid=null;
if(backProp!=null){
if(prop.isCollectionProperty()&&(backPropinstanceofSet||backPropinstanceofList)){List<?>list;
if(backPropinstanceofSet){list=asValueList(backProp);
if(list.size()>0&&list.get(0)!=null&&targetType.isAssignableFrom(list.get(0).getClass())){StringtargetPropertyName=targetPropertyType.getPropertyName();finalPropertyNameexpr=ff.property(targetPropertyName);Collections.sort(list,newComparator<Object>(){@Overridepublicintcompare(Objecto1,Objecto2){Objectv1=expr.evaluate(o1);Objectv2=expr.evaluate(o2);Stringm1=marshalValue(v1);Stringm2=marshalValue(v2);returnm1==null?(m2==null?0:-1):(m2==null?1:m1.compareTo(m2));
else{list=(List<?>)backProp;
if(collectionIndex<=list.size()){backProp=list.get(collectionIndex-1);
if(targetType.isAssignableFrom(backProp.getClass())){return(Info)backProp;
if(valueinstanceofList){values=(List<?>)value;
else
if(valueinstanceofCollection){values=Lists.newArrayList((Collection<?>)value);
else{values=Lists.newArrayList(value);
if(infoinstanceofServiceInfo){disposeServiceCache();
if(updateCount!=1){LOGGER.warning("Requestedtodelete"+info+"("+info.getId()+")butnothinghappenedonthedatabase.");
if(infoinstanceofServiceInfo){disposeServiceCache();
if(infoinstanceofResourceInfo){
if(updateResouceLayersName){updateResourceLayerName((ResourceInfo)info);
if(updateResourceLayersKeywords){updateResourceLayerKeywords((ResourceInfo)info);
if(identityCache.getIfPresent(identity)==null){identityCache.put(identity,id);
else{//notauniqueidentityidentityCache.invalidate(identity);
if(isRelationship){finalInforelatedObject=lookUpRelatedObject(info,changedProp,colIndex);relatedOid=relatedObject==null?null:findObjectId(relatedObject);relatedPropertyType=changedProp.getPropertyType().getTargetPropertyOid();
else{//it'saselfproperty,letsupdatethevalueonthepropertytablerelatedOid=null;relatedPropertyType=null;
if(updateCnt==0){addAttribute(info,oid,changedProp,colIndex,storedValue);
else{//propexistedalready,letsupdateanyrelatedpropertythatpointstoitsold//valueStringupdateRelated="updateobject_propertysetvalue=:value"+"whererelated_oid=:oidandrelated_property_type=:property_typeandcolindex=:colindex";params=params("oid",oid,"property_type",propertyType,"colindex",colIndex,"value",storedValue);logStatement(updateRelated,params);intrelatedUpdateCnt=template.update(updateRelated,params);
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Updated"+relatedUpdateCnt+"backpointerpropertiesto"+changedProp.getPropertyName()+"of"+info.getClass().getSimpleName()+"["+info.getId()+"]");
if(changedProp.isCollectionProperty()){//deleteanyremainingcollectionvaluethat'snolongerinthevaluelistStringsql="deletefromobject_propertywhereoid=:oidandproperty_type=:property_type"+"andcolindex>:maxIndex";IntegermaxIndex=Integer.valueOf(values.size());params=params("oid",oid,"property_type",propertyType,"maxIndex",maxIndex);logStatement(sql,params);template.update(sql,params);
if(CatalogInfo.class.isAssignableFrom(type)){valueLoader=newCatalogLoader(id);
else{valueLoader=newConfigLoader(id);
if(info==null){returnnull;
if(infoinstanceofCatalogInfo){info=resolveCatalog((CatalogInfo)info);
else
if(infoinstanceofServiceInfo){resolveTransient((ServiceInfo)info);
if(type.isAssignableFrom(info.getClass())){//useModificationProxyonlyinthiscaseasreturnedobjectiscached.saveInternal//followssuitecheckingwhethertheobjectbeingsavedisamodproxy,butthat'snot//mandatoryinthisimplementationandshouldonlybethecasewhentheobjectwas//obtainedbyidreturnModificationProxy.create(type.cast(info),type);
if(info==null){returnnull;
if(id==null){returnnull;
else{returngetById(id,type);
if(real==null){returnnull;
if(null==real){return;
if(realinstanceofStyleInfoImpl||realinstanceofStoreInfoImpl||realinstanceofResourceInfoImpl){OwsUtils.set(real,"catalog",catalog);
if(realinstanceofResourceInfoImpl){resolveTransient(((ResourceInfoImpl)real).getStore());
else
if(realinstanceofLayerInfo){LayerInfolayer=(LayerInfo)real;resolveTransient(layer.getDefaultStyle());
if(!layer.getStyles().isEmpty()){for(StyleInfos:layer.getStyles()){resolveTransient(s);
else
if(realinstanceofLayerGroupInfo){for(PublishedInfop:((LayerGroupInfo)real).getLayers()){resolveTransient(p);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("queryreturned"+ids.size()+"recordsin"+sw);
if(id!=null){sql="INSERTINTODEFAULT_OBJECT(DEF_KEY,ID)VALUES(:key,:id)";params=params("key",key,"id",id);logStatement(sql,params);template.update(sql,params);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;ServiceIdentityother=(ServiceIdentity)obj;
if(clazz==null){
if(other.clazz!=null)returnfalse;
else
if(!clazz.equals(other.clazz))returnfalse;
if(workspace==null){
if(other.workspace!=null)returnfalse;
else
if(!workspace.equals(other.workspace))returnfalse;returntrue;
if(id.getWorkspace()!=null&&id.getWorkspace()!=ANY_WORKSPACE){filter=equal("workspace.id",id.getWorkspace().getId());
else{filter=isNull("workspace.id");
iftheimplementthegiveninterface.Sincethereshouldn'tbetoomany//per//workspace,thisshouldn'tbeasignificantperformanceproblem.CloseableIterator<?extendsServiceInfo>it=filterService(id.getClazz(),query(ServiceInfo.class,filter,null,null,(SortBy)null));ServiceInfoservice;
if(it.hasNext()){service=it.next();
else{
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"Couldnotfindserviceoftype"+id.getClazz()+"in"+id.getWorkspace());returnnull;
if(it.hasNext()){LOGGER.log(Level.WARNING,"Foundmultipleservicesoftype"+id.getClass()+"in"+id.getWorkspace());returnnull;
if(infoinstanceofGeoServerInfo){GeoServerInfoImplglobal=(GeoServerInfoImpl)info;
if(global.getMetadata()==null){global.setMetadata(newMetadataMap());
if(global.getClientProperties()==null){global.setClientProperties(newHashMap<Object,Object>());
if(global.getCoverageAccess()==null){global.setCoverageAccess(newCoverageAccessInfoImpl());
if(global.getJAI()==null){global.setJAI(newJAIInfoImpl());
if(infoinstanceofServiceInfo){((ServiceInfo)info).setGeoServer(geoServer);
if(infoinstanceofServiceInfo){//needtofigureouthowtoremoveonlytherelevantcache//entriesfortheserviceinfo,likewithInfoIdentiesbelow,//thatwillbeabletohandlenewservicetypes.disposeServiceCache();
if(it.hasNext()){result=it.next();
if(it.hasNext()){thrownewIllegalArgumentException("Specifiedquerypredicateresultedinmorethanoneobject");
if(it.hasNext()){result=it.next();
if(it.hasNext()){thrownewIllegalArgumentException("Specifiedquerypredicateresultedinmorethanoneobject");
if(validate()){
if(newAttribute){previousPage.attributesProvider.addNewAttribute(attribute);
if(attribute.getName()==null||attribute.getName().trim().equals("")){nameField.error((IValidationError)newValidationError().addKey("Required"));valid=false;
if(String.class.equals(attribute.getBinding())){try{attribute.setSize(Integer.parseInt(size));
if(attribute.getSize()<=0){sizeField.error(newParamResourceModel("notPositive",this));valid=false;
if(Geometry.class.isAssignableFrom(attribute.getBinding())&&attribute.getCrs()==null){crsField.error((IValidationError)newValidationError().addKey("Required"));valid=false;
if(!(oinstanceofEvent)){returnfalse;
if(data==null){//willhappenincaseswherethefilterisnotactivereturn;
if(request.getPathInfo()!=null){Stringresource=request.getPathInfo();finalString[]pathParts=resource.split("/");data.getResources().add(pathParts[pathParts.length-1]);
if(data==null){//willhappenincaseswherethefilterisnotactivereturn;
if(controllerBeaninstanceoforg.geoserver.rest.catalog.AbstractCatalogController||controllerBeaninstanceoforg.geoserver.rest.AbstractGeoServerController){data.setService("RESTConfig");
ifrestconfigisnotintheclasspathLOGGER.log(Level.FINE,"Errorfindingout
ifthecallisarestconfigone",e);
if(updating)return;try{updating=true;GeoServerInfogsInfo=geoServer.getGlobal();gsInfo.setUpdateSequence(gsInfo.getUpdateSequence()+1);geoServer.save(gsInfo);
ifit'sanEOBANDLayer.IfnotreturnuntouchedfinalCoverageInfocinfo=catalogChecks(layer);
if(cinfo==null){thrownewIllegalStateException("Layer"+layer.getTitle()+"doesntoresolvetoacoverage");
if(!(layerinstanceofGridReaderLayer)){thrownewIllegalStateException("Layer"+layer.getTitle()+"doesntoresolvetoacoverage");
if(dimensions.size()!=1){thrownewIllegalStateException("Coverage"+cinfo.getName()+"hasanumberofdimensionsdifferentthan1");
if(p.getDescriptor().getName().equals(ImageMosaicFormat.MERGE_BEHAVIOR.getName())){//foundit,enfocecardinality((ParameterValue)p).setValue(MergeBehavior.STACK.name());break;
if(p.getDescriptor().getName().equals(paramName)){//foundit,enfocecardinalityListvalue=(List)((ParameterValue)p).getValue();
if(value.size()!=1&&value.size()!=3){thrownewIllegalStateException();
if(timeDimension.getResolution()!=null){setupResolution(timeDimension.getResolution());
if(resolution.remainder(duration).longValue()==0){resolutionValue=resolution.divide(duration).longValue();resolutionUnit=DURATION_UNITS[i];return;
if(time!=null){returnformatter.format(time);
else{returnnull;
if(mapping.getMethodsCondition().getMethods().contains(RequestMethod.GET)){for(Stringpattern:mapping.getPatternsCondition().getPatterns()){
if(!pattern.contains("{")){Stringpath=pattern;//excludeotherrestapis,likegwc/restfinalintrootSize=RestBaseController.ROOT_PATH.length()+1;
if(path.startsWith(RestBaseController.ROOT_PATH)&&path.length()>rootSize){//trimrootpathpath=path.substring(rootSize);
if(path.endsWith("/**")){path=path.substring(0,path.length()-3);
if(path.length()>0){s.add(path);
if(exinstanceofUsernameNotFoundException||exinstanceofBadCredentialsException||exinstanceofDisabledException){l=Level.FINE;
iftheschemaLDIFfilesarenotfoundontheclasspath*/privatevoidinitSchemaPartition()throwsException{SchemaPartitionschemaPartition=service.getSchemaService().getSchemaPartition();//InittheLdifPartitionLdifPartitionldifPartition=newLdifPartition();StringworkingDirectory=service.getWorkingDirectory().getPath();ldifPartition.setWorkingDirectory(workingDirectory+"/schema");//Extracttheschemaondisk(abrandnewone)andloadtheregistriesFileschemaRepository=newFile(workingDirectory,"schema");SchemaLdifExtractorextractor=newDefaultSchemaLdifExtractor(newFile(workingDirectory));extractor.extractOrCopy(true);schemaPartition.setWrappedPartition(ldifPartition);SchemaLoaderloader=newLdifSchemaLoader(schemaRepository);SchemaManagerschemaManager=newDefaultSchemaManager(loader);service.setSchemaManager(schemaManager);//Wehavetoloadtheschemanow,otherwisewewon'tbeable//toinitializethePartitions,aswewon'tbeabletoparse//andnormalizetheirsuffixDNschemaManager.loadAllEnabled();schemaPartition.setSchemaManager(schemaManager);List<Throwable>errors=schemaManager.getErrors();
if(errors.size()!=0){thrownewException("Schemaloadfailed:"+errors);
ifthereweresomeproblemswhileinitializingthesystem*/privatevoidinitDirectoryService(FileworkDir)throwsException{//InitializetheLDAPserviceservice=newDefaultDirectoryService();service.setWorkingDirectory(workDir);//firstloadtheschemainitSchemaPartition();//thenthesystempartition//thisisaMANDATORYpartitionPartitionsystemPartition=addPartition("system",ServerDNConstants.SYSTEM_DN);service.setSystemPartition(systemPartition);//DisabletheChangeLogsystemservice.getChangeLog().setEnabled(false);service.setDenormalizeOpAttrsEnabled(true);//NowwecancreateasmanypartitionsasweneedPartitionacmePartition=addPartition("acme","dc=acme,dc=org");//Indexsomeattributesontheapachepartition//addIndex(apachePartition,"objectClass","ou","uid");addIndex(acmePartition,"objectClass","ou","uid");//Andstarttheserviceservice.startup();//Injectthefoorootentry
ifitdoesnotalreadyexisttry{service.getAdminSession().lookup(acmePartition.getSuffixDn());
if(!service.getAdminSession().exists(peopleDn)){ServerEntrye=service.newEntry(peopleDn);e.add("objectClass","organizationalUnit");e.add("ou","people");service.getAdminSession().add(e);
if(!service.getAdminSession().exists(groupsDn)){ServerEntrye=service.newEntry(groupsDn);e.add("objectClass","organizationalUnit");e.add("ou","groups");service.getAdminSession().add(e);
if(!service.getAdminSession().exists(dn)){ServerEntrye=service.newEntry(dn);e.add("objectClass","groupOfNames");e.add("cn",groupname);for(Stringuser:users){e.add("member",format("uid=%s,ou=people,dc=acme,dc=org",user));
if(!service.getAdminSession().exists(dn)){ServerEntrye=service.newEntry(dn);e.add("objectClass","person","inetOrgPerson");e.add("uid",username);e.add("givenName",displayName);e.add("sn",displayName);e.add("cn",displayName);e.add("displayName",displayName);e.add("userPassword",passwd.getBytes());service.getAdminSession().add(e);
if(e.hasObjectClass("person")){indent+="";
if(e.hasObjectClass("groupOfNames")){indent+="";
if(e.hasObjectClass("groupOfNames")){System.out.print(e.get("member"));
if(!(objectinstanceofDomains)){thrownewIllegalArgumentException("Expecteddomainsinfobutinsteadgot:"+object.getClass().getCanonicalName());
if(geometryinstanceofPoint){elementName=org.geotools.gml2.GML.Point;
else
if(geometryinstanceofLineString){elementName=org.geotools.gml2.GML.LineString;
else
if(geometryinstanceofPolygon){elementName=org.geotools.gml2.GML.Polygon;
else
if(geometryinstanceofMultiPoint){elementName=org.geotools.gml2.GML.MultiPoint;
else
if(geometryinstanceofMultiLineString){elementName=org.geotools.gml2.GML.MultiLineString;
else
if(geometryinstanceofMultiPolygon){elementName=org.geotools.gml2.GML.MultiPolygon;
ifpossible
if(!RemoteOWSTestSupport.isRemoteWMSStatesAvailable(LOGGER)){return;
if(!RemoteOWSTestSupport.isRemoteWMSStatesAvailable(LOGGER)){LOGGER.log(Level.WARNING,"SkippingtestNoRestrictions");return;
if(!RemoteOWSTestSupport.isRemoteWMSStatesAvailable(LOGGER)){LOGGER.log(Level.WARNING,"SkippingtestGetMapDisallowed");return;
if(!RemoteOWSTestSupport.isRemoteWMSStatesAvailable(LOGGER)){LOGGER.log(Level.WARNING,"SkippingtestGetMapFiltered");return;
if(!RemoteOWSTestSupport.isRemoteWMSStatesAvailable(LOGGER)){LOGGER.log(Level.WARNING,"SkippingtestNoRestrictions");return;
if(!RemoteOWSTestSupport.isRemoteWMSStatesAvailable(LOGGER)){LOGGER.log(Level.WARNING,"SkippingtestNoRestrictions");return;
if(!RemoteOWSTestSupport.isRemoteWMSStatesAvailable(LOGGER)){LOGGER.log(Level.WARNING,"SkippingtestNoRestrictions");return;
if(!RemoteOWSTestSupport.isRemoteWMSStatesAvailable(LOGGER)){LOGGER.log(Level.WARNING,"SkippingtestNoRestrictions");return;
if(pvalue!=null){enabled=Boolean.parseBoolean(pvalue);
else{enabled=true;
if(!enabled){return;
if(LOGGER.isLoggable(LEVEL)){LOGGER.log(LEVEL,"Thread"+Thread.currentThread().getId()+"gotthelockinmode"+type);
ifitisavailableandreturns*immediatelywiththevaluetrue.Ifthelockisnotavailablethenthismethodwillreturn*immediatelywiththevaluefalse.**<p>Atypicalusageidiomforthismethodwouldbe:**<pre>*Locklock=...;*
if(lock.tryLock()){*try{*//manipulateprotectedstate*
else{*//performalternativeactions*}}*</pre>**Thisusageensuresthatthelockisunlocked
ifitwasacquired,anddoesn'ttrytounlock
if*thelockwasnotacquired.**@paramtype*@returntrue
ifthelockwasacquiredandfalseotherwise*/publicbooleantryLock(LockTypetype){
if(!enabled){returntrue;
if(res){currentLock.set(type);
if(LOGGER.isLoggable(LEVEL)){
if(res){LOGGER.log(LEVEL,"Thread"+Thread.currentThread().getId()+"gotthelockinmode"+type);
else{LOGGER.log(LEVEL,"Thread"+Thread.currentThread().getId()+"couldnotgetthelockinmode"+type);
ifthelockupgradesucceeded,falseincaseitfailed.Incaseoffailurethe*previouslyownedreadlockisalsolost.*/publicvoidtryUpgradeLock(){LockTypelock=currentLock.get();
if(lock==null){thrownewIllegalStateException("Nolockcurrentlyheld");
else
if(lock==LockType.WRITE){thrownewIllegalStateException("Alreadyowningawritelock");
else{//corejavadoesnothaveanotionoflockupgrade,onehastoreleasethe//readlockandgetawriteoneunlock();
if(tryLock(LockType.WRITE)){currentLock.set(LockType.WRITE);
else{currentLock.set(null);thrownewRuntimeException("Failedtoupgradelockfromreadtowrite"+"state,pleasere-trytheconfigurationoperation");
if(!enabled){return;
if(type==null){return;
if(LOGGER.isLoggable(LEVEL)){LOGGER.log(LEVEL,"Thread"+Thread.currentThread().getId()+"releasingthelockinmode"+type);
if(type==LockType.WRITE){lock=readWriteLock.writeLock();
else{lock=readWriteLock.readLock();
if(LOGGER.isLoggable(LEVEL)){LOGGER.log(LEVEL,"Thread"+Thread.currentThread().getId()+"lockinginmode"+type);
if(global!=null){returnglobal;
if(jmc!=null){doubled=(double)(jmc/Runtime.getRuntime().maxMemory());d=d>1d?1d:d;global.put("JaiMemoryCapacity",d);
if(contact!=null){returncontact;
if(contactElement!=null){ElementpersonPrimaryElement=ReaderUtils.getChildElement(contactElement,"ContactPersonPrimary");
if(personPrimaryElement!=null){text("ContactPerson",personPrimaryElement,contact,String.class);text("ContactOrganization",personPrimaryElement,contact,String.class);
if(addressElement!=null){text("Address",addressElement,contact,String.class);text("AddressType",addressElement,contact,String.class);text("City",addressElement,contact,String.class);text("StateOrProvince",addressElement,contact,String.class);text("PostCode",addressElement,contact,String.class);text("Country",addressElement,contact,String.class);
if(wfs!=null){returnwfs;
if(wms!=null){returnwms;
if(baseMapGroupsElement!=null){Element[]baseMapGroupElements=ReaderUtils.getChildElements(baseMapGroupsElement,"BaseMapGroup");for(inti=0;i<baseMapGroupElements.length;i++){ElementbaseMapGroupElement=baseMapGroupElements[i];HashMap<String,Object>baseMap=newHashMap<String,Object>();baseMap.put("baseMapTitle",ReaderUtils.getAttribute(baseMapGroupElement,"baseMapTitle",true));baseMap.put("baseMapLayers",Arrays.asList(ReaderUtils.getChildText(baseMapGroupElement,"baseMapLayers").split(",")));StringbaseMapStyles=ReaderUtils.getChildText(baseMapGroupElement,"baseMapStyles");
if(baseMapStyles!=null&&!"".equals(baseMapStyles)){baseMapStyles=baseMapStyles.trim();intj=-1,k=0;Liststyles=newArrayList();while((j=baseMapStyles.indexOf(',',k))!=-1){styles.add(baseMapStyles.substring(k,j).trim());k=j+1;
if(baseMapStyles.endsWith(",")){styles.add("");
else
if(k<baseMapStyles.length()-1){styles.add(baseMapStyles.substring(k).trim());
else{baseMap.put("baseMapStyles",Collections.EMPTY_LIST);baseMap.put("rawBaseMapStyles","");
if(baseMapEnvelopeElement!=null){Element[]posElements=ReaderUtils.getChildElements(baseMapEnvelopeElement,"pos");doublex1=Double.parseDouble(posElements[0].getFirstChild().getNodeValue().split("")[0]);doubley1=Double.parseDouble(posElements[0].getFirstChild().getNodeValue().split("")[1]);doublex2=Double.parseDouble(posElements[1].getFirstChild().getNodeValue().split("")[0]);doubley2=Double.parseDouble(posElements[1].getFirstChild().getNodeValue().split("")[1]);Stringsrs=ReaderUtils.getAttribute(baseMapEnvelopeElement,"srsName",false);CoordinateReferenceSystemcrs=srs!=null?CRS.decode(srs):null;baseMap.put("baseMapEnvelope",newReferencedEnvelope(x1,x2,y1,y2,crs));
if(wcs!=null){returnwcs;
if(mlElement!=null){HashMapmetadataLink=newHashMap();metadataLink.put("about",ReaderUtils.getAttribute(mlElement,"about",false));metadataLink.put("type",ReaderUtils.getAttribute(mlElement,"type",false));metadataLink.put("metadataType",ReaderUtils.getAttribute(mlElement,"metadataType",false));service.put("metadataLink",metadataLink);
if(keywordElements!=null){for(inti=0;i<keywordElements.length;i++){keywords.add(keywordElements[i].getFirstChild().getTextContent());
if(id.equals(serviceId)){returnserviceElements[i];
if(valueElement==null){
if(man){thrownewRuntimeException("Nosuchelement:"+parameter);
else{map.put(parameter,def);return;
if(Boolean.class.equals(clazz)){value=Boolean.valueOf(ReaderUtils.getBooleanAttribute(valueElement,"value",true,false));
else
if(Integer.class.equals(clazz)){value=newInteger(ReaderUtils.getIntAttribute(valueElement,"value",true,-1));
else
if(Double.class.equals(clazz)){value=newDouble(ReaderUtils.getDoubleAttribute(valueElement,"value",true));
else{value=ReaderUtils.getAttribute(valueElement,"value",true);
if(text==null){
if(man){thrownewRuntimeException("Nosuchelement:"+parameter);
else{map.put(parameter,def);return;
if(text!=null){
if(Boolean.class.equals(clazz)){value=Boolean.valueOf(text);
else
if(Integer.class.equals(clazz)){value=Integer.valueOf(text);
else
if(Double.class.equals(clazz)){value=Double.valueOf(text);
ifthecomponentispresentandinitializedtester.assertComponent("form:extensions:0:content",NetCDFOutSettingsPanel.class);tester.assertComponent("form:extensions:0:content:panel",NetCDFPanel.class);NetCDFSettingsContainercontainer=map.get(NetCDFSettingsContainer.NETCDFOUT_KEY,NetCDFSettingsContainer.class);//EnsuretheelementisinthemapassertNotNull(container);//EnsurethepanelispresentNetCDFPanelpanel=(NetCDFPanel)tester.getComponentFromLastRenderedPage("form:extensions:0:content:panel");assertNotNull(panel);//CheckthatthevaluesarethesameNetCDFSettingsContainercontainer2=(NetCDFSettingsContainer)panel.getModelObject();assertNotNull(container2);assertEquals(container.getCompressionLevel(),container2.getCompressionLevel(),0.001d);//assertEquals(container.getNetcdfVersion(),container2.getNetcdfVersion());assertEquals(container.isShuffle(),container2.isShuffle());assertEquals(container.isCopyAttributes(),container2.isCopyAttributes());assertEquals(container.isCopyGlobalAttributes(),container2.isCopyGlobalAttributes());assertNotNull(container.getGlobalAttributes());assertNotNull(container2.getGlobalAttributes());assertEquals(container.getGlobalAttributes(),container2.getGlobalAttributes());assertNotNull(container.getVariableAttributes());assertNotNull(container2.getVariableAttributes());assertEquals(container.getVariableAttributes(),container2.getVariableAttributes());assertNotNull(container.getExtraVariables());assertNotNull(container2.getExtraVariables());assertEquals(container.getExtraVariables(),container2.getExtraVariables());}}
if(isNotEmpty(userName)==false)throwcreateSecurityException(USERNAME_REQUIRED);
if(isNotEmpty(groupName)==false)throwcreateSecurityException(GROUPNAME_REQUIRED);
if(service.getUserByUsername(userName)==null)throwcreateSecurityException(USER_NOT_FOUND_$1,userName);
if(service.getGroupByGroupname(groupName)==null)throwcreateSecurityException(GROUP_NOT_FOUND_$1,groupName);
if(service.getUserByUsername(userName)!=null)throwcreateSecurityException(USER_ALREADY_EXISTS_$1,userName);
if(service.getGroupByGroupname(groupName)!=null)throwcreateSecurityException(GROUP_ALREADY_EXISTS_$1,groupName);
if(MapLayerInfo.TYPE_VECTOR==layer.getType()){owsUrl=buildURL(baseURL,"wfs",null,URLType.SERVICE);owsUrl=appendQueryString(owsUrl,"");try{owsURL=newURL(owsUrl);
else
if(MapLayerInfo.TYPE_RASTER==layer.getType()){owsUrl=buildURL(baseURL,"wcs",null,URLType.SERVICE);owsUrl=appendQueryString(owsUrl,"");try{owsURL=newURL(owsUrl);
else{//nonvectornorrasterlayer,LayerDescriptionwillnotcontainthese//attributes
if(LOGGER.isLoggable(Level.WARNING))LOGGER.warning("Nonvectornorrasterlayer,LayerDescriptionwillnotcontaintheseattributes");
if(this==obj)returntrue;
if(!super.equals(obj))returnfalse;
if(!(objinstanceofWFSInfo))returnfalse;finalWFSInfoother=(WFSInfo)obj;
if(gml==null){
if(other.getGML()!=null)returnfalse;
else
if(!gml.equals(other.getGML()))returnfalse;
if(maxFeatures!=other.getMaxFeatures())returnfalse;
if(featureBounding!=other.isFeatureBounding())returnfalse;
if(canonicalSchemaLocation!=other.isCanonicalSchemaLocation())returnfalse;
if(serviceLevel==null){
if(other.getServiceLevel()!=null)returnfalse;
else
if(!serviceLevel.equals(other.getServiceLevel()))returnfalse;
if(encodeFeatureMember!=other.isEncodeFeatureMember())returnfalse;
if(hitsIgnoreMaxFeatures!=other.isHitsIgnoreMaxFeatures())returnfalse;
if(srs==null){
if(other.getSRS()!=null)returnfalse;
else
if(!srs.equals(other.getSRS()))returnfalse;returntrue;}}
if(auth!=null&&auth.getAuthorities().size()==1&&"ROLE_ANONYMOUS".equals(auth.getAuthorities().iterator().next().getAuthority()))returnnull;returnauth;}}
iftheuserselectedanythingfinalList<Script>selection=tablePanel.getSelection();
if(selection.size()==0)return;dialog.setTitle(newParamResourceModel("confirmRemoval",this));//
ifthereissomethingtocancel,let'swarntheuseraboutwhat//couldgowrong,and
iftheuseraccepts,let'sdeletewhat'sneededdialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){privatestaticfinallongserialVersionUID=9062725459934129182L;protectedComponentgetContents(Stringid){//showaconfirmationpanelforalltheobjectswehavetoremovereturnnewLabel(id,"Doyouwanttodeletethesescripts?");
if(script.getType().equalsIgnoreCase(ScriptType.APP.getLabel())){file.parent().delete();
iftheselectionhasbeenclearedoutit'ssignadeletion//occurred,sorefreshthetable
if(tablePanel.getSelection().size()==0){setEnabled(false);target.add(ScriptSelectionRemovalLink.this);target.add(tablePanel);
if(this.beanClass!=null&&bean!=null){
if(matchSubclasses)returnthis.beanClass.isAssignableFrom(bean.getClass());
elsereturnthis.beanClass.equals(bean.getClass());
if(userGroupServiceName!=null)service=getApplication().getSecurityManager().loadUserGroupService(userGroupServiceName);
if(service==null)groups=newTreeSet<GeoServerUserGroup>();
elsegroups=service.getUserGroups();
if(PasswordValidatorImpl.passwordStartsWithEncoderPrefix(passwordArray)!=null)return;//donothing,passwordalreadyencoded//wehaveaplaintextpassword//validateitgetSecurityManager().loadPasswordValidator(getPasswordValidatorName()).validatePassword(passwordArray);//validationok,initializerencoderandsetencodedpasswordGeoServerPasswordEncoderenc=getSecurityManager().loadPasswordEncoder(getPasswordEncoderName());enc.initializeFor(this);user.setPassword(enc.encodePassword(user.getPassword(),null));
if(helper.userMap.containsKey(user.getUsername()))thrownewIllegalArgumentException("Theuser"+user.getUsername()+"alreadyexists");preparePassword(user);helper.userMap.put(user.getUsername(),user);addUserToPropertyMap(user);setModified(true);
if(users==null){users=newTreeSet<GeoServerUser>();helper.propertyMap.put((String)key,users);
if(helper.groupMap.containsKey(group.getGroupname()))thrownewIllegalArgumentException("Thegroup"+group.getGroupname()+"alreadyexists");
else{helper.groupMap.put(group.getGroupname(),group);setModified(true);
if(helper.userMap.containsKey(user.getUsername())==false){thrownewIllegalArgumentException("Theuser"+user.getUsername()+"doesnotexist");
if(helper.groupMap.containsKey(group.getGroupname())){helper.groupMap.put(group.getGroupname(),group);setModified(true);
elsethrownewIllegalArgumentException("Thegroup"+group.getGroupname()+"doesnotexist");
if(groups!=null){Collection<GeoServerUserGroup>toBeRemoved=newArrayList<GeoServerUserGroup>();toBeRemoved.addAll(groups);for(GeoServerUserGroupgroup:toBeRemoved){disAssociateUserFromGroup(user,group);
if(retValue){setModified(true);removeUserFromPropertyMap(user);
if(users!=null){Collection<GeoServerUser>toBeRemoved=newArrayList<GeoServerUser>();toBeRemoved.addAll(users);for(GeoServerUseruser:toBeRemoved){disAssociateUserFromGroup(user,group);
if(retval){setModified(true);
if(isModified()){LOGGER.info("Startstoringuser/groupsforservicenamed"+getName());//preventconcurrentwritefromstoreand//readfromservicesynchronized(service){serialize();
else{LOGGER.info("Storingunnecessary,nochangeforuserandgroups");
if(users==null){users=newTreeSet<GeoServerUser>();helper.group_userMap.put(group,users);
if(users.contains(user)==false){users.add(user);changed=true;
if(groups==null){groups=newTreeSet<GeoServerUserGroup>();helper.user_groupMap.put(user,groups);
if(groups.contains(group)==false){groups.add(group);changed=true;
if(changed){setModified(true);
if(users!=null){changed|=users.remove(user);
if(users.isEmpty()){helper.group_userMap.remove(group);
if(groups!=null){changed|=groups.remove(group);
if(groups.isEmpty())helper.user_groupMap.remove(user);
if(changed){setModified(true);
if(helper.userMap.containsKey(user.getUsername())==false)thrownewIOException("User:"+user.getUsername()+"doesnotexist");
if(helper.groupMap.containsKey(group.getGroupname())==false)thrownewIOException("Group:"+group.getGroupname()+"doesnotexist");
if(!isEarthObservationEnabled()){returnnewString[0];
if(isEarthObservationEnabled()){namespaces.declarePrefix("wcseo",WCSEOMetadata.NAMESPACE);
if(!isEarthObservationEnabled()){return;
if(defaultCount!=null){tx.start("ows:Constraint",atts("name","CountDefault"));element(tx,"ows:NoValues",null,null);element(tx,"ows:DefaultValue",String.valueOf(defaultCount),null);tx.end("ows:Constraint");
if(enabled==null||!enabled){return;
if(dataset!=null&&dataset&&time!=null&&time.isEnabled()){tx.start("wcseo:DatasetSeriesSummary");ReferencedEnvelopebbox=ci.getLatLonBoundingBox();tx.start("ows:WGS84BoundingBox");element(tx,"ows:LowerCorner",bbox.getMinX()+""+bbox.getMinY(),null);element(tx,"ows:UpperCorner",bbox.getMaxX()+""+bbox.getMaxY(),null);tx.end("ows:WGS84BoundingBox");StringdatasetId=codec.getDatasetName(ci);element(tx,"wcseo:DatasetSeriesId",datasetId,null);GridCoverage2DReaderreader=(GridCoverage2DReader)ci.getGridCoverageReader(null,null);WCSDimensionsHelperdimensionsHelper=newWCSDimensionsHelper(time,reader,null);tx.start("gml:TimePeriod",atts("gml:id",datasetId+"__timeperiod"));element(tx,"gml:beginPosition",dimensionsHelper.getBeginTime(),null);element(tx,"gml:endPosition",dimensionsHelper.getEndTime(),null);tx.end("gml:TimePeriod");tx.end("wcseo:DatasetSeriesSummary");
if(content!=null){tx.chars(content);
if(sldFile!=null)FileUtils.deleteQuietly(sldFile.getParentFile());
if(sldFile!=null)FileUtils.deleteQuietly(sldFile.getParentFile());
if(files.length!=1){thrownewIOException("NoSLDfile");
if(openIdx==-1||closeIdx==-1||closeIdx<value.length()-1){thrownewOWS20Exception("Invalidsyntax,dimension[,crs](intervalOrPoint)isexpected",WCS20ExceptionCode.InvalidEncodingSyntax,"subset");
if(dcElements.length==1){dimension=dcElements[0];crs=null;
else
if(dcElements.length==2){dimension=dcElements[0];crs=dcElements[1];
else{thrownewOWS20Exception("Invalidsyntax,dimension[,crs](intervalOrPoint)isexpected",WCS20ExceptionCode.InvalidEncodingSyntax,"subset");
if(vpElements.length==1){//pointStringpoint=parsePoint(vpElements[0],false);DimensionSliceTypeslice=Wcs20Factory.eINSTANCE.createDimensionSliceType();slice.setDimension(dimension);slice.setCRS(crs);slice.setSlicePoint(point);returnslice;
else
if(vpElements.length==2){Stringlow=parsePoint(vpElements[0],true);Stringhigh=parsePoint(vpElements[1],true);DimensionTrimTypetrim=Wcs20Factory.eINSTANCE.createDimensionTrimType();trim.setDimension(dimension);trim.setCRS(crs);trim.setTrimLow(low);trim.setTrimHigh(high);returntrim;
else{thrownewOWS20Exception("Invalidsyntax,dimension[,crs](intervalOrPoint)"+"whereintervalorpointhaseither1ortwoelements",WCS20ExceptionCode.InvalidEncodingSyntax,"subset");
if("*".equals(point)){
if(allowStar){//"no"limitreturnnull;
else{thrownewOWS20Exception("Invalidusageof*,itcanbeusedonlywhenspecifyinganinterval",WCS20ExceptionCode.InvalidEncodingSyntax,"subset");
else
if(point.startsWith("\"")&&point.endsWith("\"")){point=point.substring(1,point.length()-1);
else{try{//checkitisanumberDouble.parseDouble(point);
if(authentication!=null&&authentication.isAuthenticated()&&token!=null&&token.getTokenType().equalsIgnoreCase(OAuth2AccessToken.BEARER_TYPE)){kvp.put("access_token",token.getValue());
if(files.size()==1){returnfiles.get(0).path();
else{StringBuildersb=newStringBuilder("Files:");for(Resourcefile:files){sb.append(file.path()).append("");
if(organization!=null){element("author",()->{element("name",organization);});
if(title!=null){element("title",title);
if(request.getParentId()!=null){kvp=Collections.singletonMap("parentId",request.getParentId());
if(startIndex==null){startIndex=0;
if(startIndex>1){encodePaginationLink("previous",Math.max(startIndex-itemsPerPage,1),itemsPerPage,request);
if(startIndex+itemsPerPage<=total){encodePaginationLink("next",startIndex+itemsPerPage,itemsPerPage,request);
if(JDBCOpenSearchAccess.COLLECTION.equals(schemaName)){entryEncoder=this::encodeCollectionEntry;
else
if(JDBCOpenSearchAccess.PRODUCT.equals(schemaName)){entryEncoder=this::encodeProductEntry;
else{thrownewIllegalArgumentException("Unrecognizedfeaturetype"+schemaName);
ifavailableCollection<Property>linkProperties=feature.getProperties(OpenSearchAccess.OGC_LINKS_PROPERTY_NAME);
if(linkProperties!=null){Map<String,List<SimpleFeature>>linksByOffering=linkProperties.stream().map(p->(SimpleFeature)p).sorted(LinkFeatureComparator.INSTANCE).collect(Collectors.groupingBy(f->(String)f.getAttribute("offering")));StringhrefBase=getHRefBase(request);encodeOgcLinks(linksByOffering,hrefBase);
if(hrefBase.endsWith("/")){hrefBase=hrefBase.substring(0,hrefBase.length()-1);
if(quicklookLink!=null){element("link",NO_CONTENTS,attributes("rel","icon","href",quicklookLink,"type","image/jpeg","title","Quicklook"));element("media:group",()->mediaContent(quicklookLink));
if(location!=null){Stringtype=(String)value(feature,null,OpenSearchAccess.ORIGINAL_PACKAGE_TYPE);
if(type==null){type=MediaType.APPLICATION_OCTET_STREAM_VALUE;
if(start!=null||end!=null){//TODO:needanactualupdatecolumnDateupdated=end==null?start:end;StringformattedUpdated=DateTimeFormatter.ISO_INSTANT.format(updated.toInstant());element("updated",formattedUpdated);//dc:date,canbearangeStringspec;
if(start!=null&&end!=null&&start.equals(end)){spec=DateTimeFormatter.ISO_INSTANT.format(start.toInstant());
else{spec=start!=null?DateTimeFormatter.ISO_INSTANT.format(start.toInstant()):"";spec+="/";spec+=end!=null?DateTimeFormatter.ISO_INSTANT.format(end.toInstant()):"";
if(footprint!=null){//geometryisalreadyinlat/lonorderhereEnvelopeenvelope=footprint.getEnvelopeInternal();element("georss:where",()->encodeGmlRssGeometry(footprint));element("georss:box",envelope.getMinX()+""+envelope.getMinY()+""+envelope.getMaxX()+""+envelope.getMaxY());
if(htmlDescription!=null){Stringexpanded=QuickTemplate.replaceVariables(htmlDescription,descriptionVariables);StringexpandedWithLinks=expanded+"\n"+encodeOGCLinksAsHTML(feature,request);element("summary",()->cdata(expandedWithLinks),attributes("type","html"));
if(linkProperties!=null){Map<String,List<SimpleFeature>>linksByOffering=linkProperties.stream().map(p->(SimpleFeature)p).sorted(LinkFeatureComparator.INSTANCE).collect(Collectors.groupingBy(f->(String)f.getAttribute("offering")));StringhrefBase=getHRefBase(request);
if(linkProperties.size()>0){sb.append("<h3>OGCcrosslinks</h3>\n<ul>\n");for(Map.Entry<String,List<SimpleFeature>>entry:linksByOffering.entrySet()){finalStringkey=entry.getKey();intidx=key.lastIndexOf('/');Stringservice=key;
if(idx>0&&idx<key.length()-1){service=key.substring(idx+1).toUpperCase();
if(ginstanceofPolygon){elementName=org.geotools.gml2.GML.Polygon;
else
if(ginstanceofMultiPoint){elementName=org.geotools.gml2.GML.MultiPoint;
else{elementName=org.geotools.gml2.GML._Geometry;
if(parentIdentifier!=null){kvp.put("parentId",String.valueOf(parentIdentifier));
if(mimeType!=null){kvp.put("httpAccept",mimeType);
if(parentIdentifier!=null){kvp.put("parentId",String.valueOf(parentIdentifier));
if(prefix!=null){property=feature.getProperty(newNameImpl(prefix,attribute));
else{property=feature.getProperty(attribute);
if(property==null){returnnull;
else{Objectvalue=property.getValue();
if(valueinstanceofGeometry){//cheapreprojectionsupportsincethereisnoreprojectingcollection//wrapperforcomplexfeaturesCoordinateReferenceSystemnativeCRS=((GeometryDescriptor)property.getDescriptor()).getCoordinateReferenceSystem();
if(nativeCRS!=null&&!CRS.equalsIgnoreMetadata(nativeCRS,OpenSearchParameters.OUTPUT_CRS)){Geometryg=(Geometry)value;try{returnJTS.transform(g,CRS.findMathTransform(nativeCRS,OpenSearchParameters.OUTPUT_CRS));
if(total<=itemsPerPage||itemsPerPage==0){return1;
if(lastPageItems==0){lastPageItems=itemsPerPage;
if(parameters.get("count")==null){parameters.put("count",""+query.getMaxFeatures());
if(parameters.get("startIndex")==null){IntegerstartIndex=query.getStartIndex();
if(startIndex==null){startIndex=1;
if(property==UserListProvider.USERNAME){returneditUserLink(id,itemModel,property);
else
if(property==UserListProvider.ENABLED){
if((Boolean)property.getModel(itemModel).getObject())returnnewIcon(id,CatalogIconFactory.ENABLED_ICON);
elsereturnnewLabel(id,"");
else
if(property==UserListProvider.HASATTRIBUTES){
if((Boolean)property.getModel(itemModel).getObject())returnnewIcon(id,CatalogIconFactory.ENABLED_ICON);
elsereturnnewLabel(id,"");
if(limits==null){thrownewNullPointerException("TheprovidedDownloadEstimatorProcessisnull!");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Rastersizelimits:"+rasterSizeLimits);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Checkingdownloadlimitsforrasterrequest");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("NativeCRSis"+nativeCRS.toWKT());
if(roi!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"PushingROItonativeCRS");
if(targetCRS!=null){roiManager.useTargetCRS(targetCRS);
if(roi!=null){//IfROIispresent,thenthecoverageBBOXiscroppedwiththeROIgeometry
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"ReprojectingROI");
if(roiInNativeCRS_.isEmpty()){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Emptyintersection,sotheresultdoesnotexceedthelimits");
else{//NoROI,wearetryingtoreadtheentirecoveragescaling=newScaleToTarget(reader);
if(targetSizeX==null&&targetSizeY==null){//AsktotheGridGeometryProviderGridGeometryProviderprovider=newGridGeometryProvider(reader,roiManager,filter,catalog);gg=provider.getGridGeometry();
else{gg=scaling.getGridGeometry();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Areatoreadinpixels:"+areaRead);
ifimagesizeexceedsinteger//limitslongtargetArea=1L;Integer[]targetSize=scaling.getTargetSize();
if(targetSize[0]!=null&&targetSize[1]!=null){targetArea=(long)targetSize[0]*targetSize[1];
if(areaRead>=Integer.MAX_VALUE||targetArea>=Integer.MAX_VALUE){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Areatoreadortargetimagesizeexceedsmaximumintegervalue:"+Integer.MAX_VALUE);
if(rasterSizeLimits>DownloadServiceConfiguration.NO_LIMIT&&(areaRead>rasterSizeLimits||targetArea>rasterSizeLimits)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Areaexceedsthelimits");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Areadoesnotexceedthelimits");
ifspecified
if(bandIndices!=null&&bandIndices.length>0){for(inti=0;i<bandIndices.length;i++){//Usevalidindices
if(bandIndices[i]>=0&&bandIndices[i]<bandsCount)accumulatedPixelSizeInBits+=TypeMap.getSize(coverageDimensionInfoList.get(bandIndices[i]).getDimensionType());
else{for(inti=0;i<bandsCount;i++){accumulatedPixelSizeInBits+=TypeMap.getSize(coverageDimensionInfoList.get(i).getDimensionType());
if(writeLimits>DownloadServiceConfiguration.NO_LIMIT&&rasterSizeInBytes>writeLimits){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Outputrawrastersize("+rasterSizeInBytes+")exceeds"+"thespecifiedwritelimits("+writeLimits+")");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Outputrawrastersize("+rasterSizeInBytes+")doesnotexceed"+"thespecifiedwritelimits("+writeLimits+")");
if(this==o)returntrue;
if(o==null||getClass()!=o.getClass())returnfalse;DimensionInfoImplthat=(DimensionInfoImpl)o;returnenabled==that.enabled&&Objects.equals(attribute,that.attribute)&&Objects.equals(endAttribute,that.endAttribute)&&presentation==that.presentation&&Objects.equals(resolution,that.resolution)&&Objects.equals(units,that.units)&&Objects.equals(unitSymbol,that.unitSymbol)&&Objects.equals(defaultValue,that.defaultValue)&&Objects.equals(nearestMatchEnabled,that.nearestMatchEnabled)&&Objects.equals(acceptableInterval,that.acceptableInterval);
if(!it.next().isEnabled()){it.remove();
if(model!=null){model.detach();
if(myHandleableClasses==null)returntrue;for(StringclassName:myHandleableClasses){try{
if(Class.forName(className).isInstance(obj)){returntrue;
ifthepagehappenstobea{@linkGeoServerSecuredPage}.*<p>Ifyoudooverridethismethod,makesuretooverridetheauthorizergrabbing*methodinthepageaswell</p>**/setAuthorizer(GeoServerSecuredPage.DEFAULT_AUTHORIZER);
if(schemaLocationURI==null){returnnull;
ifnonamespacegiven,assumedefaultforthecurrentschema
if(((namespaceURI==null)||"".equals(namespaceURI))&&(xsdSchema!=null)){namespaceURI=xsdSchema.getTargetNamespace();
if("http://www.opengis.net/ows".equals(namespaceURI)&&(schemaLocationURI!=null)){
if(schemaLocationURI.endsWith("ows19115subset.xsd")){returngetClass().getResource("ows19115subset.xsd").toString();
if("http://www.opengis.net/ows".equals(namespaceURI)&&(schemaLocationURI!=null)){
if(schemaLocationURI.endsWith("owsAll.xsd")){returngetClass().getResource("owsAll.xsd").toString();
if("http://www.opengis.net/ows".equals(namespaceURI)&&(schemaLocationURI!=null)){
if(schemaLocationURI.endsWith("owsCommon.xsd")){returngetClass().getResource("owsCommon.xsd").toString();
if("http://www.opengis.net/ows".equals(namespaceURI)&&(schemaLocationURI!=null)){
if(schemaLocationURI.endsWith("owsDataIdentification.xsd")){returngetClass().getResource("owsDataIdentification.xsd").toString();
if("http://www.opengis.net/ows".equals(namespaceURI)&&(schemaLocationURI!=null)){
if(schemaLocationURI.endsWith("owsExceptionReport.xsd")){returngetClass().getResource("owsExceptionReport.xsd").toString();
if("http://www.opengis.net/ows".equals(namespaceURI)&&(schemaLocationURI!=null)){
if(schemaLocationURI.endsWith("owsGetCapabilities.xsd")){returngetClass().getResource("owsGetCapabilities.xsd").toString();
if("http://www.opengis.net/ows".equals(namespaceURI)&&(schemaLocationURI!=null)){
if(schemaLocationURI.endsWith("owsOperationsMetadata.xsd")){returngetClass().getResource("owsOperationsMetadata.xsd").toString();
if("http://www.opengis.net/ows".equals(namespaceURI)&&(schemaLocationURI!=null)){
if(schemaLocationURI.endsWith("owsServiceIdentification.xsd")){returngetClass().getResource("owsServiceIdentification.xsd").toString();
if("http://www.opengis.net/ows".equals(namespaceURI)&&(schemaLocationURI!=null)){
if(schemaLocationURI.endsWith("owsServiceProvider.xsd")){returngetClass().getResource("owsServiceProvider.xsd").toString();
if(style!=null){styleName=name.getLocalPart();addStyle(styleName,style);
if(extraProperties==null)addPropertiesType(name,properties,Collections.singletonMap(KEY_STYLE,styleName));
else{Mapprops=newHashMap(extraProperties);props.put(KEY_STYLE,styleName);addPropertiesType(name,properties,props);
if(!featureTypeDir.exists()){thrownewFileNotFoundException("Typedirectorynotfound:"+featureTypeDir.getAbsolutePath());
if(!info.exists()){thrownewFileNotFoundException("FeatureTypefilenotfound:"+featureTypeDir.getAbsolutePath());
if(!IOUtils.delete(featureTypeDir)){thrownewIOException("FetureTypedirectorynotdeleted:"+featureTypeDir.getAbsolutePath());
if(extraParams==null)extraParams=Collections.EMPTY_MAP;//setupthetypedirectory
ifneededFiledirectory=newFile(data,name.getPrefix());
if(!directory.exists()){directory.mkdir();
if(properties==null)propertiesContents=newByteArrayInputStream("-=".getBytes());
elsepropertiesContents=properties.openStream();IOUtils.copy(propertiesContents,f);//writetheinfofileinfo(name,extraParams);//setupthemetainformationtobewritteninthecatalognamespaces.put(name.getPrefix(),name.getNamespaceURI());dataStoreNamepaces.put(name.getPrefix(),name.getPrefix());Mapparams=newHashMap();params.put(PropertyDataStoreFactory.DIRECTORY.key,directory);params.put(PropertyDataStoreFactory.NAMESPACE.key,name.getNamespaceURI());dataStores.put(name.getPrefix(),params);
if(extension==null)thrownewIllegalArgumentException("UseaddCoverageFromZipinsteadofpassingNULL");Filedirectory=newFile(data,name.getPrefix());
if(!directory.exists()){directory.mkdir();
if(!directory.exists()){directory.mkdir();
if(extension!=null){FilecoverageFile=newFile(srcDir,name.getLocalPart()+"."+extension);addCoverageFromPath(name,coverageFile,"file:"+name.getPrefix()+"/"+name.getLocalPart()+"/"+name.getLocalPart()+"."+extension,styleName);
else{addCoverageFromPath(name,f,"file:"+name.getPrefix()+"/"+name.getLocalPart(),styleName);
if(srs==null){srs=4326;
if(params.get(KEY_ALIAS)!=null)writer.write("<alias>"+params.get(KEY_ALIAS)+"</alias>");writer.write("<SRS>"+params.get(KEY_SRS_NUMBER)+"</SRS>");//thismocktypemayhavewrongSRScomparedtotheactualoneinthepropertyfiles...//let'sconfigureSRShandlingnottoaltertheoriginalone,andhave4326usedonly//forcapabilitiesintsrsHandling=2;Objecthandling=params.get(KEY_SRS_HANDLINGS);
if(handling!=null){
if(handlinginstanceofProjectionPolicy){srsHandling=((ProjectionPolicy)params.get(KEY_SRS_HANDLINGS)).getCode();
else
if(handlinginstanceofNumber){srsHandling=((Number)params.get(KEY_SRS_HANDLINGS)).intValue();
if(llEnvelope==null)llEnvelope=DEFAULT_ENVELOPE;writer.write("<latLonBoundingBoxdynamic=\"false\"minx=\""+llEnvelope.getMinX()+"\"miny=\""+llEnvelope.getMinY()+"\"maxx=\""+llEnvelope.getMaxX()+"\"maxy=\""+llEnvelope.getMaxY()+"\"/>");EnvelopenativeEnvelope=(Envelope)params.get(KEY_NATIVE_ENVELOPE);
if(nativeEnvelope!=null)writer.write("<nativeBBoxdynamic=\"false\"minx=\""+nativeEnvelope.getMinX()+"\"miny=\""+nativeEnvelope.getMinY()+"\"maxx=\""+nativeEnvelope.getMaxX()+"\"maxy=\""+nativeEnvelope.getMaxY()+"\"/>");Stringstyle=(String)params.get(KEY_STYLE);
if(style==null)style="Default";writer.write("<stylesdefault=\""+style+"\"/>");writer.write("</featureType>");writer.flush();writer.close();
if(reader==null){thrownewRuntimeException("Noreaderfor"+coverageFile.toString()+"withformat"+format.getName());
if(styleName==null)styleName="raster";writer.write("<stylesdefault=\""+styleName+"\"/>\n");//envelopeCoordinateReferenceSystemcrs=reader.getCoordinateReferenceSystem();GeneralEnvelopeenvelope=reader.getOriginalEnvelope();GeneralEnvelopewgs84envelope=CoverageStoreUtils.getWGS84LonLatEnvelope(envelope);finalStringnativeCrsName=CRS.lookupIdentifier(crs,false);writer.write("<envelopecrs=\""+crs.toString().replaceAll("\"","'")+"\"srsName=\""+nativeCrsName+"\">\n");writer.write("<pos>"+wgs84envelope.getMinimum(0)+""+wgs84envelope.getMinimum(1)+"</pos>\n");writer.write("<pos>"+wgs84envelope.getMaximum(0)+""+wgs84envelope.getMaximum(1)+"</pos>\n");writer.write("</envelope>\n");/***NowreadingafakesmallGridCoveragejusttoretrievemetainformation:-calculatinga*newenvelopewhichis1/20oftheoriginalone-readingtheGridCoveragesubset*/finalParameterValueGroupreadParams=reader.getFormat().getReadParameters();finalMapparameters=CoverageUtils.getParametersKVP(readParams);double[]minCP=envelope.getLowerCorner().getCoordinate();double[]maxCP=newdouble[]{minCP[0]+(envelope.getSpan(0)/20.0),minCP[1]+(envelope.getSpan(1)/20.0)};finalGeneralEnvelopesubEnvelope=newGeneralEnvelope(minCP,maxCP);subEnvelope.setCoordinateReferenceSystem(reader.getCoordinateReferenceSystem());parameters.put(AbstractGridFormat.READ_GRIDGEOMETRY2D.getName().toString(),newGridGeometry2D(reader.getOriginalGridRange(),subEnvelope));GridCoverage2Dgc=(GridCoverage2D)reader.read(CoverageUtils.getParameters(readParams,parameters,true));//gridgeometryfinalGridGeometrygeometry=gc.getGridGeometry();finalintdimensions=geometry.getGridRange().getDimension();Stringlower="";Stringupper="";for(inti=0;i<dimensions;i++){lower=lower+geometry.getGridRange().getLow(i)+"";upper=upper+geometry.getGridRange().getHigh(i)+"";
if(geometry.getGridToCRS()instanceofAffineTransform){AffineTransformaTX=(AffineTransform)geometry.getGridToCRS();writer.write("<geoTransform>");writer.write("<scaleX>"+aTX.getScaleX()+"</scaleX>\n");writer.write("<scaleY>"+aTX.getScaleY()+"</scaleY>\n");writer.write("<shearX>"+aTX.getShearX()+"</shearX>\n");writer.write("<shearY>"+aTX.getShearY()+"</shearY>\n");writer.write("<translateX>"+aTX.getTranslateX()+"</translateX>\n");writer.write("<translateY>"+aTX.getTranslateY()+"</translateY>\n");writer.write("</geoTransform>\n");
if(categories!=null&&categories.size()>=1){writer.write("<nullValues>\n");for(Iterator<Category>it=sd[i].getCategories().iterator();it.hasNext();){Categorycat=(Category)it.next();
if((cat!=null)&&cat.getName().toString().equalsIgnoreCase("nodata")){doublemin=cat.getRange().getMinimum();doublemax=cat.getRange().getMaximum();writer.write("<value>"+min+"</value>\n");
if(min!=max)writer.write("<value>"+max+"</value>\n");
elsewriter.write("<nullValues/>\n");writer.write("</CoverageDimension>\n");
if(type.equals(tx.getClass())){return(X)tx;
if(type.isAssignableFrom(tx.getClass())){list.add((X)tx);
if(type.isAssignableFrom(it.next().getClass())){it.remove();
if(transforms==null){transforms=newArrayList();
if(tx.stopOnError(e)){throwe;
else{//logandcontinueLOGGER.log(Level.WARNING,"Transform"+tx+"failed",e);
if(type.isInstance(tx)){filtered.add((T)tx);
if(constructor==null){thrownewIllegalStateException("Noappropriateconstructor");
if(!(oinstanceofAuthorityURLInfo)){returnfalse;
if(event.getSource()instanceofNamespaceInfo&&!editing&&properties.contains("prefix")){intprefixIdx=properties.indexOf("prefix");StringoldPrefix=(String)event.getOldValues().get(prefixIdx);StringnewPrefix=(String)event.getNewValues().get(prefixIdx);WorkspaceInfows=catalog.getWorkspaceByName(oldPrefix);
if(ws!=null){try{editing=true;ws.setName(newPrefix);catalog.save(ws);
else
if(event.getSource()instanceofCatalog&&properties.contains("defaultNamespace")&&!editing){NamespaceInfonewDefault=(NamespaceInfo)event.getNewValues().get(properties.indexOf("defaultNamespace"));
if(newDefault!=null){WorkspaceInfows=catalog.getWorkspaceByName(newDefault.getPrefix());
if(ws!=null&&!catalog.getDefaultWorkspace().equals(ws)){try{editing=true;catalog.setDefaultWorkspace(ws);
else
if(event.getSource()instanceofWorkspaceInfo&&!editing&&properties.contains("name")){WorkspaceInfows=(WorkspaceInfo)event.getSource();intnameIdx=properties.indexOf("name");StringoldName=(String)event.getOldValues().get(nameIdx);StringnewName=(String)event.getNewValues().get(nameIdx);NamespaceInfons=catalog.getNamespaceByPrefix(oldName);
if(ns!=null){try{editing=true;ns.setPrefix(newName);catalog.save(ns);
else
if(event.getSource()instanceofCatalog&&properties.contains("defaultWorkspace")&&!editing){WorkspaceInfonewDefault=(WorkspaceInfo)event.getNewValues().get(properties.indexOf("defaultWorkspace"));
if(newDefault!=null){NamespaceInfons=catalog.getNamespaceByPrefix(newDefault.getName());
if(ns!=null&&!catalog.getDefaultNamespace().equals(ns)){try{editing=true;catalog.setDefaultNamespace(ns);
if(event.getSource()instanceofNamespaceInfo){NamespaceInfons=(NamespaceInfo)event.getSource();StringnamespaceURI=ns.getURI();WorkspaceInfows=catalog.getWorkspaceByName(ns.getPrefix());
if(ws!=null){List<DataStoreInfo>stores=catalog.getDataStoresByWorkspace(ws);
if(stores.size()>0){for(DataStoreInfostore:stores){StringoldURI=(String)store.getConnectionParameters().get("namespace");
if(oldURI!=null&&!namespaceURI.equals(oldURI)){store.getConnectionParameters().put("namespace",namespaceURI);catalog.save(store);
ifneededsyncIsolation(event.getSource());
if(event.getSource()instanceofNamespaceInfo){NamespaceInfons=(NamespaceInfo)event.getSource();WorkspaceInfows=catalog.getWorkspaceByName(ns.getPrefix());
if(ws!=null){catalog.remove(ws);
ifthetheisolationisnotthesame,*avoidinginfiniteloops.**@paraminfocatalogobjectassociatetotheevent*/privatevoidsyncIsolation(CatalogInfoinfo){
if(infoinstanceofWorkspaceInfo){//anworkspacewasmodifiedoradded,let'strytosyncthenamespacesyncNamespaceIsolation((WorkspaceInfo)info);
else
if(infoinstanceofNamespaceInfo){//anamespacewasmodifiedoradded,let'strytosynctheworkspacesyncWorkspaceIsolation((NamespaceInfo)info);
if(namespace!=null&&workspace.isIsolated()!=namespace.isIsolated()){//updatethenamespaceisolationnamespace.setIsolated(workspace.isIsolated());catalog.save(namespace);
if(workspace!=null&&namespace.isIsolated()!=workspace.isIsolated()){//updatetheworkspaceisolationworkspace.setIsolated(namespace.isIsolated());catalog.save(workspace);
ifpossiblerendererParams.put(StreamingRenderer.VECTOR_RENDERING_KEY,Boolean.TRUE);rendererParams.put("renderingBuffer",newInteger(mapContent.getBuffer()));
if(DefaultWebMapService.isLineWidthOptimizationEnabled()){rendererParams.put(StreamingRenderer.LINE_WIDTH_OPTIMIZATION_KEY,true);
if(mapinstanceofWMSMapContent){WMSMapContentwmsMap=(WMSMapContent)map;width=wmsMap.getMapWidth();height=wmsMap.getMapHeight();
else{//getfromthemapcontentRectanglescreenArea=map.getViewport().getScreenArea();width=screenArea.getWidth();height=screenArea.getHeight();
if((height==-1)||(width==-1)){thrownewIOException("Couldnotdeterminemapdimensions");
if(wms.isSvgAntiAlias()){g.setRenderingHint(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_ON);
else{g.setRenderingHint(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_OFF);
iftoomanyerrorsoccurred
if(errorChecker.exceedsMaxErrors()){thrownewServiceException("Morethan"+maxErrors+"renderingerrorsoccurred,bailingout.",errorChecker.getLastException(),"internalError");
ifanonignorableerroroccurred
if(nonIgnorableExceptionListener.exceptionOccurred()){ExceptionrenderError=nonIgnorableExceptionListener.getException();thrownewServiceException("Renderingprocessfailed",renderError,"internalError");
if(filterEvent(event.getSource())){Authenticationauth=SecurityContextHolder.getContext().getAuthentication();Stringuser=(auth!=null)?auth.getName():null;CatalogInfoinfo=ModificationProxy.unwrap(event.getSource());Notificationnotification=newNotificationImpl(Type.Catalog,event.getSource().getId(),Action.Remove,info,null,user);notify(notification);
if(filterEvent(event.getSource())){Authenticationauth=SecurityContextHolder.getContext().getAuthentication();Stringuser=(auth!=null)?auth.getName():null;CatalogInfoinfo=ModificationProxy.unwrap(event.getSource());Notificationnotification=newNotificationImpl(Type.Catalog,event.getSource().getId(),Action.Update,info,handleModifiedProperties(event),user);notify(notification);
if(filterEvent(event.getSource())){Authenticationauth=SecurityContextHolder.getContext().getAuthentication();Stringuser=(auth!=null)?auth.getName():null;CatalogInfoinfo=ModificationProxy.unwrap(event.getSource());Notificationnotification=newNotificationImpl(Type.Catalog,event.getSource().getId(),Action.Add,info,null,user);notify(notification);
if(sourceinstanceofFeatureTypeInfo||sourceinstanceofCoverageInfo||sourceinstanceofWMSLayerInfo||sourceinstanceofLayerGroupInfo){
if(changedProperties.contains("name")||changedProperties.contains("namespace")||changedProperties.contains("workspace")){handleRename(properties,source,changedProperties,oldValues,newValues);
else
if(sourceinstanceofWorkspaceInfo){
if(changedProperties.contains("name")){handleWorkspaceRename(properties,source,changedProperties,oldValues,newValues);
if(sourceinstanceofLayerInfo){finalLayerInfoli=(LayerInfo)source;handleLayerInfoChange(properties,changedProperties,oldValues,newValues,li);
else
if(sourceinstanceofLayerGroupInfo){LayerGroupInfolgInfo=(LayerGroupInfo)source;handleLayerGroupInfoChange(properties,changedProperties,oldValues,newValues,lgInfo);
if(changedProperties.contains("layers")){finalintlayersIndex=changedProperties.indexOf("layers");ObjectoldLayers=oldValues.get(layersIndex);ObjectnewLayers=newValues.get(layersIndex);
if(changedProperties.contains("styles")){finalintstylesIndex=changedProperties.indexOf("styles");BeanToPropertyValueTransformertransformer=newBeanToPropertyValueTransformer("name");StringoldStyles=StringUtils.join(CollectionUtils.collect((Set<StyleInfo>)oldValues.get(stylesIndex),transformer).toArray());StringnewStyles=StringUtils.join(CollectionUtils.collect((Set<StyleInfo>)newValues.get(stylesIndex),transformer).toArray());
if(!oldStyles.equals(newStyles)){properties.put("styles",newStyles);
if(changedProperties.contains("defaultStyle")){finalintpropIndex=changedProperties.indexOf("defaultStyle");finalStyleInfooldStyle=(StyleInfo)oldValues.get(propIndex);finalStyleInfonewStyle=(StyleInfo)newValues.get(propIndex);finalStringoldStyleName=oldStyle.prefixedName();finalStringnewStyleName=newStyle.prefixedName();
if(!oldStyleName.equals(newStyleName)){properties.put("defaultStyle",newStyleName);
if(changedProperties.contains("styles")){finalintstylesIndex=changedProperties.indexOf("styles");BeanToPropertyValueTransformertransformer=newBeanToPropertyValueTransformer("name");StringoldStyles=StringUtils.join(CollectionUtils.collect((Set<StyleInfo>)oldValues.get(stylesIndex),transformer).toArray());StringnewStyles=StringUtils.join(CollectionUtils.collect((Set<StyleInfo>)newValues.get(stylesIndex),transformer).toArray());
if(!oldStyles.equals(newStyles)){properties.put("styles",newStyles);
if(sourceinstanceofResourceInfo){//coversLayerInfo,CoverageInfo,andWMSLayerInfo//mustcoverprefix:namefinalResourceInforesourceInfo=(ResourceInfo)source;finalNamespaceInfocurrNamespace=resourceInfo.getNamespace();finalNamespaceInfooldNamespace;
if(namespaceIndex>-1){oldNamespace=(NamespaceInfo)oldValues.get(namespaceIndex);
else{oldNamespace=currNamespace;
if(nameIndex>-1){oldLayerName=(String)oldValues.get(nameIndex);
else{oldLayerName=resourceInfo.getName();
if(sourceinstanceofFile){fileTemplateLoader.closeTemplateSource(source);
else{ClassTemplateSourcewrapper=(ClassTemplateSource)source;//closetherawsourceclassTemplateLoader.closeTemplateSource(wrapper.source);//cleanupwrapper.path=null;wrapper.source=null;
if(result!=null){returnresult;
else{Objectsource=classTemplateLoader.findTemplateSource(path);//wrapthesourceinasourcethatmaintainstheorignialpath
if(source!=null){returnnewClassTemplateSource(path,source);
if(sourceinstanceofFile){//loadedfromfilereturnfileTemplateLoader.getReader(source,encoding);
else{//gettehresourcefortherawsourceasuseitrightawayClassTemplateSourcewrapper=(ClassTemplateSource)source;returnclassTemplateLoader.getReader(wrapper.source,encoding);
if(sourceinstanceofFile){//loadedfromfilereturnfileTemplateLoader.getLastModified(source);
else{//loadedfromclassClassTemplateSourcewrapper=(ClassTemplateSource)source;returnclassTemplateLoader.getLastModified(wrapper.source);
ifakeycanbederivedandthe{@linkAuthentication}*objectisnotinthecache,thekeywillbereturned.**<p>Anot<code>null</code>returnvalueindicatesamissingcacheentry**@paramfilter*@paramrequest*/protectedStringauthenticateFromCache(AuthenticationCachingFilterfilter,HttpServletRequestrequest){AuthenticationauthFromCache=null;StringcacheKey=null;
if(SecurityContextHolder.getContext().getAuthentication()==null){cacheKey=filter.getCacheKey(request);
if(cacheKey!=null){authFromCache=getSecurityManager().getAuthenticationCache().get(getName(),cacheKey);
if(authFromCache!=null)SecurityContextHolder.getContext().setAuthentication(authFromCache);
elsereturncacheKey;
if(request.getPathInfo()!=null){url+=request.getPathInfo();
if(ruleLimits!=null){ruleFormData.allowedArea=getAllowedAreaAsString(ruleLimits.getAllowedArea());ruleFormData.catalogMode=ruleLimits.getCatalogMode();
if(layerDetails!=null){ruleFormData.layerDetailsCheck=true;ruleFormData.layerDetails.allowedArea=getAllowedAreaAsString(layerDetails.getArea());ruleFormData.layerDetails.catalogMode=layerDetails.getCatalogMode();ruleFormData.layerDetails.cqlFilterRead=layerDetails.getCqlFilterRead();ruleFormData.layerDetails.cqlFilterWrite=layerDetails.getCqlFilterWrite();ruleFormData.layerDetails.defaultStyle=layerDetails.getDefaultStyle();ruleFormData.layerDetails.layerType=layerDetails.getType();ruleFormData.layerDetails.allowedStyles.addAll(layerDetails.getAllowedStyles());ruleFormData.layerDetails.attributes.addAll(layerDetails.getAttributes());
if(ruleFormData.rule.getAccess().equals(GrantType.LIMIT)){rules.save(ruleFormData.rule.getId(),parseAllowedArea(ruleFormData.allowedArea),ruleFormData.catalogMode);
if(ruleFormData.layerDetailsCheck){LayerDetailslayerDetails=newLayerDetails();layerDetails.setArea(parseAllowedArea(ruleFormData.layerDetails.allowedArea));layerDetails.setAttributes(newHashSet<LayerAttribute>(ruleFormData.layerDetails.attributes));layerDetails.setAllowedStyles(ruleFormData.layerDetails.allowedStyles);layerDetails.setCatalogMode(ruleFormData.layerDetails.catalogMode);layerDetails.setCqlFilterRead(ruleFormData.layerDetails.cqlFilterRead);layerDetails.setCqlFilterWrite(ruleFormData.layerDetails.cqlFilterWrite);layerDetails.setDefaultStyle(ruleFormData.layerDetails.defaultStyle);layerDetails.setType((ruleFormData.layerDetails.layerType));rules.save(ruleFormData.rule.getId(),layerDetails);
else{rules.save(ruleFormData.rule.getId(),(LayerDetails)null);
if(multiPolygon==null){return"";
if(allowedArea==null||allowedArea.isEmpty()){returnnull;
if(allowedAreaParts.length!=2){thrownewGeoServerRuntimException(String.format("Invalidallowedarea'%s'expectingSRID=<CODE>;<WKT>.",allowedArea));
if(geometryinstanceofMultiPolygon){return(MultiPolygon)geometry;
if(geometryinstanceofPolygon){returnnewMultiPolygon(newPolygon[]{(Polygon)geometry},newGeometryFactory());
iftheworkspaceis*)*/protectedList<String>getLayerNames(StringworkspaceName){List<String>resultSet=newArrayList<String>();
if(workspaceName!=null){FilterFactory2ff=CommonFactoryFinder.getFilterFactory2();try(CloseableIterator<ResourceInfo>it=getCatalog().getFacade().list(ResourceInfo.class,Predicates.equal("store.workspace.name",workspaceName),null,null,ff.sort("name",SortOrder.ASCENDING))){while(it.hasNext()){resultSet.add(it.next().getName());
iftheworkspaceis**)*/protectedList<String>getOperationNames(StringserviceName){SortedSet<String>resultSet=newTreeSet<String>();booleanflag=true;
if(serviceName!=null){for(Serviceows:GeoServerExtensions.extensions(Service.class)){
if(serviceName.equalsIgnoreCase(ows.getId())&&flag){flag=false;resultSet.addAll(ows.getOperations());
if(roleName==null){for(StringserviceName:securityManager.listUserGroupServices()){for(GeoServerUseruser:securityManager.loadUserGroupService(serviceName).getUsers()){resultSet.add(user.getUsername());
else{for(StringserviceName:securityManager.listRoleServices()){GeoServerRoleServiceroleService=securityManager.loadRoleService(serviceName);GeoServerRolerole=roleService.getRoleByName(roleName);
if(role!=null){resultSet.addAll(roleService.getUserNamesForRole(role));
if(layerChoice.getConvertedInput()!=null){LayerInfoli=getCatalog().getLayerByName(layerChoice.getConvertedInput());
switch(li.getType()){caseVECTOR:caseREMOTE:ruleFormModel.getObject().layerDetails.layerType=LayerType.VECTOR;break;caseRASTER:caseWMS:caseWMTS:ruleFormModel.getObject().layerDetails.layerType=LayerType.VECTOR;break;caseGROUP:ruleFormModel.getObject().layerDetails.layerType=LayerType.LAYERGROUP;break;
if(li.getResource()instanceofFeatureTypeInfo){FeatureTypeInfofti=(FeatureTypeInfo)li.getResource();try{for(AttributeTypeInfoati:fti.attributes()){ruleFormModel.getObject().layerDetails.attributes.add(newLayerAttribute(ati.getName(),ati.getBinding()==null?null:ati.getBinding().getName(),AccessType.NONE));
if(LayerAttributeModel.ACCESS.equals(property)){returnnewDropDownChoiceWrapperPanel<AccessType>(id,(IModel<AccessType>)property.getModel(itemModel),Arrays.asList(AccessType.values()),newAccessTypeRenderer());
if(configFile.exists()){assertTrue(configFile.delete());
if(UsernamePasswordAuthenticationProvider.class.isAssignableFrom(prov.getClass())){
if(((UsernamePasswordAuthenticationProvider)prov).getName().equals("default2")){authProvFound=true;break;
if(o.getClass()==aClass)returntrue;
iftheversionattributeisnot*specifiedthentheserviceshouldassumethattherequest*conformstogreatestavailablespecificationversion.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:attribute&gt;*&lt;xsd:attributename="handle"type="xsd:string"use="optional"&gt;*&lt;xsd:annotation&gt;*&lt;xsd:documentation&gt;*Thehandleattributeallowsaclientapplication*toassignaclient-generatedrequestidentifier*toaWFSrequest.Thehandleisincludedto*facilitateerrorreporting.AWFSmayreportthe*handleinanexceptionreporttoidentifythe*offendingrequestoraction.Ifthehandleisnot*present,thentheWFSmayemployothermeansto*localizetheerror(e.g.linenumbers).*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:attribute&gt;*&lt;/xsd:complexType&gt;**</code>*</pre>**@generated*/publicclassBaseRequestTypeBindingextendsAbstractComplexBinding{WfsFactorywfsfactory;publicBaseRequestTypeBinding(WfsFactorywfsfactory){this.wfsfactory=wfsfactory;
if(node.hasAttribute("service")){Stringservice=(String)node.getAttributeValue("service");
if((service!=null)&&!"".equals(service.trim())){EMFUtils.set(request,"service",node.getAttributeValue("service"));
else{EMFUtils.set(request,"service","WFS");
else{EMFUtils.set(request,"service","WFS");
if(node.hasAttribute("version")){Stringversion=(String)node.getAttributeValue("version");
if((version!=null)&&!"".equals(version.trim())){EMFUtils.set(request,"version",node.getAttributeValue("version"));
else{EMFUtils.set(request,"version","1.1.0");
else{EMFUtils.set(request,"version","1.1.0");
if(node.hasAttribute("handle")){EMFUtils.set(request,"handle",node.getAttributeValue("handle"));
ifneeded.**@paramlayerNamethelayername*@paramfilterthefilter*@paramemailtheemail*@parammimeTypetheoutputformat*@paramtargetCRSthetargetcrs*@paramroiCRStheroicrs*@paramroitheroi*@paramclipthecroptogeometry*@paraminterpolationinterpolationmethodtousewhenreprojecting/scaling*@paramtargetSizeXthesizeofthetargetimagealongtheXaxis*@paramtargetSizeYthesizeofthetargetimagealongtheYaxis*@parambandIndicesthebandindicesselectedforoutput,incaseofrasterinput*@paramwriteParametersoptionalwritingparameters*@paramprogressListenertheprogresslistener*@returnthefile*@throwsProcessExceptiontheprocessexception*/@DescribeResult(name="result",description="Zippedoutputfilestodownload")publicFileexecute(@DescribeParameter(name="layerName",min=1,description="Originallayertodownload")StringlayerName,@DescribeParameter(name="filter",min=0,description="OptionalVectorFilter")Filterfilter,@DescribeParameter(name="outputFormat",min=1,description="OutputFormatMime-Type")StringmimeType,@DescribeParameter(name="targetCRS",min=0,description="OptionalTargetCRS")CoordinateReferenceSystemtargetCRS,@DescribeParameter(name="RoiCRS",min=0,description="OptionalRegionOfInterestCRS")CoordinateReferenceSystemroiCRS,@DescribeParameter(name="ROI",min=0,description="OptionalRegionOfInterest(Polygon)")Geometryroi,@DescribeParameter(name="cropToROI",min=0,description="CroptoROI")Booleanclip,@DescribeParameter(name="interpolation",description="Interpolationfunctiontousewhenreprojecting/scalingrasterdata.ValuesareNEAREST(default),BILINEAR,BICUBIC2,BICUBIC",min=0)Interpolationinterpolation,@DescribeParameter(name="targetSizeX",min=0,minValue=1,description="XSizeoftheTargetImage(appliestorasterdataonly)")IntegertargetSizeX,@DescribeParameter(name="targetSizeY",min=0,minValue=1,description="YSizeoftheTargetImage(appliestorasterdataonly)")IntegertargetSizeY,@DescribeParameter(name="selectedBands",description="BandSelectionIndices",min=0)int[]bandIndices,@DescribeParameter(name="writeParameters",description="Optionalwritingparameters",min=0)ParameterswriteParameters,finalProgressListenerprogressListener)throwsProcessException{try{////initialchecksonmandatoryparams////layername
if(layerName==null||layerName.length()<=0){thrownewIllegalArgumentException("EmptyornulllayerNameprovided!");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Downloadprocesscalledonresource:"+layerName);
if(clip==null){clip=false;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Clippingdisabled");
if(roi!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"ROIcheck");
if(roiCRS==null){thrownewIllegalArgumentException("ROIwithoutaCRSisnotusable!");
if(interpolation==null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Interpolationparameternotspecified,usingdefault(NearestNeighbor)");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Runningtheestimator");
if(!estimator.execute(layerName,filter,targetCRS,roiCRS,roi,clip,targetSizeX,targetSizeY,bandIndices,progressListener)){thrownewIllegalArgumentException("DownloadLimitsExceeded.Unabletoproceed!");
if(layerInfo==null){//couldnotfindanylayer...abruptlyinterrupttheprocessthrownewIllegalArgumentException("Unabletolocatelayer:"+layerName);
if(resourceInfo==null){//couldnotfindanydatastoreassociatedtothespecifiedlayer...abruptly//interrupttheprocessthrownewIllegalArgumentException("UnabletolocateResourceInfoforlayer:"+layerName);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Employinglimits"+limits);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Theresourcetoworkonis"+resourceInfo.getName());
if(resourceInfoinstanceofFeatureTypeInfo){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Theresourcetoworkonisavectorlayer");
else
if(resourceInfoinstanceofCoverageInfo){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Theresourcetoworkonisarasterlayer");
ifneededthecoverageinternalOutput=newRasterDownload(limits,resourceManager,context,catalog).execute(mimeType,progressListener,cInfo,roi,targetCRS,clip,filter,interpolation,targetSizeX,targetSizeY,bandIndices,writeParameters);
else{//wrongtypethrownewIllegalArgumentException("CouldnotcompletetheDownloadProcess,requestedlayerwasofwrongtype-->"+resourceInfo.getClass());
if(internalOutput==null){//wrongtypethrownewIllegalStateException("CouldnotcompletetheDownloadProcess,outputfileisnull");
if(!Resources.exists(internalOutput)||!Resources.canRead(internalOutput)){//wrongtypethrownewIllegalStateException("CouldnotcompletetheDownloadProcess,outputfileinvalid!-->"+internalOutput.path());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Preparingtheresult");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Listingfiles");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Collectingstyles");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Zippingfiles");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Preparetheresultfordeletion");
if(progressListener!=null){progressListener.complete();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Downloadfailed");
if(progressListener!=null){progressListener.exceptionOccurred(processException);
if(BackupExecutionAdapter.class.getSimpleName().equals(simpleName)){returnBackupExecutionAdapter.class;
else
if(RestoreExecutionAdapter.class.getSimpleName().equals(simpleName)){returnRestoreExecutionAdapter.class;
if(params!=null&&params.getNamedKeys().contains(DETAILS_LEVEL)){
if(params.get(DETAILS_LEVEL).toInt()>0){expand=params.get(DETAILS_LEVEL).toInt();
if(location==null){location=getGeoServerApplication().getGeoServer().getLogging().getLocation();
if(!backupFile.isAbsolute()){//locatethegeoserver.logfileGeoServerDataDirectorydd=getGeoServerApplication().getBeanOfType(GeoServerDataDirectory.class);backupFile=dd.get(Paths.convert(backupFile.getPath())).file();
if(!backupFile.exists()){error("CouldnotfindtheBackupArchivefile:"+backupFile.getAbsolutePath());
if(bkp.getStatus()==BatchStatus.STOPPED){setLinkEnabled((AjaxLink)downLoadLink.getParent().get("pause"),false,target);
else{try{backupFacade().stopExecution(bkp.getId());setResponsePage(BackupRestoreDataPage.class);
if(bkp.getStatus()!=BatchStatus.STOPPED){setLinkEnabled((AjaxLink)downLoadLink.getParent().get("pause"),false,target);
else{try{Longid=backupFacade().restartExecution(bkp.getId());PageParameterspp=newPageParameters();pp.add("id",id);
if(bkpinstanceofBackupExecutionAdapter){pp.add("clazz",BackupExecutionAdapter.class.getSimpleName());
else
if(bkpinstanceofRestoreExecutionAdapter){pp.add("clazz",RestoreExecutionAdapter.class.getSimpleName());
if(!doSelectReady(bkp)){setLinkEnabled((AjaxLink)downLoadLink.getParent().get("cancel"),false,target);
else{try{backupFacade().abandonExecution(bkp.getId());PageParameterspp=newPageParameters();pp.add("id",bkp.getId());
if(bkpinstanceofBackupExecutionAdapter){pp.add("clazz",BackupExecutionAdapter.class.getSimpleName());
else
if(bkpinstanceofRestoreExecutionAdapter){pp.add("clazz",RestoreExecutionAdapter.class.getSimpleName());
if(bkp.getStatus()==BatchStatus.COMPLETED||bkp.getStatus()==BatchStatus.FAILED||bkp.getStatus()==BatchStatus.ABANDONED){returnfalse;
if(getType()==BackupExecutionAdapter.class){ctx=backupFacade().getBackupExecutions().get(contextId);
else
if(getType()==RestoreExecutionAdapter.class){ctx=backupFacade().getRestoreExecutions().get(contextId);
if(abbrev&&title.length()>70){//shortenittitle=title.substring(0,20)+"[...]"+title.substring(title.length()-50);
if(getType()==BackupExecutionAdapter.class){ctx=backupFacade().getBackupExecutions().get(contextId);
else
if(getType()==RestoreExecutionAdapter.class){ctx=backupFacade().getRestoreExecutions().get(contextId);
if(!ctx.getAllFailureExceptions().isEmpty()){for(Throwableex:ctx.getAllFailureExceptions()){ex=writeException(buf,ex,Level.SEVERE);
else{buf.append("\nNOExceptionsDetected.\n");
if(!ctx.getAllWarningExceptions().isEmpty()){for(Throwableex:ctx.getAllWarningExceptions()){ex=writeException(buf,ex,Level.WARNING);
else{buf.append("\nNOWarningsDetected.\n");
if(buf.length()>0){buf.append('\n');
if(ex.getMessage()!=null){buf.append(level).append(":");buf.append(ex.getMessage());cnt++;
if(BackupRestorePage.this.expand>0&&BackupRestorePage.this.expand>=cnt){StringWritererrors=newStringWriter();ex.printStackTrace(newPrintWriter(errors));buf.append('\n').append(errors.toString());
if(newLevel!=null){log.setLevel(newLevel);
if(matcher.matches(r)){return;
if(directory.exists()){FileUtils.deleteDirectory(directory);
if(directory.exists()){FileUtils.deleteDirectory(directory);
iftheresourcesareequalsInputStreamis=to.getBlob().getInputStream();InputStreamis2=to2.getBlob().getInputStream();checkInputStreams(is,is2);//EnsureCachescontaintheresult//cache1TileObjectto3=cacheProvider1.getTileObj(to);assertNotNull(to3);is=to.getBlob().getInputStream();InputStreamis3=to3.getBlob().getInputStream();checkInputStreams(is,is3);//cache2TileObjectto4=cacheProvider2.getTileObj(to);assertNotNull(to4);is=to.getBlob().getInputStream();InputStreamis4=to4.getBlob().getInputStream();checkInputStreams(is,is4);//DELETE//RemoveTileObjectTileObjectto5=TileObject.createQueryTileObject("test:123123112",xyz,"EPSG:4326","image/jpeg",parameters);blobStore.delete(to5);//EnsureTileObjectisnomorepresentTileObjectto6=TileObject.createQueryTileObject("test:123123112",xyz,"EPSG:4326","image/jpeg",parameters);assertFalse(blobStore.get(to6));//EnsurethateachcacheproviderdoesnotcontainthetileobjectassertNull(cacheProvider1.getTileObj(to6));assertNull(cacheProvider2.getTileObj(to6));//Attheend,destroythecachescacheProvider1.destroy();cacheProvider2.destroy();
ifthestreamsareequals,notethatthe{@linkInputStream}sarealsoclosed.*/privatevoidcheckInputStreams(InputStreamis,InputStreamis2)throwsIOException{try{assertTrue(IOUtils.contentEquals(is,is2));
ifchanged**@paramtypeName*@returnthemapping*/publicCatalogStoreMappinggetMapping(StringtypeName){PropertyFileWatcherwatcher=watchers.get(typeName);
if(watcher!=null&&watcher.isModified()){try{addMapping(typeName,CatalogStoreMapping.parse(newHashMap<String,String>((Map)watcher.getProperties())));
if(!Resources.exists(f)){IOUtils.copy(getClass().getResourceAsStream(typeName+".default.properties"),f.out());
if(delegateinstanceofSimpleFeatureCollection){interfaces=newClass[]{SimpleFeatureCollection.class};
else{interfaces=newClass[]{FeatureCollection.class};
if(listener.isCanceled()){thrownewProcessDismissedException(listener);
if(resultinstanceofFeatureIterator<?>){Class[]interfaces;
if(resultinstanceofSimpleFeatureIterator){interfaces=newClass[]{SimpleFeatureIterator.class};
else{interfaces=newClass[]{FeatureIterator.class};
if(map.containsKey(USERNAME_KEY)){returnnewUsernamePasswordAuthenticationToken(map.get(USERNAME_KEY),"N/A",null);
if(recodeCheckBox.isVisible()){recodeCheckBox.setEnabled(true);target.add(recodeCheckBox);
if(recodeCheckBox.getModelObject()){GeoServerUserGroupServices=getSecurityManager().loadUserGroupService(config.getName());
if(s.canCreateStore()){Util.recodePasswords(s.createStore());
if(constructor==null){thrownewIllegalStateException("Noappropriateconstructor");
if(provider.authenticate(token)==null)fail=true;
if(provider.authenticate(token)==null)fail=true;
if(provider.authenticate(token)==null)fail=true;
if(store){putStoredQuery(sq);
if(StoredQuery.DEFAULT.getName().equals(name)){returnStoredQuery.DEFAULT;
if(res.getType()!=Type.RESOURCE){returnnull;
ifthequeryalreadyexists.**@paramqueryThestoredquery.*/publicvoidputStoredQuery(StoredQueryquery){try{Resourcedir=storedQueryDir();Resourcef=dir.get(toFilename(query.getName()));
if(f.getType()!=Type.UNDEFINED){//TODO:backuptheoldfileincasethereisanerrorduringencoding
ifroleNameisknown**@paramroleName*/publicbooleancontainsRole(StringroleName){returnparentMappings.containsKey(roleName);
ifrolehasnoparent**@paramroleName*/publicStringgetParent(StringroleName){checkRole(roleName);StringparentRole=parentMappings.get(roleName);
if(roleName.equals(parentRole))cycleDetected(roleName,null);returnparentRole;
if(roleName==null||roleName.length()==0)return;//endrecursionancestors.add(roleName);StringparentName=parentMappings.get(roleName);
if(ancestors.contains(parentName)){cycleDetected(roleName,parentName);
if(entry.getValue()!=null&&entry.getValue().equals(roleName)){
if(roleName.equals(entry.getKey()))cycleDetected(roleName,null);children.add(entry.getKey());
if(children==null||children.size()==0)return;//endrecursionfor(StringchildName:children){
if(descendants.contains(childName))//cyclecycleDetected(childName,null);descendants.add(childName);
if(parentMappings.containsKey(roleName)==false)thrownewRuntimeException("Notextistendrole:"+roleName);
if(roleName2==null)thrownewRuntimeException("Cycledetectedfor"+roleName1);
elsethrownewRuntimeException("Cycledetectedbetween"+roleName1+"and"+roleName2);
iftheroleisarootrole**@paramroleName*/publicbooleanisRoot(StringroleName){checkRole(roleName);returnparentMappings.get(roleName)==null;
if(isRoot(roleName))result.add(roleName);
if(parentRoleName!=null)leafRoles.remove(parentRoleName);
ifparentNameisavalidparentforroleName(avoidingcycles)**@paramroleName*@paramparentName*/publicbooleanisValidParent(StringroleName,StringparentName){
if(parentName==null||parentName.length()==0)returntrue;
if(roleName.equals(parentName))returnfalse;
if(getDescendants(roleName).contains(parentName))returnfalse;returntrue;}}
iftheaddressthesamedata,
ifyouneedfull*comparison,use{@link#equalsExact(DataAccessRule)}*/@SuppressWarnings("serial")publicclassDataAccessRuleimplementsComparable<DataAccessRule>,Serializable{/**Anylayer,oranyworkspace,oranyrole*/publicstaticfinalStringANY="*";publicstaticDataAccessRuleREAD_ALL=newDataAccessRule(ANY,ANY,AccessMode.READ);publicstaticDataAccessRuleWRITE_ALL=newDataAccessRule(ANY,ANY,AccessMode.WRITE);Stringroot;Stringlayer;AccessModeaccessMode;Set<String>roles;booleanglobalGroupRule;/**Buildsanewrule*/publicDataAccessRule(Stringroot,Stringlayer,AccessModeaccessMode,Set<String>roles){super();this.root=root;this.layer=layer;this.globalGroupRule=(layer==null);this.accessMode=accessMode;
if(roles==null)this.roles=newHashSet<String>();
elsethis.roles=newHashSet<String>(roles);
if(globalGroupRule){returnroot+"."+accessMode.getAlias();
else{returnroot+"."+layer+"."+accessMode.getAlias();
if(roles.isEmpty()){returnDataAccessRule.ANY;
else{StringBuffersb=newStringBuffer();for(Stringrole:roles){sb.append(role);sb.append(",");
ifanything
elseisequal,readcomesbeforewrite*/publicintcompareTo(DataAccessRuleother){intcompareRoot=compareCatalogItems(root,other.root);
if(compareRoot!=0)returncompareRoot;intcompareLayer=compareCatalogItems(layer,other.layer);
if(compareLayer!=0)returncompareLayer;
if(accessMode.equals(other.accessMode))return0;
elsereturnaccessMode.equals(AccessMode.READ)?-1:1;
if(!(objinstanceofDataAccessRule))returnfalse;return0==compareTo((DataAccessRule)obj);
if(0!=compareTo(obj))returnfalse;
elsereturnroles.equals(obj.roles);
if(item==null){returnotherItem!=null?-1:0;
if(item.equals(otherItem))return0;
else
if(ANY.equals(item))return-1;
else
if(ANY.equals(otherItem))return1;
elsereturnitem.compareTo(otherItem);
if(validate&&validatable.getValue().isEmpty()){ValidationErrorerror=newValidationError();error.setMessage(newResourceModel("CachingOptionsPanel.validation.emptyGridsets").getObject());validatable.error(error);
if(validate&&value.isEmpty()){ValidationErrorerror=newValidationError();error.setMessage(newResourceModel("CachingOptionsPanel.validation.emptyCacheFormatList").getObject());validatable.error(error);
if(path.contains("geoserver/rest/scripts")){
if(!secMgr.checkAuthenticationForAdminRole()){thrownewRestException("",HttpStatus.UNAUTHORIZED);
if(secMgr.checkForDefaultAdminPassword()){thrownewRestException("insecurepassword",HttpStatus.FORBIDDEN);
if(values.length>0&&values.length<3){Coordinatec=newCoordinate();c.x=Double.parseDouble(values[0]);c.y=Double.parseDouble(values[1]);returngf.createPoint(c);
if(valueinstanceofPoint){Coordinatec=((Point)value).getCoordinate();returnc.x+""+c.y;
else{returnvalue.toString();
if(keyStoreResource==null){keyStoreResource=securityManager.security().get(DEFAULT_FILE_NAME);
if(key==null)returnnull;returnkey.getEncoded();
if(key==null)returnnull;returnkey.getEncoded();
if(key==null)returnnull;
if((keyinstanceofSecretKey)==false)thrownewIOException("Invalidkeytypefor:"+name);return(SecretKey)key;
if(key==null)returnnull;
if((keyinstanceofPublicKey)==false)thrownewIOException("Invalidkeytypefor:"+name);return(PublicKey)key;
if(key==null)returnnull;
if((keyinstanceofPrivateKey)==false)thrownewIOException("Invalidkeytypefor:"+name);return(PrivateKey)key;
if(ks!=null)return;char[]passwd=securityManager.getMasterPassword();try{ks=KeyStore.getInstance(KEYSTORETYPE);
if(getResource().getType()==Type.UNDEFINED){//createanempyoneks.load(null,passwd);addInitialKeys();try(OutputStreamfos=getResource().out()){ks.store(fos,passwd);
else{try(InputStreamfis=getResource().in()){ks.load(fis,passwd);
if(exinstanceofIOException)//avoiduselesswrappingthrow(IOException)ex;thrownewIOException(ex);
if(password==null)returnfalse;assertActivatedKeyStore();KeyStoretestStore=null;try{testStore=KeyStore.getInstance(KEYSTORETYPE);
if(newKSFile.getType()!=Type.UNDEFINED){newKSFile.delete();
if(keyinstanceofSecretKey)entry=newKeyStore.SecretKeyEntry((SecretKey)key);
if(keyinstanceofPrivateKey)entry=newKeyStore.PrivateKeyEntry((PrivateKey)key,oldKS.getCertificateChain(alias));
if(keyinstanceofPublicKey)entry=newKeyStore.TrustedCertificateEntry(oldKS.getCertificate(alias));
if(entry==null)LOGGER.warning("Unknownkeyinstore,alias:"+alias+"class:"+key.getClass().getName());
elsenewKS.setEntry(alias,entry,protectionparam);
if(newKSFile.getType()!=Type.UNDEFINED){//newKSFile.delete();
if(newKSFile.getType()==Type.UNDEFINED){return;//nothingtodo
if(oldKSFile.getType()==Type.UNDEFINED){return;//notinitialized
if(oldKSFile.delete()==false){LOGGER.severe("cannotdelete"+oldKSFile.path());return;
if(newKSFile.renameTo(oldKSFile)==false){Stringmsg="cannotrename"+newKSFile.path();msg+="to"+oldKSFile.path();msg+="Trytorenamemanuallyandrestart";LOGGER.severe(msg);return;
if(fin!=null){try{fin.close();
ifrequestedpropertyispresentassertXpathCount(1,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gml:description",doc);//check
ifrequiredpropertyispresentassertXpathCount(1,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:shape",doc);assertXpathCount(1,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:positionalAccuracy/gsml:CGI_NumericValue",doc);assertXpathCount(1,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:specification/gsml:GeologicUnit",doc);//check
ifnon-requestedpropertyisnotpresentassertXpathCount(0,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:metadata",doc);assertXpathCount(0,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gml:name",doc);assertXpathCount(0,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:specification/gsml:GeologicUnit/gml:name",doc);assertXpathCount(0,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:specification/gsml:GeologicUnit/gml:description",doc);
ifrequestedpropertyispresentassertXpathCount(1,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:specification/gsml:GeologicUnit/gml:description",doc);//check
ifrequiredpropertyispresentassertXpathCount(1,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:shape",doc);assertXpathCount(1,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:positionalAccuracy/gsml:CGI_NumericValue",doc);assertXpathCount(1,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:specification/gsml:GeologicUnit",doc);//check
ifnon-requestedpropertyisnotpresentassertXpathCount(0,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:metadata",doc);assertXpathCount(0,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gml:name",doc);assertXpathCount(0,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:specification/gsml:GeologicUnit/gml:name",doc);assertXpathCount(0,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gml:description",doc);
ifrequestedpropertyispresentassertXpathCount(2,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:specification/gsml:GeologicUnit/gml:name",doc);assertXpathCount(1,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gml:description",doc);//check
ifrequiredpropertyispresentassertXpathCount(1,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:shape",doc);assertXpathCount(1,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:positionalAccuracy/gsml:CGI_NumericValue",doc);assertXpathCount(1,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:specification/gsml:GeologicUnit",doc);//check
ifnon-requestedpropertyisnotpresentassertXpathCount(0,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gsml:metadata",doc);assertXpathCount(0,"//gsml:MappedFeature[@gml:id='gsml.mappedfeature.mf1']/gml:name",doc);
if(iterator!=null){iterator.close();
if(geometryEncoding==GeometryEncoding.LATLONG||(col==null&&feature.getDefaultGeometry()!=null)){geometryEncoding.encode((Geometry)feature.getDefaultGeometry(),this);end("item");
else{geometryEncoding.encode(col.getGeometryN(0),this);end("item");for(inti=1;i<col.getNumGeometries();i++){encodeRelatedGeometryItem(col.getGeometryN(i),title,link,i);
if(isNew&&infoinstanceofDataStoreInfo){applyDataStoreParamsDefaults(info);
ifnotalreadysettosomedefault
if(!connParams.containsKey(p.key)||connParams.get(p.key)==null){applyParamDefault(paramInfo,info);
if("namespace".equals(paramInfo.getName())){defValue=getCatalog().getDefaultNamespace().getURI();
else
if(URL.class==paramInfo.getBinding()&&null==defValue){defValue="file:data/example.extension";
else{defValue=paramInfo.getValue();
if(spatial!=null){returnnewdouble[]{spatial.getMinX(),spatial.getMinY(),spatial.getMaxX(),spatial.getMaxY()};
else{returnnull;
if(temporal!=null){returnnewString[]{ISO_INSTANT.format(temporal.getMinValue().toInstant()),ISO_INSTANT.format(temporal.getMaxValue().toInstant())};
else{returnnull;
if(key==null||key.trim().isEmpty()){ParamResourceModelrm=newParamResourceModel("NetCDFOut.emptyKey",null,"");error(rm.getString());
else{GlobalAttributeattribute=newGlobalAttribute(key,value);
if(!globalAttributes.getModelObject().contains(attribute)){globalAttributes.getModelObject().add(attribute);
if(key==null||key.trim().isEmpty()){ParamResourceModelrm=newParamResourceModel("NetCDFOut.emptyKey",null,"");error(rm.getString());
else{VariableAttributeattribute=newVariableAttribute(key,value);
if(!variableAttributes.getModelObject().contains(attribute)){variableAttributes.getModelObject().add(attribute);
if((source==null||source.trim().isEmpty())&&(output==null||output.trim().isEmpty())){ParamResourceModelrm=newParamResourceModel("NetCDFOut.emptySourceOutput",null,"");error(rm.getString());
else
if(dimensions!=null&&dimensions.split("\\s").length>1){ParamResourceModelrm=newParamResourceModel("NetCDFOut.tooManyDimensions",null,"");error(rm.getString());
else{extraVariables.getModelObject().add(newExtraVariable(source,output,dimensions));newOutput.setModel(Model.of(""));newSource.setModel(Model.of(""));newDimensions.setModel(Model.of(""));ajaxTarget.add(container);
if(object==null){netcdfModel.setObject((T)newNetCDFSettingsContainer());
if(componentinstanceofFormComponent){FormComponent<?>formComponent=(FormComponent<?>)component;formComponent.processInput();
if(componentinstanceofNetCDFExtensionPanel){NetCDFExtensionPanelextension=(NetCDFExtensionPanel)component;extension.convertInput(convertedInput);
if(s3propertiesFile!=null){System.setProperty("s3.properties.location",s3propertiesFile.getFile());
if(DATA_DIRECTORY==null){//setdatadirectoryDATA_DIRECTORY=newMockData();System.setProperty("GEOSERVER_DATA_DIR",DATA_DIRECTORY.getDataDirectoryRoot().toString());
if(setupDataDirectory()){DATA_DIRECTORY.setUp();geoServer.reload();
if(e!=null){ex.initCause(e);
if(layout==LegendLayout.HORIZONTAL){Row[]rows=createRows(nodes,mergeOptions.getRowWidth(),mergeOptions.getRows());finalLegend=buildFinalHLegend(rows,mergeOptions);
if(layout==LegendLayout.VERTICAL){Column[]columns=createColumns(nodes,mergeOptions.getColumnHeight(),mergeOptions.getColumns(),null,false);finalLegend=buildFinalVLegend(columns,mergeOptions);
if(imgCount==1&&(!mergeOptions.isForceLabelsOn()||rules==null)){return(BufferedImage)imageStack.get(0);
else{for(inti=0;i<imgCount;i++){BufferedImageimg=(BufferedImage)imageStack.get(i);
if(rules!=null&&rules[i]!=null){BufferedImagelabel=renderLabel(img,rules[i],req,mergeOptions);
if(label!=null){img=joinBufferedImageHorizzontally(img,label,mergeOptions.getLabelFont(),mergeOptions.isAntialias(),mergeOptions.isTransparent(),mergeOptions.getBackgroundColor(),mergeOptions.getLabelMargin());
else{nodes.add(img);
if(layout==LegendLayout.HORIZONTAL){Row[]rows=createRows(nodes,mergeOptions.getRowWidth(),mergeOptions.getRows());finalLegend=buildFinalHLegend(rows,mergeOptions);
if(layout==LegendLayout.VERTICAL){Column[]columns=createColumns(nodes,mergeOptions.getColumnHeight(),mergeOptions.getColumns(),req,true);finalLegend=buildFinalVLegend(columns,mergeOptions);
if(imgCount==1&&(!mergeOptions.isForceLabelsOn()||rules==null)){return(BufferedImage)imageStack.get(0);
if(mergeOptions.isForceTitlesOff()){for(RenderedImageimg:imageStack){nodes.add((BufferedImage)img);
else{//mergelayertitleswithlegendimagesfor(inti=0;i<imgCount;i=i+2){BufferedImagelbl=(BufferedImage)imageStack.get(i);BufferedImageimg=(BufferedImage)imageStack.get(i+1);img=joinBufferedImageVertically(lbl,img,mergeOptions.getLabelFont(),mergeOptions.isAntialias(),mergeOptions.isTransparent(),mergeOptions.getBackgroundColor());nodes.add(img);
if(layout==LegendLayout.HORIZONTAL){Row[]rows=createRows(nodes,0,0);finalLegend=buildFinalHLegend(rows,mergeOptions);
if(layout==LegendLayout.VERTICAL){Column[]columns=createColumns(nodes,0,0,null,false);finalLegend=buildFinalVLegend(columns,mergeOptions);
if(maxHeight>0){/**Limitmaxcolumn*/intcnLimit=maxColumns>0?maxColumns:nodes.size();legendMatrix=newColumn[cnLimit];legendMatrix[0]=newColumn();intcn=0;intcolumnHeight=0;for(inti=0;i<nodes.size();i++){BufferedImagenode=nodes.get(i);
if(columnHeight<=maxHeight){//FillcurrentcolumnlegendMatrix[cn].addNode(node);columnHeight=columnHeight+node.getHeight();
else{//Addcurrentnodetonextcolumni--;cn++;//Stop
ifcolumnlimitsisreached
if(cn==cnLimit){break;
else{/**Limitmaxcolumn,
ifnolimitsetitto1*/intcolNumber=maxColumns>0?maxColumns:1;legendMatrix=newColumn[colNumber];legendMatrix[0]=newColumn();introwNumber=(int)Math.ceil((float)nodes.size()/colNumber);intcn=0;intrc=0;booleancolourPresent=false;for(inti=0;i<nodes.size();i++){
if(rc<rowNumber){
if(checkColor){//checkforpresenceofcolour(ie.non-emptylegendrow)colourPresent=checkColor(nodes.get(i),req);
if(colourPresent){legendMatrix[cn].addNode(nodes.get(i));rc++;
else{legendMatrix[cn].addNode(nodes.get(i));rc++;
else{i--;cn++;rc=0;legendMatrix[cn]=newColumn();
ifnocoloursaredetected*/publicstaticbooleancheckColor(BufferedImageimg,GetLegendGraphicRequestreq){intw=img.getWidth();inth=img.getHeight();booleancolourPresent=false;for(intj=0;j<w;j++){for(intk=0;k<h;k++){
if(img.getRGB(j,k)!=LegendUtils.getBackgroundColor(req).getRGB()){colourPresent=true;
if(maxWidth>0){/**Limitmaxcolumn*/intrnLimit=maxRows>0?maxRows:nodes.size();legendMatrix=newRow[rnLimit];legendMatrix[0]=newRow();intrn=0;introwWidth=0;for(inti=0;i<nodes.size();i++){BufferedImagenode=nodes.get(i);
if(rowWidth<=maxWidth){//FillcurrentcolumnlegendMatrix[rn].addNode(node);rowWidth=rowWidth+node.getWidth();
else{//Addcurrentnodetonextcolumni--;rn++;//Stop
ifcolumnlimitsisreached
if(rn==rnLimit){break;
else{/**Limitmaxcolumn,
ifnolimitsetitto1*/introwNumber=maxRows>0?maxRows:1;legendMatrix=newRow[rowNumber];legendMatrix[0]=newRow();intcolNumber=(int)Math.ceil((float)nodes.size()/rowNumber);intrn=0;intcc=0;for(inti=0;i<nodes.size();i++){
if(cc<colNumber){legendMatrix[rn].addNode(nodes.get(i));cc++;
else{i--;rn++;cc=0;legendMatrix[rn]=newRow();
if(c!=null){
if(totalWidth>0){totalWidth=totalWidth+options.getDx();
if(options.isAntialias()){finalGraphics.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_ON);
else{finalGraphics.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_OFF);
if(c!=null){for(BufferedImagen:c.getNodes()){finalGraphics.drawImage(n,hOffset,vOffset,null);vOffset=vOffset+n.getHeight()+options.getDy();
if(r!=null){
if(totalHeight>0){totalHeight=totalHeight+options.getDy();
if(options.isAntialias()){finalGraphics.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_ON);
else{finalGraphics.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_OFF);
if(r!=null){for(BufferedImagen:r.getNodes()){finalGraphics.drawImage(n,hOffset,vOffset,null);hOffset=hOffset+n.getWidth()+options.getDx();
iftrueappliesantialiasing*@paramtransparent
iftruemakelegendtransparent*@parambackgroundColorbackgroundcoloroflegend*@returnBufferedImageofimageandlabelsidebysideandverticallycenter*/privatestaticBufferedImagejoinBufferedImageHorizzontally(BufferedImageimg,BufferedImagelabel,FontlabelFont,booleanuseAA,booleantransparent,ColorbackgroundColor,intlabelXOffset){//dosomecalculatefirstintwid=img.getWidth()+label.getWidth()+labelXOffset;intheight=Math.max(img.getHeight(),label.getHeight());//createanewbufferanddrawtwoimageintothenewimageBufferedImagenewImage=ImageUtils.createImage(wid,height,(IndexColorModel)null,transparent);finalMap<RenderingHints.Key,Object>hintsMap=newHashMap<RenderingHints.Key,Object>();Graphics2Dg2=ImageUtils.prepareTransparency(transparent,backgroundColor,newImage,hintsMap);g2.setFont(labelFont);
if(useAA){g2.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_ON);
else{g2.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_OFF);
iftrueappliesantialiasing*@paramtransparent
iftruemakelegendtransparent*@parambackgroundColorbackgroundcoloroflegend*@returnBufferedImageofimageandlabelsidebysideandverticallycenter*/privatestaticBufferedImagejoinBufferedImageVertically(BufferedImagelabel,BufferedImageimg,FontlabelFont,booleanuseAA,booleantransparent,ColorbackgroundColor){//dosomecalculatefirstintoffset=0;intheight=img.getHeight()+label.getHeight()+offset;intwid=Math.max(img.getWidth(),label.getWidth())+offset;//createanewbufferanddrawtwoimageintothenewimageBufferedImagenewImage=ImageUtils.createImage(wid,height,(IndexColorModel)null,transparent);finalMap<RenderingHints.Key,Object>hintsMap=newHashMap<RenderingHints.Key,Object>();Graphics2Dg2=ImageUtils.prepareTransparency(transparent,backgroundColor,newImage,hintsMap);g2.setFont(labelFont);
if(useAA){g2.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_ON);
else{g2.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_OFF);
ifruleisnotnullthelabelwillberendered*@paramreqtherequest*@paramoptionsoptionstobeusedformerging*@returntheBufferedImageoflabel*/privatestaticBufferedImagerenderLabel(RenderedImageimg,Rulerule,GetLegendGraphicRequestreq,MergeOptionsoptions){BufferedImagelabelImg=null;
if(!options.isForceLabelsOff()&&rule!=null){Stringlabel=LegendUtils.getRuleLabel(rule,req);
if(label!=null&&label.length()>0){finalBufferedImagerenderedLabel=getRenderedLabel((BufferedImage)img,label,req);labelImg=renderedLabel;
if(useAA){graphics.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_ON);
else{graphics.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_OFF);
ifthistaskpublishessomething,removeit).**@paramctxtaskcontext*@throwsTaskException*/voidcleanup(TaskContextctx)throwsTaskException;/***tasktypecanspecifywhetheritsupportsclean-upornot**@returntrue
ifclean-upissupported*/defaultbooleansupportsCleanup(){returntrue;}}
ifit'snot,andproceedingnormaly*
iftheserviceisenabled.**@authorGabrielRoldan*/publicclassGWCServiceEnablementInterceptorimplementsMethodInterceptor{privateGWCgwcFacade;privatefinalGeoServergeoServer;/***@paramgwcprovidesaccesstothe{@linkGWCConfigconfiguration}tocheckwhetheraservice*is{@linkGWC#isServiceEnabled(Service)enabled}.*/publicGWCServiceEnablementInterceptor(finalGWCgwc,GeoServergeoServer){this.gwcFacade=gwc;this.geoServer=geoServer;
if("getConveyor".equals(methodName)||"handleRequest".equals(methodName)){finalorg.geowebcache.service.Serviceservice=(Service)invocation.getThis();booleanserviceEnabled;
if(service.getPathName().equals("wmts")){serviceEnabled=geoServer.getService(WMTSInfo.class).isEnabled();
else{serviceEnabled=gwcFacade.isServiceEnabled(service);
if(!serviceEnabled){throwneworg.geowebcache.service.HttpErrorCodeException(400,"Serviceisdisabled");
if(rd==null){thrownewIOException(typeName+"isnotasupportedtype");
if(ad==null){returnnewCloseableIteratorAdapter<String>(newArrayList<String>().iterator());
if(prop!=null)try{values.add(newString(((String)prop.getValue()).getBytes("ISO-8859-1"),"UTF-8"));
if(q.getTypeName()==null){typeName=CSWRecordDescriptor.RECORD_DESCRIPTOR.getName();
else
if(q.getNamespace()!=null){typeName=newNameImpl(q.getNamespace().toString(),q.getTypeName());
else{typeName=newNameImpl(q.getTypeName());
if(outputSchema==null||"".equals(outputSchema)){rdOutput=descriptorByOutputSchema.get(CSWRecordDescriptor.getInstance().getOutputSchema());
else{rdOutput=descriptorByOutputSchema.get(outputSchema);
if(rd==null){thrownewIOException(q.getTypeName()+"isnotasupportedtype");
if(rdOutput==null){thrownewIOException(outputSchema+"isnotasupportedoutputschema");
ifthestringcan'tbeparsed.*/publicvoidtestPeriod()throwsParseException{finallongmillisInDay=TimeParser.MILLIS_IN_DAY;assertEquals(millisInDay,TimeParser.parsePeriod("P1D"));assertEquals(3*millisInDay,TimeParser.parsePeriod("P3D"));assertEquals(14*millisInDay,TimeParser.parsePeriod("P2W"));assertEquals(8*millisInDay,TimeParser.parsePeriod("P1W1D"));assertEquals(millisInDay,TimeParser.parsePeriod("PT24H"));assertEquals(Math.round(1.5*millisInDay),TimeParser.parsePeriod("P1.5D"));
ifthestringcan'tbeparsed.*/publicvoidtestInterval()throwsParseException{TimeKvpParsertimeKvpParser=newTimeKvpParser("TIME");Listl=newArrayList((Collection)timeKvpParser.parse(PERIOD));//Verifythatthelistcontainsatleastoneelement.assertFalse(l.isEmpty());assertInstant(format.parse("2007-01-01T12Z"),l.get(0));assertInstant(format.parse("2007-01-03T00Z"),l.get(1));assertInstant(format.parse("2007-01-04T12Z"),l.get(2));assertInstant(format.parse("2007-01-06T00Z"),l.get(3));assertInstant(format.parse("2007-01-07T12Z"),l.get(4));assertInstant(format.parse("2007-01-09T00Z"),l.get(5));assertInstant(format.parse("2007-01-10T12Z"),l.get(6));assertInstant(format.parse("2007-01-12T00Z"),l.get(7));l=newArrayList((Collection)timeKvpParser.parse("2007-01-01T12Z/2007-01-01T13Z/PT10M"));//Verifythatthelistcontainsatleastoneelement.assertFalse(l.isEmpty());assertEquals(12,l.size());assertInstant(format.parse("2007-01-01T12Z"),l.get(0));
if(objectinstanceofDateRange){assertEquals(object+"Shouldstartat",expected,((DateRange)object).getMinValue());assertEquals(object+"Shouldendat",expected,((DateRange)object).getMaxValue());
else
if(objectinstanceofDate){assertEquals(expected,object);
else{fail("ShouldhaveaDateRange:"+object);
if(range.getMinValue()==null)fail("Expectedfiniterange,saw:"+range);
if(range.getMaxValue()==null)fail("Expectedfiniterange,saw:"+range);longmin=range.getMinValue().getTime();longmax=range.getMaxValue().getTime();assertEquals("Range"+range+"shouldhavelength",expectedLength,max-min);
if(range.getMinValue()==null)fail("Expectedvalidstartdateinrange"+range);assertEquals("Range"+range+"shouldhavestart",expectedStart,range.getMinValue());
if(range.getMaxValue()==null)fail("Expectedvalidenddateinrange"+range);assertEquals("Range"+range+"shouldhaveend",expectedEnd,range.getMaxValue());}}
if(mapContents!=null){out.write(mapContents);
else
if(buffer!=null){buffer.writeTo(out);
else
if(stream!=null){IOUtils.copy(stream,out);
else{thrownewIllegalStateException();
if(stream!=null){try{stream.close();
if(request.getSchemaLanguage()!=null&&!SUPPORTED_SCHEMA_LANGUAGES.contains(request.getSchemaLanguage())){thrownewServiceException("Unsupportedschemalanguage"+request.getSchemaLanguage(),ServiceException.INVALID_PARAMETER_VALUE,"schemaLanguage");
if(request.getTypeName()==null||request.getTypeName().isEmpty()){//returnalltheoneswehavereturngetFeatureDescriptors(store.getRecordDescriptors());
else{List<AttributeDescriptor>result=newArrayList<AttributeDescriptor>();Set<String>requested=newHashSet();for(QNamename:request.getTypeName()){requested.add(name.getLocalPart());
ifitwasrequestedStringtypeName=descriptor.getName().getLocalPart();
if(requested.remove(typeName)){result.add(descriptor);
if(requested.size()!=0){LOGGER.log(Level.FINE,"Failedtolocatefeaturetypes"+requested+",ignoringthem");
ifanyremoveStore(null,"cookbook");
if(body!=null&&!body.isEmpty()){request.setContent(body.getBytes("UTF-8"));
if(value!=null){returnvalue[0];
if(matcher.matches()){returnmatcher.group(1);
if(matcher.matches()){returnmatcher.group(1);
ifnofactorycandealwithsecuringthespecifiedobject.**@paramobjecttherawobjecttobesecured*@parampolicythewrappingpolicy(howthesecuredwrappershouldbehave)*@returnthesecuredobject,ornull
iftheinputisnull.*@throwsIllegalArgumentException
ifthefactoryisnotabletowraptheobject*/publicstaticObjectsecure(Objectobject,WrapperPolicypolicy){//nullsafety
if(object==null)returnnull;//IncasetheobjecttobesecurediswrappedinaModificationProxy,gettheproxied//Objectclass//
iftheobjectisnotwrapped,ModificationProxy.unwrap()willjustreturntheobject//reference.finalObjectunwrappedObject=ModificationProxy.unwrap(object);//
ifwealreadyknowwhatcanhandlethewrapping,justdoit,don't//scantheextensionpointsoncemoreClass<?>clazz=unwrappedObject.getClass();SecuredObjectFactorycandidate=FACTORY_CACHE.get(clazz);//otherwisescanandstore(orcomplain)
if(candidate==null){//scantheapplicationcontextList<SecuredObjectFactory>factories=GeoServerExtensions.extensions(SecuredObjectFactory.class);for(SecuredObjectFactoryfactory:factories){
if(factory.canSecure(clazz)){candidate=factory;break;
if(candidate==null)thrownewIllegalArgumentException("Couldnotfindasecuritywrapperforclass"+clazz+",cannotsecuretheobject");FACTORY_CACHE.put(clazz,candidate);
if(webUIMode==null){webUIMode=WebUIMode.DEFAULT;
switch(webUIMode){caseDO_NOT_REDIRECT:getRequestCycleSettings().setRenderStrategy(RenderStrategy.ONE_PASS_RENDER);break;caseREDIRECT:getRequestCycleSettings().setRenderStrategy(RenderStrategy.REDIRECT_TO_BUFFER);break;caseDEFAULT:getRequestCycleSettings().setRenderStrategy(defaultIsRedirect?RenderStrategy.REDIRECT_TO_BUFFER:RenderStrategy.ONE_PASS_RENDER);
if(config==null){returnDEPLOYMENT;
else
if(!"DEPLOYMENT".equalsIgnoreCase(config)&&!"DEVELOPMENT".equalsIgnoreCase(config)){LOGGER.warning("UnknownWicketconfigurationvalue'"+config+"',defaultingtoDEPLOYMENT");returnDEPLOYMENT;
else{returnRuntimeConfigurationType.valueOf(config.toUpperCase());
if(s.getLocale()==null)s.setLocale(Locale.ENGLISH);returns;
if(target!=null){//returntarget;//
if(handlerinstanceofIPageRequestHandler){IPageRequestHandlerpageHandler=(IPageRequestHandler)handler;Class<?extendsIRequestablePage>pageClass=pageHandler.getPageClass();for(WicketCallbackcallback:callbacks){callback.onRequestTargetSet(cycle,pageClass);
else
if(handlerinstanceofIRequestHandlerDelegate){IRequestHandlerDelegatedelegator=(IRequestHandlerDelegate)handler;processHandler(cycle,delegator.getDelegateHandler());
if(cycle==null){thrownewIllegalStateException("Methodmustbecalledfromawicketrequestthread");
if(req==null||!(reqinstanceofServletWebRequest)){thrownewIllegalStateException("RequestnotoftypeServletWebRequest,was:"+req.getClass().getName());
if(eventinstanceofAuthenticationSuccessEvent||eventinstanceofInteractiveAuthenticationSuccessEvent){
if(Session.exists()){WebSession.get().replaceSession();
if(ProcessFactory.class.isAssignableFrom(category)){return(Iterator<T>)Collections.singletonList(SpringBeanProcessFactory.this).iterator();
else{returnnull;
if(ffinstanceofProcessFunctionFactory){ProcessFunctionFactorypff=(ProcessFunctionFactory)ff;pff.clear();
if(name.endsWith("Process")){name=name.substring(0,name.indexOf("Process"));
if(c==null){returnnull;
else{return(DescribeProcess)c.getAnnotation(DescribeProcess.class);
if(c!=null){for(Methodm:c.getMethods()){
if(m.getName().equals("execute")){
if(lastExecute!=null){lastExecute=m;
ifannotatedreturnimmediately,otherwisekeepitaside
if(m.getAnnotation(DescribeResult.class)!=null||m.getAnnotation(DescribeResults.class)!=null){returnm;
if(beanName==null){returnnull;
if(eventinstanceofContextRefreshedEvent){Processors.addProcessFactory(this);
else
if(eventinstanceofContextClosedEvent){Processors.removeProcessFactory(this);
if(encoder.canEncode("éö")){STR_MY_TEST="Thisismytest.éö";
else{STR_MY_TEST="Thisismytest.";
if(encoder.canEncode("€è")){STR_MY_NEW_TEST="Thisismynewtest.€è";
else{STR_MY_NEW_TEST="Thisismynewtest.";
ifthefilesystemencodedthefilewitha?weneedtoskipthistestAssume.assumeTrue(SystemUtils.IS_OS_WINDOWS||getDataDirectory().get("po?zie").getType()==Type.UNDEFINED);Assert.assertEquals(Type.DIRECTORY,getDataDirectory().get("poëzie").getType());XMLUnit.setXpathNamespaceContext(NS_XML);Documentdoc=getAsDOM(RestBaseController.ROOT_PATH+"/resource/po%c3%abzie?format=xml");XMLAssert.assertXpathEvaluatesTo("http://localhost:8080/geoserver"+RestBaseController.ROOT_PATH+"/resource/po%C3%ABzie/caf%C3%A9","/ResourceDirectory/children/child/atom:link/@href",doc);MockHttpServletResponseresponse=getAsServletResponse(RestBaseController.ROOT_PATH+"/resource/po%c3%abzie/caf%c3%a9?format=xml");Assert.assertEquals(200,response.getStatus());Assert.assertEquals("resource",response.getHeader("Resource-Type"));Assert.assertEquals("http://localhost:8080/geoserver"+RestBaseController.ROOT_PATH+"/resource/po%C3%ABzie",response.getHeader("Resource-Parent"));
if(property==IndexInfoProvider.LAYER){Stringvalue=(String)IndexInfoProvider.LAYER.getModel(itemModel).getObject();Labellabel=newLabel(id,value);returnlabel;
else
if(property==IndexInfoProvider.INDEXED_ATTRIBUTE){Stringvalue=(String)IndexInfoProvider.INDEXED_ATTRIBUTE.getModel(itemModel).getObject();Labellabel=newLabel(id,value);returnlabel;
else
if(property==IndexInfoProvider.INDEX_TYPE){IndexTypevalue=(IndexType)IndexInfoProvider.INDEX_TYPE.getModel(itemModel).getObject();Labellabel=newLabel(id,value.toString());returnlabel;
else
if(property==IndexInfoProvider.EXTRA_ATTRIBUTES){@SuppressWarnings("unchecked")List<String>value=(List<String>)IndexInfoProvider.EXTRA_ATTRIBUTES.getModel(itemModel).getObject();Labellabel=newLabel(id,value.toString());returnlabel;
if(WebMapService.class.isInstance(service.getService())){Stringlayers=(String)request.getRawKvp().get("LAYERS");
if(layers!=null){request.getRawKvp().put("LAYERS",qualifyLayerNamesKVP(layers,ws));
if(layers!=null){request.getRawKvp().put("QUERY_LAYERS",qualifyLayerNamesKVP(layers,ws));
if(layer!=null){request.getRawKvp().put("LAYER",qualifyName(layer,ws));
if(styles!=null&&!styles.trim().isEmpty()){request.getRawKvp().put("STYLES",qualifyStyleNamesKVP(styles,ws));
if(style!=null&&!style.trim().isEmpty()){request.getRawKvp().put("STYLE",qualifyStyleName(style,ws));
if(gc!=null){gc.setNamespace(ws.getName());return;
ifit'snotalayergroup(andpreferlocallayerstogroupsincaseof//nameclash),butalsocheckforworkspacespecificlayergroups
if(catalog.getLayerByName(qualified)!=null||catalog.getLayerGroupByName(baseName)==null){names.set(i,qualified);
else
if(catalog.getLayerGroupByName(qualified)!=null){names.set(i,qualified);
if(catalog.getStyleByName(qualified)!=null){returnqualified;
else{//usetheoriginalnameinsteadreturnname;
if(this.filter==null||this.filter.evaluate(notification)){executorPool.execute(newWorkerThread(notification,this.processor));
if(filter!=null&&!filter.isEmpty()){this.filter=CQL.toFilter(filter);
if(mime!=null){
if(NO_MIME_TYPE.equals(mime)){returnDEFAULT_FORMAT;
else{returnmime;
if(mime!=null){break;
if(mime!=null&&outputMimeTypes.contains(mime)){mimeTypeCache.put(cInfo.getId(),mime);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Addedmappingformime:"+mime);
else{//weeitherdon'thaveaclueaboutthemime,orwedon'thaveanencoder,//savetheresponseasnullmimeTypeCache.put(cInfo.getId(),NO_MIME_TYPE);returnDEFAULT_FORMAT;
if(objectinstanceofGridCoverage2D){GridCoverage2Dcoverage=(GridCoverage2D)object;returnestimateSize(coverage.getRenderedImage());
else
if(objectinstanceofRenderedImage){returnestimateSize((RenderedImage)object);
if(data==null){//willhappenincaseswherethefilterisnotactivereturnoperation;
if(operation.getParameters().length>0){//TODO:abettercheckfortherequestobjectObjectreqObj=operation.getParameters()[0];for(RequestObjectHandlerh:handlers){
if(h.canHandle(reqObj)){h.handle(reqObj,data);break;
if(request.getError()!=null){RequestDatadata=monitor.current();
if(data==null){//willhappenincaseswherethefilterisnotactivereturn;
if(OPS==null){synchronized(this){
if(OPS==null){OPS=newHashMap<String,Map<String,String>>();for(Services:GeoServerExtensions.extensions(Service.class)){HashMap<String,String>map=newHashMap<String,String>();OPS.put(s.getId().toUpperCase(),map);for(Stringo:s.getOperations()){map.put(o.toUpperCase(),o);
if(map!=null){Stringnormalized=map.get(op.getId().toUpperCase());
if(normalized!=null){returnnormalized;
if(value!=null&&"false".equalsIgnoreCase(value)){//http403.commence(request,response,authException);sendUnauthorized(response);return;
if(value!=null&&"false".equalsIgnoreCase(value)){//http403.commence(request,response,authException);sendUnauthorized(response);return;
if(url!=null){
if(url.startsWith("../gwc/service/")){intidx=url.indexOf("?");Stringservice;
if(idx>0){service=url.substring("./gwc/service/".length()+1,idx);
else{service=url.substring("./gwc/service/".length()+1);
if(service!=null){services.add(service);
else
if(url.contains("GetCapabilities")){Map<String,Object>params=KvpUtils.parseQueryString(url);Stringservice=(String)params.get("service");
if(service!=null){services.add(service);
if(nullValues!=null){nullValues.clear();
if(setNoData)nullValues.add(ORIGINAL_FILL_VALUE);
if(!isNC4Available&&LOGGER.isLoggable(Level.INFO)){LOGGER.info("NetCDFClibrarynotfound.NetCDF4outputwillnotbecreated");
if(isNC4Available){byte[]netcdfOut=getBinary(response);Filefile=File.createTempFile("netcdf","out.nc",newFile("./target"));FileUtils.writeByteArrayToFile(file,netcdfOut);NetcdfDatasetdataset=NetcdfDataset.openDataset(file.getAbsolutePath());assertNotNull(dataset);dataset.close();
if(!isNC4Available&&LOGGER.isLoggable(Level.INFO)){LOGGER.info("NetCDFClibrarynotfound.NetCDF4outputwillnotbecreated");
if(isNC4Available){byte[]netcdfOut=getBinary(response);Filefile=File.createTempFile("netcdf","outCompressed.nc",newFile("./target"));FileUtils.writeByteArrayToFile(file,netcdfOut);NetcdfDatasetdataset=NetcdfDataset.openDataset(file.getAbsolutePath());assertNotNull(dataset);Variablevar=dataset.findVariable(STANDARD_NAME);assertNotNull(var);finallongvarByteSize=var.getSize()*var.getDataType().getSize();//Theoutputfileissmallerthanthesizeoftheunderlyingvariable.//CompressionsuccessfullyoccurredassertTrue(netcdfOut.length<varByteSize);dataset.close();
ifthetimeout*elapses,therendererwillbeaskedtostoprenderingandthegraphicswillbedisposedofto*makeextrasuretherenderercannotkeepgoingon.**@authorAndreaAime-OpenGeo*/publicclassRenderingTimeoutEnforcer{longtimeout;GTRendererrenderer;Graphicsgraphics;Timertimer;booleantimedOut=false;booleansaveMap;WebMapmap=null;publicRenderingTimeoutEnforcer(longtimeout,GTRendererrenderer,Graphicsgraphics){this(timeout,renderer,graphics,false);
if(timer!=null)thrownewIllegalStateException("Thetimeoutenforcerhasalreadybeenstarted");
if(timeout>0){timedOut=false;timer=newTimer();timer.schedule(newStopRenderingTask(),timeout);
if(timer!=null){timer.cancel();timer.purge();//timer.getTheHellOutOfDodge();timer=null;
iftherendererhasbeenstoppedmid-wayduetothetimeoutoccurring*/publicbooleanisTimedOut(){returntimedOut;
if(saveMap){saveMap();
switch*/protectedbooleanextendedValidation=true;publicCatalogImpl(){facade=newDefaultCatalogFacade(this);//wrapthedefaultcatalogfacadewiththefacadecapableofhandlingisolatedworkspaces//behaviorfacade=newIsolatedCatalogFacade(facade);setFacade(facade);resourcePool=ResourcePool.create(this);
if(configurationLock!=null){facade=LockingCatalogFacade.create(facade,configurationLock);
if(store.getWorkspace()==null){store.setWorkspace(getDefaultWorkspace());
ifthereisnodefaultstoreusethisoneasthedefault
if(getDefaultDataStore(store.getWorkspace())==null&&storeinstanceofDataStoreInfo){setDefaultDataStore(store.getWorkspace(),(DataStoreInfo)store);
if(isNull(store.getName())){thrownewIllegalArgumentException("Storenamemustnotbenull");
if(store.getWorkspace()==null){thrownewIllegalArgumentException("Storemustbepartofaworkspace");
if(existing!=null&&(isNew||!existing.getId().equals(store.getId()))){Stringmsg="Store'"+store.getName()+"'alreadyexistsinworkspace'"+workspace.getName()+"'";thrownewIllegalArgumentException(msg);
if(!getResourcesByStore(store,ResourceInfo.class).isEmpty()){thrownewIllegalArgumentException("Unabletodeletenon-emptystore.");
if(store.equals(defaultStore)||defaultStore==null){//TODO:thiswillfiremultipleevents,wewanttofireonlyonesetDefaultDataStore(workspace,null);//defaultremoved,chooseanotherstoretobecomedefault
ifpossibleListdstores=getStoresByWorkspace(workspace,DataStoreInfo.class);
if(!dstores.isEmpty()){setDefaultDataStore(workspace,(DataStoreInfo)dstores.get(0));
if(store.getId()==null){//additinsteadofsavingadd(store);return;
if(ws==null){ws=getDefaultWorkspace();
if(clazz!=null&&clazz.isAssignableFrom(DataStoreInfo.class)&&(name==null||name.equals(Catalog.DEFAULT))){return(T)getDefaultDataStore(workspace);
if(store==null&&workspace==null){store=facade.getStoreByName(CatalogFacade.ANY_WORKSPACE,name,clazz);
if(workspace!=null){returngetStoreByName(workspace,name,clazz);
if(workspaceName!=null){workspace=getWorkspaceByName(workspaceName);
if(workspace==null){returnCollections.EMPTY_LIST;
if(store!=null){//basicsanitycheck
if(store.getWorkspace()==null){thrownewIllegalArgumentException("Thestorehasnotbeenassignedaworkspace");
if(!store.getWorkspace().equals(workspace)){thrownewIllegalArgumentException("Tryingtomarkasdefault"+"forworkspace"+workspace.getName()+"astorethat"+"iscontainedin"+store.getWorkspace().getName());
if(resource.getNamespace()==null){//defaulttodefaultnamespaceresource.setNamespace(getDefaultNamespace());
if(resource.getNativeName()==null){resource.setNativeName(resource.getName());
if(isNull(resource.getName())){thrownewNullPointerException("Resourcenamemustnotbenull");
if(isNull(resource.getNativeName())&&!(resourceinstanceofCoverageInfo&&((CoverageInfo)resource).getNativeCoverageName()!=null)){thrownewNullPointerException("Resourcenativenamemustnotbenull");
if(resource.getStore()==null){thrownewIllegalArgumentException("Resourcemustbepartofastore");
if(resource.getNamespace()==null){thrownewIllegalArgumentException("Resourcemustbepartofanamespace");
if(existing!=null&&!existing.getId().equals(resource.getId())){Stringmsg="Resourcenamed'"+resource.getName()+"'alreadyexistsinstore:'"+store.getName()+"'";thrownewIllegalArgumentException(msg);
if(existing!=null&&!existing.getId().equals(resource.getId())){Stringmsg="Resourcenamed'"+resource.getName()+"'alreadyexistsinnamespace:'"+namespace.getPrefix()+"'";thrownewIllegalArgumentException(msg);
if(!getLayers(resource).isEmpty()){thrownewIllegalArgumentException("Unabletodeleteresourcereferencedbylayer");
if("".equals(ns)){ns=null;
if(ns!=null){NamespaceInfonamespace=getNamespaceByPrefix(ns);
if(namespace==null){namespace=getNamespaceByURI(ns);
if(namespace!=null){returngetResourceByName(namespace,name,clazz);
if(namespace==null){namespace=getDefaultNamespace();
if(resource==null&&ns==null){resource=facade.getResourceByName(CatalogFacade.ANY_NAMESPACE,name,clazz);
if(colon!=-1){Stringns=name.substring(0,colon);StringlocalName=name.substring(colon+1);returngetResourceByName(ns,localName,clazz);
else{returngetResourceByName((String)null,name,clazz);
if(namespace==null){returngetResourcesByNamespace((NamespaceInfo)null,clazz);
if(ns==null){ns=getNamespaceByURI(namespace);
if(ns==null){returnCollections.EMPTY_LIST;
if(layer.getType()==null){
if(layer.getResource()instanceofFeatureTypeInfo){layer.setType(PublishedType.VECTOR);
else
if(layer.getResource()instanceofCoverageInfo){layer.setType(PublishedType.RASTER);
else
if(layer.getResource()instanceofWMTSLayerInfo){layer.setType(PublishedType.WMTS);
else
if(layer.getResource()instanceofWMSLayerInfo){layer.setType(PublishedType.WMS);
else{Stringmsg="Layertypenotsetandcan'tbederivedfromresource";thrownewIllegalArgumentException(msg);
if(isNull(layer.getName())){//thrownewNullPointerException("Layernamemustnotbenull");//
if(layer.getResource()==null){thrownewNullPointerException("Layerresourcemustnotbenull");
if(null==getResourceByName(ns,layer.getResource().getName(),ResourceInfo.class)){thrownewIllegalStateException("Foundnoresourcenamed"+layer.prefixedName()+",Layerwiththatnamecan'tbeadded");
if(existing!=null&&!existing.getId().equals(layer.getId())){thrownewIllegalArgumentException("Layernamed'"+layer.getName()+"'inworkspace'"+prefix+"'alreadyexists.");
ifthestyleismissingassociateadefaultone,toavoidbreakingWMS
if(layer.getDefaultStyle()==null){try{LOGGER.log(Level.INFO,"Layer"+layer.prefixedName()+"ismissingthedefaultstyle,assigningoneautomatically");StyleInfostyle=newCatalogBuilder(this).getDefaultStyle(layer.getResource());layer.setDefaultStyle(style);
if(styleInfo==null){it.remove();
if(lg.getLayers().contains(layer)||layer.equals(lg.getRootLayer())){Stringmsg="Unabletodeletelayerreferencedbylayergroup'"+lg.getName()+"'";thrownewIllegalArgumentException(msg);
if(name.getNamespaceURI()!=null){NamespaceInfons=getNamespaceByURI(name.getNamespaceURI());
if(ns!=null){returngetLayerByName(ns.getPrefix()+":"+name.getLocalPart());
if(colon!=-1){//searchbyresourcenameStringprefix=name.substring(0,colon);Stringresource=name.substring(colon+1);result=getLayerByName(prefix,resource);
else{//searchindefaultworkspacefirstWorkspaceInfows=getDefaultWorkspace();
if(ws!=null){result=getLayerByName(ws.getName(),name);
if(result==null){result=facade.getLayerByName(name);
if(r==null){returnnull;
if(layers.size()==1){returnlayers.get(0);
else{returnnull;
if(layerGroup.getStyles().isEmpty()){for(PublishedInfol:layerGroup.getLayers()){//defaultstylelayerGroup.getStyles().add(null);
if(isNull(layerGroup.getName())){thrownewNullPointerException("Layergroupnamemustnotbenull");
if(existing!=null&&!existing.getId().equals(layerGroup.getId())){//nullworkspacecancauselayergroupinanyworkspacetobereturned,checkthat//workspacesmatchWorkspaceInfoews=existing.getWorkspace();
if((ws==null&&ews==null)||(ws!=null&&ws.equals(ews))){Stringmsg="Layergroupnamed'"+layerGroup.getName()+"'alreadyexists";
if(ws!=null){msg+="inworkspace"+ws.getName();
if(layers!=null&&styles!=null&&layers.get(i)==null&&styles.get(i)==null){layers.remove(i);styles.remove(i);
else{//Validatestylegroup
if(layers.get(i)==null){try{//validatestylegroupsStyledLayerDescriptorsld=styles.get(i).getSLD();List<Exception>errors=SLDNamedLayerValidator.validate(this,sld);
if(errors.size()>0){thrownewIllegalArgumentException("Invalidstylegroup:"+errors.get(0).getMessage(),errors.get(0));
if(layerGroup.getLayers()==null||layerGroup.getLayers().isEmpty()){thrownewIllegalArgumentException("Layergroupmustnotbeempty");
if(layerGroup.getStyles()!=null&&!layerGroup.getStyles().isEmpty()&&!(layerGroup.getStyles().size()==layerGroup.getLayers().size())){thrownewIllegalArgumentException("Layergrouphasdifferentnumberofstylesthanlayers");
if(loopPath!=null){thrownewIllegalArgumentException("Layergroupisinaloop:"+helper.getLoopAsString(loopPath));
ifthelayergrouphasaworkspaceassigned,ensurethateveryresourceinthatlayer//groupliveswithinthesameworkspace
if(ws!=null){checkLayerGroupResourceIsInWorkspace(layerGroup,ws);
if(layerGroup.getMode()==null){thrownewIllegalArgumentException("Layergroupmodemustnotbenull");
else
if(LayerGroupInfo.Mode.EO.equals(layerGroup.getMode())){
if(layerGroup.getRootLayer()==null){thrownewIllegalArgumentException("Layergroupinmode"+LayerGroupInfo.Mode.EO.getName()+"musthavearootlayer");
if(layerGroup.getRootLayerStyle()==null){thrownewIllegalArgumentException("Layergroupinmode"+LayerGroupInfo.Mode.EO.getName()+"musthavearootlayerstyle");
else{
if(layerGroup.getRootLayer()!=null){thrownewIllegalArgumentException("Layergroupinmode"+layerGroup.getMode().getName()+"mustnothavearootlayer");
if(layerGroup.getRootLayerStyle()!=null){thrownewIllegalArgumentException("Layergroupinmode"+layerGroup.getMode().getName()+"mustnothavearootlayerstyle");
if(layerGroup==null)return;
if(layerGroup.getWorkspace()!=null&&!ws.equals(layerGroup.getWorkspace())){thrownewIllegalArgumentException("Layergroupwithinaworkspace("+ws.getName()+")cannotcontainresourcesfromotherworkspace:"+layerGroup.getWorkspace().getName());
if(layerGroup.getLayers()!=null){for(PublishedInfop:layerGroup.getLayers()){
if(pinstanceofLayerGroupInfo){checkLayerGroupResourceIsInWorkspace((LayerGroupInfo)p,ws);
else
if(pinstanceofLayerInfo){checkLayerGroupResourceIsInWorkspace((LayerInfo)p,ws);
if(layerGroup.getStyles()!=null){for(StyleInfos:layerGroup.getStyles()){checkLayerGroupResourceIsInWorkspace(s,ws);
if(style==null)return;
if(style.getWorkspace()!=null&&!ws.equals(style.getWorkspace())){thrownewIllegalArgumentException("Layergroupwithinaworkspace("+ws.getName()+")cannotcontainstylesfromotherworkspace:"+style.getWorkspace());
if(layer==null)return;ResourceInfor=layer.getResource();
if(r.getStore().getWorkspace()!=null&&!ws.equals(r.getStore().getWorkspace())){thrownewIllegalArgumentException("Layergroupwithinaworkspace("+ws.getName()+")cannotcontainresourcesfromotherworkspace:"+r.getStore().getWorkspace().getName());
if(lg.getLayers().contains(layerGroup)||layerGroup.equals(lg.getRootLayer())){Stringmsg="Unabletodeletelayergroupreferencedbylayergroup'"+lg.getName()+"'";thrownewIllegalArgumentException(msg);
if(workspaceName!=null){workspace=getWorkspaceByName(workspaceName);
if(workspace==null){returnCollections.EMPTY_LIST;
if(layerGroup!=null)returnlayerGroup;//lastchance:checkinghandleprefixednamecaseStringworkspaceName=null;StringlayerGroupName=null;intcolon=name.indexOf(':');
if(colon==-1){//
ifthereisnoprefix,trythedefaultworkspaceWorkspaceInfodefaultWs=getDefaultWorkspace();workspaceName=defaultWs==null?null:defaultWs.getName();layerGroupName=name;
if(colon!=-1){workspaceName=name.substring(0,colon);layerGroupName=name.substring(colon+1);
if(workspaceName!=null){workspace=getWorkspaceByName(workspaceName);
if(workspace==null){returnnull;
if(null==workspace){workspace=DefaultCatalogFacade.NO_WORKSPACE;
if(prefix==null||Catalog.DEFAULT.equals(prefix)){NamespaceInfons=getDefaultNamespace();
if(ns!=null){prefix=ns.getPrefix();
if(getDefaultNamespace()==null){setDefaultNamespace(resolved);
if(namespace.isIsolated()&&!getCatalogCapabilities().supportsIsolatedWorkspaces()){//isolatednamespaces\workspacesarenotsupportedbythiscatalogthrownewIllegalArgumentException(String.format("Namespace'%s:%s'isisolatedbutisolatedworkspacesarenotsupportedbythiscatalog.",namespace.getPrefix(),namespace.getURI()));
if(isNull(namespace.getPrefix())){thrownewNullPointerException("Namespaceprefixmustnotbenull");
if(namespace.getPrefix().equals(DEFAULT)){thrownewIllegalArgumentException(DEFAULT+"isareservedkeyword,can'tbeusedasthenamespaceprefix");
if(existing!=null&&!existing.getId().equals(namespace.getId())){thrownewIllegalArgumentException("Namespacewithprefix'"+namespace.getPrefix()+"'alreadyexists.");
if(!namespace.isIsolated()){//notanisolatednamespace\workplacesoweneedtocheckforduplicatesexisting=getNamespaceByURI(namespace.getURI());
if(existing!=null&&!existing.getId().equals(namespace.getId())){thrownewIllegalArgumentException("NamespacewithURI'"+namespace.getURI()+"'alreadyexists.");
if(isNull(namespace.getURI())){thrownewNullPointerException("Namespaceurimustnotbenull");
if(!getResourcesByNamespace(namespace,ResourceInfo.class).isEmpty()){thrownewIllegalArgumentException("Unabletodeletenon-emptynamespace.");
if(namespace.equals(defaultNamespace)||defaultNamespace==null){List<NamespaceInfo>namespaces=facade.getNamespaces();defaultNamespace=null;
if(!namespaces.isEmpty()){defaultNamespace=namespaces.get(0);
if(defaultNamespace!=null){WorkspaceInfodefaultWorkspace=getWorkspaceByName(defaultNamespace.getPrefix());
if(defaultWorkspace!=null){setDefaultWorkspace(defaultWorkspace);
if(defaultNamespace!=null){NamespaceInfons=getNamespaceByPrefix(defaultNamespace.getPrefix());
if(ns==null){thrownewIllegalArgumentException("Nosuchnamespace:'"+defaultNamespace.getPrefix()+"'");
else{defaultNamespace=ns;
if(getWorkspaceByName(workspace.getName())!=null){thrownewIllegalArgumentException("Workspacewithname'"+workspace.getName()+"'alreadyexists.");
ifthereisnodefaultworkspaceusethisoneasthedefault
if(getDefaultWorkspace()==null){setDefaultWorkspace(workspace);
if(workspace.isIsolated()&&!getCatalogCapabilities().supportsIsolatedWorkspaces()){//isolatednamespaces\workspacesarenotsupportedbythiscatalogthrownewIllegalArgumentException(String.format("Workspace'%s'isisolatedbutisolatedworkspacesarenotsupportedbythiscatalog.",workspace.getName()));
if(isNull(workspace.getName())){thrownewNullPointerException("workspacenamemustnotbenull");
if(workspace.getName().equals(DEFAULT)){thrownewIllegalArgumentException(DEFAULT+"isareservedkeyword,can'tbeusedastheworkspacename");
if(existing!=null&&!existing.getId().equals(workspace.getId())){thrownewIllegalArgumentException("Workspacenamed'"+workspace.getName()+"'alreadyexists.");
if(getNamespaceByPrefix(workspace.getName())!=null){thrownewIllegalArgumentException("Cannotdeleteworkspacewithlinkednamespace");
if(!getStoresByWorkspace(workspace,StoreInfo.class).isEmpty()){thrownewIllegalArgumentException("Cannotdeletenon-emptyworkspace.");
if(workspace.equals(defaultWorkspace)||defaultWorkspace==null){List<WorkspaceInfo>workspaces=facade.getWorkspaces();defaultWorkspace=null;
if(!workspaces.isEmpty()){defaultWorkspace=workspaces.get(0);
if(defaultWorkspace!=null){NamespaceInfodefaultNamespace=getNamespaceByPrefix(defaultWorkspace.getName());
if(defaultNamespace!=null){setDefaultNamespace(defaultNamespace);
if(defaultWorkspace!=null){WorkspaceInfows=facade.getWorkspaceByName(defaultWorkspace.getName());
if(ws==null){thrownewIllegalArgumentException("Nosuchworkspace:'"+defaultWorkspace.getName()+"'");
else{defaultWorkspace=ws;
if(name==null||Catalog.DEFAULT.equals(name)){WorkspaceInfows=getDefaultWorkspace();
if(ws!=null){name=ws.getName();
if(colon!=-1){//searchbyresourcenameStringprefix=name.substring(0,colon);Stringresource=name.substring(colon+1);result=getStyleByName(prefix,resource);
else{//searchindefaultworkspacefirstWorkspaceInfows=getDefaultWorkspace();
if(ws!=null){result=getStyleByName(ws,name);
if(result==null){result=facade.getStyleByName(name);
if(workspaceName==null){returngetStyleByName((WorkspaceInfo)null,name);
if(workspace!=null){returngetStyleByName(workspace,name);
if(workspace==null){workspace=DefaultCatalogFacade.NO_WORKSPACE;
if(workspaceName!=null){workspace=getWorkspaceByName(workspaceName);
if(workspace==null){returnCollections.EMPTY_LIST;
if(isNull(style.getName())){thrownewNullPointerException("Stylenamemustnotbenull");
if(isNull(style.getFilename())){thrownewNullPointerException("StylefileNamemustnotbenull");
if(existing!=null&&(isNew||!existing.getId().equals(style.getId()))){//nullworkspacecancausestyleinanyworkspacetobereturned,checkthat//workspacesmatchWorkspaceInfoews=existing.getWorkspace();Stringmsg="Stylenamed'"+style.getName()+"'alreadyexists";
if(ews!=null){msg+="inworkspace"+ews.getName();
if(!isNew){StyleInfocurrent=getStyle(style.getId());//Defaultstylevalidation
if(isDefaultStyle(current)){
if(!current.getName().equals(style.getName())){thrownewIllegalArgumentException("Cannotrenamedefaultstyles");
if(null!=style.getWorkspace()){thrownewIllegalArgumentException("Cannotchangetheworkspaceofdefaultstyles");
if(lg.getStyles().contains(style)||style.equals(lg.getRootLayerStyle())){Stringmsg="Unabletodeletestylereferencedbylayergroup'"+lg.getName()+"'";thrownewIllegalArgumentException(msg);
if(isDefaultStyle(style)){thrownewIllegalArgumentException("Unabletodeleteadefaultstyle");
if(resourcePool!=null)resourcePool.dispose();facade.dispose();
if(eventinstanceofCatalogAddEvent){listener.handleAddEvent((CatalogAddEvent)event);
else
if(eventinstanceofCatalogRemoveEvent){listener.handleRemoveEvent((CatalogRemoveEvent)event);
else
if(eventinstanceofCatalogModifyEvent){listener.handleModifyEvent((CatalogModifyEvent)event);
else
if(eventinstanceofCatalogPostModifyEvent){listener.handlePostModifyEvent((CatalogPostModifyEvent)event);
if(tinstanceofCatalogException&&toThrow==null){toThrow=(CatalogException)t;
else
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,"Cataloglistenerthrewexceptionhandlingevent.",t);
if(toThrow!=null){throwtoThrow;
if(keywords!=null){for(KeywordInfokw:keywords){Matcherm=KeywordInfo.RE.matcher(kw.getValue());
if(!m.matches()){thrownewIllegalArgumentException("Illegalkeyword'"+kw+"'."+"Keywordsmustnotbeemptyandmustnotcontainthe'\\'character");
if(kw.getVocabulary()!=null){m=KeywordInfo.RE.matcher(kw.getVocabulary());
if(!m.matches()){thrownewIllegalArgumentException("Keywordvocbularymustnotcontainthe'\\'character");
if(listeners==null){listeners=newArrayList<CatalogListener>();
if(resourcePool==null){resourcePool=ResourcePool.create(this);
if(resourceinstanceofFeatureTypeInfo){resolve((FeatureTypeInfo)resource);
if(rinstanceofCoverageInfo){resolve((CoverageInfo)resource);
if(rinstanceofWMSLayerInfo){resolve((WMSLayerInfo)resource);
if(rinstanceofWMTSLayerInfo){resolve((WMTSLayerInfo)resource);
if(c.getDimensions()!=null){for(CoverageDimensionInfodim:c.getDimensions()){
if(dim.getNullValues()==null){((CoverageDimensionImpl)dim).setNullValues(newArrayList<Double>());
if(layer.getAttribution()==null){layer.setAttribution(getFactory().createAttribution());
if(!extendedValidation){returnnewValidationResult(null);
if(resourcePool!=other.resourcePool){resourcePool.dispose();resourcePool=other.resourcePool;resourcePool.setCatalog(this);
if(infoinstanceofLayerGroupInfo){resolve((LayerGroupInfo)info);
else
if(infoinstanceofLayerInfo){resolve((LayerInfo)info);
else
if(infoinstanceofMapInfo){resolve((MapInfo)info);
else
if(infoinstanceofNamespaceInfo){resolve((NamespaceInfo)info);
else
if(infoinstanceofResourceInfo){resolve((ResourceInfo)info);
else
if(infoinstanceofStoreInfo){resolve((StoreInfo)info);
else
if(infoinstanceofStyleInfo){resolve((StyleInfo)info);
else
if(infoinstanceofWorkspaceInfo){resolve((WorkspaceInfo)info);
else{thrownewIllegalArgumentException("Unknownresourcetype:"+info);
if(sortOrder!=null&&!facade.canSort(of,sortOrder.getPropertyName().getPropertyName())){//TODO:useGeoTools'merge-sortcodetoprovidesortinganywaysthrownewUnsupportedOperationException("Catalogbackendcan'tsortonproperty"+sortOrder.getPropertyName()+"in-processsortingispendingimplementation");
if(it.hasNext()){result=it.next();
if(it.hasNext()){thrownewIllegalArgumentException("Specifiedquerypredicateresultedinmorethanoneobject");
if(property==ImportTaskProvider.NAME){returnnewLayerLinkPanel(id,itemModel);
if(property==ImportTaskProvider.STATUS){ImportTask.Statestate=(ImportTask.State)property.getModel(itemModel).getObject();Componentc=null;
if(state==ImportTask.State.ERROR){c=newSimpleAjaxLink<ImportTask>(id,itemModel,newStatusDescriptionModel(property.getModel(itemModel))){@OverrideprotectedvoidonClick(AjaxRequestTargettarget){popupWindow.setContent(newExceptionPanel(popupWindow.getContentId(),getModelObject().getError()));popupWindow.show(target);
else{c=newLabel(id,newStatusDescriptionModel(property.getModel(itemModel)));
if(property==ImportTaskProvider.ACTION){ImportTask.Statestate=(ImportTask.State)property.getModel(itemModel).getObject();
switch(state){caseCOMPLETE://linktomappreviewreturnnewLayerPreviewPanel(id,itemModel);caseNO_CRS://providelinktochoosecrsreturnnewNoCRSPanel(id,itemModel);//returncreateFixCRSLink(id,itemModel);caseREADY://returnadvancedoptionlink//fornowdisable
ifthisisnotavectorlayerImportTasktask=(ImportTask)itemModel.getObject();
if(task.getLayer()!=null&&task.getLayer().getResource()instanceofFeatureTypeInfo){returnnewAdvancedOptionPanel(id,itemModel);
switch(state){caseREADY:returnnewPackageResourceReference(GeoServerApplication.class,"img/icons/silk/bullet_go.png");caseRUNNING:returnnewPackageResourceReference(ImportTaskTable.class,"indicator.gif");caseCOMPLETE:returnnewPackageResourceReference(GeoServerApplication.class,"img/icons/silk/accept.png");caseNO_BOUNDS:caseNO_CRS:caseNO_FORMAT:caseBAD_FORMAT:returnnewPackageResourceReference(GeoServerApplication.class,"img/icons/silk/error.png");caseERROR:returnnewPackageResourceReference(GeoServerApplication.class,"img/icons/silk/delete.png");
switch(state){caseREADY:return"apply-link";caseRUNNING:return"working-link";caseCOMPLETE:return"accept-link";caseNO_BOUNDS:caseNO_CRS:caseERROR:caseNO_FORMAT:caseBAD_FORMAT:return"warning-link";//caseERROR://return"error-link";caseCANCELED:return"cancel-link";
if(filter==null){filter=f;
else
if(filterinstanceofAnd){((And)filter).getFilters().add(f);
else{filter=newAnd(filter,f);
if(filter==null){filter=f;
else
if(filterinstanceofOr){((Or)filter).getFilters().add(f);
else{filter=newOr(filter,f);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;TestNotCloneableother=(TestNotCloneable)obj;
if(myState==null){
if(other.myState!=null)returnfalse;
else
if(!myState.equals(other.myState))returnfalse;returntrue;
if(loginTicket==null)thrownewIOException("Nologinticketfor:"+loginUrl.toString());Stringexecution=extractFormParameter(responseString,"\"execution\"");
if(execution==null)thrownewIOException("Nohiddenexecutionfieldfor:"+loginUrl.toString());List<HttpCookie>cookies=getCookies(conn);HttpCookiesessionCookie=getCookieNamed(cookies,"JSESSIONID");StringsessionCookieSend=sessionCookie.toString();Map<String,String>paramMap=newHashMap<String,String>();paramMap.put("username",username);paramMap.put("password",password);paramMap.put("lt",loginTicket);paramMap.put("_eventId","submit");paramMap.put("submit","LOGIN");paramMap.put("execution",execution);conn=(HttpURLConnection)loginUrl.openConnection();conn.setRequestMethod("POST");conn.setDoOutput(true);conn.setDoInput(true);conn.setRequestProperty("Cookie",sessionCookieSend);writeParamsForPostAndSend(conn,paramMap);cookies=getCookies(conn);readResponse(conn);extractCASCookies(cookies,conn);returnticketGrantingCookie!=null&&ticketGrantingCookie.getValue().startsWith("TGT-");
if(workspace!=null){styleName=workspace+"/"+styleName;
if("file".equals(graphicProtocol)){Filefile=URLs.urlToFile(target);Filestyles=null;FilegraphicFile=null;
if(file.isAbsolute()){GeoServerDataDirectorydataDir=(GeoServerDataDirectory)GeoServerExtensions.bean("dataDirectory");//wegrabthecanonicalpathtomakesurewecancomparethem,no//relativepartsinthemandsoonstyles=dataDir.getStyles().dir().getCanonicalFile();file=graphicFile=file.getCanonicalFile();
if(file.getAbsolutePath().startsWith(styles.getAbsolutePath())){//ok,partofthestylesdirectory,extractonlytherelativepathfile=newFile(file.getAbsolutePath().substring(styles.getAbsolutePath().length()+1));
else{//wewont'transformthis,otherdirsarenotpublishedfile=null;
if(file!=null&&styles!=null){returnResponseUtils.buildURL(baseURL,"styles/"+styles.toURI().relativize(graphicFile.toURI()),null,URLType.RESOURCE);
else{//wedon'tknowhowtohandlethisthen...returnnull;
else
if(!("http".equals(graphicProtocol)||"https".equals(graphicProtocol))){returnnull;
if(version.getModelObject()==Version.v1_0_0){sourceGridContainer.setVisible(true);targetlayoutContainer.setVisible(false);manualGrid.setModelObject(false);sourceGridRange.setVisible(false);
else{targetlayoutContainer.setVisible(true);sourceGridContainer.setVisible(false);targetLayoutChooser.setModelObject(TargetLayout.Automatic);g2w.setModelObject(null);g2w.setVisible(false);
if(coverageName!=null){responseWindow.setDefaultModel(newModel(getDescribeXML(coverageName)));responseWindow.show(target);
if(getCoverage.version==Version.v1_0_0){return"<DescribeCoverage\n"+"version=\"1.0.0\"\n"+"service=\"WCS\"\n"+"xmlns=\"http://www.opengis.net/wcs\"\n"+"xmlns:nurc=\"http://www.nurc.nato.int\"\n"+"xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n"+"xsi:schemaLocation=\"http://www.opengis.net/wcshttp://schemas.opengis.net/wcs/1.0.0/describeCoverage.xsd\">\n"+"\n"+"<Coverage>"+getCoverage.coverage+"</Coverage>\n"+"\n"+"</DescribeCoverage>";
else{return"<?xmlversion=\"1.0\"encoding=\"UTF-8\"?>\r\n"+//"<wcs:DescribeCoverageservice=\"WCS\""+//"xmlns:ows=\"http://www.opengis.net/ows/1.1\"\r\n"+//"xmlns:wcs=\"http://www.opengis.net/wcs/1.1.1\"\r\n"+//"xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n"+//"version=\"1.1.1\">\r\n"+//"<wcs:Identifier>"+getCoverage.coverage+"</wcs:Identifier>\r\n"+//"</wcs:DescribeCoverage>";
if(targetLayoutChooser.getModelObject()==TargetLayout.Affine){AffineTransformat=guessGridToWorld(false);g2w.setResolutionModeEnabled(false);g2w.setModelObject(at);g2w.setVisible(true);
else
if(targetLayoutChooser.getModelObject()==TargetLayout.Resolution){AffineTransformat=guessGridToWorld(true);g2w.setResolutionModeEnabled(true);g2w.setModelObject(at);g2w.setVisible(true);
else{g2w.setModelObject(null);g2w.setVisible(false);
if(manualGrid.getModelObject()==Boolean.TRUE){GridEnvelope2Dgrid=guessGridLimits();sourceGridRange.setModelObject(grid);sourceGridRange.setVisible(true);
else{sourceGridRange.setModelObject(null);sourceGridRange.setVisible(false);
if(getCoverage.version==Version.v1_0_0){
if(manualGrid.getModelObject()!=Boolean.TRUE){getCoverage.sourceGridRange=guessGridLimits();
else{
if(targetLayoutChooser.getModelObject()==TargetLayout.Automatic){getCoverage.targetGridToWorld=guessGridToWorld(true);
if(resolutionMode){returnAffineTransform.getScaleInstance(at.getScaleX(),at.getScaleY());
else{returnat;
iftheprocessisstillin-flightStringexecutionId=request.getExecutionId();ExecutionStatusstatus=statusTracker.getStatus(executionId);
if(status==null){thrownewUnknownExecutionIdException(executionId);
if(status.getPhase()==ProcessState.DISMISSING){//pretendwedon'tknowtheprocess,ithasalreadybeencancelled,thespec//saysthatoncecancelledwehavetoactas
iftheprocessneverexistedthrownewUnknownExecutionIdException(executionId);
if(pixData.getElem(i,j)!=0xFF)returnfalse;
if(items==null){//returnanemptylistincasewestilldon'tknowaboutthestore
if(storeId==null)returnnewArrayList<>();//else,grabtheresourcelisttry{List<LayerResource>result;StoreInfostore=getCatalog().getStore(storeId,StoreInfo.class);Map<String,LayerResource>resources=newHashMap<>();WMTSStoreInfowmtsInfo=(WMTSStoreInfo)store;CatalogBuilderbuilder=newCatalogBuilder(getCatalog());builder.setStore(store);List<WMTSLayer>layers=wmtsInfo.getWebMapTileServer(null).getCapabilities().getLayerList();for(Layerl:layers){
if(l.getName()==null){continue;
if(resource!=null)resource.setStatus(LayerStatus.PUBLISHED);
if(i!=-1||geoserver.getService(WFSInfo.class).isCiteCompliant()){returnsuper.parseToken(token);
else{//wedon'thavethenamespace,usethecatalogtolookupthefeaturetype//mind,thisislenientbehaviorsoweuseitonly
iftheserverisnotrunnigincite//modeFeatureTypeInfoftInfo=catalog.getFeatureTypeByName(token);
if(ftInfo==null){returnnewQName(null,token);
else{finalNamename=ftInfo.getFeatureType().getName();returnnewQName(name.getNamespaceURI(),name.getLocalPart());
if(errors!=null&&errors.size()>0)throw(Exception)errors.get(0);returncaseInsensitiveKvp(input);
if(invocation.getMethod().getName().equals("kml")){try{GetMapRequestgetMap=(GetMapRequest)invocation.getArguments()[0];returnKMLReflector.doWms(getMap,webMapService,wms);
if(einstanceofServiceException){throwe;
else{thrownewServiceException(e);
else{returninvocation.proceed();
if(typename!=null){NamespaceSupportnamespaces=(NamespaceSupport)kvp.get("namespace");
if(namespaces==null){//whennullthedefaultistheCSWonenamespaces=CSWRecordDescriptor.NAMESPACES;
if(baseUrl.indexOf("?")>0){intidx=baseUrl.indexOf("?");queryString=baseUrl.substring(idx);//includequestionmarkbaseUrl=baseUrl.substring(0,idx);//leaveoutquestionmark
if(LocalPublished.get()!=null){servicePath=LocalPublished.get().getName()+"/"+servicePath;
if(LocalWorkspace.get()!=null){servicePath=LocalWorkspace.get().getName()+"/"+servicePath;
if(queryString!=null){servicePath+=queryString;
if(mapContent.layers().size()==1){map.put("layerName",mapContent.layers().get(0).getTitle());
else{map.put("layerName","Geoserverlayers");
if(!code.contains("EPSG:")){code="EPGS:"+code;
ifthemapcontextismadeonlyofcoveragelayersbylookingatthewrappingfeature*type.Ugly,
ifyoucomeupwithbettermeansofdoingso,fixit.**@parammapContent*/privatebooleanhasOnlyCoverages(WMSMapContentmapContent){for(Layerlayer:mapContent.layers()){FeatureTypeschema=layer.getFeatureSource().getSchema();booleangrid=schema.getName().getLocalPart().equals("GridCoverage")&&schema.getDescriptor("geom")!=null&&schema.getDescriptor("grid")!=null&&!(layerinstanceofWMSLayer)&&!(layerinstanceofWMTSMapLayer);
if(!grid)returnfalse;
iffilteringsupportshouldbeactivated.**<p>Ifthemapcontainsatleastonelayerthatisqueryable,filteringshouldbeactivated.*/privatebooleansupportsFiltering(WMSMapContentmapContent){//returnsTRUE
ifatleastonelayersupportsfilteringreturnmapContent.layers().stream().anyMatch(layer->{
if(layerinstanceofFeatureLayer){//vectorlayerssupportfilteringreturntrue;
if(!(layerinstanceofGridReaderLayer)){//filteringisnotsupportfortheremainingtypesreturnfalse;
ifthiscoveragetypesupportsfilteringGeneralParameterValue[]readParams=((GridReaderLayer)layer).getParams();
if(readParams==null||readParams.length==0){//filteringisnotsupportedreturnfalse;
if(readParam.getDescriptor().getName().getCode().equalsIgnoreCase("FILTER")){//thereaderofthislayersupportsfilteringreturntrue;
if(mapContent.layers().size()!=1||mapContent.getRequest()==null)returnCollections.emptyList();MapLayerInfoinfo=mapContent.getRequest().getLayers().get(0);returninfo.getOtherStyleNames();
if(ignoredParameters.contains(paramName.toUpperCase())){continue;
if(!exceptionsFound){Map<String,String>map=newHashMap<>();map.put("name","exceptions");map.put("value","application/vnd.ogc.se_inimage");result.add(map);
if(baseUrl.endsWith("/")){returnbaseUrl.substring(0,baseUrl.length()-1);
else{returnbaseUrl;
if(!endpoint.endsWith("/")){endpoint=endpoint+"/";
if(request.getParameterName()!=null&&!request.getParameterName().isEmpty()){StringparameterName=request.getParameterName();
if(parameterName.indexOf(".")>0){finalStringoperation=parameterName.split("\\.")[0];finalStringparameter=parameterName.split("\\.")[1];
if(GetCapabilities.operationParameters.get(operation)!=null){for(DomainTypeparam:GetCapabilities.operationParameters.get(operation)){
if(param.getName().equalsIgnoreCase(parameter)){for(Objectvalue:param.getValue()){result.add((String)value);
if(request.getPropertyName()!=null&&!request.getPropertyName().isEmpty()){finalStringpropertyName=request.getPropertyName();StringnameSpace="";StringlocalPart=null;
if(propertyName.indexOf(":")>0){nameSpace=propertyName.split(":")[0];localPart=propertyName.split(":")[1];
else{
if(propertyName.equalsIgnoreCase("anyText")){nameSpace=ns.getURI("csw");
if(typeName!=null){returnthis.store.getDomain(typeName,attName);
if(Placemark.class.isAssignableFrom(featureClass)&&context.isDescriptionEnabled()){returnnewPlacemarkNameDecorator();
else{returnnull;
ifwegotnothing,setthetitletotheID,butalsotrythetextsymbolizersStringfeatureId=sf.getID();
if(title==null||"".equals(title)||featureId.equals(title)){title=featureId;//see
ifwecandobetterwithatextsymbolizer//symbolizersareavailableonlyinwmsmode
if(context.getCurrentSymbolizers()!=null){StringBufferlabel=newStringBuffer();for(Symbolizersym:context.getCurrentSymbolizers()){
if(syminstanceofTextSymbolizer){Expressione=SLD.textLabel((TextSymbolizer)sym);Stringvalue=e.evaluate(sf,String.class);
if((value!=null)&&!"".equals(value.trim())){label.append(value);
if(label.length()>0){title=label.toString();
if(authentication!=null){SecurityContextHolder.getContext().setAuthentication(authentication);
if(!isNew){tag.put("readonly","readonly");
if(getEnableRedirectAuthenticationEntryPoint()||request.getRequestURI().endsWith(getLoginEndpoint())){response.sendRedirect(loginUri.toString());
if(request.getValueReference()==null){thrownewWFSException(request,"NovalueReferencespecified","MissingParameterValue").locator("valueReference");
else
if("".equals(request.getValueReference().trim())){thrownewWFSException(request,"ValueReferencecannotbeempty",ServiceException.INVALID_PARAMETER_VALUE).locator("valueReference");
if(descriptor==null&&!featureIdRequest){thrownewWFSException(request,"Nosuchattribute:"+request.getValueReference());
if(objTypeNameinstanceofArrayList){QNamename=(QName)((ArrayList)objTypeName).get(0);cr.setTypeName(name);
if(input!=null&&!input.equals("")){file=newFile(input);
ifthispanelcouldgo*intotheDimensiontab,buttherearenoextensionpointsthere.*/publicclassMultiDimLayerPanelextendsPublishedConfigurationPanel<LayerInfo>{publicMultiDimLayerPanel(Stringid,IModel<?extendsLayerInfo>model){super(id,model);MapModelexpandLimitDefaultModel=newMapModel(newPropertyModel<MetadataMap>(model,"resource.metadata"),MultiDimensionalExtension.EXPAND_LIMIT_KEY);TextField<Integer>expandLimitDefault=newTextField<>("defaultExpandLimit",expandLimitDefaultModel,Integer.class);expandLimitDefault.add(RangeValidator.minimum(0));add(expandLimitDefault);MapModelexpandLimitMaxModel=newMapModel(newPropertyModel<MetadataMap>(model,"resource.metadata"),MultiDimensionalExtension.EXPAND_LIMIT_MAX_KEY);TextField<Integer>expandLimitMax=newTextField<>("maxExpandLimit",expandLimitMaxModel,Integer.class);expandLimitMax.add(RangeValidator.minimum(0));add(expandLimitMax);}}
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("AbouttowriteaJPEGimage.");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("WritingaJPEGdone!!!");
if(dataDirectory.canWrite()){//makesurewehaveaWEB-INFdirectorynewFile(dataDirectory,"WEB-INF").mkdirs();loader=newDirectoryResourceLoader(dataDirectory);
else{//usethedefaultloaderloader=newDefaultResourceLoader();
if(dsi==null){getSession().error(newParamResourceModel("DataAccessEditPage.notFound",this,wsName,storeName).getString());doReturn(StorePage.class);return;
if(null==dataStoreInfo){thrownewIllegalArgumentException("DataStore"+dataStoreInfoId+"notfound");
if(dataStoreInfo.getId()!=null){//nullidmeansdetachedfromcatalog,don'tbotherwithuniquenesscheckfinalStringwsId=dataStoreInfo.getWorkspace().getId();workspacePanel.getFormComponent().add(newCheckExistingResourcesInWorkspaceValidator(dataStoreInfo.getId(),wsId));
if(!storeEditPanel.onSave()){return;
if(info.isEnabled()){//store'senabled,checkavailabilityDataAccess<?extendsFeatureType,?extendsFeature>dataStore;try{dataStore=catalog.getResourcePool().getDataStore(info);LOGGER.finer("connectionparametersverifiedforstore"+info.getName()+".Gota"+dataStore.getClass().getName());doSaveStore(info);doReturn(StorePage.class);
else{//store'sdisabled,noneedtochecktheconnectionparametersdoSaveStore(info);doReturn(StorePage.class);
if(message==null&&error.getCause()!=null){message=error.getCause().getMessage();
if(accepted){doReturn(StorePage.class);
if(node.hasAttribute("handle")){deleteElement.setHandle((String)node.getAttributeValue("handle"));
if(name.contains("WindowClosedBehavior")){tester.executeBehavior((AbstractAjaxBehavior)b);
if(requestTarget==null||!(GeoServerSecuredPage.class.isAssignableFrom(requestTarget)||GeoServerHomePage.class.isAssignableFrom(requestTarget))){AdminRequest.abort();
ifinfinitetimeout.*/doublegetConnectionTimeout();/***Setstheconnectiontimeout(inseconds)tobeusedinWPSexecuterequests.-1forinfinite*timeout*/voidsetConnectionTimeout(doubletimeout);/***Returnstheresourceexpirationtimeout(inseconds).Temporaryresourcessuchasstored*Executeresponsesandoutputstoredasreferencewillbedeletedafterthistimeout*/intgetResourceExpirationTimeout();/***Setstheresourceexpirationtimeout.**@paramresourceExpirationTimeout*/voidsetResourceExpirationTimeout(intresourceExpirationTimeout);/***Returnsthemaximumnumberofprocessesthatcanruninsynchronousmodeinparallel.*DefaultstothenumberofavailableCPUcores*/publicintgetMaxSynchronousProcesses();/**Setsthemaximumnumberofprocessesthatcanruninsynchronousmodeinparallel.*/publicvoidsetMaxSynchronousProcesses(intmaxSynchronousProcesses);/***Returnsthemaximumnumberofprocessesthatcanruninasynchronousmodeinparallel.*DefaultstothenumberofavailableCPUcores*/publicintgetMaxAsynchronousProcesses();/***Setsthemaximumnumberofprocessesthatcanruninasynchronousmodeinparallel.**@parammaxAsynchronousProcesses*/publicvoidsetMaxAsynchronousProcesses(intmaxAsynchronousProcesses);/**Retrievestheprocessgroupsconfigurations*/publicList<ProcessGroupInfo>getProcessGroups();/**Getsthecurrentoutputstoragedirectory*/publicStringgetStorageDirectory();/***Setstheoutputstoragedirectory,thatis,thedirectoryusedtostoretherequest,status*andfinalresponseofasynchrequests,aswellasanyoutputthatismeanttobereferredto*byURLinsteadofbeingincludedinlineinExecutetheresponse.**@paramstorageDirectory*/publicvoidsetStorageDirectory(StringstorageDirectory);/***Controlshowtheserverallowsaccesstosecuredprocesses,inasimilarwaytohowthe*catalogcontrolsaccesstosecuredlayers*/publicCatalogModegetCatalogMode();/**Setsthepolicytocontrolaccesstosecuredprocesses*/publicvoidsetCatalogMode(CatalogModecatalogMode);/***Returnstheglobalmaximumsizeofacomplexinput,inMB.Perprocessconfigurationcan*overrideit.Zerooranegativenumbermeansnolimit.*/publicintgetMaxComplexInputSize();/***Setstheglobalmaximumsizeofacomplexinput,inMB.Perprocessconfigurationcan*overrideit.Zerooranegativenumbermeansnolimit.*/publicvoidsetMaxComplexInputSize(intmaxInputSizeMB);/***Howmanysecondsaprocesscanruninasynchronousmode(withtheuserpollingforits*status)beforeitgetskilledbytheWPScontainer(0oranegativevaluemeansnolimit)*/publicabstractintgetMaxAsynchronousExecutionTime();/***Howmanysecondsaprocesscanrunorqueueinasynchronousmode(withtheuserpollingfor*itsstatus)beforeitgetskilledbytheWPScontainer(0oranegativevaluemeansnolimit)*/publicabstractIntegergetMaxAsynchronousTotalTime();/***Setshowmanysecondsaprocesscanruninasynchronousmode(withtheuserpollingforits*status)beforeitgetskilledbytheWPScontainer(0oranegativevaluemeansnolimit)*/publicabstractvoidsetMaxAsynchronousExecutionTime(intmaxAsynchronousExecutionTime);/***Setshowmanysecondsaprocesscanrunorqueueinasynchronousmode(withtheuserpolling*foritsstatus)beforeitgetskilledbytheWPScontainer(0oranegativevaluemeansno*limit)*/publicabstractvoidsetMaxAsynchronousTotalTime(IntegermaxAsynchronousTotalTime);/***Howmanysecondsaprocesscanruninsynchronousmode(withtheuserwaitingontheHTTP*connection)beforeitgetskilledbytheWPScontainer(0oranegativevaluemeansnolimit)*/publicabstractintgetMaxSynchronousExecutionTime();/***Howmanysecondsaprocesscanrunorqueueinsynchronousmode(withtheuserwaitingonthe*HTTPconnection)beforeitgetskilledbytheWPScontainer(0oranegativevaluemeansno*limit)*/publicabstractIntegergetMaxSynchronousTotalTime();/***Setshowmanysecondsaprocesscanruninsynchronousmode(withtheuserwaitingonthe*HTTPconnection)beforeitgetskilledbytheWPScontainer(0oranegativevaluemeansno*limit)*/publicabstractvoidsetMaxSynchronousExecutionTime(intmaxSynchronousExecutionTime);/***Setshowmanysecondsaprocesscanrunorqueueinsynchronousmode(withtheuserwaiting*ontheHTTPconnection)beforeitgetskilledbytheWPScontainer(0oranegativevalue*meansnolimit)*/publicabstractvoidsetMaxSynchronousTotalTime(IntegermaxSynchronousTotalTime);}
if(split.length==2){returnsplit[1];
if(split.length==2){returnsplit[0];
if(schema==null){returntableName;
else{returnschema+"."+tableName;
if(useAA){graphics.setRenderingHint(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_ON);
else{graphics.setRenderingHint(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_OFF);
ifthisonemaybecalledonlyonce,or*
ifthecodeshouldmakeitpossibletoextractthestreammultipletimes**@throwsFileNotFoundException*/publicInputStreamgetInputStream()throwsIOException;/**Optionalfieldforoutputrawdata,usedbyWPStogenerateafileextension*/publicStringgetFileExtension();}
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("UnabletoreturnaRenderedImageforaGranuleStackwhichismadeofdifferentcoverages:returningnull");
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
ifthereturnedserviceinfois{@link*ServiceInfo#isEnabled()enabled}(andhenceavoidtheWARNINGmessageitspitsout
ifthis*methodisnotfound);notthough,thatintheinterestofkeepingasingle{@link*GwcServiceProxy}toproxyallgwcprovidedservices(wmts,tms,etc),theserviceinfo*returnedherewillalwaysbeenabled,wealreadyhaveaGWC{@link*GWCServiceEnablementInterceptorserviceinterceptor}aspectthatdecoratesspecificgwc*servicestocheckforenablement.*/publicServiceInfogetServiceInfo(){returnserviceInfo;
if(params.length<4){returnCollections.emptyMap();
if(lsf.length>=3){parsed.put("gridSetId",lsf[1]);
ifyourmodelneeds*tobelocalizedandyoudon'thaveaccesstoaComponentinstance.Usewithcare,inmost*casesyoushouldbeabletolocalizeyourmessagesdirectlyinpagesorcomponents.**@paramkey*@parammodel*@paramparams*/publicstaticStringlocalize(Stringkey,IModel<?>model,Object...params){StringResourceModelrm=newStringResourceModel(key,(Component)null){privatestaticfinallongserialVersionUID=7276431319922312811L;@OverridepublicLocalizergetLocalizer(){returnGeoServerApplication.get().getResourceSettings().getLocalizer();
if(source!=null){longmodified=cfg.getTemplateLoader().getLastModified(source);returnTime.valueOf(newDate(modified));
ifvirtualservicesare*active)**@authorJustinDeOliveira*/publicclassLocalWorkspaceCatalogFilterextendsAbstractCatalogFilter{/**thereal/rawcatalog,can'tbeawrapper*/Catalogcatalog;publicLocalWorkspaceCatalogFilter(Catalogcatalog){//unwrapitjusttobesurewhile(cataloginstanceofWrapper&&((Wrapper)catalog).isWrapperFor(Catalog.class)){Catalogunwrapped=((Wrapper)catalog).unwrap(Catalog.class);
if(unwrapped==catalog||unwrapped==null){break;
if(local==null){returnfalse;
else
if(localinstanceofLayerInfo){return!local.equals(layer);
else
if(localinstanceofLayerGroupInfo){LayerGroupInfolg=(LayerGroupInfo)local;Requestrequest=Dispatcher.REQUEST.get();
if(request!=null&&"WMS".equalsIgnoreCase(request.getService())&&"GetCapabilities".equals(request.getRequest())&&lg.getMode()==Mode.SINGLE){returntrue;
else{return!newLayerGroupHelper(lg).allLayers().contains(layer);
else{thrownewRuntimeException("UnknownPublishedInfooftype"+local.getClass());
if(LocalPublished.get()!=null){for(LayerInfol:resource.getCatalog().getLayers(resource)){
if(hideLayer(l)){returntrue;
if(style.getWorkspace()==null){//globalstyle,hideit
ifalocalworkspacestylesharsthesamename,ieoverridesit
if(LocalWorkspace.get()!=null){
if(catalog.getStyleByName(LocalWorkspace.get(),style.getName())!=null){returntrue;
if(groupInherit==null){//JustsetsitbasedonthepropertysononeedtosynchronizeStringvalue=GeoServerExtensions.getProperty("GEOSERVER_GLOBAL_LAYER_GROUP_INHERIT");
if(value!=null){groupInherit=Boolean.parseBoolean(value);
else{//Localworkspacesinheritgloballayergroupsbydefault.groupInherit=true;
if(local!=null){
if(localinstanceofLayerGroupInfo){LayerGroupInfolg=(LayerGroupInfo)local;Requestrequest=Dispatcher.REQUEST.get();
if(request!=null&&"WMS".equalsIgnoreCase(request.getService())&&"GetCapabilities".equals(request.getRequest())&&lg.getMode()==Mode.SINGLE){return!lg.equals(layerGroup);
else
if(!lg.equals(layerGroup)&&!newLayerGroupHelper(lg).allGroups().contains(layerGroup)){returntrue;
else{//simplelayer,notalayergroupreturntrue;
if(layerGroup.getWorkspace()==null){
if(workspaceLayerGroupInherit()){//globallayergroup,hideit
ifalocalworkspacelayergroupsharedthesame//name,ie//overridesit
if(LocalWorkspace.get()!=null){
if(catalog.getLayerGroupByName(LocalWorkspace.get(),layerGroup.getName())!=null){returntrue;
else{//Onlyshowagloballayergroupintheglobalworkspace.returnLocalWorkspace.get()!=null;
ifthesublayersofalayergroupareallhidden.**@paramlayerGroup*/protectedbooleansubLayersHidden(LayerGroupInfolayerGroup){booleananySublayersVisible=false;for(PublishedInfosubLayer:layerGroup.getLayers()){
if(subLayerinstanceofLayerInfo){
if(!hideLayer((LayerInfo)subLayer)){anySublayersVisible=true;break;
else
if(subLayerinstanceofLayerGroupInfo){
if(!hideLayerGroup((LayerGroupInfo)subLayer)){anySublayersVisible=true;break;
if(localWS==null)returnPredicates.acceptAll();returnPredicates.equal("workspace.id",localWS.getId());
if(LocalWorkspace.get()!=null){//TODOneedawellknownimplementation//ShowglobalsunlessanobjectwiththesamenameisinthelocalworkspaceforGlobal=super.getSecurityFilter(clazz);
else{//Globalrequest,showallglobalsforGlobal=Predicates.acceptAll();
ifit'sinthelocalworkspacereturnPredicates.or(Predicates.and(Predicates.isNull("workspace.id"),forGlobal),Predicates.and(Predicates.factory.not(Predicates.isNull("workspace.id")),inWorkspace()));
if(localWS==null&&localPublished==null){returnPredicates.acceptAll();
if(ResourceInfo.class.isAssignableFrom(clazz)){//Show
ifit'sinavisibleworkspaceorusedbythelocallayerFilterlocalLayerFilter;
if(localPublished==null){localLayerFilter=Predicates.acceptAll();
else{//TODOWellknowncheck
ifit'susedbythelocallayerreturnsuper.getSecurityFilter(clazz);
else
if(WorkspaceInfo.class.isAssignableFrom(clazz)){//Show
ifthere'snolocalworkspaceor
ifitisthelocalworkspace
if(localWS==null)returnPredicates.acceptAll();returnPredicates.equal("id",localWS.getId());
else
if(LayerGroupInfo.class.isAssignableFrom(clazz)){Filterfilter=standardFilter(clazz);//Onlyshowalayergroupinalayerlocalrequest
ifitisthelocallayer
if(localPublished!=null){
if(localPublishedinstanceofLayerInfo){//TODONeedawellknownrecursivefilterforlayergroupsinsteadofusingan//InternalVolatileFunction,KSFunctionsubLayersHidden=newInternalVolatileFunction(){@OverridepublicBooleanevaluate(Objectobject){return!subLayersHidden((LayerGroupInfo)object);
ifitssublayersarehiddenfilter=Predicates.and(filter,factory.equals(factory.literal(Boolean.TRUE),subLayersHidden));Predicates.and(filter,Predicates.equal("id",localPublished.getId()));
else
if(localPublishedinstanceofLayerGroupInfo){LayerGroupInfolg=(LayerGroupInfo)localPublished;List<LayerGroupInfo>groups=newLayerGroupHelper(lg).allGroups();List<Filter>groupIdFilters=newArrayList<>();for(LayerGroupInfogroup:groups){groupIdFilters.add(Predicates.equal("id",group.getId()));
else
if(StyleInfo.class.isAssignableFrom(clazz)){returnstandardFilter(clazz);
else
if(LayerInfo.class.isAssignableFrom(clazz)){//Ifthere'salocalLayer,onlyshowthatlayer,otherwiseshowall.
if(localPublished==null){returnPredicates.acceptAll();
else
if(localPublishedinstanceofLayerInfo){returnPredicates.equal("id",localPublished.getId());
else
if(localPublishedinstanceofLayerGroupInfo){LayerGroupInfolg=(LayerGroupInfo)localPublished;Requestrequest=Dispatcher.REQUEST.get();
if(request!=null&&"WMS".equalsIgnoreCase(request.getService())&&"GetCapabilities".equals(request.getRequest())&&lg.getMode()==Mode.SINGLE){//wmsGetCapabilieswithagroupin"single"mode,meaningthelayersarealso//showingupstandalone//butweonlyaskedforthegroup,sodon'tacceptanysub-layerreturnPredicates.acceptNone();
else{//notaWMScapabilitiesornota"single"modelayergroup,allowanylayerin//thegroup,List<LayerInfo>layers=newLayerGroupHelper(lg).allLayers();List<Filter>layersIdFilters=newArrayList<>();for(LayerInfolayer:layers){layersIdFilters.add(Predicates.equal("id",layer.getId()));
else{thrownewRuntimeException("Unexpectedlocalpublishedreferenceoftype"+localPublished.getClass());
else
if(NamespaceInfo.class.isAssignableFrom(clazz)){//TODOreturnsuper.getSecurityFilter(clazz);
else{returnsuper.getSecurityFilter(clazz);
if(getPage()instanceofGeoServerBasePage){((GeoServerBasePage)getPage()).addFeedbackPanels(target);
if(config.isInternal()){return(RuleReaderService)GeoServerExtensions.bean("ruleReaderService");
else{HttpInvokerProxyFactoryBeaninvoker=neworg.springframework.remoting.httpinvoker.HttpInvokerProxyFactoryBean();invoker.setServiceUrl(servicesUrl);invoker.setServiceInterface(RuleReaderService.class);invoker.afterPropertiesSet();return(RuleReaderService)invoker.getObject();
if(getPage()instanceofGeoServerBasePage){((GeoServerBasePage)getPage()).addFeedbackPanels(target);
if(any==null){any=newArrayList<Object>();
if(obj==null)return"";
elsereturn((LayerInfo)obj).prefixedName();}}
if(String.class.isAssignableFrom(scopeAsObject.getClass())){StringscopeAsString=(String)scopeAsObject;Collections.addAll(scope,scopeAsString.split(""));
else
if(Collection.class.isAssignableFrom(scopeAsObject.getClass())){Collection<String>scopes=(Collection<String>)scopeAsObject;scope.addAll(scopes);
if(value==null){thrownewIllegalArgumentException("Unabletolookupenumvaluefromnull");
if(wrapped==null)thrownewNullPointerException("Livelistmodelcannotwrapanullmodel");this.wrapped=wrapped;
if(object!=null){collection.addAll(object);
if(ext.isEnabled()){remoteClient=ext;remoteClient.init();
if(remoteClient.isEnabled()){remoteClient.registerProcessFactoryListener(this);break;
ifa{@linkRemoteProcess}stubhasbeenalreadyregistered*/booleancheckName(Namename){
if(name==null)thrownewNullPointerException("Processnamecannotbenull");
if(!descriptors.containsKey(name)){LOGGER.warning("Unknownprocess'"+name+"'");returnfalse;
if(registeredService.getLocalPart().equalsIgnoreCase((name.getLocalPart()))){returntrue;
if(checkName(name)){try{RemoteProcessprocess=newRemoteProcess(name,remoteClient,descriptors.get(name).getMetadata());remoteInstances.put(name,process);returnprocess;
if(checkName(name))returnText.text(descriptors.get(name).getDescription());returnnull;
if(checkName(name))returnText.text(descriptors.get(name).getTitle());returnnull;
if(checkName(name)){returnname.getLocalPart();
if(checkName(name))returndescriptors.get(name).getParamInfo();returnnull;
if(checkName(name))returndescriptors.get(name).getOutputInfo();returnnull;
if(descriptors.containsKey(name)){LOGGER.warning("Service"+name+"alreadyregistered!");return;
if(checkName(name)){descriptors.remove(name);remoteInstances.remove(name);LOGGER.info("DeregisteredService["+name+"]");
ifyouneedadifferentbaseclass**@authorAndreaAime-GeoSolutions*/publicabstractclassAbstractCatalogFilterimplementsCatalogFilter{privatestaticLoggerLOGGER=org.geotools.util.logging.Logging.getLogger(AbstractCatalogFilter.class);@OverridepublicbooleanhideLayer(LayerInfolayer){returnfalse;
if(ResourceInfo.class.isAssignableFrom(clazz)){visible=newInternalVolatileFunction(){@OverridepublicBooleanevaluate(Objectobject){return!hideResource((ResourceInfo)object);
else
if(WorkspaceInfo.class.isAssignableFrom(clazz)){visible=newInternalVolatileFunction(){@OverridepublicBooleanevaluate(Objectobject){return!hideWorkspace((WorkspaceInfo)object);
else
if(LayerGroupInfo.class.isAssignableFrom(clazz)){visible=newInternalVolatileFunction(){@OverridepublicBooleanevaluate(Objectobject){return!hideLayerGroup((LayerGroupInfo)object);
else
if(StyleInfo.class.isAssignableFrom(clazz)){visible=newInternalVolatileFunction(){@OverridepublicBooleanevaluate(Objectobject){return!hideStyle((StyleInfo)object);
else
if(LayerInfo.class.isAssignableFrom(clazz)){visible=newInternalVolatileFunction(){@OverridepublicBooleanevaluate(Objectobject){return!hideLayer((LayerInfo)object);
else
if(NamespaceInfo.class.isAssignableFrom(clazz)){visible=newInternalVolatileFunction(){@OverridepublicBooleanevaluate(Objectobject){WorkspaceInfowsInfo=getCatalog().getWorkspaceByName(((NamespaceInfo)object).getPrefix());return!hideWorkspace(wsInfo);
else{LOGGER.log(Level.FINE,"CatalogFilterdoesnotrecognizeinterface{0}acceptingall.",clazz);returnPredicates.acceptAll();
ifitcontainssampleToGeophisicsandtheRangecontainsthefirstnodatadefinedassertEquals(category.getRange().getMinimum(),noData1,DELTA);assertEquals(category.getRange().getMaximum(),noData1,DELTA);
ifitcontainssampleToGeophisicsandtheRangecontainsthefirstnodatadefinedassertEquals(category.getRange().getMinimum(),noData1,DELTA);assertEquals(category.getRange().getMaximum(),noData1,DELTA);
ifnorangeisdefined,CategoryvaluesorDefaultvaluesareused**@throwsIOException*/@TestpublicvoidtestNoRange()throwsIOException{GridSampleDimensionsampleDim=newGridSampleDimension("original",SampleDimensionType.REAL_64BITS,ColorInterpretation.GRAY_INDEX,null,null,newdouble[]{-9999.0},-1000d,1000d,1d,0d,null);//SettingcoveragedimensionfinalCoverageDimensionImplcoverageDim=newCoverageDimensionImpl();finalStringwrappedName="wrapped";coverageDim.setName(wrappedName);coverageDim.setDimensionType(SampleDimensionType.REAL_64BITS);//CreationoftheWrappedSampleDimensionSampleDimensionwrappedDim=WrappedSampleDimension.build(sampleDim,coverageDim);//GettherangeNumberRange<?extendsNumber>wrappedRange=((WrappedSampleDimension)wrappedDim).getRange();//EnsuretherangeisnotpresentassertNull(wrappedRange);//Check
ifminandmaxaretakenfromthecategoriesassertEquals(-9999,wrappedDim.getMinimumValue(),DELTA);assertEquals(1000,wrappedDim.getMaximumValue(),DELTA);//CheckthatthedescriptionisequaltothesampledimensionnameassertEquals(wrappedName,wrappedDim.getDescription().toString());//ConfigureanewGridSampleDimensionwithoutcategoriessampleDim=newGridSampleDimension("original",null,newBaseUnit<Dimensionless>("test"));//NewwrappedsampledimensionwrappedDim=WrappedSampleDimension.build(sampleDim,coverageDim);//GettherangewrappedRange=((WrappedSampleDimension)wrappedDim).getRange();//EnsuretherangeisnotpresentassertNull(wrappedRange);//Check
ifminandmaxaretakenfromthecategoriesassertEquals(Double.NEGATIVE_INFINITY,wrappedDim.getMinimumValue(),DELTA);assertEquals(Double.POSITIVE_INFINITY,wrappedDim.getMaximumValue(),DELTA);}}
if(gotType){return;
if(localName.equals("GetCapabilities")){//this.requestType=Dispatcher.GET_CAPABILITIES_REQUEST;//
else
if(localName.equals("DescribeFeatureType")){//this.requestType=Dispatcher.DESCRIBE_FEATURE_TYPE_REQUEST;//
else
if(localName.equals("GetFeature")){//this.requestType=Dispatcher.GET_FEATURE_REQUEST;//
else
if(localName.equals("Transaction")){//this.requestType=Dispatcher.TRANSACTION_REQUEST;//
else
if(localName.equals("GetFeatureWithLock")){//this.requestType=Dispatcher.GET_FEATURE_LOCK_REQUEST;//
else
if(localName.equals("LockFeature")){//this.requestType=Dispatcher.LOCK_REQUEST;//
else
if(localName.equals("GetMap")){//this.requestType=Dispatcher.GET_MAP_REQUEST;//
else
if(localName.equals("GetFeatureInfo")){//this.requestType=Dispatcher.GET_FEATURE_INFO_REQUEST;//
else{//this.requestType=Dispatcher.UNKNOWN;//
if(atts.getLocalName(i).equals("service")){this.service=atts.getValue(i);//JD:killthis//
if(service.equals("WFS")){//this.serviceType=Dispatcher.WFS_SERVICE;//
else
if(service.equals("WMS")){//this.serviceType=Dispatcher.WMS_SERVICE;//
else{//this.serviceType=Dispatcher.UNKNOWN;
if(rules>0){assertThat(result.getBody(),notNullValue());assertThat(result.getBody().getRules().size(),is(rules));
else{assertThat(result.getBody(),nullValue());
if(index<0){thrownewException("FeatureType"+featureType.getName()+"doesnothaveattributenamed'"+field+"'");
if(url==null&&!reqPath.startsWith("/")){url=clazz.getResource("/");
if(url==null&&(reqPath.length()>1)&&reqPath.startsWith("/")){url=clazz.getResource(reqPath.substring(1));
ifsuchisthecase,*thismethodshallreturnthemodeltobepassedtothe{@linkStyleEditTabPanel}constructor.**<p>Thisdefaultimplementationjustreturns{@codenull}andassumesthe{@link*StyleEditTabPanel}describedbythistabpanelinfoworksagainstthe{@link*AbstractStylePage}StyleInfomodel.Subclassesmayoverrideasappropriate.**@parammodel*@paramisNew*@return{@codenull}
ifnoneedforacustommodelforthetab,themodeltouseotherwise*@seeStyleEditTabPanel#save()*/publicIModel<?>createOwnModel(IModel<?extendsStyleInfo>model,booleanisNew){returnnull;}}
if(operationName.equals(op.getName())){returnop;
if(result==null){thrownewIllegalArgumentException("Couldnotfindparameter"+parameterName);
else{returnresult;
if(parameterName.equals(dt.getName())){returndt;
if(request.getLockId()!=null){lockFeature.refresh(request.getLockId(),true);LockFeatureResponseresponse=requestWrapper.createResponse();response.setLockId(request.getLockId());return(LockFeatureResponseType)response.getAdaptee();
else{//NeedtoperformsomeofthesameStoredQueryhandlingasGetFeature//...expandeventualstoredqueriesbooleangetFeatureById=GetFeature.expandStoredQueries(requestWrapper,request.getAbstractQueryExpression(),getStoredQueryProvider());//...expandthetypenamesfromfeatureidfilters(thewrapperswillmodifythe//underlyingobjectList<Query>queries=GetFeatureRequest.WFS20.getQueries(request.getAbstractQueryExpression());GetFeature.expandTypeNames(requestWrapper,queries,getFeatureById,getCatalog());//...lockcannothandlequerieswithmultipletargettypenames,needtoexpandthem//intoseparatequeriesfixQueriesForLock(request.getAbstractQueryExpression());//runthelockreturn(LockFeatureResponseType)lockFeature.lockFeature(requestWrapper).getAdaptee();
if(objinstanceofQueryType){QueryTypequery=(QueryType)queries.get(0);
if(query.getTypeNames().size()>1){List<QueryType>expanded=newArrayList<>();for(ObjecttypeName:query.getTypeNames()){QueryTypecopy=EcoreUtil.copy(query);copy.getTypeNames().clear();copy.getTypeNames().add(typeName);expanded.add(copy);
if(renderedMessages==null){fail(String.format("feedbackpanelatpath[%s]returnednullmessages",path));
if(numberOfMessages!=renderedMessages.size()){fail(String.format("youexpected'%d'messagesforthefeedbackpanel[%s],buttherewereactually'%d'",numberOfMessages,path,renderedMessages.size()));
if(actual.getMessage().toString().contains(partOfMessage)){found=true;break;
if(!found){fail("Missingexpectedfeedbackmessage:"+partOfMessage);
iftheoriginalrequestedresulttypewas"index"See{@link*IndexResultTypeDispatcherCallback}**@authorsandr*/publicclassIndexOutputFormatextendsHitsOutputFormat{privatestaticfinalLoggerLOGGER=Logging.getLogger(IndexOutputFormat.class);privateStringresultSetId;privateRequestrequest;privateIndexConfigurationManagerindexConfiguration;publicIndexOutputFormat(GeoServergs,IndexConfigurationManagerindexConfiguration){super(gs);this.indexConfiguration=indexConfiguration;
if(kvp.containsKey("POST_REQUEST")){data.setPostRequest((String)kvp.get("POST_REQUEST"));
if(nodes.getLength()!=1){//onlyonenodeshouldexists,let'sloganwarninganmoveonLOGGER.warning("Nofeaturecollectionelementcouldbefound,resultSetIDattributewillnotbeadded.");return;
if(node.getNodeType()==Node.ELEMENT_NODE){//thefoundnodeisaXMLelementsolet'saddtheresultSetIDattributeElementelement=(Element)node;element.setAttribute("resultSetID",resultSetId);
else{//unlikelybutwegotaXMLnodethatisnotaXMLelementLOGGER.warning("FeaturecollectionnodeisnotaXMLelement,resultSetIDattributewillnotbeadded.");
if(scriptMgr!=null){returnscriptMgr;
if(responseHeaders==null||responseHeaders.size()==0){returnnull;
ifansrsNameissetforthisgeometry,putitinthecontextfor//children,sotheycanuseitaswell
if(node.hasAttribute("srsName")){try{CoordinateReferenceSystemcrs=GML2ParsingUtils.crs(node);
if(crs!=null){context.registerComponentInstance(CoordinateReferenceSystem.class,crs);
if(node.hasAttribute("handle")){updateElement.setHandle((String)node.getAttributeValue("handle"));
if(node.hasAttribute("inputFormat")){updateElement.setInputFormat((String)node.getAttributeValue("inputFormat"));
if(node.hasAttribute("srsName")){updateElement.setSrsName((URI)node.getAttributeValue("srsName"));
ifonenotset.*@uml.propertyname="filter"*/Filterfilter();/***Acaponthenumberoffeaturesthataqueryagainstthistypecanreturn.**<p>Notethatthisvalueshouldoverridetheglobaldefault:{@link*GeoServerInfo#getMaxFeatures()}.*/intgetMaxFeatures();/**Setsacaponthenumberoffeaturesthataqueryagainstthistypecanreturn.*/voidsetMaxFeatures(intmaxFeatures);/***Thenumberofdecimalplacestousewhenencodingfloatingpointnumbersfromdataofthis*featuretype.**<p>Notethatthisvalueshouldoverridetheglobaldefault:{@link*GeoServerInfo#getNumDecimals()}.*/intgetNumDecimals();/***Setsthenumberofdecimalplacestousewhenencodingfloatingpointnumbersfromdataof*thisfeaturetype.*/voidsetNumDecimals(intnumDecimals);/***Toleranceusedtolinearizethisfeaturetype,asanabsolutevalueexpressedinthe*geometriesownCRS*/MeasuregetLinearizationTolerance();/***Toleranceusedtolinearizethisfeaturetype,asanabsolutevalueexpressedinthe*geometriesownCRS*/voidsetLinearizationTolerance(Measuretolerance);/**True
ifthisfeaturetypeinfoisoverridingtheWFSglobalSRSlist*/booleanisOverridingServiceSRS();/**Settotrue
ifthisfeaturetypeinfoisoverridingtheWFSglobalSRSlist*/voidsetOverridingServiceSRS(booleanoverridingServiceSRS);/**True
ifthisfeaturetypeinfoisoverridingthecountingofnumberMatched.*/booleangetSkipNumberMatched();/***Settotrue
ifthisfeaturetypeinfoisoverridingthedefaultcountingofnumberMatched.**@paramskipNumberMatched*/voidsetSkipNumberMatched(booleanskipNumberMatched);/***Thesrs'sthattheWFSservicewilladvertiseinthecapabilitiesdocumentforthisfeature*type(overridingtheglobalWFSsettings)*/List<String>getResponseSRS();/***Returnsthederivedsetofattributesforthefeaturetype.**<p>Thisvalueisderivedfromtheunderlyingfeature,andanyoverridesconfiguredvia{@link*#getAttributes()}.*/List<AttributeTypeInfo>attributes()throwsIOException;/***Returnstheunderlyinggeotoolsfeaturetype.**<p>Thereturnedfeaturetypeis"wrapped"totakeintoaccount"metadata",suchas*reprojectionandnamealiasing.*/FeatureTypegetFeatureType()throwsIOException;/**ReturntheECQLstringusedasdefaultfeaturetypefilter*/StringgetCqlFilter();/**SettheECQLstringusedasdefaultfeatuetypefilter*/voidsetCqlFilter(StringcqlFilterString);/***Returnstheunderlyingfeaturesourceinstance.**<p>ThismethoddoesI/Oandispotentiallyblocking.The<tt>listener</tt>maybeusedto*reporttheprogressofloadingthefeaturesourceandalsotoreportanyerrorsorwarnings*thatoccur.**@paramlistenerAprogresslistener,maybe<code>null</code>.*@paramhintsHintstousewhileloadingthefeatuersource,maybe<code>null</code>.*@returnThefeaturesource.*@throwsIOExceptionAnyI/Oproblems.*/FeatureSource<?extendsFeatureType,?extendsFeature>getFeatureSource(ProgressListenerlistener,Hintshints)throwsIOException;booleanisCircularArcPresent();voidsetCircularArcPresent(booleanarcsPresent);}
if(info.getQualifiedName().getNamespaceURI().equals(MockData.CITE_URI)&&info.getFeatureType().getGeometryDescriptor()!=null)testDefaultStyle(info.getFeatureSource(null,null));
ifdefaultinterpolationmethodisnotspecified,servicedefaultisusedrequest=newGetMapRequest();request.setFormat(getMapFormat());request.setLayers(Arrays.asList(mapLayer));layerInfo.setDefaultWMSInterpolationMethod(null);assertEquals(null,request.getLayers().get(0).getLayerInfo().getDefaultWMSInterpolationMethod());assertTrue(request.getInterpolations().isEmpty());assertEquals(WMSInfo.WMSInterpolation.Nearest,getWMS().getServiceInfo().getInterpolation());map=createWMSMap(env);map.setRequest(request);imageMap=this.rasterMapProducer.produceMap(map);op=(RenderedOp)imageMap.getImage();BufferedImageimageServiceDefault=op.getAsBufferedImage();imageMap.dispose();assertNotBlank("testInterpolationServiceDefault",imageServiceDefault);//testproducedimageisequaltoimageNearestassertEquals(getPixelColor(imageNearest,200,200).getRGB(),getPixelColor(imageServiceDefault,200,200).getRGB());assertEquals(getPixelColor(imageNearest,300,300).getRGB(),getPixelColor(imageServiceDefault,300,300).getRGB());assertEquals(getPixelColor(imageNearest,250,250).getRGB(),getPixelColor(imageServiceDefault,250,250).getRGB());assertEquals(getPixelColor(imageNearest,150,150).getRGB(),getPixelColor(imageServiceDefault,150,150).getRGB());
ifthedirectrasterrenderpathis*not*taken*/privatevoidcheckByLayerInterpolation(RenderedImageMapimageMap,Interpolationexpected){Layerlayer=imageMap.getMapContext().layers().get(0);Interpolationactual=(Interpolation)layer.getUserData().get(StreamingRenderer.BYLAYER_INTERPOLATION);assertEquals(expected,actual);
ifwecansuccessfullycreateadirectrenderedimagebyusingacoverageview*asasource,andasymbolizerdefiningwhichthreebandsoftheinputcoverageviewcanbe*usedforRGBcoloring,andwithwhatorder.*/@TestpublicvoidtestStyleUsingChannelsFromCoverageView()throwsException{GetMapRequestrequest=newGetMapRequest();CoordinateReferenceSystemcrs=DefaultGeographicCRS.WGS84;ReferencedEnvelopebbox=newReferencedEnvelope(newEnvelope(-116.90673461649858211,-114.30988665660261461,32.07093728218402617,33.89032847348440214),crs);request.setBbox(bbox);request.setSRS("urn:x-ogc:def:crs:EPSG:4326");request.setFormat("image/png");finalWMSMapContentmap=newWMSMapContent(request);map.setMapWidth(300);map.setMapHeight(300);map.setTransparent(false);map.getViewport().setBounds(bbox);StyleBuilderstyleBuilder=newStyleBuilder();Catalogcatalog=getCatalog();//SourceimageCoverageInfoci=catalog.getCoverageByName(SystemTestData.MULTIBAND.getPrefix(),SystemTestData.MULTIBAND.getLocalPart());GridCoverage2DReaderreader=(GridCoverage2DReader)ci.getGridCoverageReader(null,null);reader.getCoordinateReferenceSystem();Layersl=newCachedGridReaderLayer(reader,styleBuilder.createStyle(styleBuilder.createRasterSymbolizer()));map.addLayer(sl);RenderedImageMapsrcImageMap=this.rasterMapProducer.produceMap(map);RenderedImagesrcImage=srcImageMap.getImage();//CoverageViewbandcreation.Wecreateacoverageviewwith6bands,using//theoriginalbandsfromthemultibandcoverage//NotethatfirstthreebandsareintreverseorderofthebandsofthesourcecoveragefinalInputCoverageBandib0=newInputCoverageBand("multiband","2");finalCoverageBandb0=newCoverageBand(Collections.singletonList(ib0),"multiband@2",0,CompositionType.BAND_SELECT);finalInputCoverageBandib1=newInputCoverageBand("multiband","1");finalCoverageBandb1=newCoverageBand(Collections.singletonList(ib1),"multiband@1",1,CompositionType.BAND_SELECT);finalInputCoverageBandib2=newInputCoverageBand("multiband","0");finalCoverageBandb2=newCoverageBand(Collections.singletonList(ib2),"multiband@0",2,CompositionType.BAND_SELECT);finalInputCoverageBandib3=newInputCoverageBand("multiband","0");finalCoverageBandb3=newCoverageBand(Collections.singletonList(ib3),"multiband@0",0,CompositionType.BAND_SELECT);finalInputCoverageBandib4=newInputCoverageBand("multiband","1");finalCoverageBandb4=newCoverageBand(Collections.singletonList(ib4),"multiband@1",1,CompositionType.BAND_SELECT);finalInputCoverageBandib5=newInputCoverageBand("multiband","2");finalCoverageBandb5=newCoverageBand(Collections.singletonList(ib5),"multiband@2",2,CompositionType.BAND_SELECT);finalList<CoverageBand>coverageBands=newArrayList<CoverageBand>(1);coverageBands.add(b0);coverageBands.add(b1);coverageBands.add(b2);coverageBands.add(b3);coverageBands.add(b4);coverageBands.add(b5);CoverageViewmultiBandCoverageView=newCoverageView("multiband_select",coverageBands);CoverageStoreInfostoreInfo=catalog.getCoverageStoreByName("multiband");CatalogBuilderbuilder=newCatalogBuilder(catalog);//ReorderedbandscoverageCoverageInfocoverageInfo=multiBandCoverageView.createCoverageInfo("multiband_select",storeInfo,builder);coverageInfo.getParameters().put("USE_JAI_IMAGEREAD","false");catalog.add(coverageInfo);finalLayerInfolayerInfoView=builder.buildLayer(coverageInfo);catalog.add(layerInfoView);finalEnvelopeenv=ci.boundingBox();LOGGER.info("abouttocreatemapctxforBasicPolygonswithbounds"+env);RasterSymbolizersymbolizer=styleBuilder.createRasterSymbolizer();ChannelSelectioncs=newChannelSelectionImpl();SelectedChannelTypered=newSelectedChannelTypeImpl();SelectedChannelTypegreen=newSelectedChannelTypeImpl();SelectedChannelTypeblue=newSelectedChannelTypeImpl();//WewanttocreateanimagewheretheRGBchannelsareinreverseorder//regardingthebandorderoftheinputcoverageview//Notethatchannelnamesstartwithindex"1"red.setChannelName("3");green.setChannelName("2");blue.setChannelName("1");cs.setRGBChannels(newSelectedChannelType[]{red,green,blue});symbolizer.setChannelSelection(cs);reader=(GridCoverage2DReader)coverageInfo.getGridCoverageReader(null,null);reader.getCoordinateReferenceSystem();Layerdl=newCachedGridReaderLayer(reader,styleBuilder.createStyle(symbolizer));map.removeLayer(sl);map.addLayer(dl);RenderedImageMapdstImageMap=this.rasterMapProducer.produceMap(map);RenderedImagedestImage=dstImageMap.getImage();intdWidth=destImage.getWidth();intdHeight=destImage.getHeight();int[]destImageRowBand0=newint[dWidth*dHeight];int[]destImageRowBand1=newint[destImageRowBand0.length];int[]destImageRowBand2=newint[destImageRowBand0.length];destImage.getData().getSamples(0,0,dWidth,dHeight,0,destImageRowBand0);destImage.getData().getSamples(0,0,dWidth,dHeight,1,destImageRowBand1);destImage.getData().getSamples(0,0,dWidth,dHeight,2,destImageRowBand2);intsWidth=srcImage.getWidth();intsHeight=srcImage.getHeight();int[]srcImageRowBand0=newint[sWidth*sHeight];int[]srcImageRowBand2=newint[srcImageRowBand0.length];srcImage.getData().getSamples(0,0,sWidth,sHeight,0,srcImageRowBand0);//Sourceandresultimagefirstbandsshouldbethesame.Wehavereversedtheorder//ofthethreefirstbandsofthesourcecoverageandthenwere-reversedthethree//firstbandsusingchannelselectionontherastersymbolizerusedforrendering.Assert.assertTrue(Arrays.equals(destImageRowBand0,srcImageRowBand0));//Resultband0shouldnotbeequaltosourceimageband2Assert.assertFalse(Arrays.equals(destImageRowBand0,srcImageRowBand2));srcImageMap.dispose();dstImageMap.dispose();map.dispose();
if(directory1.exists()){FileUtils.deleteDirectory(directory1);
if(operation==null||operation.getParameters().length<=0){returnsuper.operationDispatched(request,operation);
ifthisisafeatureinfoornotfinalObjecto=operation.getParameters()[0];
if(!(oinstanceofGetFeatureInfoRequest)){returnsuper.operationDispatched(request,operation);
ifitis1.3.0org.geoserver.wms.GetFeatureInfoRequestfeatureinfoReq=(GetFeatureInfoRequest)o;
if(!featureinfoReq.getVersion().equalsIgnoreCase("1.3.0")){returnsuper.operationDispatched(request,operation);
if(rawKvpMap!=null){for(Map.Entry<String,String>kvp:rawKvpMap.entrySet()){Stringname=kvp.getKey();
if(name.startsWith("DIM_")){name=name.substring(4);
if(name.length()>0&&name!=null){finalArrayList<String>val=newArrayList<String>(1);
if(kvp.getValue().indexOf(",")>0){String[]elements=kvp.getValue().split(",");val.addAll(Arrays.asList(elements));
else{val.add(kvp.getValue());
if(metadata.containsKey(EoLayerType.KEY)&&metadata.get(EoLayerType.KEY).equals(EoLayerType.BAND_COVERAGE.name())){//checktheMERGE_BEHAVIORasflat(thisisharmlessanyway)Map<String,Serializable>params=cInfo.getParameters();for(Entry<String,Serializable>entry:params.entrySet()){
if(entry.getKey().equalsIgnoreCase(ImageMosaicFormat.MERGE_BEHAVIOR.getName().getCode())){entry.setValue(MergeBehavior.STACK.toString());break;
if(dynamicParameters.isEmpty()){thrownewIllegalStateException("Layer"+cInfo.getTitle()+"hasnoadditionaldimensionswhicharerequiredforanEOBANDSlayer");
if(customDomains.containsKey(name)){finalListvalues=customDomains.get(name);//1or3,0toleavedefaultkickin
if(values.size()!=0&&values.size()!=1&&values.size()!=3){thrownewServiceException("DimensionDIM_"+name+"hasbeenrequestwithwrongnumberofvalues:"+values.size(),"InvalidDimensionValue");
ifnoval
iftheuserhasadmincredentials*/staticComponentAuthorizerADMIN=newAdminComponentAuthorizer();/**authorizerthatgrantsaccess
iftheuserhasworkspaceadmincredentials*/staticComponentAuthorizerWORKSPACE_ADMIN=newWorkspaceAdminComponentAuthorizer();/**authorizerthatgrantsaccess
iftheuserhasauthenticated*/staticComponentAuthorizerAUTHENTICATED=newAuthenticatedComponentAuthorizer();/**Determines
ifaccessisallowedtothecomponentgiventhespecifiedcredentials.*/booleanisAccessAllowed(Class<?>componentClass,Authenticationauthentication);}
if(pf==null){thrownewWPSException("Nosuchprocess:"+processName);
if(rawKvp.containsKey("responseDocument")){execute.setResponseForm(parseResponseDocument(pf.getResultInfo(processName,null),(String)rawKvp.get("responseDocument")));
else
if(rawKvp.containsKey("rawDataOutput")){execute.setResponseForm(parseRawDataOutput(pf.getResultInfo(processName,null),(String)rawKvp.get("rawDataOutput")));
else{ResponseFormTyperesponseForm=factory.createResponseFormType();responseForm.setResponseDocument(factory.createResponseDocumentType());execute.setResponseForm(responseForm);
if("true".equals(kvp.get("storeExecuteResponse"))){
if(execute.getResponseForm().getResponseDocument()==null){thrownewWPSException("InvalidParameterValue","Cannotstoretheresponseforrawdataoutputs,"+"pleaseuseresponsedocumentinstead");
if("true".equals(kvp.get("lineage"))){
if(execute.getResponseForm().getResponseDocument()==null){thrownewWPSException("InvalidParameterValue","Cannotprovidelineageintheresponseforrawdataoutputs,"+"pleaseuseresponsedocumentinstead");
if("true".equals(kvp.get("status"))){
if(execute.getResponseForm().getResponseDocument()==null){thrownewWPSException("InvalidParameterValue","Cannotaddstatuswithrawdataoutputs,"+"pleaseuseresponsedocumentwithstoreoptioninstead");
if(!execute.getResponseForm().getResponseDocument().isStoreExecuteResponse()){thrownewWPSException("InvalidParameterValue","Cannotaddstatus
iftheresponse"+"isnotstored,pleaseaddstoreExecuteResponse=trueyourrequest");
if(gtParam==null){thrownewWPSException("Unknowndatainputnamed'"+ioParam.id+"'");
if(ppioinstanceofLiteralPPIO){it.getData().setLiteralData(parseLiteral(it,factory,ioParam));
else
if(ppioinstanceofBoundingBoxPPIO){it.getData().setBoundingBoxData(parseBoundingBox(it,factory,ioParam));
else
if(ioParam.isReference()){it.setReference(parseReferenceType(it,factory,ioParam));
else{it.getData().setComplexData(parseComplex(it,factory,ioParam));
if(inputString==null||"".equals(inputString.trim())){returnCollections.emptyList();
if(idx==-1){result.add(newIOParam(input,null,Collections.EMPTY_MAP));
else{StringinputId=input.substring(0,idx);String[]valueAttributes=input.substring(idx+1,input.length()).split("@");Stringvalue=valueAttributes[0];Map<String,String>attributes=parseAttributes(valueAttributes);result.add(newIOParam(inputId,value,attributes));
if(idx==-1){thrownewWPSException("Invalidsyntaxfordatainputattribute:@"+att);
if(idx==att.length()-1){result.put(att.substring(0,idx),null);
else{result.put(att.substring(0,idx),att.substring(idx+1,att.length()));
if(param.attributes.containsKey("href")){ref.setHref(param.attributes.get("href"));
else{ref.setHref(param.attributes.get("xlink:href"));
if(envelope!=null){BoundingBoxTypebbox=Ows11Factory.eINSTANCE.createBoundingBoxType();
if(envelope.getCoordinateReferenceSystem()!=null){bbox.setCrs(GML2EncodingUtils.epsgCode(envelope.getCoordinateReferenceSystem()));
else{returnnull;
if(!outputs.containsKey(ioParam.id)){thrownewWPSException("Unknownoutput"+ioParam.id);
if(inDocument){DocumentOutputDefinitionTypedout=factory.createDocumentOutputDefinitionType();dout.setAsReference(Boolean.parseBoolean(ioParam.attributes.get("asReference")));odt=dout;
else{odt=factory.createOutputDefinitionType();
if(ioParams.size()==0){returnresponse;
if(ioParams.size()>1){thrownewWPSException("TherecanbeonlyoneRawDataOutput");
if(info.getType()==PublishedType.VECTOR)icon=VECTOR_ICON;
else
if(info.getType()==PublishedType.RASTER)icon=RASTER_ICON;returnicon;
if(info.getType()==PublishedType.RASTER){returnRASTER_ICON;
else
if(info.getType()==PublishedType.VECTOR){try{FeatureTypeInfofti=(FeatureTypeInfo)info.getResource();GeometryDescriptorgd=fti.getFeatureType().getGeometryDescriptor();returngetVectoryIcon(gd);
else
if(info.getType()==PublishedType.WMS){returnMAP_ICON;
else
if(info.getType()==PublishedType.WMTS){returnMAP_ICON;
else{returnUNKNOWN_ICON;
if(gd==null){returnGEOMETRY_ICON;
if(Point.class.isAssignableFrom(geom)||MultiPoint.class.isAssignableFrom(geom)){returnPOINT_ICON;
else
if(LineString.class.isAssignableFrom(geom)||MultiLineString.class.isAssignableFrom(geom)){returnLINE_ICON;
else
if(Polygon.class.isAssignableFrom(geom)||MultiPolygon.class.isAssignableFrom(geom)){returnPOLYGON_ICON;
else{returnGEOMETRY_ICON;
if(storeInfoinstanceofDataStoreInfo){DataAccessFactorydataStoreFactory=null;try{dataStoreFactory=resourcePool.getDataStoreFactory((DataStoreInfo)storeInfo);
if(dataStoreFactory!=null){returngetStoreIcon(dataStoreFactory.getClass());
else
if(storeInfoinstanceofCoverageStoreInfo){AbstractGridFormatformat=resourcePool.getGridCoverageFormat((CoverageStoreInfo)storeInfo);
if(format!=null){returngetStoreIcon(format.getClass());
else
if(storeInfoinstanceofWMSStoreInfo){returnMAP_STORE_ICON;
else
if(storeInfoinstanceofWMTSStoreInfo){returnMAP_STORE_ICON;
else{thrownewIllegalStateException(storeInfo.getClass().getName());
ifnotfound,theiconforthe{@linkDataStorePanelInfo}*registeredwiththeid{@codedefaultVector}or{@codedefaultRaster},asappropriatewillbe*used.**@paramfactoryClasseithera{@linkDataAccessFactory}ora{@linkFormat}class*/publicPackageResourceReferencegetStoreIcon(Class<?>factoryClass){//lookfortheassociatedpanelinfo
ifthereisonefinalList<DataStorePanelInfo>infos;infos=GeoServerApplication.get().getBeansOfType(DataStorePanelInfo.class);for(DataStorePanelInfopanelInfo:infos){
if(factoryClass.equals(panelInfo.getFactoryClass())){returnnewPackageResourceReference(panelInfo.getIconBase(),panelInfo.getIcon());
if(DataAccessFactory.class.isAssignableFrom(factoryClass)){//searchforthedeclareddefaultvectorstoreiconfor(DataStorePanelInfopanelInfo:infos){
if("defaultVector".equals(panelInfo.getId())){returnnewPackageResourceReference(panelInfo.getIconBase(),panelInfo.getIcon());
else
if(Format.class.isAssignableFrom(factoryClass)){//searchforthedeclareddefaultcoveragestoreiconfor(DataStorePanelInfopanelInfo:infos){
if("defaultRaster".equals(panelInfo.getId())){returnnewPackageResourceReference(panelInfo.getIconBase(),panelInfo.getIcon());
if(egfinstanceofImageGraphicFactory){Fieldcache=egf.getClass().getDeclaredField("imageCache");cache.setAccessible(true);imageCache=(Map)cache.get(egf);URLu=newURL("http://boundless.org");BufferedImageb=newBufferedImage(6,6,8);imageCache.put(u,b);
if(getSession().getAuthentication()!=null&&getSession().getAuthentication().isAuthenticated()){try{ByteArrayOutputStreambos=newByteArrayOutputStream();PrintStreamps=newPrintStream(bos);error.printStackTrace(ps);ps.close();bos.close();errorText=newModel(bos.toString());notice=newResourceModel("GeoServerErrorPage.whatIsThis");trace=true;
if(notice!=null&&notice.getObject()!=null){error(notice.getObject().toString());
if(job==null||job.isDone()){//removethetimerstop(null);self.setEnabled(true);target.add(self);running.set(false);target.add(cancelLink(self));/*ImportContextimp=model.getObject();
if(imp.getState()==ImportContext.State.COMPLETE){//enablecancel,whichwillnotbe"done"setLinkEnabled(cancelLink(self),true,target);
else{//disablecancel,importisnotlongerrunning,but//also//notcompletesetLinkEnabled(cancelLink(self),false,target);}*/
if(!running.get()){//
if(imp.getState()==ImportContext.State.COMPLETE){setResponsePage(ImportDataPage.class);return;
if(jobid==null){return;
if(task==null||task.isDone()){return;
if(enable){booleanallComplete=true;for(ImportTasktask:table.getSelection()){allComplete=task.getState()==ImportTask.State.COMPLETE;
if(t.getState()==ImportTask.State.READY){table.selectObject(t);empty=false;
if(datainstanceofFileData){FileDatadf=(FileData)data;
if(datainstanceofDirectory){icon=DataIcon.FOLDER;
else{icon=df.getFormat()instanceofVectorFormat?DataIcon.FILE_VECTOR:df.getFormat()instanceofRasterFormat?DataIcon.FILE_RASTER:DataIcon.FILE;
else
if(datainstanceofDatabase){icon=DataIcon.DATABASE;
else{icon=DataIcon.VECTOR;//TODO:betterdefault
if(abbrev&&title.length()>70){//shortenittitle=title.substring(0,20)+"[...]"+title.substring(title.length()-50);
if(namespaceURI==null){//assumedefaultnamespaceURI=catalog.getDefaultNamespace().getURI();
if(meta!=null){//founditXSDSchemaschema=schemaBuilder.build(meta,null);for(Iteratore=schema.getElementDeclarations().iterator();e.hasNext();){XSDElementDeclarationelement=(XSDElementDeclaration)e.next();
if(name.getLocalPart().equals(element.getName())){returnnewElementHandlerImpl(element,parent,parser);
if(pf==null){thrownewWPSException("Unknownprocess"+processName);
iftherequestisasynchronous*/publicbooleanisAsynchronous(){returnrequest.getResponseForm()!=null&&request.getResponseForm().getResponseDocument()!=null&&request.getResponseForm().getResponseDocument().isStoreExecuteResponse();
ifstatusupdateisrequested*/publicbooleanisStatusEnabled(){returnisAsynchronous()&&request.getResponseForm().getResponseDocument().isStatus();
if(inputs==null){inputs=getInputsInternal(manager);
if(!outputMimeParameters.isEmpty()){Map<String,String>requestedRawDataMimeTypes=getRequestedRawDataMimeTypes(outputMimeParameters.keySet(),processName,pf);for(Map.Entry<String,String>param:outputMimeParameters.entrySet()){StringoutputName=param.getKey();StringinputParameter=param.getValue();Stringmime=requestedRawDataMimeTypes.get(outputName);StringInputProviderprovider=newStringInputProvider(mime,inputParameter);providers.put(inputParameter,provider);
if(p==null){thrownewWPSException("Nosuchparameter:"+inputId);
if(input.getData()!=null&&input.getData().getComplexData()!=null){mime=input.getData().getComplexData().getMimeType();
else
if(input.getReference()!=null){mime=input.getReference().getMimeType();
if(ppio==null){thrownewWPSException("Unabletodecodeinput:"+inputId);
if(p.maxOccurs>1){ListInputProviderlp=(ListInputProvider)providers.get(p.key);
if(lp==null){lp=newListInputProvider(provider,p.getMaxOccurs());providers.put(p.key,lp);
else{lp.add(provider);
else{providers.put(p.key,provider);
if(form==null||(raw==null&&document==null)){//alloutputsusingtheirdefaultmimefor(StringrawResult:rawResults){Stringmime=AbstractRawData.getDefaultMime(name,pf,rawResult);result.put(rawResult,mime);
else
if(raw!=null){//justoneoutputtypeStringoutput=raw.getIdentifier().getValue();Stringmime;
if(raw.getMimeType()!=null){mime=raw.getMimeType();
else{mime=AbstractRawData.getDefaultMime(name,pf,output);
else{//theresponsedocumentformfor(Iteratorit=document.getOutput().iterator();it.hasNext();){OutputDefinitionTypeout=(OutputDefinitionType)it.next();StringoutputName=out.getIdentifier().getValue();
if(rawResults.contains(outputName)){//wastheoutputmimespecified?Stringmime=out.getMimeType();
if(mime==null||mime.trim().isEmpty()){mime=AbstractRawData.getDefaultMime(name,pf,outputName);
ifnothingspecificwasrequested,thelistotherwise*/publicList<OutputDefinitionType>getRequestedOutputs(){//incasenothingspecificwasrequestedResponseFormTyperesponseForm=request.getResponseForm();
if(responseForm==null){returnnull;
if(responseForm.getRawDataOutput()!=null){returnCollections.singletonList(responseForm.getRawDataOutput());
else
if(responseForm.getResponseDocument()!=null&&responseForm.getResponseDocument().getOutput()!=null){List<OutputDefinitionType>result=newArrayList<>();EListoutputs=responseForm.getResponseDocument().getOutput();for(Objectoutput:outputs){result.add((DocumentOutputDefinitionType)output);
if(requestedOutputs!=null){for(OutputDefinitionTypeoutput:requestedOutputs){StringoutputIdentifier=output.getIdentifier().getValue();
if(!resultInfo.containsKey(outputIdentifier)){Stringlocator=outputinstanceofDocumentOutputDefinitionType?"ResponseDocument":"RawDataOutput";thrownewWPSException("Unknowoutput"+outputIdentifier,ServiceException.INVALID_PARAMETER_VALUE,locator);
if(m.getAvailable()){System.out.println(m.getName()+"ISavailable->"+m.getValue()+""+m.getUnit());
else{System.err.println(m.getName()+"ISNOTavailable");
if(doSave){WFSInfowfs=getWFS();GMLInfogml=wfs.getGML().get(WFSInfo.Version.V_20);gml.setSrsNameStyle(srsNameStyle);getGeoServer().save(wfs);
if(valinstanceofMap){encode((Map)val,w);
else{w.value(val);
ifnoatttributetypemappedto<code>clazz*</code>*/publicAttributeTypetype(Classclazz){ArrayListassignable=newArrayList();for(Iteratorp=profiles.iterator();p.hasNext();){ProfileImplprofile=(ProfileImpl)p.next();for(Iteratori=profile.values().iterator();i.hasNext();){AttributeTypetype=(AttributeType)i.next();
if(type.getBinding().isAssignableFrom(clazz)){assignable.add(type);
if(clazz.equals(type.getBinding())){returntype;
if(assignable.isEmpty()){returnnull;
if(assignable.size()==1){return(AttributeType)assignable.get(0);
else{//sortComparatorcomparator=newComparator(){publicintcompare(Objecto1,Objecto2){AttributeTypea1=(AttributeType)o1;AttributeTypea2=(AttributeType)o2;Classc1=a1.getBinding();Classc2=a2.getBinding();
if(c1.equals(c2)){return0;
if(c1.isAssignableFrom(c2)){return1;
if(!assignable.get(0).equals(assignable.get(1))){return(AttributeType)assignable.get(0);
ifnoatttributetypemappedto<code>clazz</code>*/publicNamename(Classclazz){ArrayListassignable=newArrayList();for(Iteratorp=profiles.iterator();p.hasNext();){ProfileImplprofile=(ProfileImpl)p.next();for(Iteratori=profile.entrySet().iterator();i.hasNext();){Map.Entryentry=(Map.Entry)i.next();AttributeTypetype=(AttributeType)entry.getValue();
if(type.getBinding().isAssignableFrom(clazz)){assignable.add(entry);
if(clazz.equals(type.getBinding())){return(Name)entry.getKey();
if(assignable.isEmpty()){returnnull;
if(assignable.size()==1){return(Name)((Map.Entry)assignable.get(0)).getKey();
else{//sortComparatorcomparator=newComparator(){publicintcompare(Objecto1,Objecto2){Map.Entrye1=(Map.Entry)o1;Map.Entrye2=(Map.Entry)o2;AttributeTypea1=(AttributeType)e1.getValue();AttributeTypea2=(AttributeType)e2.getValue();Classc1=a1.getBinding();Classc2=a2.getBinding();
if(c1.equals(c2)){return0;
if(c1.isAssignableFrom(c2)){return1;
if(!a1.equals(a2)){return(Name)e1.getKey();
if(componentinstanceofFormComponent){FormComponent<?>formComponent=(FormComponent<?>)component;formComponent.processInput();
ifthecontentlengthis*unknown.**@author"AlessioFabiani-alessio.fabiani@geo-solutions.it"*/abstractclassLimitedImageOutputStreamextendsFilterImageOutputStream{/**Themaximumsizeofanitem,inbytes.*/privatelongsizeMax;/**Thecurrentnumberofbytes.*/privatelongcount;/**Whetherthisstreamisalreadyclosed.*/privatebooleanclosed;/***Createsanewinstance.**@parampOutTheinputstream,whichshallbelimited.*@parampSizeMaxThelimit;nomorethanthisnumberofbytesshallbereturnedbythesource*stream.*/publicLimitedImageOutputStream(ImageOutputStreampOut,longpSizeMax){super(pOut);sizeMax=pSizeMax;
if(count>sizeMax){raiseError(sizeMax,count);
ifthestreamisclosed,otherwisefalse.*@throwsIOExceptionAnI/Oerroroccurred.*/publicbooleanisClosed()throwsIOException{returnclosed;
ifanI/Oerroroccurs.*@seejava.io.FilterInputStream#in*/publicvoidclose()throwsIOException{closed=true;super.close();
if(!info.isEnabled()){doSaveStore(info);
else{try{//trytosee
ifwecanconnectgetCatalog().getResourcePool().clear(info);//donotcallinfo.getWebMapServercauseitendsupcalling//resourcepool.getWebMapServerwiththeunproxiedinstance(oldvalues)//info.getWebMapServer(null).getCapabilities();WebMapTileServerwmts=getCatalog().getResourcePool().getWebMapTileServer(info);wmts.getCapabilities();doSaveStore(info);
if(message==null&&error.getCause()!=null){message=error.getCause().getMessage();
if(accepted){doReturn(StorePage.class);
if(executionId==null){executionId=getExecutionId((Boolean)null);
if(id==null){id=UUID.randomUUID().toString();executionId.set(id);resourceCache.put(id,newExecutionResources(synch!=null?synch:true));
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Associatingprocesswithexecutionid:"+id);
if(resources==null){thrownewIllegalStateException("Executionid"+executionId+"isnotknown");
ifany**@paramexecutionId*/StringgetCurrentExecutionId(){returnthis.executionId.get();
if(resources==null){thrownewIllegalStateException("TheexecutionIdwasnotsetforthecurrentthread!");
else{resources.temporary.add(resource);
ifyoudon'thaveittheresourcemanagerwilluseitsthread*localversion*@paramname*@parambaseUrl-optional,
ifyoudon'thaveittheresourcemanagerwillpickonefrom*Dispatcher.REQUEST*@parammimeType*/publicStringgetOutputResourceUrl(StringexecutionId,Stringname,StringbaseUrl,StringmimeType){//createthelinkMap<String,String>kvp=newLinkedHashMap<String,String>();kvp.put("service","WPS");kvp.put("version","1.0.0");kvp.put("request","GetExecutionResult");kvp.put("executionId",getExecutionId(executionId));kvp.put("outputId",name);kvp.put("mimetype",mimeType);
if(baseUrl==null){Operationop=Dispatcher.REQUEST.get().getOperation();ExecuteTypeexecute=(ExecuteType)op.getParameters()[0];baseUrl=execute.getBaseUrl();
ifthe*processisexecutingasynchronously**@paramexecutionId*/publicResourcegetStoredRequest(StringexecutionId){returnartifactsStore.getArtifact(executionId,ArtifactType.Request,null);
if(resource==null||resource.getType()==Type.UNDEFINED){returnnull;
else{try(InputStreamin=resource.in()){WPSConfigurationconfig=newWPSConfiguration();Parserparser=newParser(config);return(ExecuteType)parser.parse(in);
ifwedidnotgenerateanyprocessid,noresourceshavebeenadded
if(executionId.get()==null){return;
iftheprocessissynchronous
if(resourceCache.get(id).synchronouos){cleanProcess(id,false);resourceCache.remove(id);
if(cancelled){try{artifactsStore.clearArtifacts(id);
if(eventinstanceofContextClosedEvent||eventinstanceofContextStoppedEvent){//weareshuttingdown,removealltempresources!for(Stringid:resourceCache.keySet()){cleanProcess(id,false);
ifwehaveanartifactsstoreintheappcontext,otherwiseusethedefaultoneProcessArtifactsStorestore=GeoServerExtensions.bean(ProcessArtifactsStore.class);
if(store==null){store=newDefaultProcessArtifactsStore();
if(status==null||status.getPhase().isExecutionCompleted()){cleanupResource(r,expirationThreshold);
if(resourceType==Type.RESOURCE&&resource.lastmodified()<expirationThreshold){result=resource.delete();
else
if(resourceType==Type.DIRECTORY){longdirectoryModified=resource.lastmodified();for(Resourcechild:resource.list()){result&=cleanupResource(child,expirationThreshold);
ifallthechildrenhavebeencleanup
if(result&&directoryModified<expirationThreshold){result&=resource.delete();
if(GeoServerSecurityFilterChainProxy.isSecurityEnabledForCurrentRequest()==false)return;//nothingtodoAuthenticationauth=getSession().getAuthentication();
if(auth==null||!auth.isAuthenticated()||authinstanceofAnonymousAuthenticationToken){//emulatewhatspringsecurityurlcontrolwoulddosothatwegetaproperredirect//afterloginHttpServletRequesthttpRequest=(HttpServletRequest)((WebRequest)getRequest()).getContainerRequest();//ExceptionTranslationFiltertranslator=(ExceptionTranslationFilter)//getGeoServerApplication().getBean("consoleExceptionTranslationFilter");SavedRequestsavedRequest=newDefaultSavedRequest(httpRequest,newPortResolverImpl());HttpSessionsession=httpRequest.getSession();//TODO,Justin,WebAttributes.SAVED_REQUESThasdisappearedinspringsecurity//frameworksession.setAttribute(SAVED_REQUEST,savedRequest);//thenredirecttotheloginpagesetResponsePage(GeoServerLoginPage.class);
else
if(!getPageAuthorizer().isAccessAllowed(this.getClass(),auth))setResponsePage(UnauthorizedPage.class);
ifthecurrentuserisauthenticatedasfulladministartor.*/protectedbooleanisAuthenticatedAsAdmin(){returnComponentAuthorizer.ADMIN.isAccessAllowed(GeoServerSecuredPage.class,SecurityContextHolder.getContext().getAuthentication());}}
if(is!=null){returnnewInputSourceToLSResource(is);
if(elementinstanceofInsert){for(Objectf:((Insert)element).getFeatures()){SimpleFeaturesf=(SimpleFeature)f;
if("Points".equals(sf.getType().getTypeName())){//checkinsertscanbemodifiedsf.setAttribute("id",sf.getAttribute("id")+"-modified");
else
if(elementinstanceofUpdate){Updateupdate=(Update)element;List<Property>updateProperties=update.getUpdateProperties();Propertyproperty=update.createProperty();property.setName(newQName(null,"NAME"));property.setValue(FOLSOM_STREET);updateProperties.add(property);update.setUpdateProperties(updateProperties);
else
if(elementinstanceofDelete){try{//massdeletemorethanrequested((Delete)element).setFilter(CQL.toFilter("FID>102"));
if(md.storesUpperCaseIdentifiers()){schema=schema.toUpperCase();pattern=pattern.toUpperCase();
if(authConfig.isUseRememberMe()){filter.setRememberMeServices(securityManager.getRememberMeService());GeoServerWebAuthenticationDetailsSources=newGeoServerWebAuthenticationDetailsSource();filter.setAuthenticationDetailsSource(s);
if(request.getSession(false)!=null)//nocaching
ifthereisanHTTPsessionreturnnull;Stringheader=request.getHeader("Authorization");
if((header!=null)&&header.startsWith("Basic")){byte[]base64Token=null;try{base64Token=header.substring(6).getBytes("UTF-8");
if(delim!=-1){username=token.substring(0,delim);password=token.substring(delim+1);
else{returnnull;
if(GeoServerUser.ROOT_USERNAME.equals(username))returnnull;StringBufferbuff=newStringBuffer(password);buff.append(":");buff.append(getName());StringdigestString=null;try{MessageDigestmd=(MessageDigest)digest.clone();digestString=newString(Hex.encode(md.digest(buff.toString().getBytes("utf-8"))));
elsereturnnull;
iftheObjectisnotencodeable.*/publicvoidencode(Objecto)throwsIllegalArgumentException{
if(!(oinstanceofGetCapabilitiesType)){thrownewIllegalArgumentException(newStringBuffer("NotaGetCapabilitiesType:").append(o).toString());
if(request.getUpdateSequence()!=null){try{requestedUpdateSequence=Long.parseLong(request.getUpdateSequence());
if(requestedUpdateSequence>updateSequence){thrownewWcsException("Invalidupdatesequencevalue,it'shigher"+"thanthecurrentvalue,"+updateSequence,WcsExceptionCode.InvalidUpdateSequence,"updateSequence");
if(request.getSections()==null){allSections=true;sections=Collections.emptyList();
else{sections=request.getSections().getSection();allSections=sections.contains("All");
if(!knownSections.contains(section))thrownewWcsException("Unknownsection"+section,WcsExceptionCode.InvalidParameterValue,"Sections");
if(requestedUpdateSequence<updateSequence){
if(allSections||sections.contains("ServiceIdentification"))handleServiceIdentification();
if(allSections||sections.contains("ServiceProvider"))handleServiceProvider();
if(allSections||sections.contains("OperationsMetadata"))handleOperationsMetadata();
if(allSections||sections.contains("Contents"))handleContents();
if((fees==null)||"".equals(fees)){fees="NONE";
if((accessConstraints==null)||"".equals(accessConstraints)){accessConstraints="NONE";
if(parameters!=null&&!parameters.isEmpty()){for(Map.Entry<String,List<String>>param:parameters.entrySet()){attributes=newAttributesImpl();attributes.addAttribute("","name","name","",param.getKey());start("ows:Parameter",attributes);start("ows:AllowedValues");for(Stringvalue:param.getValue()){element("ows:Value",value);
if(kwords!=null&&kwords.size()>0){start("ows:Keywords");
if(kwords!=null){for(Iteratorit=kwords.iterator();it.hasNext();){element("ows:Keyword",it.next().toString());
if((or!=null)&&!"".equals(or.trim())){AttributesImplattributes=newAttributesImpl();attributes.addAttribute("","xlink:href","xlink:href","",or);start("ows:OnlineResource",attributes);end("OnlineResource");
if(!cv.enabled()){it.remove();
if(request.getNamespace()!=null){Stringnamespace=request.getNamespace();for(Iteratorit=coverages.iterator();it.hasNext();){CoverageInfocv=(CoverageInfo)it.next();
if(!namespace.equals(cv.getStore().getWorkspace().getName()))it.remove();
if(skipMisconfigured){reset();LOGGER.log(Level.SEVERE,"Skippingcoverage"+cv.getPrefixedName()+"asitscapabilitiesgenerationfailed",e);
else{thrownewRuntimeException("Capabilitiesdocumentgenerationfailedoncoverage"+cv.getPrefixedName(),e);
if(mdl!=null){handleMetadataLink(mdl,linkType);
if((mdl.getAbout()!=null)&&(mdl.getAbout()!="")){attributes.addAttribute("","about","about","",mdl.getAbout());
if((linkType!=null)&&(linkType!="")){attributes.addAttribute("","xlink:type","xlink:type","",linkType);
if((mdl.getContent()!=null)&&(mdl.getContent()!="")){attributes.addAttribute("","xlink:href","xlink:href","",ResponseUtils.proxifyMetadataLink(mdl,request.getBaseUrl()));element("ows:Metadata",null,attributes);
ifandonly
ifthecontentisnotnullandnotempty**@paramelementName*@paramcontent*/protectedvoidelementIfNotEmpty(StringelementName,Stringcontent){
if(content!=null&&!"".equals(content.trim()))element(elementName,content);
ifinfinitetimeout.*/publicdoublegetConnectionTimeout(){
if(connectionTimeout==null){//checkthemetadatamapforbackwardscompatibilitywith2.1.xseriesMetadataMapmd=getMetadata();
if(md==null){returnDEFAULT_CONNECTION_TIMEOUT;
if(timeout==null){returnDEFAULT_CONNECTION_TIMEOUT;
if(resourceExpirationTimeout==null){//checkthemetadatamapforbackwardscompatibilitywith2.1.xseriesMetadataMapmd=getMetadata();
if(md==null){returnDEFAULT_RESOURCE_EXPIRATION_TIMEOUT;
if(timeout==null){returnDEFAULT_RESOURCE_EXPIRATION_TIMEOUT;
if(maxSynchronousProcesses==null){//checkthemetadatamapforbackwardscompatibilitywith2.1.xseriesMetadataMapmd=getMetadata();
if(md==null){returnDEFAULT_MAX_SYNCH;
if(max==null){returnDEFAULT_MAX_SYNCH;
if(maxAsynchronousProcesses==null){//checkthemetadatamapforbackwardscompatibilitywith2.1.xseriesMetadataMapmd=getMetadata();
if(md==null){returnDEFAULT_MAX_ASYNCH;
if(max==null){returnDEFAULT_MAX_ASYNCH;
if(catalogMode==null){catalogMode=CatalogMode.HIDE;
if(this==obj)returntrue;
if(!super.equals(obj))returnfalse;
if(getClass()!=obj.getClass())returnfalse;WPSInfoImplother=(WPSInfoImpl)obj;
if(catalogMode!=other.catalogMode)returnfalse;
if(connectionTimeout==null){
if(other.connectionTimeout!=null)returnfalse;
else
if(!connectionTimeout.equals(other.connectionTimeout))returnfalse;
if(maxAsynchronousProcesses==null){
if(other.maxAsynchronousProcesses!=null)returnfalse;
else
if(!maxAsynchronousProcesses.equals(other.maxAsynchronousProcesses))returnfalse;
if(maxAsynchronousExecutionTime!=other.maxAsynchronousExecutionTime)returnfalse;
if(maxAsynchronousTotalTime==null){
if(other.maxAsynchronousTotalTime!=null)returnfalse;
else
if(!maxAsynchronousTotalTime.equals(other.maxAsynchronousTotalTime))returnfalse;
if(maxComplexInputSize!=other.maxComplexInputSize)returnfalse;
if(maxSynchronousExecutionTime!=other.maxSynchronousExecutionTime)returnfalse;
if(maxSynchronousTotalTime==null){
if(other.maxSynchronousTotalTime!=null)returnfalse;
else
if(!maxSynchronousTotalTime.equals(other.maxSynchronousTotalTime))returnfalse;
if(maxSynchronousProcesses==null){
if(other.maxSynchronousProcesses!=null)returnfalse;
else
if(!maxSynchronousProcesses.equals(other.maxSynchronousProcesses))returnfalse;
if(processGroups==null){
if(other.processGroups!=null)returnfalse;
else
if(!processGroups.equals(other.processGroups))returnfalse;
if(resourceExpirationTimeout==null){
if(other.resourceExpirationTimeout!=null)returnfalse;
else
if(!resourceExpirationTimeout.equals(other.resourceExpirationTimeout))returnfalse;
if(storageDirectory==null){
if(other.storageDirectory!=null)returnfalse;
else
if(!storageDirectory.equals(other.storageDirectory))returnfalse;returntrue;}}
if(config.equals(model.getObject())){isNew=false;break;
if(ConfigEntry.isRestricted(name)){form.error(String.format("Modifying%sthroughthisinterfacecanhaveunintendedconsequencesandisnotallowed.",name));
else{for(ConfigEntryconfig:table.getConfigs()){
if(!config.equals(model.getObject())){StringnewName=config.getName();
if(newName!=null&&!newName.equals(previousName)&&newName.equals(name)){form.error(String.format("Aconfigentrycalled%salreadyexists",name));
if(!isInTable){table.add(newConfig);
ifyouhavemanydifferentplacemarksorgroundoverlays,theyallneedtobe*containedwithinone<document>element,thenzippedupandsentoffwiththeextension"kmz".**@author$Author:AlessioFabiani(alessio.fabiani@gmail.com)$*@author$Author:SimoneGiannecchini(simboss1@gmail.com)$*@author$Author:BrentOwens*@authorJustinDeoliveira*/publicclassKMZMapOutputFormatextendsAbstractMapOutputFormat{/**OfficialKMZmimetype*/publicstaticfinalStringMIME_TYPE="application/vnd.google-earth.kmz";publicstaticfinalStringNL_KMZ_MIME_TYPE=KMZMapOutputFormat.MIME_TYPE+";mode=networklink";publicstaticfinalString[]OUTPUT_FORMATS={MIME_TYPE,/*NL_KMZ_MIME_TYPE,*/"application/vnd.google-earth.kmz+xml","kmz","application/vnd.google-earth.kmzxml"};privateWMSwms;privateStreamingKMLBuilderbuilder=newStreamingKMLBuilder();publicKMZMapOutputFormat(WMSwms){super(MIME_TYPE,OUTPUT_FORMATS);this.wms=wms;
ifencodingto<code>outStream</code>fails.*/@OverridepublicvoidformatImageOutputStream(RenderedImageoriginalImage,OutputStreamoutStream,WMSMapContentmapContent)throwsServiceException,IOException{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Writinggifimage...");
if(format.equalsIgnoreCase(IMAGE_GIF_SUBTYPE_ANIMATED)){animatedGIF=true;
if(originalImageinstanceofRenderedImageList){//converttolistril=(RenderedImageList)originalImage;//getnumberofimagesnumfiles=ril.size();
else{ril=newRenderedImageList(Arrays.asList(originalImage));
if(numfiles==1||!animatedGIF){
if(LOGGER.isLoggable(Level.FINE))LOGGER.fine("Preparingtowriteagif...");////Nowthemagic//try{originalImage=applyPalette(originalImage,mapContent,MIME_TYPE,false);ImageWorkeriw=newImageWorker(originalImage);iw.writeGIF(outStream,"LZW",0.75f);RasterCleaner.addImage(iw.getRenderedImage());
if(numfiles<=0){thrownewServiceException("ThenumberofframesforthisGIFislessthan1");
if(loopContinuouslyString==null){loopContinuouslyString=request.getFormatOptions().get(GIF_LOOP_CONTINUOSLY);
if(requestedDisposalMethod!=null){for(Stringmethod:WMS.DISPOSAL_METHODS){
if(method.equalsIgnoreCase(requestedDisposalMethod.trim())){disposalMethod=method;
if(disposalMethod=="backgroundColor"){disposalMethod="restoreToBackgroundColor";
else
if(disposalMethod=="previous"){disposalMethod="restoreToPrevious";
if(delay<=0)thrownewServiceException("AnimateGIFdelayinvalid:"+delay);////Gettinginputfiles//for(inti=0;i<numfiles;i++){
if(LOGGER.isLoggable(Level.FINE))LOGGER.fine("Writingimage"+i);//gettheimageRenderedImageri=(RenderedImage)ril.get(i);//convertittogifcompatibleri=applyPalette(ri,mapContent,MIME_TYPE,false);
if(ri!=null){//preparemetadataandwriteparamfinalIIOMetadataimageMetadata=gifWriter.getDefaultImageMetadata(newImageTypeSpecifier(ri),param);prepareMetadata(ri,imageMetadata,loopContinuosly,delay,disposalMethod);//writegifWriter.writeToSequence(newIIOImage(ri,null,imageMetadata),param);images.add(ri);
if(imageinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)image);
else
if(imageinstanceofBufferedImage){((BufferedImage)image).flush();
if(LOGGER.isLoggable(Level.FINE))LOGGER.fine("Donewritinganimatedgif");
if(icm.getTransparency()==Transparency.BITMASK&&(transparentColorIndex=icm.getTransparentPixel())>=0){graphicsControlExtensionNode.setAttribute("transparentColorIndex",String.valueOf(transparentColorIndex));graphicsControlExtensionNode.setAttribute("transparentColorFlag","TRUE");
else{graphicsControlExtensionNode.setAttribute("transparentColorIndex","0");graphicsControlExtensionNode.setAttribute("transparentColorFlag","FALSE");
iffoundoranewnodecreatedwiththegivenname.*/privatestaticIIOMetadataNodegetNode(IIOMetadataNoderootNode,StringnodeName){intnNodes=rootNode.getLength();for(inti=0;i<nNodes;i++){
if(rootNode.item(i).getNodeName().compareToIgnoreCase(nodeName)==0){return((IIOMetadataNode)rootNode.item(i));
if(IMAGE_GIF_SUBTYPE_ANIMATED.equals(outputFormat)){returnCAPABILITIES_ANIM;
else{returnCAPABILITIES;
if(serviceName!=null){for(RemoteProcessFactoryListenerlistener:getRemoteFactoryListeners()){listener.registerProcess(newRemoteServiceDescriptor(serviceName,"Service","Atestservice",null,null,metadata));
ifthisGetFeatureInfoproducercangeneratethemapformatspecifiedby<code>*mapFormat</code>,where<code>mapFormat</code>istheMIMEtypeoftherequestedresponse.**@parammapFormattheMIMEtypeoftherequiredoutputformat,mightbe{@codenull}*@returntrue
ifclasscanproduceamapinthepassedformat*/publicbooleancanProduce(StringmapFormat){returnthis.contentType.equalsIgnoreCase(mapFormat);
ifthesaveactioncan't*besuccessfullyperformed*/protectedabstractvoidonSave(WMTSStoreInfoinfo,AjaxRequestTargettarget)throwsIllegalArgumentException;@OverrideprotectedComponentAuthorizergetPageAuthorizer(){returnComponentAuthorizer.WORKSPACE_ADMIN;}}
ifmissingit'sthesameaskey*/publicstaticfinalStringPARAM_NAME="parameterName";publicstaticfinalStringMIN_INCLUSIVE="minInclusive";publicstaticfinalStringMAX_INCLUSIVE="maxInclusive";privatestaticfinalList<Parameter<?>>BASIC_OPENSEARCH;privatestaticfinalList<Parameter<?>>GEO_TIME_OPENSEARCH;static{BASIC_OPENSEARCH=basicOpenSearchParameters();GEO_TIME_OPENSEARCH=geoTimeOpenSearchParameters();try{OUTPUT_CRS=CRS.decode("urn:ogc:def:crs:EPSG:4326",false);
if(info.getMaximumRecordsPerPage()>0){count.maximumInclusive(info.getMaximumRecordsPerPage());
if(prefix!=null){
if((OS_PREFIX.equals(prefix))){
if(qualifyOpenSearchNative){returnprefix+":"+name;
else{returnname;
else
if(isProductClass(prefix)){//alltheEOparametersshouldbeputintheEOnamespacereturn"eo:"+name;
else{returnname;
if(pc.getPrefix().equals(prefix)){returntrue;
ifany**@paramp*@return*/publicstaticStringgetParameterPrefix(Parameterp){Stringprefix=p.metadata==null?null:(String)p.metadata.get(PARAM_PREFIX);returnprefix;
ifany,orthekeyotherwise**@paramp*@return*/publicstaticStringgetParameterName(Parameterp){Stringname=p.metadata==null?null:(String)p.metadata.get(PARAM_NAME);
if(name==null){name=p.key;
if(EO_PREFIX.equals(prefix)){namespace=OpenSearchAccess.EO_NAMESPACE;
else{//productparametermaybe?for(OpenSearchAccess.ProductClasspc:OpenSearchAccess.ProductClass.values()){
if(pc.getPrefix().equals(prefix)){namespace=pc.getNamespace();
if(theService!=null)theService.load();
ifthisobjectisregistered**@seeGeoServerUserGroupService#registerUserGroupLoadedListener(UserGroupLoadedListener)*/@OverridepublicvoidusersAndGroupsChanged(UserGroupLoadedEventevent){//avoidunnecessaryreloadssetLastModified(resource.lastmodified());LOGGER.info("Adjustedlastmodifiedforfile:"+path);}}
if(version!=null&&VERSION_11.equals(version)){returnMIMETYPE_11;
if(mimeType.equals(MIMETYPE_11)){returnVERSION_11;
if(version==null){Object[]versionAndReader=getVersionAndReader(input);version=(Version)versionAndReader[0];input=versionAndReader[1];
if(VERSION_11.compareTo(version)==0){returnparse11(input,resourceLocator,entityResolver);
else{returnparse10(input,resourceLocator,entityResolver);
ifwegrabone,but
ifit'safileithas//tostayassuchtoallowrelativeresourceresolutionduringtheparse
if(!(inputinstanceofFile)){reader=toReader(input);input=reader;
if(sld.getStyledLayers().length==0){//mostlikelyastylethatisnotavalidsld,trytoactuallyparseouta//styleandthenwrapitinansldStyle[]style=p.readDOM();
if(style.length>0){NamedLayerl=styleFactory.createNamedLayer();l.addStyle(style[0]);sld.addStyledLayer(l);
if(inputinstanceofFile){parser=newSLDParser(styleFactory,(File)input);
else{parser=newSLDParser(styleFactory,toReader(input));
if(resourceLocator!=null){parser.setOnLineResourceLocator(resourceLocator);
if(entityResolver!=null){parser.setEntityResolver(entityResolver);
if(resourceLocator==null&&inputinstanceofFile){//setupforresolutionofrelativepathsfinaljava.net.URLsurl=URLs.fileToUrl((File)input);DefaultResourceLocatordefResourceLocator=newDefaultResourceLocator();defResourceLocator.setSourceUrl(surl);resourceLocator=defResourceLocator;
if(locator!=null){sld=newSLDConfiguration(){protectedvoidconfigureContext(org.picocontainer.MutablePicoContainercontainer){container.registerComponentInstance(ResourceLocator.class,locator);};};
else{sld=newSLDConfiguration();
if(entityResolver!=null){parser.setEntityResolver(entityResolver);
if(version!=null&&VERSION_11.compareTo(version)==0){encode11(sld,pretty,output);
else{encode10(sld,pretty,output);
if(pretty){tx.setIndentation(2);
if(version==null){Object[]versionAndReader=getVersionAndReader(input);version=(Version)versionAndReader[0];input=versionAndReader[1];
if(version!=null&&VERSION_11.compareTo(version)==0){returnvalidate11(input,entityResolver);
else{returnvalidate10(input,entityResolver);
if(inputinstanceofInputStream){reader=RequestUtils.getBufferedXMLReader((InputStream)input,XML_LOOKAHEAD);
else{reader=RequestUtils.getBufferedXMLReader(toReader(input),XML_LOOKAHEAD);
if(!reader.ready()){returnnull;
if("version".equals(parser.getAttributeName(i))){version=parser.getAttributeValue(i);
if(version==null){LOGGER.warning("CouldnotdetermineSLDversionfromcontent.Assuming1.0.0");version="1.0.0";
if(username!=null){StaticUserAuthenticatorauth=newStaticUserAuthenticator(domain,username,password);FileSystemOptionsopts=newFileSystemOptions();DefaultFileSystemConfigBuilder.getInstance().setUserAuthenticator(opts,auth);fo=manager.resolveFile(location,opts);
else{fo=manager.resolveFile(location);
if(fo!=null){FileSystemfs=fo.getFileSystem();fo.close();manager.closeFileSystem(fs);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;RemoteDataother=(RemoteData)obj;
if(domain==null){
if(other.domain!=null)returnfalse;
else
if(!domain.equals(other.domain))returnfalse;
if(location==null){
if(other.location!=null)returnfalse;
else
if(!location.equals(other.location))returnfalse;
if(password==null){
if(other.password!=null)returnfalse;
else
if(!password.equals(other.password))returnfalse;
if(username==null){
if(other.username!=null)returnfalse;
else
if(!username.equals(other.username))returnfalse;returntrue;
if(!isComplex()){returnnull;
else{return((ComplexPPIO)getProcessParameterIO().get(0)).getMimeType();
if(workingDiretory!=null){executor.setWorkingDirectory(workingDiretory);
if(executor.isFailure(result)){//toStringcallisroutedtoByteArrayOutputStream,whichdoestherightstring//conversionthrownewIOException("Failedtoexecutecommand"+cmd.toString()+"\nStandardoutputis:\n"+os.toString()+"\nStandarderroris:\n"+es.toString());
if(getByteCount()>maxSize){return;
if(getByteCount()>maxSize){return;
if(getByteCount()>maxSize){return;
if(type.equals("FeatureTypeInfo")){sourceClass=KombuFeatureTypeInfo.class;
if(type.equals("WorkspaceInfo")){sourceClass=KombuWorkspaceInfo.class;
if(type.equals("NamespaceInfo")){sourceClass=KombuNamespaceInfo.class;
if(type.equals("LayerInfo")){sourceClass=KombuLayerInfo.class;
if(type.equals("WMSLayerInfo")){sourceClass=KombuWMSLayerInfo.class;
if(type.equals("StoreInfo")){sourceClass=KombuStoreInfo.class;
if(type.equals("CoverageInfo")){sourceClass=KombuCoverageInfo.class;
if(type.equals("LayerGroupInfo")){sourceClass=KombuLayerGroupInfo.class;
if(sourceClass!=null){ret=mapper.readValue(node.toString(),sourceClass);
ifweareexceeedingthedownloadlimitsforvector*data.Alsothisclasswritesthefeaturesintheoutputfile.**@authorSimoneGiannecchini,GeoSolutionsSAS*/classVectorDownload{privatestaticfinalLoggerLOGGER=Logging.getLogger(VectorDownload.class);/**The{@linkDownloadServiceConfiguration}objectcontainingtheconfiguredlimits.*/privateDownloadServiceConfigurationlimits;/**Theresourcemanagerforhandlingtheusedresources.*/privateWPSResourceManagerresourceManager;privateApplicationContextcontext;/***Constructor,takesa{@linkDownloadServiceConfiguration}anda{@linkWPSResourceManager}.**@paramlimitsthe{@linkDownloadServiceConfiguration}tocheckfornotexceedingthe*downloadlimits.*@paramresourceManagerthe{@linkWPSResourceManager}tohandlegeneratedresources*/publicVectorDownload(DownloadServiceConfigurationlimits,WPSResourceManagerresourceManager,ApplicationContextcontext){this.limits=limits;this.resourceManager=resourceManager;this.context=context;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("NativeCRSis"+nativeCRS.toWKT());
if(roi!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"PushingROItonativeCRS");
if(filter!=null){ra=filter;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Usingfilter"+ra);
ifwehaveoneSimpleFeatureCollectionoriginalFeatures;finalbooleanhasROI=roiManager!=null;
if(hasROI){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"AddingGeometryfilterwithROI");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Readingthefilteredfeatures");
if(targetCRS!=null&&!CRS.equalsIgnoreMetadata(nativeCRS,targetCRS)){roiManager.useTargetCRS(targetCRS);//testingreprojection...finalMathTransformtargetTX=CRS.findMathTransform(nativeCRS,targetCRS,true);
if(!targetTX.isIdentity()){//avoiddoingthetransform
ifthisistheidentity
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Reprojectingfeatures");
else{reprojectedFeatures=originalFeatures;DownloadUtilities.checkIsEmptyFeatureCollection(reprojectedFeatures);
else{reprojectedFeatures=originalFeatures;
if(hasROI){roiManager.useTargetCRS(nativeCRS);
if(clip&&roi!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Clippingfeatures");
else{clippedFeatures=reprojectedFeatures;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Writingfeatures");
if(ppio_==null){thrownewProcessException("Don'tknowhowtoencodeinmimetype"+mimeType);
else
if(!(ppio_instanceofComplexPPIO)){thrownewProcessException("InvalidPPIOfound"+ppio_.getIdentifer());
if(limits.getHardOutputLimit()>0){limit=limits.getHardOutputLimit();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Hardoutputlimitssetto"+limit);
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Hardoutputlimitunset");
if(ppio_instanceofComplexPPIO){extension="."+((ComplexPPIO)ppio_).getFileExtension();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Writingfileinatemporaryfolder");
if(limit>DownloadServiceConfiguration.NO_LIMIT){os=newLimitedOutputStream(bufferedOutputStream,limit){@OverrideprotectedvoidraiseError(longpSizeMax,longpCount)throwsIOException{IOExceptionioe=newIOException("DownloadExceededthemaximumHARDallowedsize!");throwioe;
else{os=bufferedOutputStream;
if(ppio_instanceofComplexPPIO){((ComplexPPIO)ppio_).encode(features,os);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Flushingstream");
if(os!=null){IOUtils.closeQuietly(os);
if(("char".equals(typeName)||"varchar".equals(typeName))&&rsmd.getColumnDisplaySize(i)>0&&rsmd.getColumnDisplaySize(i)<Integer.MAX_VALUE){sb.append("(").append(rsmd.getColumnDisplaySize(i)).append(")");
switch(sourcedb.getDialect().isNullable(rsmd.isNullable(i))){caseResultSetMetaData.columnNoNulls:sb.append("NOTNULL");break;caseResultSetMetaData.columnNullable:sb.append("NULL");break;
if(!hasPrimaryKeyColumn){//createaPrimarykeycolumn
ifnoneexist.sb.append(GENERATE_ID_COLUMN_NAME+"intPRIMARYKEY,");columnCount++;
if(indexAndColumnMap.isEmpty()&&!spatialColumns.isEmpty()){sb.append(targetdb.getDialect().createIndex(tempTableName,spatialColumns,true,false));
if(i>0){sb.append(",");
if(!hasPrimaryKeyColumn){pstmt.setObject(columnCount,primaryKeyValue);
if(batchSize>=BATCH_SIZE){pstmt.executeBatch();batchSize=0;
if(batchSize>0){pstmt.executeBatch();
ifnecessarytry(Connectionconn=targetdb.getDataSource().getConnection()){try(Statementstmt=conn.createStatement()){stmt.executeUpdate("DROPTABLEIFEXISTS"+targetdb.getDialect().quote(tempTableName));
if(conn.getMetaData().storesUpperCaseIdentifiers()){name=name.toUpperCase();
else
if(conn.getMetaData().storesUpperCaseIdentifiers()){name=name.toLowerCase();
if(conn.getMetaData().storesUpperCaseIdentifiers()){schema=schema.toUpperCase();
else
if(conn.getMetaData().storesUpperCaseIdentifiers()){schema=schema.toLowerCase();
if(sb.length()>2){sb.setLength(sb.length()-2);
ifthereisnoprimarykeycolumndefined.Check
ifthereisageneratedkeycolumn//available
if(sb.length()<2){ResultSetrsColumns=conn.getMetaData().getColumns(null,schema,name,null);while(rsColumns.next()){
if(GENERATE_ID_COLUMN_NAME.equalsIgnoreCase(rsColumns.getString("COLUMN_NAME"))){returnGENERATE_ID_COLUMN_NAME;
if(!result.containsKey(indexName)){result.put(indexName,newHashSet<>());
if(iteminstanceofResource){Resourceres=(Resource)item;returnres.getType()==Type.DIRECTORY;
if(item.layerInfo!=null){returnitem.layerInfo.prefixedName();
if(item.groupInfo!=null){returnitem.groupInfo.prefixedName();
if(getKeywords()!=null&&getKeywords().length>0){//Useauniquekeyfordifferentqueriesreturncache.get(KEY_SIZE+"."+String.join(",",getKeywords()),sizeCaller);
if(iteratorinstanceofCloseableIterator){//don'tknowhowtoforcewickettoclosetheiterator,letsreturn//acopy.Shouldn'tbemuchoverheadaswe'repagingtry{returnLists.newArrayList(iterator).iterator();
else{returniterator;
if(sort!=null){
if(propertyinstanceofBeanProperty){finalStringsortProperty=((BeanProperty<PreviewLayer>)property).getPropertyPath();sortOrder=sortBy(sortProperty,sort.isAscending());
else
if(property==NAME){sortOrder=sortBy("prefixedName",sort.isAscending());
if(inputinstanceofLayerInfo){returnnewPreviewLayer((LayerInfo)input);
else
if(inputinstanceofLayerGroupInfo){returnnewPreviewLayer((LayerGroupInfo)input);
if(temporaryName!=null){localPart=temporaryName.getLocalPart();usesTemporary=true;
if(!wstore.getConfiguredStoredQueries().containsValue(localPart)){wstore.addStoredQuery(localPart,sqc.getStoredQueryId());
ifanerroroccursinencodingmap*/publicvoidencode(finalOutputStreamout)throwsIOException{//initializesthewriterthis.writer=newHTMLImageMapWriter(out,mapContent);longt=System.currentTimeMillis();try{//encodesthedifferentlayerswriteLayers();this.writer.flush();t=System.currentTimeMillis()-t;LOGGER.info("HTMLImageMapgeneratedin"+t+"ms");
ifthereare>//"getMaxFiltersToSendToDatastore"rules//
ifso,thenwedontdoanythingsincenomatterwhatthere'stoo//manytosenddown.//nextwecheckforany
elserules.Ifwefindany-->dontsend//anythingtoDatastore//nextwecheckforrulesw/ofilters.Ifwefindany-->dontsend//anythingtoDatastore////otherwise,we'regoldandcan"or"togetherallthefitersthen//ANDitwiththeoriginalfilter.//ie.SELECT*FROM...WHERE(the_geom&&BBOX)AND(filter1OR//filter2ORfilter3);finalList<Filter>filtersToDS=newArrayList<Filter>();finalintstylesLength=styles.length;intstyleRulesLength;FeatureTypeStylestyle;intu=0;Ruler;for(intt=0;t<stylesLength;t++)//lookateach//featuretypestyle{style=styles[t];Rule[]rules=style.getRules();styleRulesLength=rules.length;for(u=0;u<styleRulesLength;u++)//lookateach//ruleinthe//featuretypestyle{r=rules[u];
if(r.getFilter()==null)returnnull;//uh-ohhasnofilter(wantallrows)
if(r.hasElseFilter())returnnull;//uh-ohhaselseRulefiltersToDS.add(r.getFilter());
if(filtersToDS.size()==1)//specialcaseof1filter{ruleFiltersCombined=filtersToDS.get(0);//ORallfilters
iftheyareundermaxFilterSizeinnumber,else,donotfilter
else
if(filtersToDS.size()<maxFilterSize){//builditupruleFiltersCombined=filtersToDS.get(0);finalintsize=filtersToDS.size();for(intt=1;t<size;t++)//NOTE:dont//redo1stone{newFilter=filtersToDS.get(t);ruleFiltersCombined=filterFactory.or(ruleFiltersCombined,newFilter);
if((featureTypeStyles==null)||(featureTypeStyles.length==0)){returnnewFeatureTypeStyle[0];
if(rules!=null)rules=filterRules(rules);//doesthisstylehaveanyrules
if(rules==null||rules.length==0){continue;
if(featureType.getTypeName().equalsIgnoreCase(featureTypeName)||FeatureTypes.isDecendedFrom(featureType,null,featureTypeName)){filtered.add(featureTypeStyle);
ifthesuppliedscaleDenominatoriscongruentwitharuledefinedscalerange.**@paramrcurrentrule*@paramscaleDenominatorcurrentvaluetoverify*@returntrue
ifscaleDenominatorisintheruledefinedrange*/publicstaticbooleanisWithInScale(Ruler,doublescaleDenominator){return((r.getMinScaleDenominator())<=scaleDenominator)&&((r.getMaxScaleDenominator())>scaleDenominator);
if(EncodeHTMLImageMap.isWithInScale(rule,scaleDenominator)){result.add(rule);
ifanerroroccursduringencoding*@throwsAbortedException
iftheencodingisaborted*@taskTODO:respectlayerfilteringgivenbytheirStyles*/@SuppressWarnings("unchecked")privatevoidwriteLayers()throwsIOException,AbortedException{for(Layerlayer:mapContent.layers()){SimpleFeatureSourcefSource;fSource=(SimpleFeatureSource)layer.getFeatureSource();SimpleFeatureTypeschema=fSource.getSchema();/*FeatureSourcefSource=layer.getFeatureSource();FeatureTypeschema=fSource.getSchema();*/try{ReferencedEnvelopeaoi=mapContent.getRenderingArea();CoordinateReferenceSystemsourceCrs=schema.getGeometryDescriptor().getCoordinateReferenceSystem();booleanreproject=(sourceCrs!=null)&&!CRS.equalsIgnoreMetadata(aoi.getCoordinateReferenceSystem(),sourceCrs);
if(reproject){aoi=aoi.transform(sourceCrs,true);
if(!definitionQuery.equals(Query.ALL)){
if(q.equals(Query.ALL)){q=(Query)definitionQuery;
else{q=(Query)DataUtilities.mixQueries(definitionQuery,q,"HTMLImageMapEncoder");
if(ruleFilter!=null){//combinewiththegeometryfilter(preexisting)ruleFilter=filterFactory.and(q.getFilter(),ruleFilter);//settheactualfilter//q.setFilter(ruleFilter);q=newDefaultQuery(schema.getTypeName(),ruleFilter);//q=(Query)DataUtilities.mixQueries(new//Query(schema.getTypeName(),ruleFilter),q,"HTMLImageMapEncoder");
if(reproject){fColl=newReprojectFeatureResults(fSource.getFeatures(q),mapContent.getCoordinateReferenceSystem());
elsefColl=fSource.getFeatures(q);//encodesthecurrentlayer,usingthedefinedstylewriter.writeFeatures(fColl,ftsList);writer.write("</map>\n");
if(!isNew()){doBackup(jobExecution,geoserver,dd,resourceStore);
else{doRestore(jobExecution,geoserver,dd);
if(!skipSettings){//StoreGeoServerGlobalInfodoWrite(geoserver.getGlobal(),targetBackupFolder,"global.xml");//StoreGeoServerGlobalSettingsdoWrite(geoserver.getSettings(),targetBackupFolder,"settings.xml");//StoreGeoServerGlobalLoggingSettingsdoWrite(geoserver.getLogging(),targetBackupFolder,"logging.xml");//StoreGeoServerGlobalServicesfor(ServiceInfoservice:geoserver.getServices()){//LocalServiceswillbesavedlateron...
if(service.getWorkspace()==null){doWrite(service,targetBackupFolder,"services");
if(filteredWorkspace(getCatalog().getDefaultWorkspace())){doWrite(getCatalog().getDefaultNamespace(),targetWorkspacesFolder,"defaultnamespace.xml");doWrite(getCatalog().getDefaultWorkspace(),targetWorkspacesFolder,"default.xml");
if(filteredWorkspace(ws)){
if(geoserver.getSettings(ws)!=null){doWrite(geoserver.getSettings(ws),BackupUtils.dir(targetWorkspacesFolder,ws.getName()),"settings.xml");
if(geoserver.getServices(ws)!=null){for(ServiceInfoservice:geoserver.getServices(ws)){doWrite(service,targetWorkspacesFolder,ws.getName());
if(Resources.exists(styResource)){Resources.copy(styResource.file(),BackupUtils.dir(targetWorkspacesFolder.get(ws.getName()),"styles"));
if(configFile!=null&&Resources.exists(configFile)){ResourcetargetDir=Files.asResource(targetGeoServerResourceLoader.findOrCreateDirectory(Paths.convert(dd.getResourceLoader().getBaseDirectory(),configFile.parent().dir())));Resources.copy(configFile.file(),targetDir);
if(!skipGWC){try{
if(GeoServerExtensions.bean("gwcGeoServervConfigPersister")!=null){backupGWCSettings(targetBackupFolder);
if(Resources.exists(sourceWorkspacesFolder.get("default.xml"))){NamespaceInfonewDefaultNamespace=(NamespaceInfo)doRead(sourceWorkspacesFolder,"defaultnamespace.xml");WorkspaceInfonewDefaultWorkspace=(WorkspaceInfo)doRead(sourceWorkspacesFolder,"default.xml");getCatalog().setDefaultNamespace(newDefaultNamespace);getCatalog().setDefaultWorkspace(newDefaultWorkspace);
if(!isDryRun()){try{hardRestore(geoserver,dd,sourceRestoreFolder,sourceWorkspacesFolder,newGeoServerInfo,newLoggingInfo);
else{//DRY-RUN-MODEON:Trytocheckbackupfilesconsistencyasmuchaspossibletry{//TemporaryGeoServerDataDirjustfortestingGeoServerDataDirectorytd=newGeoServerDataDirectory(BackupUtils.tmpDir().dir());softRestore(geoserver,td,sourceRestoreFolder,sourceWorkspacesFolder,newGeoServerInfo,newLoggingInfo);
if(!skipSettings){//RestoreGeoServerGlobalInfoFiles.delete(dd.get("global.xml").file());doWrite(newGeoServerInfo,dd.get(Paths.BASE),"global.xml");geoserver.setGlobal(newGeoServerInfo);//RestoreGeoServerGlobalLoggingSettingsFiles.delete(dd.get("logging.xml").file());doWrite(newLoggingInfo,dd.get(Paths.BASE),"logging.xml");geoserver.setLogging(newLoggingInfo);restoreGlobalServices(sourceRestoreFolder,dd);
if(purge){Files.delete(workspaces.dir());workspaces=BackupUtils.dir(dd.get(Paths.BASE),"workspaces");
if(purge){Files.delete(styles.dir());styles=BackupUtils.dir(dd.get(Paths.BASE),"styles");
ifpurge
if(purge){Files.delete(layerGroups.dir());layerGroups=BackupUtils.dir(dd.get(Paths.BASE),"layergroups");
if(!skipGWC){try{
if(GeoServerExtensions.bean("gwcGeoServervConfigPersister")!=null){restoreGWCSettings(sourceRestoreFolder,dd.get(Paths.BASE));//InitializeGWCwiththenewsettingsGWCInitializergwcInitializer=GeoServerExtensions.bean(GWCInitializer.class);
if(gwcInitializer!=null){gwcInitializer.initialize(geoserver);
if(GeoServerExtensions.bean("gwcGeoServervConfigPersister")!=null){restoreGWCSettings(sourceRestoreFolder,td.get(Paths.BASE));
ifexists)
if(Resources.exists(rstConfigFile)){Resources.copy(rstConfigFile.file(),configFile.parent());
if(filteredWorkspace(ws)){ResourcewsFolder=BackupUtils.dir(sourceWorkspacesFolder,ws.getName());SettingsInfowsSettings=null;
if(Resources.exists(wsFolder.get("settings.xml"))){wsSettings=(SettingsInfo)doRead(wsFolder,"settings.xml");
if(wsSettings!=null){wsSettings.setWorkspace(ws);
if(!isDryRun()){geoserver.add(wsSettings);doWrite(geoserver.getSettings(ws),dd.get(Paths.path("workspaces",ws.getName())),"settings.xml");
else{doWrite(wsSettings,dd.get(Paths.path("workspaces",ws.getName())),"settings.xml");
if(!"settings.xml".equals(res.name())&&res.name().endsWith(".xml")){returntrue;
if(localService!=null){localService.setWorkspace(ws);
if(!isDryRun()){geoserver.add(localService);
if(Resources.exists(styResource)){Resources.copy(styResource.file(),wsLocalStyleFolder);
if(lyg.getWorkspace()==null){doWrite(lyg,layerGroups,lyg.getName()+".xml");
if(sty.getWorkspace()==null){doWrite(sty,styles,sty.getName()+".xml");ResourcestyResource=sourceRestoreFolder.get(Paths.path("styles",sty.getFilename()));
if(Resources.exists(styResource)){Resources.copy(styResource.file(),styles);
if(service!=null&&service.getWorkspace()==null){Files.delete(td.get(serviceResource.name()).file());Resources.copy(sourceRestoreFolder.get(Paths.path("services",serviceResource.name())).file(),td.get(Paths.BASE));
if(filteredWorkspace(ws)){//RestoreWorkspaceandNamespaceconfifuration//-PrepareFolderFiles.delete(workspaces.get(ws.getName()).dir());ResourcewsFolder=BackupUtils.dir(workspaces,ws.getName());doWrite(getCatalog().getNamespaceByPrefix(ws.getName()),wsFolder,"namespace.xml");doWrite(ws,wsFolder,"workspace.xml");//RestoreDataStores/CoverageStoresfor(DataStoreInfods:getCatalog().getStoresByWorkspace(ws.getName(),DataStoreInfo.class)){//-PrepareFolderResourcedsFolder=BackupUtils.dir(wsFolder,ds.getName());ds.setWorkspace(ws);doWrite(ds,dsFolder,"datastore.xml");//RestoreResourcesfor(FeatureTypeInfoft:getCatalog().getFeatureTypesByDataStore(ds)){//-PrepareFolderFiles.delete(dsFolder.get(ft.getName()).dir());ResourceftFolder=BackupUtils.dir(dsFolder,ft.getName());doWrite(ft,ftFolder,"featuretype.xml");//RestoreLayersfor(LayerInfoly:getCatalog().getLayers(ft)){doWrite(ly,ftFolder,"layer.xml");
if(Resources.exists(providerConfigFile)&&FileUtils.sizeOf(providerConfigFile.file())>0){Resources.copy(gwcProvider.in(),targetGWCProviderBackupDir,providerConfigFile.name());
if(gwcCatalog!=null){finalXMLConfigurationgwcXmlPersisterFactory=(XMLConfiguration)GeoServerExtensions.bean("gwcXmlConfig");finalGeoServerResourceLoaderresourceLoader=newGeoServerResourceLoader(targetBackupFolder.dir());finalDefaultTileLayerCataloggwcBackupCatalog=newDefaultTileLayerCatalog(resourceLoader,gwcXmlPersisterFactory);for(StringlayerName:gwcCatalog.getLayerNames()){GeoServerTileLayerInfogwcLayerInfo=gwcCatalog.getLayerByName(layerName);//PersisttheGWCLayerInfointothebackupfolderbooleanpersistResource=false;LayerInfolayerInfo=getCatalog().getLayerByName(layerName);
if(layerInfo!=null){WorkspaceInfows=layerInfo.getResource()!=null&&layerInfo.getResource().getStore()!=null&&layerInfo.getResource().getStore().getWorkspace()!=null?getCatalog().getWorkspaceByName(layerInfo.getResource().getStore().getWorkspace().getName()):null;
if(!filteredResource(layerInfo,ws,true)){persistResource=true;
else{LayerGroupInfolayerGroupInfo=getCatalog().getLayerGroupByName(layerName);
if(layerGroupInfo!=null){WorkspaceInfows=layerGroupInfo.getWorkspace()!=null?getCatalog().getWorkspaceByName(layerGroupInfo.getWorkspace().getName()):null;
if(!filteredResource(layerGroupInfo,ws,false)){persistResource=true;
if(persistResource){gwcBackupCatalog.save(gwcLayerInfo);
if(Resources.exists(providerConfigFile)&&FileUtils.sizeOf(providerConfigFile.file())>0){Resources.copy(providerConfigFile.in(),targetGWCProviderRestoreDir,providerConfigFile.name());
if(gwcCatalog!=null){
if(isDryRun()){BiMap<String,String>baseBiMap=HashBiMap.create();layersByName=Maps.synchronizedBiMap(baseBiMap);
if(layerInfo!=null){WorkspaceInfows=layerInfo.getResource()!=null&&layerInfo.getResource().getStore()!=null&&layerInfo.getResource().getStore().getWorkspace()!=null?getCatalog().getWorkspaceByName(layerInfo.getResource().getStore().getWorkspace().getName()):null;
if(!filteredResource(layerInfo,ws,true)){restoreGWCTileLayerInfo(gwcCatalog,layersByName,layerName,gwcLayerInfo,layerInfo.getId());
else{LayerGroupInfolayerGroupInfo=getCatalog().getLayerGroupByName(layerName);
if(layerGroupInfo!=null){WorkspaceInfows=layerGroupInfo.getWorkspace()!=null?getCatalog().getWorkspaceByName(layerGroupInfo.getWorkspace().getName()):null;
if(!filteredResource(layerGroupInfo,ws,false)){restoreGWCTileLayerInfo(gwcCatalog,layersByName,layerName,gwcLayerInfo,layerGroupInfo.getId());
if(!isDryRun()){//-DepersisttheGWCLayerInfointotherestorefolderGeoServerTileLayerInfooldValue=gwcCatalog.getLayerByName(layerName);gwcCatalog.delete(oldValue.getId());//-UpdatetheIDgwcLayerInfo.setId(layerID);gwcCatalog.save(gwcLayerInfo);
else{
if(layersByName.get(layerName)==null){layersByName.put(layerName,layerID);
else{//-WarningorExceptionthrownewIllegalArgumentException("TileLayerwithsamenamealreadyexists:"+layerName+":<"+layerID+">");
ifthefactoryisallowed,null
iffactory*istobefilteredout.**<p>Thefactoryprovidedbythismethodmighthavebeenwrappedalreadybyanotherfilter,so*don'tassumeit'spossibletomakeaninstance-ofcheckagainstittorecognizeaparticular*factory.Incase{@linkDelegatingProcessFactory}isusedthe{@link*DelegatingProcessFactory#getInnermostDelegate()}methodcanbeusedtoreachtheoriginal*factory**@parampf*/ProcessFactoryfilterFactory(ProcessFactorypf);}
ifaspecificlocationwassetusingpropertiesGEOWEBCACHE_CONFIG_DIR*andGEOWEBCACHE_CACHE_DIR,thenwewillcheck
ifalocationwasprovidedandthenfallbackon*thedefaultlocation.*/privatestaticResourceinferConfigDirectory(ResourceStoreresourceStore,StringprovidedConfigDirectory){//check
ifaspecificlocationwasprovidedusingacontextpropertyotherwiseusethe//provideddirectoryStringconfigDirectoryPath=findFirstDefined(GEOWEBCACHE_CONFIG_DIR_PROPERTY,GEOWEBCACHE_CACHE_DIR_PROPERTY).orElse(providedConfigDirectory);//
iftheconfigurationdirectorystillsnotdefinedweusethedefaultlocation
if(configDirectoryPath==null){configDirectoryPath=DEFAULT_CONFIGURATION_DIR_NAME;
if(configurationDirectory.isAbsolute()){returnResources.fromPath(configurationDirectory.getAbsolutePath());
ifnopropertyisdefinedinthecurrentcontext.*/privatestaticOptional<String>findFirstDefined(String...propertiesNames){for(StringpropertyName:propertiesNames){//looksthepropertyusingGeoServerextensionsmechanismStringpropertyValue=GeoServerExtensions.getProperty(propertyName);
if(propertyValue!=null){//thispropertyisdefinedsolet'suseisvalueLOGGER.debug(String.format("Property'%s'issetwithvalue'%s'.",propertyName,propertyValue));returnOptional.of(propertyValue);
if(Resources.exists(xmlFile)){LOGGER.info("Foundconfigurationfilein"+configDirectory.path());
else
if(templateLocation!=null){LOGGER.warn("Foundnoconfigurationfileinconfigdirectory,willcreateoneat'"+xmlFile.path()+"'fromtemplate"+getClass().getResource(templateLocation).toExternalForm());//grabtemplatefromclasspathtry{IOUtils.copy(getClass().getResourceAsStream(templateLocation),xmlFile.out());
if(configFileName.equals(res.name())){returnfalse;
if(res.name().startsWith(configFileName)&&res.name().endsWith(".bak")){returntrue;
if(previousBackUps.size()>maxBackups){Collections.sort(previousBackUps,newComparator<Resource>(){@Overridepublicintcompare(Resourceo1,Resourceo2){return(int)(o1.lastmodified()-o2.lastmodified());
ifallgeometriesshouldbewrittenasblocks//(faster)oronlywhentheyaretoocomplex(slower)protectedbooleangeometryAsBlock=false;//flagtochoose
iffeatureattributesshouldbewrittentofile//Thisforcesallfeaturestobeconvertedtoblocks,since//attributesaretighttoBLOCK/INSERTprotectedbooleanwriteAttributes=false;//arrayofcyclicallyusedcolors(specifiedasautocadcolorindexes)//eachcolorisassignedtoalayeruntilthereareelements//available,thentheyarereusedagainprotectedint[]colors=newint[]{7,1,2,3,4,5,6,8,9};//arrayofcyclicallyusedlinetypesprotectedLineType[]lineTypes=newLineType[]{newLineType("CONTINUOUS","Solidline")};//currentlayercolor(indexinthecolorsarray)privateintcolorPos=0;//currentlayerlinetype(indexinthelineTypesarray)privateintltypePos=0;//listofnamestobeassignedtoexportlayersprivateString[]layerNames=null;//counterusedtonamelayers,
ifnolayernamelistisgiven//asanoptionintlayerCounter=0;//assignednames(id->name),usedtoreferencelayers//indifferentstepsofthedxfwritingprivateMap<String,String>cachedNames=newHashMap<String,String>();//cachedglobalenvelopeprivateReferencedEnvelopee=null;//handlecounters//eachtypeofobjectneedsaseparatehandlespace,to//avoidconflicts,sowemantainasetofcounters//fordifferentkinkofobjectsMap<String,Integer>handles=newHashMap<String,Integer>();/***Createanewinstanceofthewriter,usingthegivenunderlyingwriter.**@paramwriter*/publicabstractDXFWriternewInstance(Writerwriter);/***Verifies
ifthewritersupportstherequestdxfversion.**@paramversion*/publicbooleansupportsVersion(Stringversion){
if(version==null)returntrue;returnfalse;
if(encoding!=null)this.encoding=encoding;//initializenumberformatsformat=NumberFormat.getInstance(Locale.US);//thismaynotbeenoughforlatlon.Attheequator,0.01°approx.1100m//tohaveanaccuracyofcm,7isneeded//TODO:useCRSinformationtoadaptthisvalueformat.setMaximumFractionDigits(7);format.setGroupingUsed(false);format.setMinimumFractionDigits(1);ltypeFormat=NumberFormat.getInstance(Locale.US);ltypeFormat.setMaximumFractionDigits(4);ltypeFormat.setGroupingUsed(false);ltypeFormat.setMinimumFractionDigits(1);dateFormat=NumberFormat.getInstance(Locale.US);dateFormat.setMaximumFractionDigits(10);dateFormat.setGroupingUsed(false);dateFormat.setMinimumFractionDigits(1);
if(e==null){for(inti=0;i<featureList.size();i++){FeatureCollectioncollection=(FeatureCollection)featureList.get(i);
if(e==null){e=collection.getBounds();
else{e.expandToInclude(collection.getBounds());
if(pEnv!=null){//
ifit'sempty,geta1meterenvelopearoundit
if(pEnv.getWidth()==0&&pEnv.getHeight()==0){//nofeaturesornogeom,enablecreationofvalidemptyfileatleastpEnv.init(0d,1d,0d,1d);
else{//nodata,enablecreationofemptyfileatleastpEnv=newReferencedEnvelope();pEnv.init(0d,1d,0d,1d);
if(tpl!=null){BufferedReaderreader=newBufferedReader(newInputStreamReader(tpl));Stringline=null;while((line=reader.readLine())!=null)writer.write(line+EOL);
if(name==null){name=layerNames[layerCounter];
if(name.equals(""))name="LAYER"+layerCounter;layerCounter++;storeCachedName(coll.hashCode()+"",name);
if(colorPos<(colors.length-1))colorPos++;
elsecolorPos=0;returncolor;
if(ltypePos<(lineTypes.length-1))ltypePos++;
elseltypePos=0;returnltype;
if*specified.**@paramgeometryName*@paramlayer*@paramownerHandle*@throwsIOException*/protectedvoidwriteGeometryStart(StringgeometryName,Stringlayer,StringownerHandle,intlineType,intcolor)throwsIOException{writeGroup(0,geometryName);writeHandle("Geometry");
if(ownerHandle!=null)writeOwnerHandle(ownerHandle);writeSubClass("AcDbEntity");writeLayer(layer);
if(lineType!=-1)writeLineType(lineType);
if(color!=-1)writeColor(7);
if(!Double.isNaN(z))writeDoubleGroup(baseCode+20,z);
if(optionName.equalsIgnoreCase("geometryasblock")){setGeometryAsBlock(((Boolean)optionValue).booleanValue());
else
if(optionName.equalsIgnoreCase("colors")){setColors((int[])optionValue);
else
if(optionName.equalsIgnoreCase("linetypes")){setLineTypes((LineType[])optionValue);
else
if(optionName.equalsIgnoreCase("layers")){setLayerNames((String[])optionValue);
else
if(optionName.equalsIgnoreCase("writeattributes")){setWriteAttributes((Boolean)optionValue);
else{System.err.println("unknownoption"+optionName);
ifsubclassingworks**@authorchristian*/publicclassMemoryGeoserverRoleextendsGeoServerRole{/***/privatestaticfinallongserialVersionUID=1L;publicMemoryGeoserverRole(Stringrole){super(role);}}
if(layerInfo==null){LOGGER.warning("Couldnotlocatepreviouslayer"+name+",skippingremovalofoldpublishingconfiguration");return;
ifithasthestylethecodenormallyattachesStyleInfosi=layerInfo.getDefaultStyle();
if(si.getWorkspace()!=null&&previousLayer.getWorkspace().equals(si.getWorkspace().getName())&&previousLayer.getLayer().equals(si.getName())){visitor.visit(si);
if(resourceInfo==null){LOGGER.warning("Locatedlayer"+name+",butitreferencesadanglingresource,cannotperformfullremoval,limiting"+"tolayerremoval");visitor.visit(layerInfo);return;
else
if(!(resourceInfoinstanceofCoverageInfo)){thrownewRuntimeException("Unexpected,theoldlayerinconfiguration,"+name+",isnotacoverage,bailingout");
ifwehaveastoreStoreInfostoreInfo=resourceInfo.getStore();
if(storeInfo==null){LOGGER.warning("Locatedlayer"+name+",butitreferencesadanglingstore,cannotperformfullremoval,limiting"+"tolayerandresourceremoval");visitor.visit((CoverageInfo)resourceInfo);return;
ifneededfinalStringrelativePath="data/"+layer.getWorkspace()+"/"+layer.getLayer();ResourcemosaicDirectory=rl.fromPath(relativePath);
if(mosaicDirectory.getType()!=Type.UNDEFINED){mosaicDirectory.dir();
if(layer.isSeparateBands()){configureSeparateBandsMosaic(collection,layer,relativePath,mosaicDirectory);
else{configureSimpleMosaic(collection,layer,relativePath,mosaicDirectory);
if(format==null){thrownewRestException("Couldnotfindacoveragereaderabletoprocess"+file.getAbsolutePath(),HttpStatus.PRECONDITION_FAILED);
if(reader==null){thrownewRestException("Couldnotfindacoveragereaderabletoprocess"+file.getAbsolutePath(),HttpStatus.PRECONDITION_FAILED);
if(reader!=null){reader.dispose();
if(imageReader!=null){spi=imageReader.getOriginatingProvider();
if(spi!=null){mosaicConfig.put("SuggestedSPI",spi.getClass().getName());
if(layerConfiguration.isHeterogeneousCRS()){mosaicConfig.put("HeterogeneousCRS","true");mosaicConfig.put("MosaicCRS","EPSG:4326"/*layerConfiguration.getMosaicCRS()*/);mosaicConfig.put("CrsAttribute","crs");//
ifthere//isnoindexer.propertiesaround,even
ifnocollectionisactuallydonebuildIndexer(collection,mosaicDirectory);//mosaicdatastoreconnectioncreateDataStoreProperties(collection,mosaicDirectory);//themosaicdatastoreitselfCatalogBuildercb=newCatalogBuilder(catalog);CoverageStoreInfomosaicStoreInfo=createMosaicStore(cb,collection,layerConfiguration,relativePath);//andfinallythelayer,withacoverageviewassociatedtoitList<CoverageBand>coverageBands=buildCoverageBands(layerConfiguration);finalStringcoverageName=layerConfiguration.getLayer();finalCoverageViewcoverageView=newCoverageView(coverageName,coverageBands);CoverageInfocoverageInfo=coverageView.createCoverageInfo(coverageName,mosaicStoreInfo,cb);timeEnableResource(coverageInfo);finalLayerInfolayerInfo=cb.buildLayer(coverageInfo);catalog.add(coverageInfo);catalog.add(layerInfo);//configurethestyle
ifneededcreateStyle(layerConfiguration,layerInfo);
if(firstFeature==null){thrownewRestException("Couldnotlocateanygranuleforcollection'"+collection+"'andband'"+band+"'",HttpStatus.EXPECTATION_FAILED);
if(!file.exists()){thrownewRestException("Samplegranule'"+location+"'couldnotbefoundonthefilesystem,checkyourdatabase",HttpStatus.EXPECTATION_FAILED);
if(firstFeature==null){thrownewRestException("Cannotconfigureamosaic,pleaseaddatleastoneproduct"+"withgranulesinordertosetitup",HttpStatus.PRECONDITION_FAILED);
ifneededcreateStyle(layerConfiguration,layerInfo);
if(layerConfiguration.isHeterogeneousCRS()){indexer.put("HeterogeneousCRS","true");indexer.put("MosaicCRS","EPSG:4326"/*layerConfiguration.getMosaicCRS()*/);indexer.put("CrsAttribute","crs");//
if(browseBands!=null&&browseBands.length>0&&!Arrays.equals(defaultBands,browseBands)){RasterSymbolizerBuilderrsb=newRasterSymbolizerBuilder();
if(browseBands.length==1){ChannelSelectionBuildercs=rsb.channelSelection();cs.gray().channelName(""+getBandIndex(browseBands[0],bands,defaultBands));
else
if(browseBands.length==3){ChannelSelectionBuildercs=rsb.channelSelection();cs.red().channelName(""+getBandIndex(browseBands[0],bands,defaultBands));cs.green().channelName(""+getBandIndex(browseBands[1],bands,defaultBands));cs.blue().channelName(""+getBandIndex(browseBands[2],bands,defaultBands));
if(bands==null||bands.length==0){lookup=defaultBands;
if(band.equals(lookup[i])){returni+1;
if(invocations>2){//wearedonereturnRepeatStatus.FINISHED;
ifthecontentsarecorrect.Whenno*typenamespecified,itshouldreturnimportsforallnamespacesinvolved.Iftypenameis*specified,itshouldreturnimportsofGMLtypeandthetype'stoplevelschema.**@throwsIOException*/@TestpublicvoidtestDescribeFeatureType()throwsIOException{/**gsml:MappedFeature*/Documentdoc=getAsDOM("wfs?request=DescribeFeatureType&version=1.1.0&typename=gsml:MappedFeature");LOGGER.info("WFSDescribeFeatureType,typename=gsml:MappedFeatureresponse:\n"+prettyString(doc));assertEquals("xsd:schema",doc.getDocumentElement().getNodeName());//checktargetnamespaceisencodedandiscorrectassertXpathEvaluatesTo(AbstractAppSchemaMockData.GSML_URI,"//@targetNamespace",doc);//makesurethecontentisonlyrelevantincludeassertXpathCount(1,"//xsd:include",doc);//noimporttoGMLsinceit'salreadyimportedinsidetheincludedschema//otherwiseit'sinvalidtoimporttwiceassertXpathCount(0,"//xsd:import",doc);//GSMLschemaLocationassertXpathEvaluatesTo(AbstractAppSchemaMockData.GSML_SCHEMA_LOCATION_URL,"//xsd:include/@schemaLocation",doc);//nothing
elseassertXpathCount(0,"//xsd:complexType",doc);assertXpathCount(0,"//xsd:element",doc);/**gsml:GeologicUnit*/doc=getAsDOM("wfs?request=DescribeFeatureType&version=1.1.0&typename=gsml:GeologicUnit");LOGGER.info("WFSDescribeFeatureType,typename=gsml:GeologicUnitresponse:\n"+prettyString(doc));assertEquals("xsd:schema",doc.getDocumentElement().getNodeName());assertXpathEvaluatesTo(AbstractAppSchemaMockData.GSML_URI,"//@targetNamespace",doc);assertXpathCount(1,"//xsd:include",doc);assertXpathCount(0,"//xsd:import",doc);//GSMLschemaLocationassertXpathEvaluatesTo(AbstractAppSchemaMockData.GSML_SCHEMA_LOCATION_URL,"//xsd:include/@schemaLocation",doc);//nothing
elseassertXpathCount(0,"//xsd:complexType",doc);assertXpathCount(0,"//xsd:element",doc);
if(schemaLocation.startsWith(AbstractAppSchemaMockData.GSML_URI)){//GSMLschemalocationwasencodedfirstassertEquals(gsmlLocation+""+wfsLocation,schemaLocation);
else{//WFSschemalocationwasencodedfirstassertEquals(wfsLocation+""+gsmlLocation,schemaLocation);
elseisencodedassertXpathCount(0,"//gsml:MappedFeature[@gml:id='"+id+"']/gsml:specification/gsml:GeologicUnit",doc);
if(i>-1){StringnewName=(String)event.getNewValues().get(i);
if(sourceinstanceofStyleInfo){renameStyle((StyleInfo)source,newName);
if(sourceinstanceofStyleInfo){i=event.getPropertyNames().indexOf("workspace");
if(i>-1){WorkspaceInfonewWorkspace=(WorkspaceInfo)event.getNewValues().get(i);ResourcenewDir=dd.getStyles(newWorkspace);//lookforanyresourcefiles(image,etc...)andcopythemover,don'tmove//sincetheycouldbesharedamongotherstylesfor(Resourceold:dd.additionalStyleResources((StyleInfo)source)){
if(old.getType()!=Type.UNDEFINED){copyResToDir(old,newDir);
if(old.getType()!=Type.UNDEFINED){moveResToDir(old,newDir);
ifappropriate
if(!SLDHandler.FORMAT.equals(format.getFormat())){Resourcesld=style.parent().get(FilenameUtils.getBaseName(style.name())+".sld");
if(sld.getType()==Type.RESOURCE){LOGGER.fine("Renamingstyleresource"+s.getName()+"to"+newName);Resourcegenerated=uniqueResource(sld,newName,"sld");renameRes(sld,generated.name());
if(sourceinstanceofStyleInfo){removeStyle((StyleInfo)source);
if(i>MAX_RENAME_ATTEMPTS){thrownewIOException("Alltargetfilesbetween"+newName+"1."+extension+"and"+newName+MAX_RENAME_ATTEMPTS+"."+extension+"areinusealready,givingup");
if(Resources.exists(sld)){ResourcesldBackup=dd.get(sld.path()+".bak");inti=1;while(Resources.exists(sldBackup)){sldBackup=dd.get(sld.path()+".bak."+i++);
ifthereisaneedtoblock**@paramrequestnewrequest*@paramtimeoutmaximumtimetherequestcanbeblocked*@returnTrue
iftherequestwasprocessedsuccessfully,false
iftherequesttimedoutduring*thewait*/booleanrequestIncoming(Requestrequest,longtimeout)throwsInterruptedException;/***Calledbytheflowcontrollerwhentherequestisdoneprocessingt**@paramrequesttherequest*/voidrequestComplete(Requestrequest);/***Returnsthenumberofrequests"running"(couldbebothexecutingandtimedout,anything*thatwentinto{@link#requestIncoming(Request,long)}andmanagedtogetoutofit,butit's*notyetcomplete)**@return*/intgetRunningRequestsCount();}
if(data.getLiteralData()!=null){LiteralDataTypeliteral=data.getLiteralData();result=((LiteralPPIO)ppio).decode(literal.getValue());
else
if(data.getComplexData()!=null){ComplexDataTypecomplex=data.getComplexData();
if(ppioinstanceofRawDataPPIO){ObjectinputData=complex.getData().get(0);Stringencoding=complex.getEncoding();byte[]decoded=null;
if(encoding!=null){
if("base64".equals(encoding)){Stringinput=inputData.toString();decoded=Base64.decode(input);
else{thrownewWPSException("Unsupportedencoding"+encoding);
if(decoded!=null){returnnewByteArrayRawData(decoded,complex.getMimeType());
else{returnnewStringRawData(inputData.toString(),complex.getMimeType());
else{ObjectinputData=complex.getData().get(0);Stringencoding=complex.getEncoding();byte[]decoded=null;
if(encoding!=null){
if("base64".equals(encoding)){Stringinput=inputData.toString();decoded=Base64.decode(input);
else{thrownewWPSException("Unsupportedencoding"+encoding);
if(decoded!=null){result=((ComplexPPIO)ppio).decode(newByteArrayInputStream(decoded));
else{result=((ComplexPPIO)ppio).decode(inputData);
else
if(data.getBoundingBoxData()!=null){result=((BoundingBoxPPIO)ppio).decode(data.getBoundingBoxData());
if("baz".equals(it.next().get("key").getDefaultModelObjectAsString())){break;
if(outputFormats==null){outputFormats=Collections.emptySet();
ifwejustprovidethevaluesdirectlyasthemodelstheywon't//berefreshedonapagereload(ugh).add(newLabel("dataDir",newMapModel(values,KEY_DATA_DIR)));add(newLabel("locks",newMapModel(values,KEY_LOCKS)));add(newLabel("connections",newMapModel(values,KEY_CONNECTIONS)));add(newLabel("memory",newMapModel(values,KEY_MEMORY)));add(newLabel("jvm.version",newMapModel(values,KEY_JVM_VERSION)));add(newLabel("jai.available",newMapModel(values,KEY_JAI_AVAILABLE)));add(newLabel("jai.imageio.available",newMapModel(values,KEY_JAI_IMAGEIO_AVAILABLE)));add(newLabel("jai.memory.available",newMapModel(values,KEY_JAI_MAX_MEM)));add(newLabel("jai.memory.used",newMapModel(values,KEY_JAI_MEM_USAGE)));add(newLabel("jai.memory.threshold",newMapModel(values,KEY_JAI_MEM_THRESHOLD)));add(newLabel("jai.tile.threads",newMapModel(values,KEY_JAI_TILE_THREADS)));add(newLabel("jai.tile.priority",newMapModel(values,KEY_JAI_TILE_THREAD_PRIORITY)));add(newLabel("coverage.corepoolsize",newMapModel(values,KEY_COVERAGEACCESS_CORE_POOL_SIZE)));add(newLabel("coverage.maxpoolsize",newMapModel(values,KEY_COVERAGEACCESS_MAX_POOL_SIZE)));add(newLabel("coverage.keepalivetime",newMapModel(values,KEY_COVERAGEACCESS_KEEP_ALIVE_TIME)));add(newLabel("updateSequence",newMapModel(values,KEY_UPDATE_SEQUENCE)));add(newLabel("renderer",newMapModel(values,KEY_JAVA_RENDERER)));//serializationerrorhereadd(newLink("free.locks"){privatestaticfinallongserialVersionUID=-2889353495319211391L;publicvoidonClick(){//TODO:seeGEOS-2130updateModel();
if(jaiCacheinstanceofCacheDiagnostics){values.put(KEY_JAI_MEM_USAGE,formatMemory(((CacheDiagnostics)jaiCache).getCacheMemoryUsed()));
else{values.put(KEY_JAI_MEM_USAGE,"-");
ifintheclasspathitwilltellus
if//thenativeextensionsareavailable,
ifnot,anErrorwillbethrowntry{Class<?>image=Class.forName("com.sun.medialib.mlib.Image");return(Boolean)image.getMethod("isAvailable").invoke(null);
if(bytes>GB){formattedUsedMemory=formatter.format((float)bytes/GB)+"GB";
else
if(bytes>MB){formattedUsedMemory=formatter.format(bytes/MB)+"MB";
else{formattedUsedMemory=formatter.format(bytes/KB)+"KB";
if(!meta.isEnabled()){//Don'tcountlocksfromdisableddatastores.continue;
if(storeinstanceofDataStore){LockingManagerlockingManager=((DataStore)store).getLockingManager();
if(lockingManager!=null){//wecan'tactually*count*locksrightnow?//count+=lockingManager.getLockSet().size();
if(!meta.isEnabled()){//Don'tcountconnectionsfromdisableddatastores.continue;
if(sourceCoverage==null){thrownewIllegalStateException(newStringBuffer("Itseemsprepare()hasnotbeencalled").append("orhasnotsucceeded").toString());
if(isOutputCompressed(outputFormat)){gzipOut=newGZIPOutputStream(output);output=gzipOut;
if(gzipOut!=null){gzipOut.finish();gzipOut.flush();
if(writer!=null)writer.dispose();
if(gzipOut!=null)IOUtils.closeQuietly(gzipOut);sourceCoverage.dispose(true);
iftherearerulesinmatchfirstmode**@authorAndreaAime-GeoSolutions*/privatestaticclassMatchFirstVisitorextendsAbstractStyleVisitor{booleanmatchFirst=false;@Overridepublicvoidvisit(FeatureTypeStylefts){//yes,it'sanapproximation,wecannotreallyworkwithamixofFTSthat//aresomeevaluatefirst,othersnonevaluatefirst,butthecaseissonarrow//thatI'minclinedtowaitfordedicatedfundingbeforegoingtherematchFirst|=FeatureTypeStyle.VALUE_EVALUATION_MODE_FIRST.equals(fts.getOptions().get(FeatureTypeStyle.KEY_EVALUATION_MODE));
if(rules==null||rules.length==0){returnrules;
if(StringUtils.isEmpty(label)){label="("+counter.get()+")";
else{label=label+"("+counter.get()+")";
if(rule.isElseFilter()){
if(!matched){AtomicIntegercounter=counters.get(rule);counter.incrementAndGet();
else
if(rule.getFilter()==null||rule.getFilter().evaluate(f)){AtomicIntegercounter=counters.get(rule);counter.incrementAndGet();matched=true;
if(matchFirst){break;
if(srcWidth!=null){kvp.put(WIDTH,Converters.convert(srcWidth,Integer.class));
if(srcHeight!=null){kvp.put(HEIGHT,Converters.convert(srcHeight,Integer.class));
if(formatOptions!=null){formatOptions.remove("layout");
if(legend.getLayer()!=null){returnlegend.getLayer();
else
if(legend.getLayerInfo()!=null){returnlegend.getLayerInfo().prefixedName();
else
if(legend.getFeatureType()!=null){Namename=legend.getFeatureType().getName();NamespaceInfons=request.getWms().getCatalog().getNamespaceByURI(name.getNamespaceURI());finalStringlocalName=name.getLocalPart();
if(ns!=null){returnns.getPrefix()+":"+localName;
else{returnlocalName;
else{//shouldnotreallyhappentoday,butwhoknows,maydointhefuturethrownewServiceException("Couldnotgetthelayernameoutof"+legend);
if(namespacesElement==null){//nonamespacesavailable,unlikelybutpossibleLOGGER.log(Level.INFO,"Nonamespacesavailable.");returnCollections.emptyMap();
ifweneedtoreturnthisnamespace
if((!readIsolated&&isIsolated)||(readIsolated&&!isIsolated)){//notinterestinthisnamespace,movetothenextonecontinue;
ifthisisthedefaultnamespace
if(isDefault){namespaces.put("",uri);
ifanerroroccurscreatingthemapfromtheprovidedrequest*/publicWebMaprun(GetMapRequestrequest)throwsServiceException{request=fireInitRequest(request);//JD/GR:holdareferenceinordertoreleaseresourceslater.mapcontextcanleakmemory--//wemakesurewedone(seefinallyblock)WMSMapContentmapContent=newWMSMapContent(request);mapContent.setGetMapCallbacks(callbacks);try{WebMapmap=run(request,mapContent);map=fireFinished(map);returnmap;
if(tinstanceofRuntimeException){throw(RuntimeException)t;
else
if(tinstanceofError){throw(Error)t;
else{thrownewServiceException("Internalerror",t);
if(cap!=null&&!cap.isTiledRequestsSupported()&&isTiled){thrownewServiceException("Format"+request.getFormat()+"doesnotsupporttiledrequests");
ifrequestlookslikeatiledone
if(MetatileMapOutputFormat.isRequestTiled(request,delegate)){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Tiledrequestdetected,activatingontheflymetatiler");
iftheformatcandoanimationsfinalbooleanisMultivaluedSupported=(cap!=null?cap.isMultivalueRequestsSupported():false);////Test
iftheparameter"TIME"orELEVATIONarepresentintheWMS//request//TIMEList<Object>times=request.getTime();finalintnumTimes=times.size();booleansingleTimeRange=numTimes==1&&times.get(0)instanceofDateRange;//ELEVATIONList<Object>elevations=request.getElevation();finalintnumElevations=elevations.size();booleansingleElevationRange=numElevations==1&&elevations.get(0)instanceofNumberRange;//handlingtimeseriesandelevationseriesMaxAnimationTimeHelpermaxAnimationTimeHelper=newMaxAnimationTimeHelper(wms,request);intmaxAllowedFrames=wms.getMaxAllowedFrames();
if((numTimes>1||singleTimeRange)&&isMultivaluedSupported){WebMapmap=null;List<RenderedImage>images=newArrayList<RenderedImage>();
if(singleTimeRange){List<Object>expandTimeList=expandTimeList((DateRange)times.get(0),request,maxAllowedFrames);
if(expandTimeList.size()==0){returnexecuteInternal(mapContent,request,delegate,Arrays.asList(times.get(0)),elevations);
else{times=expandTimeList;
else
if((numElevations>1||singleElevationRange)&&isMultivaluedSupported){WebMapmap=null;List<RenderedImage>images=newArrayList<RenderedImage>();
if(singleElevationRange){List<Object>expandElevationList=expandElevationList((NumberRange)elevations.get(0),request,maxAllowedFrames);
if(expandElevationList.size()==0){map=executeInternal(mapContent,request,delegate,times,Arrays.asList(elevations.get(0)));
else{elevations=expandElevationList;
else{returnexecuteInternal(mapContent,request,delegate,times,elevations);
if(ri==null){continue;
if(timeInfo==null){continue;
if(l.getType()==MapLayerInfo.TYPE_VECTOR){TreeSet<Object>times=wms.queryFeatureTypeTimes(l.getFeature(),queryRange,maxAllowedFrames);accumulateTimes(result,times,maxAllowedFrames);
else
if(l.getType()==MapLayerInfo.TYPE_RASTER){TreeSet<Object>times=wms.queryCoverageTimes(l.getCoverage(),queryRange,maxAllowedFrames);accumulateTimes(result,times,maxAllowedFrames);
if(timeinstanceofDate){result.add((Date)time);
else
if(timeinstanceofDateRange){DateRangerange=((DateRange)time);DaterangeMid=newDate((range.getMinValue().getTime()+range.getMaxValue().getTime())/2);result.add(rangeMid);
if(result.size()>maxAllowedFrames){thrownewServiceException("Toomanystepsintheanimation");
if(ri==null){continue;
if(elevationInfo==null){continue;
if(l.getType()==MapLayerInfo.TYPE_VECTOR){TreeSet<Object>elevations=wms.queryFeatureTypeElevations(l.getFeature(),queryRange,maxAllowedFrames);accumulateElevations(result,elevations,maxAllowedFrames);
else
if(l.getType()==MapLayerInfo.TYPE_RASTER){TreeSet<Object>elevations=wms.queryCoverageElevations(l.getCoverage(),queryRange,maxAllowedFrames);accumulateElevations(result,elevations,maxAllowedFrames);
if(elevationinstanceofNumber){result.add(((Number)elevation).doubleValue());
else
if(elevationinstanceofNumberRange){NumberRangerange=((NumberRange)elevation);doublerangeMid=(range.getMinimum()+range.getMaximum())/2;result.add(rangeMid);
if(result.size()>maxAllowedFrames){thrownewServiceException("Toomanystepsintheanimation");
ifthere'sacrsintherequest,usethat.Ifnot,assumeits4326finalCoordinateReferenceSystemmapcrs=request.getCrs();//DJB:addedthistobeniceraboutthe"NONE"srs.
if(mapcrs!=null){mapContent.getViewport().setBounds(newReferencedEnvelope(envelope,mapcrs));
else{mapContent.getViewport().setBounds(newReferencedEnvelope(envelope,DefaultGeographicCRS.WGS84));
ifwereallyhavesomethingtodisplay.Sometimeswidth//orheightorbotharenonpositiveortherequestedareaisnull.///////
if((request.getWidth()<=0)||(request.getHeight()<=0)||(mapContent.getRenderingArea().getSpan(0)<=0)||(mapContent.getRenderingArea().getSpan(1)<=0)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Wearenotgoingtorenderanythingbecauseeithertheareaisnullorthedimensionsarenotpositive.");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("settingupmap");
if(cachingPossible){maxAge=Math.min(maxAge,mapLayerInfo.getCacheMaxAge());
else{cachingPossible=false;
if(layerType==MapLayerInfo.TYPE_REMOTE_VECTOR){finalSimpleFeatureSourcesource=mapLayerInfo.getRemoteFeatureSource();FeatureLayerfeatureLayer=newFeatureLayer(source,layerStyle);featureLayer.setTitle(mapLayerInfo.getRemoteFeatureSource().getSchema().getTypeName());finalQuerydefinitionQuery=newQuery(source.getSchema().getTypeName());definitionQuery.setFilter(layerFilter);definitionQuery.setVersion(featureVersion);definitionQuery.setSortBy(layerSort);intmaxFeatures=request.getMaxFeatures()!=null?request.getMaxFeatures():Integer.MAX_VALUE;definitionQuery.setMaxFeatures(maxFeatures);featureLayer.setQuery(definitionQuery);mapContent.addLayer(featureLayer);layer=featureLayer;
else
if(layerType==MapLayerInfo.TYPE_VECTOR){FeatureSource<?extendsFeatureType,?extendsFeature>source;///////////////////////////////////////////////////////////////Addingafeaturelayer/////////////////////////////////////////////////////////////try{source=mapLayerInfo.getFeatureSource(true);
if(layerSort!=null){//filtergetsvalidateddownintherenderer,but//sortingisdonewithouttherendererknowing,performvalidationherevalidateSort(source,layerSort,mapLayerInfo);
ifnointersection,don'tbotheraddingthefeature//sourcetothemap//Thisisnotanoptimization,onthecontrary,//computingthebboxmaybe//veryexpensivedependingonthedatasize.Using//sigma.openplans.orgdata//andatiledclientlikeOpenLayers,itdraggedthe//servertohisknees//andtheclientsimplytimedout
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.log(Level.SEVERE,newStringBuffer("Gettingfeaturesource:").append(exp.getMessage()).toString(),exp);
if(viewParams!=null){definitionQuery.setHints(newHints(Hints.VIRTUAL_TABLE_PARAMETERS,viewParams.get(i)));
if(startIndex!=null){QueryCapabilitiesqueryCapabilities=source.getQueryCapabilities();
if(queryCapabilities.isOffsetSupported()){//fsourceisrequiredtosupport//SortBy.NATURAL_ORDERsowedon'tbothercheckingdefinitionQuery.setStartIndex(startIndex);
else{//source=newPagingFeatureSource(source,//request.getStartIndex(),limit);thrownewServiceException("startIndexisnotsupportedforthe"+mapLayerInfo.getName()+"layer");
else
if(layerType==MapLayerInfo.TYPE_RASTER){///////////////////////////////////////////////////////////////Addingacoveragelayer/////////////////////////////////////////////////////////////finalGridCoverage2DReaderreader=(GridCoverage2DReader)mapLayerInfo.getCoverageReader();
if(reader!=null){//getthegroupofparametersthathisreadersupportsGeneralParameterValue[]readParameters=wms.getWMSReadParameters(request,mapLayerInfo,layerFilter,layerSort,times,elevations,reader,false);try{try{layer=newCachedGridReaderLayer(reader,layerStyle,readParameters);
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.log(Level.SEVERE,newStringBuilder("WrappingGCinfeaturesource:").append(e.getLocalizedMessage()).toString(),e);
else{thrownewServiceException(newStringBuffer("Internalerror:unabletogetreaderforthiscoveragelayer").append(mapLayerInfo.toString()).toString());
else
if(layerType==MapLayerInfo.TYPE_WMS){WMSLayerInfowmsLayer=(WMSLayerInfo)mapLayerInfo.getResource();WebMapServerwms=wmsLayer.getStore().getWebMapServer(null);Layergt2Layer=wmsLayer.getWMSLayer(null);//see
ifwecanmergethislayerwiththepreviousonebooleanmerged=false;
if(mapContent.layers().size()>0){org.geotools.map.LayerlastLayer=mapContent.layers().get(mapContent.layers().size()-1);
if(lastLayerinstanceofWMSLayer){WMSLayerlastWMS=(WMSLayer)lastLayer;WebMapServerotherWMS=lastWMS.getWebMapServer();
if(otherWMS.equals(wms)){lastWMS.addLayer(gt2Layer);merged=true;
if(!merged){WMSLayerLayer=newWMSLayer(wms,gt2Layer);Layer.setTitle(wmsLayer.prefixedName());mapContent.addLayer(Layer);
else
if(layerType==MapLayerInfo.TYPE_WMTS){WMTSLayerInfowmtsLayer=(WMTSLayerInfo)mapLayerInfo.getResource();WebMapTileServerwmts=wmtsLayer.getStore().getWebMapTileServer(null);Layergt2Layer=wmtsLayer.getWMTSLayer(null);WMTSMapLayermapLayer=newWMTSMapLayer(wmts,gt2Layer);mapLayer.setTitle(wmtsLayer.prefixedName());mapLayer.setRawTime((String)Dispatcher.REQUEST.get().getRawKvp().get("time"));mapContent.addLayer(mapLayer);
else{thrownewIllegalArgumentException("Unknownlayertype"+layerType);
iftheadminhassetaspecificvalueforsomelayers//inthismap//GR:question:doessetupRenderingBufferneedEnvFunction.setLocalValuestobealready//set?otherwisemovethiscalloutofthetryblockandabovesetLovalValuessetupRenderingBuffer(mapContent,layers);///////////////////////////////////////////////////////////////Producingthemapintherequestedformat./////////////////////////////////////////////////////////////mapContent=fireBeforeRender(mapContent);WebMapmap=delegate.produceMap(mapContent);
if(cachingPossible){map.setResponseHeader("Cache-Control","max-age="+maxAge+",must-revalidate");finalGregorianCalendarcalendar=newGregorianCalendar(TimeZone.getTimeZone("GMT"));calendar.add(Calendar.SECOND,maxAge);DateFormatformat=newSimpleDateFormat("EEE,ddMMMyyyyHH:mm:ssz");format.setTimeZone(TimeZone.getTimeZone("GMT"));map.setResponseHeader("Expires",format.format(calendar.getTime()));
if(sortBy.getPropertyName().evaluate(ft)==null){thrownewServiceException("Sortproperty'"+sortBy.getPropertyName().getPropertyName()+"'notavailablein"+mapLayerInfo.getName(),ServiceException.INVALID_PARAMETER_VALUE,"sortBy");
if(map.getBuffer()>0){return;
ifthereisnonesetint[]layerBuffers=newint[layers.size()];booleancomputeBuffer=false;for(inti=0;i<layers.size();i++){finalLayerInfolayerInfo=layers.get(i).getLayerInfo();
if(layerInfo!=null){//itisalocallayerIntegerlayerBuffer=layerInfo.getMetadata().get(LayerInfo.BUFFER,Integer.class);
if(layerBuffer!=null&&layerBuffer>0){computeBuffer=true;layerBuffers[i]=layerBuffer;
if(computeBuffer){finaldoublescaleDenominator=map.getScaleDenominator(true);intbuffer=0;//eitherusethepresetbuffer,or
ifmissing,computeoneontheflybased//onananalysisoftheactiverulesatthecurrentscalefor(inti=0;i<layers.size();i++){intlayerBuffer=layerBuffers[i];
if(layerBuffer==0){layerBuffer=computeLayerBuffer(map.layers().get(i).getStyle(),scaleDenominator);
if(layerBuffer>buffer){buffer=layerBuffer;
if(((rule.getMinScaleDenominator()-TOLERANCE)<=scaleDenominator)&&((rule.getMaxScaleDenominator()+TOLERANCE)>scaleDenominator)){estimator.visit(rule);
ifanymandatoryparameterhasnotbeensetontherequest*/privatevoidassertMandatory(GetMapRequestrequest)throwsServiceException{
if(0>=request.getWidth()||0>=request.getHeight()){thrownewServiceException("Missingorinvalidrequestedmapsize.Parameters"+"WIDTHandHEIGHTshallbepresentandbeintegers>0.Got"+"WIDTH="+request.getWidth()+",HEIGHT="+request.getHeight(),"MissingOrInvalidParameter");
if(request.getLayers().size()==0){thrownewServiceException("Nolayershavebeenrequested","LayerNotDefined");
if(request.getStyles().size()==0){thrownewServiceException("Nostyleshavebeenrequested","StyleNotDefined");
if(request.getFormat()==null){thrownewServiceException("Nooutputmapformatrequested","InvalidFormat");
ifitis,throwaserviceexception!finalEnvelopeenv=request.getBbox();
if(env==null){thrownewServiceException("GetMaprequestsmustincludeaBBOXparameter.","MissingBBox");
if(env.isNull()||(env.getWidth()<=0)||(env.getHeight()<=0)){thrownewServiceException(newStringBuffer("Therequestboundingboxhaszeroarea:").append(env).toString(),"InvalidBBox");
if(requestFilters==null||requestFilters.size()==0){requestFilters=Collections.nCopies(layers.size(),(Filter)Filter.INCLUDE);
else
if(requestFilters.size()!=nLayers){thrownewIllegalArgumentException("requestedfiltersandnumberoflayersdonotmatch");
if(layer.getType()==MapLayerInfo.TYPE_REMOTE_VECTOR||layer.getType()==MapLayerInfo.TYPE_RASTER){combinedList[i]=userRequestedFilter;
else
if(layer.getType()==MapLayerInfo.TYPE_VECTOR){layerDefinitionFilter=layer.getFeature().filter();//heck,howIwishweusethenullobjectsmore
if(layerDefinitionFilter==null){layerDefinitionFilter=Filter.INCLUDE;
if(featureTypeConstraints!=null){List<Filter>filters=newArrayList<Filter>();for(intj=0;j<featureTypeConstraints.length;j++){FeatureTypeConstraintfeatureTypeConstraint=featureTypeConstraints[j];filters.add(featureTypeConstraint.getFilter());
ifnospecializationisconfiguredfortheoutputformatspecified*in<code>request</code>or
ifitcan'tbeinstantiatedortheformatisnotallowed*/protectedGetMapOutputFormatgetDelegate(finalStringoutputFormat)throwsServiceException{finalGetMapOutputFormatproducer=wms.getMapOutputFormat(outputFormat);
if(producer==null){ServiceExceptione=newServiceException("Thereisnosupportforcreatingmapsin"+outputFormat+"format","InvalidFormat");e.setCode("InvalidFormat");throwe;
if(wms.isAllowedGetMapFormat(producer)==false){throwwms.unallowedGetMapFormatException(outputFormat);
if(isNew){repoInfo=newModel<>(newRepositoryInfo());
if(null==repoId){returnnewArrayList<>();
if(geogig!=null){ImmutableList<Remote>geogigRemotes=geogig.command(RemoteListOp.class).call();list=RemoteInfo.fromList(geogigRemotes);
if(null==repoId){returnMaps.newHashMap();
if(geogig!=null){Optional<Map<String,String>>config=geogig.command(ConfigOp.class)//.setAction(ConfigAction.CONFIG_LIST)//.setScope(global?ConfigScope.GLOBAL:ConfigScope.LOCAL)//.call();
if(config.isPresent()){returnconfig.get();
if(null==repoId){returnLists.newArrayList();
if(!currentRemotes.isEmpty()||!newRemotes.isEmpty()){GeogigTransactiontx=geogig.command(TransactionBegin.class).call();try{updateRemotes(tx,currentRemotes,newRemotes);tx.commit();
if(ri.getId()!=null){remaining.put(ri.getId(),ri);
if(!remaining.containsKey(deleted.getId())){Stringname=deleted.getName();try{geogig.command(RemoteRemoveOp.class).setName(name).call();
if(ri.getId()==null){//itsanewoneRemoteAddOpcmd=geogig.command(RemoteAddOp.class);cmd.setName(ri.getName());cmd.setURL(ri.getURL());cmd.setUserName(ri.getUserName());cmd.setPassword(ri.getPassword());try{cmd.call();
else{//handleupadtesRemoteInfoold=currentRemotes.remove(ri.getId());Preconditions.checkNotNull(old);
if(old.equals(ri)){continue;//didn'tchange
if(currentConfig.containsKey(entry.getName())){
if(!currentConfig.get(entry.getName()).equals(entry.getValue())){//entrychangedgeogig.command(ConfigOp.class)//.setAction(ConfigAction.CONFIG_SET)//.setName(entry.getName())//.setValue(entry.getValue())//.setScope(scope)//.call();
else{//newentrygeogig.command(ConfigOp.class)//.setAction(ConfigAction.CONFIG_SET)//.setName(entry.getName())//.setValue(entry.getValue())//.setScope(scope)//.call();
if(!isNew){for(Entry<String,String>entry:currentConfig.entrySet()){//removedentrygeogig.command(ConfigOp.class)//.setAction(ConfigAction.CONFIG_UNSET)//.setName(entry.getKey())//.setScope(scope)//.call();
if(ws==null){thrownewResourceNotFoundException("Nosuchworkspace:"+workspaceName);
if(original==null){thrownewResourceNotFoundException("Nosuchcoveragestore:"+workspaceName+","+storeName);
if(!recurse){
if(!catalog.getCoveragesByCoverageStore(cs).isEmpty()){thrownewRestException("coveragestorenotempty",HttpStatus.UNAUTHORIZED);
else{newCascadeDeleteVisitor(catalog).visit(cs);
if(!deleteType.equalsIgnoreCase("none")&&(deleteType.equalsIgnoreCase("all")||deleteType.equalsIgnoreCase("metadata"))){finalbooleandeleteData=deleteType.equalsIgnoreCase("all");GridCoverageReaderreader=cs.getGridCoverageReader(null,null);
if(readerinstanceofStructuredGridCoverage2DReader){((StructuredGridCoverage2DReader)reader).delete(deleteData);
if(workspace==null||coveragestore==null){returnnull;
if(objinstanceofWorkspaceInfo){converter.encodeLink("/workspaces/"+converter.encode(ref),writer);
if(properties==null){try{properties=model.toMap();
if(!csProps.isEmpty()){properties.putIfAbsent("coverages",csProps);
if(read==4096){chars=newString(Base64.encodeBase64(buffer)).toCharArray();
else{byte[]reducedBuffer=newbyte[read];System.arraycopy(buffer,0,reducedBuffer,0,read);chars=newString(Base64.encodeBase64(reducedBuffer)).toCharArray();
ifthestringcan'tbeparsed.*/publicvoidtestPairs()throwsException{Map<String,String>expected=newHashMap<String,String>(){{put("key1","value1");put("key2","value2");put("key3","true");put("key4","value4");
ifthestringcan'tbeparsed.*/publicvoidtestEscapedSeparators()throwsException{Map<String,String>expected=newHashMap<String,String>(){{put("key1","value:1");put("key2","value:2");put("key3","value:3;ZZZ");
ifthestringcan'tbeparsed.*/publicvoidtestEmbeddedSeparators()throwsException{Map<String,String>expected=newHashMap<String,String>(){{put("key1","value:1");put("key2","value:2");put("key3","value:3:ZZ;XX");
ifthestringcan'tbeparsed.*/publicvoidtestErrors()throwsException{Map<String,String>expected=newHashMap<String,String>(){{put("key1","value:1");put("key2","value:2");put("key3","value:3");
if(!p.getValidationErrors().isEmpty()){for(Iteratore=p.getValidationErrors().iterator();e.hasNext();){SAXParseExceptionex=(SAXParseException)e.next();System.out.println(ex.getLineNumber()+","+ex.getColumnNumber()+"-"+ex.toString());
if("".equals(contents)){continue;
if(xpath.getMatchingNodes("//wps:Status/wps:ProcessAccepted",dom).getLength()>0||xpath.getMatchingNodes("//wps:Status/wps:ProcessStarted",dom).getLength()>0||xpath.getMatchingNodes("//wps:Status/wps:ProcessQueued",dom).getLength()>0){Thread.sleep(100);
else{returndom;
if("".equals(contents)){continue;
if(xpath.getMatchingNodes("//wps:Status/wps:ProcessAccepted",dom).getLength()>0||xpath.getMatchingNodes("//wps:Status/wps:ProcessStarted",dom).getLength()>0||xpath.getMatchingNodes("//wps:Status/wps:ProcessQueued",dom).getLength()>0){waitAction.call();
else{returndom;
if("".equals(contents)){continue;
if(xpath.getMatchingNodes("//wps:Status/wps:ProcessAccepted",dom).getLength()>0||xpath.getMatchingNodes("//wps:Status/wps:ProcessQueued",dom).getLength()>0){Thread.sleep(100);
else{returndom;
if(rhsinstanceofGeoServerUserGroup){returngetGroupname().equals(((GeoServerUserGroup)rhs).getGroupname());
if(o==null)return1;returngetGroupname().compareTo(o.getGroupname());
if(!catalogFile.exists()){thrownewFileNotFoundException("Couldnotfindcatalog.xmlunder:"+dir.getAbsolutePath());
if(!featureTypes.exists())featureTypes.mkdir();File[]featureTypeDirectories=featureTypes.listFiles();for(inti=0;i<featureTypeDirectories.length;i++){FilefeatureTypeDirectory=featureTypeDirectories[i];
if(!featureTypeDirectory.isDirectory()||featureTypeDirectory.isHidden())continue;//loadinfo.xmlFileftInfoFile=newFile(featureTypeDirectory,"info.xml");
if(!ftInfoFile.exists()){LOGGER.fine("Noinfo.xmlfoundindirectory:'"+featureTypeDirectory.getName()+"',ignoring");continue;
if(featureType==null){continue;
if(layer.getPath()==null){layer.setPath("/");
if(defaultStyleName!=null){StyleInfostyle=catalog.getStyleByName(defaultStyleName);
if(style!=null){layer.setDefaultStyle(style);
if(styles!=null){for(StringstyleName:styles){StyleInfostyle=catalog.getStyleByName(styleName);
if(style!=null){layer.getStyles().add(style);
if(legendURL!=null){LegendInfolegend=factory.createLegend();legend.setHeight((Integer)legendURL.get("height"));legend.setWidth((Integer)legendURL.get("width"));legend.setFormat((String)legendURL.get("format"));legend.setOnlineResource((String)legendURL.get("onlineResource"));layer.setLegend(legend);
if(!coverages.exists())coverages.mkdir();File[]coverageDirectories=coverages.listFiles();for(inti=0;i<coverageDirectories.length;i++){FilecoverageDirectory=coverageDirectories[i];
if(!coverageDirectory.isDirectory()||coverageDirectory.isHidden())continue;//loadinfo.xmlFilecInfoFile=newFile(coverageDirectory,"info.xml");
if(!cInfoFile.exists()){LOGGER.fine("Noinfo.xmlfoundindirectory:'"+coverageDirectory.getName()+"',ignoring");continue;
if(coverage==null){continue;
if(layer.getPath()==null){layer.setPath("/");
if(defaultStyleName!=null){StyleInfostyle=catalog.getStyleByName(defaultStyleName);
if(style!=null){layer.setDefaultStyle(style);
if(styles!=null){for(StringstyleName:styles){StyleInfostyle=catalog.getStyleByName(styleName);
if(style!=null){layer.getStyles().add(style);
if(dataStore.isEnabled()){try{//testconnectiontodatastoredataStore.getDataStore(null);//connectionokLOGGER.info("Processeddatastore'"+dataStore.getName()+"',"+(dataStore.isEnabled()?"enabled":"disabled"));
if(entry.getKey()==null||"".equals(entry.getKey())){continue;
if(namespace.getURI().equals(namespaces.get(""))){catalog.setDefaultNamespace(namespace);catalog.setDefaultWorkspace(workspace);
if(catalog.getDefaultNamespace()!=null){LOGGER.info("Defaultnamespace:'"+catalog.getDefaultNamespace().getPrefix()+"'");
else{LOGGER.warning("Nodefaultnamespaceset.");
if(ftInfoReader.alias()!=null){featureType.setName(ftInfoReader.alias());
else{featureType.setName(ftInfoReader.name());
if(dataStore==null){LOGGER.warning("Ignoringfeaturetype:'"+ftInfoReader.parentDirectoryName()+"',datastore'"+dataStoreName+"'notfound");returnnull;
if(featureType.isEnabled()&&!dataStore.isEnabled()){LOGGER.info("Ignoringfeaturetype:'"+ftInfoReader.parentDirectoryName()+"',datastoreisdisabled");featureType.setEnabled(false);
if(featureType.isEnabled()){Exceptionerror=null;//nativecrsDataAccess<?extendsFeatureType,?extendsFeature>ds=null;try{ds=dataStore.getDataStore(null);
if(error==null){try{//loadthenativefeaturetype,andgenerateattributesfromthatFeatureTypeft=ds.getSchema(featureType.getQualifiedNativeName());featureType.setNativeCRS(ft.getCoordinateReferenceSystem());
if(error==null){//nativeboundsEnvelopenativeBBOX=ftInfoReader.nativeBoundingBox();
if(nativeBBOX!=null){featureType.setNativeBoundingBox(newReferencedEnvelope(nativeBBOX,featureType.getNativeCRS()));
if(error!=null){featureType.setEnabled(false);
if(coverageStore==null){LOGGER.warning("Ignoringcoverage:'"+cInfoReader.parentDirectoryName()+"',coveragestore'"+coverageStoreName+"'notfound");returnnull;
if(!coverageStore.isEnabled()){LOGGER.info("Ignoringcoverage:'"+cInfoReader.parentDirectoryName()+"',coveragestoreisdisabled");returnnull;
if(grid!=null){int[]low=(int[])grid.get("low");int[]high=(int[])grid.get("high");GeneralGridEnveloperange=newGeneralGridEnvelope(low,high);Map<String,Double>tx=(Map<String,Double>)grid.get("geoTransform");
if(tx!=null){double[]matrix=newdouble[3*3];matrix[0]=tx.get("scaleX")!=null?tx.get("scaleX"):matrix[0];matrix[1]=tx.get("shearX")!=null?tx.get("shearX"):matrix[1];matrix[2]=tx.get("translateX")!=null?tx.get("translateX"):matrix[2];matrix[3]=tx.get("shearY")!=null?tx.get("shearY"):matrix[3];matrix[4]=tx.get("scaleY")!=null?tx.get("scaleY"):matrix[4];matrix[5]=tx.get("translateY")!=null?tx.get("translateY"):matrix[5];matrix[8]=1.0;MathTransformgridToCRS=newDefaultMathTransformFactory().createAffineTransform(newGeneralMatrix(3,3,matrix));coverage.setGrid(newGridGeometry2D(range,gridToCRS,crs));
else{coverage.setGrid(newGridGeometry2D(range,gridEnvelope));
else{//newgridrangeGeneralGridEnveloperange=newGeneralGridEnvelope(newint[]{0,0},newint[]{1,1});coverage.setGrid(newGridGeometry2D(range,gridEnvelope));
if(prefix){params="geotiff:compression=JPEG&geotiff:jpeg_quality=75";
if(readerOverviewTS!=null){try{readerOverviewTS.dispose();
if(readerOverviewSF!=null){try{readerOverviewSF.dispose();
if(readerNative!=null){try{readerNative.dispose();
if(params==null){returnfalse;
if(!params.containsKey(param.key)){
if(param.required){returnfalse;//missingrequiredkey!
else{continue;
if(value==null){
if(param.required){return(false);
else{
if(!param.type.isInstance(value)){returnfalse;//valuewasnotoftherequiredtype
if(param.metadata!=null){//checkmetadata
if(param.metadata.containsKey(Param.OPTIONS)){List<Object>options=(List<Object>)param.metadata.get(Param.OPTIONS);
if(options!=null&&!options.contains(value)){returnfalse;//invalidoption
if(DBTYPE.sample.equals(type)){returntrue;
ifwehaveanythingtoimportprovider=newWMSLayerProvider();provider.setStoreId(storeId);
if(provider.size()<=0){error(newParamResourceModel("storeEmpty",this,store.getName(),store.getWorkspace().getName()).getString());
if(property==WMSLayerProvider.NAME){returnnewLabel(id,property.getModel(itemModel));
else
if(property==WMSLayerProvider.STATUS){Fragmentf=newFragment(id,"labelIcon",WMSLayerImporterPage.this);f.add(newImage("icon",newIconModel(itemModel)));f.add(newLabel("label",newStatusModel(itemModel)));returnf;
else
if(property==WMSLayerProvider.ACTION){finalLayerResourceresource=(LayerResource)itemModel.getObject();finalLayerStatusstatus=resource.getStatus();
if(status==LayerStatus.PUBLISHED||status==LayerStatus.NEWLY_PUBLISHED||status==LayerStatus.UPDATED){returnresourceChooserLink(id,itemModel,newParamResourceModel("NewLayerPage.publishAgain",this));
else{returnresourceChooserLink(id,itemModel,newParamResourceModel("NewLayerPage.publish",this));
ifnothingwasselectedweneedtogoback
if(selection.size()==0){error(newParamResourceModel("selectionEmpty",WMSLayerImporterPage.this).getString());
else{publishLayers(selection);
if(exists!=null){//TODOwhattodo
iflayeralreadyexists?builder.updateWMSLayer(exists,wli);layer.setStatus(LayerStatus.UPDATED);updateCount++;
else{try{catalog.add(wli);catalog.add(li);layer.setStatus(LayerStatus.NEWLY_PUBLISHED);importCount++;
if(importCount>0){info("Succesfullyimported"+importCount+"layers");
else{info("Nonewlayerswereimported");
if(updateCount>0){info("Updated"+updateCount+"layers");
if(errorCount>0){error("Unabletoimport"+errorCount+"layers,youmaywanttoimportthemmanually");
if(resource.getStatus()==LayerStatus.ERROR){returnnewPackageResourceReference(GeoServerBasePage.class,"img/icons/silk/error.png");
else
if(resource.getStatus()==LayerStatus.NEW){returnnewPackageResourceReference(GeoServerBasePage.class,"img/icons/silk/add.png");
else
if(resource.getStatus()==LayerStatus.NEWLY_PUBLISHED){returnCatalogIconFactory.ENABLED_ICON;
else
if(resource.getStatus()==LayerStatus.UPDATED){returnnewPackageResourceReference(GeoServerBasePage.class,"img/icons/silk/pencil.png");
else
if(resource.getStatus()==LayerStatus.PUBLISHED){returnCatalogIconFactory.MAP_ICON;
else{returnnull;
if(StringUtils.hasLength(authConfig.getProxyCallbackUrlPrefix()))validator.setProxyCallbackUrl(GeoServerCasConstants.createProxyCallBackURl(authConfig.getProxyCallbackUrlPrefix()));casLogoutURL=GeoServerCasConstants.createCasURl(authConfig.getCasServerUrlPrefix(),GeoServerCasConstants.LOGOUT_URI);
if(StringUtils.hasLength(authConfig.getUrlInCasLogoutPage()))casLogoutURL+="?"+GeoServerCasConstants.LOGOUT_URL_PARAM+"="+URLEncoder.encode(authConfig.getUrlInCasLogoutPage(),"utf-8");singleSignOut=authConfig.isSingleSignOut();aep=newGeoServerCasAuthenticationEntryPoint(authConfig);
if(ticket==null)returnnull;
if((ticket.startsWith(GeoServerCasConstants.PROXY_TICKET_PREFIX)||ticket.startsWith(GeoServerCasConstants.SERVICE_TICKET_PREFIX))==false)returnnull;try{Stringservice=retrieveService(request);returnvalidator.validate(ticket,service);
if(StringUtils.hasLength(proxyBaseUrl)){serviceBaseUrl=proxyBaseUrl;
else{serviceBaseUrl=request.getRequestURL().toString();
if(StringUtils.hasLength(request.getQueryString())){Stringquery=request.getQueryString();String[]params=query.split("&");booleanfirsttime=true;for(Stringparam:params){String[]keyValue=param.split("=");
if(keyValue.length==0)continue;Stringname=keyValue[0];
if(GeoServerCasConstants.ARTIFACT_PARAMETER.equals(name.trim()))continue;
if(GeoServerCasAuthenticationEntryPoint.CAS_REDIRECT.equals(name.trim()))continue;
if(firsttime){buff.append("?");firsttime=false;
else{buff.append("&");
if(LOGGER.isLoggable(Level.FINE))LOGGER.fine("CASServiceURL:"+serviceUrl);returnserviceUrl;
if(principal!=null&&session!=null){session.setAttribute(GeoServerCasConstants.CAS_ASSERTION_KEY,request.getAttribute(GeoServerCasConstants.CAS_ASSERTION_KEY));request.removeAttribute(GeoServerCasConstants.CAS_ASSERTION_KEY);getHandler().process(request,null);
if(principal==null){request.removeAttribute(GeoServerCasConstants.CAS_ASSERTION_KEY);
if(assertion==null)returnnull;request.setAttribute(GeoServerCasConstants.CAS_ASSERTION_KEY,assertion);returnassertion.getPrincipal().getName();
if(!handlerInitialized){handler.init();handlerInitialized=true;
if(isLogoutRequest(httpReq)){
if(singleSignOut){//doweparticipateLOGGER.info("SingleSignOutreceivedfromCASserver-->startinglogout");LogoutFilterChainlogOutChain=(LogoutFilterChain)getSecurityManager().getSecurityConfig().getFilterChain().getRequestChainByName("webLogout");logOutChain.doLogout(getSecurityManager(),httpReq,httpRes,getName());handler.process(httpReq,httpRes);
elseLOGGER.info("SingleSignOutreceivedfromCASserver-->ignoring");return;
if(SecurityContextHolder.getContext().getAuthentication()!=null){HttpSessionsession=httpReq.getSession(false);
if(session!=null&&session.getAttribute(GeoServerCasConstants.CAS_ASSERTION_KEY)!=null&&singleSignOut){handler.process(httpReq,httpRes);
if(LOGGER.isLoggable(Level.INFO))LOGGER.info("RecordHTTPSession"+session.getId()+"forCASsinglesignout");
ifrequestislogoutrequest,falseotherwise.*/publicbooleanisLogoutRequest(finalHttpServletRequestrequest){return"POST".equals(request.getMethod())&&CommonUtils.isNotBlank(CommonUtils.safeGetParameter(request,SingleSignOutHandler.DEFAULT_LOGOUT_PARAMETER_NAME));
ifrequiredparametersaremissingfromtheconfiguration*/publicvoidloadOptions(Map<String,String>options)throwsException;/***Determinethe'best'sizeforthisdecoration,giventherequestparameters.**@paramg2dtheGraphics2DcontextinwhichthisDecorationwillberendered*@parammapContentthemapcontextfortherequest*@throwsInvalidStateException
ifloadOptions()hasnotbeencalledyet*/publicDimensionfindOptimalSize(Graphics2Dg2d,WMSMapContentmapContent)throwsException;/***Renderthecontentsofthisdecorationontotheprovidedgraphicsobjectwithinthespecified*bounds.TheWMSMapContextobjectcanbeusedtoprovideadditionalinfoaboutthemapfor*context-sensitivedecorations.**@paramg2dtheGraphics2Dobjectontowhichthedecorationshouldbedrawn*@parampaintAreatheboundswithinthegraphicsobjectwherethedecorationshouldbedrawn*@paramcontextthemapContentfortheimagebeingrendered*@throwsInvalidStateException
ifloadOptions()hasnotbeencalledyet*/publicvoidpaint(Graphics2Dg2d,RectanglepaintArea,WMSMapContentcontext)throwsException;}
if(storedQueryProvider.getStoredQuery(sqd.getId())!=null){WFSExceptione=newWFSException(request,"Storedqueryalreadyexists",WFSException.DUPLICATE_STORED_QUERY_ID_VALUE);e.setLocator(sqd.getId());throwe;
if(sq.getQueryExpressionText().isEmpty()){thrownewWFSException(request,"Storedquerydoesnotspecifyanyqueries");
if(language!=null&&!storedQueryProvider.supportsLanguage(language)){WFSExceptione=newWFSException(request,"Invalidlanguage"+queryExpressionTextType.getLanguage(),ServiceException.INVALID_PARAMETER_VALUE);e.setLocator("language");throwe;
if(!language.equals(sq.getQueryExpressionText().get(i).getLanguage())){thrownewWFSException(request,"Storedqueryspecifiesquerieswithmultiplelanguages."+"Notsupported");
ifthisreaderclassisreallynecessary**@authorAndreaAime*/publicclassDescribeCoverageKvpRequestReaderextendsEMFKvpRequestReader{privateCatalogcatalog;publicDescribeCoverageKvpRequestReader(Catalogcatalog){super(DescribeCoverageType.class,Wcs111Factory.eINSTANCE);this.catalog=catalog;//JD:wesetafilterbecausetheWCS1.1schemepeoplearecrazyfilter=newHashSet(Arrays.asList("service","version","identifiers"));
if(identifiers==null||identifiers.size()==0){thrownewWcsException("Requiredparamer,identifiers,missing",WcsExceptionCode.MissingParameterValue,"identifiers");
ifnotspecified,throwaresoundingexception(byspec)
if(!describeCoverage.isSetVersion())thrownewWcsException("Versionhasnotbeenspecified",WcsExceptionCode.MissingParameterValue,"version");returnrequest;}}
switchfromthestandardsuppliertooneusingthemockclientpreparedaboveSupplier<HTTPClient>oldSupplier=process.getHttpClientSupplier();try{process.setHttpClientSupplier(()->client);MockHttpServletResponseresponse=postAsServletResponse("wps",request);assertEquals("image/png",response.getContentType());BufferedImageimage=ImageIO.read(newByteArrayInputStream(response.getContentAsByteArray()));ImageAssert.assertEquals(newFile(SAMPLES+"mapSimple.png"),image,100);
switchfromthestandardsuppliertooneusingthemockclientpreparedaboveSupplier<HTTPClient>oldSupplier=process.getHttpClientSupplier();try{process.setHttpClientSupplier(()->client);MockHttpServletResponseresponse=postAsServletResponse("wps",request);assertEquals("image/png",response.getContentType());BufferedImageimage=ImageIO.read(newByteArrayInputStream(response.getContentAsByteArray()));ImageAssert.assertEquals(newFile(SAMPLES+"mapSimple.png"),image,100);
switchfromthestandardsuppliertooneusingthemockclientpreparedaboveSupplier<HTTPClient>oldSupplier=process.getHttpClientSupplier();try{process.setHttpClientSupplier(()->client);MockHttpServletResponseresponse=postAsServletResponse("wps",request);assertEquals("image/png",response.getContentType());BufferedImageimage=ImageIO.read(newByteArrayInputStream(response.getContentAsByteArray()));ImageAssert.assertEquals(newFile(SAMPLES+"localRemote.png"),image,100);
if(os==null){finalServletOutputStreamwrapped=super.getOutputStream();os=newServletOutputStream(){booleanclosed;@Overridepublicvoidwrite(intb)throwsIOException{wrapped.write(b);
if(closed){//weshouldneverreachthiscodethrownewRuntimeException("Aaarg,I'malreadyclosed,yourJVMshalldienow!");
ifwegotherewithoutexception,it'salreadyagoodsign.Let'schecktheoutputassertEquals("Somerandomtext",response.getContentAsString());}}
if(res.equals(CalcResult.NULL_RESULT)){returnnull;
else{returnConverters.convert(max.getMax(),clz);
iftheformisnotvalidating*<li>automaticallyaddsthe{@linkGeoServerBasePage}feedbackpanelintheajaxtarget*</ul>**Whenusingitrememberthatyouhavetoinvoke{@linkFormComponent#processInput()}oneach*componentyouneedinputfromasthestandardformprocessinghasbeenskipped**@authorAndreaAime*/@SuppressWarnings("serial")publicabstractclassGeoServerAjaxFormLinkextendsAjaxSubmitLink{publicGeoServerAjaxFormLink(Stringid){super(id);
if(getPage()instanceofGeoServerBasePage){((GeoServerBasePage)getPage()).addFeedbackPanels(target);
if(writeQuery.getFilter()==Filter.EXCLUDE||writeQuery.getPropertyNames()==Query.NO_NAMES){throwunsupportedOperation();
else
if(writeQuery==Query.ALL){//makesureitbehaveslikenativewhennowritelimitsareimposed(even
ifthis//casemakesnosense,weshouldnotwrapatall)returnstoreDelegate.addFeatures(collection);
else{//check
ifanyoftheinsertedfeaturesdoesnotpassthewritefilters
if(writeQuery.getFilter()!=null&&writeQuery.getFilter()!=Filter.INCLUDE){finalFilteringFeatureCollection<T,F>filtered=newFilteringFeatureCollection<T,F>(collection,writeQuery.getFilter());
if(filtered.size()<collection.size()){StringtypeName=getSchema().getName().getLocalPart();
if(policy.response==Response.CHALLENGE){throwSecureCatalogImpl.unauthorizedAccess(typeName);
else{thrownewUnsupportedOperationException("Atleastoneofthefeaturesinserteddoesnotsatisfyyourwriterestrictions");
if(writeQuery.getPropertyNames()==Query.ALL_NAMES){returnstoreDelegate.addFeatures(collection);
else{
if(collection.getSchema()instanceofSimpleFeatureType&&storeDelegateinstanceofSimpleFeatureStore){//see
iftheuserspecifiedthevalueofanyattributeshecannotwritefinalSimpleFeatureCollectionsimpleCollection=(SimpleFeatureCollection)collection;//wrapitwithacollectionthatwillcheck
ifanynonwritableattributehas//beengivenavalueList<String>writableAttributes=Arrays.asList(writeQuery.getPropertyNames());CheckAttributesFeatureCollectionchecker=newCheckAttributesFeatureCollection(simpleCollection,writableAttributes,policy.getResponse());return((SimpleFeatureStore)storeDelegate).addFeatures(checker);
else{//TODO:addretypingtoshaveoffattributeswecannotwriteLOGGER.log(Level.SEVERE,"Unfinishedimplementation,weneedtoshaveoff"+"theattributesonecannotwriteoffcomplexfeatures."+"Howeveratthistimethereisnowritablecomplexfeature!");returnstoreDelegate.addFeatures(collection);
if(writeQuery==Query.ALL){storeDelegate.modifyFeatures(names,values,filter);return;
else
if(writeQuery.getFilter()==Filter.EXCLUDE||writeQuery.getPropertyNames()==Query.NO_NAMES){throwunsupportedOperation();
if(writeQuery.getPropertyNames()==Query.ALL_NAMES){//itwasjustamatteroffiltering.storeDelegate.modifyFeatures(names,values,mixed.getFilter());
else{//getthewritableattributesetSet<String>queryNames=newHashSet<String>(Arrays.asList(writeQuery.getPropertyNames()));//checktheupdatefieldsfor(inti=0;i<names.length;i++){finalStringlocalName=names[i].getLocalPart();
if(queryNames.contains(localName)){StringtypeName=getSchema().getName().getLocalPart();
if(policy.getResponse()==Response.CHALLENGE){throwSecureCatalogImpl.unauthorizedAccess(typeName);
else{thrownewUnsupportedOperationException("Tryingtowriteonthewriteprotectedattribute"+names[i]);
if(writeQuery==Query.ALL){storeDelegate.removeFeatures(filter);
else
if(writeQuery.getFilter()==Filter.EXCLUDE||writeQuery.getPropertyNames()==Query.NO_NAMES){throwunsupportedOperation();
if(policy.response==Response.CHALLENGE){returnSecureCatalogImpl.unauthorizedAccess(typeName);
else{returnnewUnsupportedOperationException(typeName+"isreadonly");
if(configurationModel!=null){batch.setConfiguration(configurationModel.getObject());
if(!TaskManagerBeans.get().getDataUtil().isDeletable(batch)){error(newParamResourceModel("stillRunning",BatchesPanel.this,batch.getFullName()).getString());someCant=true;
else
if(!TaskManagerBeans.get().getSecUtil().isAdminable(((GeoServerBasePage)getPage()).getSession().getAuthentication(),batch)){error(newParamResourceModel("noDeleteRights",BatchesPanel.this,batch.getName()).getString());someCant=true;
if(someCant){((GeoServerBasePage)getPage()).addFeedbackPanels(target);
else{dialog.setTitle(newParamResourceModel("confirmDeleteBatchesDialog.title",BatchesPanel.this));dialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){privatestaticfinallongserialVersionUID=-5552087037163833563L;privateStringerror=null;@OverrideprotectedComponentgetContents(Stringid){StringBuildersb=newStringBuilder();sb.append(newParamResourceModel("confirmDeleteBatchesDialog.content",BatchesPanel.this).getString());for(Batchbatch:batchesPanel.getSelection()){sb.append("\n&nbsp;&nbsp;");sb.append(escapeHtml(batch.getFullName()));
if(configurationModel!=null){configurationModel.getObject().getBatches().remove(batch.getName());
if(batch.getId()!=null){removedBatches.add(batch);
else{TaskManagerBeans.get().getBjService().remove(batch);
if(error!=null){error(error);target.add(remove);((GeoServerBasePage)getPage()).addFeedbackPanels(target);
else{target.add(batchesPanel);
if((property.equals(BatchesModel.NAME)||property.equals(BatchesModel.FULL_NAME))&&itemModel.getObject().getId()!=null){
if(findParent(Form.class)==null){returnnewSimpleAjaxLink<String>(id,(IModel<String>)property.getModel(itemModel)){privatestaticfinallongserialVersionUID=-9184383036056499856L;@OverrideprotectedvoidonClick(AjaxRequestTargettarget){setResponsePage(newBatchPage(itemModel,getPage()));
else{returnnewSimpleAjaxSubmitLink(id,(IModel<String>)property.getModel(itemModel)){privatestaticfinallongserialVersionUID=-9184383036056499856L;@OverrideprotectedvoidonSubmit(AjaxRequestTargettarget,Form<?>form){setResponsePage(newBatchPage(itemModel,getPage()));
else
if(property==BatchesModel.ENABLED){PackageResourceReferenceicon=itemModel.getObject().isEnabled()?CatalogIconFactory.get().getEnabledIcon():CatalogIconFactory.get().getDisabledIcon();Fragmentf=newFragment(id,"iconFragment",BatchesPanel.this);f.add(newImage("enabledIcon",icon));returnf;
else
if(property==BatchesModel.FREQUENCY){returnnewLabel(id,formatFrequency(itemModel.getObject().getFrequency()));
else
if(property==BatchesModel.STATUS){returnnewSimpleAjaxLink<String>(id,(IModel<String>)property.getModel(itemModel)){privatestaticfinallongserialVersionUID=-9184383036056499856L;@OverridepublicvoidonClick(AjaxRequestTargettarget){setResponsePage(newBatchRunsPage(itemModel,getPage()));
else
if(property==BatchesModel.RUN){
if(itemModel.getObject().getId()==null||itemModel.getObject().getElements().isEmpty()||(configurationModel!=null&&configurationModel.getObject().isTemplate())||!TaskManagerBeans.get().getSecUtil().isWritable(((GeoServerSecuredPage)getPage()).getSession().getAuthentication(),itemModel.getObject())){returnnewLabel(id);
else{SimpleAjaxSubmitLinklink=newSimpleAjaxSubmitLink(id,null){privatestaticfinallongserialVersionUID=-9184383036056499856L;@OverrideprotectedvoidonSubmit(AjaxRequestTargettarget,Form<?>form){TaskManagerBeans.get().getBjService().scheduleNow(itemModel.getObject());info(newParamResourceModel("batchStarted",BatchesPanel.this).getString());((GeoServerBasePage)getPage()).addFeedbackPanels(target);
else{returnnull;
if(frequency==null){returnnull;
if(matcher.matches()){intminutes=Integer.parseInt(matcher.group(1));inthour=Integer.parseInt(matcher.group(2));
if(minutes<=60&&hour<24){returnnewParamResourceModel("Daily",this).getString()+","+String.format("%02d",hour)+":"+String.format("%02d",minutes);
else{matcher=FrequencyUtil.WEEKLY_PATTERN.matcher(frequency);
if(matcher.matches()){intminutes=Integer.parseInt(matcher.group(1));inthour=Integer.parseInt(matcher.group(2));DayOfWeekday=FrequencyUtil.findDayOfWeek(matcher.group(3));
if(minutes<=60&&hour<24&&day!=null){returnnewParamResourceModel("Weekly",this).getString()+","+day.getDisplayName(TextStyle.FULL,getLocale())+","+String.format("%02d",hour)+":"+String.format("%02d",minutes);
else{matcher=FrequencyUtil.MONTHLY_PATTERN.matcher(frequency);
if(matcher.matches()){intminutes=Integer.parseInt(matcher.group(1));inthour=Integer.parseInt(matcher.group(2));intday=Integer.parseInt(matcher.group(3));
if(minutes<=60&&hour<24&&day>0&&day<=28){returnnewParamResourceModel("Monthly",this).getString()+","+newParamResourceModel("Day",this).getString()+""+day+","+String.format("%02d",hour)+":"+String.format("%02d",minutes);
iftheerrorisalreadyrecoveredbyadifferenthandler*/publicvoidhandleListenerSetupFailure(Throwableex,booleanalreadyRecovered);}
if(!getInfo().getServiceLevel().getOps().contains(WFSInfo.Operation.TRANSACTION_INSERT)){thrownewWFSException(element,"TransactionINSERTsupportisnotenabled");
if(collection==null){collection=newListFeatureCollection(schema);schema2features.put(schema,collection);
ifsettrytotellthedatastoretouse//theprovidedfid
if(insert.isIdGenUseExisting()){feature.getUserData().put(Hints.USE_PROVIDED_FID,true);
else{Objectidentifier=feature.getAttribute(newNameImpl(GML.NAMESPACE,"identifier"));
if(WFSInfo.Version.V_20.compareTo(insert.getVersion())>=0&&identifierinstanceofString){SimpleFeatureBuilderfb=newSimpleFeatureBuilder(feature.getFeatureType());fb.init(feature);feature=fb.buildFeature((String)identifier);feature.getUserData().put(Hints.USE_PROVIDED_FID,true);
ifinserting//featuresintodifferentfeaturestores,theycouldverywell//getgiventhesameid//JD:changefromlisttomapsothatthemapcanlaterbe//processedandwecanreportthefidsbackinthesameorder//astheyweresuppliedMap<String,List<FeatureId>>schema2fids=newHashMap<String,List<FeatureId>>();for(Iteratorc=schema2features.values().iterator();c.hasNext();){SimpleFeatureCollectioncollection=(SimpleFeatureCollection)c.next();SimpleFeatureTypeschema=collection.getSchema();finalQNameelementName=newQName(schema.getName().getNamespaceURI(),schema.getTypeName());SimpleFeatureStorestore;store=DataUtilities.simple((FeatureStore)featureStores.get(elementName));
if(store==null){thrownewWFSException(request,"CouldnotlocateFeatureStorefor'"+elementName+"'");
if(collection!=null){//
ifwereallyneedto,makesureweareinsertingcoordinatesthatdo//matchtheCRSareaofvalidity
if(getInfo().isCiteCompliant()){checkFeatureCoordinatesRange(collection);
if(defaultGeometry!=null){CoordinateReferenceSystemtarget=defaultGeometry.getCoordinateReferenceSystem();
if(target!=null/*&&!CRS.equalsIgnoreMetadata(collection.getSchema().getCoordinateReferenceSystem(),target)*/){collection=newReprojectingFeatureCollection(collection,target);
if(fids==null){fids=newLinkedList<FeatureId>();schema2fids.put(schema.getTypeName(),fids);
if(types.get(i)instanceofGeometryDescriptor){GeometryDescriptorgat=(GeometryDescriptor)types.get(i);
if(gat.getCoordinateReferenceSystem()!=null){Geometrygeom=(Geometry)f.getAttribute(i);
if(geom!=null)JTS.checkCoordinatesRange(geom,gat.getCoordinateReferenceSystem());
if(!features.isEmpty()){for(Iteratorf=features.iterator();f.hasNext();){Objectnext=f.next();//
ifparsingfailstheparserjustreturnsaMap,dothrowanerrorinthiscase
if(!(nextinstanceofSimpleFeature)){Stringversion=request.getVersion();Stringcode;
if(version==null||newVersion(version).compareTo(WFSInfo.Version.V_20.getVersion())>=0){code=WFSException.INVALID_VALUE;
else{code=ServiceException.INVALID_PARAMETER_VALUE;
else{LOGGER.finer("Insertwasempty-doesnotneedaFeatureSource");
ifclosehasbeencalled,ornotFeatureTypeInfofti=getCatalog().getFeatureTypeByName(getLayerId(MockData.POLYGONS));FeatureSourcefs=fti.getFeatureSource(null,null);SimpleFeatureCollectionfc=(SimpleFeatureCollection)fs.getFeatures();finalAtomicIntegeropenIterators=newAtomicInteger(0);SimpleFeatureCollectiondecorated=neworg.geotools.feature.collection.DecoratingSimpleFeatureCollection(fc){@OverridepublicSimpleFeatureIteratorfeatures(){openIterators.incrementAndGet();finalSimpleFeaturef=DataUtilities.first(delegate);returnnewSimpleFeatureIterator(){@OverridepublicSimpleFeaturenext()throwsNoSuchElementException{returnf;
if(v==null){returnOptional.empty();
if(keyStoreInputStream==null){thrownewFileNotFoundException("Couldnotfindfilenamed'"+keyStoreName+"'intheCLASSPATH");
if(STYLE!=null){nodeInfoContainer.add(newAttributeAppender("style",newModel<String>(STYLE),";"));
if(committed){hook.handlePostCommit(eng,txReq,txRes,context);
else{hook.handleAbort(eng,txReq,txRes,context);
if(ready!=null){ready.countDown();readied=true;ready.await();
if(ready!=null&&!readied){try{ready.countDown();
if(done!=null){done.countDown();
if(problem!=null){throwproblem;
if(node.hasChild("LockId")){transaction.setLockId((String)node.getChildValue("LockId"));
if(cvinstanceofInsertElementType){transaction.getInsert().add(cv);
else
if(cvinstanceofUpdateElementType){transaction.getUpdate().add(cv);
else
if(cvinstanceofDeleteElementType){transaction.getDelete().add(cv);
else
if(cvinstanceofNativeType){transaction.getNative().add(cv);
if(node.hasAttribute(AllSomeType.class)){transaction.setReleaseAction((AllSomeType)node.getAttributeValue(AllSomeType.class));
ifweusethelatterduetosmallreprojectionerrorsStringxml="<?xmlversion=\"1.0\"encoding=\"UTF-8\"?>\n"+"<wps:Executeversion=\"1.0.0\"service=\"WPS\"xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"xmlns=\"http://www.opengis.net/wps/1.0.0\"xmlns:wfs=\"http://www.opengis.net/wfs\"xmlns:wps=\"http://www.opengis.net/wps/1.0.0\"xmlns:ows=\"http://www.opengis.net/ows/1.1\"xmlns:gml=\"http://www.opengis.net/gml\"xmlns:ogc=\"http://www.opengis.net/ogc\"xmlns:wcs=\"http://www.opengis.net/wcs/1.1.1\"xmlns:xlink=\"http://www.w3.org/1999/xlink\"xsi:schemaLocation=\"http://www.opengis.net/wps/1.0.0http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd\">\n"+"<ows:Identifier>gs:Reproject</ows:Identifier>\n"+"<wps:DataInputs>\n"+"<wps:Input>\n"+"<ows:Identifier>features</ows:Identifier>\n"+"<wps:ReferencemimeType=\"text/xml;subtype=wfs-collection/1.0\"xlink:href=\"http://geoserver/wfs\"method=\"POST\">\n"+"<wps:Body>\n"+"<wfs:GetFeatureservice=\"WFS\"version=\"1.0.0\"outputFormat=\"GML2\">\n"+"<wfs:QuerytypeName=\""+getLayerId(MockData.BASIC_POLYGONS)+"\"/>\n"+"</wfs:GetFeature>\n"+"</wps:Body>\n"+"</wps:Reference>\n"+"</wps:Input>\n"+"<wps:Input>\n"+"<ows:Identifier>targetCRS</ows:Identifier>\n"+"<wps:Data>\n"+"<wps:LiteralData>EPSG:3395</wps:LiteralData>\n"+"</wps:Data>\n"+"</wps:Input>\n"+"</wps:DataInputs>\n"+"<wps:ResponseForm>\n"+"<wps:RawDataOutputmimeType=\"text/xml;subtype=wfs-collection/1.1\">\n"+"<ows:Identifier>result</ows:Identifier>\n"+"</wps:RawDataOutput>\n"+"</wps:ResponseForm>\n"+"</wps:Execute>";Documentresponse=postAsDOM(root(),xml);//print(response);//thistestworksjustfineonmylocalmachinebutthereisnotchancetoget//itworkingonthebuildserver...givingup...//assertXpathEvaluatesTo(//"http://www.opengis.net/gml/srs/epsg.xml#3395",//"(//gml:boundedBy)[2]/gml:Envelope/@srsName",//response);//assertXpathEvaluatesTo("-222638.98158654713-110579.96522189587",//"(//gml:boundedBy)[1]/gml:Envelope/gml:lowerCorner",response);}}
if(props.containsKey(FILENAME_REGEX)){setFilenameRegex(props.get(FILENAME_REGEX).toString());
if(props.containsKey(TIME_FORMAT)){setTimeFormat(props.get(TIME_FORMAT).toString());
if(!m.matches()||m.groupCount()!=2){//reportbackmessageStringmsg="Failureparsingtimefromfile"+filename+"withpattern"+getFilenameRegex();g.setMessage(msg);LOGGER.log(Level.WARNING,msg);returnnull;
if(available)initialiseTest();
if*{@link#connect()}fails.*/publicstaticfinalStringSKIP_ON_FAILURE_KEY="skip.on.failure";/**Thedefaultvalueusedfor{@link#SKIP_ON_FAILURE_KEY}
ifitisnotpresent.*/publicstaticfinalStringSKIP_ON_FAILURE_DEFAULT="true";protectedbooleanskipOnFailure=true;/***Astaticmapwhichtrackswhichfixturefilescannotbefound.Thispreventscontinually*lookingupthefileandreportingitnotfoundtotheuser.*/protectedstaticMap<String,Boolean>found=newHashMap<String,Boolean>();@OverrideprotectedvoidsetUpTestData(SystemTestDatatestData)throwsException{setup.setUp();super.setUpTestData(testData);
if(skipOnFailure){//disablethetestfixture=null;//leavesometraceoftheswallowedexceptione.printStackTrace();
else{//donotswallowtheexceptionthrowe;
ifpresent,*andteststheconnectionusing{@link#isOnline()}.**@returntrue
iffixtureisavailableforuse*@throwsFileNotFoundException*/protectedbooleancheckAvailable()throwsException{setup.configureFixture();fixture=setup.getFixture();
if(fixture==null){returnfalse;
else{StringfixtureId=getFixtureId();setup.setFixture(fixture);//doanonline/offlinecheckMap<String,Boolean>online=setup.getOnlineMap();Booleanavailable=(Boolean)online.get(fixtureId);
if(available==null||available.booleanValue()){//testtheconnectiontry{available=isOnline();
if(secMgr.isStrongEncryptionAvailable()){add(newLabel("strongEncryptionMsg",newStringResourceModel("strongEncryption",this,null)).add(newAttributeAppender("class",newModel("info-link"),"")));
else{add(newLabel("strongEncryptionMsg",newStringResourceModel("noStrongEncryption",this,null)).add(newAttributeAppender("class",newModel("warning-link"),"")));
ifoutputFormatisnotavalidjsonmimetype*/publicGeoJSONFeatureInfoResponse(finalWMSwms,finalStringoutputFormat)throwsException{super(outputFormat);this.wms=wms;
if(input==null){returnnull;
else
if(inputinstanceofFilter){returninput;
else
if(inputinstanceofString){returndecode(IOUtils.toInputStream((String)input));
else{thrownewIllegalArgumentException("Cannotconvert"+input+"intoaFilterobject");
if(maxFeatures==null){maxFeatures=Integer.MAX_VALUE;
if(featureBounding!=null){wfs.setFeatureBounding(featureBounding);
if(hitsIgnoreMaxFeatures!=null){wfs.setHitsIgnoreMaxFeatures(hitsIgnoreMaxFeatures);
if(srsXmlStyle){gml.setSrsNameStyle(SrsNameStyle.XML);
else{gml.setSrsNameStyle(SrsNameStyle.NORMAL);
if(context==null||!isGwcServiceTargeted(context)){returnnull;
ifweareinthepresenceofvirtualserviceweneedtoadapttherequestWorkspaceInfolocalWorkspace=LocalWorkspace.get();PublishedInfolocalPublished=LocalPublished.get();
if(localWorkspace!=null){//thisisavirtualservicerequestStringlayerName=(String)request.getKvp().get("LAYER");
if(layerName==null){layerName=(String)request.getKvp().get("layer");
if(layerName!=null){//wehavealayernameasparameterweneedtoadaptit(gwcdoesn'tcareabout//workspaces)layerName=CatalogConfiguration.removeWorkspacePrefix(layerName,catalog);layerName=localWorkspace.getName()+":"+layerName;//wesetthelayerparameterwithGWCexpectednamekvp.put("LAYER",layerName);
else
if(localPublished!=null){request.setHttpRequest(newVirtualServiceRequest(request.getHttpRequest(),localPublished.getName(),null,null));
iftheGWCserviceistargetedbasedontherequestcontext.*/privatebooleanisGwcServiceTargeted(Stringcontext){
if(context.startsWith("gwc/service")){//isgwcistargetedreturntrue;
if(matcher.matches()){//thisisavirtualservice,let'ssee
ifwehaveavalidworkspace
if(LocalWorkspace.get()==null&&!(LocalPublished.get()instanceofLayerGroupInfo)){//theworkspacenamehastobevalidthrownewServiceException("Nosuchworkspace'"+matcher.group(1)+"'");
if(matcher.matches()){//thisisalayespecificvirtualservice,let'ssee
ifwehaveavalidworkspace
if(LocalPublished.get()==null){//theworkspacenamehastobevalidthrownewServiceException("Nosuchlayerorlayergroup'"+matcher.group(2)+"'");
if(layerName!=null){parameters.put("layer",newString[]{layerName});
if(localPublishedName==null){returnsuper.getContextPath()+"/"+localWorkspaceName;
else{returnsuper.getContextPath()+"/"+localWorkspaceName+"/"+localPublishedName;
if(layerName!=null&&name.equalsIgnoreCase("layer")){returnlayerName;
if(layerName!=null&&name.equalsIgnoreCase("layer")){returnnewString[]{layerName};
ifwedon'thaveanygc=(GridCoverage2D)reader.read(null);assertEquals(-9999d,CoverageUtilities.getNoDataProperty(gc).getAsSingleValue(),0d);
if(gc!=null){RenderedImageri=gc.getRenderedImage();
if(gcinstanceofGridCoverage2D){gc.dispose(true);
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
if(GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){assertTrue(expandedDs.getConnectionParameters().get("host").equals(gsEnvironment.resolveValue("${jdbc.host}")));assertTrue(expandedDs.getConnectionParameters().get("port").equals(gsEnvironment.resolveValue("${jdbc.port}")));
else{assertTrue(expandedDs.getConnectionParameters().get("host").equals("${jdbc.host}"));assertTrue(expandedDs.getConnectionParameters().get("port").equals("${jdbc.port}"));
ifthestoreisanOracleonewithoutaschemaspecified).*Makesureit'snotbeingcalledunlessthefeaturetypeisreallynotcacheable.*/@OverrideprotectedNamegetTemporaryName(FeatureTypeInfoinfo,DataAccess<?extendsFeatureType,?extendsFeature>dataAccess,FeatureTypeCallbackinitializer)throwsIOException{
if(VT_NAME.equals(info.getNativeName())){counter.incrementAndGet();
if(ServiceInfo.class.isAssignableFrom(interfce)){returnSERVICE;
if(interfce.equals(cm.getInterface())){returncm;
if(ServiceInfo.class.isAssignableFrom(clazz)){returnSERVICE;
if(clazz==cm.getImpl())returncm;
if(timeoutModel.getObject()==null){timeoutModel.setObject(TimeoutCallback.TIMEOUT_CONFIG_DEFAULT);
if(ttl==1){done1.countDown();break;
if(!exists){done2.countDown();break;
if(count==REQUESTS/2){//ChangedatabaseOutputStreamout=resource.out();properties.store(out,null);out.close();
if(condition){done.countDown();break;
if(identifiers==null||identifiers.size()==0){thrownewWcsException("Requiredparamer,sourcecoverage,missing",WcsExceptionCode.MissingParameterValue,"sourcecoverage");
if(layer==null||layer.getType()!=PublishedType.RASTER)thrownewWcsException("Couldnotfindsourcecoverage'"+coverage+"'",InvalidParameterValue,"sourcecoverage");coverages.add(coverage);
if(coverages.size()>1){thrownewWcsException("Wrongparameter,sourcecoverage,morethanoneidentifierwasspecified",WcsExceptionCode.InvalidParameterValue,"sourcecoverage");
ifthegivenpointisinternalforthistriangle.**@parampoint*/publicbooleanContainsPoint(Vertexpoint){//returntrue
ifthepointtotestisoneofthevertices
if(point.equals(A)||point.equals(B)||point.equals(C))returntrue;booleanoddNodes=false;
if(checkPointToSegment(C,A,point))oddNodes=!oddNodes;
if(checkPointToSegment(A,B,point))oddNodes=!oddNodes;
if(checkPointToSegment(B,C,point))oddNodes=!oddNodes;returnoddNodes;
ifthegivenpointisinternalforthetrianglebuildfrom(a,b,c).**@parampoint*/publicstaticbooleanContainsPoint(Vertexa,Vertexb,Vertexc,Vertexpoint){returnnewTriangle(a,b,c).ContainsPoint(point);
if((sA.getPosition().y<point.getPosition().y&&sB.getPosition().y>=point.getPosition().y)||(sB.getPosition().y<point.getPosition().y&&sA.getPosition().y>=point.getPosition().y)){doublex=sA.getPosition().x+(point.getPosition().y-sA.getPosition().y)/(sB.getPosition().y-sA.getPosition().y)*(sB.getPosition().x-sA.getPosition().x);
if(x<point.getPosition().x)returntrue;
if(!(objinstanceofTriangle))returnfalse;Trianglet=(Triangle)obj;returnt.A.equals(A)&&t.B.equals(B)&&t.C.equals(C);
switch(type){caseMISSING:returnparamName+"ismissingbutrequiredfortasktype"+taskType;caseINVALID_PARAM:returnparamName+"isnotavalidparameterfortasktype"+taskType;caseINVALID_VALUE:returnparamValue+"isnotavalidparametervalueforparameter"+paramName+"intasktype"+taskType;caseMISSING_DEPENDENCY:returnparamName+"ismissingbutrequiredasdependencyfor"+paramValue+"intasktype"+taskType;default:return"validationError";
if(!oldName.equals(newName)){Map<Name,LayerInfo>nameMap=getMapForValue(nameMultiMap,LayerInfoImpl.class);LayerInfovalue=nameMap.remove(oldName);//handlecaseoffeaturetypewithoutacorrespondinglayer
if(value!=null){nameMap.put(newName,value);
if(workspace==ANY_WORKSPACE){result=stores.findFirst(clazz,s->name.equals(s.getName()));
else{Nameqname=newNameImpl((workspace!=null)?workspace.getId():null,name);result=stores.findByName(qname,clazz);
if(workspace==null){ws=getDefaultWorkspace();
else{ws=workspace;
if(defaultStores.containsKey(workspace.getId())){DataStoreInfodefaultStore=defaultStores.get(workspace.getId());returnModificationProxy.create(defaultStore,DataStoreInfo.class);
else{returnnull;
if(store!=null){defaultStores.put(workspace.getId(),store);
else{defaultStores.remove(workspace.getId());
if(namespace==ANY_NAMESPACE){result=resources.findFirst(clazz,r->name.equals(r.getName()));
else{Nameqname=newNameImpl(namespace!=null?namespace.getId():null,name);result=resources.findByName(qname,clazz);
if(namespace==null){ns=getDefaultNamespace();
else{ns=namespace;
if(store.getWorkspace()!=null&&store.getWorkspace().getName()!=null&&(ns=getNamespaceByPrefix(store.getWorkspace().getName()))!=null){resource=resources.findByName(newNameImpl(ns.getId(),name),clazz);
if(resource!=null&&!(store.equals(resource.getStore()))){returnnull;
else{//shouldnothappen,butsomebrokentestcodesetsupnamespaceswithoutequivalent//workspaces//orstoreswithoutworkspacesresource=resources.findFirst(clazz,r->name.equals(r.getName())&&store.equals(r.getStore()));
if(ci!=null){returnModificationProxy.create(ci,clazz);
else{returnnull;
if(layer==null){returnCollections.emptyList();
else{List<LayerInfo>matches=newArrayList<>();matches.add(layer);returnModificationProxy.createList(matches,LayerInfo.class);
if(id.equals(map.getId())){returnModificationProxy.create(map,MapInfo.class);
if(name.equals(map.getName())){returnModificationProxy.create(map,MapInfo.class);
if(workspace==null){ws=getDefaultWorkspace();
else{ws=workspace;
if(workspace==NO_WORKSPACE){predicate=lg->lg.getWorkspace()==null;
else{predicate=lg->ws.equals(lg.getWorkspace());
if(workspace==NO_WORKSPACE){match=layerGroups.findByName(newNameImpl(null,name),LayerGroupInfo.class);
else
if(ANY_WORKSPACE==workspace){match=layerGroups.findFirst(LayerGroupInfo.class,lg->name.equals(lg.getName()));
else{match=layerGroups.findByName(newNameImpl(workspace.getId(),name),LayerGroupInfo.class);
if(namespace.equals(defaultNamespace)){defaultNamespace=null;
if(workspace.equals(this.defaultWorkspace)){this.defaultWorkspace=null;
if(!workspace.getName().equals(ws.getName())){DataStoreInfods=defaultStores.remove(ws.getName());
if(ds!=null){defaultStores.put(workspace.getName(),ds);
if(match==null){match=styles.findFirst(StyleInfo.class,s->name.equals(s.getName()));
if(null==workspace){thrownewNullPointerException("workspace");
if(null==name){thrownewNullPointerException("name");
if(workspace==ANY_WORKSPACE){returngetStyleByName(name);
else{Namesn=newNameImpl(workspace==null?null:workspace.getId(),name);StyleInfomatch=styles.findByName(sn,StyleInfo.class);returnwrapInModificationProxy(match,StyleInfo.class);
if(workspace==NO_WORKSPACE){matches=styles.list(StyleInfo.class,s->s.getWorkspace()==null);
else{WorkspaceInfows;
if(workspace==null){ws=getDefaultWorkspace();
else{ws=workspace;
if(stores!=null)stores.clear();
if(defaultStores!=null)defaultStores.clear();
if(resources!=null)resources.clear();
if(namespaces!=null)namespaces.clear();
if(workspaces!=null)workspaces.clear();
if(layers!=null)layers.clear();
if(layerGroups!=null)layerGroups.clear();
if(maps!=null)maps.clear();
if(styles!=null)styles.clear();
if(workspaces==null){workspaces=newCatalogInfoLookup<>(WORKSPACE_NAME_MAPPER);
if(namespaces==null){namespaces=newCatalogInfoLookup<>(NAMESPACE_NAME_MAPPER);
if(stores==null){stores=newCatalogInfoLookup<>(STORE_NAME_MAPPER);
if(styles==null){styles=newCatalogInfoLookup<>(STYLE_NAME_MAPPER);
if(resources==null){resources=newCatalogInfoLookup<>(RESOURCE_NAME_MAPPER);
if(layers==null){layers=newLayerInfoLookup();
if(layerGroups==null){layerGroups=newCatalogInfoLookup<>(LAYERGROUP_NAME_MAPPER);
if(maps==null){maps=newArrayList<MapInfo>();
if(daoinstanceofDefaultCatalogFacade){//doanoptimizedsyncDefaultCatalogFacadeother=(DefaultCatalogFacade)dao;other.stores=stores.setCatalog(catalog);other.defaultStores=defaultStores;other.resources=resources.setCatalog(catalog);other.defaultNamespace=defaultNamespace;other.namespaces=namespaces.setCatalog(catalog);other.defaultWorkspace=defaultWorkspace;other.workspaces=workspaces.setCatalog(catalog);other.layers=layers.setCatalog(catalog);other.maps=maps;other.layerGroups=layerGroups.setCatalog(catalog);other.styles=styles.setCatalog(catalog);
else{//doamanualimportfor(WorkspaceInfows:workspaces.values()){dao.add(ws);
if(defaultWorkspace!=null){dao.setDefaultWorkspace(defaultWorkspace);
if(defaultNamespace!=null){dao.setDefaultNamespace(defaultNamespace);
if(null!=ws){dao.setDefaultDataStore(ws,e.getValue());
if(i==path.length-1){booleanprimitive=clazz.isPrimitive();booleancomparable=Comparable.class.isAssignableFrom(clazz);booleancanSort=primitive||comparable;returncanSort;
if(sortOrder!=null){sortOrderList=newSortBy[]{sortOrder};
if(sortOrder!=null){for(SortByso:sortOrder){
if(sortOrder!=null&&!canSort(of,so.getPropertyName().getPropertyName())){thrownewIllegalArgumentException("Can'tsortobjectsoftype"+of.getName()+"by"+so.getPropertyName());
if(offset!=null&&offset.intValue()>0){iterable=Iterables.skip(iterable,offset.intValue());
if(count!=null&&count.intValue()>=0){iterable=Iterables.limit(iterable,count.intValue());
if(NamespaceInfo.class.isAssignableFrom(of)){all=(List<T>)namespaces.list(of,toPredicate(filter));
else
if(WorkspaceInfo.class.isAssignableFrom(of)){all=(List<T>)workspaces.list(of,toPredicate(filter));
else
if(StoreInfo.class.isAssignableFrom(of)){all=(List<T>)stores.list(of,toPredicate(filter));
else
if(ResourceInfo.class.isAssignableFrom(of)){all=(List<T>)resources.list(of,toPredicate(filter));
else
if(LayerInfo.class.isAssignableFrom(of)){all=(List<T>)layers.list(of,toPredicate(filter));
else
if(LayerGroupInfo.class.isAssignableFrom(of)){all=(List<T>)layerGroups.list(of,toPredicate(filter));
else
if(PublishedInfo.class.isAssignableFrom(of)){all=newArrayList<>();all.addAll((List<T>)layers.list(LayerInfo.class,toPredicate(filter)));all.addAll((List<T>)layerGroups.list(LayerGroupInfo.class,toPredicate(filter)));
else
if(StyleInfo.class.isAssignableFrom(of)){all=(List<T>)styles.list(of,toPredicate(filter));
else
if(MapInfo.class.isAssignableFrom(of)){all=(List<T>)newArrayList<>(maps);
else{thrownewIllegalArgumentException("Unknowntype:"+of);
if(null!=sortByList){for(inti=sortByList.length-1;i>=0;i--){SortBysortBy=sortByList[i];Ordering<Object>ordering=Ordering.from(comparator(sortBy));
if(SortOrder.DESCENDING.equals(sortBy.getSortOrder())){ordering=ordering.reverse();
if(filter!=null&&filter!=Filter.INCLUDE){returno->filter.evaluate(o);
else{returnCatalogInfoLookup.TRUE;
if(v1==null){
if(v2==null){return0;
else{return-1;
else
if(v2==null){return1;
if(LOGGER.isLoggable(Level.FINE)){try{LOGGER.fine("Palettehasbeenparsedto"+toSLD(sld));
if(rc!=null){rc.close();
if(objinstanceofVariableFilterChain==false)returnfalse;VariableFilterChainother=(VariableFilterChain)obj;
if(this.interceptorName==null&&other.interceptorName!=null)returnfalse;
if(this.interceptorName!=null&&this.interceptorName.equals(other.interceptorName)==false)returnfalse;returnsuper.equals(obj);
if(ci==null){thrownewWPSException("Couldnotfindcoverage"+name);
if(filter!=null){params=CoverageUtils.mergeParameter(parameterDescriptors,params,filter,"FILTER","Filter");
if(CatalogConfiguration.isLayerExposable(l)){++validLayers;
if(parent==null)return"";
elsereturnparent.getAuthority();
if(item.getProperties().size()==0)returnBoolean.FALSE;
elsereturnBoolean.TRUE;
if(roleServiceName!=null)service=GeoServerApplication.get().getSecurityManager().loadRoleService(roleServiceName);
if(service==null)roles=newTreeSet<GeoServerRole>();
elseroles=service.getRoles();
ifwe'rerunningagainstabrowsersupportedbyCodeMirrorbooleanenableCodeMirror=isCodeMirrorSupported();container=newWebMarkupContainer("editorContainer");container.setOutputMarkupId(true);add(container);WebMarkupContainertoolbar=newWebMarkupContainer("toolbar");toolbar.setVisible(enableCodeMirror);container.add(toolbar);customButtons=newRepeatingView("custom-buttons");toolbar.add(customButtons);WebMarkupContainereditorParent=newWebMarkupContainer("editorParent");
if(enableCodeMirror){editorParent.add(AttributeModifier.replace("style","border:1pxsolidblack;padding-bottom:3px"));
if(enableCodeMirror){editor.add(newCodeMirrorBehavior());
else{editor.add(AttributeModifier.replace("style","width:100%"));
if(clientProperties.isBrowserInternetExplorer()){ClientPropertiesprops=extractIEVersion(clientProperties.getNavigatorUserAgent());enableCodeMirror=clientProperties.getBrowserVersionMajor()>=8||props.getBrowserVersionMajor()>=8;
else
if(clientProperties.isBrowserMozillaFirefox()){ClientPropertiesprops=extractFirefoxVersion(clientProperties.getNavigatorUserAgent());enableCodeMirror=clientProperties.getBrowserVersionMajor()>=3||props.getBrowserVersionMajor()>=3;
else
if(clientProperties.isBrowserSafari()){ClientPropertiesprops=extractSafariVersion(clientProperties.getNavigatorAppVersion());enableCodeMirror=clientProperties.getBrowserVersionMajor()>5||(clientProperties.getBrowserVersionMajor()==5&&clientProperties.getBrowserVersionMinor()>=2)||props.getBrowserVersionMajor()>5||(props.getBrowserVersionMajor()==5&&props.getBrowserVersionMinor()>=2);
else
if(clientProperties.isBrowserOpera()){ClientPropertiesprops=extractOperaVersion(clientProperties.getNavigatorAppVersion());enableCodeMirror=clientProperties.getBrowserVersionMajor()>=9||props.getBrowserVersionMajor()>=9;
if(userAgent!=null){StringuserAgencyLc=userAgent.toLowerCase();Stringpattern;
if(userAgencyLc.contains("likegecko")){pattern="rv:(\\d+)\\.(\\d+)";
else{pattern="msie(\\d+)\\.(\\d+)";
if(userAgent!=null){StringuserAgencyLc=userAgent.toLowerCase();props.setBrowserVersionMajor(-1);props.setBrowserVersionMinor(-1);setMajorMinorVersionByPattern(userAgencyLc,"firefox/(\\d+)\\.(\\d+)",props);
if(userAgent!=null){StringuserAgencyLc=userAgent.toLowerCase();
if(userAgencyLc.startsWith("opera/")&&userAgencyLc.contains("version/")){setMajorMinorVersionByPattern(userAgencyLc,"version/(\\d+)\\.(\\d+)",props);
else
if(userAgencyLc.startsWith("opera/")&&!userAgencyLc.contains("version/")){setMajorMinorVersionByPattern(userAgencyLc,"opera/(\\d+)\\.(\\d+)",props);
else{setMajorMinorVersionByPattern(userAgencyLc,"opera(\\d+)\\.(\\d+)",props);
if(userAgent!=null){StringuserAgencyLc=userAgent.toLowerCase();setMajorMinorVersionByPattern(userAgencyLc,"version/(\\d+)\\.(\\d+)",props);
if(matcher.find()){properties.setBrowserVersionMajor(Integer.parseInt(matcher.group(1)));properties.setBrowserVersionMinor(Integer.parseInt(matcher.group(2)));
if(requestTarget!=null){Stringjavascript="document.gsEditors."+editor.getMarkupId()+".setOption('mode','"+mode+"');";requestTarget.appendJavaScript(javascript);
if(is!=null){Writerwriter=newStringWriter();char[]buffer=newchar[1024];try{Readerreader=newBufferedReader(newInputStreamReader(is,"UTF-8"));intn;while((n=reader.read(buffer))!=-1){writer.write(buffer,0,n);
else{return"";
if(!findAndCall("preInsert",engine,inserted,tx,context)){super.doHandlePreInsert(engine,inserted,tx,context);
if(!findAndCall("postInsert",engine,inserted,tx,context)){super.doHandlePostInsert(engine,inserted,tx,context);
if(!findAndCall("preUpdate",engine,updated,props,tx,context)){super.doHandlePreUpdate(engine,updated,props,tx,context);
if(!findAndCall("postUpdate",engine,updated,props,tx,context)){super.doHandlePostUpdate(engine,updated,props,tx,context);
if(!findAndCall("preDelete",engine,deleted,tx,context)){super.doHandlePreDelete(engine,deleted,tx,context);
if(!findAndCall("postDelete",engine,deleted,tx,context)){super.doHandlePostDelete(engine,deleted,tx,context);
if(!findAndCall("before",engine,tx,context)){super.doHandleBefore(engine,tx,context);
if(!findAndCall("preCommit",engine,tx,context)){super.doHandlePreCommit(engine,tx,context);
if(!findAndCall("postCommit",engine,tx,result,context)){super.doHandlePostCommit(engine,tx,result,context);
if(!findAndCall("abort",engine,tx,result,context)){super.doHandleAbort(engine,tx,result,context);
if(e.getCause()instanceofPyException){PyExceptionpye=(PyException)e.getCause();
if(pye.value!=null){Objectwfse=pye.value.__tojava__(Exception.class);
if(wfseinstanceofWFSException){throw(WFSException)wfse;
if(oinstanceofPyFunction){PyFunctionf=(PyFunction)o;PyObjectd=f.__findattr__("__decorator__");
if(dinstanceofPyFunction&&name.equals(((PyFunction)d).__name__)){returnf;
if(f!=null){call(f,args);returntrue;
if(realLogInfo==null){return;
ifLoggingInfogetsnewproperties,thisshouldstill//work.KSClassPropertiesproperties=OwsUtils.getClassProperties(LoggingInfo.class);List<String>propertyNames=newArrayList<String>(properties.properties().size());List<Object>newValues=newArrayList<Object>(properties.properties().size());List<Object>oldValues=newArrayList<Object>(properties.properties().size());finalLevelpropertyTableLevel=Level.FINE;LOGGER.log(propertyTableLevel,"CheckingLoggingconfigurationincaseitneeedstobereinitialized");for(StringpropName:properties.properties()){//Don'tcareaboutthereturntypeMethodread=properties.getter(propName,null);ObjectnewVal=read.invoke(realLogInfo);ObjectoldVal=read.invoke(startLogInfo);
if((newVal==null&&oldVal==null)||(newVal!=null&&newVal.equals(oldVal))){//ValuesthesameLOGGER.log(propertyTableLevel,"==={0}(logging.xml:{1},JDBCConfig:{2})",newObject[]{read.getName(),oldVal,newVal});
else{//ValuesdifferentpropertyNames.add(propName);newValues.add(newVal);oldValues.add(oldVal);LOGGER.log(propertyTableLevel,"=/={0}(logging.xml:{1},JDBCConfig:{2})",newObject[]{read.getName(),oldVal,newVal});
if(!(propertyNames.isEmpty()||(propertyNames.size()==1&&propertyNames.get(0).equals("Id")))){LOGGER.log(Level.WARNING,"StartuploggingconfigdoesnotmatchthatinJDBCConfig.Reconfiguringnow.Logsprecedingthismessagemayreflectadifferentconfiguration.");LoggingUtils.initLogging(resourceLoader,realLogInfo.getLevel(),!realLogInfo.isStdOutLogging(),realLogInfo.getLocation());
if(global.getSettings()==null){SettingsInfodefaultSettings=geoServer.getFactory().createSettings();add(defaultSettings);global.setSettings(defaultSettings);//JD:disablingthischeck,globalsettingsshouldhaveanid//}elseif(null==global.getSettings().getId()){
else{add(global.getSettings());
if(null==getGlobal()){db.add(global);
else{db.save(ModificationProxy.create(global,GeoServerInfo.class));
if(null==getLogging()){db.add(logging);
else{db.save(ModificationProxy.create(logging,LoggingInfo.class));
if(workspace!=null&&workspace!=ANY_WORKSPACE){returnequal("workspace.id",workspace.getId());
else{returnfilterForGlobal();
if(null!=workspace&&ANY_WORKSPACE!=workspace){finalStringwsId=workspace.getId();FilterwsFilter=equal("workspace.id",wsId);filter=and(filter,wsFilter);
if(null==curId){finalStringuid=newUID().toString();finalStringid=type.getSimpleName()+"."+uid;OwsUtils.set(info,"id",id);
if(!item.getModelObject().isAvailable()){radio.setEnabled(false);
if(t.isDone()){try{
if(t.getError()!=null){error(t.getError());
else
if(t.isCancelled()){//donothing
else{ImportContextimp=t.get();//checktheimportforactualthingstodobooleanproceed=!imp.getTasks().isEmpty();
if(proceed){imp.setArchive(false);importer.changed(imp);PageParameterspp=newPageParameters();pp.add("id",imp.getId());setResponsePage(ImportPage.class,pp);
else{info("Nodatatoimportwasfound");importer.delete(imp);
if(self.equals(component)&&method.getDeclaringClass().equals(org.apache.wicket.behavior.IBehaviorListener.class)&&method.getName().equals("onRequest")){returntrue;
if(task!=null&&!task.isDone()&&!task.isCancelled()){task.getMonitor().setCanceled(true);task.cancel(false);try{task.get();
if(targetWorkspace==null){Catalogcat=getCatalog();StringwsName=workspaceNameTextField.getDefaultModelObjectAsString();targetWorkspace=cat.getWorkspaceByName(wsName);
if(targetWorkspace==null){targetWorkspace=cat.getFactory().createWorkspace();targetWorkspace.setName(wsName);NamespaceInfons=cat.getFactory().createNamespace();ns.setPrefix(wsName);try{ns.setURI("http://opengeo.org/#"+URLEncoder.encode(wsName,"ASCII"));
if(target!=null){target.add(storeChoice);target.add(workspaceNameTextField.getParent());
if(sourcePanel.size()>0){sourcePanel.remove("content");
if(target!=null){target.add(sourcePanel);
if(!source.isAvailable()){get("name").add(AttributeModifier.replace("style","font-style:italic;"));add(AttributeModifier.replace("title","Datasourcenotavailable.Please"+"installrequiredpluginanddrivers."));
else{extra.setVisible(false);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"DataStoreclassnotavailable:"+className,e);
if(clazz==null){returnfalse;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"ErrorcreatingDataStorefactory:"+className,e);
if(factory==null){returnfalse;
if(Double.class.isAssignableFrom(type)){return(IConverter<C>)decimalConverter;
ifweareexcecutingfromanIDE;theversionisextractedfromthe//compiledjarAssume.assumeFalse(ModuleStatusImpl.class.getResource("ModuleStatusImpl.class").getProtocol().equals("file"));tester.assertRenderedPage(StatusPage.class);tester.clickLink("tabs:tabs-container:tabs:1:link",true);tester.assertContains("gs-main");Componentcomponent=tester.getComponentFromLastRenderedPage("tabs:panel:listViewContainer:modules:1:version");assertTrue(componentinstanceofLabel);assertNotNull(component.getDefaultModelObjectAsString());assertNotEquals("",component.getDefaultModelObjectAsString().trim());
if(exception!=null){ParamResourceModelrm=newParamResourceModel("GWC.diskQuotaLoadFailed",null,exception.getMessage());label.setDefaultModelObject(rm.getString());
else{label.setVisible(false);
if{@linkGeoServerUser#getPassword()}haschanged*(rereadfrombackend,checkforaprefix,...)**<p>ifthepasswordhaschanged,itisarawpasswordandthemethodmustuse*#getPasswordValidatorName()tovalidatetherawpasswordand#getPasswordEncoderName()to**<p>encodethepassword.**@paramuser*/voidupdateUser(GeoServerUseruser)throwsIOException,PasswordPolicyException;/***Removesthespecifieduser**@paramuser*/booleanremoveUser(GeoServerUseruser)throwsIOException;/***Addsagroup**@paramgroup*/voidaddGroup(GeoServerUserGroupgroup)throwsIOException;/***Updatesagroup**@paramgroup*/voidupdateGroup(GeoServerUserGroupgroup)throwsIOException;/***Removesthespecifiedgroup.**@paramgroup*/booleanremoveGroup(GeoServerUserGroupgroup)throwsIOException;/***Synchronizesallchangeswiththebackendstore.Onsuccess,theassociated{@link*GeoServerUserGroupService}objectshouldbeloaded*/voidstore()throwsIOException;/***Associatesauserwithagroup,onsuccess**@paramuser*@paramgroup*/voidassociateUserToGroup(GeoServerUseruser,GeoServerUserGroupgroup)throwsIOException;/***Disassociatesauserfromagroup,onsuccess**@paramuser*@paramgroup*/voiddisAssociateUserFromGroup(GeoServerUseruser,GeoServerUserGroupgroup)throwsIOException;/***returnstrue
iftherearependingmodificationsnotwrittentothebackendstore**@returntrue/false*/booleanisModified();}
if(logging==GeoToolsLoggingRedirection.JavaLogging){//noredirectionneeded
else
if(logging==GeoToolsLoggingRedirection.CommonsLogging){Logging.ALL.setLoggerFactory(CommonsLoggerFactory.getInstance());
else{Logging.ALL.setLoggerFactory(Log4JLoggerFactory.getInstance());
if(Boolean.valueOf(relinquishLoggingControl)){getLogger().info("RELINQUISH_LOG4J_CONTROLon,won'tattempttoreconfigureLOG4Jloggers");
else{try{FilebaseDir=newFile(GeoServerResourceLoader.lookupGeoServerDataDirectory(context));GeoServerResourceLoaderloader=newGeoServerResourceLoader(baseDir);LoggingInfologinfo=getLogging(loader);
if(loginfo!=null){finalStringlocation=LoggingUtils.getLogFileLocation(loginfo.getLocation(),event.getServletContext());LoggingUtils.initLogging(loader,loginfo.getLevel(),!loginfo.isStdOutLogging(),location);
else{//checkforoldstyledatadirectoryFilef=loader.find("services.xml");
if(f!=null){LegacyLoggingImporterloggingImporter=newLegacyLoggingImporter();loggingImporter.imprt(baseDir);finalStringlocation=LoggingUtils.getLogFileLocation(loggingImporter.getLogFile(),null);LoggingUtils.initLogging(loader,loggingImporter.getConfigFileName(),loggingImporter.getSuppressStdOutLogging(),location);
else{getLogger().log(Level.WARNING,"Couldnotfindconfigurationfileforlogging");
iflogging.xmldoesnot*exist*/@Deprecatedpublicstatic@NullableLoggingInfogetLogging(ResourceStorestore)throwsIOException{//ExposingthisisahacktoprovideJDBCConfigwiththeinformationitneedstocompute//the"change"betweenlogging.xmlandtheversionsstoredinJDBC.KS//TODOfindabettersolutionthanre-initializingonJDBCCOnfigstartup.Resourcef=store.get("logging.xml");
if(f!=null){XStreamPersisterxp=newXStreamPersisterFactory().createXMLPersister();try(BufferedInputStreamin=newBufferedInputStream(f.in())){LoggingInfologinfo=xp.load(in,LoggingInfo.class);returnloginfo;
else{returnnull;
if(LOGGER==null){LOGGER=Logging.getLogger("org.geoserver.logging");
ifexternalgraphicsaren'treferenced(afuture*versionmaylearntoextractapalettemergingtheonesoftheexternalgraphics).*/publicclassPaletteExtractorextendsFilterAttributeExtractorimplementsStyleVisitor{publicstaticfinalColorTRANSPARENT=newColor(255,255,255,0);privatestaticfinalintTRANSPARENT_CODE=255<<16|255<<8|255;Set/*<Color>*/colors;booleantranslucentSymbolizers;booleanexternalGraphicsSymbolizers;booleanunknownColors;booleanrasterUsed;/***Initializesanewpaletteextractor**@parambackgroundbackgroundcolor,ornull
iftransparent*/publicPaletteExtractor(Colorbackground){super(null);colors=newHashSet();
if(background==null)background=TRANSPARENT;colors.add(background);
if(translucentSymbolizers||externalGraphicsSymbolizers||unknownColors||rasterUsed)returnfalse;//impossibletodeviseapalette(0shuoldneverhappen,butyouneverknow...)
if(colors.size()==0||colors.size()>256)returnfalse;returntrue;
ifitwasn'tpossibletodeviseone*/publicIndexColorModelgetPalette(){
if(!canComputePalette())returnnull;int[]cmap=newint[colors.size()];inti=0;for(Iteratorit=colors.iterator();it.hasNext();){Colorcolor=(Color)it.next();cmap[i++]=(color.getAlpha()<<24)|(color.getRed()<<16)|(color.getGreen()<<8)|color.getBlue();
if(cmap.length<=2){bits=1;
else
if(cmap.length<=4){bits=2;
else
if(cmap.length<=16){bits=4;
if(cmap.length<length){int[]temp=newint[length];System.arraycopy(cmap,0,temp,0,cmap.length);cmap=temp;
if(opacity==null)return;
if(opacityinstanceofLiteral){Literallo=(Literal)opacity;doublevalue=((Double)lo.evaluate(null,Double.class)).doubleValue();translucentSymbolizers=translucentSymbolizers||value!=1;
else{//wecannotknow,soweassumesomewillbenonopaquetranslucentSymbolizers=true;
ifthecolorisan*expressionotherthanaliteral**@paramcolor*/voidhandleColor(Expressioncolor){
if(color==null)return;
if(colorinstanceofLiteral){Literallc=(Literal)color;StringrgbColor=(String)lc.evaluate(null,String.class);colors.add(Color.decode(rgbColor));
else{unknownColors=true;
if(filter!=null){filter.accept(this,null);
if(symbolizers!=null){for(inti=0;i<symbolizers.length;i++){Symbolizersymbolizer=symbolizers[i];symbolizer.accept(this);
if(layers[i]instanceofNamedLayer){((NamedLayer)layers[i]).accept(this);
else
if(layers[i]instanceofUserLayer){((UserLayer)layers[i]).accept(this);
if(syminstanceofPointSymbolizer){visit((PointSymbolizer)sym);
if(syminstanceofLineSymbolizer){visit((LineSymbolizer)sym);
if(syminstanceofPolygonSymbolizer){visit((PolygonSymbolizer)sym);
if(syminstanceofTextSymbolizer){visit((TextSymbolizer)sym);
if(syminstanceofRasterSymbolizer){visit((RasterSymbolizer)sym);
if(fill.getGraphicFill()!=null)fill.getGraphicFill().accept(this);handleOpacity(fill.getOpacity());
if(stroke.getGraphicFill()!=null){stroke.getGraphicFill().accept(this);
if(stroke.getGraphicStroke()!=null){stroke.getGraphicStroke().accept(this);
if(ps.getGraphic()!=null){ps.getGraphic().accept(this);
if(line.getStroke()!=null){line.getStroke().accept(this);
if(poly.getStroke()!=null){poly.getStroke().accept(this);
if(poly.getFill()!=null){poly.getFill().accept(this);
if(textinstanceofTextSymbolizer2){
if(((TextSymbolizer2)text).getGraphic()!=null)((TextSymbolizer2)text).getGraphic().accept(this);
if(text.getFill()!=null){text.getFill().accept(this);
if(text.getHalo()!=null){text.getHalo().accept(this);
if(gr.getSymbols()!=null){Symbol[]symbols=gr.getSymbols();for(inti=0;i<symbols.length;i++){Symbolsymbol=symbols[i];symbol.accept(this);
if(mark.getFill()!=null){mark.getFill().accept(this);
if(mark.getStroke()!=null){mark.getStroke().accept(this);
if(halo.getFill()!=null){halo.getFill().accept(this);
if(name.equals("Buildings")){FeatureTypeInfoinfo=(FeatureTypeInfo)r;AttributeTypeInfoImplgeom1=newAttributeTypeInfoImpl();geom1.setName("geom");EasyMock.expect(info.getAttributes()).andReturn(Arrays.asList(geom1)).anyTimes();AttributeTypeInfoImplgeom2=newAttributeTypeInfoImpl();geom2.setName("geom");geom2.setBinding(Polygon.class);try{EasyMock.expect(info.attributes()).andReturn(Arrays.asList(geom2)).anyTimes();
if(Info.class.isAssignableFrom(type)){returnINSTANCE;
if(format==null){returnnull;
else{return(Format)SecuredObjects.secure(format,policy);
if(policy.getLimits()instanceofCoverageAccessLimits){CoverageAccessLimitslimits=(CoverageAccessLimits)policy.getLimits();//getthecropfilterrasterFilter=limits.getRasterFilter();FilterreadFilter=limits.getReadFilter();//updatethereadparamsfinalGeneralParameterValue[]limitParams=limits.getParams();
if(parameters==null){parameters=limitParams;
else
if(limitParams!=null){//scantheinputparams,addandoverwritewiththelimitsparamsasneededList<GeneralParameterValue>params=newArrayList<GeneralParameterValue>(Arrays.asList(parameters));for(GeneralParameterValuelparam:limitParams){//removetheoverwrittenparam,
ifanyfinalGeneralParameterDescriptorldescriptor=lparam.getDescriptor();for(Iteratorit=params.iterator();it.hasNext();){GeneralParameterValueparam=(GeneralParameterValue)it.next();
if(param.getDescriptor().equals(lparam.getDescriptor())){it.remove();break;
ifitwasalreadythere,an//additionotherwise)params.add(lparam);
if(readFilter!=null&&!Filter.INCLUDE.equals(readFilter)){Formatformat=delegate.getFormat();ParameterValueGroupreadParameters=format.getReadParameters();List<GeneralParameterDescriptor>descriptors=readParameters.getDescriptor().descriptors();//scanalltheparamslookingfortheonewewanttoaddbooleanreplacedOriginalFilter=false;for(GeneralParameterValuepv:parameters){StringpdCode=pv.getDescriptor().getName().getCode();
if("FILTER".equals(pdCode)||"Filter".equals(pdCode)){replacedOriginalFilter=true;ParameterValuepvalue=(ParameterValue)pv;FilteroriginalFilter=(Filter)pvalue.getValue();
if(originalFilter==null||Filter.INCLUDE.equals(originalFilter)){pvalue.setValue(readFilter);
else{Filtercombined=Predicates.and(originalFilter,readFilter);pvalue.setValue(combined);
if(!replacedOriginalFilter){parameters=CoverageUtils.mergeParameter(descriptors,parameters,readFilter,"FILTER","Filter");
ifnecessary
if(rasterFilter!=null&&grid!=null){GeometrycoverageBounds=JTS.toGeometry((Envelope)newReferencedEnvelope(grid.getEnvelope2D()));
if(coverageBounds.intersects(rasterFilter)){finalParameterValueGroupparam=cropParams.clone();param.parameter("source").setValue(grid);param.parameter("ROI").setValue(rasterFilter);grid=(GridCoverage2D)coverageCropFactory.doOperation(param,null);
else{returnnull;
if(info==null){returnnull;
else{return(ServiceInfo)SecuredObjects.secure(info,policy);
if(info==null){returnnull;
else{return(ResourceInfo)SecuredObjects.secure(info,policy);
if(file.isPresent()){returnsniff(file.get())!=null;
if(it.hasNext()){return(SimpleFeature)it.next();
if(datainstanceofDirectory){List<ImportTask>tasks=newArrayList<ImportTask>();for(FileDatafile:((Directory)data).getFiles()){tasks.add(task(file,catalog));
else{returnArrays.asList(task(data,catalog));
if(featureType!=null&&featureType.getCoordinateReferenceSystem()!=null){crs=featureType.getCoordinateReferenceSystem();
if(srs!=null){ft.setSRS(srs);
if(datainstanceofDirectory){returnIterables.find(((Directory)data).getFiles(),newPredicate<FileData>(){@Overridepublicbooleanapply(FileDatainput){returnFilenameUtils.getBaseName(input.getFile().getName()).equals(item.getLayer().getName());
else{returnmaybeFile(data).get();
if(datainstanceofFileData){returnOptional.of(((FileData)data).getFile());
if(epsg==null){epsg=CRS.lookupEpsgCode(crs,true);
if(columnValue.equals(property.getPropertyValue(modelObject)))returnc;
if(style!=null){catalog.remove(style);
if(group!=null){catalog.remove(group);
if(group!=null){catalog.remove(group);
if(value==null||value.isEmpty())returnnull;try{returnInteger.parseInt(value);
if(value==null){returnnull;
else{String[]strings=StringUtils.split(value,"\r\n");List<Integer>floats=newArrayList<Integer>(strings.length);for(Strings:strings){floats.add((Integer)INTEGER.convertToObject(s,locale));
if(i.hasNext()){sb.append(INTEGER.convertToString(i.next(),locale));
if(List.class.isAssignableFrom(type)){return(IConverter<S>)CONVERT;
if(Integer.class.isAssignableFrom(type)){return(IConverter<S>)INTEGER;
ifthereisnoauthenticatedprincipal*/@OverridepublicvoiddoFilter(ServletRequestrequest,ServletResponseresponse,FilterChainchain)throwsIOException,ServletException{StringcacheKey=authenticateFromCache(this,(HttpServletRequest)request);
if(SecurityContextHolder.getContext().getAuthentication()==null){doAuthenticate((HttpServletRequest)request,(HttpServletResponse)response);AuthenticationpostAuthentication=SecurityContextHolder.getContext().getAuthentication();
if(postAuthentication!=null&&cacheKey!=null){
if(cacheAuthentication(postAuthentication,(HttpServletRequest)request)){getSecurityManager().getAuthenticationCache().put(getName(),cacheKey,postAuthentication);
ifnoprincipalwasauthenticated**@paramrequest*/protectedabstractStringgetPreAuthenticatedPrincipal(HttpServletRequestrequest);/***subclassesshouldreturntherolesfortheprincipalobtainedby{@link*#getPreAuthenticatedPrincipal(HttpServletRequest)}**@paramrequest*@paramprincipal*/protectedabstractCollection<GeoServerRole>getRoles(HttpServletRequestrequest,Stringprincipal)throwsIOException;/***Trytoauthenticateandadds{@linkGeoServerRole#AUTHENTICATED_ROLE}Takescareofthe*specialusernamed{@linkGeoServerUser#ROOT_USERNAME}**@paramrequest*@paramresponse*/protectedvoiddoAuthenticate(HttpServletRequestrequest,HttpServletResponseresponse){Stringprincipal=getPreAuthenticatedPrincipal(request);
if(principal==null||principal.trim().length()==0){return;
if(GeoServerUser.ROOT_USERNAME.equals(principal)){result=newPreAuthenticatedAuthenticationToken(principal,null,Collections.singleton(GeoServerRole.ADMIN_ROLE));
else{Collection<GeoServerRole>roles=null;try{roles=getRoles(request,principal);
if(roles.contains(GeoServerRole.AUTHENTICATED_ROLE)==false)roles.add(GeoServerRole.AUTHENTICATED_ROLE);result=newPreAuthenticatedAuthenticationToken(principal,null,roles);
ifnoHTTPsessionisavailablereturnrequest.getSession(false)==null;
if(request.getSession(false)!=null)//nocaching
ifthereisanHTTPsessionreturnnull;Stringretval=getPreAuthenticatedPrincipal(request);
if(GeoServerUser.ROOT_USERNAME.equals(retval))returnnull;returnretval;
if(!restManager.getReader().existGeoserver()){thrownewTaskException("Failedtoconnecttogeoserver"+extGS.getUrl());
if(restLayer==null){thrownewTaskException("Layerdoesnotexistondestination"+layer.getName());
if(matcher.find()){storeName=matcher.group(1);
else{thrownewTaskException("Couldn'tdeterminestorenamefor"+layer.getName());
if(!restManager.getPublisher().configureResource(ws,storeType,storeName,re)){thrownewTaskException("Failedtoconfigureresource"+ws+":"+resource.getName());
if(!restManager.getPublisher().configureLayer(ws,layer.getName(),layerEncoder)){thrownewTaskException("Failedtoconfigurelayer"+ws+":"+resource.getName());
if(resourceinstanceofCoverageInfo){CoverageInfocoverage=(CoverageInfo)resource;finalGSCoverageEncodercoverageEncoder=newGSCoverageEncoder();for(Stringformat:coverage.getSupportedFormats()){coverageEncoder.addSupportedFormats(format);
else{re=newGSFeatureTypeEncoder();
if(resource.getNativeCRS()!=null){re.setNativeCRS(CRS.toSRS(resource.getNativeCRS()));
if(entry.getValue()!=null){re.setMetadataString(entry.getKey(),entry.getValue().toString());
if(resource.getNativeBoundingBox()!=null){re.setNativeBoundingBox(resource.getNativeBoundingBox().getMinX(),resource.getNativeBoundingBox().getMinY(),resource.getNativeBoundingBox().getMaxX(),resource.getNativeBoundingBox().getMaxY(),resource.getSRS());
if(resource.getLatLonBoundingBox()!=null){re.setLatLonBoundingBox(resource.getLatLonBoundingBox().getMinX(),resource.getLatLonBoundingBox().getMinY(),resource.getLatLonBoundingBox().getMaxX(),resource.getLatLonBoundingBox().getMaxY(),resource.getSRS());
if(resourceinstanceofCoverageInfo){CoverageInfocoverage=(CoverageInfo)resource;for(CoverageDimensionInfodi:coverage.getDimensions()){((GSCoverageEncoder)re).addCoverageDimensionInfo(di.getName(),di.getDescription(),Double.toString(di.getRange().getMinimum()),Double.toString(di.getRange().getMaximum()),di.getUnit(),di.getDimensionType()==null?null:di.getDimensionType().identifier());
if(rule.isElseFilter()){filters.add(Filter.INCLUDE);
else{Filterfilter=rule.getFilter();
if(filter==null){filters.add(Filter.INCLUDE);
else{filters.add(filter);
if(filters.size()==0){returnFilter.INCLUDE;
else
if(filters.size()==1){returnfilters.get(0);
else{FilterFactoryff=CommonFactoryFinder.getFilterFactory();Filteror=ff.or(filters);SimplifyingFilterVisitorsimplifier=newSimplifyingFilterVisitor();return(Filter)or.accept(simplifier,null);
if(pattern.contains("/gwc/rest/wmts")){//thisisanhandlerforGWCWMTSRESTAPIsuper.registerHandlerMethod(handler,method,mapping);break;
if(gwcRestBaseIndex==-1||gwcRestBaseIndex==0){//notaGWCRESTURLornotinthecontextofavirtualservicereturnnull;
if(workspace==null){//notavalidworkspace,wearedonereturnnull;
if(handler==null){//nohandlerfoundreturnnull;
if(!matcher.find()){//nolayersintheURI,wearedonereturnqueryUri;
if(((char)read)=='\n'){break;
if(workspace!=null){WorkspaceInfows=geoServer.getCatalog().getWorkspaceByName(workspace);service=geoServer.getService(ws,WFSInfo.class);
else{service=geoServer.getService(WFSInfo.class);
ifwecanusetheSLDcache,someconversionsareexpensive.
if(inputinstanceofFile){//converttoresource,toavoidcodeduplication(thecodeforfilewouldbevery//similartotheresourceone,butunfortunatelyusinganunrelatedsetofclassesFilecssFile=(File)input;input=newFileSystemResourceStore(cssFile.getParentFile()).get(cssFile.getName());
if(inputinstanceofResource){ResourcecssResource=(Resource)input;ResourcesldResource=cssResource.parent().get(FilenameUtils.getBaseName(cssResource.name())+".sld");
if(sldResource.getType()!=Resource.Type.UNDEFINED&&sldResource.lastmodified()>cssResource.lastmodified()){returnsldHandler.parse(sldResource,SLDHandler.VERSION_10,resourceLocator,entityResolver);
else{//otherwiseconvertandwritethecachetry(Readerreader=toReader(input)){StyledLayerDescriptorsld=convertToSLD(reader);try(OutputStreamfos=sldResource.out()){sldHandler.encode(sld,SLDHandler.VERSION_10,true,fos);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;GetExecutionResultTypeother=(GetExecutionResultType)obj;
if(baseUrl==null){
if(other.baseUrl!=null)returnfalse;
else
if(!baseUrl.equals(other.baseUrl))returnfalse;
if(executionId==null){
if(other.executionId!=null)returnfalse;
else
if(!executionId.equals(other.executionId))returnfalse;
if(mimeType==null){
if(other.mimeType!=null)returnfalse;
else
if(!mimeType.equals(other.mimeType))returnfalse;
if(outputId==null){
if(other.outputId!=null)returnfalse;
else
if(!outputId.equals(other.outputId))returnfalse;
if(service==null){
if(other.service!=null)returnfalse;
else
if(!service.equals(other.service))returnfalse;
if(version==null){
if(other.version!=null)returnfalse;
else
if(!version.equals(other.version))returnfalse;returntrue;}}
if(DataAttributesProvider.COMPUTE_STATS.equals(property.getName())){Fragmentf=newFragment(id,"computeStatsFragment",DataPanel.this);f.add(newAjaxLink<Void>("computeStats"){privatestaticfinallongserialVersionUID=1L;@OverridepublicvoidonClick(AjaxRequestTargettarget){DataAttributeattribute=(DataAttribute)itemModel.getObject();try{updateAttributeStats(attribute);
if(pd==null||!Comparable.class.isAssignableFrom(binding)||Geometry.class.isAssignableFrom(binding)){return;
ifnullispassedasargument*/publicstaticStringencodeXML(StringinData){//returnnull,
ifnullispassedasargument
if(inData==null){returnnull;
ifnospecialcharacters,justreturn//(foroptimization.Thoughmaybeanoverhead,butformostofthe//strings,thiswillsavetime)
if((inData.indexOf('&')==-1)&&(inData.indexOf('<')==-1)&&(inData.indexOf('>')==-1)&&(inData.indexOf('\'')==-1)&&(inData.indexOf('\"')==-1)){returninData;
iftheithcharacterisspecialcharacter,replacebycode
if(charToCompare=='&'){buffer.append("&amp;");
else
if(charToCompare=='<'){buffer.append("&lt;");
else
if(charToCompare=='>'){buffer.append("&gt;");
else
if(charToCompare=='\"'){buffer.append("&quot;");
else
if(charToCompare=='\''){buffer.append("&apos;");
else{buffer.append(charToCompare);
if(c=='<'){writer.write("&lt;");
else
if(c=='>'){writer.write("&gt;");
else
if(c=='&'){writer.write("&amp;");
else
if(c=='\''){writer.write("&apos;");
else
if(c=='"'){writer.write("&quot;");
else{writer.write(c);
iftheappendedquerystringrequiresa'?'or*'&amp;'tobeprepended.**<p>Thiscodecanbeusedtomakesuretheurlendswith?or&amp;bycalling*appendQueryString(url,"")**@paramurlThebaseurl.*@paramqueryStringThequerystringtobeappended,shouldnotcontainthe'?'character.*@returnAfullurlwiththequerystringappended.*<p>TODO:removethisandreplacewithRequetss.appendQueryString*/publicstaticStringappendQueryString(Stringurl,StringqueryString){
if(url.endsWith("?")||url.endsWith("&")){returnurl+queryString;
if(url.indexOf('?')!=-1){returnurl+"&"+queryString;
if(index==-1){returnurl;
if(index==-1||index==url.length()-1){return"";
if(url.endsWith("/")){url=url.substring(0,url.length()-1);
if(index==-1){returnurl;
if(endsWithSlash&&startsWithSlash){result.setLength(result.length()-1);
else
if(!endsWithSlash&&!startsWithSlash){result.append("/");
if(path.startsWith("/")){i=1;
if(index>-1){returnpath.substring(0,index);
if(path.startsWith("/")){i=1;
if(index>-1){returnpath.substring(index+1);
if(ext!=null){returnpath.substring(0,path.length()-ext.length()-1);
if(path.endsWith("/")){i--;
if(j==-1){returnpath;
ifitdoesnotexist.*/publicstaticStringgetExtension(Stringuri){intslash=uri.lastIndexOf('/');
if(slash!=-1){uri=uri.substring(slash+1);
if(dot!=-1){returnuri.substring(dot+1);
if(path.startsWith("/")){returnpath;
if(kvp!=null)kvpBuffer.putAll(kvp);//runallofthemanglersfor(URLManglermangler:GeoServerExtensions.extensions(URLMangler.class)){mangler.mangleURL(baseURLBuffer,pathBuffer,kvpBuffer,type);
if(value!=null){Stringencoded=urlEncode(value);params.append(encoded);
if(params.length()>1){params.setLength(params.length()-1);result=appendQueryString(result,params.toString());
if(parameters.length%2!=0)thrownewIllegalArgumentException("Theparameterssequenceshouldbe"+"composedofkey/valuepairs,buttheparamspassedareoddinnumber");for(inti=0;i<parameters.length;){Stringkey=parameters[i++];Stringvalue=parameters[i++];result.put(key,value);
if(enc>='A'&&enc<='Z'||enc>='a'&&enc<='z'||enc>='0'&&enc<='9'||enc=='-'||enc=='_'||enc=='.'||enc=='~'||ArrayUtils.contains(exclude,(char)enc)){resultStr.append((char)enc);
else{resultStr.append(String.format("%%%02X",enc));
if(!defaultFile.exists()){thrownewIOException("Unabletolocatethedefaultpropertiesfileat:"+defaultFile);
if(properties.getType()!=Type.RESOURCE){//copythedefaultsInputStreaminputStream=null;try{inputStream=defaults.getInputStream();IOUtils.copy(inputStream,properties.out());
if(inputStream!=null){org.apache.commons.io.IOUtils.closeQuietly(inputStream);
if(getDomain(dependsOnRawValues).contains(value)){returnvalue;
else{returnnull;
if("true".equals(dependsOnRawValues.get(0))){returnLists.newArrayList("crash","test","dummy");
else{returnLists.newArrayList("dummy");
if(getDomain(dependsOnRawValues).contains(value)){returnvalue;
else{returnnull;
if(role.getUserName()!=null){get("form:properties").setEnabled(false);get("form:parent").setEnabled(false);get("form:save").setEnabled(false);
if(hasRoleStore(roleServiceName)==false){thrownewRuntimeException("Invalidworkflow,cannotstoreinareadonlyroleservice");
if(parentRoleName!=null){GeoServerRoleparentRole=store.getRoleByName(parentRoleName);store.setParentRole(role,parentRole);
if(coverageName!=null){reader=SingleGridCoverage2DReader.wrap(delegate,coverageName);
if(readerinstanceofStructuredGridCoverage2DReader){returnnewCoverageDimensionCustomizerStructuredReader((StructuredGridCoverage2DReader)reader,coverageName,info);
else{returnnewCoverageDimensionCustomizerReader(reader,coverageName,info);
if(coverageName!=null){reader=SingleGridCoverage2DReader.wrap(delegate,coverageName);
if(readerinstanceofStructuredGridCoverage2DReader){returnnewCoverageDimensionCustomizerStructuredReader((StructuredGridCoverage2DReader)reader,coverageName,info);
else{returnnewCoverageDimensionCustomizerReader(reader,coverageName,info);
if(coverage==null){returncoverage;
if(info!=null){List<CoverageDimensionInfo>dimensions=info.getDimensions();//
ifnodimensionsfound,see
ifthereisacoverageviewprovidingthem
if(dimensions==null||dimensions.isEmpty()){MetadataMapmap=info.getMetadata();
if(map.containsKey(CoverageView.COVERAGE_VIEW)){CoverageViewcoverageView=(CoverageView)map.get(CoverageView.COVERAGE_VIEW);dimensions=newArrayList<>();List<CoverageBand>coverageBands=coverageView.getCoverageBands();for(CoverageBandband:coverageBands){CoverageDimensionInfodimensionInfo=newCoverageDimensionImpl();dimensionInfo.setName(band.getDefinition());dimensions.add(dimensionInfo);
if(wrappedDims==null){wrappedDims=(GridSampleDimension[])dims;
else
if(properties!=null&&noDataProperty!=null){//updatetheGC_NODATAproperty(ifany)withthelatestvalue,
ifwehaveanydouble[]wrappedNoDataValues=wrappedDims[0].getNoDataValues();
if(wrappedNoDataValues!=null&&wrappedNoDataValues.length>0){CoverageUtilities.setNoDataProperty(properties,wrappedNoDataValues[0]);
ifthedelegatecannotdobandselection,don'tbother
if(delegate.getFormat()==null||!delegate.getFormat().getReadParameters().getDescriptor().descriptors().contains(AbstractGridFormat.BANDS)){returnnull;
ifpossible
if(parameters!=null){for(inti=0;i<parameters.length;i++){finalParameterValueparam=(ParameterValue)parameters[i];
if(AbstractGridFormat.BANDS.getName().equals(param.getDescriptor().getName())){int[]bandIndicesParam=(int[])param.getValue();returnbandIndicesParam;
if(storedDimensions!=null&&storedDimensions.size()>0){inti=0;wrappedDims=newGridSampleDimension[dims.length];for(SampleDimensiondim:dims){CoverageDimensionInfocdi;
if(bandIndexes!=null){
if(i>=bandIndexes.length){//dynamicallyaddedalphabandcdi=buildAlphaChannelDimnsionInfo(storedDimensions.get(0));
else{intidx=bandIndexes[i];cdi=storedDimensions.get(idx);
else{
if(i>=storedDimensions.size()){//dynamicallyaddedalphabandcdi=buildAlphaChannelDimnsionInfo(storedDimensions.get(0));
else{cdi=storedDimensions.get(i);
if(this.coverageName!=null&&!this.coverageName.equals(coverageName)){thrownewIllegalArgumentException("Unkonwncoveragenamed"+coverageName+",theonlyvalidvalueis:"+this.coverageName);
if(coverageinstanceofGridCoverageWrapper||forceWrapping){returnnewGridCoverageWrapper(coverage.getName().toString(),coverage,wrappedDimensions==null?coverage.getSampleDimensions():wrappedDimensions,properties==null?sourceCoverage.getProperties():properties);
if(uom!=null){unit=SimpleUnitFormat.getInstance().parse(uom);
if(LOGGER.isLoggable(Level.WARNING)&&defaultUnit!=null){LOGGER.warning("Unabletoparsethespecifiedunit("+uom+").Usingthepreviousone:"+defaultUnit.toString());
if(nullValues!=null&&nullValues.size()>0){finalintsize=nullValues.size();configuredNoDataValues=newdouble[size];for(inti=0;i<size;i++){configuredNoDataValues[i]=nullValues.get(i);
else{configuredNoDataValues=sampleDim.getNoDataValues();
ifthenodatahasbeenconfiguredbooleannodataConfigured=configuredNoDataValues!=null&&configuredNoDataValues.length>0;//customcategoriesintnumCategories=0;List<Category>customCategories=newArrayList<Category>(numCategories);
if(categories!=null&&(numCategories=categories.size())>0){Categorywrapped=null;for(Categorycategory:categories){wrapped=category;
if(Category.NODATA.getName().equals(category.getName())){
if(category.isQuantitative()){//Getminimumandmaximumvaluedoubleminimum=nodataConfigured?configuredNoDataValues[0]:category.getRange().getMinimum();doublemaximum=nodataConfigured?configuredNoDataValues[0]:category.getRange().getMaximum();
if(Double.isNaN(minimum)&&Double.isNaN(maximum)){//Createaqualitativecategorywrapped=newCategory(Category.NODATA.getName(),category.getColors()[0],minimum);
else{//Createthewrappedcategorywrapped=newCategory(Category.NODATA.getName(),category.getColors(),NumberRange.create(minimum,maximum));
ifwewanttheconfiguredrange//tosurviveagriddimensioncopy//(butaninfiniterangeisnotvalid,theCategorycreationwillthrowanexception)
if(configuredRange!=null&&!Double.isInfinite(configuredRange.getMinimum())&&!Double.isInfinite(configuredRange.getMaximum())){ClasstargetType=categories!=null&&!categories.isEmpty()?categories.get(0).getRange().getElementClass():Double.class;finalNumberRange<?>dataRange=configuredRange.castTo(targetType);List<NumberRange<?>>dataRanges=newArrayList<>();dataRanges.add(dataRange);for(Categorycategory:customCategories){List<NumberRange<?>>newDataRanges=newArrayList<>();for(NumberRange<?>dr:dataRanges){NumberRange<?>[]subtracted=dr.subtract(category.getRange());for(NumberRange<?>range:subtracted){
if(!range.isEmpty()){newDataRanges.add(range);
iftherangeexists,otherwiseusethesampledimensionvalues
if(range!=null){returnrange.getMinimum();
else{returnsampleDim.getMinimumValue();
iftherangeexists,otherwiseusethesampledimensionvalues
if(range!=null){returnrange.getMaximum();
else{returnsampleDim.getMaximumValue();
if(range!=null){builder.append(range.getMinimum()).append("...").append(range.getMaximum());
else{finalUnit<?>unit=getUnits();
if(unit!=null){builder.append(unit);
if(customCategories!=null){StringBuilderbuilder=newStringBuilder(configuredDescription);builder.append('(');builder=formatRange(builder,null);builder.append(')').append(LINE_SEPARATOR);for(finalCategorycategory:customCategories){builder.append("").append('').append('').append(category).append(LINE_SEPARATOR);
else{returnsampleDim.toString();
if(uom!=null){label.append("(".intern());parseUOM(label,uom);label.append(")".intern());
ifacertainobjectcanorcannotbeshowedtothecurrentuser**@authorAndreaAime-GeoSolutions*/publicclassInMemorySecurityFilterextendsInternalVolatileFunction{ResourceAccessManagerresourceAccesssManager;Authenticationuser;/***Returnsafilterthatwillcheck
iftheobjectpassedtoitcanbeaccessedbytheuser**@paramresourceAccesssManager*@paramuser*/publicstaticFilterbuildUserAccessFilter(ResourceAccessManagerresourceAccesssManager,Authenticationuser){org.opengis.filter.expression.Functionvisible=newInMemorySecurityFilter(resourceAccesssManager,user);FilterFactoryfactory=Predicates.factory;//createafiltercombinedwiththesecuritycredentialscheckFilterfilter=factory.equals(factory.literal(Boolean.TRUE),visible);returnfilter;
if(infoinstanceofNamespaceInfo){info=getCatalog().getWorkspaceByName(((NamespaceInfo)info).getPrefix());
if(info==null){returnfalse;
if*youdomodifyanythinginthisclass(especiallythemodels),manuallyretestthattheeditsare*notlostontabswitch.**@authorNielsCharlier*/publicabstractclassPublishedConfigurationPage<TextendsPublishedInfo>extendsGeoServerSecuredPage{privatestaticfinallongserialVersionUID=7870938096047218989L;publicstaticfinalStringNAME="name";publicstaticfinalStringWORKSPACE="wsName";protectedIModel<T>myModel;protectedbooleanisNew;protectedTabbedPaneltabbedPanel;/***{@linkPublishedEditTabPanel}contributionsmayneedtoeditsomethingdifferentthanthe*LayerInfoandResourceInfothispageholdsmodelsto.Insuchcases{@link*PublishedEditTabPanelInfo#createOwnModel}willreturnanonnullmodelandwellpassitback*totheconcreteLayerEditTabPanelconstructor.ThisissobecauseLayerEditTabPanelare*re-createdeverytimetheuserswitchestabs.*/privateLinkedHashMap<Class<?extendsPublishedEditTabPanel<T>>,IModel<?>>tabPanelCustomModels;privatebooleaninputEnabled=true;protectedPublishedConfigurationPage(booleanisNew){this.isNew=isNew;
if(ttabPanelInfo.supports(getPublishedInfo())){@SuppressWarnings("unchecked")PublishedEditTabPanelInfo<T>tabPanelInfo=(PublishedEditTabPanelInfo<T>)ttabPanelInfo;StringtitleKey=tabPanelInfo.getTitleKey();IModel<String>titleModel=null;
if(titleKey!=null){titleModel=neworg.apache.wicket.model.ResourceModel(titleKey);
else{titleModel=newModel<String>(tabPanelInfo.getComponentClass().getSimpleName());
ifthistabneedsacustommodelinsteadofjustourlayer//model,then//letitcreateitonce
if(panelCustomModel==null){tabPanel=panelClass.getConstructor(String.class,IModel.class).newInstance(panelId,myModel);
else{tabPanel=panelClass.getConstructor(String.class,IModel.class,IModel.class).newInstance(panelId,myModel,panelCustomModel);
if(selectedTabIndex>-1){tabbedPanel.setSelectedTab(selectedTabIndex);
if(hasErrorMessage()){return;
if(customModel==null){continue;
if(info.canHandle(getPublishedInfo())){result.add((PublishedConfigurationPanelInfo<T>)info);
if(workspaceName==null){layers=catalog.getLayers();
else{layers=newArrayList<>();for(ResourceInforesourceInfo:catalog.getResourcesByNamespace(workspaceName,ResourceInfo.class)){layers.addAll(catalog.getLayers(resourceInfo));
if(workspaceName!=null){layerName=workspaceName+":"+layerName;
if(layer==null){thrownewResourceNotFoundException("Nosuchlayer:"+layerName);
if(workspaceName!=null){layerName=workspaceName+":"+layerName;
if(layer==null){thrownewResourceNotFoundException(layerName);
if(!recurse){catalog.remove(layer);LOGGER.info("DELETElayer'"+layerName+"'");
else{newCascadeDeleteVisitor(catalog).visit(layer);LOGGER.info("DELETElayer'"+layerName+"'recurse=true");
if(workspaceName!=null){layerName=workspaceName+":"+layerName;
if(layer.getName()!=null&&!layer.getName().equals(original.getName())){//thrownewRestletException("Can'tchangenameofalayer",//Status.CLIENT_ERROR_FORBIDDEN);//
if(layerName==null){returnnull;
if(objinstanceofStyleInfo){StyleInfostyle=(StyleInfo)obj;StringBuilderlink=newStringBuilder();
if(style.getWorkspace()!=null){StringwsName=style.getWorkspace().getName();writer.startNode("workspace");writer.setValue(wsName);writer.endNode();link.append("/workspaces/").append(converter.encode(wsName));
if(objinstanceofResourceInfo){ResourceInfor=(ResourceInfo)obj;StringBuilderlink=newStringBuilder("/workspaces/").append(converter.encode(r.getStore().getWorkspace().getName())).append("/");
if(rinstanceofFeatureTypeInfo){link.append("datastores/").append(converter.encode(r.getStore().getName())).append("/featuretypes/");
else
if(rinstanceofCoverageInfo){link.append("coveragestores/").append(converter.encode(r.getStore().getName())).append("/coverages/");
else
if(rinstanceofWMSLayerInfo){link.append("wmsstores/").append(converter.encode(r.getStore().getName())).append("/wmslayers/");
else{return;
if(stylePageinstanceofStyleEditPage){//globalstylesonlyeditablebyfulladmin
if(!stylePage.isAuthenticatedAsAdmin()&&parent.getStyleInfo().getWorkspace()==null){nameTextField.setEnabled(false);uploadLink.setEnabled(false);
if(StylePage.isDefaultStyle(getStylePage().getStyleInfo())){nameTextField.setEnabled(false);wsChoice.setEnabled(false);
if(!stylePage.isAuthenticatedAsAdmin()){wsChoice.setNullValid(false);wsChoice.setRequired(true);
if(StylePage.isDefaultStyle(style)){nameTextField.add(newIValidator<String>(){StringoriginalName=style.getName();@Overridepublicvoidvalidate(IValidatable<String>validatable){
if(originalName!=null&&!originalName.equals(validatable.getValue())){ValidationErrorerror=newValidationError();error.setMessage("Can'tchangethenameofdefaultstyles.");error.addKey("editDefaultStyleNameDisallowed");validatable.error(error);
if(validatable.getValue()!=null){ValidationErrorerror=newValidationError();error.setMessage("Can'tchangetheworkspaceofdefaultstyles.");error.addKey("editDefaultStyleWorkspaceDisallowed");validatable.error(error);
ifnotadmin(canonlybesetuponcreation)
if(stylePageinstanceofStyleEditPage&&!stylePage.isAuthenticatedAsAdmin()){wsChoice.setEnabled(false);
if(style.getId()!=null){try{stylePage.setRawStyle(stylePage.readFile(style));
if(onlineResource!=null&&!onlineResource.isEmpty()){
if(conn!=null){try{legendImage=ImageIO.read(conn.getInputStream());legendImg.setVisible(true);
else{//Noexternallegend,usegeneratedlegendGeoServerDataDirectorydd=GeoServerExtensions.bean(GeoServerDataDirectory.class,stylePage.getGeoServerApplication().getApplicationContext());StyleInfosi=newStyleInfoImpl(stylePage.getCatalog());Stringformat=stylePage.getStyleInfo().getFormat();si.setFormat(format);StringstyleName="tmp"+UUID.randomUUID().toString();StringstyleFileName=styleName+'.'+Styles.handler(si.getFormat()).getFileExtension();si.setFilename(styleFileName);si.setName(styleName);si.setWorkspace(stylePage.styleModel.getObject().getWorkspace());ResourcestyleResource=null;try{styleResource=dd.style(si);try(OutputStreamos=styleResource.out()){IOUtils.write(stylePage.editor.getInput(),os);
if(style!=null){GetLegendGraphicRequestrequest=newGetLegendGraphicRequest();request.setLayer(null);request.setStyle(style);request.setStrict(false);Map<String,String>legendOptions=newHashMap<>();legendOptions.put("forceLabels","on");legendOptions.put("fontAntiAliasing","true");request.setLegendOptions(legendOptions);BufferedImageLegendGraphicBuilderbuilder=newBufferedImageLegendGraphicBuilder();legendImage=builder.buildLegendGraphic(request);legendImg.setVisible(true);
ifthestyleisvalid.");LOGGER.log(Level.WARNING,"Failedtobuildlegendpreview",e);
if(styleResource!=null){styleResource.delete();
if(template!=null){try{//samehere,forcevalidationorthefieldwon'tbeupdatedstylePage.editor.reset();stylePage.setRawStyle(newStringReader(styleGen.generateStyle(stylePage.styleHandler(),template,getStylePage().getStyleInfo().getName())));target.appendJavaScript(String.format("if(document.gsEditors){document.gsEditors.editor.setOption('mode','%s');}",stylePage.styleHandler().getCodeMirrorEditMode()));clearFeedbackMessages();
if(style!=null){try{//samehere,forcevalidationorthefieldwon'tbeupdatedstylePage.editor.reset();stylePage.setRawStyle(stylePage.readFile(style));stylePage.getStyleInfo().setFormat(style.getFormat());target.appendJavaScript(String.format("if(document.gsEditors){document.gsEditors.editor.setOption('mode','%s');}",stylePage.styleHandler().getCodeMirrorEditMode()));clearFeedbackMessages();
if(upload==null){warn("Nofileselected.");return;
if(s.getName()==null||"".equals(s.getName().trim())){//setitnameTextField.setModelValue(newString[]{ResponseUtils.stripExtension(upload.getClientFileName())});nameTextField.modelChanged();
if(map.isUnchanged())returnwriter;returnnewRetypingFeatureCollection.RetypingFeatureWriter(writer,map.getFeatureType());
if(map.isUnchanged())returnwriter;returnnewRetypingFeatureCollection.RetypingFeatureWriter(writer,map.getFeatureType());
if(map.isUnchanged())returnwriter;returnnewRetypingFeatureCollection.RetypingFeatureWriter(writer,map.getFeatureType());
if(map==null)thrownewIOException("Unknowntype"+typeName);updateMap(map,true);returnmap.getFeatureType();
if(transformedName!=null){transformedNames.add(transformedName);FeatureTypeMapmap=backup.get(original);
if(map==null){map=newFeatureTypeMap(original,transformedName);
if(map.isUnchanged())returnreader;returnnewRetypingFeatureCollection.RetypingFeatureReader(reader,map.getFeatureType(query));
if(map.isUnchanged())returnsource;
if(sourceinstanceofFeatureLocking){SimpleFeatureLockinglocking=DataUtilities.simple((FeatureLocking)source);returnnewRetypingFeatureLocking(this,locking,map);
else
if(sourceinstanceofFeatureStore){SimpleFeatureStorestore=DataUtilities.simple((FeatureStore)source);returnnewRetypingFeatureStore(this,store,map);
if(map==null&&checkMap)thrownewIOException("Typemappinghasnotbeenestablishedfortype"+externalTypeName+"."+"MakesureyouaccesstypesusinggetTypeNames()orgetSchema()"+"beforetryingtoread/writeontothem");returnmap;
if(map.getFeatureType()==null||forceUpdate){SimpleFeatureTypeoriginal=wrapped.getSchema(map.getOriginalName());SimpleFeatureTypetransformed=transformFeatureType(original);map.setFeatureTypes(original,transformed);
ifthefeaturetypecannotbefoundintheoriginaldatastore,//removeitfromthemapbackwardsMap.remove(map.getName());forwardMap.remove(map.getOriginalName());
if(transfomedName.equals(original.getTypeName()))returnoriginal;try{SimpleFeatureTypeBuilderb=newSimpleFeatureTypeBuilder();b.init(original);b.setName(transfomedName);returnb.buildFeatureType();
iftheoriginaltypenameistobe*hidden**@paramoriginalName*/protectedStringtransformFeatureTypeName(StringoriginalName){returnoriginalName.replaceAll(":","_");
if(!joins.isEmpty()){modified.getJoins().clear();for(Joinjoin:joins){FeatureTypeMapmap=(FeatureTypeMap)backwardsMap.get(join.getTypeName());
if(map==null){//nothingwecandoaboutitmodified.getJoins().add(join);
else{finalFeatureTypeMapjoinTypeMap=getTypeMapBackwards(join.getTypeName(),true);StringoriginalName=joinTypeMap.getOriginalName();Joinmj=newJoin(originalName,join.getJoinFilter());mj.setType(join.getType());mj.setAlias(join.getAlias());mj.setProperties(join.getProperties());mj.setFilter(join.getFilter());modified.getJoins().add(mj);
if(s==null||"".equals(s)){return-1;
if(raw==null||"".equals(raw)){returnnewArrayList<String>();
if(metadataLinks!=null){Element[]metadataLink=ReaderUtils.getChildElements(metadataLinks,"metadataLink");for(Elemente:metadataLink){HashMapm=newHashMap();m.put("metadataType",e.getAttribute("metadataType"));m.put("type",e.getAttribute("type"));
if(e.getFirstChild()!=null){m.put(null,e.getFirstChild().getNodeValue());
if(dynamic){returnnull;
if(styleRoot!=null){List<String>styleNames=newArrayList<String>();Element[]styles=ReaderUtils.getChildElements(styleRoot,"style");for(Elementstyle:styles){styleNames.add(style.getTextContent().trim());
else{returnCollections.emptyList();
if(legendURL!=null){HashMapmap=newHashMap();map.put("width",Integer.parseInt(ReaderUtils.getAttribute(legendURL,"width",true)));map.put("height",Integer.parseInt(ReaderUtils.getAttribute(legendURL,"height",true)));map.put("format",ReaderUtils.getChildText(legendURL,"Format",true));map.put("onlineResource",ReaderUtils.getAttribute(ReaderUtils.getChildElement(legendURL,"OnlineResource",true),"xlink:href",true));returnmap;
if(cacheInfo!=null){try{return"true".equals(ReaderUtils.getAttribute(cacheInfo,"enabled",false));
if(cacheInfo!=null){try{returnReaderUtils.getAttribute(cacheInfo,"maxage",false);
if(searchable!=null){try{return"true".equals(ReaderUtils.getAttribute(searchable,"enabled",false));
if(regionateAttribute!=null){returnregionateAttribute.getAttribute("value");
if(regionateStrategy!=null){returnregionateStrategy.getAttribute("value");
if(sim==null){returnoperation;
if(sim.contains(";")){try{simOpts=(Map<String,Object>)newFormatOptionsKvpParser().parse(sim.toString());
else{simOpts=Collections.emptyMap();
if(req!=null){out.key("request");traverse(req,0,depth,out);
if(obj==null){out.value(null);return;
if(objinstanceofCollection){handleCollection((Collection)obj,depth,maxDepth,out);return;
if(objinstanceofMap){handleMap((Map)obj,depth,maxDepth,out);return;
if(objinstanceofEnvelope){Envelopee=(Envelope)obj;out.object();out.key("x1").value(e.getMinimum(0));out.key("y1").value(e.getMaximum(0));
if(e.getDimension()>1){out.key("x2").value(e.getMinimum(1));out.key("y2").value(e.getMaximum(1));
if(objinstanceofcom.vividsolutions.jts.geom.Envelope){com.vividsolutions.jts.geom.Envelopee=(com.vividsolutions.jts.geom.Envelope)obj;out.object().key("x1").value(e.getMinX()).key("y1").value(e.getMinY()).key("x2").value(e.getMaxX()).key("y2").value(e.getMaxY()).endObject();return;
if(objinstanceofFilter){out.value(ECQL.toCQL((Filter)obj));return;
if(!Modifier.isPublic(obj.getClass().getModifiers())){out.value(obj.toString());return;
if(className.startsWith("java.")||className.startsWith("org.geotools.")||className.startsWith("org.opengis.")){
if(OwsUtils.has(obj,"name")){out.value(OwsUtils.get(obj,"name"));
else{out.value(obj.toString());
if(isPrimitive(value)||depth>=maxDepth){out.value(value);
else
if(valueinstanceofInfo){out.value(((Info)value).getId());
else
if(valueinstanceofCollection){handleCollection((Collection)value,depth,maxDepth,out);
else
if(valueinstanceofMap){handleMap((Map)value,depth,maxDepth,out);
else{traverse(value,depth+1,maxDepth,out);
if(objinstanceofGetFeatureInfoRequest){//specialcaseforGetFeatureIntotoprovidelon/latcorrespondingtox/ytry{GetFeatureInfoRequestinfo=(GetFeatureInfoRequest)obj;GetMapRequestmap=info.getGetMapRequest();Coordinatec=WMS.pixelToWorld(info.getXPixel(),info.getYPixel(),newReferencedEnvelope(map.getBbox(),map.getCrs()),map.getWidth(),map.getHeight());double[]p=newdouble[]{c.getOrdinate(0),c.getOrdinate(1)};MathTransformtx=CRS.findMathTransform(map.getCrs(),WGS84,true);tx.transform(p,0,p,0,1);out.key("lon").value(p[0]);out.key("lat").value(p[1]);
if(objinstanceofGetMapRequest){try{GetMapRequestmap=(GetMapRequest)obj;ReferencedEnvelopellbox=newReferencedEnvelope(map.getBbox(),map.getCrs()).transform(WGS84,true);out.key("bbox_wgs84").object();out.key("west").value(llbox.getMinX());out.key("east").value(llbox.getMaxX());out.key("south").value(llbox.getMinY());out.key("north").value(llbox.getMaxY());out.endObject();
if("Class".equalsIgnoreCase(f))returntrue;
if("DeclaringClass".equalsIgnoreCase(f))returntrue;
if("EStructuralFeature".equalsIgnoreCase(f))returntrue;returnfalse;
if(value==null||(valueinstanceofCollection&&((Collection)value).isEmpty())||(valueinstanceofMap&&((Map)value).isEmpty())){returntrue;
if(valueinstanceofString){returntrue;
if(valueinstanceofNumber){returntrue;
if(v==null){v=value.get();
if(objinstanceofEObject){EObjecteobj=(EObject)obj;returneobj.eClass().getEAllStructuralFeatures().stream().map(f->newProperty(f.getName(),f.getEType().getInstanceClass(),()->eobj.eGet(f)));
else{ClassPropertiesclassProps=OwsUtils.getClassProperties(obj.getClass());returnclassProps.properties().stream().map(p->newProperty(p,classProps.getter(p,null).getReturnType(),()->{Objectvalue;try{value=OwsUtils.get(obj,p);
if(layer.getAttribution()==null){layer.setAttribution(GeoServerApplication.get().getCatalog().getFactory().createAttribution());
if(logo.getDefaultModelObjectAsString()!=null){try{URLurl=newURL(logo.getDefaultModelObjectAsString());URLConnectionconn=url.openConnection();type.getModel().setObject(conn.getContentType());BufferedImageimage=ImageIO.read(conn.getInputStream());height.setModelValue(newString[]{""+image.getHeight()});width.setModelValue(newString[]{""+image.getWidth()});
if(!(collectioninstanceofSimpleFeatureCollection)){thrownewServiceException("GeoPackageOutputFormatdoesnotsupportComplexFeatures.");
if(meta!=null){//initializeentrymetadatae.setIdentifier(meta.getTitle());e.setDescription(abstractOrDescription(meta));
if("true".equals(System.getProperty(PROPERTY_INDEXED))){geopkg.createSpatialIndex(e);
if(featureType!=null){Catalogcat=gs.getCatalog();FeatureTypeInfometa=cat.getFeatureTypeByName(featureType.getName());
if(meta!=null){returnmeta;
else{LOGGER.fine("Nofeaturetypeforcollection,unabletoloadmetadata");
if(ROOT_DIRECTORY!=null){IOUtils.delete(ROOT_DIRECTORY.toFile());
ifitdoesn'texistsFilecache=newFile(ROOT_DIRECTORY.toFile(),"app-schema-cache");
if(cache.mkdir()){//cachedirectorycreatedLOGGER.log(Level.INFO,String.format("App-Schemaschemasresolutionscachedirectory'%s'created.",cache.getAbsolutePath()));
ifthenumberofnodesfoundcorrespondto*theexpectednumber,*/protectedvoidcheckCount(XpathEnginexpathEngine,Documentdocument,intexpectedCount,Stringxpath){try{//evaluatethexpathandcomparethenumberofnodesfoundMatcherAssert.assertThat(xpathEngine.getMatchingNodes(xpath,document).getLength(),is(expectedCount));
if(!fixtureFile.exists()){//createfixtureexamplefilecreateFixtureExample(fixtureFile);LOGGER.warning(String.format("Nofixturefile'%s'forMongoDBexists,examplefilecreated.Testswillebskipped.",fixtureFile.getAbsolutePath()));
ifthefilealreadyexistsnothingwillbedone.*/privatestaticvoidcreateFixtureExample(FilefixtureFile){//examplefixturefileFileexampleFixtureFile=newFile(fixtureFile.getAbsolutePath()+".example");
if(exampleFixtureFile.exists()){//filealreadyexistsreturn;
ifneeded.*/privatestaticFilegetFixtureFile(){Filedirectory=newFile(System.getProperty("user.home")+File.separator+".geoserver");
if(!directory.exists()){//makesureparentdirectoryexistsdirectory.mkdir();
if(extraNamespaces.length%2!=0){thrownewRuntimeException("Invalidnumberofnamespacesprovided.");
ifInnerCachingshouldbeusedinsteadofdefaultFileSystemcaching*/privatebooleaninnerCachingEnabled;/***Booleanindicating
iftheTilesstoredinmemoryshouldbealsostoredintheFileSystemas*backup*/privatebooleanpersistenceEnabled;/***Stringindicatingtheclassofthe{@linkCacheProvider}instanceusedforcachingGWCTiles*/privateStringcacheProviderClass;/***{@linkMap}containingallthe{@linkCacheConfiguration}objectstoredforeach{@link*CacheProvider}instance.*/privateMap<String,CacheConfiguration>cacheConfigurations;/**WhethertoautomaticallycacheGeoServerlayersortheyshouldbeenabledexplicitly*/privatebooleancacheLayersByDefault=true;/**WhethertocacheanynondefaultStyleassociatedtothelayer*/privatebooleancacheNonDefaultStyles;/**Defaultmeta-tilingfactorfortheXaxis*/privateintmetaTilingX;/**Defaultmeta-tilingfactorfortheYaxis*/privateintmetaTilingY;/**Defaultguttersizeinpixels*/privateintgutter;/***WhichSRS'stocachebydefaultwhenaddinganewLayer.Defaultsto{@code[EPSG:4326,*EPSG:900913]}*/privateHashSet<String>defaultCachingGridSetIds;privateHashSet<String>defaultCoverageCacheFormats;privateHashSet<String>defaultVectorCacheFormats;/**Defaultcacheformatsfornoncoverage/vectorlayers(LayerGroupsandWMSlayers)*/privateHashSet<String>defaultOtherCacheFormats;privateStringlockProviderName;/**CreatesanewGWCconfigwithdefaultvalues*/publicGWCConfig(){setOldDefaults();Stringpng="image/png";Stringjpeg="image/jpeg";setDefaultCoverageCacheFormats(Collections.singleton(jpeg));setDefaultOtherCacheFormats(newHashSet<String>(Arrays.asList(png,jpeg)));setDefaultVectorCacheFormats(Collections.singleton(png));Map<String,CacheConfiguration>map=newHashMap<String,CacheConfiguration>();map.put(GuavaCacheProvider.class.toString(),newCacheConfiguration());setCacheConfigurations(map);readResolve();
if(null==version){version="0.0.1";
if(defaultCachingGridSetIds==null){defaultCachingGridSetIds=newHashSet<String>();
if(defaultCoverageCacheFormats==null){defaultCoverageCacheFormats=newHashSet<String>();
if(defaultOtherCacheFormats==null){defaultOtherCacheFormats=newHashSet<String>();
if(defaultVectorCacheFormats==null){defaultVectorCacheFormats=newHashSet<String>();
if(cacheConfigurations==null){cacheConfigurations=newHashMap<String,CacheConfiguration>();cacheConfigurations.put(GuavaCacheProvider.class.toString(),newCacheConfiguration());
if(isSane()){returnthis;
if(metaTilingX>0){sane.setMetaTilingX(metaTilingX);
if(metaTilingY>0){sane.setMetaTilingY(metaTilingY);
if(gutter>=0){sane.setGutter(gutter);
if(!defaultCachingGridSetIds.isEmpty()){sane.setDefaultCachingGridSetIds(defaultCachingGridSetIds);
if(!defaultCoverageCacheFormats.isEmpty()){sane.setDefaultCoverageCacheFormats(defaultCoverageCacheFormats);
if(!defaultOtherCacheFormats.isEmpty()){sane.setDefaultOtherCacheFormats(defaultOtherCacheFormats);
if(!defaultVectorCacheFormats.isEmpty()){sane.setDefaultVectorCacheFormats(defaultVectorCacheFormats);
if("wms".equalsIgnoreCase(serviceId)){returnisWMSCEnabled();
if("wmts".equalsIgnoreCase(serviceId)){thrownewRuntimeException("Tocheck
ifWMTSserviceisenableordisableuseserviceinfo.");
if("tms".equalsIgnoreCase(serviceId)){returnisTMSEnabled();
iftilesarecachedinmemory*/publicbooleanisInnerCachingEnabled(){returninnerCachingEnabled;
ifGWCtilesmustbecachedinmemory**@paraminnerCachingEnabledIfthisflagissettotrue,GWCtileswillbecachedinmemory*insteadofbeingcachedonthedisk.*/publicvoidsetInnerCachingEnabled(booleaninnerCachingEnabled){this.innerCachingEnabled=innerCachingEnabled;
iftheyarealreadystoredin*memory**@returnabooleanindicating
ifGWCtilesarealsocachedinFileSystem*/publicbooleanisPersistenceEnabled(){returnpersistenceEnabled;
ifGWCtilesmustbestoredinFileSystemeven
ifthey*arealsocachedinmemory**@parampersistenceEnabledIfthisflagissettotrue,GWCtilesarestoredintheFile*Systemasbackup.*/publicvoidsetEnabledPersistence(booleanpersistenceEnabled){this.persistenceEnabled=persistenceEnabled;
if(op.getExpression1()instanceofPropertyName&&op.getExpression2()instanceofLiteral){property=getPropertyName(op.getExpression1());literal=(Comparable)((Literal)op.getExpression2()).getValue();
else
if(op.getExpression2()instanceofPropertyName&&op.getExpression1()instanceofLiteral){property=getPropertyName(op.getExpression2());literal=(Comparable)((Literal)op.getExpression1()).getValue();inverted=true;
else{thrownewIllegalArgumentException("Unsupportedcomparison,onlycomparisonbetweenanattributeandastaticvaluearesupported:"+op);
if(op.getExpression1()instanceofPropertyName&&op.getExpression2()instanceofLiteral){property=((PropertyName)op.getExpression1()).getPropertyName();literal=(Comparable)((Literal)op.getExpression2()).getValue();
else
if(op.getExpression2()instanceofPropertyName&&op.getExpression1()instanceofLiteral){property=((PropertyName)op.getExpression2()).getPropertyName();literal=(Comparable)((Literal)op.getExpression1()).getValue();inverted=true;
else{thrownewIllegalArgumentException("Unsupportedcomparison,onlycomparisonbetweenanattributeandastaticvaluearesupported:"+op);
if(!(expressioninstanceofPropertyName)){thrownewIllegalArgumentException("Wasexpectingapropertyname,butfound:"+expression);
if("processName".equals(propertyName)){propertyName="simpleProcessName";
if(filter.isMatchingCase()){returnlike(propertyName,pattern);
else{returnilike(propertyName,pattern);
if(!"1.3.0".equalsIgnoreCase(request.getVersion())){returnsuper.beforeRender(content);
if(tempLayerinstanceofRasterLayer){Stringtitle=tempLayer.getTitle();LayerInfolayerInfo=catalog.getLayerByName(title);
if(layerInfo!=null){MetadataMapmetadata=layerInfo.getMetadata();
if(metadata.containsKey(EoLayerType.KEY)&&metadata.get(EoLayerType.KEY).equals(BAND_COVERAGE_VALUE)){layer=(RasterLayer)tempLayer;break;
if(layer==null){//thereisnoBANDlayer,wemoveonasusualreturnsuper.beforeRender(content);
if(dynamicParameters.isEmpty()){thrownewIllegalStateException("Layer"+readerLayer.getTitle()+"hasnoadditionaldimensionswhicharerequiredforanEOBANDSlayer");
if(name.equals(ImageMosaicFormat.MERGE_BEHAVIOR.getName())){foundMergeBehavior=true;param.setValue(MergeBehavior.STACK.toString());
else{//DynamicParameterschecks//-1-onlyonecanhavemultiplevalueswithcardinality3
if(dynamicParametersNames.contains(name)){finalListparamValues=(List)param.getValue();finalintsize=paramValues.size();
if(size!=1&&size!=3){thrownewServiceException("WrongnumberofvaluesprovidedtothisGetMapforEOBANDSlayer.Paremeter:"+name.getCode()+"#:"+size,"InvalidDimensionValue");
if(foundCustomDimensions!=dynamicParameters.size()){thrownewIllegalArgumentException("NotallthedimensionsforthisEOBANDSlayerwererequested.Please,checktheGetMaprequest.");
ifwefoundandsetthemergebehavior
if(!foundMergeBehavior){//shouldnothappenthrownewIllegalStateException("UnabletoimposeStackingmergebehavior!");
if("r3".equals(r.getAuthority()))continue;
if("r2".equals(r.getAuthority())){assertEquals(1,r.getProperties().size());assertEquals("r2_v1",r.getProperties().get("r2_p1"));continue;
if("r1".equals(r.getAuthority())){assertEquals(2,r.getProperties().size());assertEquals("r1_v1",r.getProperties().get("r1_p1"));assertEquals("r1_v2",r.getProperties().get("r1_p2"));continue;
if(service.getMaintainer()==null){service.setMaintainer("http://geoserver.org/com");
if(service.getOnlineResource()==null){service.setOnlineResource("http://geoserver.org");
if(service.getTitle()==null){service.setTitle("GeoServerWebMapTileService");
if(service.getAbstract()==null){service.setAbstract("AcompliantimplementationofWMTSservice.");
if(service.getFees()==null){service.setFees("NONE");
if(service.getAccessConstraints()==null){service.setAccessConstraints("NONE");
if(service.getVersions()==null||service.getVersions().isEmpty()){service.getVersions().add(newVersion("1.0.0"));
if(request.getRawKvp()==null){returnrequest;
if(dataset!=null){WorkspaceInfows=catalog.getWorkspaceByName(dataset);
if(ws!=null){LocalWorkspace.set(ws);returnrequest;
if(layer!=null){LocalWorkspace.set(layer.getResource().getStore().getWorkspace());LocalPublished.set(layer);returnrequest;
if(group!=null){LocalWorkspace.set(group.getWorkspace());LocalPublished.set(group);returnrequest;
if(request!=null&&"GetCapabilities".equals(request.getRequest())&&request.getRawKvp()!=null){Stringdataset=Converters.convert(request.getRawKvp().get("DATASET"),String.class);
if(dataset!=null){kvp.put("DATASET",dataset);
if(nativeCRS!=null&&!CRS.equalsIgnoreMetadata(wgs84,nativeCRS)){features=newReprojectFeatureResults(features,wgs84);
if(count==-1){count=featureSource.getFeatures(q).size();
ifadefinitionqueryhasbeenestablishedforthislayer,//besuretorespectitbycombiningitwiththeboundingboxone.q=DataUtilities.mixQueries(q,layer.getQuery(),"KMLEncoder");//checktheregionatingstrategyRegionatingStrategyregionatingStrategy=null;Stringstratname=(String)mapContent.getRequest().getFormatOptions().get("regionateBy");
if(("auto").equals(stratname)){Catalogcatalog=wms.getGeoServer().getCatalog();Namename=layer.getFeatureSource().getName();stratname=catalog.getFeatureTypeByName(name).getMetadata().get("kml.regionateStrategy",String.class);
if(stratname==null||"".equals(stratname)){stratname="best_guess";LOGGER.log(Level.FINE,"Nodefaultregionatingstrategyhasbeenconfiguredin"+name+";usingautomaticbest-guessstrategy.");
if(stratname!=null){regionatingStrategy=findStrategyByName(stratname);//
ifastrategywasspecifiedbutwedidnotfindit,lettheuser//know
if(regionatingStrategy==null){thrownewServiceException("Unknownregionatingstrategy"+stratname);
else{regionatingFilter=regionatingStrategy.getFilter(mapContent,layer);
if(finalFilter==Filter.EXCLUDE){//
ifwedon'thaveanyfeaturetoreturnreturnnull;
if(factory.canHandle(name)){returnfactory.createStrategy();
ifsomethinggoeswrongcreatingthefilter*/privateFiltercreateBBoxFilter(SimpleFeatureTypeschema,ReferencedEnvelopeaoi)throwsIllegalFilterException{//Googleearthlikestomakerequeststhatgobeyond180whenzoomedout//fixthemList<ReferencedEnvelope>envelopes=newArrayList<ReferencedEnvelope>();
if(KmlEncodingContext.WORLD_BOUNDS_WGS84.contains((Envelope)aoi)){envelopes.add(aoi);
else{Envelopeintersection=KmlEncodingContext.WORLD_BOUNDS_WGS84.intersection((Envelope)aoi);
if(intersection.getWidth()>0){envelopes.add(newReferencedEnvelope(intersection,DefaultGeographicCRS.WGS84));
if(aoi.getMaxX()>180){//GEneversendsvalueslargerthan360doublemaxx=aoi.getMaxX()-360;doubleminx=aoi.getMinX()>180?aoi.getMinX()-360:-180;envelopes.add(newReferencedEnvelope(minx,maxx,aoi.getMinY(),aoi.getMaxY(),DefaultGeographicCRS.WGS84));
if((sourceCrs!=null)&&!CRS.equalsIgnoreMetadata(aoi.getCoordinateReferenceSystem(),sourceCrs)){for(ReferencedEnvelopere:envelopes){try{ReferencedEnvelopese=re.transform(sourceCrs,true);sourceEnvelopes.add(se);
else{sourceEnvelopes.addAll(envelopes);
if(sourceEnvelopes.size()==0){returnFilter.INCLUDE;
else
if(sourceEnvelopes.size()==1){ReferencedEnvelopese=sourceEnvelopes.get(0);returnfilterFactory.bbox(gd.getLocalName(),se.getMinX(),se.getMinY(),se.getMaxX(),se.getMaxY(),null);
else{//wehavetoORthemultiplesourceenvelopesList<Filter>filters=newArrayList<Filter>();for(ReferencedEnvelopese:sourceEnvelopes){filters.add(filterFactory.bbox(gd.getLocalName(),se.getMinX(),se.getMinY(),se.getMaxX(),se.getMaxY(),null));
if(filters==null||filters.length==0){returnFilter.EXCLUDE;
if(filters.length>0){FilterFactoryff=CommonFactoryFinder.getFilterFactory(null);result=ff.and(Arrays.asList(filters));
else
if(filters.length==1){result=filters[0];
if(eventinstanceofJMSServiceModifyEvent)returntrue;
elsereturnfalse;
if(reqinstanceofHttpServletRequest){HttpServletRequestrequest=(HttpServletRequest)req;HttpServletResponseresponse=(HttpServletResponse)res;Stringae=request.getHeader("accept-encoding");
if(ae!=null&&ae.indexOf("gzip")!=-1){GZIPResponseWrapperwrappedResponse=newGZIPResponseWrapper(response,myCompressedTypes,request.getRequestURL().toString());chain.doFilter(req,wrappedResponse);wrappedResponse.finishResponse();return;
if(!f.exists()){return;
if(geoipLookup==null){return;
ifatleastoneuploadisinprogress*/@OverridepublicbooleanallowPut(){returnresumableUploadResourceManager.hasAnyResource();
if(filePath==null||filePath.isEmpty()){getResponse().setStatus(newStatus(Status.CLIENT_ERROR_BAD_REQUEST,"POSTdatamustcontainsuploadfilepath"));return;
if(uploadId==null||uploadId.isEmpty()){getResponse().setStatus(newStatus(Status.CLIENT_ERROR_BAD_REQUEST,"MissinguploadID"));return;
if(!resumableUploadResourceManager.resourceExists(uploadId)){getResponse().setStatus(newStatus(Status.CLIENT_ERROR_BAD_REQUEST,"UnknowuploadID"));return;
if(totalByteToUpload==0){getResponse().setStatus(newStatus(Status.CLIENT_ERROR_LENGTH_REQUIRED,"NotzeroContent-Lengthheadermustbespecified"));return;
if(headerRange!=null){try{
if(headerRange.getMinimum()>headerRange.getMaximum()||(headerRange.getRange().longValue()!=totalByteToUpload)){getResponse().setStatus(Status.CLIENT_ERROR_BAD_REQUEST,"Rangeparametervaluesarenotvalid");return;
if(!validated){getResponse().setStatus(Status.CLIENT_ERROR_REQUESTED_RANGE_NOT_SATISFIABLE,"Rangeparametervaluesnotmeetspartialuploadedfilessize");return;
else{//Clearpreviousfile
ifexistsresumableUploadResourceManager.clearUpload(uploadId);
if(writedBytes<totalFileSize){getResponse().setStatus(newStatus(RESUME_INCOMPLETE.getCode()));Series<Parameter>headers=newForm();headers.add("Content-Length","0");headers.add("Range","0-"+(writedBytes-1));getResponse().getAttributes().put("org.restlet.http.headers",headers);
else{StringmappedPath;try{mappedPath=resumableUploadResourceManager.uploadDone(uploadId);
if(uploadId==null||uploadId.isEmpty()){getResponse().setStatus(newStatus(Status.CLIENT_ERROR_BAD_REQUEST,"MissinguploadID"));return;
if(!resumableUploadResourceManager.isUploadDone(uploadId)){LongwritedBytes=resumableUploadResourceManager.getWrittenBytes(uploadId);getResponse().setStatus(newStatus(RESUME_INCOMPLETE.getCode()));Series<Parameter>headers=newForm();headers.add("Content-Length","0");headers.add("Range","0-"+(writedBytes-1));getResponse().getAttributes().put("org.restlet.http.headers",headers);
else{Responseresponse=getResponse();response.setStatus(Status.SUCCESS_OK);
if(oHeaders!=null){Series<Parameter>headers=(Series<Parameter>)oHeaders;ParametercontentLengthParam=headers.getFirst("Content-Length",true);
if(contentLengthParam!=null){StringcontentLengthStr=contentLengthParam.getValue();
if(!contentLengthStr.isEmpty()&&StringUtils.isNumeric(contentLengthStr)){contentLength=Long.parseLong(contentLengthStr);
if(oHeaders!=null){Series<Parameter>headers=(Series<Parameter>)oHeaders;ParametercontentRangeParam=headers.getFirst("Content-Range",true);
if(contentRangeParam!=null){StringcontentRangeStr=contentRangeParam.getValue();Stringrange=contentRangeStr.substring(6);String[]rangeParts=range.split("/");LongstartPosition=Long.parseLong(rangeParts[0].split("-")[0]);LongendPosition=Long.parseLong(rangeParts[0].split("-")[1]);LongtotalFileSize=Long.parseLong(rangeParts[1]);headerRange=newHeaderRange(startPosition,endPosition,totalFileSize);
ifitdoesn'texist.**@paramfileNameNameofthefile*@paramscopeScopeforlookingupadefault
ifthefiledoesn'texist.*@throwsIOException*/publicResourcegetConfigFile(StringfileName,Class<?>scope)throwsIOException{returngetConfigFile(fileName,scope,this.rl);
if(!Resources.exists(file)){IOUtils.copy(scope.getResourceAsStream(fileName),file.out());
ifclusteringingeneralisenabled.*/publicbooleanisSessionSharing(){returnisEnabled()&&Boolean.parseBoolean(getClusterConfig().getProperty("session_sharing","true"));
ifclusteringisnotenabled*/publicHazelcastInstancegetHz(){
if(!isEnabled())thrownewIllegalStateException("HazelcastClusteringhasnotbeenenabled.");returnhz;
if(watcher.get().isEnabled()){hz=Hazelcast.newHazelcastInstance(loadHazelcastConfig(this.rl));CLUSTER=this;
if(hz!=null){LOGGER.info("HzCluster.destroy()invoked,shuttingdownHazelcastinstance...");CLUSTER=null;hz.getLifecycleService().shutdown();hz=null;LOGGER.info("HzCluster.destroy():Hazelcastinstanceshutdowncomplete");
if(watcher.get().isEnabled()){hz=Hazelcast.newHazelcastInstance(loadHazelcastConfig(resourceLoader));CLUSTER=this;
if(owsSections!=null){Sectionssections=Wcs20Factory.eINSTANCE.createSections();for(Objecto:owsSections.getSection()){StringsectionName=(String)o;Sectionsection=Section.get(sectionName);
if(section==null){thrownewWCS20Exception("Invalidsectionsvalue"+sectionName+",supportedvaluesare"+Arrays.asList(Section.values()),OWSExceptionCode.InvalidParameterValue,"sections");
if(subset!=null){kvp.put("dimensionTrim",subset);
if(containment!=null){kvp.put("containmentType",containment);
if(metadataLink!=null){MetadataLinkInfoml=gs.getCatalog().getFactory().createMetadataLink();ml.setAbout((String)metadataLink.get("about"));ml.setMetadataType((String)metadataLink.get("metadataType"));ml.setType((String)metadataLink.get("type"));service.setMetadataLink(ml);
if(keywords!=null){for(Stringkw:keywords){service.getKeywords().add(newKeyword(kw));
if(auth==null)returnnull;//nextproviderSet<GrantedAuthority>roles=newHashSet<GrantedAuthority>();roles.addAll(auth.getAuthorities());//addgeoserverroles
if(getSecurityManager()!=null){RoleCalculatorcalc=newRoleCalculator(getSecurityManager().getActiveRoleService());try{roles.addAll(calc.calculateRoles(newGeoServerUser(auth.getName())));
if(!auth.getAuthorities().contains(GeoServerRole.AUTHENTICATED_ROLE)){roles.add(GeoServerRole.AUTHENTICATED_ROLE);
if(adminRole!=null&&!adminRole.equals("")&&!roles.contains(GeoServerRole.ADMIN_ROLE)){for(GrantedAuthorityauthority:auth.getAuthorities()){
if(authority.getAuthority().equalsIgnoreCase("ROLE_"+adminRole)){roles.add(GeoServerRole.ADMIN_ROLE);break;
if(groupAdminRole!=null&&!groupAdminRole.equals("")&&!roles.contains(GeoServerRole.GROUP_ADMIN_ROLE)){for(GrantedAuthorityauthority:auth.getAuthorities()){
if(authority.getAuthority().equalsIgnoreCase("ROLE_"+groupAdminRole)){roles.add(GeoServerRole.GROUP_ADMIN_ROLE);break;
if(datePattern!=null){this.datePattern=newDatePattern(datePattern,null,true,false);//parsethedateformattoensureitslegaltry{this.datePattern.dateFormat();
if(val!=null){Dateparsed=(valinstanceofDate?(Date)val:parseDate(val.toString()));
if(parsed==null){task.addMessage(Level.WARNING,"Invaliddate'"+val+"'specifiedfor"+feature.getID());feature=null;
else{feature.setAttribute(field,parsed);
if(enddate!=null){val=oldFeature.getAttribute(field);
if(val!=null){parsed=(valinstanceofDate?(Date)val:parseDate(val.toString()));
if(parsed!=null){feature.setAttribute(enddate,parsed);
if(task.getLayer()!=null){ResourceInfor=task.getLayer().getResource();
if(r!=null&&r.getMetadata().get(ResourceInfo.TIME)==null){DimensionInfodim=newDimensionInfoImpl();dim.setEnabled(true);dim.setAttribute(field);dim.setEndAttribute(enddate);dim.setPresentation(DimensionPresentation.valueOf(presentation));dim.setUnits("ISO8601");//TODO:isthereanenumerationforthis?r.getMetadata().put(ResourceInfo.TIME,dim);
ifaformatwasprovided,useit
if(datePattern!=null){parsed=datePattern.parse(value);
if(parsed==null){parsed=Dates.parse(value);
if(parsed!=null){returnparsed;
if(OPTIMIZE_LINE_WIDTH==null){Stringenabled=GeoServerExtensions.getProperty("OPTIMIZE_LINE_WIDTH",context);//defaulttotrue,butallowswitchingoff
if(enabled==null)OPTIMIZE_LINE_WIDTH=false;
elseOPTIMIZE_LINE_WIDTH=Boolean.valueOf(enabled);
if(MAX_FILTER_RULES==null){Stringrules=GeoServerExtensions.getProperty("MAX_FILTER_RULES",context);//defaulttotrue,butallowswitchingoff
if(rules==null)MAX_FILTER_RULES=20;
elseMAX_FILTER_RULES=Integer.valueOf(rules);
if(USE_GLOBAL_RENDERING_POOL==null){StringusePool=GeoServerExtensions.getProperty("USE_GLOBAL_RENDERING_POOL",context);//defaulttotrue,butallowswitchingoff
if(usePool==null)USE_GLOBAL_RENDERING_POOL=true;
elseUSE_GLOBAL_RENDERING_POOL=Boolean.valueOf(usePool);
if(null==getCapabilities){thrownewUnsupportedOperationException("Operationnotproperlyconfigured,makesuretheoperationbeanhasbeenset");
if(null==describeLayer){thrownewUnsupportedOperationException("Operationnotproperlyconfigured,makesuretheoperationbeanhasbeenset");
if(null==getMap){thrownewUnsupportedOperationException("Operationnotproperlyconfigured,makesuretheoperationbeanhasbeenset");
if(null==getFeatureInfo){thrownewUnsupportedOperationException("Operationnotproperlyconfigured,makesuretheoperationbeanhasbeenset");
if(null==getLegendGraphic){thrownewUnsupportedOperationException("Operationnotproperlyconfigured,makesuretheoperationbeanhasbeenset");
if(getMap.getFormat()==null){getMap.setFormat(FORMAT);
if((getMap.getStyles()==null)||getMap.getStyles().isEmpty()){//setstylestobethedefaultsforthespecifiedlayers//TODO:shouldthisbepartofcoreWMSlogic?issoletsthrow//this//intotheGetMapKvpRequestReader
if((getMap.getLayers()!=null)&&(getMap.getLayers().size()>0)){ArrayList<Style>styles=newArrayList<Style>(getMap.getLayers().size());for(inti=0;i<getMap.getLayers().size();i++){styles.add(getMap.getLayers().get(i).getDefaultStyle());
else{getMap.setStyles(STYLES);
if*eitherheightorwidtharespecifiedbytheuser.Ifbothheightandwidtharespecifiedby*theuser,theautomaticallydeterminedboundingboxwillbeadjustedtofitinsidethese*bounds.**<p>Generalidea1)FigureoutwhetherSRShasbeenspecified,fallbacktoEPSG:43262)*DeterminewhetherallrequestedlayersusethesameSRS,-
ifso,trytodoboundingbox*calculationsinnativecoordinates3)Aggregatetheboundingboxes(inEPSG:4326ornative)*4a)Ifboundingboxhasbeenspecified,adjustheightofimagetomatch4b)Ifboundingbox*hasnotbeenspecified,butheighthas,adjustboundingbox*/publicstaticvoidautoSetBoundsAndSize(GetMapRequestgetMap){//GetthelayersList<MapLayerInfo>layers=getMap.getLayers();/**1)CheckwhatSRShasbeenrequested*/StringreqSRS=getMap.getSRS();//
ifnone,trytodeterminewhichSRStouse//andkeeptrackofwhetherwecanusenativeallthewaybooleanuseNativeBounds=true;
if(reqSRS==null){reqSRS=guessCommonSRS(layers);forceSRS(getMap,reqSRS);
if(layers.get(i)!=null){StringlayerSRS=layers.get(i).getSRS();useNativeBounds=reqSRS.equalsIgnoreCase(layerSRS)&&layers.get(i).getResource().getNativeBoundingBox()!=null;
else{useNativeBounds=false;
ifnotspecifiedEnvelopeaggregateBbox=getMap.getBbox();booleanspecifiedBbox=true;//Ifbboxisnotspecifiedbyrequest
if(aggregateBbox==null){specifiedBbox=false;//Gettheboundingboxfromthelayersfor(inti=0;i<layers.size();i++){MapLayerInfolayerInfo=layers.get(i);ReferencedEnvelopecurbbox;try{curbbox=layerInfo.getLatLongBoundingBox();
if(useNativeBounds){ReferencedEnvelopenativeBbox=layerInfo.getBoundingBox();
if(nativeBbox==null){try{CoordinateReferenceSystemnativeCrs=layerInfo.getCoordinateReferenceSystem();nativeBbox=curbbox.transform(nativeCrs,true);
if(aggregateBbox!=null){aggregateBbox.expandToInclude(curbbox);
else{//defensivecopy(otherwiseitcancauseacatalogreferencedenvelopetobe//modified)aggregateBbox=newReferencedEnvelope(curbbox);
ifwehaveto
if(!useNativeBounds&&!reqSRS.equalsIgnoreCase(SRS)){try{ref=newReferencedEnvelope(aggregateBbox,CRS.decode("EPSG:4326"));aggregateBbox=ref.transform(reqCRS,true);
if(aggregateBbox==null){forceSRS(getMap,DefaultWebMapService.SRS);aggregateBbox=DefaultWebMapService.BBOX;
if(mheight>0.5&&mwidth>0.5&&specifiedBbox){//Thispersonreallydoesntwantourhelp,//we'llwarpitanywaytheylikeit...
else{
if(mheight>0.5&&mwidth>0.5){//Fullyspecified,needtoadjustbboxdoublemratio=mwidth/mheight;//Adjustboundstobelessthanidealtomeetspec
if(bbratio>mratio){//Toowide,needtoincreaseheightofbbdoublediff=((bbwidth/mratio)-bbheight)/2;aggregateBbox.expandBy(0,diff);
else{//Tootall,needtoincreasewidthofbbdoublediff=((bbheight*mratio)-bbwidth)/2;aggregateBbox.expandBy(diff,0);
else
if(mheight>0.5){mwidth=bbratio*mheight;
else{
if(mwidth>0.5){mheight=(mwidth/bbratio>=1)?mwidth/bbratio:1;
else{
if(bbratio>1){mwidth=MAX_SIDE;mheight=(mwidth/bbratio>=1)?mwidth/bbratio:1;
else{mheight=MAX_SIDE;mwidth=(mheight*bbratio>=1)?mheight*bbratio:1;
if("application/openlayers".equalsIgnoreCase(getMap.getFormat())||"openlayers".equalsIgnoreCase(getMap.getFormat())){
if(mheight<MIN_OL_HEIGHT){mheight=MIN_OL_HEIGHT;
else
if(mheight>MAX_OL_HEIGHT){mheight=MAX_OL_HEIGHT;
if(mwidth<MIN_OL_WIDTH){mwidth=MIN_OL_WIDTH;
else
if(mwidth>MAX_OL_WIDTH){mwidth=MAX_OL_WIDTH;
if(SRS==null){SRS=layerSRS.toUpperCase();
else
if(!SRS.equals(layerSRS)){//layerswithmixednativeSRS,let'sjustusethedefaultreturnDefaultWebMapService.SRS;
if(SRS==null){returnDefaultWebMapService.SRS;
iftheSRSisEPSG:4326orEPSG:900913**@paramreqSRStheSRS*@parambboxthecurrentboundingbox*@returntheadjustedboundingbox*/privatestaticEnvelopeadjustBounds(StringreqSRS,Envelopebbox){
if(reqSRS.equalsIgnoreCase("EPSG:4326")){bbox.expandBy(bbox.getWidth()/100,bbox.getHeight()/100);EnvelopemaxEnv=newEnvelope(-180.0,-90.0,180.0,90.0);returnbbox.intersection(maxEnv);
else
if(reqSRS.equalsIgnoreCase("EPSG:900913")){bbox.expandBy(bbox.getWidth()/100,bbox.getHeight()/100);EnvelopemaxEnv=newEnvelope(-20037508.33,-20037508.33,20037508.33,20037508.33);returnbbox.intersection(maxEnv);
if(USE_GLOBAL_RENDERING_POOL&&RENDERING_POOL==null){synchronized(DefaultWebMapService.class){
if(RENDERING_POOL==null){RENDERING_POOL=Executors.newCachedThreadPool();
if(RENDERING_POOL!=null){RENDERING_POOL.shutdown();RENDERING_POOL.awaitTermination(10,TimeUnit.SECONDS);RENDERING_POOL=null;
if(configHelper.isNew()){comp=newJDBCConnectFormComponent("jdbcConnectFormComponent",Mode.DYNAMIC);
else{JDBCSecurityServiceConfigconfig=(JDBCSecurityServiceConfig)configHelper.getConfig();
if(config.isJndi()){comp=newJDBCConnectFormComponent("jdbcConnectFormComponent",Mode.DYNAMIC,config.getJndiName());
else{comp=newJDBCConnectFormComponent("jdbcConnectFormComponent",Mode.DYNAMIC,config.getDriverClassName(),config.getConnectURL(),config.getUserName(),config.getPassword());
if(config.isJndi()){config.setJndiName(c.getJndiName());
else{config.setDriverClassName(c.getDriverName());config.setConnectURL(c.getConnectURL());config.setUserName(c.getUsername());config.setPassword(c.getPassword());
if(!(objectinstanceofDomains)){thrownewIllegalArgumentException("Expecteddomainsinfobutinsteadgot:"+object.getClass().getCanonicalName());
if(gwc.isDiskQuotaEnabled()){returngwc.getUsedQuota(item.getName());
else{returnnull;
if(input!=null&&!input.isEmpty()){TileLayerlayer=GWC.get().getTileLayerByName(input);returnlayer.isAdvertised();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;CoverageAccessInfoImplother=(CoverageAccessInfoImpl)obj;
if(corePoolSize!=other.corePoolSize)returnfalse;
if(imageIOCacheThreshold!=other.imageIOCacheThreshold)returnfalse;
if(keepAliveTime!=other.keepAliveTime)returnfalse;
if(maxPoolSize!=other.maxPoolSize)returnfalse;
if(queueType==null){
if(other.queueType!=null)returnfalse;
else
if(!queueType.equals(other.queueType))returnfalse;returntrue;
ifthesequenceiscompleted*/Tnext();}
if(e.getCause()instanceofAbstractSecurityException){error(e.getCause());
else{error(newParamResourceModel("saveError",getPage(),e.getMessage()).getObject());
if(features!=null){for(Featuref:features){
if(!f.getType().equals(memberType)){//TODO:handleinheritancethrownewIllegalArgumentException("Foundafeaturewhosefeaturetypeisnotequaltothedeclaredone:"+f);
if(filter.evaluate(f)){results.add(f);
ifitispresent*(optionaloperation).**@paramoelementtoberemovedfromthiscollection,
ifpresent.*@return<tt>true</tt>
ifthecollectioncontainedthespecifiedelement.*@throwsUnsupportedOperationException
ifthe<tt>remove</tt>methodisnotsupportedbythis*collection.*/publicbooleanremove(Objecto){returnfeatures.remove(o);
ifthiscollectionchangedasaresultofthecall.*@throwsUnsupportedOperationException
ifthe<tt>removeAll</tt>methodisnotsupportedby*thiscollection.*@throwsNullPointerException
ifthespecifiedcollectionisnull.*@see#remove(Object)*@see#contains(Object)*/publicfinalbooleanremoveAll(Collection<?>c){returnfeatures.removeAll(c);
ifthiscollectionchangedasaresultofthecall.*@throwsUnsupportedOperationException
ifthe<tt>retainAll</tt>methodisnotsupportedby*thisCollection.*@throwsNullPointerException
ifthespecifiedcollectionisnull.*@see#remove(Object)*@see#contains(Object)*/publicfinalbooleanretainAll(Collection<?>c){returnfeatures.removeAll(c);
ifthecollectionchangedasaresultofthecall.*@throwsUnsupportedOperationException
ifthe<tt>add</tt>methodisnotsupportedbythis*collection.*@throwsNullPointerException
ifthiscollectiondoesnotpermit<tt>null</tt>elements,and*thespecifiedelementis<tt>null</tt>.*@throwsClassCastException
iftheclassofthespecifiedelementpreventsitfrombeingadded*tothiscollection.*@throwsIllegalArgumentException
ifsomeaspectofthiselementpreventsitfrombeingadded*tothiscollection.*/publicbooleanadd(Featureo){returnfeatures.add(o);
ifthiscollectionchangedasaresultofthecall.*@throwsUnsupportedOperationException
ifthiscollectiondoesnotsupportthe<tt>addAll</tt>*method.*@throwsNullPointerException
ifthespecifiedcollectionisnull.*@see#add(Feature)*/publicbooleanaddAll(Collection<Feature>c){returnfeatures.addAll(c);
elsetodoverify(mediator,times(1)).getTileLayersByFeatureType(eq(layerName.getNamespaceURI()),eq(layerName.getLocalPart()));verifyNoMoreInteractions(mediator);
if(!response.getContentType().startsWith("application/json")){System.out.println(response.getContentAsString());fail("Expectedjsonbutgot"+response.getContentType());
if(sort!=null&&sort.getProperty().equals(TYPE.getName())){returnnewComparator<BlobStoreInfo>(){@Overridepublicintcompare(BlobStoreInfoo1,BlobStoreInfoo2){intr=BlobStoreTypes.getFromClass(o1.getClass()).toString().compareTo(BlobStoreTypes.getFromClass(o2.getClass()).toString());returnsort.isAscending()?r:-r;
else{returnsuper.getComparator(sort);
iftherootprovideristhefirstAuthenticationProviderfirst=getSecurityManager().getProviders().get(0);assertEquals(GeoServerRootAuthenticationProvider.class,first.getClass());GeoServerRootAuthenticationProviderprovider=newGeoServerRootAuthenticationProvider();provider.setSecurityManager(getSecurityManager());provider.initializeFromConfig(null);UsernamePasswordAuthenticationTokentoken=newUsernamePasswordAuthenticationToken("abc",null);assertTrue(provider.supports(token.getClass()));assertFalse(provider.supports(RememberMeAuthenticationToken.class));assertNull(provider.authenticate(token));token=newUsernamePasswordAuthenticationToken(GeoServerUser.ROOT_USERNAME,null);assertNull(provider.authenticate(token));token=newUsernamePasswordAuthenticationToken(GeoServerUser.ROOT_USERNAME,"abc");assertNull(provider.authenticate(token));StringmasterPassword=getMasterPassword();token=newUsernamePasswordAuthenticationToken(GeoServerUser.ROOT_USERNAME,masterPassword);token.setDetails("hallo");UsernamePasswordAuthenticationTokenresult=(UsernamePasswordAuthenticationToken)provider.authenticate(token);assertNotNull(result);assertNull(result.getCredentials());assertEquals(GeoServerUser.ROOT_USERNAME,result.getPrincipal());assertEquals("hallo",result.getDetails());}}
if(response.getRawStatusCode()!=400){super.handleError(response);
if(checkTokenResponse.containsKey("error")){logger.debug("check_tokenreturnederror:"+checkTokenResponse.get("error"));thrownewInvalidTokenException(accessToken);
if(headers.getContentType()==null){headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
if(piinstanceofSecuredLayerInfo||piinstanceofSecuredLayerGroupInfo){@SuppressWarnings("unchecked")AbstractDecorator<?extendsPublishedInfo>decorator=(AbstractDecorator<?extendsPublishedInfo>)pi;returndecorator.unwrap(PublishedInfo.class);
else{returnpi;
if(input==null||input.trim().length()==0){returnchoices.iterator();
if(rasterLegend.getType()==Type.RESOURCE){imgShape=ImageIO.read(rasterLegend.file());
if(ruleName!=null){Rulerule=LegendUtils.getRule(ftStyles,ruleName);
if(rule==null){thrownewServiceException("Specifiedstyledoesnotcontainsarulenamed"+ruleName);
else{applicableRules=LegendUtils.getApplicableRules(ftStyles,scaleDenominator);
if(applicableRules.length!=0){//finalNumberRange<Double>scaleRange=NumberRange.create(scaleDenominator,//scaleDenominator);//getwidthandheightwidth=request.getWidth();height=request.getHeight();
if(width<=0||height<=0)thrownewIllegalArgumentException("InvalidwidthandorheightfortheGetLegendGraphicRequest");finalSymbolizer[]symbolizers=applicableRules[0].getSymbolizers();
if(symbolizers==null||symbolizers.length!=1|symbolizers[0]==null)thrownewIllegalArgumentException("Unabletocreatealegendforthisstyle,weneedexactly1Symbolizer");finalSymbolizersymbolizer=symbolizers[0];
if(!(symbolizerinstanceofRasterSymbolizer))thrownewIllegalArgumentException("Unabletocreatealegendforthisstyle,weneedaRasterSymbolizer");rasterSymbolizer=(RasterSymbolizer)symbolizer;//isbackgroundtransparent?transparent=request.isTransparent();//backgroundbkgColorbgColor=LegendUtils.getBackgroundColor(request);//colormapelementfinalColorMapcmap=rasterSymbolizer.getColorMap();finalBuildercmapLegendBuilder=newColorMapLegendCreator.Builder();
if(cmap!=null&&cmap.getColorMapEntries()!=null&&cmap.getColorMapEntries().length>0){//passingadditionaloptionscmapLegendBuilder.setAdditionalOptions(request.getLegendOptions());//settingtypeofcolormapcmapLegendBuilder.setColorMapType(cmap.getType());//isthiscolormapusingextendedcolorscmapLegendBuilder.setExtended(cmap.getExtendedColors());//settingtherequestedcolormapentriescmapLegendBuilder.setRequestedDimension(newDimension(width,height));//settingtransparencyandbackgroundbkgColorcmapLegendBuilder.setTransparent(transparent);cmapLegendBuilder.setBackgroundColor(bgColor);//settingband//SettinglabelfontandfontbkgColorcmapLegendBuilder.setLabelFont(LegendUtils.getLabelFont(request));cmapLegendBuilder.setLabelFontColor(LegendUtils.getLabelFontColor(request));//SettinglayoutparameterscmapLegendBuilder.setLayout(LegendUtils.getLayout(request));cmapLegendBuilder.setColumnHeight(LegendUtils.getColumnHeight(request));cmapLegendBuilder.setRowWidth(LegendUtils.getRowWidth(request));cmapLegendBuilder.setColumns(LegendUtils.getColumns(request));cmapLegendBuilder.setRows(LegendUtils.getRows(request));cmapLegendBuilder.setLabelFontColor(LegendUtils.getLabelFontColor(request));//setbandfinalChannelSelectionchannelSelection=rasterSymbolizer.getChannelSelection();cmapLegendBuilder.setBand(channelSelection!=null?channelSelection.getGrayChannel():null);//checktheadditionaloptionsbeforeproceedingcmapLegendBuilder.checkAdditionalOptions();//addingthecolormapentriesfinalColorMapEntry[]colorMapEntries=cmap.getColorMapEntries();ColorMapEntryLegendBuilderlastEntry=null;booleanfirst=true;for(ColorMapEntryce:colorMapEntries){
if(ce==null){continue;
if(cmap.getType()==ColorMap.TYPE_INTERVALS&&first&&qty<0&&Double.isInfinite(qty)){continue;
if(lastEntry!=null){lastEntry.setLastRow();
elsecMapLegendCreator=null;
if(rasterSymbolizer==null){returnnull;
if(image==null){
if(cMapLegendCreator!=null)//creatingalegendimage=cMapLegendCreator.getLegend();
else{image=ImageUtils.createImage(width,height,(IndexColorModel)null,transparent);finalGraphics2Dgraphics=ImageUtils.prepareTransparency(transparent,bgColor,image,newHashMap<RenderingHints.Key,Object>());
if(defaultLegend==null){drawRasterIcon(graphics);
else{graphics.setRenderingHint(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_ON);graphics.drawImage(defaultLegend,0,0,width,height,null);
ifmultipleversionsofWCSaresupportedinsideWPSrequests.**@authordriesj*/@RunWith(Parameterized.class)publicclassExecuteOnCoverageTestextendsWPSTestSupport{privatefinalStringversion;@ParameterspublicstaticCollection<Object[]>getParameters(){returnArrays.asList(newObject[]{"1.1.1"},newObject[]{"2.0.0"});
ifwerequestingacoverageusingdifferent*WCSversionsworks.*/@TestpublicvoidtestCrop()throwsException{StringwcsRequest=WCS2GetCoverageRequestBuilder.newBuilder().coverageId(getLayerId(MockData.TASMANIA_DEM)).bbox(130.0,150,-44.,-40).asXML(version);Stringxml="<?xmlversion=\"1.0\"encoding=\"UTF-8\"?>\n"+"<wps:Executeversion=\"1.0.0\"service=\"WPS\"xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"xmlns=\"http://www.opengis.net/wps/1.0.0\"xmlns:wfs=\"http://www.opengis.net/wfs\"xmlns:wps=\"http://www.opengis.net/wps/1.0.0\"xmlns:ows=\"http://www.opengis.net/ows/1.1\"xmlns:gml=\"http://www.opengis.net/gml\"xmlns:ogc=\"http://www.opengis.net/ogc\"xmlns:wcs=\"http://www.opengis.net/wcs/1.1.1\"xmlns:xlink=\"http://www.w3.org/1999/xlink\"xsi:schemaLocation=\"http://www.opengis.net/wps/1.0.0http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd\">\n"+"<ows:Identifier>gs:CropCoverage</ows:Identifier>\n"+"<wps:DataInputs>\n"+"<wps:Input>\n"+"<ows:Identifier>coverage</ows:Identifier>\n"+"<wps:ReferencemimeType=\"image/tiff\"xlink:href=\"http://geoserver/wcs\"method=\"POST\">\n"+"<wps:Body>\n"+wcsRequest+"</wps:Body>\n"+"</wps:Reference>\n"+"</wps:Input>\n"+"<wps:Input>\n"+"<ows:Identifier>cropShape</ows:Identifier>\n"+"<wps:Data>\n"+"<wps:ComplexDatamimeType=\"application/wkt\"><![CDATA[POLYGON((145.5-41.9,145.5-42.1,145.6-42,145.5-41.9))]]></wps:ComplexData>\n"+"</wps:Data>\n"+"</wps:Input>\n"+"</wps:DataInputs>\n"+"<wps:ResponseForm>\n"+"<wps:RawDataOutputmimeType=\"application/arcgrid\">\n"+"<ows:Identifier>result</ows:Identifier>\n"+"</wps:RawDataOutput>\n"+"</wps:ResponseForm>\n"+"</wps:Execute>\n"+"\n"+"";MockHttpServletResponseresponse=postAsServletResponse(root(),xml);InputStreamis=getBinaryInputStream(response);ArcGridFormatformat=newArcGridFormat();GridCoveragegc=format.getReader(is).read(null);assertTrue(newEnvelope(-145.4,145.6,-41.8,-42.1).contains(newReferencedEnvelope(gc.getEnvelope())));double[]valueInside=(double[])gc.evaluate(newDirectPosition2D(145.55,-42));assertEquals(615.0,valueInside[0]);double[]valueOutside=(double[])gc.evaluate(newDirectPosition2D(145.57,-41.9));//thisshouldreallybeNoDataassertEquals(-9999&0xFFFF,(int)valueOutside[0]);}}
if(description==null){//grabthedescriptionStringdesc="-";try{//REVISIT:asfarasIknowtheEPSGnamesarenotlocalized?anyway,
if//they'rerevisittousethepagelocale//description=CRS.getAuthorityFactory(true).getDescriptionText("EPSG:"+//code)//.toString(getLocale()).toUpperCase();desc=CRS.getAuthorityFactory(true).getDescriptionText("EPSG:"+code).toString();
if(items==null){synchronized(SRSProvider.class){
if(items==null){items=buildCodeList();
iftheyarechosenexceptionsariseseverywhere
if(NUMERIC.matcher(id).matches()){idSet.add(newSRS(id));
if(c1==null){
if(c2==null)returns1.compareTo(s2);
elsereturn-1;
else{
if(c2==null)return1;
elsereturnc1-c2;
ifthereisasingleone,ornullotherwise*/publicabstractFormComponentgetFormComponent();}
if(isInternal){link.add(newAttributeModifier("style",newModel<String>("font-style:italic;")));link.add(newAttributeModifier("title",newResourceModel("nameLink.titleInternalGridSet")));
else{link.add(newAttributeModifier("title",newResourceModel("nameLink.title")));
iftheuserselectedanythingList<GridSet>selection=gridsets.getSelection();
if(selection.size()==0){return;
ifthereissomethingtocancel,let'swarntheuseraboutwhat//couldgowrong,and
iftheuseraccepts,let'sdeletewhat'sneededdialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){@OverrideprotectedComponentgetContents(finalStringid){finalGWCgwc=GWC.get();finalintcount=selectedGridsetIds.size();QuotatotalQuota=newQuota();for(StringgridsetId:selectedGridsetIds){QuotausedQuotaByGridSet=gwc.getUsedQuotaByGridSet(gridsetId);
if(usedQuotaByGridSet!=null){totalQuota.add(usedQuotaByGridSet);
iftheselectionhasbeenclearedoutit'ssignadeletion//occurred,sorefreshthetable
if(gridsets.getSelection().size()==0){setEnabled(false);target.add(SelectionRemovalLink.this);target.add(gridsets);
ifpresentfor*callsagainst<code>.../animate</code>serviceendpoints.**@paramrequestcurrentHTTPrequest*@paramresponsecurrentHTTPresponse*@paramchaincurrentlyexecutingfilterchain*@throwsjava.io.IOException*@throwsjavax.servlet.ServletException*/@OverridepublicvoiddoFilter(ServletRequestrequest,ServletResponseresponse,FilterChainchain)throwsIOException,ServletException{
if(requestinstanceofHttpServletRequest){HttpServletRequestrequestHTTP=(HttpServletRequest)request;
if(requestNeedsWrapper(requestHTTP)){LOGGER.log(Level.FINER,"Modifiedrequestto{0},removed\"Request\"KVPargument(GEOS-6006)",requestHTTP.getRequestURI());request=newRequestWrapper(requestHTTP);
if(request.getRequestURI().endsWith(ENDPOINT)){Enumeration<String>names=request.getParameterNames();while(names.hasMoreElements()){Stringname=names.nextElement();
if(REQUEST.equalsIgnoreCase(name)&&GETMAP.equalsIgnoreCase(request.getParameter(name))){returntrue;
if(!REQUEST.equalsIgnoreCase(key)){filtered.put(key,entry.getValue());
if(REQUEST.equalsIgnoreCase(name)){returnnull;
if(REQUEST.equalsIgnoreCase(name)){returnnull;
if(context!=null&&context.isKmz()){encodeAsKmz(kml,context,operation,output);
else{encoder.encode(kml,output,context);
if(!embeddedIcons.isEmpty()){ZipEntryicons=newZipEntry("icons/");zip.putNextEntry(icons);for(Map.Entry<String,Style>namedStyle:embeddedIcons.entrySet()){finalStringname=namedStyle.getKey();finalStylestyle=namedStyle.getValue();BufferedImageicon=IconRenderer.renderIcon(style);entry=newZipEntry("icons/"+name+".png");zip.putNextEntry(entry);ImageIO.write(icon,"PNG",zip);
if(latIndex<0||lngIndex<0){thrownewException("FeatureType"+featureType.getName()+"doesnothavelatlngfieldsnamed'"+latField+"'"+"and"+"'"+lngField+"'");
if(geometryDescriptor!=null){builder.remove(geometryDescriptor.getLocalName());
if(lat==null||lng==null){feature.setDefaultGeometry(null);
else{Coordinatecoordinate=newCoordinate(lng,lat);Pointpoint=geometryFactory.createPoint(coordinate);feature.setAttribute(pointFieldName,point);
if(value==null){returnnull;
if(valueinstanceofDouble){return(Double)value;
if(ev==null){thrownewNullArgumentException("Incomingeventisnull");
switch(ev.getEventType()){caseMODIFIED://localizeservicefinalServiceInfolocalObject=localizeService(geoServer,ev);//savethelocalizedobjectgeoServer.save(localObject);break;caseADDED://checkingthatthisserviceisnotalreadypresent,wedon'tsynchronizethis//check//
iftwothreadsaddthesameservicewelloneofthemwillfailandthrowan//exception//thiseventmaybegeneratedforaservicethatalreadyexists
if(geoServer.getService(ev.getSource().getId(),ServiceInfo.class)==null){//thisisanewservicesolet'saddittothisGeoServerinstancegeoServer.add(ev.getSource());
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(this.getClass()+"isunabletosynchronizetheincomingevent:"+ev);throwe;
if(geoServer==null||ev==null)thrownewIllegalArgumentException("wrongpassedargumentsarenull");finalServiceInfoinfo=JMSServiceHandler.getLocalService(geoServer,ev);BeanUtils.smartUpdate(info,ev.getPropertyNames(),ev.getNewValues());//LOCALIZEserviceinfo.setGeoServer(geoServer);returninfo;
ifnameischanged(remotely),searchisperformedusing*theoldone**@paramgeoServer*@paramev*/publicstaticServiceInfogetLocalService(finalGeoServergeoServer,finalJMSServiceModifyEventev){finalServiceInfoservice=ev.getSource();
if(service==null){thrownewIllegalArgumentException("passedserviceisnull");
ifnameischangedfinalList<String>props=ev.getPropertyNames();finalintindex=props.indexOf("name");StringserviceName=service.getName();
if(index!=-1){//theservicenamewasupdatedsoweneedtouseoldservicenamefinalList<Object>oldValues=ev.getOldValues();serviceName=oldValues.get(index).toString();
if(service.getWorkspace()==null){//novirtualservicereturngeoServer.getServiceByName(serviceName,ServiceInfo.class);
if(!isAuthenticatedAsAdmin()){//initializetheworkspacedropdown//defaulttofirstavailableworkspaceList<WorkspaceInfo>ws=getCatalog().getWorkspaces();
if(!ws.isEmpty()){styleModel.getObject().setWorkspace(ws.get(0));
ifthereisnoURL
if(null==s.getLegend()||null==s.getLegend().getOnlineResource()||s.getLegend().getOnlineResource().isEmpty()){s.setLegend(null);
if(s.getFilename()==null){//TODO:checkthatthisdoesnotoverrideanyexistingfiless.setFilename(s.getName()+"."+styleHandler.getFileExtension());
ifthestoresupportstransactions(insert,update,delete),falseotherwise*/publicbooleansupportsTransactions(){returnfalse;
ifGetRepositoryItemissupportedonthespecifiedtype**@paramtypeNameQualifiedname(withnamespace)*/publicbooleansupportsGetRepositoryItem(NametypeName){returnfalse;}}
if(property==StyleProvider.NAME){returnstyleLink(id,itemModel);
if(property==StyleProvider.WORKSPACE){returnworkspaceLink(id,itemModel);
if(isDefaultStyle(object)){returnnewStringResourceModel("cantRemoveDefaultStyle",StylePage.this,null);
if(wsName!=null){returnnewSimpleBookmarkableLink(id,WorkspaceEditPage.class,newModel<String>(wsName),"name",wsName);
else{returnnewWebMarkupContainer(id);
if(catalogInfoinstanceofStyleInfo){StyleInfos=(StyleInfo)catalogInfo;returns.getWorkspace()==null&&(StyleInfo.DEFAULT_POINT.equals(s.getName())||StyleInfo.DEFAULT_LINE.equals(s.getName())||StyleInfo.DEFAULT_POLYGON.equals(s.getName())||StyleInfo.DEFAULT_RASTER.equals(s.getName())||StyleInfo.DEFAULT_GENERIC.equals(s.getName()));
else{returnfalse;
if(writeFilter==Filter.EXCLUDE){throwunsupportedOperation();
else
if(writeFilter==Filter.INCLUDE){returnlockDelegate.lockFeatures(query);
else{returnlockDelegate.lockFeatures(mixed);
if(writeQuery.getFilter()==Filter.EXCLUDE){throwunsupportedOperation();
else{lockDelegate.setFeatureLock(lock);
if(writeFilter==Filter.EXCLUDE){throwunsupportedOperation();
else
if(writeFilter==Filter.INCLUDE){lockDelegate.unLockFeatures(query);
else{lockDelegate.unLockFeatures(mixed);
iftherearealready<code>queueSize*</code>requestsrunning*/publicclassSimpleThreadBlockerimplementsThreadBlocker{/***Thisqueuecontainstherequeststhatarerunning.Theoneswaitingarenot"visible",are*allblockedon{@linkBlockingQueue#offer(Object,long,TimeUnit)}}or{@link*BlockingQueue#put(Object)}*/BlockingQueue<Request>queue;publicSimpleThreadBlocker(intqueueSize){queue=newArrayBlockingQueue<Request>(queueSize,true);
if(timeout>0){returnqueue.offer(request,timeout,TimeUnit.MILLISECONDS);
else{queue.put(request);returntrue;
if(!projectionFileDir.mkdir()){FileUtils.deleteDirectory(projectionFileDir);assertTrue("Unabletocreateprojectiondir:"+projectionFileDir,projectionFileDir.mkdir());
if(workspace==null){returngetCatalog().getLayerGroups();
else{returngetCatalog().getLayerGroupsByWorkspace(workspace);
if(NAME==property){returnnewSimpleAjaxLink<String>(id,(IModel<String>)model){privatestaticfinallongserialVersionUID=-5189072047640596694L;@OverrideprotectedvoidonClick(AjaxRequestTargettarget){LayerGroupInfolayerGroup=itemModel.getObject();handleLayerGroup(layerGroup,target);
else{returnnewLabel(id,model);
if(nodeOpts==null){nodeId=null;nodeIdStyle=null;
else{try{Map<String,String>options=parseProperties(nodeOpts);Stringid=(String)options.get("id");
if(id!=null){
if(id.contains("$host_ip")){InetAddressaddress=getLocalHostLANAddress();id=id.replace("$host_ip",address.getHostAddress());
else
if(id.contains("$host_name")){InetAddressaddress=getLocalHostLANAddress();id=id.replace("$host_name",address.getHostName());
if(bgcolor==null){bgcolor="#dadada";
if(color==null){color="#0076a1";
if(!inetAddr.isLoopbackAddress()){
if(inetAddr.isSiteLocalAddress()){returninetAddr;
else
if(candidateAddress==null){candidateAddress=inetAddr;
if(candidateAddress!=null){returncandidateAddress;
if(jdkSuppliedAddress==null){thrownewUnknownHostException("TheJDKInetAddress.getLocalHost()methodunexpectedlyreturnednull.");
ifneeded*/privatestaticMap<String,String>parseProperties(Stringproperty){Map<String,String>properties=newHashMap<String,String>();List<String>kvps=KvpUtils.escapedTokens(property,';');for(Stringkvp:kvps){List<String>kv=KvpUtils.escapedTokens(kvp,':',2);Stringkey=kv.get(0).toLowerCase();Stringvalue=kv.size()==1?"true":KvpUtils.unescape(kv.get(1));properties.put(key,value);
if(store!=null){JDBCUserGroupStorejdbcStore=(JDBCUserGroupStore)store;JDBCTestSupport.dropExistingTables(jdbcStore,jdbcStore.getConnection());store.store();
if(getTestData().isTestDataAvailable()){service=getSecurityManager().loadUserGroupService(getFixtureId());store=createStore(service);
if("h2".equalsIgnoreCase(getFixtureId()))returnsuper.createTestData();returnnewLiveDbmsDataSecurity(getFixtureId());
if(invalidTuples!=null)returninvalidTuples;Propertiesprops=getModelObject();
if(props==null){props=newProperties();
if(props==null){props=newProperties();
if(StringUtils.hasLength(t.getKey())==false){invalidTuples=listView.getModelObject();error(newValidationError("KeyRequired").addKey("KeyRequired"));return;
if(StringUtils.hasLength(t.getValue())==false){invalidTuples=listView.getModelObject();error(newValidationError("ValueRequired").addKey("ValueRequired"));return;
if(pf==null||pf.create(name)==null){thrownewWPSException("Nosuchprocess:"+id.getValue());
if(outputMimeParameters.contains(p.key)){continue;
if(ppios.isEmpty()){thrownewWPSException("Couldnotfindprocessparameterfortype"+p.key+","+p.type);
if(ppios.get(0)instanceofLiteralPPIO){LiteralPPIOlppio=(LiteralPPIO)ppios.get(0);LiteralInputTypeliteral=wpsf.createLiteralInputType();input.setLiteralData(literal);//mapthejavaclasstoanxmltypename
if(!String.class.equals(lppio.getType())){Classtype=lppio.getType();
if(PRIMITIVE_TO_WRAPPER.containsKey(type)){type=PRIMITIVE_TO_WRAPPER.get(type);
if(typeName!=null){literal.setDataType(Ows11Util.type("xs:"+typeName.getLocalPart()));
if(p.metadata.get(Parameter.OPTIONS)!=null){List<Object>options=(List<Object>)p.metadata.get(Parameter.OPTIONS);Object[]optionsArray=options.toArray(newObject[options.size()]);addAllowedValues(literal,optionsArray);
else
if(lppio.getType().isEnum()){Object[]enumValues=lppio.getType().getEnumConstants();addAllowedValues(literal,enumValues);
else{Objectmin=p.metadata.get(Param.MIN);Objectmax=p.metadata.get(Param.MAX);addAllowedValues(literal,min,max);
if(p.sample!=null){literal.setDefaultValue(lppio.encode(p.sample));
else
if(ppios.get(0)instanceofBoundingBoxPPIO){input.setBoundingBoxData(buildSupportedCRSType());
else{//handlethecomplexdatacaseSupportedComplexDataInputTypecomplex=wpsf.createSupportedComplexDataInputType();input.setComplexData(complex);
if(p.metadata.get(MaxSizeValidator.PARAMETER_KEY)instanceofNumber){intmaxSize=((Number)p.metadata.get(MaxSizeValidator.PARAMETER_KEY)).intValue();
if(maxSize>0){complex.setMaximumMegabytes(BigInteger.valueOf(maxSize));
if(ppioinstanceofRawDataPPIO){String[]mimeTypes=AbstractRawData.getMimeTypes(p);for(StringmimeType:mimeTypes){ComplexDataDescriptionTypeddt=wpsf.createComplexDataDescriptionType();ddt.setMimeType(mimeType);//heuristictofigureout
ifaformatistextbased,ornot,we//mightwanttoexposethisasaseparateannotation/propertydownthe//road
if(!mimeType.contains("json")&&!mimeType.contains("text")&&!mimeType.contains("xml")&&!mimeType.contains("gml")){ddt.setEncoding("base64");
if(format==null){format=ddt;
else{format=wpsf.createComplexDataDescriptionType();format.setMimeType(cppio.getMimeType());
if(cppioinstanceofBinaryPPIO){format.setEncoding("base64");
if(complex.getDefault()==null){ComplexDataDescriptionTypedef=wpsf.createComplexDataDescriptionType();def.setMimeType(format.getMimeType());complex.setDefault(wpsf.createComplexDataCombinationType());complex.getDefault().setFormat(def);
if(min==null&&max==null){literal.setAnyValue(owsf.createAnyValueType());
else{AllowedValuesTypeallowed=owsf.createAllowedValuesType();RangeTyperange=owsf.createRangeType();
if(min!=null){ValueTypeminValue=owsf.createValueType();minValue.setValue(min.toString());range.setMinimumValue(minValue);
if(max!=null){ValueTypemaxValue=owsf.createValueType();maxValue.setValue(max.toString());range.setMaximumValue(maxValue);
if(min==null){rangeClosure=RangeClosureType.OPEN_CLOSED_LITERAL;
else
if(max==null){rangeClosure=RangeClosureType.CLOSED_OPEN_LITERAL;
else{rangeClosure=RangeClosureType.CLOSED_LITERAL;
if(ppios.isEmpty()){thrownewWPSException("Couldnotfindprocessparameterfortype"+p.key+","+p.type);
if(ppios.get(0)instanceofLiteralPPIO){LiteralPPIOlppio=(LiteralPPIO)ppios.get(0);LiteralOutputTypeliteral=wpsf.createLiteralOutputType();output.setLiteralOutput(literal);//mapthejavaclasstoanxmltypename
if(!String.class.equals(lppio.getType())){Classtype=lppio.getType();
if(PRIMITIVE_TO_WRAPPER.containsKey(type)){type=PRIMITIVE_TO_WRAPPER.get(type);
if(typeName!=null){literal.setDataType(Ows11Util.type(typeName.getLocalPart()));
else
if(ppios.get(0)instanceofBoundingBoxPPIO){output.setBoundingBoxOutput(buildSupportedCRSType());
else{//handlethecomplexdatacaseSupportedComplexDataTypecomplex=wpsf.createSupportedComplexDataType();output.setComplexOutput(complex);complex.setSupported(wpsf.createComplexDataCombinationsType());for(ProcessParameterIOppio:ppios){ComplexPPIOcppio=(ComplexPPIO)ppio;ComplexDataDescriptionTypeformat=null;
if(ppioinstanceofRawDataPPIO){String[]mimeTypes=AbstractRawData.getMimeTypes(p);for(StringmimeType:mimeTypes){ComplexDataDescriptionTypeddt=wpsf.createComplexDataDescriptionType();ddt.setMimeType(mimeType);complex.getSupported().getFormat().add(ddt);
if(format==null){format=ddt;
else{format=wpsf.createComplexDataDescriptionType();format.setMimeType(cppio.getMimeType());//addtosupportedcomplex.getSupported().getFormat().add(format);
if(complex.getDefault()==null){ComplexDataDescriptionTypedef=wpsf.createComplexDataDescriptionType();def.setMimeType(format.getMimeType());complex.setDefault(wpsf.createComplexDataCombinationType());complex.getDefault().setFormat(def);
if(roleStore!=null){JDBCRoleStorejdbcStore1=(JDBCRoleStore)roleStore;JDBCTestSupport.dropExistingTables(jdbcStore1,jdbcStore1.getConnection());roleStore.store();
if(usergroupStore!=null){JDBCUserGroupStorejdbcStore2=(JDBCUserGroupStore)usergroupStore;JDBCTestSupport.dropExistingTables(jdbcStore2,jdbcStore2.getConnection());usergroupStore.store();
if(getSecurityManager().loadRoleService(getFixtureId())==null)super.setServices(getFixtureId());
else{roleService=getSecurityManager().loadRoleService(getFixtureId());roleStore=createStore(roleService);usergroupService=getSecurityManager().loadUserGroupService(getFixtureId());usergroupStore=createStore(usergroupService);getSecurityManager().setActiveRoleService(roleService);
if("h2".equalsIgnoreCase(getFixtureId()))returnsuper.createTestData();returnnewLiveDbmsDataSecurity(getFixtureId());
if(selection.size()==0)return;dialog.setTitle(newParamResourceModel("confirmRemoval",this));//
ifthereissomethingtocancel,let'swarntheuseraboutwhat//couldgowrong,and
iftheuseraccepts,let'sdeletewhat'sneededdialog.showOkCancel(target,delegate=newGeoServerDialog.DialogDelegate(){protectedComponentgetContents(Stringid){//showaconfirmationpanelforalltheobjectswehavetoremovereturnremovePanel=newConfirmRemovalDataAccessRulePanel(id,selection){@OverrideprotectedIModel<String>canRemove(DataAccessRuledata){returnSelectionDataRuleRemovalLink.this.canRemove(data);
iftheselectionhasbeenclearedoutit'ssignadeletion//occurred,sorefreshthetable
if(rules.getSelection().size()==0){setEnabled(false);target.add(SelectionDataRuleRemovalLink.this);target.add(rules);
if(statusObj==null){statusObj=DEFAULT_EMBEDDED_BROKER_VALUE;
if(description.getAnnotation(RunTestSetup.class)!=null){try{doTearDownClass();
if(isQuietTests()){Logging.getLogger("org.geoserver").setLevel(Level.SEVERE);Logging.getLogger("org.vfny.geoserver").setLevel(Level.SEVERE);Logging.getLogger("org.geotools").setLevel(Level.SEVERE);
if(System.getProperty("org.geotools.referencing.forceXY")==null||!"http".equals(Hints.getSystemDefault(Hints.FORCE_AXIS_ORDER_HONORING))){System.setProperty("org.geotools.referencing.forceXY","true");Hints.putSystemDefault(Hints.FORCE_AXIS_ORDER_HONORING,"http");CRS.reset("all");
if(testData==null){test=this;testData=createTestData();testData.setUp();setUp((T)testData);
if(testSetupFrequency==null){testSetupFrequency=lookupTestSetupPolicy();
if(testSetupFrequency!=TestSetupFrequency.ONCE){doTearDownClass();
if(testSetup!=null){returntestSetup.run();
if(testData!=null){try{test.tearDown(testData);testData.tearDown();
if(qName.getPrefix()!=null){returnqName.getPrefix()+":"+qName.getLocalPart();
else{returnqName.getLocalPart();
if(o1.getWorkspace().equals(o2.getWorkspace())){returno1.getName().compareTo(o2.getName());
if(hasStoredAnyRole(rootObject)){//rolePalette.setEnabled(false);//rolePalette.add(newAttributeAppender("disabled",true,new//Model<String>("disabled"),""));//hasAnyBox.setDefaultModelObject(Boolean.TRUE);//
else{//rolePalette.setEnabled(true);//rolePalette.add(newAttributeAppender("enabled",true,new//Model<String>("enabled"),""));//hasAnyBox.setDefaultModelObject(Boolean.FALSE);//
if(isHasAnyRole()){result.add(GeoServerRole.ANY_ROLE);
else{result.addAll(getSelectedRoles());
if(role!=null)roles.add(role);
if(service==null||service.getId()==null||!service.getId().equalsIgnoreCase("wfs")){//notaWFSservicesowearenotinterestedinitreturnresponse;
if(!isGmlBased(responseMimeType)){//noaGMLbasedresponsereturnresponse;
if(gmlInfo==null||!gmlInfo.getMimeTypeToForce().isPresent()){//wedon'tneedtoforceanyspecificMIMEtypereturnresponse;
ifaMIMEtypeisGMLbased.*/privatebooleanisGmlBased(StringcandidateMimeType){
if(candidateMimeType==null){//unlikelysituationbutinthiswedon'tconsiderthisMIMEtypeaGMLonereturnfalse;
iftheMIMEtypecontainsGMLcandidateMimeType=candidateMimeType.toLowerCase();returncandidateMimeType.contains("gml");
if(info==null){thrownewNullArgumentException("Incomingobjectisnull");
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(this.getClass()+"isunabletosynchronizetheincomingevent:"+info);throwe;
ifno{@linkGetFeatureInfoOutputFormat}isconfiguredforthe*outputformatspecifiedin<code>request</code>*/privateGetFeatureInfoOutputFormatgetRequestedOutputFormat(GetFeatureInfoRequestrequest)throwsServiceException{StringrequestFormat=request.getInfoFormat();GetFeatureInfoOutputFormatformat=wms.getFeatureInfoOutputFormat(requestFormat);
if(format==null){format=defaultOutputFormat;
if(wms.isAllowedGetFeatureInfoFormat(format)==false){throwwms.unallowedGetFeatureInfoFormatException(requestFormat);
switch(list){case"available":LOGGER.fine(()->logMessage("GETavailableWMTSlayersfrom",workspaceName,storeName,null));returnnewAvailableResources(getAvailableLayersInternal(workspaceName,storeName,quietOnNotFound),"wmtsLayerName");case"configured":LOGGER.fine(()->logMessage("GETconfiguredWMTSlayersfrom",workspaceName,storeName,null));returnwrapList(getConfiguredLayersInternal(workspaceName,storeName,quietOnNotFound),WMTSLayerInfo.class);default:thrownewRestException("Unknownlisttype"+list,HttpStatus.NOT_IMPLEMENTED);
if(Objects.nonNull(storeName)){returnCollections.singleton(getStoreInternal(ns,storeName));
else{returncatalog.getStoresByWorkspace(ns.getPrefix(),WMTSStoreInfo.class);
if(Objects.isNull(workspaceName)){thrownewNullPointerException();
else{NamespaceInfons=catalog.getNamespaceByPrefix(workspaceName);
if(Objects.isNull(ns)){thrownewResourceNotFoundException("Couldnotfindworkspace"+workspaceName);
else{returnns;
if(Objects.isNull(storeName)){thrownewNullPointerException();
else{returncatalog.getStoreByName(ns.getPrefix(),storeName,WMTSStoreInfo.class);
if(Objects.isNull(layerName)){thrownewNullPointerException();
else
if(Objects.isNull(storeName)){layer=catalog.getResourceByName(ns,layerName,WMTSLayerInfo.class);
if(Objects.isNull(layer)){thrownewResourceNotFoundException("Nosuchcascadedwmts:"+workspaceName+","+layerName);
else{returnlayer;
else{WMTSStoreInfostore=getStoreInternal(ns,storeName);layer=catalog.getResourceByStore(store,layerName,WMTSLayerInfo.class);
if(Objects.isNull(layer)){thrownewResourceNotFoundException("Nosuchcascadedwmts:"+workspaceName+","+layerName);
else{returnlayer;
if(recurse){//byrecurseweclearoutallthelayersthatpublicthisresourcefor(LayerInfol:layers){catalog.remove(l);LOGGER.info("DELETEWMTSlayer"+l.getName());
else{
if(!layers.isEmpty()){thrownewRestException("wmtslayerreferencedbylayer(s)",HttpStatus.FORBIDDEN);
if(resource.getStore()!=null){
if(Objects.nonNull(storeName)&&!Objects.equals(storeName,resource.getStore().getName())){thrownewRestException("Expectedwmtsstore"+storeName+"butclientspecified"+resource.getStore().getName(),HttpStatus.FORBIDDEN);
else{store=getStoreInternal(ns,storeName);resource.setStore(store);
if(resource.getNamespace()!=null){
if(!workspaceName.equals(resource.getNamespace().getPrefix())){thrownewRestException("Expectedworkspace"+workspaceName+"butclientspecified"+resource.getNamespace().getPrefix(),HttpStatus.FORBIDDEN);
else{resource.setNamespace(catalog.getNamespaceByPrefix(workspaceName));
if(foundns!=null&&!foundns.getPrefix().equals(workspaceName)){LOGGER.warning("Namespace:"+ns.getPrefix()+"doesnotmatchworkspace:"+workspaceName+",overriding.");foundns=null;
if(foundns==null){//inferfromworkspaceresource.setNamespace(ns);
if(workspaceName==null||storeName==null||layerName==null){returnnull;
if(store==null){returnnull;
if(objinstanceofNamespaceInfo){NamespaceInfons=(NamespaceInfo)obj;converter.encodeLink("/namespaces/"+converter.encode(ns.getPrefix()),writer);
if(objinstanceofWMTSStoreInfo){WMTSStoreInfostore=(WMTSStoreInfo)obj;converter.encodeLink("/workspaces/"+converter.encode(store.getWorkspace().getName())+"/wmtsstores/"+converter.encode(store.getName()),writer);
if(super.canHandle(layer)){
if(myHandleableClasses==null){returntrue;
if(Class.forName(className).isInstance(((LayerInfo)layer).getResource())){returntrue;
if(res.getType()!=Type.UNDEFINED){assertThat(path+"directory",parent,is(directory()));
if(i<thread1Content.length){out1.write(thread1Content[i]);
if(i<thread2Content.length){out2.write(thread2Content[i]);
if(geometryType!=MULTIGEOMETRY){this.key("coordinates");
switch(geometryType){casePOINT:Pointpoint=(Point)geometry;Coordinatec=point.getCoordinate();writeCoordinate(c.x,c.y,c.z);break;caseLINESTRING:writeCoordinates(((LineString)geometry).getCoordinateSequence());break;caseMULTIPOINT:writeCoordinates(geometry.getCoordinates());break;casePOLYGON:writePolygon((Polygon)geometry);break;caseMULTILINESTRING:this.array();for(inti=0,n=geometry.getNumGeometries();i<n;i++){writeCoordinates(((LineString)geometry.getGeometryN(i)).getCoordinateSequence());
else{writeGeomCollection((GeometryCollection)geometry);
if(dim>2){writeCoordinate(coords.getX(i),coords.getY(i),coords.getOrdinate(i,2));
else{writeCoordinate(coords.getX(i),coords.getY(i));
if(axisOrder==CRS.AxisOrder.NORTH_EAST){roundedValue(y);roundedValue(x);
else{roundedValue(x);roundedValue(y);
if(!Double.isNaN(z)){roundedValue(z);
if(axisOrder==CRS.AxisOrder.NORTH_EAST){roundedValue(env.getMinY());roundedValue(env.getMinX());roundedValue(env.getMaxY());roundedValue(env.getMaxX());
else{roundedValue(env.getMinX());roundedValue(env.getMinY());roundedValue(env.getMaxX());roundedValue(env.getMaxY());
if(geometryinstanceofPoint){return"Point";
else
if(geometryinstanceofLineString){return"LineString";
else
if(geometryinstanceofPolygon){return"Polygon";
else
if(geometryinstanceofMultiPoint){return"MultiPoint";
else
if(geometryinstanceofMultiLineString){return"MultiLineString";
else
if(geometryinstanceofMultiPolygon){return"MultiPolygon";
else
if(geometryinstanceofGeometryCollection){return"GeometryCollection";
else{thrownewIllegalArgumentException("Unknowngeometrytype"+geometry.getClass());
if(geometryinstanceofPoint){//LOGGER.finest("foundpoint");returnPOINT;
else
if(geometryinstanceofLineString){//LOGGER.finest("foundlinestring");returnLINESTRING;
else
if(geometryinstanceofPolygon){//LOGGER.finest("foundpolygon");returnPOLYGON;
else
if(geometryinstanceofMultiPoint){//LOGGER.finest("foundmultiPoint");returnMULTIPOINT;
else
if(geometryinstanceofMultiLineString){returnMULTILINESTRING;
else
if(geometryinstanceofMultiPolygon){returnMULTIPOLYGON;
else
if(geometryinstanceofGeometryCollection){returnMULTIGEOMETRY;
else{thrownewIllegalArgumentException("Unabletodeterminegeometrytype"+geometry.getClass());
if(value==null){super.value(value);
else
if(valueinstanceofGeometry){this.writeGeom((Geometry)value);
else
if(valueinstanceofList){this.writeList((List)value);
else
if(valueinstanceofMap){this.writeMap((Map)value);
else{
if(valueinstanceofjava.util.Date||valueinstanceofCalendar){value=Converters.convert(value,String.class);
if(LOGGER.isLoggable(Level.FINEST)){//allowWFSresulttobeloggedfordebuggingpurposes//WFSresultcanbelarge,souseonlyfordebuggingByteArrayOutputStreamoutputStream=newByteArrayOutputStream();ByteStreams.copy(input,outputStream);streamBytes=outputStream.toByteArray();input=newByteArrayInputStream(streamBytes);
if(resultinstanceofFeatureCollectionType){FeatureCollectionTypefct=(FeatureCollectionType)result;returndecode(fct);
else{
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.log(Level.FINEST,"DecodingthefollowingWFSresponsedidnotresultinanobjectoftypeFeatureCollectionType:\n"+newString(streamBytes));
ifCDATAisusedor
if//it'saKVPparseitwillbeastringinstead
if(inputinstanceofString){Parserp=getParser(configuration);input=p.parse(newStringReader((String)input));
ifthecollectionneedsflipping
if(fc.getSchema().getGeometryDescriptor()!=null){CoordinateReferenceSystemcrs=getCollectionCRS(fc);
if(crs!=null){//doweneedtoforcethecrsontothecollection?CoordinateReferenceSystemnativeCrs=fc.getSchema().getGeometryDescriptor().getCoordinateReferenceSystem();
if(nativeCrs==null){//weneedcrsforcingfc=newForceCoordinateSystemFeatureResults(fc,crs,false);
if(code!=null){CoordinateReferenceSystemlonLatCrs=CRS.decode("EPSG:"+code,true);
if(!CRS.equalsIgnoreMetadata(crs,lonLatCrs)){//weneedaxisflippingfc=newReprojectingFeatureCollection(fc,lonLatCrs);
if(!BOUNDEDBY.equals(name)&&!METADATA.equals(name)){names.add(name);
if(!LOCATION.equals(name)&&adinstanceofGeometryDescriptor){alternateGeometry=true;
ifthereisanothergeometryweassume"location"isgoingtobeempty,//otherwisewe'regoingtogetalwaysanullgeometry
if(alternateGeometry){names.remove("location");
if(names.size()<original.getDescriptors().size()){String[]namesArray=names.toArray(newString[names.size()]);SimpleFeatureTypetarget=SimpleFeatureTypeBuilder.retype(original,namesArray);returnnewRetypingFeatureCollection(fc,target);
if(fc.getSchema().getCoordinateReferenceSystem()!=null){returnfc.getSchema().getCoordinateReferenceSystem();
if(gd!=null&&gd.getCoordinateReferenceSystem()!=null){featureCrs=gd.getCoordinateReferenceSystem();
if(f.getDefaultGeometry()!=null){Geometryg=(Geometry)f.getDefaultGeometry();
if(g.getUserData()instanceofCoordinateReferenceSystem){featureCrs=(CoordinateReferenceSystem)g.getUserData();
ifit'snew,useit,otherwise//checkthecollectiondoesnothavemixedcrs
if(featureCrs!=null){
if(crs==null){crs=featureCrs;
else
if(!CRS.equalsIgnoreMetadata(featureCrs,crs)){returnnull;
if(prop.getPropertyName().equals("title")){titleExists=true;
else
if(prop.getPropertyName().equals("prefixedName")){prefixedNameExists=true;
if(!(context.getService()instanceofWMSInfo)){returnnull;
if(Placemark.class.isAssignableFrom(featureClass)){returnnewPlacemarkStyleDecorator();
else{returnnull;
if(symbolizers.size()>0&&sf.getDefaultGeometry()!=null){//sortbypoint,text,lineandpolygonMap<Class,List<Symbolizer>>classified=classifySymbolizers(symbolizers);//
ifnopointsymbolizers,createadefaultoneList<Symbolizer>points=classified.get(PointSymbolizer.class);
if(points.size()==0){
if(context.isDescriptionEnabled()){setDefaultIconStyle(style,sf,context);
else{org.geotools.styling.StylewholeStyle=context.getCurrentLayer().getStyle();IconPropertiesproperties=IconPropertyExtractor.extractProperties(wholeStyle,sf);setIconStyle(style,wholeStyle,properties,context);
if(texts.size()==0){
if(context.isDescriptionEnabled()){setDefaultLabelStyle(style);
else{//theXMLschemaallowsonlyonetextstyle,followpainter'smodel//andsetthelastoneTextSymbolizerlastTextSymbolizer=(TextSymbolizer)texts.get(texts.size()-1);setLabelStyle(style,sf,lastTextSymbolizer);
if(lines.size()>0){LineSymbolizerlastLineSymbolizer=(LineSymbolizer)lines.get(lines.size()-1);setLineStyle(style,sf,lastLineSymbolizer.getStroke());
if(polygons.size()>0){//theXMLschemaallowsonlyonepolygonstyle,followpainter'smodel//andsetthelastonePolygonSymbolizerlastPolygonSymbolizer=(PolygonSymbolizer)polygons.get(polygons.size()-1);setPolygonStyle(style,sf,lastPolygonSymbolizer,forceOutiline);
if(sinstanceofPointSymbolizer){result.get(PointSymbolizer.class).add(s);
else
if(sinstanceofLineSymbolizer){result.get(LineSymbolizer.class).add(s);
else
if(sinstanceofPolygonSymbolizer){result.get(PolygonSymbolizer.class).add(s);
else
if(sinstanceofTextSymbolizer){result.get(TextSymbolizer.class).add(s);
else{thrownewIllegalArgumentException("Unrecognizedsymbolizertype:"+s);
iflineorpolygonbooleanline=feature.getDefaultGeometry()!=null&&(feature.getDefaultGeometry()instanceofLineString||feature.getDefaultGeometry()instanceofMultiLineString);booleanpoly=feature.getDefaultGeometry()!=null&&(feature.getDefaultGeometry()instanceofPolygon||feature.getDefaultGeometry()instanceofMultiPolygon);//Finalpre-flightcheck
if(!line&&!poly){LOGGER.log(Level.FINER,"UnexpectedlyenteredencodeDefaultIconStyle()"+"withsomethingthatdoesnothaveamultipointgeometry.");return;
iftheyaskforattributes,sincewe'llhavealabel
if(context.isDescriptionEnabled()){is.setColor("00ffffff");
iflineorpolygonscalethelabel
if(line||poly){is.setScale(0.4);
if(context.isLiveIcons()||properties.isExternal()){setLiveIconStyle(style,sld,properties,context);
else{setInlineIconStyle(style,sld,properties,context);
if(!iconStyles.containsKey(name)){finalorg.geotools.styling.StyleinjectedStyle=IconPropertyInjector.injectProperties(sld,properties.getProperties());iconStyles.put(name,injectedStyle);
if(properties.getHeading()!=null){is.setHeading(0.0);
if(scale!=null){is.setScale(scale);
if(opacity!=null){is.setColor(colorToHex(Color.WHITE,opacity));
if(scale!=null){is.setScale(scale);
if(heading!=null){is.setHeading(heading);
if(ws!=null)wsName=ws.getName();Iconicon=is.createAndSetIcon();icon.setHref(properties.href(context.getMapContent().getRequest().getBaseUrl(),wsName,sld.getName()));
if(font!=null&&font.getSize()!=null){//wemakethescaleproportionaltothenormalfontsizedoublesize=font.getSize().evaluate(feature,Double.class);scale=Math.round(size/Font.DEFAULT_FONTSIZE*100)/100.0;
if(fill!=null){Doubleopacity=fill.getOpacity().evaluate(feature,Double.class);
if(opacity==null||Double.isNaN(opacity)){opacity=1.0;
else{ls.setColor("ffffffff");
ifstrokespecifiedaddlinestyleaswell(ithastobebeforethefill,otherwise//we'llgetawhitefilling...)
if(symbolizer.getStroke()!=null){setLineStyle(style,feature,symbolizer.getStroke());
if(fill!=null){//getopacityDoubleopacity=fill.getOpacity().evaluate(feature,Double.class);
if(opacity==null||Double.isNaN(opacity)){opacity=1.0;
else{//makeittransparentps.setColor("00aaaaaa");
if(symbolizer.getStroke()!=null||forceOutline){ps.setOutline(true);
if(stroke!=null){//opacityDoubleopacity=stroke.getOpacity().evaluate(feature,Double.class);
if(opacity==null||Double.isNaN(opacity)){opacity=1.0;
if(sc!=null){color=(Color)sc.evaluate(feature,Color.class);
if(color==null){color=Color.DARK_GRAY;
if(sw!=null){width=sw.evaluate(feature,Double.class);
if(width==null){width=1d;
else{//defaultls.setColor("ffaaaaaa");ls.setWidth(1);
if(sinstanceofExternalGraphic){return(ExternalGraphic)s;
if(strLocation==null)returnnull;//parsetheeventual${cqlExpression}embeddedintheURLExpressionlocation;try{location=ExpressionExtractor.extractCqlExpressions(strLocation);
if(LOGGER.isLoggable(Level.SEVERE))LOGGER.log(Level.SEVERE,"Couldnotparsecqlexpressionsoutof"+strLocation,e);location=ff.literal(strLocation);
if(prelim.length()<2){prelim="0"+prelim;
if(!p.getValidationErrors().isEmpty()){for(Iteratore=p.getValidationErrors().iterator();e.hasNext();){SAXParseExceptionex=(SAXParseException)e.next();System.out.println(ex.getLineNumber()+","+ex.getColumnNumber()+"-"+ex.toString());
if(locationinstanceofSpringResourceAdaptor){configFile=((SpringResourceAdaptor)location).getResource();
if(configFile!=null&&copyOutTemplate){try(OutputStreamfout=configFile.out()){props.store(fout,comments);fout.flush();
if(localProperties!=null){for(Propertiesprops:localProperties){loadProperties(props);
ifdesired.*/publicclassResourceStoreFactoryimplementsFactoryBean<ResourceStore>,ApplicationContextAware{finalLoggerLOGGER=Logging.getLogger("org.geoserver.platform");privateApplicationContextapplicationContext;@OverridepublicResourceStoregetObject()throwsException{ResourceStoreresourceStore=null;try{resourceStore=(ResourceStore)GeoServerExtensions.bean("resourceStoreImpl",applicationContext);
if(resourceStore==null){resourceStore=(ResourceStore)GeoServerExtensions.bean("dataDirectoryResourceStore",applicationContext);
if(delay>0)
if(timeout>delay){try{Thread.sleep(delay);
else{returnfalse;
iftheuserhasauthenticated.**@authorJustinDeoliveira,OpenGeo*/publicclassAuthenticatedComponentAuthorizerimplementsComponentAuthorizer{@OverridepublicbooleanisAccessAllowed(Class<?>componentClass,Authenticationauthentication){
if(GeoServerSecurityFilterChainProxy.isSecurityEnabledForCurrentRequest()==false)returntrue;returnauthentication!=null&&authentication.isAuthenticated();}}
ifuserFilterisdefined)*/protectedStringuserNameAttribute="uid";/**lookupuserfordn*/protectedbooleanlookupUserForDn=false;@OverridepublicvoidinitializeFromConfig(SecurityNamedServiceConfigconfig)throwsIOException{super.initializeFromConfig(config);LDAPBaseSecurityServiceConfigldapConfig=(LDAPBaseSecurityServiceConfig)config;ldapContext=LDAPUtils.createLdapContext(ldapConfig);
if(ldapConfig.isBindBeforeGroupSearch()){//authenticatebeforeLDAPsearchesuser=ldapConfig.getUser();password=ldapConfig.getPassword();template=newBindingLdapTemplate(ldapContext);
else{template=newSpringSecurityLdapTemplate(ldapContext);
if(!isEmpty(ldapConfig.getGroupSearchBase())){groupSearchBase=ldapConfig.getGroupSearchBase();
if(!isEmpty(ldapConfig.getUserSearchBase())){userSearchBase=ldapConfig.getUserSearchBase();
if(!isEmpty(ldapConfig.getGroupSearchFilter())){groupMembershipFilter=ldapConfig.getGroupSearchFilter();Matcherm=lookForMembershipAttribute.matcher(groupMembershipFilter);
if(m.matches()){
if(isEmpty(ldapConfig.getGroupMembershipAttribute())){groupMembershipAttribute=m.group(1);
if(!isEmpty(ldapConfig.getGroupMembershipAttribute())){groupMembershipAttribute=ldapConfig.getGroupMembershipAttribute();
if(isEmpty(ldapConfig.getGroupSearchFilter())){groupMembershipFilter=groupMembershipAttribute+"={0}";
if(!isEmpty(ldapConfig.getGroupFilter())){groupNameFilter=ldapConfig.getGroupFilter();
if(isEmpty(ldapConfig.getGroupNameAttribute())){Matcherm=lookForMembershipAttribute.matcher(groupNameFilter);
if(m.matches()){groupNameAttribute=m.group(1);
if(!isEmpty(ldapConfig.getGroupNameAttribute())){groupNameAttribute=ldapConfig.getGroupNameAttribute();
if(isEmpty(ldapConfig.getGroupFilter())){groupNameFilter=groupNameAttribute+"={0}";
if(!isEmpty(ldapConfig.getAllGroupsSearchFilter())){allGroupsSearchFilter=ldapConfig.getAllGroupsSearchFilter();
else{allGroupsSearchFilter=groupNameAttribute+"=*";
if(!isEmpty(ldapConfig.getUserFilter())){this.userNameFilter=ldapConfig.getUserFilter();Matcherm=lookForMembershipAttribute.matcher(userNameFilter);
if(m.matches()){
if(isEmpty(ldapConfig.getUserNameAttribute())){userNameAttribute=m.group(1);
if(!isEmpty(ldapConfig.getUserNameAttribute())){userNameAttribute=ldapConfig.getUserNameAttribute();
if(isEmpty(ldapConfig.getUserFilter())){userNameFilter=userNameAttribute+"={0}";
if(!isEmpty(ldapConfig.getAllUsersSearchFilter())){allUsersSearchFilter=ldapConfig.getAllUsersSearchFilter();
else{allUsersSearchFilter=userNameAttribute+"=*";
ifconfiguredtodoso,andthencallthegivencallbackon*authenticatedcontext,orsimplycallthegivencallback
ifnoauthenticationisneeded.**@paramcallback*/protectedvoidauthenticateIfNeeded(AuthenticatedLdapEntryContextCallbackcallback){
if(user!=null&&password!=null){template.authenticate(DistinguishedName.EMPTY_PATH,user,password,callback);
else{callback.executeWithContext(null,null);
if(lookupUserForDn){authenticateIfNeeded(newAuthenticatedLdapEntryContextCallback(){@OverridepublicvoidexecuteWithContext(DirContextctx,LdapEntryIdentificationldapEntryIdentification){DirContextOperationsobj=(DirContextOperations)LDAPUtils.getLdapTemplateInContext(ctx,template).lookup(user);Stringname=obj.getObjectAttribute(userNameAttribute).toString();Matcherm=userNamePattern.matcher(name);
if(m.matches()){name=m.group(1);
if(lookupUserForDn){authenticateIfNeeded(newAuthenticatedLdapEntryContextCallback(){@OverridepublicvoidexecuteWithContext(DirContextctx,LdapEntryIdentificationldapEntryIdentification){try{dn.set(LDAPUtils.getLdapTemplateInContext(ctx,template).searchForSingleEntry("",userNameFilter,newString[]{username}).getDn().toString());
if(einstanceofEndRequest||einstanceofPaintShapeRequest){returnsuper.add(e);
else{returntrue;
if(storeId==null){returnnewArrayList<Resource>();
else
if(cachedItems==null){cachedItems=getItemsInternal();
if(storeinstanceofDataStoreInfo){DataStoreInfodstore=(DataStoreInfo)store;DataStoreInfoexpandedStore=getCatalog().getResourcePool().clone(dstore,true);//collectallthetypenamesandturnthemintoresources//forthemomentweuselocalnamesasdatastoresarenotreturning//namespacequalifiedNameImplList<Name>names=expandedStore.getDataStore(null).getNames();for(Namename:names){FeatureTypeInfofti=getCatalog().getFeatureTypeByDataStore(expandedStore,name.getLocalPart());//skipviews,wecannothavetwolayersusethesamefeaturetypeinfo,asthe//underlyingdefinitionisattachedtothefeaturetypeinfoitself
if(fti==null||fti.getMetadata().get(FeatureTypeInfo.JDBC_VIRTUAL_TABLE)==null){resources.put(name.getLocalPart(),newResource(name));
else
if(storeinstanceofCoverageStoreInfo){CoverageStoreInfocstore=(CoverageStoreInfo)store;CoverageStoreInfoexpandedStore=getCatalog().getResourcePool().clone(cstore,true);NamespaceInfons=getCatalog().getNamespaceByPrefix(expandedStore.getWorkspace().getName());GridCoverageReaderreader=expandedStore.getGridCoverageReader(null,null);try{String[]names=reader.getGridCoverageNames();for(Stringname:names){Namequalified=newNameImpl(ns.getURI(),name);Resourceresource=newResource(qualified);resource.setMultiCoverageReader(true);resources.put(name,resource);
else
if(storeinstanceofWMTSStoreInfo){WMTSStoreInfowmsInfo=(WMTSStoreInfo)store;WMTSStoreInfoexpandedStore=(WMTSStoreInfo)getCatalog().getResourcePool().clone(wmsInfo,true);CatalogBuilderbuilder=newCatalogBuilder(getCatalog());builder.setStore(store);WebMapTileServerwebMapTileServer=expandedStore.getWebMapTileServer(null);WMTSCapabilitiescapabilities=webMapTileServer.getCapabilities();List<WMTSLayer>layers=capabilities.getLayerList();for(Layerl:layers){
if(l.getName()==null){continue;
else
if(storeinstanceofWMSStoreInfo){WMSStoreInfowmsInfo=(WMSStoreInfo)store;WMSStoreInfoexpandedStore=getCatalog().getResourcePool().clone(wmsInfo,true);CatalogBuilderbuilder=newCatalogBuilder(getCatalog());builder.setStore(store);List<Layer>layers=expandedStore.getWebMapServer(null).getCapabilities().getLayerList();for(Layerl:layers){
if(l.getName()==null){continue;
if(typeinstanceofCoverageInfo){CoverageInfoci=(CoverageInfo)type;
if(ci.getNativeCoverageName()!=null){resource=resources.get(ci.getNativeCoverageName());
else{resource=resources.get(type.getNativeName());
else{resource=resources.get(type.getNativeName());
if(resource!=null){resource.setPublished(true);
if(showPublished)returnresources;List<Resource>unconfigured=newArrayList<Resource>();for(Resourceresource:resources){
if(!resource.isPublished())unconfigured.add(resource);
if(wsi==null){getSession().error(newParamResourceModel("WorkspaceEditPage.notFound",this,wsName).getString());doReturn(WorkspacePage.class);return;
if(ns==null){//unfortunatelythismayhappen
ifthenamespaceassociatedtotheworkspacewas//deletedornevercreatedthrownewRuntimeException(String.format("Workspace'%s'associatednamespacedoesn'texists.",ws.getName()));
if(defaultWs){catalog.setDefaultWorkspace(workspaceInfo);
if(set.enabled){
if(set.modelinstanceofNewSettingsModel){geoServer.add(set.model.getObject());
else{geoServer.save(set.model.getObject());
else{//remove
ifnecessary
if(set.modelinstanceofExistingSettingsModel){geoServer.remove(set.model.getObject());
if(s.enabled){
if(s.modelinstanceofExistingServiceModel){//nothingtodo,servicehasalreadybeenaddedcontinue;
else{//remove
ifnecessary
if(s.modelinstanceofExistingServiceModel){//meanstheyareremovinganexistingservice,lookitupandremovegeoServer.remove(s.model.getObject());
if(info==null){GeoServergs=GeoServerApplication.get().getGeoServer();info=gs.getFactory().createSettings();//initializefromglobalsettingsSettingsInfoglobal=gs.getGlobal().getSettings();//hack,weneedtocopyoutcompositeobjectsseparatelytogetaroundproxying//madnessContactInfocontact=gs.getFactory().createContact();OwsUtils.copy(global.getContact(),contact,ContactInfo.class);OwsUtils.copy(global,info,SettingsInfo.class);info.setContact(contact);info.setWorkspace(wsModel.getObject());
if(service==null){service=create();
if(s.modelinstanceofExistingServiceModel){//servicethathasalreadybeenadded,PageParameterspp=newPageParameters().add("workspace",wsModel.getObject().getName());try{page=s.adminPage.getComponentClass().getConstructor(PageParameters.class).newInstance(pp);
else{//servicethathasyettobeaddedtry{page=s.adminPage.getComponentClass().getConstructor(s.adminPage.getServiceClass()).newInstance(s.model.getObject());
if(info.getIcon()!=null){image=newImage("link.icon",newPackageResourceReference(info.getComponentClass(),info.getIcon()));
else{image=newImage("link.icon",newPackageResourceReference(GeoServerBasePage.class,"img/icons/silk/wrench.png"));
ifserviceisdisabled,createaplaceholdermodeltoholdanewlycreatedone,//otherwisecreatealivemodeltotheexistingservice@SuppressWarnings("unchecked")Class<ServiceInfo>serviceClass=(Class<ServiceInfo>)page.getServiceClass();service.model=!service.enabled?newNewServiceModel(wsModel,serviceClass):newExistingServiceModel(wsModel,serviceClass);services.add(service);
if(status==RepeatStatus.CONTINUABLE){continuable.add(handler);
if(continuable.isEmpty()){//nocontinuablejobs,wearedonereturnRepeatStatus.FINISHED;
ifwehaveanypendingcontinuablejobsObjectvalue=jobExecution.getExecutionContext().get(GENERIC_CONTINUABLE_HANDLERS_KEY);
if(value==null||!List.class.isAssignableFrom(value.getClass())){//nopendingcontinuablehandlers,usethenormalhandlersreturngetAllHandlers();
if(values.isEmpty()||!GenericTaskletHandler.class.isAssignableFrom(values.get(0).getClass())){//notwhatweexpect,usethenormalhandlersreturngetAllHandlers();
if(item.getProperties().size()==0)returnBoolean.FALSE;
elsereturnBoolean.TRUE;
if(userGroupServiceName!=null)service=getApplication().getSecurityManager().loadUserGroupService(userGroupServiceName);
if(service==null)users=newTreeSet<GeoServerUser>();
elseusers=service.getUsers();
if(storesinstanceofJSONArray){assertEquals(catalog.getStoresByWorkspace("sf",WMSStoreInfo.class).size(),((JSONArray)stores).size());
else{assertEquals(1,catalog.getStoresByWorkspace("sf",WMSStoreInfo.class).size());
if(!service.getVersions().contains(OSEOInfo.VERSION_1_0_0)){service.getVersions().add(OSEOInfo.VERSION_1_0_0);
if(previewImage==null){previewImage=createPreviewImage();
ifwearecomparing*GeoServerAwithGeoServerBand
ifinfoAisNULLitmeansthatinfoBdoesn'texistsin*GeoServerA.*/publicfinalclassInfoDiff{privatefinalInfoinfoA;privatefinalInfoinfoB;publicInfoDiff(InfoinfoA,InfoinfoB){
if(infoA==null&&infoB==null){//
ifbothobjectareNULLitmeansthatthereisnodifferencethrownewRuntimeException("BothinfosareNULL.");
if(getNamespace().equals(getExtension())){directory=wps;
else{directory=newFile(wps,getNamespace());
if(u!=null){FileUtils.copyURLToFile(u,script);returnscript;
if(fp.getName().getLocalPart().equals("buffer")){assertEquals("*",validatedLabel.getDefaultModelObject());
else{assertEquals("",validatedLabel.getDefaultModelObject());
if(pgi.getFactoryClass().equals(GeometryProcessFactory.class)){returnpgi;
if(ascending){returnresult;
else{returnresult*-1;
if(id1==null){
if(id2==null){return0;
else{return-1;
else
if(id2==null){return1;
else{returnid1.compareTo(id2);
if(this.getXp()==null){setXp(this.xstream.getXStream());
if(!getOutputState().isInitialized()){thrownewWriterNotOpenException("Writermustbeopenbeforeitcanbewrittento");
if(logger.isDebugEnabled()){logger.debug("Writingtoflatfilewith"+items.size()+"items.");
if(items.size()>0){lines.append("<items>\n");
if(items.size()>0){lines.append("</items>\n");
if(append){shouldDeleteIfExists=false;
ifitalreadyexists,otherwiseit*willbecreated.Defaultstotrue,sonoappendingexceptonrestart.Ifsettofalseand*{@link#setAppendAllowed(boolean)appendAllowed}isalsofalsethentherewillbean*exceptionwhenthestreamisopenedtopreventexistingdatabeingpotentiallycorrupted.**@paramshouldDeleteIfExiststheflagvaluetoset*/publicvoidsetShouldDeleteIfExists(booleanshouldDeleteIfExists){this.shouldDeleteIfExists=shouldDeleteIfExists;
ifitalreadyexists.Ifthisflag*issetthentheflag{@link#setShouldDeleteIfExists(boolean)shouldDeleteIfExists}is*automaticallysettofalse,sothatflagshouldnotbesetexplicitly.Defaultsvalueis*false.**@paramappendtheflagvaluetoset*/publicvoidsetAppendAllowed(booleanappend){this.append=append;//this.shouldDeleteIfExists=false;
ifatransactionisactive.*Defaultstotrue.*/publicvoidsetTransactional(booleantransactional){this.transactional=transactional;
if(!getOutputState().isInitialized()){try{doOpen(executionContext);
if(executionContext.containsKey(getExecutionContextKey(RESTART_DATA_NAME))){outputState.restoreFrom(executionContext);
if(state==null){thrownewItemStreamException("ItemStreamnotopenoralreadyclosed.");
if(saveState){try{executionContext.putLong(getExecutionContextKey(RESTART_DATA_NAME),state.position());
if(state!=null){state.close();state=null;
if(state==null){Filefile;try{file=resource.getFile();
if(fileChannel==null){return0;
if(transactional){pos+=((TransactionAwareBufferedWriter)outputBufferedWriter).getBufferSize();
if(shouldDeleteIfEmpty&&linesWritten==0){//previousexecutiondeletedtheoutputfilebecausenoitemswerewrittenrestarted=*false;lastMarkedByteOffsetPosition=0;
else{restarted=true;
if(outputBufferedWriter!=null){outputBufferedWriter.close();
if(!transactional){closeStream();
if(fileChannel!=null){fileChannel.close();
if(os!=null){os.close();
if(!initialized){initializeBufferedWriter();
if(append){//BuginIOlibrary?Thisdoesn'twork...//lastMarkedByteOffsetPosition=fileChannel.position();
if(file.length()>0){appending=true;//Don'twritetheheadersagain
if(restarted){checkFileSize();truncate();
if(transactional){TransactionAwareBufferedWriterwriter=newTransactionAwareBufferedWriter(channel,newRunnable(){@Overridepublicvoidrun(){closeStream();
else{Writerwriter=newBufferedWriter(Channels.newWriter(fileChannel,encoding)){@Overridepublicvoidflush()throwsIOException{super.flush();
if(forceSync){channel.force(false);
ifthereisanIOproblem*/privatevoidcheckFileSize()throwsIOException{longsize=-1;outputBufferedWriter.flush();size=fileChannel.size();
if(size<lastMarkedByteOffsetPosition){thrownewItemStreamException("Currentfilesizeissmallerthansizeatlastcommit");
if(item.getSourceTypes()==null||item.getSourceTypes().size()==0){return"";
else{StringBuildersb=newStringBuilder();for(SourceTypest:item.getSourceTypes()){sb.append(st.getStoreName().getLocalPart()+"/"+st.getTypeName());sb.append(",");
if(environment!=null){this.environment.putAll(environment);
if(toolFormatParameter!=null){cmd.add(toolFormatParameter);cmd.add(format.getToolFormat());
if(format.getOptions()!=null){for(Stringoption:format.getOptions()){cmd.add(option);
if(exitCode!=0)thrownewIOException(executable+"didnotterminatesuccessfully,exitcode"+exitCode+".Wastryingtorun:"+cmd+"\nResultedin:\n"+sb);//outputmaybeadirectory,handlethatcasegracefullyFileoutput=newFile(outputDirectory,outFileName);
if(output.isDirectory()){output=newFile(output,outFileName);
if(format.getFileExtension()!=null)outFileName+=format.getFileExtension();
if(isInputFirst()){cmd.add(inputData.getAbsolutePath());cmd.add(newFile(outputDirectory,outFileName).getAbsolutePath());
else{cmd.add(newFile(outputDirectory,outFileName).getAbsolutePath());cmd.add(inputData.getAbsolutePath());
if(crs!=null){//wedon'tuseanEPSGcodesincethereisnoguaranteewe'llbeabletoreverse//engineerone.UsingWKTalsoensurestheEPSGparamssuchastheTOWGS84onesare//notlostintheconversion//Wealsowritetoafilebecausesomeoperatingsystemscannottakeargumentswith//quotesandspacesinside(and/orProcessBuilderisnotgoodenoughtoescapethem)crsFile=File.createTempFile("srs","wkt",parentDir);Strings=crs.toWKT();s=s.replaceAll("\n\r","").replaceAll("","");FileUtils.writeStringToFile(crsFile,s);
ifanexceptionisthrownduring*commandexecution.**<p>Defaultimplementationdoesnothingatall.Maybeimplementedbysubclassestodosome*clean-upwork.**@paramexitCodetheexitcodeoftheinvokedcommand.Usually,0indicatesnormaltermination*@throwsIOException*/protectedvoidonAfterRun(intexitCode)throwsIOException{//defaultimplementationdoesnothing
if(environment!=null)builder.environment().putAll(environment);builder.redirectErrorStream(true);Processp=builder.start();BufferedReaderreader=newBufferedReader(newInputStreamReader(p.getInputStream()));Stringline=null;while((line=reader.readLine())!=null){
if(sb!=null){sb.append("\n");sb.append(line);
if(!(context.getService()instanceofWMSInfo)){returnnull;
if(Placemark.class.isAssignableFrom(featureClass)&&context.isDescriptionEnabled()){returnnewPlacemarkDescriptionDecorator();
else{returnnull;
if(description!=null){pm.setDescription(description);
if*available,Lexicographicallyotherwise**@authorAndreaAime-GeoSolutions*/publicclassLinkFeatureComparatorimplementsComparator<SimpleFeature>{publicstaticfinalLinkFeatureComparatorINSTANCE=newLinkFeatureComparator();privateLinkFeatureComparator(){};staticfinalComparator<String>STRING_COMPARATOR=newNullSafeComparator<String>(newComparableComparator<>(),true);@Overridepublicintcompare(SimpleFeaturef1,SimpleFeaturef2){Stringoff1=(String)f1.getAttribute("offering");Stringcode1=(String)f1.getAttribute("code");Stringcode2=(String)f2.getAttribute("code");//orderbythelistofoperationsintheservice
ifpossible
if(off1!=null){Serviceservice=getServiceFromOffering(off1);
if(service!=null){intidx1=service.getOperations().indexOf(code1);intidx2=service.getOperations().indexOf(code2);
if(idx1==-1){returnidx2==-1?STRING_COMPARATOR.compare(code1,code2):-1;
else{returnidx1-idx2;
if(idx<0&&idx>=off1.length()){returnnull;
if(serviceName.equalsIgnoreCase(service.getId())){returnservice;
if(i<cr.length-1){xml+="";
if(i<cr.length-1){xml+="";
if(i<cr.length-1){xml+="";
if(writeQuery==Query.ALL){((SimpleFeatureStore)storeDelegate).modifyFeatures(names,values,filter);
else
if(writeQuery.getFilter()==Filter.EXCLUDE||writeQuery.getPropertyNames()==Query.NO_NAMES){throwunsupportedOperation();
if(writeQuery.getPropertyNames()==Query.ALL_NAMES){//itwasjustamatteroffiltering.((SimpleFeatureStore)storeDelegate).modifyFeatures(names,values,mixed.getFilter());
else{//getthewritableattributesetSet<String>queryNames=newHashSet<String>(Arrays.asList(writeQuery.getPropertyNames()));//checktheupdatefieldsfor(inti=0;i<names.length;i++){
if(!queryNames.contains(names[i])){StringtypeName=getSchema().getName().getLocalPart();
if(policy.getResponse()==org.geoserver.security.Response.CHALLENGE){throwSecureCatalogImpl.unauthorizedAccess(typeName);
else{thrownewUnsupportedOperationException("Tryingtowriteonthewriteprotectedattribute"+names[i]);
if(batch!=null){dao.delete(batch);
if(config!=null){dao.delete(config);
if(originalName.equals(MockData.BUILDINGS.getLocalPart()))returnRENAMED;
elsereturnsuper.transformFeatureTypeName(originalName);
if(value==null&&mandatory){thrownewServiceException(String.format("Mandatory'%s'parameterismissing.",parameterName));
if(map.containsKey(USERNAME_KEY)){returnnewUsernamePasswordAuthenticationToken(map.get(USERNAME_KEY),"N/A",null);
if(p==null){p=catalog.getLayerByName(namedLayer.getName());
if(p==null){validationErrors.add(newException("Nolayerorlayergroupnamed'"+namedLayer.getName()+"'foundinthecatalog"));
if(s==null){validationErrors.add(newException("Nostylenamed'"+namedStyle.getName()+"'foundinthecatalog"));
if(global==null){returnnull;
if(s.getWorkspace().equals(workspace)){returnModificationProxy.create(s,SettingsInfo.class);
if(logging==null){returnnull;
if(id.equals(si.getId())){returnModificationProxy.create((T)si,clazz);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Couldnotlocateserviceoftype"+clazz+"andid'"+id+"',availableserviceswere"+services);
if(global!=null)global.dispose();
if(settings!=null)settings.clear();
if(services!=null)services.clear();
if(global.getMetadata()==null){global.setMetadata(newMetadataMap());
if(global.getClientProperties()==null){global.setClientProperties(newHashMap<Object,Object>());
if(global.getCoverageAccess()==null){global.setCoverageAccess(newCoverageAccessInfoImpl());
if(clazz.isAssignableFrom(si.getClass())&&wsEquals(workspace,si.getWorkspace())){returnModificationProxy.create((T)si,clazz);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Couldnotlocateserviceoftype"+clazz+"inworkspace"+workspace+",availableserviceswere"+services);
if(name.equals(si.getName())&&wsEquals(workspace,si.getWorkspace())){returnModificationProxy.create((T)si,clazz);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Couldnotlocateserviceoftype"+clazz+"inworkspace"+workspace+"andname'"+name+"',availableserviceswere"+services);
if(wsEquals(workspace,si.getWorkspace())){list.add(si);
if(ws1==null){returnws2==null;
if(OwsUtils.get(o,"id")==null){Stringuid=newUID().toString();OwsUtils.set(o,"id",o.getClass().getSimpleName()+"-"+uid);
if(serializer.name.equals(nodeName)){try{encoder=serializer.clazz.newInstance();encoder=(NotificationEncoder)context.convertAnother(encoder,serializer.clazz);break;
if(inputStream.available()==0){Utils.debug(LOGGER,"Rulesfilesseemstobeempty.");returnnewArrayList<>();
if(rules.get(i).getId().equals(rule.getId())){rules.set(i,rule);exists=true;
if(!exists){rules.add(rule);
if(value!=null){output.writeAttribute(name,value.toString());
if(!qName.equalsIgnoreCase("rule")){return;
if(attributeValue==null){Utils.debug(LOGGER,"Ruleattribute%sisNULL.",attributeName);return;
if(source==null){thrownewIOException("Cannotreadfromnull");
if(sourceinstanceofString){Stringpath=(String)source;GeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);Filef=loader.url(path);URLurl=null;
if(f!=null&&f.exists()){url=f.toURI().toURL();
else{url=newURL(path);
if(KMLRawReader.ReadType.SCHEMA_AND_FEATURES.equals(readType)){
if(featureType==null){parser=newPullParser(newKMLConfiguration(),inputStream,KML.Placemark,KML.Schema);
else{parser=newPullParser(newKMLConfiguration(),inputStream,pullParserArgs(featureTypeSchemaNames(featureType),KML.Placemark,KML.Schema));
else
if(KMLRawReader.ReadType.FEATURES.equals(readType)){
if(featureType==null){parser=newPullParser(newKMLConfiguration(),inputStream,KML.Placemark);
else{parser=newPullParser(newKMLConfiguration(),inputStream,pullParserArgs(featureTypeSchemaNames(featureType),KML.Placemark));
else{thrownewIllegalArgumentException("Unknownparsereadtype:"+readType.toString());
if(userData.containsKey("schemanames")){List<String>names=(List<String>)userData.get("schemanames");List<QName>qnames=newArrayList<QName>(names.size());for(Stringname:names){qnames.add(newQName(name));
if(next!=null){returntrue;
if(next!=null){Objectresult=next;next=null;returnresult;
if(feature==null){thrownewNoSuchElementException();
if(property==RulesModel.EDIT_BUTTON){returnnewEditButtonPanel(id,itemModel.getObject());
if(property==RulesModel.ACTIVATE_BUTTON){returnnewActivateButtonPanel(id,itemModel.getObject());
if(rulesPanel.getSelection().isEmpty()){output.setModelObject("NORULESSELECTED!");return;
if(urlTransform.haveChanged()){outputText=urlTransform.toString();
else{outputText="NORULESAPPLIED!";
if(node.hasAttribute("outputFormat")){describeFeatureType.setOutputFormat((String)node.getAttributeValue("outputFormat"));
if(MockData.CITE_PREFIX.equals(rule.getRoot())&&MockData.BRIDGES.getLocalPart().equals(rule.getLayer()))returnrule;
if(disposal=="backgroundColor"){disposal="restoreToBackgroundColor";
else
if(disposal=="previous"){disposal="restoreToPrevious";
if("NETSCAPE".equals(node.getAttribute("applicationID"))&&"2.0".equals(node.getAttribute("authenticationCode"))){found=true;byte[]flags=(byte[])node.getUserObject();
if(loopContinously){assertArrayEquals(newbyte[]{0x1,0x0,0x0},flags);
else{assertArrayEquals(newbyte[]{0x1,0x1,0x0},flags);
if(!found){fail("Couldnotfindcustommetadatanodecontainingtheloopcontrolextension");
ifoneisnotsupplied*/privatestaticfinalStringDEFAULT_MAP_FORMAT="image/png";/**WMSServiceconfiguration**/protectedfinalWMSwms;privatebooleanpalleteSupported=true;privatebooleantransparencySupported=true;/**Thefileextension(minusthe.)*/privateStringextension=null;/**Theknownproducercapabilities*/privatefinalMap<String,MapProducerCapabilities>capabilities=newHashMap<String,MapProducerCapabilities>();/***/publicRenderedImageMapOutputFormat(WMSwms){this(DEFAULT_MAP_FORMAT,wms);
if(response.getOutputFormats().contains(outFormat)){MapProducerCapabilitiescap=response.getCapabilities(outFormat);
if(cap!=null){capabilities.put(outFormat,cap);
if{@codetiled==true}.**@parammapContent*@paramtiledIndicateswhethermetatilingisactivatedforthismapproducer.*/publicRenderedImageMapproduceMap(finalWMSMapContentmapContent,finalbooleantiled)throwsServiceException{RectanglepaintArea=newRectangle(0,0,mapContent.getMapWidth(),mapContent.getMapHeight());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("settingup"+paintArea.width+"x"+paintArea.height+"image");
if(antialias!=null)antialias=antialias.toUpperCase();//figureoutapaletteforbufferedimagecreationIndexColorModelpotentialPalette=null;finalbooleantransparent=mapContent.isTransparent()&&isTransparencySupported();finalColorbgColor=mapContent.getBgColor();
if(AA_NONE.equals(antialias)){potentialPalette=mapContent.getPalette();
else
if(AA_NONE.equals(antialias)){PaletteExtractorpe=newPaletteExtractor(transparent?null:bgColor);List<Layer>layers=mapContent.layers();for(inti=0;i<layers.size();i++){pe.visit(layers.get(i).getStyle());
if(!pe.canComputePalette())break;
if(pe.canComputePalette())potentialPalette=pe.getPalette();
ifso,throwaserviceexceptionlongmaxMemory=wms.getMaxRequestMemory()*KB;//...baseimagememorylongmemory=getDrawingSurfaceMemoryUse(paintArea.width,paintArea.height,palette,transparent);//..useafakestreamingrenderertoevaluatetheextrabackbuffersusedwhenrendering//multiplefeatureTypeStylesagainstthesamelayerStreamingRenderertestRenderer=buildRenderer();testRenderer.setMapContent(mapContent);memory+=testRenderer.getMaxBackBufferMemory(paintArea.width,paintArea.height);
if(maxMemory>0&&memory>maxMemory){longkbUsed=memory/KB;longkbMax=maxMemory/KB;thrownewServiceException("Renderingrequestwoulduse"+kbUsed+"KB,whilstthe"+"maximummemoryallowedis"+kbMax+"KB");
if(DefaultWebMapService.isDirectRasterPathEnabled()&&mapContent.layers().size()==1&&mapContent.getAngle()==0.0&&(layout==null||layout.isEmpty())){List<GridCoverage2D>renderedCoverages=newArrayList<GridCoverage2D>(2);try{Interpolationinterpolation=null;
if(request.getInterpolations()!=null&&request.getInterpolations().size()>0){interpolation=request.getInterpolations().get(0);
if(image!=null){returnbuildMap(mapContent,image);
iftheimageistransparentor
ifthemetatiler//isenabled,sinceapparentlytheCropoperationinsidethemeta-tiler//generatesstripedimagesinthatcase(seeGEOS-booleanuseAlpha=transparent||MetatileMapOutputFormat.isRequestTiled(request,this);finalRenderedImagepreparedImage=prepareImage(paintArea.width,paintArea.height,palette,useAlpha);finalMap<RenderingHints.Key,Object>hintsMap=newHashMap<RenderingHints.Key,Object>();finalGraphics2Dgraphic=getGraphics(transparent,bgColor,preparedImage,hintsMap);//setuptheantialiashints
if(AA_NONE.equals(antialias)){hintsMap.put(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_OFF);
if(preparedImage.getColorModel()instanceofIndexColorModel){//otherwiseweendupwithditheredcolorswherethematchis//not100%hintsMap.put(RenderingHints.KEY_DITHERING,RenderingHints.VALUE_DITHER_DISABLE);
else
if(AA_TEXT.equals(antialias)){hintsMap.put(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_OFF);hintsMap.put(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_ON);
else{
if(antialias!=null&&!AA_FULL.equals(antialias)){LOGGER.warning("Unrecognizedantialiassetting'"+antialias+"',validvaluesare"+AA_SETTINGS);
if(wms!=null){
if(WMSInterpolation.Nearest.equals(wms.getInterpolation())){hintsMap.put(JAI.KEY_INTERPOLATION,NN_INTERPOLATION);hintsMap.put(RenderingHints.KEY_INTERPOLATION,RenderingHints.VALUE_INTERPOLATION_NEAREST_NEIGHBOR);
else
if(WMSInterpolation.Bilinear.equals(wms.getInterpolation())){hintsMap.put(JAI.KEY_INTERPOLATION,BIL_INTERPOLATION);hintsMap.put(RenderingHints.KEY_INTERPOLATION,RenderingHints.VALUE_INTERPOLATION_BILINEAR);
else
if(WMSInterpolation.Bicubic.equals(wms.getInterpolation())){hintsMap.put(JAI.KEY_INTERPOLATION,BIC_INTERPOLATION);hintsMap.put(RenderingHints.KEY_INTERPOLATION,RenderingHints.VALUE_INTERPOLATION_BICUBIC);
if(AA_NONE.equals(antialias)){rendererParams.put(StreamingRenderer.TEXT_RENDERING_KEY,StreamingRenderer.TEXT_RENDERING_STRING);
else{//usedtobeTEXT_RENDERING_ADAPTIVEalways,butsincejava7callingdrawGlyphVector//justgeneratesveryuglyresultsrendererParams.put(StreamingRenderer.TEXT_RENDERING_KEY,StreamingRenderer.TEXT_RENDERING_OUTLINE);
if(DefaultWebMapService.isLineWidthOptimizationEnabled()){rendererParams.put(StreamingRenderer.LINE_WIDTH_OPTIMIZATION_KEY,true);
if(wms.isAdvancedProjectionHandlingEnabled()){rendererParams.put(StreamingRenderer.ADVANCED_PROJECTION_HANDLING_KEY,true);
if(wms.isContinuousMapWrappingEnabled()){rendererParams.put(StreamingRenderer.CONTINUOUS_MAP_WRAPPING,true);
if(getFormatOptionAsBoolean(request,ADV_PROJECTION_HANDLING_FORMAT_OPTION)==false){rendererParams.put(StreamingRenderer.ADVANCED_PROJECTION_HANDLING_KEY,false);rendererParams.put(StreamingRenderer.CONTINUOUS_MAP_WRAPPING,false);
if(getFormatOptionAsBoolean(request,MAP_WRAPPING_FORMAT_OPTION)==false){rendererParams.put(StreamingRenderer.CONTINUOUS_MAP_WRAPPING,false);
iftheuserspecifiedadpi
if(request.getFormatOptions().get("dpi")!=null){rendererParams.put(StreamingRenderer.DPI_KEY,(request.getFormatOptions().get("dpi")));
if(labelCache!=null){try{rendererParams.put(StreamingRenderer.LABEL_CACHE_KEY,labelCache.apply(mapContent));
if(request.getFormatOptions().get("kmplacemark")!=null)kmplacemark=((Boolean)request.getFormatOptions().get("kmplacemark")).booleanValue();
if(kmplacemark){//createaStyleVisitorthatcopiesastyle,butremovesthe//PointSymbolizersandTextSymbolizersKMLStyleFilteringVisitordupVisitor=newKMLStyleFilteringVisitor();//RemovePointSymbolizersandTextSymbolizersfromthe//layers'Stylestopreventtheirrenderingonthe//rasterimage.Botharebetterservedwiththe//placemarks.List<Layer>layers=mapContent.layers();for(inti=0;i<layers.size();i++){
if(layers.get(i)instanceofStyleLayer){StyleLayerlayer=(StyleLayer)layers.get(i);Stylestyle=layer.getStyle();style.accept(dupVisitor);Stylecopy=(Style)dupVisitor.getCopy();layer.setStyle(copy);
if(request.getInterpolations()!=null&&request.getInterpolations().size()>i){interpolationToSet=request.getInterpolations().get(i);
ifvendorparamnotset,checkbylayerinterpolationconfiguration
if(interpolationToSet==null){LayerInfolayerInfo=request.getLayers().get(i).getLayerInfo();LayerInfo.WMSInterpolationbyLayerInterpolation=getConfiguredLayerInterpolation(layerInfo);
if(byLayerInterpolation!=null){interpolationToSet=toInterpolationObject(byLayerInterpolation);
if(interpolationToSet!=null){Layerlayer=mapContent.layers().get(i);layer.getUserData().put(StreamingRenderer.BYLAYER_INTERPOLATION,interpolationToSet);
ifabortalreadyrequestedbailout//
if(this.abortRequested){//graphic.dispose();//returnnull;//
if(layout!=null){try{layout.paint(graphic,paintArea,mapContent);
iftoomanyerrorsoccurred
if(errorChecker.exceedsMaxErrors()){serviceException=newServiceException("Morethan"+maxErrors+"renderingerrorsoccurred,bailingout.",errorChecker.getLastException(),"internalError");
iftherequestdidtimeout
if(timeout.isTimedOut()){serviceException=newServiceException("Thisrequestusedmoretimethanallowedandhasbeenforcefullystopped."+"Maxrenderingtimeis"+(maxRenderingTime/1000.0)+"s");
ifanonignorableerroroccurred
if(nonIgnorableExceptionListener.exceptionOccurred()){ExceptionrenderError=nonIgnorableExceptionListener.getException();serviceException=newServiceException("Renderingprocessfailed",renderError,"internalError");
if(serviceException==null){returnoptimizeAndBuildMap(palette,preparedImage,mapContent);//IftheexceptionformatisPARTIALMAP,returnwhateverdidgetrenderedwiththe//exception
else
if(saveMap){RenderedImageMapmap=(RenderedImageMap)timeout.getMap();//Wehitanerrorotherthanatimeoutduringrendering
if(map==null){map=optimizeAndBuildMap(palette,preparedImage,mapContent);
if(request.getFormatOptions().get(formatOptionKey)!=null){StringformatOptionValue=(String)request.getFormatOptions().get(formatOptionKey);return(!"false".equalsIgnoreCase(formatOptionValue));
elsekeynotpresentreturntrue;
if(palette!=null&&palette.getMapSize()<256){image=optimizeSampleModel(preparedImage);
else{image=preparedImage;
if(extension!=null){map.setContentDispositionHeader(mapContent,"."+extension,false);
if(request.getFormatOptions()!=null){layoutName=(String)request.getFormatOptions().get("layout");
if(layoutName!=null&&!layoutName.trim().isEmpty()){try{GeoServerResourceLoaderloader=wms.getCatalog().getResourceLoader();Resourcelayouts=loader.get("layouts");
if(layouts.getType()==Type.DIRECTORY){ResourcelayoutConfig=layouts.get(layoutName+".xml");
if(layoutConfig.getType()==Type.RESOURCE){layout=MapDecorationLayout.fromFile(layoutConfig,tiled);
else{LOGGER.log(Level.WARNING,"Unknownlayoutrequested:"+layoutName);
else{LOGGER.log(Level.WARNING,"Nolayoutsdirectorydefined");
if(layout==null){thrownewServiceException("Couldnotfinddecorationlayoutnamed:"+layoutName);
if(layout==null){layout=tiled?newMetatiledMapDecorationLayout():newMapDecorationLayout();
if(watermark!=null){layout.addBlock(watermark);
if(watermark!=null&&watermark.isEnabled()){Map<String,String>options=newHashMap<String,String>();options.put("url",watermark.getURL());options.put("opacity",Float.toString((255f-watermark.getTransparency())/2.55f));MapDecorationd=newWatermarkDecoration();try{d.loadOptions(options);
switch(watermark.getPosition()){caseTOP_LEFT:p=MapDecorationLayout.Block.Position.UL;break;caseTOP_CENTER:p=MapDecorationLayout.Block.Position.UC;break;caseTOP_RIGHT:p=MapDecorationLayout.Block.Position.UR;break;caseMID_LEFT:p=MapDecorationLayout.Block.Position.CL;break;caseMID_CENTER:p=MapDecorationLayout.Block.Position.CC;break;caseMID_RIGHT:p=MapDecorationLayout.Block.Position.CR;break;caseBOT_LEFT:p=MapDecorationLayout.Block.Position.LL;break;caseBOT_CENTER:p=MapDecorationLayout.Block.Position.LC;break;caseBOT_RIGHT:p=MapDecorationLayout.Block.Position.LR;break;default:thrownewServiceException("UnknownWatermarkInfo.Positionvalue.Somethingisseriouslywrong.");
ifthepaletteInverterisnotprovided,ora*indexedimageotherwise.Subclassesmayoverridethismethodshouldtheyneedaspecialkind*ofimage**@paramwidth*@paramheight*@parampaletteInverter*/protectedRenderedImageprepareImage(intwidth,intheight,IndexColorModelpalette,booleantransparent){returnImageUtils.createImage(width,height,isPaletteSupported()?palette:null,transparent&&isTransparencySupported());
iftheformatsupportsimagetransparency,falseotherwise(defaultsto{@code*true})**@returntrue
iftheformatsupportsimagetransparency,falseotherwise*/publicbooleanisTransparencySupported(){returntransparencySupported;
iftheformatsupportspaletteencoding,falseotherwise(defaultsto{@code*true}).**@returntrue
iftheformatsupportspaletteencoding,falseotherwise*/publicbooleanisPaletteSupported(){returnpalleteSupported;
ifthepaletteonlyhas2colors)**@paramsource*/privatestaticRenderedImageoptimizeSampleModel(RenderedImagesource){intw=source.getWidth();inth=source.getHeight();ImageLayoutlayout=newImageLayout();layout.setColorModel(source.getColorModel());layout.setSampleModel(source.getColorModel().createCompatibleSampleModel(w,h));//
ifIdon'tforcetilingoffwiththissettinganexceptionisthrown//whenwritingtheimageout...layout.setTileWidth(w);layout.setTileHeight(h);RenderingHintshints=newRenderingHints(JAI.KEY_IMAGE_LAYOUT,layout);LookupTabletable=LookupTableFactory.create(IDENTITY_TABLE);//TODOSIMONEwhynotformat?ImageWorkerworker=newImageWorker(source);worker.setRenderingHints(hints);worker.lookup(table);returnworker.getRenderedImage();
ifany,sothat*theycanbedisposedlater*@returntheresultofrenderingthecoverage,ornull
iftherewasnocoverage,orthe*coveragecouldnotberendererforsomereason*@throwsFactoryException*/privateRenderedImagedirectRasterRender(WMSMapContentmapContent,intlayerIndex,List<GridCoverage2D>renderedCoverages,InterpolationlayerInterpolation)throwsIOException,FactoryException{////extracttherastersymbolizersandtheeventualrenderingtransformation//doublescaleDenominator=mapContent.getScaleDenominator(true);Layerlayer=mapContent.layers().get(layerIndex);FeatureTypefeatureType=layer.getFeatureSource().getSchema();Stylestyle=layer.getStyle();RasterSymbolizerVisitorvisitor=newRasterSymbolizerVisitor(scaleDenominator,featureType);style.accept(visitor);List<RasterSymbolizer>symbolizers=visitor.getRasterSymbolizers();
if(symbolizers.size()!=1){returnnull;
if(isVectorSource(transformation)){returnnull;
if(transparent){bgColor=newColor(bgColor.getRed(),bgColor.getGreen(),bgColor.getBlue(),0);
else{bgColor=newColor(bgColor.getRed(),bgColor.getGreen(),bgColor.getBlue(),255);
if(layerInterpolation!=null){interpolation=layerInterpolation;
else{LayerInfo.WMSInterpolationbyLayerInterpolation=null;
if(mapContent.getRequest().getLayers().size()>layerIndex){LayerInfolayerInfo=mapContent.getRequest().getLayers().get(layerIndex).getLayerInfo();byLayerInterpolation=getConfiguredLayerInterpolation(layerInfo);
if(byLayerInterpolation==null&&wms!=null){//
ifinterpolationmethodisnotconfiguredforthislayer,useservicedefaultbyServiceInterpolation=wms.getInterpolation();
if(byLayerInterpolation!=null){interpolation=toInterpolationObject(byLayerInterpolation);
else
if(byServiceInterpolation!=null){interpolation=toInterpolationObject(byServiceInterpolation);
else{//defaulttoNearestNeighborinterpolation=Interpolation.getInstance(Interpolation.INTERP_NEAREST);
ifthereisaoutputtilesizehint,useit,otherwiseusetheoutputsizeitselfinttileSizeX=-1;inttileSizeY=-1;
if(mapContent.getTileSize()!=-1){tileSizeX=tileSizeY=mapContent.getTileSize();
else
if(mapWidth<MAX_TILE_SIZE&&mapHeight<MAX_TILE_SIZE){tileSizeX=mapWidth;tileSizeY=mapHeight;
if(transformation==null&&wms.isAdvancedProjectionHandlingEnabled()){////Getthereader//finalFeaturefeature=mapContent.layers().get(0).getFeatureSource().getFeatures().features().next();finalGridCoverage2DReaderreader=(GridCoverage2DReader)feature.getProperty("grid").getValue();//renderviagridcoveragerenderer,thatwillapplytheadvancedprojection//handlingfinalObjectparams=feature.getProperty("params").getValue();GeneralParameterValue[]readParameters=getReadParameters(params,null,null,interpolation,readerBgColor,bandIndices);finalGridCoverageRenderergcr=newGridCoverageRenderer(mapEnvelope.getCoordinateReferenceSystem(),mapEnvelope,mapRasterArea,worldToScreen,interpolationHints);gcr.setAdvancedProjectionHandlingEnabled(true);gcr.setWrapEnabled(wms.isContinuousMapWrappingEnabled());//usenullbackgroundhere,backgroundcolorishandledafterwardsimage=gcr.renderImage(reader,readParameters,symbolizer,interpolation,null,tileSizeX,tileSizeY);
if(image==null){//we'reoutsideofthecoveragedefinitionarea,returnanemptyspaceimage=createBkgImage(mapWidth,mapHeight,bgColor,null);
else{////Preparethereadingparameters(fortheRTcase)//finalCoordinateReferenceSystemcoverageCRS=layer.getFeatureSource().getSchema().getCoordinateReferenceSystem();finalGridGeometry2DreadGG;finalbooleanequalsMetadata=CRS.equalsIgnoreMetadata(mapCRS,coverageCRS);booleansameCRS;try{sameCRS=equalsMetadata||CRS.findMathTransform(mapCRS,coverageCRS,true).isIdentity();
if(!needsGutter){readGG=newGridGeometry2D(newGridEnvelope2D(mapRasterArea),mapEnvelope);
else{////SGaddedguttertothedrawing.Weneedtoinvestigatemuchmoreandalsowe//needtodothisonlywhenneeded////enlargerasterareaRectanglebufferedTargetArea=(Rectangle)mapRasterArea.clone();bufferedTargetArea.add(mapRasterArea.x+mapRasterArea.width+10,mapRasterArea.y+mapRasterArea.height+10);bufferedTargetArea.add(mapRasterArea.x-10,mapRasterArea.y-10);//nowcreatethefinalenvelopeaccordinglytry{readGG=newGridGeometry2D(newGridEnvelope2D(bufferedTargetArea),PixelInCell.CELL_CORNER,newAffineTransform2D(worldToScreen.createInverse()),mapCRS,null);
if(transformation!=null){RenderingTransformationHelperhelper=newRenderingTransformationHelper(){protectedGridCoverage2DreadCoverage(GridCoverage2DReaderreader,Objectparams,GridGeometry2DreadGG)throwsIOException{context.reader=reader;context.params=params;returnreadBestCoverage(context,ReferencedEnvelope.reference(readGG.getEnvelope()),readGG.getGridRange2D(),interpolation,readerBgColor,bandIndices);
if(result==null){coverage=null;
else
if(resultinstanceofGridCoverage2D){coverage=(GridCoverage2D)result;symbolizer=updateSymbolizerForBandSelection(context,symbolizer,bandIndices);
else{//wedon'tknowhowtohandlethiscase,we'llletstreamingrendererfall//backonthisonereturnnull;
else{////Getthereader//finalFeaturefeature=mapContent.layers().get(0).getFeatureSource().getFeatures().features().next();finalGridCoverage2DReaderreader=(GridCoverage2DReader)feature.getProperty("grid").getValue();//renderviagridcoveragerenderer,thatwillapplytheadvancedprojection//handlingfinalObjectparams=feature.getProperty("params").getValue();context.reader=reader;context.params=params;coverage=readBestCoverage(context,ReferencedEnvelope.reference(readGG.getEnvelope()),readGG.getGridRange2D(),interpolation,readerBgColor,bandIndices);symbolizer=updateSymbolizerForBandSelection(context,symbolizer,bandIndices);
if(coverage==null){//we'reoutsideofthecoveragedefinitionarea,returnanemptyspaceimage=createBkgImage(mapWidth,mapHeight,bgColor,null);
if(image==null){//applythegridcoveragerendererfinalGridCoverageRenderergcr=newGridCoverageRenderer(mapCRS,ReferencedEnvelope.reference(readGG.getEnvelope()),readGG.getGridRange2D(),worldToScreen,interpolationHints);gcr.setAdvancedProjectionHandlingEnabled(false);//createasolidcoloremptyimage//usenullbackground,backgroundishandledseparatelyimage=gcr.renderImage(coverage,symbolizer,interpolation,null,tileSizeX,tileSizeY);
ifwemanagedtoprocessthecoverageintoanimage
if(image==null){returnnull;
iftheimageintersectstherequestedareaatallreturnnullandbedonewithitfinalRectangleimageBounds=PlanarImage.wrapRenderedImage(image).getBounds();Rectangleintersection=imageBounds.intersection(mapRasterArea);
if(intersection.isEmpty()){returnnull;
ifweneedtocropweuseCrop.Notice//that//
ifweneedtomessupwiththebackgroundcolorweneedtogobyMosaicandwecannotuse//Crop//sinceitdoesnotsupportchangingthebkgcolor.////////weneedtodoamosaic,let'spreparealayout//prepareafinalimagelayoutshouldweneedtoperformamosaicoracropfinalImageLayoutlayout=newImageLayout();layout.setMinX(0);layout.setMinY(0);layout.setWidth(mapWidth);layout.setHeight(mapHeight);
if(tileSizeX>0&&tileSizeY>0){layout.setTileGridXOffset(0);layout.setTileGridYOffset(0);layout.setTileWidth(tileSizeX);layout.setTileHeight(tileSizeY);
if(cminstanceofIndexColorModel){IndexColorModelicm=(IndexColorModel)cm;//trytofindtheindexthatmatchestherequestedbackgroundcolorfinalintbgColorIndex;
if(transparent){bgColorIndex=icm.getTransparentPixel();
else{
if(icm.hasAlpha()&&icm.isAlphaPremultiplied()){//uncommoncasethatwedon'thavethecodetohandledirectlybgColorIndex=-1;
else{
if(icm.getTransparency()!=Transparency.OPAQUE){//wehaveatranslucentimage,sothebgcolorneedstobemergedinto//thepaletteicm=ColorUtilities.applyBackgroundColor(icm,bgColor);cm=icm;ImageLayoutilColorModel=newImageLayout(image);ilColorModel.setColorModel(icm);RenderingHintshints=newRenderingHints(JAI.KEY_IMAGE_LAYOUT,ilColorModel);worker.setRenderingHints(hints);worker.format(image.getSampleModel().getDataType());image=worker.getRenderedImage();
if(bgColorIndex==-1){//weneedtoexpandtheimagetoRGBimage=worker.forceComponentColorModel().getRenderedImage();
if(transparent){image=addAlphaChannel(image);worker.setImage(image);
else{//wefoundthebackgroundcolorintheoriginalimagepalettethereforewesetits//indexasthebkgvalue.//ThefinalMosaicwillusetheIndexColorModelofthisimageanywa,thereforeall//weneedtodoistoforce//thebackgroundtopointtotherightcolorinthepalettebgValues=newdouble[]{bgColorIndex};
ifwehavetheminordertoreusethemlateronformosaic//operation
if(cm.hasAlpha()&&bgColorIndex==-1){worker.forceComponentColorModel();finalRenderedImagealpha=worker.retainLastBand().getRenderedImage();alphaChannels=newPlanarImage[]{PlanarImage.wrapRenderedImage(alpha)};
if(cminstanceofComponentColorModel){//converttoRGB
ifnecessaryComponentColorModelccm=(ComponentColorModel)cm;booleanhasAlpha=cm.hasAlpha();//
ifwehaveagrayscaleimagesee
ifwehavetoexpandtoRGB
if(ccm.getNumColorComponents()==1){
if((!isLevelOfGray(bgColor)&&!transparent)||(ccm.getTransferType()==DataBuffer.TYPE_DOUBLE||ccm.getTransferType()==DataBuffer.TYPE_FLOAT||ccm.getTransferType()==DataBuffer.TYPE_UNDEFINED)){//expandtoRGB,thisisnotacasewecanoptimizefinalImageWorkeriw=newImageWorker(image);
if(hasAlpha){finalRenderedImagealpha=iw.retainLastBand().getRenderedImage();//getfirstbandfinalRenderedImagegray=newImageWorker(image).retainFirstBand().getRenderedImage();image=newImageWorker(gray).bandMerge(3).addBand(alpha,false).forceComponentColorModel().forceColorSpaceRGB().getRenderedImage();
else{image=iw.bandMerge(3).forceComponentColorModel().forceColorSpaceRGB().getRenderedImage();
else
if(!hasAlpha){//notransparencyintheoriginaldata,sononeedtoexpandtoRGB
if(transparent){//weneedtoexpandtheimagewithanalphachannel//let'ssee
ifwecandothatbydirectlymappingnodatatotransparent//colorRenderedImagetransparentImage=grayNoDataTransparent(image);
if(transparentImage==null){image=addAlphaChannel(image);bgValues=newdouble[]{mapToGrayColor(bgColor,ccm),0};
else{image=transparentImage;noDataTransparencyOnGrayByte=true;
else{bgValues=newdouble[]{mapToGrayColor(bgColor,ccm)};
else{//extractthealphachannelfinalImageWorkeriw=newImageWorker(image);finalRenderedImagealpha=iw.retainLastBand().getRenderedImage();alphaChannels=newPlanarImage[]{PlanarImage.wrapRenderedImage(alpha)};
if(transparent){bgValues=newdouble[]{mapToGrayColor(bgColor,ccm),0};
else{bgValues=newdouble[]{mapToGrayColor(bgColor,ccm),255};
if(bgValues==null&&!noDataTransparencyOnGrayByte){
if(hasAlpha){//getalphafinalImageWorkeriw=newImageWorker(image);finalRenderedImagealpha=iw.retainLastBand().getRenderedImage();alphaChannels=newPlanarImage[]{PlanarImage.wrapRenderedImage(alpha)};
if(transparent){bgValues=newdouble[]{bgColor.getRed(),bgColor.getGreen(),bgColor.getBlue(),0};
else{bgValues=newdouble[]{bgColor.getRed(),bgColor.getGreen(),bgColor.getBlue(),255};
else{
if(transparent){image=addAlphaChannel(image);//thiswillworkfineforallsituationwherethecolorcomponentsare<=3//e.g.,onebandrasterswithnocolormapwillhaveonlyoneusuallybgValues=newdouble[]{0,0,0,0};
else{//TODO:handlethecasewherethecomponentcolormodelisnotRGB//WecannotuseImageWorkerasisbecauseitbasicallyseemstoassume//component->3bandinforceComponentColorModel()//butIguesswe'llneedtoturntheimageintoa3bandRGBone.bgValues=newdouble[]{bgColor.getRed(),bgColor.getGreen(),bgColor.getBlue()};
ifweneedtoblend/applyabkgcolorImageWorkeriw=newImageWorker(image);ObjectroiCandidate=image.getProperty("roi");
if(!(imageBounds.contains(mapRasterArea)||imageBounds.equals(mapRasterArea))||transparencyType!=Transparency.OPAQUE||iw.getNoData()!=null||roiCandidateinstanceofROI){image=applyBackgroundTransparency(mapRasterArea,image,intersection,layout,bgValues,alphaChannels,transparencyType,iw,roiCandidate,noDataTransparencyOnGrayByte);
else{//Check
ifweneedtocropasubsetoftheproducedimage,
elsereturnitrightaway
if(imageBounds.contains(mapRasterArea)&&!imageBounds.equals(mapRasterArea)){//theproducedimagedoesnotneedafinalmosaicking//operationbutacrop!iw.setBackground(bgValues);iw.crop(0,0,mapWidth,mapHeight);image=iw.getRenderedImage();
if(roiCandidateinstanceofROI){ROIimageROI=(ROI)roiCandidate;try{roi=imageROI.intersect(newROIShape(mapRasterArea));
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"FailedtointersectimageROIwithtargetbounds,returningemptyresult",e);
else{roi=newROIShape(!intersection.isEmpty()?intersection:mapRasterArea);
if(tranformationinstanceofProcessFunction){ProcessFunctionprocessFunction=(ProcessFunction)tranformation;NameprocessName=processFunction.getProcessName();Map<String,org.geotools.data.Parameter<?>>params=Processors.getParameterInfo(processName);for(org.geotools.data.Parameter<?>param:params.values()){
if(SimpleFeatureCollection.class.isAssignableFrom(param.getType())){returntrue;
if(params!=null&&reader!=null&&bandIndices!=null){Formatformat=reader.getFormat();ParameterValueGroupreadParameters=null;ParameterDescriptorGroupdescriptorGroup=null;List<GeneralParameterDescriptor>descriptors=null;
if(format!=null&&((readParameters=format.getReadParameters())!=null)&&((descriptorGroup=readParameters.getDescriptor())!=null)&&((descriptors=descriptorGroup.descriptors())!=null)&&(descriptors.contains(AbstractGridFormat.BANDS))&&bandIndices!=null){//
ifbandsareselected,alterthesymbolizertousebandsinorder0,1,2,...//sincethechannelorderdefinedbyitpreviouslyistakencareofthereadersymbolizer=GridCoverageRenderer.setupSymbolizerForBandsSelection(symbolizer);
if(CRS.getAxisOrder(crs)!=AxisOrder.NORTH_EAST){returnenvelope;
if(epsg==null){returnenvelope;
else{CoordinateReferenceSystemeastNorthCrs=CRS.decode("EPSG:"+epsg,true);returnnewReferencedEnvelope(envelope.getMinY(),envelope.getMaxY(),envelope.getMinX(),envelope.getMaxX(),eastNorthCrs);
if(noData!=null&&image.getSampleModel().getDataType()==DataBuffer.TYPE_BYTE&&numColorBands==1&&cminstanceofComponentColorModel){intminValue=noData.getMin().intValue();intmaxValue=noData.getMax().intValue();
if(minValue==maxValue&&minValue>=Byte.MIN_VALUE&&minValue<=Byte.MAX_VALUE){//OptimizationongrayimageswithnoDatavalue.MakethatvaluetransparentColortransparentColor=newColor(minValue,minValue,minValue);iw.makeColorTransparent(transparentColor);returniw.getRenderedImage();
ifthecolorisalevelofgray**@paramcolor*/privatestaticbooleanisLevelOfGray(Colorcolor){returncolor.getRed()==color.getBlue()&&color.getRed()==color.getGreen();
ifneededfinalNumber[]bands=newByte[]{(byte)bgColor.getRed(),(byte)bgColor.getGreen(),(byte)bgColor.getBlue(),(byte)bgColor.getAlpha()};returnConstantDescriptor.create(width,height,bands,renderingHints);
if(envelope!=null){//////ItisanGridCoverage2DReader,let'suseparameters//
ifwehaveanysuppliedbyauser.//////firstIcreatedthecorrectReadGeometryreadGG=(Parameter<GridGeometry2D>)AbstractGridFormat.READ_GRIDGEOMETRY2D.createValue();readGG.setValue(newGridGeometry2D(newGridEnvelope2D(requestedRasterArea),envelope));
if(bgColor!=null){bgColorParam=(Parameter<Color>)AbstractGridFormat.BACKGROUND_COLOR.createValue();bgColorParam.setValue(bgColor);
else{bgColorParam=null;
if(bandIndices!=null){bandIndicesParam=(Parameter<int[]>)AbstractGridFormat.BANDS.createValue();bandIndicesParam.setValue(bandIndices);
ifthereareany.GeneralParameterValue[]readParams=(GeneralParameterValue[])params;finalintlength=readParams==null?0:readParams.length;
if(length>0){////////Gettingparameterstocontrolhowtoreadthiscoverage.//Remembertochecktoactuallyhavethembeforeforwarding//themtothereader.////////wehaveavalidnumberofparameters,let'scheck
if//alsohaveaREAD_GRIDGEOMETRY2D.Insuchcasewejust//overrideitwiththeonewejustbuildforthis//request.finalStringreadGGName=AbstractGridFormat.READ_GRIDGEOMETRY2D.getName().toString();finalStringreadInterpolationName=ImageMosaicFormat.INTERPOLATION.getName().toString();finalStringbgColorName=AbstractGridFormat.BACKGROUND_COLOR.getName().toString();finalStringbandsListName=AbstractGridFormat.BANDS.getName().toString();inti=0;booleanfoundInterpolation=false;booleanfoundGG=false;booleanfoundBgColor=false;booleanfoundBandIndices=false;for(;i<length;i++){finalStringparamName=readParams[i].getDescriptor().getName().toString();
if(paramName.equalsIgnoreCase(readGGName)&&readGG!=null){((Parameter)readParams[i]).setValue(readGG);foundGG=true;
else
if(paramName.equalsIgnoreCase(readInterpolationName)){((Parameter)readParams[i]).setValue(interpolation);foundInterpolation=true;
else
if(paramName.equalsIgnoreCase(bgColorName)&&bgColor!=null){((Parameter)readParams[i]).setValue(bgColor);foundBgColor=true;
else
if(paramName.equalsIgnoreCase(bandsListName)&&bandIndices!=null){((Parameter)readParams[i]).setValue(bandIndices);foundBandIndices=true;
if(!foundGG||!foundInterpolation||!(foundBgColor&&bgColor!=null)||!foundBandIndices){//addthecorrectreadgeometrytothesupplied//paramssincewedidnotfindanythingList<GeneralParameterValue>paramList=newArrayList<GeneralParameterValue>();paramList.addAll(Arrays.asList(readParams));
if(!foundGG&&readGG!=null){paramList.add(readGG);
if(!foundInterpolation){paramList.add(readInterpolation);
if(!foundBgColor&&bgColor!=null){paramList.add(bgColorParam);
if(!foundBandIndices&&bandIndices!=null){paramList.add(bandIndicesParam);
else{List<GeneralParameterValue>paramList=newArrayList<>();
if(readGG!=null){paramList.add(readGG);
if(bgColor!=null){paramList.add(bgColorParam);
if(bandIndices!=null){paramList.add(bandIndicesParam);
if(layer!=null&&layer.getDefaultWMSInterpolationMethod()!=null){try{configuredInterpolation=layer.getDefaultWMSInterpolationMethod();
if(interpolationMethod==null){returnnull;
switch(interpolationMethod){caseBilinear:returnInterpolation.getInstance(Interpolation.INTERP_BILINEAR);caseBicubic:returnInterpolation.getInstance(Interpolation.INTERP_BICUBIC);caseNearest:default:returnInterpolation.getInstance(Interpolation.INTERP_NEAREST);
if(interpolationMethod==null){returnnull;
switch(interpolationMethod){caseBilinear:returnInterpolation.getInstance(Interpolation.INTERP_BILINEAR);caseBicubic:returnInterpolation.getInstance(Interpolation.INTERP_BICUBIC);caseNearest:default:returnInterpolation.getInstance(Interpolation.INTERP_NEAREST);
if(history.size()>100){history.poll();
if(r.getId()==id){returnr;
if(q.getFilter()!=null){Filterf=q.getFilter();predicates.add(newPropertyCompare(f.getLeft(),f.getType(),f.getRight()));
if(q.getFromDate()!=null||q.getToDate()!=null){predicates.add(newDateRange(q.getFromDate(),q.getToDate()));
if(!p.matches(r)){it.remove();continueO;
if(q.getOffset()!=null&&q.getOffset()>=i++){it.remove();continue;
if(q.getCount()!=null&&q.getCount()<=count){it.remove();continue;
if(q.getSortBy()!=null){Collections.sort(requests,newSorter(q.getSortBy(),q.getSortOrder()));
else
if(q.getFromDate()!=null||q.getToDate()!=null){Collections.sort(requests,newSorter("startTime",SortOrder.DESC));
if(time==null){returnfalse;
if(from!=null){
if(time.before(from)){returnfalse;
if(to!=null){
if(time.after(to)){returnfalse;
if(leftinstanceofString&&OwsUtils.has(data,(String)left)){property=(String)left;value=right;
else
if(rightinstanceofString&&OwsUtils.has(data,(String)right)){property=(String)right;value=left;
if(property==null){thrownewIllegalArgumentException("Couldnotfindproperty");
if(o==null){returnvalue==null&&compare==Comparison.EQ;
if(compare==Comparison.IN){
if(!(valueinstanceofList)){thrownewUnsupportedOperationException("INcomparisononlysupportedagainstlistvalues");
if(compare==Comparison.EQ){returno.equals(value);
if(compare==Comparison.NEQ){return!o.equals(value);
if(oinstanceofComparable){intc=((Comparable)o).compareTo(value);
switch(compare){caseLT:returnc<0;caseLTE:returnc<=0;caseGT:returnc>0;caseGTE:returnc>=0;
else{thrownewUnsupportedOperationException("Valuesoftype"+value.getClass().getName()+"onlysupportequalityandnon-equalitycomparison.");
if(o1==null&&o2!=null){return1;
if(o1!=null&&o2==null){return-1;
if(o1==null&&o2==null){return0;
if(o1instanceofComparable){return((Comparable)o1).compareTo(o2);
if(store.getWorkspace()!=null){//ensurethespecifiedworkspacematchestheonedictatedbytheuriWorkspaceInfows=store.getWorkspace();
if(!workspaceName.equals(ws.getName())){thrownewRestException("Expectedworkspace"+workspaceName+"butclientspecified"+ws.getName(),HttpStatus.FORBIDDEN);
else{store.setWorkspace(catalog.getWorkspaceByName(workspaceName));
if(info.getWorkspace()!=null&&!original.getWorkspace().equals(info.getWorkspace())){thrownewRestException("Attemptingtomove"+storeName+"from"+original.getWorkspace().getName()+"to"+info.getWorkspace().getName()+"viaPUT",HttpStatus.FORBIDDEN);
if(!original.getName().equals(info.getName())){thrownewRestException("Attemptingtorename"+storeName+"to"+info.getName()+"viaPUT",HttpStatus.FORBIDDEN);
if(original==null){thrownewResourceNotFoundException("Nosuchwmtsstore:"+workspaceName+","+storeName);
if(!recurse){
if(!catalog.getResourcesByStore(cs,WMTSLayerInfo.class).isEmpty()){thrownewRestException("wmtsstorenotempty",HttpStatus.UNAUTHORIZED);
else{newCascadeDeleteVisitor(catalog).visit(cs);
if(workspace==null||store==null){returnnull;
if(objinstanceofWorkspaceInfo){converter.encodeLink("/workspaces/"+converter.encode(ref),writer);
if(properties==null){try{properties=model.toMap();
if(!dsProps.isEmpty())properties.putIfAbsent("layers",dsProps);
ifapathisinsidethedatadirectoryitwillbeturnedinto*arelativepath**@authorAndreaAime-GeoSolutions*/publicclassFileModelimplementsIModel<String>{privatestaticfinallongserialVersionUID=3911203737278340528L;staticfinalLoggerLOGGER=Logging.getLogger(FileModel.class);IModel<String>delegate;FilerootDir;publicFileModel(IModel<String>delegate){this(delegate,GeoServerExtensions.bean(GeoServerResourceLoader.class).getBaseDirectory());
if(selection==null||"".equals(selection.getPath()))returnfalse;
if(selection.equals(root))returntrue;returnisSubfile(root,selection.getParentFile());
if(objinstanceofURL){URLurl=(URL)obj;returnurl.toExternalForm();
if(location!=null){FiledataDirectory=canonicalize(rootDir);Filefile=canonicalize(newFile(location));
if(isSubfile(dataDirectory,file)){Filecurr=file;Stringpath=null;//paranoidchecktoavoidinfiniteloopswhile(curr!=null&&!curr.equals(dataDirectory)){
if(path==null){path=curr.getName();
else{path=curr.getName()+"/"+path;
else{FiledataFile=Files.url(rootDir,location);
if(dataFile!=null&&!dataFile.equals(file)){//relativetothedatadirectory,doesnotneedfixing
else{location="file://"+file.getAbsolutePath();
ifpossible**@paramfile*/Filecanonicalize(Filefile){try{returnfile.getCanonicalFile();
ifitdoesn'texsistworkspace=newWorkspaceInfoImpl();workspace.setId("test-workspace");workspace.setName("test-workspace");getCatalog().add(workspace);//initiatethehandlersrelatedwithservicesserviceHandler=GeoServerExtensions.bean(JMSServiceHandlerSPI.class).createHandler();
ifthenewaddedservicewascorrectlypublishedassertThat(messages.size(),is(1));List<JMSServiceModifyEvent>serviceEvents=getMessagesForHandler(messages,SERVICE_EVENT_HANDLER_KEY,serviceHandler);assertThat(serviceEvents.size(),is(1));assertThat(serviceEvents.get(0).getEventType(),is(JMSEventType.ADDED));//checktheservicecontentServiceInfopublishedService=serviceEvents.get(0).getSource();assertThat(publishedService.getName(),is("TEST-WMS-NAME"));assertThat(publishedService.getId(),is("TEST-WMS-ID"));assertThat(publishedService.getAbstract(),is("TEST-WMS-ABSTRACT"));
ifwegotthecorrectevents,modifyeventandapostmodifyeventassertThat(messages.size(),is(2));List<JMSServiceModifyEvent>serviceEvents=getMessagesForHandler(messages,SERVICE_EVENT_HANDLER_KEY,serviceHandler);assertThat(serviceEvents.size(),is(2));//checkthemodifyeventJMSServiceModifyEventmodifyEvent=serviceEvents.stream().filter(event->event.getEventType()==JMSEventType.MODIFIED).findFirst().orElse(null);assertThat(modifyEvent,notNullValue());ServiceInfomodifiedService=serviceEvents.get(0).getSource();assertThat(modifiedService.getName(),is(serviceInfo.getName()));assertThat(modifiedService.getId(),is(serviceInfo.getId()));assertThat(modifiedService.getAbstract(),is(newAbstract));//checkthepostmodifyeventJMSServiceModifyEventpostModifyEvent=serviceEvents.stream().filter(event->event.getEventType()==JMSEventType.ADDED).findFirst().orElse(null);assertThat(postModifyEvent,notNullValue());ServiceInfopostModifiedService=serviceEvents.get(0).getSource();assertThat(postModifiedService.getName(),is(serviceInfo.getName()));assertThat(postModifiedService.getId(),is(serviceInfo.getId()));assertThat(postModifiedService.getAbstract(),is(newAbstract));}}
if(!m.matches()){response.sendError(400,"Badrequest,pathmustbeofform:/icons/[<workspace>/]<style>");returnnull;
if(m.groupCount()==2){workspace=m.group(1);styleName=m.group(2);
else{styleName=m.group(1);
if(styleInfo==null){Stringmsg="Nosuchstyle"+styleName;
if(workspace!=null){msg+="inworkspace"+workspace;
if(valueinstanceofString){kvp.put(key,(String)value);
else{String[]values=(String[])value;kvp.put(key,values[0]);
if(!DISABLED){initAddresses(strategy);initAliases();initLog();
if(LOGGER.isLoggable(Level.INFO)){StringBuilderbuilder=newStringBuilder("Identifiedaddressesandhostnamesforlocalinterfaces:");booleanfirst=true;for(InetAddressadd:ADDRESSES){
if(!first){builder.append(",");
if(additional==null){additional="localhost";
ifarequestisreflectiveweneedtoknowwhatallthe//addressesandhostnamesthatweareaddressableon.Sincehostnamesareexpensivewe//doitonceandcachetheresultsADDRESSES.clear();for(NetworkInterfaceni:strategy.getNetworkInterfaces()){for(InetAddressadd:Collections.list(ni.getInetAddresses())){//dothehostnamelookup,thesearecachedafterthefirstcallsoweonlypaythe//pricenowadd.getHostName();ADDRESSES.add(add);
if(DISABLED)returnfalse;//check
ifthisuriisareflectiveone
if(uriIsReflective(uri)){//itis,checkthequerystringtodetermine
ifitisaDescribeFeatureTyperequestStringq=uri.query();
if(q!=null&&!"".equals(q.trim())){KvpMapkv=parseQueryString(q);
if("DescribeFeatureType".equalsIgnoreCase((String)kv.get("REQUEST"))||(uri.path().endsWith("DescribeFeatureType"))){returntrue;
ifthereisoneStringproxyBaseUrl=geoServer.getGlobal().getProxyBaseUrl();
if(proxyBaseUrl!=null){try{URIproxyBaseUri=URI.createURI(proxyBaseUrl);
if(uri.host().equalsIgnoreCase(proxyBaseUri.host())){returntrue;
if(ADDITIONAL_HOSTNAMES.contains(uri.host())){LOGGER.log(Level.FINE,"Hostname{0}isinknownaliasesforself",newObject[]{uri.host()});returntrue;
ifthehostmatchesfor(InetAddressadd:ADDRESSES){
if(uri.host().equals(add.getHostAddress())||uri.host().equalsIgnoreCase(add.getHostName())){LOGGER.log(Level.FINE,"Hostname{0}identifieslocalnetworkinterface{1}{2}",newObject[]{uri.host(),add.getHostAddress(),add.getHostName()});returntrue;
if(ver==null){ver=WFSInfo.Version.latest();
switch(ver){caseV_10:caseV_11:dftReqReader=newDescribeFeatureTypeKvpRequestReader(catalog);break;default:dftReqReader=neworg.geoserver.wfs.kvp.v2_0.DescribeFeatureTypeKvpRequestReader(catalog);
switch(ver){caseV_10:schemaEncoder=newXmlSchemaEncoder.V10(geoServer);break;caseV_11:schemaEncoder=newXmlSchemaEncoder.V11(geoServer);break;caseV_20:default:schemaEncoder=newXmlSchemaEncoder.V20(geoServer);
if(other==this)returntrue;
if(other==null)returnfalse;
if(!(otherinstanceofAttributionInfo))returnfalse;AttributionInfoattr=(AttributionInfo)other;
if(id==null){
if(attr.getId()!=null)returnfalse;
else{
if(!id.equals(attr.getId()))returnfalse;
if(title==null){
if(attr.getTitle()!=null)returnfalse;
else{
if(!title.equals(attr.getTitle()))returnfalse;
if(href==null){
if(attr.getHref()!=null)returnfalse;
else{
if(!href.equals(attr.getHref()))returnfalse;
if(logoURL==null){
if(attr.getLogoURL()!=null)returnfalse;
else{
if(!logoURL.equals(attr.getLogoURL()))returnfalse;
if(logoWidth!=attr.getLogoWidth())returnfalse;
if(logoHeight!=attr.getLogoHeight())returnfalse;
if(logoType==null){
if(attr.getLogoType()!=null)returnfalse;
else{
if(!logoType.equals(attr.getLogoType()))returnfalse;
ifthetogglecanrunenableanddisablepublishingevents,falseotherwise*/privatevolatileBooleanstatus=true;privatefinalToggleTypetoggleType;publicToggleSwitch(finalToggleTypetoggleType){this.toggleType=toggleType;
ifthetogglecanenableanddisable,falseotherwise*/publicfinalbooleanisToggleEnabled(){returnstatus;
if(isToggleEnabled()){ctx.publishEvent(newToggleEvent(Boolean.TRUE,toggleType));
if(isToggleEnabled()){ctx.publishEvent(newToggleEvent(Boolean.FALSE,toggleType));
if(instances.length<=1){//onlyoneinstance,sonothingtoequalizereturn;
if(infoA==null){//thisinfodoesn'texistsinthereferenceinstance,soitneedstoberemovedremove(instanceB.getGeoServer(),instanceB.getCatalog(),infoB);
else
if(infoB==null){//thisinfoexistsonlyinthereferenceinstancesoitneedstobeaddedadd(instanceB.getGeoServer(),instanceB.getCatalog(),(Info)SerializationUtils.clone(infoA));
else{//thisinfoexistsinbothinstancesbutisdifferentsave(instanceB.getGeoServer(),instanceB.getCatalog(),ModificationProxy.unwrap(infoA),ModificationProxy.unwrap(infoB));
if(instances.length<=1){//onlyoneinstance,sonotingtocheckreturn;
if(infoAinstanceofWorkspaceInfo){catalog.save(updateInfoImpl(infoA,infoB,WorkspaceInfo.class));
else
if(infoAinstanceofNamespaceInfo){catalog.save(updateInfoImpl(infoA,infoB,NamespaceInfo.class));
else
if(infoAinstanceofDataStoreInfo){catalog.save(updateInfoImpl(infoA,infoB,DataStoreInfo.class));
else
if(infoAinstanceofCoverageStoreInfo){catalog.save(updateInfoImpl(infoA,infoB,CoverageStoreInfo.class));
else
if(infoAinstanceofWMSStoreInfo){catalog.save(updateInfoImpl(infoA,infoB,WMSStoreInfo.class));
else
if(infoAinstanceofFeatureTypeInfo){catalog.save(updateInfoImpl(infoA,infoB,FeatureTypeInfo.class));
else
if(infoAinstanceofCoverageInfo){catalog.save(updateInfoImpl(infoA,infoB,CoverageInfo.class));
else
if(infoAinstanceofLayerInfo){catalog.save(updateInfoImpl(infoA,infoB,LayerInfo.class));
else
if(infoAinstanceofStyleInfo){catalog.save(updateInfoImpl(infoA,infoB,StyleInfo.class));
else
if(infoAinstanceofLayerGroupInfo){catalog.save(updateInfoImpl(infoA,infoB,LayerGroupInfo.class));
else
if(infoAinstanceofWMSLayerInfo){catalog.save(updateInfoImpl(infoA,infoB,WMSLayerInfo.class));
else
if(infoAinstanceofSettingsInfo){geoServer.save(updateInfoImpl(infoA,infoB,SettingsInfo.class));
else
if(infoAinstanceofServiceInfo){geoServer.save(updateInfoImpl(infoA,infoB,ServiceInfo.class));
else
if(infoAinstanceofLoggingInfo){geoServer.save(updateInfoImpl(infoA,infoB,LoggingInfo.class));
else
if(infoAinstanceofGeoServerInfo){geoServer.save(updateInfoImpl(infoA,infoB,GeoServerInfo.class));
else{thrownewRuntimeException(String.format("Don'tknowhowtohandleinfooftype'%s'.",infoA.getClass().getSimpleName()));
if(!type.isAssignableFrom(infoA.getClass())||!type.isAssignableFrom(infoB.getClass())){thrownewRuntimeException(String.format("Infoobjectsshouldbeoftype'%s',butareoftypes'%s'and'%s'.",type.getSimpleName(),infoA.getClass().getSimpleName(),infoB.getClass().getSimpleName()));
if(propertyValueinstanceofInfo){//wearedealingwithaninfoobject,checkthatbothpropertiesarecompatibleObjectotherPropertyValue=OwsUtils.get(infoB,propertyName);
if(otherPropertyValueinstanceofInfo){//recursivelyupdatethisinfopropertyValue=updateInfoImpl((Info)propertyValue,(Info)otherPropertyValue,getInfoInterface(propertyValue.getClass()));
ifthepropertyvalueisnotainfocloneit
ifpossible
if(propertyValueinstanceofSerializable&&!(propertyValueinstanceofProxy)){propertyValue=SerializationUtils.clone((Serializable)propertyValue);
if(Info.class.isAssignableFrom(classInterface)){//compatibleinterfacefound,let'susethisonereturnclassInterface;
if(infoinstanceofWorkspaceInfo){catalog.add((WorkspaceInfo)info);
else
if(infoinstanceofNamespaceInfo){catalog.add((NamespaceInfo)info);
else
if(infoinstanceofDataStoreInfo){catalog.add((DataStoreInfo)info);
else
if(infoinstanceofCoverageStoreInfo){catalog.add((CoverageStoreInfo)info);
else
if(infoinstanceofWMSStoreInfo){catalog.add((WMSStoreInfo)info);
else
if(infoinstanceofFeatureTypeInfo){catalog.add((FeatureTypeInfo)info);
else
if(infoinstanceofCoverageInfo){catalog.add((CoverageInfo)info);
else
if(infoinstanceofLayerInfo){catalog.add((LayerInfo)info);
else
if(infoinstanceofStyleInfo){catalog.add((StyleInfo)info);
else
if(infoinstanceofLayerGroupInfo){catalog.add((LayerGroupInfo)info);
else
if(infoinstanceofWMSLayerInfo){catalog.add((WMSLayerInfo)info);
else
if(infoinstanceofSettingsInfo){geoServer.add((SettingsInfo)info);
else
if(infoinstanceofServiceInfo){geoServer.add((ServiceInfo)info);
else{thrownewRuntimeException(String.format("Don'tknowhowtohandleinfooftype'%s'.",info.getClass().getSimpleName()));
if(infoinstanceofWorkspaceInfo){catalog.remove((WorkspaceInfo)info);
else
if(infoinstanceofNamespaceInfo){catalog.remove((NamespaceInfo)info);
else
if(infoinstanceofDataStoreInfo){catalog.remove((DataStoreInfo)info);
else
if(infoinstanceofCoverageStoreInfo){catalog.remove((CoverageStoreInfo)info);
else
if(infoinstanceofWMSStoreInfo){catalog.remove((WMSStoreInfo)info);
else
if(infoinstanceofFeatureTypeInfo){catalog.remove((FeatureTypeInfo)info);
else
if(infoinstanceofCoverageInfo){catalog.remove((CoverageInfo)info);
else
if(infoinstanceofLayerInfo){catalog.remove((LayerInfo)info);
else
if(infoinstanceofStyleInfo){catalog.remove((StyleInfo)info);
else
if(infoinstanceofLayerGroupInfo){catalog.remove((LayerGroupInfo)info);
else
if(infoinstanceofWMSLayerInfo){catalog.remove((WMSLayerInfo)info);
else
if(infoinstanceofSettingsInfo){geoServer.remove((SettingsInfo)info);
else
if(infoinstanceofServiceInfo){geoServer.remove((ServiceInfo)info);
else{thrownewRuntimeException(String.format("Don'tknowhowtohandleinfooftype'%s'.",info.getClass().getSimpleName()));
if(m_Iter!=null){returnm_Iter.hasNext();
else{returnfalse;
if(m_Iter!=null){
if(!m_Iter.hasNext()){thrownewNoSuchElementException();
else{thrownewIteratorException();
if(File.class.isAssignableFrom(type)){return(IConverter<C>)newFileLocator();
if(URL.class.isAssignableFrom(type)){return(IConverter<C>)newURLLocator();
if(URI.class.isAssignableFrom(type)){return(IConverter<C>)newURILocator();
if(value==null||"".equals(value)){returnnull;
if("file".equals(url.getProtocol())){value=url.getFile();
if(file.isAbsolute()){returnfile;
ifthefileisachildofthebasedatadirectoryList<String>path=newArrayList<String>();booleanisChild=false;while(file!=null){
if(file.equals(data)){isChild=true;break;
if(isChild){StringBufferb=newStringBuffer("file:");for(inti=path.size()-1;i>-1;i--){b.append(path.get(i)).append(File.separatorChar);
if(file!=null){try{returnfile.toURI().toURL();
if(file!=null&&!"".equals(file)){returnfromFile(newFile(value.getFile()));
if(file!=null){returnfile.toURI();
if(md.storesUpperCaseIdentifiers()){schema=schema.toUpperCase();pattern=pattern.toUpperCase();
if(buildingsPrefixedName.equals(pl.getName())){returntrue;
if(pl.getName().equals(prefixedName)){returnpl;
iffalseonlyADMINshavewrite*access.**@returnthegrantWriteToWorkspacesToAuthenticatedUsers*/publicbooleanisGrantWriteToWorkspacesToAuthenticatedUsers(){returngrantWriteToWorkspacesToAuthenticatedUsers;
iffalseonlyADMINshavewrite*access.**@paramgrantWriteToWorkspacesToAuthenticatedUsersthe*grantWriteToWorkspacesToAuthenticatedUserstoset*/publicvoidsetGrantWriteToWorkspacesToAuthenticatedUsers(booleangrantWriteToWorkspacesToAuthenticatedUsers){this.grantWriteToWorkspacesToAuthenticatedUsers=grantWriteToWorkspacesToAuthenticatedUsers;
if(acceptedRoles==null){acceptedRoles="";
if(colors==null)thrownewException("Classnumnotsetted,colorrampnull");returncolors;
iftrue,allgeometriesarewrittenasblocksandtheninsertedas*entities.Iffalse,simplegeometriesaredirectlywrittenasentities.-colors:(comma*delimitedlistofnumbers):colorstobeusedfortheDXFlayers,insequence.Iflayersaremore*thanthespecifiedcolors,theywillbereusedmanytimes.Asetofdefaultcolorsisused
ifthe*optionisnotused.ColorsareAutoCadcolornumbers(7=white,etc.).-ltypes:(commadelimited*listoflinetypedescriptors):linetypestobeusedfortheDXFlayers,insequence.Iflayers*aremorethanthespecifiedlinetypes,theywillbereusedmanytimes.Ifnotspecified,all*layerswillbegivenasolid,continuouslinetype.Adescriptorhasthefollowingformat:*<name>!<repeatablepattern>[!<baselength>],where<name>isthenameassignedtothelinetype,*<baselength>(optional)isarealnumberthattellshowlongiseachpartofthelinepattern*(defaultsto0.125),and<repeatablepattern>isavisualdescriptionoftherepeatablepartof*thelinepattern,asasequenceof-(solidline),*(dot)and_(emptyspace).-layers:(comma*delimitedlistofstrings)namestobeassignedtotheDXFlayers.Ifspecified,mustcontaina*nameforeachrequestedquery.Bydefaultastandardnamewillbeassignedtolayers.**<p>Adifferentlayerwillbegeneratedforeachrequestedquery.Layernamescanbechosenusing*thelayersformatoption,orinPOSTmode,usingthehandleattributeoftheQuerytag.Thename*oftheresultingfilecanbechosenusingthehandleattributeoftheGetFeaturetag.Bydefault,*thenamesoflayersconcatenatedwith_willbeused.**@authorMauroBartolomeoli,mbarto@infosia.it*/publicclassDXFOutputFormatextendsWFSGetFeatureOutputFormat{privatestaticfinalLoggerLOGGER=Logging.getLogger(DXFOutputFormat.class);publicstaticfinalSet<String>formats=newHashSet<String>();static{//listofsupportedoutputformatsformats.add("DXF");formats.add("DXF-ZIP");
if(outputFormat.equals("DXF"))return"dxf";//DXF-ZIPreturn"zip";
elsethenameisobtainedconcatenatinglayernameswithunderscoreasaseparator(up*toamaximumnamelength).*/privateStringgetFileName(Operationoperation){GetFeatureRequestrequest=GetFeatureRequest.adapt(operation.getParameters()[0]);
if(request.getHandle()!=null){LOGGER.log(Level.FINE,"Usinghandleforfilename:"+request.getHandle());returnrequest.getHandle();
if(layerNames.length()>20){LOGGER.log(Level.WARNING,"Calculatedfilenametoolong.Returingashorterone:"+layerNames.substring(0,20));returnlayerNames.substring(0,20);
if(toUpper){localName=localName.toUpperCase();
if(format.equals("dxf")){LOGGER.log(Level.FINE,"PlainDXFoutput");w=newBufferedWriter(newOutputStreamWriter(output));
else{LOGGER.log(Level.FINE,"ZippedDXFoutput");//DXF-ZIP:useazipstreamwrappedwiththebufferedwriterzipStream=newZipOutputStream(output);ZipEntryentry=newZipEntry(getFileName(operation)+".dxf");zipStream.putNextEntry(entry);w=newBufferedWriter(newOutputStreamWriter(zipStream));
if(gft.getFormatOptions().get("LAYERS")instanceofString){layers=((String)gft.getFormatOptions().get("LAYERS")).split(",");
else
if(gft.getFormatOptions().get("LAYERS")instanceofList){layers=(String[])((List)gft.getFormatOptions().get("LAYERS")).toArray(newString[0]);
if(layers!=null){for(intcount=0;count<layers.length;count++){layers[count]=layers[count].toUpperCase();
if(dxfWriter!=null){LOGGER.log(Level.INFO,"DXFWriter:"+dxfWriter.getDescription());
if(layers==null){layers=getLayerNames(gft.getQueries());
if(writeAttributes!=null){dxfWriter.setOption("writeattributes",writeAttributes.toLowerCase().equals("true"));
if(blocks!=null&&blocks.toLowerCase().equals("true"))dxfWriter.setOption("geometryasblock",true);//setoptionalcolors
if(colors!=null){try{String[]sColors=colors.split(",");int[]icolors=newint[sColors.length];for(intcount=0;count<sColors.length;count++)icolors[count]=Integer.parseInt(sColors[count]);dxfWriter.setOption("colors",icolors);
if(ltypes!=null){try{String[]sLTypes=ltypes.split(",");LineType[]ltypesArr=newLineType[sLTypes.length];for(intcount=0;count<sLTypes.length;count++)ltypesArr[count]=LineType.parse(sLTypes[count]);dxfWriter.setOption("linetypes",ltypesArr);
if(zipStream!=null){zipStream.closeEntry();zipStream.close();
elsethrownewUnsupportedOperationException("Version"+version+"notsupportedbydxfoutputformat");
if(selection.size()==0)return;dialog.setTitle(newParamResourceModel("confirmRemoval",this));//
ifthereissomethingtocancel,let'swarntheuseraboutwhat//couldgowrong,and
iftheuseraccepts,let'sdeletewhat'sneededdialog.showOkCancel(target,delegate=newGeoServerDialog.DialogDelegate(){protectedComponentgetContents(Stringid){//showaconfirmationpanelforalltheobjectswehavetoremoveModel<Boolean>model=newModel<Boolean>(SelectionUserRemovalLink.this.disassociateRoles);returnremovePanel=newConfirmRemovalUserPanel(id,model,selection){@OverrideprotectedIModel<String>canRemove(GeoServerUseruser){returnSelectionUserRemovalLink.this.canRemove(user);
if(disassociateRoles){try{gaStore=GeoServerApplication.get().getSecurityManager().getActiveRoleService().createStore();gaStore=newRoleStoreValidationWrapper(gaStore);for(GeoServerUseruser:removePanel.getRoots()){List<GeoServerRole>list=newArrayList<GeoServerRole>();list.addAll(gaStore.getRolesForUser(user.getUsername()));for(GeoServerRolerole:list)gaStore.disAssociateRoleFromUser(role,user.getUsername());
iftheselectionhasbeenclearedoutit'ssignadeletion//occurred,sorefreshthetable
if(users.getSelection().size()==0){setEnabled(false);target.add(SelectionUserRemovalLink.this);target.add(users);
ifthescalehintmustbeinunitsperdiagonalofa*pixel*@returnCapabilitiesas{@linkDocument}*/privateDocumentfindCapabilities(BooleanscaleHintUnitsPerDiaPixel)throwsException{//settheScalehintunitsperdiagonalpixelsetting.WMSwms=getWMS();WMSInfoinfo=wms.getServiceInfo();MetadataMapmm=info.getMetadata();mm.put(WMS.SCALEHINT_MAPUNITS_PIXEL,scaleHintUnitsPerDiaPixel);info.getGeoServer().save(info);Capabilities_1_3_0_Transformertr=newCapabilities_1_3_0_Transformer(wms,BASE_URL,wms.getAllowedMapFormats(),newHashSet<ExtendedCapabilitiesProvider>());GetCapabilitiesRequestreq=newGetCapabilitiesRequest();req.setBaseUrl(BASE_URL);req.setVersion(WMS.VERSION_1_3_0.toString());Documentdom=WMSTestSupport.transform(req,tr);Elementroot=dom.getDocumentElement();assertEquals(WMS.VERSION_1_3_0.toString(),root.getAttribute("version"));returndom;
if(layerRequired.equalsIgnoreCase(nodeValue)){return(Element)e.getParentNode();//returnsthelayerelementassociatedtothe//requiredlayername.
if(item.getType()!=null){returnitem.getType().getSimpleName();
if(adinstanceofGeometryDescriptor){GeometryDescriptorgd=(GeometryDescriptor)ad;
if(gd.getUserData().get(JDBCDataStore.JDBC_NATIVE_SRID)!=null){at.setSrid((Integer)gd.getUserData().get(JDBCDataStore.JDBC_NATIVE_SRID));
else
if(gd.getCoordinateReferenceSystem()!=null){try{at.setSrid(CRS.lookupEpsgCode(gd.getCoordinateReferenceSystem(),false));
if(vt!=null&&vt.getGeometries().contains(attName)){at.setSrid(vt.getNativeSrid(attName));at.setType(vt.getGeometryType(attName));
if(vt!=null&&vt.getPrimaryKeyColumns()!=null&&vt.getPrimaryKeyColumns().contains(attName)){at.setPk(true);
if(Geometry.class.isAssignableFrom(att.getType())){
if(att.getSrid()==null){vt.addGeometryMetadatata(att.getName(),(Class<?extendsGeometry>)att.getType(),4326);
else{vt.addGeometryMetadatata(att.getName(),(Class<?extendsGeometry>)att.getType(),att.getSrid());
if(att.pk){pks.add(att.getName());
if(pks.size()>0){vt.setPrimaryKeyColumns(pks);
if(this.contactEmail!=null&&!this.contactEmail.isEmpty()){//thisfieldisdeprecateusecontactEmail
ifavailablereturncontactEmail;
if(this.contactEmail==null||this.contactEmail.isEmpty()){//thisfieldisdeprecate-migratevaluetocontactEmail
ifavailablethis.contactEmail=addressElectronicMailAddress;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofContactInfo))returnfalse;finalContactInfoother=(ContactInfo)obj;
if(address==null){
if(other.getAddress()!=null)returnfalse;
else
if(!address.equals(other.getAddress()))returnfalse;
if(addressCity==null){
if(other.getAddressCity()!=null)returnfalse;
else
if(!addressCity.equals(other.getAddressCity()))returnfalse;
if(addressCountry==null){
if(other.getAddressCountry()!=null)returnfalse;
else
if(!addressCountry.equals(other.getAddressCountry()))returnfalse;
if(addressPostalCode==null){
if(other.getAddressPostalCode()!=null)returnfalse;
else
if(!addressPostalCode.equals(other.getAddressPostalCode()))returnfalse;
if(addressState==null){
if(other.getAddressState()!=null)returnfalse;
else
if(!addressState.equals(other.getAddressState()))returnfalse;
if(addressType==null){
if(other.getAddressType()!=null)returnfalse;
else
if(!addressType.equals(other.getAddressType()))returnfalse;
if(contactEmail==null){
if(other.getContactEmail()!=null)returnfalse;
else
if(!contactEmail.equals(other.getContactEmail()))returnfalse;
if(contactFacsimile==null){
if(other.getContactFacsimile()!=null)returnfalse;
else
if(!contactFacsimile.equals(other.getContactFacsimile()))returnfalse;
if(contactOrganization==null){
if(other.getContactOrganization()!=null)returnfalse;
else
if(!contactOrganization.equals(other.getContactOrganization()))returnfalse;
if(contactPerson==null){
if(other.getContactPerson()!=null)returnfalse;
else
if(!contactPerson.equals(other.getContactPerson()))returnfalse;
if(contactPosition==null){
if(other.getContactPosition()!=null)returnfalse;
else
if(!contactPosition.equals(other.getContactPosition()))returnfalse;
if(contactVoice==null){
if(other.getContactVoice()!=null)returnfalse;
else
if(!contactVoice.equals(other.getContactVoice()))returnfalse;
if(onlineResource==null){
if(other.getOnlineResource()!=null)returnfalse;
else
if(!onlineResource.equals(other.getOnlineResource()))returnfalse;
if(addressDeliveryPoint==null){
if(other.getAddressDeliveryPoint()!=null)returnfalse;
else
if(!addressDeliveryPoint.equals(other.getAddressDeliveryPoint()))returnfalse;returntrue;}}
if(securityManager==null){LOGGER.severe("securityManagerisnull!");return;
if(loadedConfig==null){LOGGER.warning("Configurationfilenotfound,creatingdefaultconfig");//config:createadefaultoneGeoFenceAuthenticationProviderConfigdefaultConfig=newGeoFenceAuthenticationProviderConfig();defaultConfig.setName("geofence");defaultConfig.setClassName(GeoFenceAuthenticationProvider.class.getName());securityManager.saveAuthenticationProvider(defaultConfig);
if(coverage!=null){ImageUtilities.disposeImage(coverage.getRenderedImage());
if(reader!=null){reader.dispose();
if(imageReader!=null){try{imageReader.dispose();
if((c>'')&&(c<'{')&&("\"\\<>%^[]`+$,".indexOf(c)==-1)){sb.append(c);
else{sb.append("%").append(Integer.toHexString(c));
if(file.isDirectory()){File[]files=file.listFiles();for(inti=0;i<files.length;i++){delete(files[i]);
if(parser.getKey().equalsIgnoreCase("format_options")){formatOptionsParser=parser;break;
if(formatOptionsParser==null){thrownewIllegalStateException("Missingformatoptionsparser.");
if(!skipHole(hole,scale)){//callholesremovertocutthecurrentholeHolesRemoverremover=newHolesRemover(result,hole,gFac);result=remover.cutHole();
ifholeareaislessthanthetolerance,skipit
if(holePoly.getArea()<HOLE_AREA_TOLERANCE*scale*scale)returntrue;returnfalse;
if(v.getPosition().x>rightMostHoleVertex.getPosition().x)rightMostHoleVertex=v;
if((a.getPosition().x>rightMostHoleVertex.getPosition().x||b.getPosition().x>rightMostHoleVertex.getPosition().x)&&((a.getPosition().y>=rightMostHoleVertex.getPosition().y&&b.getPosition().y<=rightMostHoleVertex.getPosition().y)||(a.getPosition().y<=rightMostHoleVertex.getPosition().y&&b.getPosition().y>=rightMostHoleVertex.getPosition().y)))segmentsToTest.add(newLineSegment(a,b));
if(intersection!=null){
if(closestPoint==null||closestPoint.floatValue()>intersection.floatValue()){closestPoint=intersection;closestSegment=segment;
ifclosestPointisnull,therewerenocollisions(likelyfromimproperinputdata),//butwe'lljustreturnwithoutdoinganything
else
if(closestPoint==null)returnshapeVerts;//otherwisewecanfindourmutuallyvisiblevertextosplitthepolygonCoordinateI=rightMostHoleVertex.getPosition();GVectori=newGVector(newdouble[]{I.x,I.y});i.add(newGVector(newdouble[]{closestPoint.floatValue(),0.0}));VertexP=(closestSegment.A.getPosition().x>closestSegment.B.getPosition().x)?closestSegment.A:closestSegment.B;//constructtriangleMIPTrianglemip=newTriangle(rightMostHoleVertex,newVertex(I,1),P);//see
ifanyofthereflexverticeslieinsideoftheMIPtriangleArrayListinteriorReflexVertices=newArrayList();for(intcount=0;count<reflexVertices.size();count++){Vertexv=(Vertex)reflexVertices.get(count);
if(mip.ContainsPoint(v))interiorReflexVertices.add(v);
ifthereareanyinteriorreflexvertices,findtheonethat,whenconnected//toourrightMostHoleVertex,formsthelineclosesttoVector2.UnitX
if(interiorReflexVertices.size()>0){floatclosestDot=-1f;for(intcount=0;count<interiorReflexVertices.size();count++){Vertexv=(Vertex)interiorReflexVertices.get(count);GVectorn=newGVector(newdouble[]{v.getPosition().x,v.getPosition().y});n.sub(newGVector(newdouble[]{rightMostHoleVertex.getPosition().x,rightMostHoleVertex.getPosition().y}));n.normalize();GVectorm=newGVector(newdouble[]{1.0,0.0});floatdot=(float)m.dot(n);//
ifthislineistheclosestwe'vefound
if(dot>closestDot){//savethevalueandsavethevertexasPclosestDot=dot;P=v;
if(isConvex(v)){convexVertices.add(v);
else{reflexVertices.add(v);
if(determineWindingOrder(vertices)!=windingOrder){returnreverseWindingOrder(vertices);
if(e1.getElement(0)*e2.getElement(1)-e1.getElement(1)*e2.getElement(0)>=0)clockWiseCount++;
elsecounterClockWiseCount++;p1=p2;
if(hasMore){count++;
else{metrics.get().put("total",System.currentTimeMillis()-start);metrics.get().put("count",count);
ifnoneisfound,usethe//defaultoneconfigurator=GeoServerExtensions.bean(ControlFlowConfigurator.class,applicationContext);
if(configurator==null){configurator=newDefaultControlFlowConfigurator();
if(controllers.size()==0){LOGGER.info("Control-flowinactive,therearenoconfiguredrules");
ifweneedtorebuildtheflowcontrollerlist
if(configurator.isStale()){//becareful,astheconfigurationcanbereadondemand,it'dnotbeuncommonthat//multiplerequestscomeatoncewhentheconfigfilechangedsynchronized(configurator){
if(configurator.isStale()){reloadConfiguration();
if(controllersCount>0){LOGGER.info("Control-flowactivewith"+controllersCount+"flowcontrollers");
else{LOGGER.info("Control-flowinactive,therearenoconfiguredrules");
if(namespaces==null){namespaces=newNamespaceSupport();
if(qname.getNamespaceURI()==null){thrownewServiceException("Typename"+tn+"hasnoprefix,butthereisnodefaultprefix"+"declaredintheNAMESPACEparameter",ServiceException.INVALID_PARAMETER_VALUE,"typename");
if(elements.length!=3){return"Invalidrule"+ruleKey+",theexpectedformatisworkspace.layer.mode=role1,role2,...";
if(mode==null){return"Unknownaccessmode"+modeAlias+"in"+ruleKey;
if(ANY.equals(workspace)){
if(!ANY.equals(layerName)){return"Invalidrule"+ruleKey+",whennamespace"+"is*thenalsolayermustbe*.";
if(mode==AccessMode.ADMIN&&!ANY.equals(layerName)){return"Invalidrule"+ruleKey+",admin(a)privilegesmayonlybeapplied"+"globallytoaworkspace,layermustbe*.";
if(setRequiredFields){config.setServerURL(ldapServerUrl+"/"+basePath);config.setGroupSearchBase(GROUPS_BASE);config.setUserSearchBase(USERS_BASE);
ifneeded,forthecanceloneaswell)**@paramtarget*@paramdelegate*/publicvoidshowOkCancel(AjaxRequestTargettarget,finalDialogDelegatedelegate){//wireupthecontentsuserPanel=delegate.getContents("userPanel");window.setContent(newContentsPage(userPanel));//makesureclose==cancelbehaviorwisewindow.setCloseButtonCallback(newModalWindow.CloseButtonCallback(){publicbooleanonCloseButtonClicked(AjaxRequestTargettarget){returndelegate.onCancel(target);
if(delegate.onSubmit(target,contents)){close(target);
if(delegate.onCancel(target)){window.close(target);delegate=null;
if(component.getOutputMarkupId()){target.add(component);
ifthedialogistobeclosed,falseotherwise*/protectedabstractbooleanonSubmit(AjaxRequestTargettarget,Componentcontents);/***Calledwhenthedialogiscancelled.**@paramtarget*@returntrue
ifthedialogistobeclosed,falseotherwise*/protectedbooleanonCancel(AjaxRequestTargettarget){returntrue;
if(queryMap!=null){String[]params=queryMap.get("expand");
if(params!=null&&params.length>0){ex=params[0];
if(expand==null){returndef;
if(top){json.object().key("import");
if(context.getMessage()!=null){json.key("message").value(context.getMessage());
if(expand>0){json.key("archive").value(context.isArchive());
if(context.getTargetWorkspace()!=null){json.key("targetWorkspace").value(toJSON(context.getTargetWorkspace()));
if(context.getTargetStore()!=null){json.key("targetStore");store(json,context.getTargetStore(),null,false,expand-1);//value(toJSON(context.getTargetStore()));
if(context.getData()!=null){json.key("data");data(json,context.getData(),context,expand-1);
if(!context.getDefaultTransforms().isEmpty()){transforms(json,context,expand-1,context.getDefaultTransforms());
if(top){json.endObject();
if(top){json.object();
if(top){json.endObject();
if(top){json.object().key("task");
if(expand>0){json.key("updateMode").value(task.getUpdateMode().name());//data(usedtobesource)ImportDatadata=task.getData();
if(data!=null){json.key("data");data(json,data,task,expand-1);
if(store!=null){json.key("target");store(json,store,task,false,expand-1);
if(layer!=null){//@tododon'tknowwhycatalogisn'tsethere,thoughtthiswassetduringload//fromBDBImportStorelayer.getResource().setCatalog(importer.getCatalog());json.key("layer");layer(json,task,false,expand-1);
if(task.getError()!=null){json.key("errorMessage").value(concatErrorMessages(task.getError()));
if(top){json.endObject();
if(task!=null){json.key("href").value(RequestInfo.get().servletURI(pathTo(task)+"/target"));
if(expand>0){JSONObjectobj=toJSON(store);json.key(type).value(obj.get(type));
else{json.key(type).object().key("name").value(store.getName()).key("type").value(store.getType()).endObject();
if(top){json.object().key("layer");
if(expand>0){
if(r.getTitle()!=null){json.key("title").value(r.getTitle());
if(r.getAbstract()!=null){json.key("abstract").value(r.getAbstract());
if(r.getDescription()!=null){json.key("description").value(r.getDescription());
if(r!=null){json.key("nativeName").value(r.getNativeName());
if(r.getSRS()!=null){json.key("srs").value(r.getSRS());
if(r.getNativeBoundingBox()!=null){json.key("bbox");bbox(json,r.getNativeBoundingBox());
if(rinstanceofFeatureTypeInfo){featureType(json,(FeatureTypeInfo)r);
if(s!=null){style(json,s,task,false,expand-1);
if(top){json.endObject();
if(top){json.object();
if(expand>0){JSONObjectobj=toJSON(style).getJSONObject("style");obj.put("href",href);json.value(obj);
else{json.object();json.key("name").value(style.getName());json.key("href").value(href);json.endObject();
if(top){json.endObject();
if(top){json.object();
if(top){json.endObject();
if(expand>0){
if(transforminstanceofDateFormatTransform){DateFormatTransformdf=(DateFormatTransform)transform;json.key("field").value(df.getField());
if(df.getDatePattern()!=null){json.key("format").value(df.getDatePattern().dateFormat().toPattern());
if(df.getEnddate()!=null){json.key("enddate").value(df.getEnddate());
if(df.getPresentation()!=null){json.key("presentation").value(df.getPresentation());
else
if(transforminstanceofIntegerFieldToDateTransform){IntegerFieldToDateTransformdf=(IntegerFieldToDateTransform)transform;json.key("field").value(df.getField());
else
if(transforminstanceofCreateIndexTransform){CreateIndexTransformdf=(CreateIndexTransform)transform;json.key("field").value(df.getField());
else
if(transforminstanceofAttributeRemapTransform){AttributeRemapTransformart=(AttributeRemapTransform)transform;json.key("field").value(art.getField());json.key("target").value(art.getType().getName());
else
if(transforminstanceofAttributeComputeTransform){AttributeComputeTransformact=(AttributeComputeTransform)transform;json.key("field").value(act.getField());json.key("fieldType").value(act.getType().getName());json.key("cql").value(act.getCql());
else
if(transform.getClass()==AttributesToPointGeometryTransform.class){AttributesToPointGeometryTransformatpgt=(AttributesToPointGeometryTransform)transform;json.key("latField").value(atpgt.getLatField());json.key("lngField").value(atpgt.getLngField());
else
if(transform.getClass()==ReprojectTransform.class){ReprojectTransformrt=(ReprojectTransform)transform;json.key("source").value(srs(rt.getSource()));json.key("target").value(srs(rt.getTarget()));
else
if(transform.getClass().equals(GdalTranslateTransform.class)){GdalTranslateTransformgtx=(GdalTranslateTransform)transform;List<String>options=gtx.getOptions();buildJsonOptions(json,"options",options);
else
if(transform.getClass().equals(GdalWarpTransform.class)){GdalWarpTransformgw=(GdalWarpTransform)transform;List<String>options=gw.getOptions();buildJsonOptions(json,"options",options);
else
if(transform.getClass().equals(GdalAddoTransform.class)){GdalAddoTransformgad=(GdalAddoTransform)transform;List<String>options=gad.getOptions();buildJsonOptions(json,"options",options);JSONBuilderarrayBuilder=json.key("levels").array();for(Integerlevel:gad.getLevels()){arrayBuilder.value(level);
else
if(transform.getClass().equals(PostScriptTransform.class)){PostScriptTransformpst=(PostScriptTransform)transform;List<String>options=pst.getOptions();json.key("name").value(pst.getName());buildJsonOptions(json,"options",options);
else{thrownewIOException("Serializaitonof"+transform.getClass()+"notimplemented");
if(options!=null){JSONBuilderarrayBuilder=json.key(key).array();for(Stringoption:options){arrayBuilder.value(option);
if(crs!=null){json.key("crs").value(crs.toWKT());
if(datainstanceofFileData){
if(datainstanceofDirectory){
if(datainstanceofMosaic){mosaic(json,(Mosaic)data,parent,expand);
else{directory(json,(Directory)data,parent,expand);
else{file(json,(FileData)data,parent,expand,false);
else
if(datainstanceofDatabase){database(json,(Database)data,parent,expand);
else
if(datainstanceofTable){table(json,(Table)data,parent,expand);
else
if(datainstanceofRemoteData){remote(json,(RemoteData)data,parent,expand);
else{thrownewIllegalArgumentException("Unabletoserialize"+data.getClass().getSimpleName()+"asImportData");
if(data.getUsername()!=null){json.key("username").value(data.getUsername());
if(data.getPassword()!=null){json.key("password").value(data.getPassword());
if(data.getDomain()!=null){json.key("domain").value(data.getDomain());
if(href){json.key("href").value(RequestInfo.get().servletURI(pathTo(data,parent)));
if(expand>0){json.key("location").value(location);
if(data.getCharsetEncoding()!=null){json.key("charset").value(data.getCharsetEncoding());
else{json.key("file").value(data.getFile().getName());
if(expand>0){
if(datainstanceofSpatialFile){SpatialFilesf=(SpatialFile)data;json.key("prj").value(sf.getPrjFile()!=null?sf.getPrjFile().getName():null);json.key("other").array();for(Filesupp:((SpatialFile)data).getSuppFiles()){json.value(supp.getName());
if(sfinstanceofGranule){Granuleg=(Granule)sf;
if(g.getTimestamp()!=null){json.key("timestamp").value(DATE_FORMAT.format(g.getTimestamp()));
if(data.getFormat()!=null){json.key("format").value(data.getFormat().getName());
if(expand>0){
if(data.getCharsetEncoding()!=null){json.key("charset").value(data.getCharsetEncoding());
if(top){json.object().key("files");
if(top){json.endObject();
if(expand>0){json.key("parameters").object();for(Map.Entry<String,Serializable>e:data.getParameters().entrySet()){json.key(e.getKey()).value(e.getValue());
if(data.getMessage()!=null){json.key("message").value(data.getMessage());
if(!records.isEmpty()){json.key("messages");json.array();for(inti=0;i<records.size();i++){LogRecordrecord=records.get(i);json.object();json.key("level").value(record.getLevel().toString());json.key("message").value(record.getMessage());json.endObject();
if(buf.length()>0){buf.append('\n');
if(ex.getMessage()!=null){buf.append(ex.getMessage());
if(callback!=null){xp.setCallback(callback);
if(parentinstanceofImportContext){returnpathTo((ImportContext)parent);
else
if(parentinstanceofImportTask){returnpathTo((ImportTask)parent);
else{thrownewIllegalArgumentException("Don'trecognize:"+parent);
if(batch!=null){dao.delete(batch);
if(config!=null){dao.delete(config);
ifitdoesnotexist*@throwsIOException*/ResourcefindConfigFile()throwsIOException{finalResourceconfigFile=resourceLoader.get(GWC_CONFIG_FILE);returnconfigFile;
if(config==null){try{loadConfig();
ifnooutputformathasbeenfoundontheGetMaprequest*/publicstaticfinalStringGIF_ANIMATED_FORMAT="image/gif;subtype=animated";/**webmapservice*/WebMapServicewms;/**TheWMSconfiguration*/WMSwmsConfiguration;/***TheprototypeConstructor**@paramwms*@paramwmsConfiguration*/publicAnimator(WebMapServicewms,WMSwmsConfiguration){this.wms=wms;this.wmsConfiguration=wmsConfiguration;
if(frameCatalog==null){thrownewRuntimeException("Animatorinitializationerror!");
ifnotspecified
if(request.getFormat()==null){request.setFormat(GIF_ANIMATED_FORMAT);
ifwehaveacaseoflayersbeingtheparam,stickthefirstvalueintotherequest
if(frameCatalog.getParameter().equalsIgnoreCase("LAYERS")){List<String>layers0=Arrays.asList(frameCatalog.getValues()[0].replaceAll("\\\\,",",").split("\\s*,\\s*"));LayerParserparser=newLayerParser(wmsConfiguration);List<MapLayerInfo>layers=parser.parseLayerInfos(layers0,request.getRemoteOwsURL(),request.getRemoteOwsType());request.setLayers(layers);
ifwehaveacaseoflayersbeingtheparam,weshouldalsotrytogetuniform//widthandheightandbbox
if(frameCatalog.getParameter().equalsIgnoreCase("LAYERS")){Envelopebbox=request.getBbox();request.getRawKvp().put("BBOX",bbox.getMinX()+","+request.getBbox().getMinY()+","+request.getBbox().getMaxX()+","+request.getBbox().getMaxY());request.getRawKvp().put("WIDTH",String.valueOf(request.getWidth()));request.getRawKvp().put("HEIGHT",String.valueOf(request.getHeight()));
if(oinstanceofLayerInfo){layers.add(newMapLayerInfo((LayerInfo)o));
else
if(oinstanceofLayerGroupInfo){for(LayerInfol:((LayerGroupInfo)o).layers()){layers.add(newMapLayerInfo(l));
else
if(oinstanceofMapLayerInfo){//itwasaremoteOWSlayer,additdirectlylayers.add((MapLayerInfo)o);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;GetExecutionStatusTypeother=(GetExecutionStatusType)obj;
if(baseUrl==null){
if(other.baseUrl!=null)returnfalse;
else
if(!baseUrl.equals(other.baseUrl))returnfalse;
if(executionId==null){
if(other.executionId!=null)returnfalse;
else
if(!executionId.equals(other.executionId))returnfalse;
if(service==null){
if(other.service!=null)returnfalse;
else
if(!service.equals(other.service))returnfalse;
if(version==null){
if(other.version!=null)returnfalse;
else
if(!version.equals(other.version))returnfalse;returntrue;}}
if(langs==null){try{langs=getAvailableLanguages();
if(masterpw.getType()==Type.RESOURCE){init(loadMasterPasswordConfig());
else{//
ifitdoesn'texistthismustbeamigrationstartup...andthiscaseshouldbe//handledduringmigrationwhereallthedatastorepasswordsareprocessed//explicitly
if(eventPublisher!=null){providerMgr.setAuthenticationEventPublisher(this.eventPublisher);
if(eventinstanceofContextLoadedEvent){reload();
if(eventinstanceofContextClosedEvent){try{destroy();
if(masterPasswordInfo.getType()!=Type.UNDEFINED){LOGGER.warning(masterPasswordInfo.path()+"isasecurityrisk.Pleasereadthisfileandremoveitafterward");
if(securityVersion.compareTo(VERSION_2_2)<0){migratedFrom21=migrateFrom21();
if(securityVersion.compareTo(VERSION_2_3)<0){removeErroneousAccessDeniedPage();migrateFrom22(migratedFrom21);
if(securityVersion.compareTo(VERSION_2_4)<0){migrateFrom23();
if(securityVersion.compareTo(VERSION_2_5)<0){migrateFrom24();
if(securityVersion.compareTo(CURR_VERSION)<0){writeCurrentVersion();
ifthereisanoutstandingmasterpasswordchangeincaseofSPrininjectioninit();for(GeoServerSecurityProvidersecurityProvider:GeoServerExtensions.extensions(GeoServerSecurityProvider.class)){securityProvider.init(this);
if(security.getType()==Type.UNDEFINED){returnBASE_VERSION;
if(properties.getType()==Type.UNDEFINED){returnBASE_VERSION;
if(version!=null){returnnewVersion(version);
else{returnBASE_VERSION;
if(rs!=null){writer.setValue(rs.toString());
if(reader.getValue()!=null){returnJ2EERoleSource.valueOf(reader.getValue());
if(fConfig!=null){
if(fConfiginstanceofJ2eeAuthenticationBaseFilterConfig){J2eeAuthenticationBaseFilterConfigj2eeConfig=(J2eeAuthenticationBaseFilterConfig)fConfig;//adddefaultJ2EERoleSourcethatwastheonlyonepossible//before2.5
if(j2eeConfig.getRoleSource()==null){j2eeConfig.setRoleSource(J2EERoleSource.J2EE);
else
if(fConfiginstanceofPreAuthenticatedUserNameFilterConfig){PreAuthenticatedUserNameFilterConfiguserNameConfig=(PreAuthenticatedUserNameFilterConfig)fConfig;RoleSourcers=userNameConfig.getRoleSource();
if(rs!=null){//usetherightRoleSourceenumuserNameConfig.setRoleSource(PreAuthenticatedUserNameRoleSource.valueOf(rs.toString()));
if(!roleService.isConfigured()){//roleService=null;//
if(roleService==null){try{roleService=loadRoleService("default");
if(!config.getAuthProviderNames().isEmpty()){for(StringauthProviderName:config.getAuthProviderNames()){//TODO:handlefailurehere...perhapssimplydisablingwhenauthprovider//failstoload?GeoServerAuthenticationProviderauthProvider=authProviderHelper.load(authProviderName);authProviders.add(authProvider);
if(config.isAnonymousAuth()){//AnonymousAuthenticationProvideraap=newAnonymousAuthenticationProvider();//aap.setKey("geoserver");//aap.afterPropertiesSet();//allAuthProviders.add(aap);//
if(keyStoreProvider==null){synchronized(this){
if(keyStoreProvider==null){keyStoreProvider=lookupKeyStoreProvider();
if(ksp==null){//usedefaultkeystoreproviderksp=newKeyStoreProviderImpl();
if(authCache==null){synchronized(this){
if(authCache==null){authCache=lookupAuthenticationCache();
if(rememberMeService==null){synchronized(this){
if(rememberMeService==null){rememberMeService=lookupRememberMeService();
ifthesecuritymanagerhasbeeninitializedyet.**<p>TODO:thisisatemporaryhack,perhapsweshouldthinkaboutinitializingthesecurity*subsystemastheveryfirstthingonstartup...butnowwehavedependenciesonthecatalog*sowecant.*/publicbooleanisInitialized(){returninitialized;
if(create){returndirectory.dir();
else{returnResources.directory(directory);
if(roleService==null){synchronized(this){roleService=roleServices.get(name);
if(roleService==null){roleService=roleServiceHelper.load(name);
if(roleService!=null){roleServices.put(name,roleService);
if(!initialized){//startingupreturnroleService;
if(checkAuthenticationForAdminRole(auth)){//admin,noneedtowrapreturnroleService;
if(checkAuthenticationForRole(auth,GeoServerRole.GROUP_ADMIN_ROLE)){roleService=newGroupAdminRoleService(roleService,calculateAdminGroups((UserDetails)auth.getPrincipal()));
if(userDetailsinstanceofGeoServerUser){Propertiesprops=((GeoServerUser)userDetails).getProperties();
if(GroupAdminProperty.has(props)){returnArrays.asList(GroupAdminProperty.get(props));
if(user!=null){for(GeoServerUserGroupgroup:ugService.getGroupsForUser(user)){groupNames.add(group.getGroupname());
ifnotfound**@paramnameThenameoftheroleserviceconfiguration.*/publicSecurityRoleServiceConfigloadRoleServiceConfig(Stringname)throwsIOException{returnroleServiceHelper.loadConfig(name);
if(validator==null){synchronized(this){validator=passwordValidators.get(name);
if(validator==null){validator=passwordValidatorHelper.load(name);
if(validator!=null){passwordValidators.put(name,validator);
ifnotfound**@paramnameThenameofthepasswordpolicyconfiguration.*/publicPasswordPolicyConfigloadPasswordPolicyConfig(Stringname)throwsIOException{returnpasswordValidatorHelper.loadConfig(name);
ifnonfoundmatchingthename.*/publicGeoServerPasswordEncoderloadPasswordEncoder(Stringname){GeoServerPasswordEncoderencoder=(GeoServerPasswordEncoder)GeoServerExtensions.bean(name);
if(encoder!=null){try{encoder.initialize(this);
ifareversibleencoderisrequired,trueforces*reversible,falseforcesirreversible,nullmeanseither.*@paramstrongFlagindicating
ifanencoderthatsupportsstrongencryptionisrequired,true*forcesstrongencryption,falseforcesweakencryption,nullmeanseither.*@returnThefirstencodermatching,ornull
ifnonewasfound.*/public<TextendsGeoServerPasswordEncoder>TloadPasswordEncoder(Class<T>filter,Booleanreversible,Booleanstrong){List<T>pw=loadPasswordEncoders(filter,reversible,strong);returnpw.isEmpty()?null:pw.get(0);
ifareversibleencoderisrequired,trueforces*reversible,falseforcesirreversible,nullmeanseither.*@paramstrongFlagindicating
ifanencoderthatsupportsstrongencryptionisrequired,true*forcesstrongencryption,falseforcesweakencryption,nullmeanseither.*@returnAllmatchingencoders,oranemptylist.*/public<TextendsGeoServerPasswordEncoder>List<T>loadPasswordEncoders(Class<T>filter,Booleanreversible,Booleanstrong){filter=(Class<T>)(filter!=null?filter:GeoServerPasswordEncoder.class);Listlist=GeoServerExtensions.extensions(filter);for(Iteratorit=list.iterator();it.hasNext();){booleanremove=false;Tpw=(T)it.next();
if(reversible!=null&&!reversible.equals(pw.isReversible())){remove=true;
if(!remove&&strong!=null&&strong.equals(pw.isAvailableWithoutStrongCryptogaphy())){remove=true;
if(remove){it.remove();
else{try{pw.initialize(this);
ifstrongencryptionisavailable.**<p>ThismethoddoesthedeterminationbytryingtoencryptavaluewithAES256Bit*encryption.**@returnTrue
ifstrongencryptionavaialble,otherwisefalse.*/publicbooleanisStrongEncryptionAvailable(){
if(strongEncryptionAvaialble!=null)returnstrongEncryptionAvaialble;KeyGeneratorkgen;try{kgen=KeyGenerator.getInstance("AES");kgen.init(256);SecretKeyskey=kgen.generateKey();byte[]raw=skey.getEncoded();SecretKeySpecskeySpec=newSecretKeySpec(raw,"AES");Ciphercipher=Cipher.getInstance("AES");cipher.init(Cipher.ENCRYPT_MODE,skeySpec);cipher.doFinal("Thisisjustanexample".getBytes());strongEncryptionAvaialble=true;LOGGER.info("Strongcryptographyisavailable");
if(config.getId()==null){config.initBeforeSave();validator.validateAddRoleService(config);
else{validator.validateModifiedRoleService(config,roleServiceHelper.loadConfig(config.getName()));
if(activeRoleService!=null&&config.getName().equals(activeRoleService.getName())){synchronized(activeRoleService){activeRoleService.initializeFromConfig(config);
if(config.getId()==null){config.initBeforeSave();validator.validateAddPasswordPolicy(config);
else{validator.validateModifiedPasswordPolicy(config,passwordValidatorHelper.loadConfig(config.getName()));
if(ugService==null){synchronized(this){ugService=userGroupServices.get(name);
if(ugService==null){ugService=userGroupServiceHelper.load(name);
if(ugService!=null){userGroupServices.put(name,ugService);
if(!initialized){//startingupreturnugService;
if(checkAuthenticationForAdminRole(auth)){//fulladmin,noneedtowrapreturnugService;
if(checkAuthenticationForRole(auth,GeoServerRole.GROUP_ADMIN_ROLE)){ugService=newGroupAdminUserGroupService(ugService,calculateAdminGroups((UserDetails)auth.getPrincipal()));
ifnotfoun**@paramnameThenameoftheusergroupserviceconfiguration.*/publicSecurityUserGroupServiceConfigloadUserGroupServiceConfig(Stringname)throwsIOException{returnuserGroupServiceHelper.loadConfig(name);
if(config.getId()==null){config.initBeforeSave();validator.validateAddUserGroupService(config);
else{validator.validateModifiedUserGroupService(config,userGroupServiceHelper.loadConfig(config.getName()));
ifnot*found**@paramnameThenameoftheauthenticationproviderserviceconfiguration.*/publicSecurityAuthProviderConfigloadAuthenticationProviderConfig(Stringname)throwsIOException{returnauthProviderHelper.loadConfig(name);
if(config.getId()==null){config.initBeforeSave();validator.validateAddAuthProvider(config);
else{validator.validateModifiedAuthProvider(config,authProviderHelper.loadConfig(config.getName()));
if(authProviders!=null){GeoServerAuthenticationProviderauthProvider=null;for(GeoServerAuthenticationProviderap:authProviders){
if(config.getName().equals(ap.getName())){authProvider=ap;break;
if(authProvider!=null){synchronized(authProvider){authProvider.initializeFromConfig(config);
ifthecurrentlyauthenticateduserhastheadministratorrole.**<p>Thismethodisshorthandfor:<code>*<pre>*checkAuthenticationForAdminRole(SecurityContextHolder.getContext().getAuthentication())*</pre>*</code>*/publicbooleancheckAuthenticationForAdminRole(){
if(SecurityContextHolder.getContext()==null)returncheckAuthenticationForAdminRole(null);
elsereturncheckAuthenticationForAdminRole(SecurityContextHolder.getContext().getAuthentication());
ifthespecifiedauthenticationhastheadministratorrole.**<p>Thismethodisshorthandfor:<code>*<pre>*checkAuthenticationForRole(auth,GeoServerRole.ADMIN_ROLE)*</pre>*</code>*/publicbooleancheckAuthenticationForAdminRole(Authenticationauth){returncheckAuthenticationForRole(auth,GeoServerRole.ADMIN_ROLE);
ifthespecifiedauthenticationcontainsthespecifiedrole.**Ifthecurrent{@linkHttpServletRequest}hassecuritydisabled,*thismethodalwaysreturns<code>true</code>.**@return<code>true</code>
iftheauthenticatedcontainstherole,otherwise<code>false</false>*/publicbooleancheckAuthenticationForRole(Authenticationauth,GeoServerRolerole){
if(GeoServerSecurityFilterChainProxy.isSecurityEnabledForCurrentRequest()==false)returntrue;//Nosecuritymeansanyroleisgranted
if(auth==null||!auth.isAuthenticated()){returnfalse;
if(role.getAuthority().equals(authority.getAuthority())){returntrue;
ifthedefaultpasswordforthe{@LinkGeoServerUser#ADMIN_USERNAME}hasnot*beenchanged.*/publicbooleancheckForDefaultAdminPassword(){Authenticationtoken=newUsernamePasswordAuthenticationToken(GeoServerUser.ADMIN_USERNAME,GeoServerUser.DEFAULT_ADMIN_PASSWD);try{token=providerMgr.authenticate(token);
if(config.getClassName()==null){continue;
if(type.isAssignableFrom(Class.forName(config.getClassName()))){configs.add(config.getName());
ifnotfound**@paramnameThenameoftheauthenticationproviderserviceconfiguration.*@parammigrationHelperOptionalhelperusedformigrationpurposes*/publicSecurityFilterConfigloadFilterConfig(Stringname,MigrationHelpermigrationHelper)throwsIOException{returnfilterHelper.loadConfig(name,migrationHelper);
ifnotfound**@paramnameThenameoftheauthenticationproviderserviceconfiguration.*/publicSecurityFilterConfigloadFilterConfig(Stringname)throwsIOException{returnfilterHelper.loadConfig(name);
if(config.getId()==null){config.initBeforeSave();validator.validateAddFilter(config);
else{validator.validateModifiedFilter(config,filterHelper.loadConfig(config.getName(),migrationHelper));//removeallcachedauthenticationsforthisfiltergetAuthenticationCache().removeAll(config.getName());
if(!securityConfig.getFilterChain().patternsForFilter(config.getName(),true).isEmpty()){fireChanged=true;
if(fireChanged){fireChanged();
if(this.securityConfig==null)returnfalse;returnthis.securityConfig.isEncryptingUrlParams();
if(config.getConfigPasswordEncrypterName().equals(oldConfig.getConfigPasswordEncrypterName())==false){updateConfigurationFilesWithEncryptedFields();
if(mpProviderConfig.isReadOnly()){//newpasswordcomesfromtheprovidernewPasswd=mpProvider.getMasterPassword();
if(!mpProviderConfig.isReadOnly()){//writeitbackfirsttry{mpProvider.setMasterPassword(newPasswd);
if(!config.getProviderName().equals(oldConfig.getProviderName())){//TODO:reencryptthekeystore?restarttheserver?//updateConfigurationFilesWithEncryptedFields();
if(masterPasswdDigest==null){synchronized(this){
if(masterPasswdDigest==null){try{//lookforfilemasterPasswdDigest=loadMasterPasswordDigest();
if(pwDigestFile.getType()==Type.RESOURCE){InputStreamfin=pwDigestFile.in();try{returnIOUtils.toString(fin);
else{//computeandstorechar[]masterPasswd=getMasterPassword();try{returncomputeAndSaveMasterPasswordDigest(masterPasswd);
iftheproviderconfigisnotfound.**@paramnameThenameofthemasterpasswordproviderconfiguration.*/publicMasterPasswordProviderConfigloadMasterPassswordProviderConfig(Stringname)throwsIOException{returnmasterPasswordProviderHelper.loadConfig(name);
iftheproviderconfigisnotfound.**@paramnameThenameofthemasterpasswordproviderconfiguration.*/protectedMasterPasswordProviderloadMasterPasswordProvider(Stringname)throwsIOException{returnmasterPasswordProviderHelper.load(name);
if(config.getId()==null){config.initBeforeSave();
if(validate){validator.validateAddMasterPasswordProvider(config);
else{
if(validate){validator.validateModifiedMasterPasswordProvider(config,masterPasswordProviderHelper.loadConfig(config.getName()));
if(props!=null){//loaduser.propertiespopulatetheservicesUserAttributeEditorconfigAttribEd=newUserAttributeEditor();for(Iterator<Object>iter=props.keySet().iterator();iter.hasNext();){Stringusername=(String)iter.next();configAttribEd.setAsText(props.getProperty(username));UserAttributeattr=(UserAttribute)configAttribEd.getValue();
if(attr==null)continue;//Themasterpasswordpolicyisnotyetavailable,thedefaultisto//haveaminimumof8chars-->allpasswordsshorterthan8chars//arenocandidates
if(attr.getPassword()==null||attr.getPassword().length()<8)continue;//Thedefaultpasswordisnotallowed
if(defaultPasswordAsString.equals(attr.getPassword()))continue;//theusernamed"admin"havinganondefaultpasswordistheprimarycandiate
if(GeoServerUser.ADMIN_USERNAME.equals(username)){candidates.put(GeoServerUser.ADMIN_USERNAME,attr.getPassword());continue;
if(attr.getAuthorities().contains(GeoServerRole.ADMIN_ROLE)){candidates.put(username,attr.getPassword());
if(masterPW==null&&candidates.size()>0){username=candidates.keySet().iterator().next();masterPW=candidates.get(username);
if(masterPW!=null){message="Masterpasswordisidenticaltothepasswordofuser:"+username;masterPasswordArray=masterPW.toCharArray();writeMasterPasswordInfo(info,message,null);
else{message="Thegeneratedmasterpasswordis:";masterPasswordArray=getRandomPassworddProvider().getRandomPassword(8);writeMasterPasswordInfo(info,message,masterPasswordArray);
if(masterPasswordArray!=null){w.write(masterPasswordArray);
if(checkAuthenticationForAdminRole()==false){LOGGER.warning("Unautorizedusertriestodumpmasterpassword");returnfalse;
if(result!=null){LOGGER.warning("Dumpmasterpasswordiscalledbyanunautorizedmethod\n"+result);returnfalse;
if(checkAuthenticationForAdminRole()==false){thrownewIOException("Unauthorizedusertriestoreadmasterpassword");
if(result!=null){thrownewIOException("Unauthorizedmethodwantstoreadmasterpassword\n"+result);
ifthestacktracecontainsallowedmethods.Ititcontainsallowedmethods,return*<code>null</code>,
ifnotreturnaStringlistingthemethods.**@paramcountMethodsToCheck*@paramallowedMethods*/StringcheckStackTrace(intcountMethodsToCheck,String[][]allowedMethods){StackTraceElement[]stackTraceElements=Thread.currentThread().getStackTrace();booleanisAllowed=false;for(inti=0;i<countMethodsToCheck;i++){StackTraceElementelement=stackTraceElements[i];for(String[]methodEntry:allowedMethods){
if(methodEntry[0].equals(element.getClassName())&&methodEntry[1].equals(element.getMethodName())){isAllowed=true;break;
if(isAllowed){returnnull;
else{StringBufferbuff=newStringBuffer();for(inti=0;i<countMethodsToCheck;i++){StackTraceElementelement=stackTraceElements[i];buff.append(element.getClassName()).append(":").append(element.getMethodName()).append("\n");
ifmigrationhastakenplace*/booleanmigrateFrom21()throwsException{
if(role().getType()!=Type.UNDEFINED){ResourceoldUserFile=security().get("users.properties.old");
if(oldUserFile.getType()!=Type.UNDEFINED){LOGGER.warning(oldUserFile.path()+"couldberemovedmanually");
if(mpProviderConfig==null){mpProviderConfig=newURLMasterPasswordProviderConfig();mpProviderConfig.setName("default");mpProviderConfig.setClassName(URLMasterPasswordProvider.class.getCanonicalName());mpProviderConfig.setReadOnly(false);((URLMasterPasswordProviderConfig)mpProviderConfig).setURL(newURL("file:passwd"));((URLMasterPasswordProviderConfig)mpProviderConfig).setEncrypting(true);saveMasterPasswordProviderConfig(mpProviderConfig,false);//saveoutthedefaultmasterpasswordMasterPasswordProvidermpProvider=loadMasterPasswordProvider(mpProviderConfig.getName());ResourcepropFile=security().get("users.properties");Propertiesuserprops=null;
if(propFile.getType()==Type.RESOURCE)userprops=Util.loadPropertyFile(propFile);mpProvider.setMasterPassword(extractMasterPasswordForMigration(userprops));
ifnecessaryResourceserviceFile=security().get("services.properties");
if(serviceFile.getType()==Type.UNDEFINED){org.geoserver.util.IOUtils.copy(Util.class.getResourceAsStream("serviceTemplate.properties"),serviceFile.out());
ifnecessaryGeoServerUserGroupServiceuserGroupService=loadUserGroupService(XMLUserGroupService.DEFAULT_NAME);KeyStoreProviderkeyStoreProvider=getKeyStoreProvider();keyStoreProvider.reloadKeyStore();keyStoreProvider.setUserGroupKey(XMLUserGroupService.DEFAULT_NAME,randomPasswdProvider.getRandomPassword(32));keyStoreProvider.storeKeyStore();PasswordValidatorvalidator=loadPasswordValidator(PasswordValidator.DEFAULT_NAME);
if(validator==null){//Policyallowsanypasswordexceptnull,thisisthedefault//atbeforemigrationPasswordPolicyConfigpwpconfig=newPasswordPolicyConfig();pwpconfig.setName(PasswordValidator.DEFAULT_NAME);pwpconfig.setClassName(PasswordValidatorImpl.class.getName());pwpconfig.setMinLength(0);savePasswordPolicy(pwpconfig);validator=loadPasswordValidator(PasswordValidator.DEFAULT_NAME);
if(validator==null){//Policyrequiresaminimumof8charsforthemasterpasswordPasswordPolicyConfigpwpconfig=newPasswordPolicyConfig();pwpconfig.setName(PasswordValidator.MASTERPASSWORD_NAME);pwpconfig.setClassName(PasswordValidatorImpl.class.getName());pwpconfig.setMinLength(8);savePasswordPolicy(pwpconfig);validator=loadPasswordValidator(PasswordValidator.MASTERPASSWORD_NAME);
if(userGroupService==null){XMLUserGroupServiceConfigugConfig=newXMLUserGroupServiceConfig();ugConfig.setName(XMLUserGroupService.DEFAULT_NAME);ugConfig.setClassName(XMLUserGroupService.class.getName());ugConfig.setCheckInterval(checkInterval);ugConfig.setFileName(XMLConstants.FILE_UR);ugConfig.setValidating(true);//startwithweakencryption,plainpasswordscanberestoredugConfig.setPasswordEncoderName(loadPasswordEncoder(GeoServerPBEPasswordEncoder.class,null,false).getName());ugConfig.setPasswordPolicyName(PasswordValidator.DEFAULT_NAME);saveUserGroupService(ugConfig);userGroupService=loadUserGroupService(XMLUserGroupService.DEFAULT_NAME);
ifnecessaryGeoServerRoleServiceroleService=loadRoleService(XMLRoleService.DEFAULT_NAME);
if(roleService==null){XMLRoleServiceConfiggaConfig=newXMLRoleServiceConfig();gaConfig.setName(XMLRoleService.DEFAULT_NAME);gaConfig.setClassName(XMLRoleService.class.getName());gaConfig.setCheckInterval(checkInterval);gaConfig.setFileName(XMLConstants.FILE_RR);gaConfig.setValidating(true);gaConfig.setAdminRoleName(XMLRoleService.DEFAULT_LOCAL_ADMIN_ROLE);gaConfig.setGroupAdminRoleName(XMLRoleService.DEFAULT_LOCAL_GROUP_ADMIN_ROLE);saveRoleService(gaConfig);roleService=loadRoleService(XMLRoleService.DEFAULT_NAME);
if(filter==null){BasicAuthenticationFilterConfigbfConfig=newBasicAuthenticationFilterConfig();bfConfig.setName(filterName);bfConfig.setClassName(GeoServerBasicAuthenticationFilter.class.getName());bfConfig.setUseRememberMe(true);saveFilter(bfConfig);
if(filter==null){BasicAuthenticationFilterConfigbfConfig=newBasicAuthenticationFilterConfig();bfConfig.setClassName(GeoServerBasicAuthenticationFilter.class.getName());bfConfig.setName(filterName);bfConfig.setUseRememberMe(false);saveFilter(bfConfig);}*/filterName=GeoServerSecurityFilterChain.FORM_LOGIN_FILTER;filter=loadFilter(filterName);
if(filter==null){UsernamePasswordAuthenticationFilterConfigupConfig=newUsernamePasswordAuthenticationFilterConfig();upConfig.setClassName(GeoServerUserNamePasswordAuthenticationFilter.class.getName());upConfig.setName(filterName);upConfig.setUsernameParameterName(UsernamePasswordAuthenticationFilterConfig.DEFAULT_USERNAME_PARAM);upConfig.setPasswordParameterName(UsernamePasswordAuthenticationFilterConfig.DEFAULT_PASSWORD_PARAM);saveFilter(upConfig);
if(filter==null){SecurityContextPersistenceFilterConfigpConfig=newSecurityContextPersistenceFilterConfig();pConfig.setClassName(GeoServerSecurityContextPersistenceFilter.class.getName());pConfig.setName(filterName);pConfig.setAllowSessionCreation(true);saveFilter(pConfig);
if(filter==null){SecurityContextPersistenceFilterConfigpConfig=newSecurityContextPersistenceFilterConfig();pConfig.setClassName(GeoServerSecurityContextPersistenceFilter.class.getName());pConfig.setName(filterName);pConfig.setAllowSessionCreation(false);saveFilter(pConfig);
if(filter==null){AnonymousAuthenticationFilterConfigaConfig=newAnonymousAuthenticationFilterConfig();aConfig.setClassName(GeoServerAnonymousAuthenticationFilter.class.getName());aConfig.setName(filterName);saveFilter(aConfig);
if(filter==null){RememberMeAuthenticationFilterConfigrConfig=newRememberMeAuthenticationFilterConfig();rConfig.setClassName(GeoServerRememberMeAuthenticationFilter.class.getName());rConfig.setName(filterName);saveFilter(rConfig);
if(filter==null){SecurityInterceptorFilterConfigsiConfig=newSecurityInterceptorFilterConfig();siConfig.setClassName(GeoServerSecurityInterceptorFilter.class.getName());siConfig.setName(filterName);siConfig.setAllowIfAllAbstainDecisions(false);siConfig.setSecurityMetadataSource("geoserverMetadataSource");saveFilter(siConfig);
if(filter==null){SecurityInterceptorFilterConfigsiConfig=newSecurityInterceptorFilterConfig();siConfig.setClassName(GeoServerSecurityInterceptorFilter.class.getName());siConfig.setName(filterName);siConfig.setAllowIfAllAbstainDecisions(false);siConfig.setSecurityMetadataSource("restFilterDefinitionMap");saveFilter(siConfig);
if(filter==null){LogoutFilterConfigloConfig=newLogoutFilterConfig();loConfig.setClassName(GeoServerLogoutFilter.class.getName());loConfig.setName(filterName);saveFilter(loConfig);
if(filter==null){ExceptionTranslationFilterConfigbfConfig=newExceptionTranslationFilterConfig();bfConfig.setClassName(GeoServerExceptionTranslationFilter.class.getName());bfConfig.setName(filterName);bfConfig.setAuthenticationFilterName(null);bfConfig.setAccessDeniedErrorPage("/accessDenied.jsp");saveFilter(bfConfig);
if(filter==null){ExceptionTranslationFilterConfigbfConfig=newExceptionTranslationFilterConfig();bfConfig.setClassName(GeoServerExceptionTranslationFilter.class.getName());bfConfig.setName(filterName);bfConfig.setAuthenticationFilterName(GeoServerSecurityFilterChain.FORM_LOGIN_FILTER);bfConfig.setAccessDeniedErrorPage("/accessDenied.jsp");saveFilter(bfConfig);
ifnecessaryGeoServerAuthenticationProviderauthProvider=loadAuthenticationProvider(GeoServerAuthenticationProvider.DEFAULT_NAME);
if(authProvider==null){UsernamePasswordAuthenticationProviderConfigupAuthConfig=newUsernamePasswordAuthenticationProviderConfig();upAuthConfig.setName(GeoServerAuthenticationProvider.DEFAULT_NAME);upAuthConfig.setClassName(UsernamePasswordAuthenticationProvider.class.getName());upAuthConfig.setUserGroupServiceName(userGroupService.getName());saveAuthenticationProvider(upAuthConfig);authProvider=loadAuthenticationProvider(GeoServerAuthenticationProvider.DEFAULT_NAME);
if(usersFile.getType()==Type.RESOURCE){//loaduser.propertiespopulatetheservicesPropertiesprops=Util.loadPropertyFile(usersFile);UserAttributeEditorconfigAttribEd=newUserAttributeEditor();for(Iterator<Object>iter=props.keySet().iterator();iter.hasNext();){//theattributeeditorsparsesthelistofstringsintopassword,usernameand//enabled//flagStringusername=(String)iter.next();configAttribEd.setAsText(props.getProperty(username));//
iftheparsingsucceededturnthatintoauserobjectUserAttributeattr=(UserAttribute)configAttribEd.getValue();
if(attr!=null){GeoServerUseruser=userGroupStore.createUserObject(username,attr.getPassword(),attr.isEnabled());userGroupStore.addUser(user);for(GrantedAuthorityauth:attr.getAuthorities()){StringroleName=GeoServerRole.ADMIN_ROLE.getAuthority().equals(auth.getAuthority())?XMLRoleService.DEFAULT_LOCAL_ADMIN_ROLE:auth.getAuthority();GeoServerRolerole=roleStore.getRoleByName(roleName);
if(role==null){role=roleStore.createRoleObject(roleName);roleStore.addRole(role);
else{//nouser.properties,populatewithdefaultuserandroles
if(userGroupService.getUserByUsername(GeoServerUser.ADMIN_USERNAME)==null){userGroupStore.addUser(GeoServerUser.createDefaultAdmin());GeoServerRolelocalAdminRole=roleStore.createRoleObject(XMLRoleService.DEFAULT_LOCAL_ADMIN_ROLE);roleStore.addRole(localAdminRole);roleStore.associateRoleToUser(localAdminRole,GeoServerUser.ADMIN_USERNAME);
if(roleStore.getRoleByName(XMLRoleService.DEFAULT_LOCAL_GROUP_ADMIN_ROLE)==null){roleStore.addRole(roleStore.createRoleObject(XMLRoleService.DEFAULT_LOCAL_GROUP_ADMIN_ROLE));
if(file.getType()==Type.UNDEFINED){continue;
if(serviceFile.getType()!=Type.UNDEFINED){Propertiesprops=Util.loadPropertyFile(serviceFile);for(Entry<Object,Object>entry:props.entrySet()){StringTokenizertokenizer=newStringTokenizer((String)entry.getValue(),",");while(tokenizer.hasMoreTokens()){StringroleName=tokenizer.nextToken().trim();
if(roleName.length()>0){
if(roleStore.getRoleByName(roleName)==null){roleStore.addRole(roleStore.createRoleObject(roleName));
if(dataFile.getType()==Type.RESOURCE){Propertiesprops=Util.loadPropertyFile(dataFile);for(Entry<Object,Object>entry:props.entrySet()){
if("mode".equals(entry.getKey().toString()))continue;//skipmodedirectiveStringTokenizertokenizer=newStringTokenizer((String)entry.getValue(),",");while(tokenizer.hasMoreTokens()){StringroleName=tokenizer.nextToken().trim();
if(roleName.length()>0&&roleName.equals("*")==false){
if(roleStore.getRoleByName(roleName)==null)roleStore.addRole(roleStore.createRoleObject(roleName));
if(usersFile.getType()!=Type.UNDEFINED){ResourceoldUserFile=dataDir.get(usersFile.path()+".old");usersFile.renameTo(oldUserFile);LOGGER.info("Renamed"+usersFile.path()+"to"+oldUserFile.path());
ifmigrationhastakenplace*/booleanmigrateFrom22(booleanmigratedFrom21)throwsException{StringfilterName=GeoServerSecurityFilterChain.ROLE_FILTER;GeoServerSecurityFilterfilter=loadFilter(filterName);ResourcelogoutFilterDir=filterRoot().get(GeoServerSecurityFilterChain.FORM_LOGOUT_FILTER);ResourceoldLogoutFilterConfig=logoutFilterDir.get("config.xml.2.2.x");ResourceoldSecManagerConfig=security().get("config.xml.2.2.x");
if(filter!=null){
if(oldLogoutFilterConfig.getType()==Type.RESOURCE)LOGGER.warning(oldLogoutFilterConfig.path()+"couldberemovedmanually");
if(oldSecManagerConfig.getType()==Type.RESOURCE)LOGGER.warning(oldSecManagerConfig.path()+"couldberemovedmanually");returnfalse;//alreadymigrated
if(!migratedFrom21)org.geoserver.util.IOUtils.copy(logoutFilterDir.get("config.xml").in(),oldLogoutFilterConfig.out());LogoutFilterConfigloConfig=(LogoutFilterConfig)loadFilterConfig(GeoServerSecurityFilterChain.FORM_LOGOUT_FILTER);loConfig.setRedirectURL(GeoServerLogoutFilter.URL_AFTER_LOGOUT);saveFilter(loConfig);
if(!migratedFrom21)org.geoserver.util.IOUtils.copy(security().get("config.xml").in(),oldSecManagerConfig.out());SecurityManagerConfigconfig=loadSecurityConfig();for(RequestFilterChainchain:config.getFilterChain().getRequestChains()){
if(chain.getFilterNames().contains(GeoServerSecurityFilterChain.SECURITY_CONTEXT_ASC_FILTER)){chain.setAllowSessionCreation(true);chain.getFilterNames().remove(GeoServerSecurityFilterChain.SECURITY_CONTEXT_ASC_FILTER);
if(chain.getFilterNames().contains(GeoServerSecurityFilterChain.SECURITY_CONTEXT_NO_ASC_FILTER)){chain.setAllowSessionCreation(false);chain.getFilterNames().remove(GeoServerSecurityFilterChain.SECURITY_CONTEXT_NO_ASC_FILTER);
if(GeoServerSecurityFilterChain.WEB_CHAIN_NAME.equals(chain.getName())){//replaceexceptiontranslationfilterintindex=chain.getFilterNames().indexOf(GeoServerSecurityFilterChain.GUI_EXCEPTION_TRANSLATION_FILTER);
if(index!=-1)chain.getFilterNames().set(index,GeoServerSecurityFilterChain.DYNAMIC_EXCEPTION_TRANSLATION_FILTER);//injectformloginfilter
ifnecessary
if(chain.getFilterNames().indexOf(GeoServerSecurityFilterChain.FORM_LOGIN_FILTER)==-1){index=chain.getFilterNames().indexOf(GeoServerSecurityFilterChain.ANONYMOUS_FILTER);
if(index==-1)index=chain.getFilterNames().indexOf(GeoServerSecurityFilterChain.FILTER_SECURITY_INTERCEPTOR);
if(index!=-1)chain.getFilterNames().add(index,GeoServerSecurityFilterChain.FORM_LOGIN_FILTER);
if(!migratedFrom21){for(StringfName:listFilters()){SecurityFilterConfigfConfig=loadFilterConfig(fName);
if(fConfig!=null)saveFilter(fConfig);
ifmigrationhastakenplace*/booleanmigrateFrom23()throwsException{SecurityManagerConfigconfig=loadSecurityConfig();RequestFilterChainwebChain=config.getFilterChain().getRequestChainByName(GeoServerSecurityFilterChain.WEB_CHAIN_NAME);booleanmigrated=false;List<String>patterns=webChain.getPatterns();
if(patterns.contains("/")==false){patterns.add("/");saveSecurityConfig(config);migrated|=true;
ifitexists.*/voidremoveErroneousAccessDeniedPage()throwsException{ExceptionTranslationFilterConfigconfig=(ExceptionTranslationFilterConfig)loadFilterConfig(GeoServerSecurityFilterChain.DYNAMIC_EXCEPTION_TRANSLATION_FILTER);
if(config!=null&&"/accessDenied.jsp".equals(config.getAccessDeniedErrorPage())){config.setAccessDeniedErrorPage(null);saveFilter(config);
if(config!=null&&"/accessDenied.jsp".equals(config.getAccessDeniedErrorPage())){config.setAccessDeniedErrorPage(null);saveFilter(config);
if(!provider.isAvailable()){continue;
if(d.getType()==Type.DIRECTORY&&d.get(CONFIG_FILENAME).getType()==Type.RESOURCE){result.add(d.name());
if(gxp==null){gxp=buildGlobalPersister();
if(xp==null){xp=buildPersister();
if(dir.getType()!=Type.DIRECTORY){returnnull;
if(migrationHelper!=null){migrationHelper.migrationPersister(xp);
if(isNew){config.setId(newId());
iftheconfigwasnew,clearouttheidsinceitwasnotadded
if(isNew){config.setId(null);
if(einstanceofIOException){throw(IOException)e;
if(config==null){//nosuchconfigreturnnull;
if(p.getUserGroupServiceClass()==null){continue;
if(p.getUserGroupServiceClass().getName().equals(config.getClassName())){service=p.createUserGroupService(config);break;
if(service==null){thrownewIOException("Nousergroupservicematchingconfig:"+config);
if(configinstanceofSecurityUserGroupServiceConfig){booleanneedsLockProtection=GeoServerSecurityProvider.getProvider(GeoServerUserGroupService.class,config.getClassName()).roleServiceNeedsLockProtection();
if(needsLockProtection)service=newLockingUserGroupService(service);
if(configinstanceofFileBasedSecurityServiceConfig){FileBasedSecurityServiceConfigfileConfig=(FileBasedSecurityServiceConfig)config;
if(fileConfig.getCheckInterval()>0){Resourceresource=getConfigFile(fileConfig.getFileName());
if(resource==null){Stringpath=Paths.path("security/usergroup",name,fileConfig.getFileName());resource=get(path);
if(config==null){//nosuchconfigreturnnull;
if(p.getRoleServiceClass()==null){continue;
if(p.getRoleServiceClass().getName().equals(config.getClassName())){service=p.createRoleService(config);break;
if(service==null){thrownewIOException("Noauthorityservicematchingconfig:"+config);
if(configinstanceofSecurityRoleServiceConfig){booleanneedsLockProtection=GeoServerSecurityProvider.getProvider(GeoServerRoleService.class,config.getClassName()).roleServiceNeedsLockProtection();
if(needsLockProtection){service=newLockingRoleService(service);
if(configinstanceofFileBasedSecurityServiceConfig){FileBasedSecurityServiceConfigfileConfig=(FileBasedSecurityServiceConfig)config;
if(fileConfig.getCheckInterval()>0){Resourceresource=getConfigFile(fileConfig.getFileName());
if(resource==null){Stringpath=Paths.path("security/role",name,fileConfig.getFileName());resource=get(path);
if(file.isAbsolute()){
if(file.canRead()){returnFiles.asResource(file);//usedbytestcases
else{thrownewIOException("Cannotreadfile:"+file.getCanonicalPath());
if(config==null){//nosuchconfigreturnnull;
if(p.getPasswordValidatorClass()==null){continue;
if(p.getPasswordValidatorClass().getName().equals(config.getClassName())){validator=p.createPasswordValidator(config,GeoServerSecurityManager.this);break;
if(validator==null){thrownewIOException("Nopasswordpolicymatchingconfig:"+config);
if(config==null){returnnull;
if(p.getMasterPasswordProviderClass()==null){continue;
if(p.getMasterPasswordProviderClass().getName().equals(config.getClassName())){provider=p.createMasterPasswordProvider(config);break;
if(provider==null){thrownewIOException("Nomasterpasswordprovidermatchingconfig:"+config);
if(!Modifier.isFinal(provider.getClass().getModifiers())){thrownewRuntimeException("Masterpasswordproviderclass:"+provider.getClass().getCanonicalName()+"isnotfinal");
if(!configPasswordEncryptionHelper.getEncryptedFields(info).isEmpty()){catalog.save(info);
if(config.getClass().isAssignableFrom(classWithEncryption)){passwordValidatorHelper.saveConfig(config);break;
if(config.getClass().isAssignableFrom(classWithEncryption)){roleServiceHelper.saveConfig(config);break;
if(config.getClass().isAssignableFrom(classWithEncryption)){userGroupServiceHelper.saveConfig(config);break;
if(config.getClass().isAssignableFrom(classWithEncryption)){authProviderHelper.saveConfig(config);break;
if(config.getClass().isAssignableFrom(classWithEncryption)){filterHelper.saveConfig(config);break;
if(config==null){//nosuchconfigreturnnull;
if(p.getAuthenticationProviderClass()==null){continue;
if(p.getAuthenticationProviderClass().getName().equals(config.getClassName())){authProvider=p.createAuthenticationProvider(config);break;
if(authProvider==null){thrownewIOException("Noauthenticationprovidermatchingconfig:"+config);
if(config==null){//nosuchconfigreturnnull;
if(p.getFilterClass()==null){continue;
if(p.getFilterClass().getName().equals(config.getClassName())){filter=p.createFilter(config);break;
if(filter==null){thrownewIOException("Noauthenticationprovidermatchingconfig:"+config);
if(sb.length()>0){sb.setLength(sb.length()-1);
if(requestChain.getName()!=null){writer.addAttribute("name",requestChain.getName());
if(StringUtils.hasLength(requestChain.getRoleFilterName()))writer.addAttribute("roleFilterName",requestChain.getRoleFilterName());
if(requestChaininstanceofVariableFilterChain){
if(StringUtils.hasLength(((VariableFilterChain)requestChain).getInterceptorName()))writer.addAttribute("interceptorName",((VariableFilterChain)requestChain).getInterceptorName());
if(StringUtils.hasLength(((VariableFilterChain)requestChain).getExceptionTranslationName()))writer.addAttribute("exceptionTranslationName",((VariableFilterChain)requestChain).getExceptionTranslationName());
if(requestChain.getHttpMethods()!=null&&requestChain.getHttpMethods().size()>0){writer.addAttribute("httpMethods",StringUtils.collectionToCommaDelimitedString(requestChain.getHttpMethods()));
if(name==null){//firstversionoftheserializationdidnotcontainnameattribute,
ifnot//availabletrytolookupwellknownchain,
ifnotfoundjustusethepath//asthenameRequestFilterChainrequestChain=GeoServerSecurityFilterChain.lookupRequestChainByPattern(path,GeoServerSecurityManager.this);
if(requestChain!=null){name=requestChain.getName();
else{name=path;
if(classname==null){
if(GeoServerSecurityFilterChain.WEB_CHAIN_NAME.equals(name)){classname=HtmlLoginFilterChain.class.getName();allowSessionCreationString="true";interceptorName=GeoServerSecurityFilterChain.FILTER_SECURITY_INTERCEPTOR;
if(GeoServerSecurityFilterChain.WEB_LOGIN_CHAIN_NAME.equals(name)){classname=ConstantFilterChain.class.getName();allowSessionCreationString="true";interceptorName=GeoServerSecurityFilterChain.FILTER_SECURITY_INTERCEPTOR;
if(GeoServerSecurityFilterChain.WEB_LOGOUT_CHAIN_NAME.equals(name)){classname=LogoutFilterChain.class.getName();allowSessionCreationString="true";interceptorName=GeoServerSecurityFilterChain.FILTER_SECURITY_INTERCEPTOR;
if(GeoServerSecurityFilterChain.REST_CHAIN_NAME.equals(name)){classname=ServiceLoginFilterChain.class.getName();allowSessionCreationString="false";interceptorName=GeoServerSecurityFilterChain.FILTER_SECURITY_REST_INTERCEPTOR;
if(GeoServerSecurityFilterChain.GWC_CHAIN_NAME.equals(name)){classname=ServiceLoginFilterChain.class.getName();allowSessionCreationString="false";interceptorName=GeoServerSecurityFilterChain.FILTER_SECURITY_REST_INTERCEPTOR;
if(GeoServerSecurityFilterChain.DEFAULT_CHAIN_NAME.equals(name)){classname=ServiceLoginFilterChain.class.getName();allowSessionCreationString="false";interceptorName=GeoServerSecurityFilterChain.FILTER_SECURITY_INTERCEPTOR;
if(StringUtils.hasLength(disabledString)){requestChain.setDisabled(Boolean.parseBoolean(disabledString));
if(StringUtils.hasLength(allowSessionCreationString)){requestChain.setAllowSessionCreation(Boolean.parseBoolean(allowSessionCreationString));
if(StringUtils.hasLength(sslString)){requestChain.setRequireSSL(Boolean.parseBoolean(sslString));
if(StringUtils.hasLength(matchHTTPMethodString)){requestChain.setMatchHTTPMethod(Boolean.parseBoolean(matchHTTPMethodString));
if(StringUtils.hasLength(httpMethodsString)){for(Stringmethod:httpMethodsString.split(",")){requestChain.getHttpMethods().add(HTTPMethod.fromString(method));
if(requestChaininstanceofVariableFilterChain){((VariableFilterChain)requestChain).setInterceptorName(interceptorName);
if(StringUtils.hasLength(exceptionTranslationName))((VariableFilterChain)requestChain).setExceptionTranslationName(exceptionTranslationName);
else((VariableFilterChain)requestChain).setExceptionTranslationName(GeoServerSecurityFilterChain.DYNAMIC_EXCEPTION_TRANSLATION_FILTER);
if//ajdbcconnectioncannotbeestablished.try{allRoles.addAll(loadRoleService(serviceName).getRoles());
ifusercanaccesstheworkspaceinthespecifiedmode*/publicbooleancanAccess(Authenticationuser,WorkspaceInfoworkspace,AccessModemode);/**Returnstrue
ifusercanaccessthelayerinthespecifiedmode*/publicbooleancanAccess(Authenticationuser,LayerInfolayer,AccessModemode);/**Returnstrue
ifusercanaccesstheresourceinthespecifiedmode*/publicbooleancanAccess(Authenticationuser,ResourceInforesource,AccessModemode);}
if(modelObject!=null){time=modelObject.longValue();
else{time=0;
if(!isJDBCTest())checkEmpty(service);checkValuesInserted(store);//rollbackstore.load();checkEmpty(store);checkEmpty(service);//commitinsertValues(store);store.store();checkValuesInserted(store);checkValuesInserted(service);
if(!isJDBCTest())checkValuesInserted(service);checkValuesModified(store);store.load();checkValuesInserted(store);checkValuesInserted(service);modifyValues(store);store.store();checkValuesModified(store);checkValuesModified(service);
if(!isJDBCTest())checkValuesInserted(service);checkValuesRemoved(store);store.load();checkValuesInserted(store);checkValuesInserted(service);removeValues(store);store.store();checkValuesRemoved(store);checkValuesRemoved(service);
if(pf!=null){Set<Name>names=pf.getNames();for(Namename:names){prefixes.add(name.getNamespaceURI());
ifwecannotfindatitleusetheclassname
if(prefixes.isEmpty()){return"";
else{//buildacommaseparatedlistwiththeprefixesList<String>pl=newArrayList<String>(prefixes);Collections.sort(pl);StringBuildersb=newStringBuilder();for(inti=0;i<pl.size();i++){sb.append(pl.get(i));
if(i<pl.size()-1){sb.append(",");
if(pf!=null){title=pf.getTitle().toString(locale);
ifwecannotfindatitleusetheclassname
if(title==null){title=factoryClass.getName();
if(item.getFilteredProcesses().isEmpty()){//allprocessesareenabledreturnnewParamResourceModel("WPSAdminPage.filter.all",null).getString();
if(pf!=null){Set<Name>names=newHashSet<Name>(pf.getNames());inttotal=names.size();for(ProcessInfotoRemove:item.getFilteredProcesses()){
if(!toRemove.isEnabled()){names.remove(toRemove.getName());
if(active!=total){returnnewParamResourceModel("WPSAdminPage.filter.active",null,active,total).getString();
else{returnnewParamResourceModel("WPSAdminPage.filter.all",null).getString();
if(config.getMode()!=Mode.HISTORY){dao.add(req);
if(config.getMode()!=Mode.HISTORY){dao.update(data);
if(eventinstanceofContextRefreshedEvent){listeners=GeoServerExtensions.extensions(RequestDataListener.class);
iftheydontspecifyone,weshouldthrowanerror*insteadweuse"NONE"-whichisno-projection.PreviousbehaviorwastotheWSG84lat/long*(4326)**@returnrequestCRS,or<code>null</code>
ifnotset.TODO:makeCRSmanditoryasforspec*conformance*/publicCoordinateReferenceSystemgetCrs(){returnthis.optionalParams.crs;
ifnoversionisset.*/publicVersionstyleVersion(){returngetStyleVersion()!=null?newVersion(getStyleVersion()):null;
ifthereqeustisforavectorlayer.*/publicvoidsetMaxFeatures(IntegermaxFeatures){this.optionalParams.maxFeatures=maxFeatures;
iftherequestisforavectorlayer.*/publicvoidsetStartIndex(IntegerstartIndex){this.optionalParams.startIndex=startIndex;
if(this.optionalParams.sortBy==null){returnnull;
else{returnthis.optionalParams.sortBy.stream().map(l->l.toArray(newSortBy[l.size()])).collect(Collectors.toList());
ifnotspecified*/ColorbgColor=DEFAULT_BG;/**fromSRS(1.1)orCRS(1.2)param*/CoordinateReferenceSystemcrs;/**EPSGcodefortheSRS*/Stringsrs;/**vendorextensions,allowstofiltereachlayerwithauserdefinedfilter*/Listfilters;/**cqlfilters*/ListcqlFilters;/**featureidfilters*/ListfeatureIds;/**Layersorting*/List<List<SortBy>>sortBy;Stringexceptions=SE_XML;booleantransparent=false;/***Tilinghint,accordingtothe<a*href="http://wiki.osgeo.org/index.php/WMS_Tiling_Client_Recommendation">WMS-C*specification</a>*/booleantiled;/***Temporaryhacksincefindingagoodtilingoriginwouldrequireustocomputethebboxon*theflyTODO:removethisoncewecachetherealbboxofvectorlayers*/publicPoint2DtilesOrigin;/**therenderingbuffer,inpixels**/intbuffer;/**Thepaletteusedforrendering,
ifany*/IndexColorModelicm;/***timeparameter,alistsincemanypatternsetupcanbepossible,seeforexample*http://mapserver.gis.umn.edu/docs/howto/wms_time_support/#time-patterns.Cancontain*{@linkDate}or{@linkDateRange}objects.*/List<Object>time=Collections.emptyList();/***elevationparameter,canalsobealist,cancontain{@linkDouble}or{@link*NumberRange}*/List<Object>elevation=Collections.emptyList();/**STYLE_URLparameter*/URLstyleUrl;/**STYLE_BODYparameter*/StringstyleBody;/**STYLE_VERSIONparameter*/StringstyleVersion;/**STYLE_FORMATparameter*/StringstyleFormat=SLDHandler.FORMAT;/**flagtovalidateSLDparameter*/BooleanvalidateSLD=Boolean.FALSE;/**featureversion(forversionedrequests)*/StringfeatureVersion;/**RemoteOWStype*/StringremoteOwsType;/**RemoteOWSurl*/URLremoteOwsURL;/**pagingparameters*/IntegermaxFeatures;IntegerstartIndex;/**maprotation*/doubleangle;/**scalecomputationmethod*/ScaleComputationMethodscaleMethod;/**bylayerinterpolationmethods**/List<Interpolation>interpolationMethods=Collections.EMPTY_LIST;@OverridepublicObjectclone()throwsCloneNotSupportedException{returnsuper.clone();
if(i.hasNext()){returnString.append(",");
if(it.hasNext()){returnString.append(",");
if(httpRequestHeaders==null){httpRequestHeaders=newCaseInsensitiveMap(newHashMap<String,String>());
if(getRawKvp()!=null){Stringkey="DIM_"+dimensionName;Stringvalue=getRawKvp().get(key);
if(value!=null){finalArrayList<String>values=newArrayList<String>(1);
if(value.indexOf(",")>0){String[]elements=value.split("\\s*,\\s*");values.addAll(Arrays.asList(elements));
else{values.add(value);
if(request.getSession(false)!=null)//nocaching
ifthereisanHTTPsessionreturnnull;Stringheader=request.getHeader("Authorization");
if((header!=null)&&header.startsWith("Digest")){Stringsection212response=header.substring(7);String[]headerEntries=DigestAuthUtils.splitIgnoringQuotes(section212response,',');Map<String,String>headerMap=DigestAuthUtils.splitEachArrayElementAndCreateMap(headerEntries,"=","\"");Stringusername=headerMap.get("username");Stringrealm=headerMap.get("realm");Stringnonce=headerMap.get("nonce");StringresponseDigest=headerMap.get("response");
if(StringUtils.hasLength(username)==false||StringUtils.hasLength(realm)==false||StringUtils.hasLength(nonce)==false||StringUtils.hasLength(responseDigest)==false)returnnull;
if(GeoServerUser.ROOT_USERNAME.equals(username))returnnull;StringBufferbuff=newStringBuffer();buff.append(username).append(":");buff.append(realm).append(":");buff.append(nonce).append(":");buff.append(responseDigest);returnbuff.toString();
else{returnnull;
if(c.isRunning()){fp.info("Disconnecting...");
if(c.disconnect()){fp.info("Succesfullyun-registeredfromthedestinationtopic");fp.warn("Youwill(probably)loosenextincomingeventsfromotherinstances!!!(dependingonhowyouhaveconfiguredthebroker)");connectionInfo.getModel().setObject(ConnectionConfigurationStatus.disabled.toString());
else{fp.error("Disconnectionerror!");connectionInfo.getModel().setObject(ConnectionConfigurationStatus.enabled.toString());
else{fp.info("Connecting...");
if(c.connect()){fp.info("NowGeoServerisregisteredwiththedestination");connectionInfo.getModel().setObject(ConnectionConfigurationStatus.enabled.toString());
else{fp.error("Connectionerror!");fp.error("Registrationabortedduetoaconnectionproblem");connectionInfo.getModel().setObject(ConnectionConfigurationStatus.disabled.toString());
switchfinalTextField<String>readOnlyInfo=newTextField<String>(ReadOnlyConfiguration.READ_ONLY_KEY);//https://issues.apache.org/jira/browse/WICKET-2426readOnlyInfo.setType(String.class);readOnlyInfo.setOutputMarkupId(true);readOnlyInfo.setOutputMarkupPlaceholderTag(true);readOnlyInfo.setEnabled(false);form.add(readOnlyInfo);finalAjaxButtonreadOnly=newAjaxButton("readOnlyB"){/**serialVersionUID*/privatestaticfinallongserialVersionUID=1L;@OverrideprotectedvoidonSubmit(AjaxRequestTargettarget,org.apache.wicket.markup.html.form.Form<?>form){ReadOnlyGeoServerLoaderloader=getReadOnlyGeoServerLoader();
if(loader.isEnabled()){readOnlyInfo.getModel().setObject("disabled");loader.enable(false);
else{readOnlyInfo.getModel().setObject("enabled");loader.enable(true);
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(e.getLocalizedMessage());fp.error(e.getLocalizedMessage());
switchfinalTextField<String>embeddedBrokerInfo=newTextField<String>(EmbeddedBrokerConfiguration.EMBEDDED_BROKER_KEY);//https://issues.apache.org/jira/browse/WICKET-2426embeddedBrokerInfo.setType(String.class);embeddedBrokerInfo.setOutputMarkupId(true);embeddedBrokerInfo.setOutputMarkupPlaceholderTag(true);embeddedBrokerInfo.setEnabled(false);form.add(embeddedBrokerInfo);finalAjaxButtonembeddedBroker=newAjaxButton("embeddedBrokerB"){/**serialVersionUID*/privatestaticfinallongserialVersionUID=1L;@OverrideprotectedvoidonSubmit(AjaxRequestTargettarget,org.apache.wicket.markup.html.form.Form<?>form){JMSFactoryfactory=getJMSFactory();
if(!factory.isEmbeddedBrokerStarted()){try{
if(factory.startEmbeddedBroker(configurations)){embeddedBrokerInfo.getModel().setObject("enabled");
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(e.getLocalizedMessage());fp.error(e.getLocalizedMessage());
else{try{
if(factory.stopEmbeddedBroker()){embeddedBrokerInfo.getModel().setObject("disabled");
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(e.getLocalizedMessage());fp.error(e.getLocalizedMessage());
if(switchTo){fp.info("The"+type+"toggleisnowENABLED");
else{fp.warn("The"+type+"toggleisnowDISABLEDnoeventwillbeposted/receivedto/fromthebroker");fp.info("Notethatthe"+type+"isstillregisteredtothetopicdestination");
ifthecreateTileLayercheckboxisdisabled,noTileLayeris//configuredGWCmediator=GWC.get();//SavetheoldGeoServerTileLayerGeoServerTileLayertileLayer=(GeoServerTileLayer)mediator.getTileLayerByName(tileLayerModel.getObject().getName());//RemovethetileLayermediator.removeTileLayers(Arrays.asList(tileLayerModel.getObject().getName()));assertNull(mediator.getTileLayer(layerModel.getObject()));//UpdatetheconfigurationinordertosetdefaultcachingGWCConfigconfig=mediator.getConfig();booleandefaultCaching=config.isCacheLayersByDefault();config.setCacheLayersByDefault(true);mediator.saveConfig(config);//CreatethenewLayerGeoServerTileLayerInfonewInfo=TileLayerInfoUtil.loadOrCreate(layerModel.getObject(),mediator.getConfig());tileLayerModel=newGeoServerTileLayerInfoModel(newInfo,true);tester.startPage(newFormTestPage(newComponentBuilder(){privatestaticfinallongserialVersionUID=-6705646666953650890L;publicComponentbuildComponent(finalStringid){returnnewLayerCacheOptionsTabPanel(id,layerModel,tileLayerModel);
if*notspecified(ienull)thenthecontainingpageisusedviagetPage()*/publicHelpLink(Stringid,Componentcontainer){super(id);this.container=container;
if(checked){//activateversioningattributesselectionidAttributeChoice.setVisible(true);idAttributeChoiceLabel.setVisible(true);timeAttributeChoice.setVisible(true);timeAttributeChoiceLabel.setVisible(true);
else{//deactivateversioningattributesselectionidAttributeChoice.setVisible(false);idAttributeChoiceLabel.setVisible(false);timeAttributeChoice.setVisible(false);timeAttributeChoiceLabel.setVisible(false);
if(isVersioningActivated){versioningActivateCheckBox.setModelObject(true);
ifwehaveanuptodateversionoftheiteminthecacheStringkey=getFileKey(file);CacheItem<T>ci=cache.get(key);
if(ci!=null&&ci.isUpToDate(file)){returnci.getItem();
ifnot,loadandcacheTitem=loadItem(file);
if(item==null){returnnull;
if(request.getCoverageId()==null||request.getCoverageId().isEmpty()){thrownewOWS20Exception("RequiredparametercoverageIdmissing",WCS20Exception.WCS20ExceptionCode.EmptyCoverageIdList,"coverageId");
if(availableDescribeCovExtensions){for(WCS20DescribeCoverageExtensionext:wcsDescribeCoverageExtensions){newCoverageID=ext.handleCoverageId(newCoverageID);
if(layer==null){badCoverageIds.add(encodedCoverageId);
if(!badCoverageIds.isEmpty()){StringmergedIds=StringUtils.merge(badCoverageIds);thrownewWCS20Exception("Couldnotfindtherequestedcoverage(s):"+mergedIds,WCS20Exception.WCS20ExceptionCode.NoSuchCoverage,"coverageId");
if(request.getCoverageId()==null||"".equals(request.getCoverageId())){thrownewOWS20Exception("RequiredparametercoverageIdmissing",WCS20Exception.WCS20ExceptionCode.EmptyCoverageIdList,"coverageId");
if(StringUtils.hasLength(adminRoleName)==false)returnnull;try{returngetRoleByName(adminRoleName);
if(StringUtils.hasLength(groupAdminRoleName)==false)returnnull;try{returngetRoleByName(groupAdminRoleName);
iftheysupportastorealongwithaservicereturnnull;
if(roleMap.containsKey(role.getAuthority())==false)//thrownewIllegalArgumentException("Role:"+role.getAuthority()+"doesnot//exist");//
ifauserpropertynameequalsarolepropertyname,takethe*valuefromtouserpropertyanduseitfortheroleproperty.*/publicPropertiespersonalizeRoleParams(StringroleName,PropertiesroleParams,StringuserName,PropertiesuserProps)throwsIOException{Propertiesprops=null;//thisistrue
ifthesetismodified-->common//propertynamesexistprops=newProperties();booleanpersonalized=false;for(Objectkey:roleParams.keySet()){
if(userProps.containsKey(key)){props.put(key,userProps.get(key));personalized=true;
else{props.put(key,roleParams.get(key));
if(SECURITY_ROLE_REF.equals(localName)){inSecRoleRef=false;
if(AUTH_CONSTRAINT.equals(localName)){inAuthConstraint=false;
if(SECURITY_ROLE.equals(localName)){inSecRole=false;
if(ROLE_NAME.endsWith(localName)){
if(inSecRoleRef)roleName=currentValue.trim();
if(inAuthConstraint)inAuthConstraintRoles.add(currentValue.trim());;
if(inSecRole)inSecRoleRoles.add(currentValue.trim());
if(ROLE_LINK.endsWith(localName)){inSecRoleRefRoles.put(roleName,currentValue.trim());
if(SECURITY_ROLE_REF.equals(localName)){inSecRoleRef=true;
if(AUTH_CONSTRAINT.equals(localName)){inAuthConstraint=true;
if(SECURITY_ROLE.equals(localName)){inSecRole=true;
if(StringUtils.hasLength(adminRoleName)==false)returnnull;try{returngetRoleByName(adminRoleName);
if(StringUtils.hasLength(groupAdminRoleName)==false)returnnull;try{returngetRoleByName(groupAdminRoleName);
if(roleSet!=null)returnroleSet;returnemptySet;
if(roleMap!=null)return;LOGGER.info("Startreloadingrolesforservicenamed"+getName());FilewebXML=GeoServerExtensions.file("WEB-INF/web.xml");
if(webXML==null){thrownewIOException("Cannotopen/WEB-INF/web.xml");
if(roleMap.containsKey(role.getAuthority())==false)//thrownewIllegalArgumentException("Role:"+role.getAuthority()+"doesnot//exist");//
if(roleMap!=null)returnroleMap.get(role);returnnull;
if(roleSet!=null)returnroleSet.size();return0;}}
if(setRequiredFields){config.setServerURL(ldapServerUrl+"/"+basePath);config.setGroupSearchBase(GROUPS_BASE);
if(delegate.getContentDisposition()!=null){map.put("Content-Disposition",delegate.getContentDisposition());
if(m!=null&&!m.isEmpty()){map.putAll(m);
if(map==null||map.isEmpty())returnnull;String[][]headers=newString[map.size()][2];Listkeys=newArrayList(map.keySet());for(inti=0;i<headers.length;i++){headers[i][0]=(String)keys.get(i);headers[i][1]=(String)map.get(keys.get(i));
if(getFeatureSource()instanceofFeatureStore){try{finalFeatureStore<SimpleFeatureType,SimpleFeature>store=((FeatureStore<SimpleFeatureType,SimpleFeature>)getFeatureSource());finalList<Object>attributes=newArrayList<Object>();attributes.addAll(Arrays.asList(values));finalSimpleFeatureTypeft=store.getSchema();finalDefaultFeatureCollectioncollection=newDefaultFeatureCollection();finalSimpleFeaturefeature=SimpleFeatureBuilder.build(ft,attributes,SimpleFeatureBuilder.createDefaultFeatureId());collection.add(feature);store.addFeatures(collection);m_iCount++;
if(m_BaseDataObject!=null){try{finalFeatureCollection<SimpleFeatureType,SimpleFeature>features=getFeatureSource().getFeatures();returnnewGTRecordsetIterator(features);
else{returnnull;
if(m_BaseDataObject!=null){try{finalSimpleFeatureTypeft=getFeatureSource().getSchema();finalAttributeTypeat=ft.getType(i);returnat.getName().getLocalPart();
if(m_BaseDataObject!=null){try{finalSimpleFeatureTypeft=getFeatureSource().getSchema();finalAttributeTypeat=ft.getType(i);returnat.getBinding();
if(m_BaseDataObject!=null){try{finalSimpleFeatureTypeft=getFeatureSource().getSchema();returnft.getAttributeCount();
if((colType==Integer.class)||(colType==Short.class)||(colType==Byte.class)){header.addColumn(colName,'N',Math.min(fieldLen,16),0);
else
if((colType==Double.class)||(colType==Float.class)||(colType==Number.class)){finalintl=Math.min(fieldLen,33);header.addColumn(colName,'N',l,l/2);
else
if(java.util.Date.class.isAssignableFrom(colType)){header.addColumn(colName,'D',fieldLen,0);
else
if(colType==Boolean.class){header.addColumn(colName,'L',1,0);
else
if(CharSequence.class.isAssignableFrom(colType)){header.addColumn(colName,'C',Math.min(254,fieldLen),0);
else
if(Geometry.class.isAssignableFrom(colType)){continue;
else{thrownewIOException("Unabletowrite:"+colType.getName());
if(this.get("attributePanel")!=null){this.remove("attributePanel");
if(resourceinstanceofFeatureTypeInfo){this.add(newDataPanel("attributePanel",(FeatureTypeInfo)resource));
else
if(resourceinstanceofCoverageInfo){this.add(newBandsPanel("attributePanel",(CoverageInfo)resource));
iftheprocessfailssomehowtheoriginal"info"doesnotend*upwithanidset*/CoverageStoreInfoexpandedStore=getCatalog().getResourcePool().clone(info,true);CoverageStoreInfosavedStore=catalog.getFactory().createCoverageStore();//GR:thisshouldn'tfail,theCatalog.save(StoreInfo)APIdoesnotdeclareanyactionin//case//ofafailure!...strange,whyasavecan'tfail?//Still,becautiousandwrapitinatry/catchblocksothepagedoesnotblowuptry{//GeoServerEnvsubstitution;validatefirstcatalog.validate(expandedStore,false).throwIfInvalid();//GeoServerEnvsubstitution;forceto*AVOID*resolvingenvplaceholders...savedStore=catalog.getResourcePool().clone(info,false);//...andsavecatalog.save(savedStore);
if(getModel()!=null){setModelObject(null);
iftheothersubsystemscontinuetoworkproperlyinfaceofabsenceoflocks**@authorAndreaAime-GeoSolutions*/publicclassNullLockProviderimplementsLockProvider{publicResource.Lockacquire(finalStringlockKey){returnnewResource.Lock(){publicvoidrelease(){//nothingtodo
if(ctx.getParameterValues().containsKey(PARAM_DELAY)){intdelay=(Integer)ctx.getParameterValues().get(PARAM_DELAY);
if(delay>0){LOGGER.log(Level.INFO,"waitingfor"+delay+"milliseconds");try{Thread.sleep(delay);
if(Boolean.TRUE.equals(ctx.getParameterValues().get(PARAM_FAIL))){LOGGER.log(Level.INFO,"failingtask"+identifier);thrownewTaskException("purposelyfailedtask");
if(ctx.getParameterValues().containsKey(PARAM_DELAY_COMMIT)){intdelay=(Integer)ctx.getParameterValues().get(PARAM_DELAY_COMMIT);
if(delay>0){LOGGER.log(Level.INFO,"waitingtocommitfor"+delay+"milliseconds");try{Thread.sleep(delay);
if(attribute==null)attribute=MapLayerInfo.getRegionateAttribute(featureType);
if(attribute==null)thrownewServiceException("Regionatingattributehasnotbeenspecified");//MakesuretheattributeisactuallythereAttributeTypeattributeType=type.getType(attribute);
if(attributeType==null){thrownewServiceException("Couldnotfindregionatingattribute"+attribute+"inlayer"+featureType.getName());
if(!fs.getQueryCapabilities().supportsSorting(newSortBy[]{ff.sort(attribute,SortOrder.DESCENDING)}))thrownewServiceException("Nativesortingonthe"+attribute+"isnotpossibleforlayer"+featureType.getName());//makesureaspecialdbforthislayerandattributewillbecreatedreturnsuper.getDatabaseName(con,layer)+"_"+attribute;
if(parameters!=null&&parameters.length>0&&parameters[0]instanceofGetCoverageType){//checkwearegoingagainstagranuleGetCoverageTypegc=(GetCoverageType)parameters[0];StringcoverageId=gc.getCoverageId();
if(coverageId==null){thrownewWCS20Exception("RequiredparametercoverageIdismissing",WCS20Exception.WCS20ExceptionCode.MissingParameterValue,"coverageId");
if(coverage!=null){//settheactualcoveragenameStringactualCoverageId=NCNameResourceCodec.encode(coverage);gc.setCoverageId(actualCoverageId);//extractthegranulefilterFiltergranuleFilter=codec.getGranuleFilter(coverageId);//checkthefilteractuallymatchesonegranule
if(!readerHasGranule(coverage,granuleFilter)){thrownewWCS20Exception("Couldnotlocatecoverage"+coverageId,WCS20ExceptionCode.NoSuchCoverage,"coverageId");
if(previous==null||previous==Filter.INCLUDE){gc.setFilter(granuleFilter);
else{gc.setFilter(FF.and(previous,granuleFilter));
ifthecoveragehasthespecifiedgranule",e);
if(prefix!=null){returnprefix+":AbstractFeatureType";
if(this.prefix!=null){returnthis.prefix+":AbstractFeatureType";
if(prefix!=null){returnprefix+":AbstractFeatureCollectionBaseType";
if(this.prefix!=null){returnthis.prefix+":AbstractFeatureCollectionBaseType";
if(prefix!=null){returnprefix+":AbstractFeatureCollectionType";
if(this.prefix!=null){returnthis.prefix+":AbstractFeatureCollectionType";
ifyou//aredoingmorecomplexstuffthanweallow.ButIwillleavethisin//andcommentedout,incaseIamwrongandthisjunkdoeshaveause.//Ithinkperhapsitmayjustneedbetterobjects,thatcanactuallyuse//these?Sincethegeometryobjectstheyaregivencan'tusethem.classGeometryPropertyElementextendsNameSpaceElement{publicGeometryPropertyElement(Stringprefix){super(prefix);
if(prefix!=null){returnprefix+":GeometryPropertyType";
if(this.prefix!=null){returnthis.prefix+":GeometryPropertyType";
if(prefix!=null){returnprefix+":PointPropertyType";
if(this.prefix!=null){returnthis.prefix+":PointPropertyType";
if(prefix!=null){returnprefix+":pointProperty";
if(this.prefix!=null){returnthis.prefix+":pointProperty";
if(prefix!=null){returnprefix+":PolygonPropertyType";
if(this.prefix!=null){returnthis.prefix+":PolygonPropertyType";
if(prefix!=null){returnprefix+":polygonProperty";
if(this.prefix!=null){returnthis.prefix+":polygonProperty";
if(prefix!=null){returnprefix+":LineStringPropertyType";
if(this.prefix!=null){returnthis.prefix+":LineStringPropertyType";
if(prefix!=null){returnprefix+":lineStringProperty";
if(this.prefix!=null){returnthis.prefix+":lineStringProperty";
if(prefix!=null){returnprefix+":MultiPointPropertyType";
if(this.prefix!=null){returnthis.prefix+":MultiPointPropertyType";
if(prefix!=null){returnprefix+":multiPointProperty";
if(this.prefix!=null){returnthis.prefix+":multiPointProperty";
if(prefix!=null){returnprefix+":MultiLineStringPropertyType";
if(this.prefix!=null){returnthis.prefix+":MultiLineStringPropertyType";
if(prefix!=null){returnprefix+":multiLineStringProperty";
if(this.prefix!=null){returnthis.prefix+":multiLineStringProperty";
if(prefix!=null){returnprefix+":MultiPolygonPropertyType";
if(this.prefix!=null){returnthis.prefix+":MultiPolygonPropertyType";
if(prefix!=null){returnprefix+":multiPolygonProperty";
if(this.prefix!=null){returnthis.prefix+":multiPolygonProperty";
if(prefix!=null){returnprefix+":MultiGeometryPropertyType";
if(this.prefix!=null){returnthis.prefix+":MultiGeometryPropertyType";
if(prefix!=null){returnprefix+":multiGeometryProperty";
if(this.prefix!=null){returnthis.prefix+":multiGeometryProperty";
if(prefix!=null){returnprefix+":NullType";
if(this.prefix!=null){returnthis.prefix+":NullType";
if(prefix!=null){returnprefix+":null";
if(this.prefix!=null){returnthis.prefix+":null";
ifprocessingshouldstop,falseotherwise*/booleanstopOnError(Exceptione);/***Initializeanytransientortemporarystate.Thisshouldbecalledpriortoinvokingany*othermethodsonthetransform.*/voidinit();}
ifnobundlefound,thenonqualifiednameisused.**@parameTheexceptionwhosemessagetolocalize.*@paramlocaleThelocaletouse.*@returnThelocalizedmessage,or<code>null</code>
ifnonecouldbefound.*/publicstaticStringlocalize(IGeoServerExceptione,Localelocale){Class<?extendsIGeoServerException>clazz=e.getClass();while(clazz!=null){Stringlocalized=doLocalize(e.getId(),e.getArgs(),clazz,locale);
if(localized!=null){returnlocalized;
iftheexceptionparentclassisalsoageoserverexception//moveupthehierarchyandtrythat
if(IGeoServerException.class.isAssignableFrom(clazz.getSuperclass())){clazz=(Class<?extendsIGeoServerException>)clazz.getSuperclass();
else{clazz=null;
if(bundle==null){//couldnotlocateabundlereturnnull;
if(localized==null){
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Resourcelookupfailedforkey"+id+",class="+clazz);
iftherearearguments,formatthemessageaccordingly
if(args!=null&&args.length>0){localized=MessageFormat.format(localized,args);
if(baseName==null){thrownewNullPointerException();
if(lang!=null&&!"".equals(lang)){filename+="_"+lang;
if(props==null){props=newProperties();
if(in!=null){try{in.close();
if(selection.size()==0)return;dialog.setTitle(newParamResourceModel("confirmRemoval",this));//
ifthereissomethingtocancel,let'swarntheuseraboutwhat//couldgowrong,and
iftheuseraccepts,let'sdeletewhat'sneededdialog.showOkCancel(target,delegate=newGeoServerDialog.DialogDelegate(){protectedComponentgetContents(Stringid){//showaconfirmationpanelforalltheobjectswehavetoremoveModel<Boolean>model=newModel<Boolean>(SelectionGroupRemovalLink.this.disassociateRoles);returnremovePanel=newConfirmRemovalGroupPanel(id,model,selection){@OverrideprotectedIModel<String>canRemove(GeoServerUserGroupgroup){returnSelectionGroupRemovalLink.this.canRemove(group);
if(disassociateRoles){try{gaStore=GeoServerApplication.get().getSecurityManager().getActiveRoleService().createStore();gaStore=newRoleStoreValidationWrapper(gaStore);for(GeoServerUserGroupgroup:removePanel.getRoots()){List<GeoServerRole>list=newArrayList<GeoServerRole>();list.addAll(gaStore.getRolesForGroup(group.getGroupname()));for(GeoServerRolerole:list)gaStore.disAssociateRoleFromGroup(role,group.getGroupname());
iftheselectionhasbeenclearedoutit'ssignadeletion//occurred,sorefreshthetable
if(groups.getSelection().size()==0){setEnabled(false);target.add(SelectionGroupRemovalLink.this);target.add(groups);
if(group==null){thrownewWicketRuntimeException("Radiocomponent["+getPath()+"]cannotfinditsparentRadioGroup.AllRadiocomponentsmustbeachildoforbelowinthehierarchyofaRadioGroupcomponent.");
ifgeoservercodewantstocreateCAS*Proxytickets**<p>IfanHTTPsessionhasbeencreated,theassertionisstoredusing{@link*HttpSession#setAttribute(String,Object)}.**<p>Ifnosessionhasbeencreated,theassertionisstoredusing{@link*HttpServletRequest#setAttribute(String,Object)}*/publicstaticfinalStringCAS_ASSERTION_KEY="org.geoserver.security.cas.CasAssertion";/***createstheproxycallbackurlusingthecallbackurlprefixand{@link*#CAS_PROXY_RECEPTOR_PATTERN}**<p>iftheulrPrefixisnull,thereturnvalueisnull**@paramurlPrefix*/publicstaticStringcreateProxyCallBackURl(StringurlPrefix){returncreateCasURl(urlPrefix,CAS_PROXY_RECEPTOR_PATTERN);
if(casUrlPrefix==null)returnnull;StringresultURL=casUrlPrefix.endsWith("/")?casUrlPrefix.substring(0,casUrlPrefix.length()-1):casUrlPrefix;returnresultURL+casUri;}}
if((Boolean)getDefaultModelObject()){SortedSet<GeoServerRole>roles=GeoServerApplication.get().getSecurityManager().getActiveRoleService().getRolesForGroup(object.getGroupname());buffer.append("[");for(GeoServerRolerole:roles){buffer.append(role.getAuthority()).append("");
if(roles.size()>0){//removelastdelimiterbuffer.setLength(buffer.length()-1);
if(val!=null){feature.setAttribute(field,Converters.convert(val,type));
if(simplified!=null){simplified.accept(newAbstractStyleVisitor(){publicvoidvisit(org.geotools.styling.Rulerule){rulesFound.set(true);//noneedtoscaninsiderules
if(fi!=null){//untilwearescrollingthisgeneratorweareinvectormodeEnvFunction.setLocalValue(OUTPUT_MODE,VECTOR_MODE);this.fi=fi;
if(fi==null){returnnull;
if(symbolizers.size()==0){//skiplayersthathavenoactivesymbolizerscontinue;
if(pm==null){//wehavetoskipthisonecontinue;
if(!featureRetrieved){//anexceptionhasoccurred,releasethefeatureiteratorcontext.closeIterator(fi);EnvFunction.setLocalValue(OUTPUT_MODE,null);
if(!fi.hasNext()){//cleanuptheoutputmode,thenextlayermightbeencodedasarasteroverlayEnvFunction.setLocalValue(OUTPUT_MODE,null);context.closeIterator(fi);
if(authKeyProps==null){synchronize();
if(fileWatcher.isStale())//reload
ifnecessaryauthKeyProps=fileWatcher.getProperties();StringuserName=authKeyProps.getProperty(key);
if(StringUtils.hasLength(userName)==false){LOGGER.warning("Cannotfinduserforauthkey:"+key);returnnull;
if(theUser.isEnabled()==false){LOGGER.info("Founduser"+theUser.getUsername()+"forkey"+key+",butthisuserisdisabled");returnnull;
iftheprevioussynchronizefailed
if(backupFile.exists())thrownewIOException("Thefile:"+backupFile.getCanonicalPath()+"hastoberemovedfirst");authKeyProps=newProperties();PropertiesoldProps=newProperties();//check
ifpropertyfileexistsandreload
if(propFile.exists()){FileUtils.copyFile(propFile,backupFile);FileInputStreaminputFile=newFileInputStream(backupFile);try{oldProps.load(inputFile);
if(reverseMap.containsKey(user.getUsername())){authKeyProps.put(reverseMap.get(user.getUsername()),user.getUsername());
else{authKeyProps.put(createAuthKey(),user.getUsername());counter++;
if(backupFile.exists())backupFile.delete();fileWatcher=newPropertyFileWatcher(propFile);returncounter;}}
if(null!=target&&null!=value){result=Converters.convert(value,target);
else{result=(T)value;
ifapriornestedproperty*inthepathisnull;*@throwsIllegalArgumentException
ifnosuchpropertyexistsforthegivenobject*/publicObjectgetProperty(finalObjectinput,finalStringpropertyName)throwsIllegalArgumentException{
if(inputinstanceofInfo&&Predicates.ANY_TEXT.getPropertyName().equals(propertyName)){returngetAnyText((Info)input);
if(propertyinstanceofCollection){textProps.addAll(((Collection<String>)property));
else
if(property!=null){textProps.add(String.valueOf(property));
if(offset<0||offset>propertyNames.length){thrownewArrayIndexOutOfBoundsException("offset:"+offset+",properties:"+propertyNames.length);
if(offset==propertyNames.length){returninput;
if(null==input){thrownewIllegalArgumentException("Propertynotfound:"+Joiner.on('.').join(Arrays.copyOf(propertyNames,offset+1)));
if(propName.indexOf('[')>0&&propName.endsWith("]")){returngetIndexedProperty(input,propertyNames,offset);
if(inputinstanceofCollection){@SuppressWarnings("unchecked")Collection<Object>col=(Collection<Object>)input;List<Object>result=newArrayList<Object>(col.size());for(Objecto:col){
if(o==null){continue;
ifoneofthenestedpropertiesisnotfoundjustignoreandmove//tothenextone,wecanhavemixedcollections(e.g.,layergrouplayers)try{Objectvalue=getProperty(o,propName);Objectnested=getProperty(value,propertyNames,offset+1);result.add(nested);
if(inputinstanceofMap){
if(!((Map<?,?>)input).containsKey(propName)){thrownewIllegalArgumentException("Property"+propName+"doesnotexistinMapproperty"+(offset>0?propertyNames[offset-1]:""));
else{//specialcaseforResourceInfoboundingbox,usedthederivedproperty
if("boundingBox".equalsIgnoreCase(propName)&&inputinstanceofResourceInfo){try{value=((ResourceInfo)input).boundingBox();
else{value=OwsUtils.get(input,propName);
ifournestedaccessstumblesontoanull,wereturnanullvaluetoallow//forfulltextsearchestowork(e.g.,workspace.name,butworkspacecanbenull//inbothlayergroupsandstyles
if(value==null){returnnull;
if(col==null){returnfalse;
if(!(colinstanceofList)){thrownewRuntimeException("Indexedpropertyaccessisnotvalidforproperty"+colPropName);
if(index>list.size()){returnnull;
if(null==colProp){returnnull;
if(colProp.getClass().isArray()){intlength=Array.getLength(colProp);List<Object>array=newArrayList<Object>(length);for(intj=0;j<length;j++){array.add(Array.get(colProp,j));
if(!(colPropinstanceofCollection)){thrownewIllegalArgumentException("Specifiedproperty"+colPropName+"isnotacollectionorarray:"+colProp);
if(obj!=null){Class<?>clazz=ModificationProxy.unwrap(obj).getClass();ClassMappingsclassMappings=ClassMappings.fromImpl(clazz);checkState(classMappings!=null,"Noclassmappingsfoundforclass"+clazz.getName());Class<?>interf=classMappings.getInterface();props=fullTextProperties(interf);
if(FULL_TEXT_PROPERTIES.isEmpty()){loadFullTextProperties();
if(props==null){props=ImmutableSet.of();
if(!FULL_TEXT_PROPERTIES.isEmpty()){return;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;SecuredWMTSLayerother=(SecuredWMTSLayer)obj;
if(delegate==null){
if(other.delegate!=null)returnfalse;
else
if(!delegate.equals(other.delegate))returnfalse;
if(policy==null){
if(other.policy!=null)returnfalse;
else
if(!policy.equals(other.policy))returnfalse;returntrue;
if(!wfs.getServiceLevel().contains(WFSInfo.ServiceLevel.TRANSACTIONAL)){thrownewWFSException(request,"Transactionsupportisnotenabled");
ifwehavenotprovidedproperauthorization.**<p>ThespecificationallowsaWFStoimplementPARTIALsucess
ifitisunabletorollbackall*therequestedchanges.ThisimplementationisabletoofferfullRollbacksupportandwill*notrequiretheuseofPARTIALsuccess.**@paramtransactionRequest*@throwsServiceExceptionDOCUMENTME!*@throwsWfsException*@throwsWfsTransactionExceptionDOCUMENTME!*/protectedTransactionResponseexecute(TransactionRequestrequest)throwsException{//somedefaults
if(request.getReleaseAction()==null){request.setReleaseActionAll();
if(typeName.getNamespaceURI()!=null){namespaceURI=typeName.getNamespaceURI();
else{namespaceURI=catalog.getDefaultNamespace().getURI();
if(meta==null){Stringmsg="Featuretype'"+name+"'isnotavailable:";thrownewWFSTransactionException(msg,ServiceException.INVALID_PARAMETER_VALUE,element.getHandle());
if(catalog.getDefaultNamespace().getURI().equals(URI)){elementNameDefault=newQName(meta.getName());
if(stores.containsKey(elementName)){//typeNamealreadyloadedcontinue;
if(sourceinstanceofFeatureStore){FeatureStore<?extendsFeatureType,?extendsFeature>store;store=(FeatureStore<?extendsFeatureType,?extendsFeature>)source;store.setTransaction(transaction);stores.put(elementName,source);
if(elementNameDefault!=null){stores.put(elementNameDefault,source);
else{Stringmsg=elementName+"isread-only";thrownewWFSTransactionException(msg,(String)null,element.getHandle());
if(authorizationID!=null){
if(!wfs.getServiceLevel().getOps().contains(WFSInfo.Operation.LOCKFEATURE)){thrownewWFSException(request,"Locksupportisnotenabled");
if(!lockExists(authorizationID)){Stringmesg="AttemptingtousealockIDthatdoesnotexist"+",ithaseitherexpiredorwasenteredwrong.";thrownewWFSException(request,mesg,"InvalidParameterValue");
if(request.getVersion().startsWith("2")&&e.getCause()instanceofFeatureLockException&&request.getLockId()==null){exception=newWFSTransactionException(e.getMessage(),e,"MissingParameterValue");
if(exception!=null){transaction.rollback();
else{fireBeforeCommit(request);transaction.commit();committed=true;////Letsdealwiththelocks////Q:WhytalktoDatayouask//A:OnlyclassthatknowsalltheDataStores////WereallyneedtoaskallDataStorestorelease/refresh//becausewemayhavelockedFeatureswiththisAuthorizations//onthem,eventhoughwedidnotrefertotheminthis//transaction.////Q:Whyhere,whynow?//A:Theopperationwasasuccess,andwehavecompletedthe//opperation////Wealsoneedtodothis
iftheopperationisnotasuccess,//youcanfindthissamecodeintheabortmethod//StringlockId=request.getLockId();
if(lockId!=null){
if(request.isReleaseActionAll()){lockRelease(lockId);
else
if(request.isReleaseActionSome()){lockRefresh(lockId);
if(result.getTransactionResult().getStatus().getPARTIAL()!=null)//{//thrownewWFSException("CancelingPARTIALresponse");//
if(result.getTransactionResult().getStatus().getFAILED()!=null)//{////transactionfailed,rollitback//transaction.rollback();//
else{//transaction.commit();//result.getTransactionResult().getStatus().setSUCCESS(//WfsFactory.eINSTANCE.createEmptyType());//
if(exception!=null){//WFS2.0wantsustothrowtheexception
if(request.getVersion()!=null&&request.getVersion().startsWith("2")){
if(!(exceptioninstanceofWFSException&&((WFSException)exception).getCode()!=null)){//wraptogetthedefaultcodeexception=newWFSException(request,exception);
ifnoinsert//occured,howweverinsertresultsneedstohaveatleastone//"FeatureId"eliement,sp//wecreateanFeatureIdwithanemptyfidListinsertedFeatures=result.getInsertedFeatures();
if(insertedFeatures!=null&&insertedFeatures.isEmpty()){result.addInsertedFeature(null,filterFactory.featureId("none"));
if(tx!=null){//TransactionPlugincannotaltertransactionssincetheadventofWFS2.0,it'sleft//likethatand//willbedeprecatedfor(TransactionPlugintp:transactionPlugins){tp.beforeTransaction(tx);
if(tx!=null&&tr!=null){for(TransactionPlugintp:transactionPlugins){tp.afterTransaction(tx,tr,committed);
if(tx!=null){tp.beforeCommit(tx);
if(handler.getElementClass().isAssignableFrom(type)){matches.add(handler);
if(matches.isEmpty()){//trytoinstantiateoneStringmsg="Notransactionelementhandlerfor:("+type+")";thrownewWFSTransactionException(msg);
if(matches.size()>1){//sortbyclasshierarchyComparatorcomparator=newComparator(){publicintcompare(Objecto1,Objecto2){TransactionElementHandlerh1=(TransactionElementHandler)o1;TransactionElementHandlerh2=(TransactionElementHandler)o2;
if(h2.getElementClass().isAssignableFrom(h1.getElementClass())){return-1;
if(authentication!=null){Objectprincipal=authentication.getPrincipal();
if(principalinstanceofUserDetails){username=((UserDetails)principal).getUsername();
else
if(principalinstanceofString){//OAuthusername=principal.toString();
if(extendedProperties!=null){for(Entry<?,?>e:extendedProperties.entrySet()){ObjectpropKey=e.getKey();ObjectpropValue=e.getValue();transaction.putProperty(propKey,propValue);
if(transaction==null){return;//notransactiontorollback
if(lockId!=null){
if(request.isReleaseActionSome()){try{lockRefresh(lockId);
else
if(request.isReleaseActionAll()){try{lockRelease(lockId);
iflockIDexists*@seeorg.geotools.data.Data#lockExists(java.lang.String)*/privatebooleanlockExists(StringlockId)throwsException{LockFeaturelockFeature=newLockFeature(wfs,catalog);returnlockFeature.exists(lockId);
if(!servicesFile.exists()){thrownewFileNotFoundException("Couldnotfindservices.xmlunder:"+dir.getAbsolutePath());
if(!validate){return;
if(gridSubsets==null||gridSubsets.size()==0){error(validatable,"GridSubsetsEditor.validation.empty");return;
if(gridSetName==null){thrownewIllegalStateException("GridSetnameisnull");
if(zoomStart!=null&&zoomStop!=null){
if(zoomStart.intValue()>zoomStop.intValue()){error(validatable,"GridSubsetsEditor.validation.zoomLevelsError");return;
if(null==gridSet){error(validatable,"GridSubsetsEditor.validation.gridSetNotFound",gridSetName);return;
if(extent!=null){
if(extent.isNull()||!extent.isSane()){error(validatable,"GridSubsetsEditor.validation.invalidBounds");
if(!intersects){error(validatable,"GridSubsetsEditor.validation.boundsOutsideCoverage");
if(params==null){message=newResourceModel(resourceKey).getObject();
else{message=newParamResourceModel(resourceKey,GridSubsetsEditor.this,(Object[])params).getObject();
if(gridsetExists){gridsetLevels=gridSet.getNumLevels();gridsetDescription=gridSet.getDescription();
else{gridsetLevels=gridSubset.getZoomStop()==null?1:gridSubset.getZoomStop().intValue();
if(!gridsetExists){gridSetLabel.add(newAttributeModifier("style",newModel<String>("color:red;text-decoration:line-through;")));getPage().warn("GridSet"+gridSubset.getGridSetName()+"doesnotexist");
if(null!=gridsetDescription){gridSetLabel.add(newAttributeModifier("title",newModel<String>(gridsetDescription)));
if(null==selectedGridset){return;
if(componentinstanceofFormComponent){FormComponent<?>formComponent=(FormComponent<?>)component;formComponent.processInput();
ifmodelvalueisn'tnullsetOutputMarkupId(true);
if(modelObject!=null&&modelObject>=min&&modelObject<=max){setModelObject(modelObject);
else{setModelObject(null);
if(min!=null){zoomStop.setAllowedMin(min.intValue());minCachedLevel.setAllowedMin(min.intValue());maxCachedLevel.setAllowedMin(min.intValue());
if(max!=null){minCachedLevel.setAllowedMax(max.intValue());maxCachedLevel.setAllowedMax(max.intValue());
if(minCached!=null){maxCachedLevel.setAllowedMin(minCached.intValue());
if(null!=target){target.add(zoomStop);target.add(minCachedLevel);target.add(maxCachedLevel);
ifweknowaboutthisformatdirectlyStringfactoryClassName=formatToDataStoreFactory.get(format);
if(factoryClassName!=null){try{ClassfactoryClass=Class.forName(factoryClassName);return(DataAccessFactory)factoryClass.newInstance();
ifnot,let'ssee
ifwehaveafiledatastorefactorythatknowsabouttheextensionStringextension="."+format;for(DataAccessFactorydataAccessFactory:DataStoreUtils.getAvailableDataStoreFactories()){
if(dataAccessFactoryinstanceofFileDataStoreFactorySpi){FileDataStoreFactorySpifactory=(FileDataStoreFactorySpi)dataAccessFactory;for(StringhandledExtension:factory.getFileExtensions()){
if(extension.equalsIgnoreCase(handledExtension)){returnfactory;
if(factory==null){continue;
if(factory.getDisplayName()!=null&&factory.getDisplayName().equals(type)){for(Map.Entrye:formatToDataStoreFactory.entrySet()){
if(e.getValue().equals(factory.getClass().getCanonicalName())){return(String)e.getKey();
if(info==null){thrownewRestException("Nosuchdatastore"+storeName,HttpStatus.NOT_FOUND);
if(File.class.isAssignableFrom(param.getType())){Objectresult=param.lookUp(paramValues);
if(resultinstanceofFile){directory=(File)result;
else
if(URL.class.isAssignableFrom(param.getType())){Objectresult=param.lookUp(paramValues);
if(resultinstanceofURL){directory=URLs.urlToFile((URL)result);
if(directory!=null&&!"directory".equals(param.key)){directory=directory.getParentFile();
if(directory!=null){break;
if(directory==null||!directory.exists()||!directory.isDirectory()){thrownewRestException("Nofilesfordatastore"+storeName,HttpStatus.NOT_FOUND);
if(targetDataStoreFormat==null){//setthesametypeasthesourcetargetDataStoreFormat=sourceDataStoreFormat;
if(info==null){LOGGER.info("Auto-configuringdatastore:"+storeName);info=builder.buildDataStore(storeName);add=true;//TODO:shouldcheck
ifthestoreactuallysupportscharset
if(characterset!=null&&characterset.length()>0){info.getConnectionParameters().put("charset",characterset);
if(!targetDataStoreFormat.equals(sourceDataStoreFormat)){//targetisdifferent,weneedtocreateittargetFactory=lookupDataStoreFactory(targetDataStoreFormat);
if(targetFactory==null){thrownewRestException("Unabletocreatedatastoreoftype"+targetDataStoreFormat,HttpStatus.BAD_REQUEST);
else{updateParameters(info,namespace,targetFactory,uploadedFile);
else{LOGGER.info("Usingexistingdatastore:"+storeName);//lookupthetargetdatastorefactorytargetDataStoreFormat=lookupDataStoreFactoryFormat(info.getType());
if(targetDataStoreFormat==null){thrownewRuntimeException("Unabletolocatedatastorefactoryoftype"+info.getType());
if(targetDataStoreFormat.equals(sourceDataStoreFormat)){save=true;updateParameters(info,namespace,factory,uploadedFile);
else{canRemoveFiles=true;
if(add){catalog.validate(info,true).throwIfInvalid();catalog.add(info);
else
if(save){catalog.validate(info,false).throwIfInvalid();catalog.save(info);
if(characterset!=null&&characterset.length()>0){params.put("charset",characterset);
ifitisthecasethatthesourcedoesnotmatchthetargetweneedto//copythedataintothetarget
if(!targetDataStoreFormat.equals(sourceDataStoreFormat)&&(sourceinstanceofDataStore&&dsinstanceofDataStore)){//copyoverthefeaturetypesDataStoresourceDataStore=(DataStore)source;DataStoretargetDataStore=(DataStore)ds;for(StringfeatureTypeName:sourceDataStore.getTypeNames()){//doesthefeaturetypealreadyexistinthetarget?try{targetDataStore.getSchema(featureTypeName);
if(!(featureSourceinstanceofFeatureStore)){LOGGER.warning(featureTypeName+"isnotwritable,skipping");continue;
if("overwrite".equalsIgnoreCase(update)){LOGGER.fine("Removingexistingfeaturesfrom"+featureTypeName);//killallfeaturesfeatureStore.removeFeatures(Filter.INCLUDE);
ifsettononedonottrytoconfigure//datafeaturetypes//Stringconfigure=form.getFirstValue("configure");
if("none".equalsIgnoreCase(configure)){response.setStatus(HttpStatus.CREATED.value());return;
if(!"all".equalsIgnoreCase(configure)&&i>0){break;
if(ftinfo==null){//autoconfigurethefeaturetypeaswellftinfo=builder.buildFeatureType(fs);builder.lookupSRS(ftinfo,true);builder.setupBounds(ftinfo);
if(ftinfo.getId()==null){//doacheckforatypealreadynamedthisnameinthecatalog,
ifitis//already//theretrytorenameit
if(catalog.getFeatureTypeByName(namespace,ftinfo.getName())!=null){LOGGER.warning(String.format("Featuretype%salreadyexistsinnamespace%s,"+"attemptingtorename",ftinfo.getName(),namespace.getPrefix()));intx=1;StringoriginalName=ftinfo.getName();do{ftinfo.setName(originalName+x);x++;
if(!catalog.validate(layer,true).isValid()){valid=false;
else{LOGGER.info("Updatedfeaturetype"+ftinfo.getName());catalog.validate(ftinfo,false).throwIfInvalid();catalog.save(ftinfo);
ifneeded
if(createNewSource){source.dispose();
ifwecan
if(method.isInline()&&canRemoveFiles){
if(uploadedFile.getType()==Resource.Type.RESOURCE){
if(!uploadedFile.parent().delete()){LOGGER.info("Unabletodelete"+uploadedFile.path());
else
if(uploadedFile.getType()==Resource.Type.DIRECTORY){for(Resourcefile:files){
if(file.getType()==Resource.Type.RESOURCE){
if(!file.delete()){LOGGER.info("Unabletodelete"+file.path());
if(method.isInline()){//Mappingoftheinputdirectory
if(method==UploadMethod.url){//ForURLuploadmethod,workspaceandStoreNamearenotconsidereddirectory=createFinalRoot(null,null,postRequest);
else{directory=createFinalRoot(workspaceName,storeName,postRequest);
iftheRequestisaPOSTrequest,inordertosearchforanexistingcoverageResourcedirectory=null;
if(isPost&&storeName!=null){//Check
ifthecoveragealreadyexistsCoverageStoreInfocoverage=catalog.getCoverageStoreByName(storeName);
if(coverage!=null){
if(workspaceName==null||coverage.getWorkspace().getName().equalsIgnoreCase(workspaceName)){//IfthecoverageexiststhentheassociateddirectoryisdefinedbyitsURLdirectory=Resources.fromPath(URLs.urlToFile(newURL(coverage.getURL())).getPath(),catalog.getResourceLoader().get(""));
if(directory==null){directory=catalog.getResourceLoader().get(Paths.path("data",workspaceName,storeName));
if("shp".equalsIgnoreCase(format)||"h2".equalsIgnoreCase(format)){//specialcaseforshapefiles,sinceshapefiledatastorecanhandledirectoriesjust//returnthedirectory,thishandlesthecaseofauseruploadingazipwithmultiple//shapefilesinitandthesamehappensforH2returndirectory;
else{returnsuper.findPrimaryFile(directory,format);
if(!factory.canProcess(connectionParameters)){//TODO:logtheparametersatthedebuglevelthrownewRestException("Unabletoconfiguredatastore,badparameters.",HttpStatus.INTERNAL_SERVER_ERROR);
if(File.class==p.type||URL.class==p.type){
if("directory".equals(p.key)){//setthevaluetobethedirectoryf=f.getParentFile();
if(URI.class.equals(p.type)){converted=f.toURI();
else
if(URL.class.equals(p.type)){converted=URLs.fileToUrl(f);
if(converted!=null){connectionParameters.put(p.key,converted);
else{connectionParameters.put(p.key,f);
if(p.required){try{p.lookUp(connectionParameters);
if(factory.getDisplayName().equalsIgnoreCase("SpatiaLite")){connectionParameters.put(JDBCDataStoreFactory.DATABASE.getName(),f.getAbsolutePath());
else
if(factory.getDisplayName().equalsIgnoreCase("H2")){//weneedtoextracttheH2databasenameStringdatabaseFile=f.getAbsolutePath();
if(f.isDirectory()){//
iftheuseruploadedaZIPfileweneedtogetthedatabasefileinsideOptional<Resource>found=Resources.list(uploadedFile,resource->resource.name().endsWith("data.db")).stream().findFirst();
if(!found.isPresent()){//ouchnodatabasefilefoundjustthrowanexceptionthrownewRestException(String.format("H2databasefilecouldnotbefoundindirectory'%s'.",f.getAbsolutePath()),HttpStatus.INTERNAL_SERVER_ERROR);
if(!matcher.matches()){//strangethedatabasefileisnotendingindata.dbthrownewRestException(String.format("InvalidH2databasefile'%s'.",databaseFile),HttpStatus.INTERNAL_SERVER_ERROR);
if(defaultParams==null){thrownewRuntimeException("Unabletoautocreateparametersfor"+factory.getDisplayName());
if(e.getValue()instanceofString){Stringstring=(String)e.getValue();string=string.replace("@NAME@",info.getName()).replace("@DATA_DIR@",dataDirRoot);e.setValue(string);
if(node.hasAttribute("expiry")){lockFeature.setExpiry((BigInteger)node.getAttributeValue("expiry"));
else{lockFeature.setExpiry(BigInteger.valueOf(5));
if(node.hasAttribute("lockAction")){lockFeature.setLockAction((AllSomeType)node.getAttributeValue("lockAction"));
else{lockFeature.setLockAction(AllSomeType.ALL_LITERAL);
if(items==null){//returnanemptylistincasewestilldon'tknowaboutthestore
if(storeId==null)returnnewArrayList<LayerResource>();//else,grabtheresourcelisttry{List<LayerResource>result;StoreInfostore=getCatalog().getStore(storeId,StoreInfo.class);Map<String,LayerResource>resources=newHashMap<String,LayerResource>();WMSStoreInfowmsInfo=(WMSStoreInfo)store;CatalogBuilderbuilder=newCatalogBuilder(getCatalog());builder.setStore(store);List<Layer>layers=wmsInfo.getWebMapServer(null).getCapabilities().getLayerList();for(Layerl:layers){
if(l.getName()==null){continue;
if(resource!=null)resource.setStatus(LayerStatus.PUBLISHED);
ifavailable*<li>Usingcopyconstructors
ifavailable*<li>FallingbackonXStreamserialization
iftheabovefails**@authorAndreaAime-GeoSolutions*/classModificationProxyCloner{privatestaticfinalXStreamPersisterFactoryXSTREAM_PERSISTER_FACTORY=newXStreamPersisterFactory();staticfinalLoggerLOGGER=Logging.getLogger(ModificationProxyCloner.class);staticfinalMap<Class,Class>CATALOGINFO_INTERFACE_CACHE=newConcurrentHashMap<Class,Class>();/***Besteffortobjectcloningutility,triesdifferentlightweightstrategies,thenfallsback*oncopybyXStreamserialization(weusethatoneaswehaveanumberofhookstoavoiddeep*copyingthecatalog,andre-attachingtoit,inthere)**@paramsource*/static<T>Tclone(Tsource){//null?
if(source==null){returnnull;
if(ModificationProxy.handler(source)!=null){returnsource;
if(sourceinstanceofCatalogInfo){//mumble...shouldn'twewrapthisoneinamodificationproxyobject?return(T)ModificationProxy.create(source,getDeepestCatalogInfoInterface((CatalogInfo)source));
ifaknownimmutable?
if(sourceinstanceofString||sourceinstanceofByte||sourceinstanceofShort||sourceinstanceofInteger||sourceinstanceofFloat||sourceinstanceofDouble||sourceinstanceofBigInteger||sourceinstanceofBigDecimal){return(T)source;
if(sourceinstanceofCloneable){//methodutilsdoesnotseemtoworkagainst"clone()"...//return(T)MethodUtils.invokeExactMethod(source,"clone",null,null);Methodmethod=source.getClass().getDeclaredMethod("clone");
if(Modifier.isPublic(method.getModifiers())&&method.getParameterTypes().length==0){return(T)method.invoke(source);
if(copyConstructor!=null){try{return(T)copyConstructor.newInstance(source);
if(sourceinstanceofSerializable){return(T)cloneSerializable((Serializable)source);
else{XStreamPersisterpersister=XSTREAM_PERSISTER_FACTORY.createXMLPersister();XStreamxs=persister.getXStream();Stringxml=xs.toXML(source);Tcopy=(T)xs.fromXML(xml);returncopy;
if(result==null){List<Class<?>>interfaces=ClassUtils.getAllInterfaces(sourceClass);//collectonlyCatalogInforelatedinterfacesList<Class>cis=newArrayList<Class>();for(Classclazz:interfaces){
if(CatalogInfo.class.isAssignableFrom(clazz)){cis.add(clazz);
if(cis.size()==0){result=null;
else
if(cis.size()==1){result=cis.get(0);
else{Collections.sort(cis,newComparator<Class>(){@Overridepublicintcompare(Classc1,Classc2){
if(c1.isAssignableFrom(c2)){return1;
else
if(c2.isAssignableFrom(c1)){return-1;
else{return0;
if(source==null){//nothingtocopyreturnnull;
if(sourceinstanceofSet){copy=newHashSet<T>();
else{copy=newArrayList<T>();
if(deepCopy){for(Tobject:source){TobjectCopy=clone(object);copy.add(objectCopy);
else{copy.addAll(source);
if(source==null){//nothingtocopyreturnnull;
if(deepCopy){for(Map.Entry<K,V>entry:source.entrySet()){KkeyCopy=clone(entry.getKey());VvalueCopy=clone(entry.getValue());copy.put(keyCopy,valueCopy);
else{copy.putAll(source);
if(closed){thrownewIOException("Thisoutputstreamhasalreadybeenclosed");
if(!closed){gzipstream.flush();
if(closed){thrownewIOException("Cannotwritetoaclosedoutputstream");
if(closed){thrownewIOException("Cannotwritetoaclosedoutputstream");
if(StringUtils.isNotEmpty(GeoServerExtensions.getProperty(GEOSERVER_XFRAME_SHOULD_SET_POLICY))){shouldSetPolicy=Boolean.parseBoolean(GeoServerExtensions.getProperty(GEOSERVER_XFRAME_SHOULD_SET_POLICY));
if(StringUtils.isNotEmpty(GeoServerExtensions.getProperty(GEOSERVER_XFRAME_POLICY))){framePolicy=GeoServerExtensions.getProperty(GEOSERVER_XFRAME_POLICY);
if(shouldSetPolicy()){HttpServletResponsehttpResponse=(HttpServletResponse)response;httpResponse.setHeader(X_FRAME_OPTIONS,getFramePolicy());
if(target!=null){returnConverters.convert(value,target);
else{return(T)value;
if(isPost){url=newURL(postUrl);for(inti=0;i<runs;i++)threads[i]=newTestPostThread(url,req);
else{
if(url==null){url=newURL(req);
ifit'sreallyaproblemwiththeservlet//containerorthisclientcode...Seemslikethereshould//besomewaytotellthethreadstomaybetrytowaitfora//bit?sleep(wait);}			while(finished<runs){sleep(1);			}PrintStreamos=System.out;
if((log!=null)&&(log.getAbsoluteFile()!=null)){log=log.getAbsoluteFile();os=newPrintStream(newFileOutputStream(log));
switch(((TestGetThread)threads[i]).getResult()){caseHttpURLConnection.HTTP_OK:good++;default:}
if(tpt.getTime2()==null){os.print(result+"Couldnotconnect\n");
else
if(tpt.getTime3()==null){os.print(result+"Couldnotcompleteread\n");
else{os.print(tpt.getResult()+",");os.print(tpt.getTime1().getTime()+",");
if(tpt.getTime2()!=null){os.print(tpt.getTime2().getTime()+",");
if(tpt.getTime3()!=null){os.print(tpt.getTime3().getTime()+",");doubletime=(tpt.getTime3().getTime()-tpt.getTime1().getTime())/1000.0;os.print("time(s):"+time+"\n");
else{os.print("null\n");
if(args.length==0){return;
if("-n".equals(key)&&(i<args.length)){Stringval=args[i++];runs=Integer.parseInt(val);
else{
if("-r".equals(key)&&(i<args.length)){Stringval=args[i++];Filef=newFile(val);FileReaderfr=newFileReader(f);BufferedReaderbr=newBufferedReader(fr);Stringt="";					//doesthisreadyloopworkhere?Itdoesn'tfor//thethreads...chwhile(br.ready())t+=br.readLine();req=t;//thisalsowillgetanullfortheURL,needto//specifythatsomewhere...ch
else{
if("-u".equals(key)&&(i<args.length)){Stringval=args[i++];url=newURL(val);
else{
if("-l".equals(key)&&(i<args.length)){Stringval=args[i++];log=newFile(val);
else{
if("-p".equals(key)){isPost=true;
else{//usage
if("-w".equals(key)&&i<args.length){wait=Integer.parseInt(args[i++]);
else{usage();
if(!readOnly){super.setObject(object);
if(element.isActive()){element.setIndex(i++);
else{element.setIndex(null);
if(b!=null){b.setLatestBatchRun(br);
if(templates!=null){criteria.add(Restrictions.eq("template",templates));
if(batch.getConfiguration()==null){criteria.add(Restrictions.eq("configuration.template",false));
else{criteria.add(Restrictions.eq("configuration.id",batch.getConfiguration().getId()));
if(splitName.length>1){criteria.createAlias("configuration","configuration").add(Restrictions.eq("configuration.name",splitName[0])).add(Restrictions.eq("name",splitName[1])).add(Restrictions.eq("removeStamp",0L)).add(Restrictions.eq("configuration.removeStamp",0L));
else{criteria.add(Restrictions.isNull("configuration")).add(Restrictions.eq("name",splitName[0])).add(Restrictions.eq("removeStamp",0L));
if(batch.getConfiguration()!=null){batch.getConfiguration().getBatches().remove(batch.getName());
if(Hibernate.isInitialized(be.getRuns())){be.getRuns().clear();
if(Hibernate.isInitialized(batch.getBatchRuns())){batch.getBatchRuns().clear();
if(!clone.isTemplate()){batch.setEnabled(false);
if(attName!=null){Attributeatt=parameter.getTask().getConfiguration().getAttributes().get(attName);
if(att!=null){returnatt.getValue();
else{returnnull;
else{returnparameter.getValue();
if(rawValue!=null){rawParameterValues.put(parameter.getName(),rawValue);
if(info.isRequired()){
if(!rawParameters.containsKey(info.getName())||"".equals(rawParameters.get(info.getName()))){validationErrors.add(newValidationError(ValidationErrorType.MISSING,info.getName(),null,taskType.getName()));
ifanyoftheparametersareinvalidormissing.*/privateMap<String,Object>parseParameters(TaskTypetaskType,Map<String,String>rawParameters)throwsTaskException{List<ValidationError>validationErrors=newArrayList<ValidationError>();//firstcheckallrequiredvalidateRequired(taskType,rawParameters,validationErrors);//parseMap<String,Object>result=newHashMap<String,Object>();for(Entry<String,String>parameter:rawParameters.entrySet()){ParameterInfoinfo=taskType.getParameterInfo().get(parameter.getKey());
if(info==null){validationErrors.add(newValidationError(ValidationErrorType.INVALID_PARAM,parameter.getKey(),null,taskType.getName()));break;
if(value==null){validationErrors.add(newValidationError(ValidationErrorType.INVALID_VALUE,parameter.getKey(),parameter.getValue(),taskType.getName()));break;
else{result.put(parameter.getKey(),value);
if(!validationErrors.isEmpty()){thrownewTaskException("Therewerevalidationerrors:"+validationErrors);
ifthecleanupwasentirelysuccessful,false
ifoneormoretaskclean-ups*failed,inwhichcasethelogsshouldbechecked.*/publicbooleancleanup(Tasktask){TaskTypetype=taskTypes.get(task.getType());try{type.cleanup(createContext(task));returntrue;
ifthecleanupwasentirelysuccessful,false
ifoneormoretaskclean-ups*failed,inwhichcasethelogsshouldbechecked.*@throwsTaskException*/publicMap<String,Object>getParameterValues(Tasktask)throwsTaskException{returnparseParameters(taskTypes.get(task.getType()),getRawParameterValues(task));
ifthecleanupwasentirelysuccessful,false
ifoneormoretaskclean-ups*failed,inwhichcasethelogsshouldbechecked.*/publicbooleancleanup(Configurationconfig){booleansuccess=true;//let'strytofigureouttheidealordertoclean-uptasks,//mergingtheordersofthedifferentbatchesandturningthemaround//thisalgorithmwillworkperfectly
iftherearenocontradictionsinthere//(forexampleB1=T1,T2andB2=T2,T1)//inthatcase,thechosenorderwilldependoncoincidenceList<Task>orderedTasks=newArrayList<Task>();for(Tasktask:config.getTasks().values()){intposition=orderedTasks.size();task=dataUtil.init(task);for(BatchElementel:task.getBatchElements()){
if(el.getIndex()>0){intindexTaskBefore=orderedTasks.indexOf(el.getBatch().getElements().get(el.getIndex()-1).getTask());
if(indexTaskBefore>=0&&indexTaskBefore<position){position=indexTaskBefore;
if(canCleanup(task)){success=cleanup(task)&&success;
if(canCleanup(task)){returntrue;
if(oinstanceofAttributeInfo){returntype.equals(((AttributeInfo)o).type)&&dependsOn.equals(((AttributeInfo)o).dependsOn);
if(thisDomain!=null&&thisDomain.contains("")){
if(domain==null){domain=newLinkedHashSet<String>(thisDomain);
else{domain.addAll(thisDomain);
if(thisDomain!=null&&!thisDomain.contains("")){
if(domain==null){domain=newLinkedHashSet<String>(thisDomain);
else{domain.retainAll(thisDomain);
if(!configuration.getAttributes().containsKey(attName)){it.remove();
if(!domains.containsKey(att.getName())||updateAttributes!=null&&updateAttributes.contains(att.getName())){domains.put(att.getName(),mergeDomain(att,configuration));
if(depedentParam!=null){StringattName=dataUtil.getAssociatedAttributeName(depedentParam);
if(attName!=null){dependentAttributes.add(attName);
if(att!=null){domains.put(attName,mergeDomain(att,config));
iftemplate)
if(!configuration.isTemplate()){validateRequired(taskType,rawParameters,validationErrors);
if(info==null){validationErrors.add(newValidationError(ValidationErrorType.INVALID_PARAM,parameter.getKey(),null,taskType.getName()));continue;
if(parameter.getValue()!=null&&!"".equals(parameter.getValue())){ParameterTypept=info.getType();List<String>dependsOnValues=newArrayList<String>();for(ParameterInfodependsOn:info.getDependsOn()){Stringvalue=rawParameters.get(dependsOn.getName());
if(value==null){validationErrors.add(newValidationError(ValidationErrorType.MISSING_DEPENDENCY,dependsOn.getName(),parameter.getKey(),taskType.getName()));
if(!pt.validate(parameter.getValue(),dependsOnValues)){validationErrors.add(newValidationError(ValidationErrorType.INVALID_VALUE,parameter.getKey(),parameter.getValue(),taskType.getName()));continue;
if(info.getType().getActions().contains(action)){for(ParameterInfodependsOn:info.getDependsOn()){values.add(getRawParameterValue(parameter.getTask().getParameters().get(dependsOn.getName())));
ifforsomereasontheuserhas//associatedanattribute//withparametersthathavethesameactionbutdifferentdependentvalues,//theresultisundefined.
if(!monitor.isEnabled())return;//specialcaseforhibernate,weneedtohaveasessioninordertomakethisworkSessionFactorysessionFactory=null;
if(monitor.getDAO()instanceofHibernateMonitorDAO2){sessionFactory=((HibernateMonitorDAO2)monitor.getDAO()).getSessionFactory();HibUtil.setUpSession(sessionFactory);
if(InternalHostname.get().equals(data.getInternalHost())){//markstartasINTERRUPTEDdata.setStatus(Status.INTERRUPTED);monitor.getDAO().save(data);
if(sessionFactory!=null){HibUtil.tearDownSession(sessionFactory,null);
if(pageParams.length%2==1)thrownewIllegalArgumentException("Thepageparametersarrayshouldcontainanevennumberofelements");PageParametersresult=newPageParameters();for(inti=0;i<pageParams.length;i+=2){Stringname=pageParams[i];Stringvalue=pageParams[i+1];//startingwithwicket6thevaluecannotbenull,inthatcasethe//paramshouldnotbeprovided
if(value!=null){result.add(name,value);
if(!complex.getData().isEmpty()&&complex.getData().get(0)instanceofXMLEncoderDelegate){XMLEncoderDelegatedelegate=(XMLEncoderDelegate)complex.getData().get(0);Listproperties=newArrayList();properties.add(newObject[]{delegate.getProcessParameterIO().getElement(),delegate});returnproperties;
if(cd.getData().size()==0){cd.getData().add(instance.getText().toString());
if(store!=null){store.dispose();
if(params==null){returnnull;
if(store.getName()==null){store.setName(factory.getDisplayName());
if(monitor.isCanceled()){break;
ifSRScannotbefoundtry{FeatureTypeInfofeatureType=cb.buildFeatureType(dataStore.getFeatureSource(typeName));featureType.setStore(null);featureType.setNamespace(null);SimpleFeatureSourcefeatureSource=dataStore.getFeatureSource(typeName);//DeferboundscalculationfeatureType.setNativeBoundingBox(EMPTY_BOUNDS);featureType.setLatLonBoundingBox(EMPTY_BOUNDS);featureType.getMetadata().put("recalculate-bounds",Boolean.TRUE);//addattributesCatalogFactoryfactory=catalog.getFactory();SimpleFeatureTypeschema=featureSource.getSchema();for(AttributeDescriptorad:schema.getAttributeDescriptors()){AttributeTypeInfoatt=factory.createAttribute();att.setName(ad.getLocalName());att.setBinding(ad.getType().getBinding());featureType.getAttributes().add(att);
if(dataStore==null){dataStore=createDataStore(data);//storeinordertolaterdispose//TODO:comeupwithabetterschemeforcachingthedatastoretask.getMetadata().put(DataStore.class,dataStore);
if(task.getMetadata().containsKey(DataStore.class)){DataStoredataStore=(DataStore)task.getMetadata().get(DataStore.class);dataStore.dispose();task.getMetadata().remove(DataStore.class);
if(params!=null&&dataStoreFactory.canProcess(params)){DataStoredataStore=dataStoreFactory.createDataStore(params);
if(dataStore!=null){returndataStore;
if(dataStoreFactoryinstanceofFileDataStoreFactorySpi){Filef=null;
if(datainstanceofSpatialFile){f=((SpatialFile)data).getFile();
if(datainstanceofDirectory){f=((Directory)data).getFile();
if(f!=null){Map<String,Serializable>map=newHashMap<String,Serializable>();map.put("url",relativeDataFileURL(URLs.fileToUrl(f).toString(),catalog));
if(data.getCharsetEncoding()!=null){//@todothismaponlyworkforshapefilemap.put("charset",data.getCharsetEncoding());
if(dataStoreFactoryinstanceofJDBCDataStoreFactory){Databasedb=null;
if(datainstanceofDatabase){db=(Database)data;
if(datainstanceofTable){db=((Table)data).getDatabase();
if(db!=null){returndb.getParameters();
if(datainstanceofDatabase){db=(Database)data;
if(datainstanceofTable){db=((Table)data).getDatabase();
if(db!=null){returndb.getParameters();
if(dataStoreFactory==null){synchronized(this){
if(dataStoreFactory==null){try{dataStoreFactory=dataStoreFactoryClass.newInstance();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;DataStoreFormatother=(DataStoreFormat)obj;
if(dataStoreFactoryClass==null){
if(other.dataStoreFactoryClass!=null)returnfalse;
else
if(!dataStoreFactoryClass.equals(other.dataStoreFactoryClass))returnfalse;returntrue;}}
if(LayerGroupInfo.Mode.EO.equals(group.getMode())){layers.add(group.getRootLayer());
if(group.getStyles()==null||group.getStyles().size()==0){s=null;
else{s=group.getStyles().get(i);
if(pinstanceofLayerInfo){LayerInfol=(LayerInfo)p;layers.add(l);
else
if(pinstanceofLayerGroupInfo){allLayers((LayerGroupInfo)p,layers);
else
if(p==null&&s!=null){expandStyleGroup(s,group.getBounds()==null?null:group.getBounds().getCoordinateReferenceSystem(),layers,null);
if(pinstanceofLayerGroupInfo){LayerGroupInfog=(LayerGroupInfo)p;allGroups(g,groups);
if(LayerGroupInfo.Mode.EO.equals(group.getMode())){styles.add(group.getRootLayerStyle());
if(pinstanceofLayerInfo){styles.add(group.getStyles().get(i));
else
if(pinstanceofLayerGroupInfo){allStyles((LayerGroupInfo)p,styles);
else
if(p==null&&s!=null){expandStyleGroup(s,group.getBounds()==null?null:group.getBounds().getCoordinateReferenceSystem(),null,styles);
switch(group.getMode()){caseEO:layers.add(group.getRootLayer());break;caseCONTAINER:
if(root){thrownewUnsupportedOperationException("LayerGroupmode"+Mode.CONTAINER.getName()+"cannotberendered");
if(pinstanceofLayerInfo){LayerInfol=(LayerInfo)p;layers.add(l);
else
if(pinstanceofLayerGroupInfo){allLayersForRendering((LayerGroupInfo)p,layers,false);
else
if(p==null&&s!=null){expandStyleGroup(s,group.getBounds()==null?null:group.getBounds().getCoordinateReferenceSystem(),layers,null);
switch(group.getMode()){caseEO:styles.add(group.getRootLayerStyle());break;caseCONTAINER:
if(root){thrownewUnsupportedOperationException("LayerGroupmode"+Mode.CONTAINER.getName()+"cannotberendered");
if(pinstanceofLayerInfo){styles.add(group.getStyles().get(i));
else
if(pinstanceofLayerGroupInfo){allStylesForRendering((LayerGroupInfo)p,styles,false);
else
if(p==null&&s!=null){expandStyleGroup(s,group.getBounds()==null?null:group.getBounds().getCoordinateReferenceSystem(),null,styles);
if(layers.isEmpty()){return;
if(crsEnvelope!=null){ReferencedEnveloperefEnvelope=newReferencedEnvelope(crsEnvelope);this.group.setBounds(refEnvelope);
else{this.group.setBounds(null);
if(layers.isEmpty()){return;
if(bounds==null){bounds=l.getResource().getLatLonBoundingBox();latlon=true;
if(bounds==null){thrownewIllegalArgumentException("Couldnotcalculateboundsfromlayerwithnobounds,"+l.getName());
if(latlon){re=resource.getLatLonBoundingBox();
else{re=resource.boundingBox();
if(re==null){re=resource.getLatLonBoundingBox();
if(re==null){thrownewIllegalArgumentException("Couldnotcalculateboundsfromlayerwithnobounds,"+l.getName());
if(!CRS.equalsIgnoreMetadata(crs,e.getCoordinateReferenceSystem())){returne.transform(crs,true);
iftheLayerGroupcontainsrecursivestructures**@returntrue
iftheLayerGroupcontainsitself,oranotherLayerGroupcontainsitself*/publicStack<LayerGroupInfo>checkLoops(){Stack<LayerGroupInfo>path=newStack<LayerGroupInfo>();
if(checkLoops(group,path)){returnpath;
else{returnnull;
if(path==null){return"";
ifalayergroupcontainsrecursivestructures**@paramgroupThecurrentlayergroup*@parampathStackofeachvisited/parentLayerGroup*@returntrue
iftheLayerGroupcontainsitself,oranotherLayerGroupcontainsitself*/privatestaticbooleancheckLoops(LayerGroupInfogroup,Stack<LayerGroupInfo>path){path.push(group);
if(group.getLayers()!=null){intsize=group.getLayers().size();for(inti=0;i<size;i++){PublishedInfochild=group.getLayers().get(i);StyleInfos;//Handleincompletelayergroups,especiallythoseconstructedbythe//XStreamPersister
if(group.getStyles()==null||group.getStyles().size()==0){s=null;
else{s=group.getStyles().get(i);
if(childinstanceofLayerGroupInfo){
if(isGroupInStack((LayerGroupInfo)child,path)){path.push((LayerGroupInfo)child);returntrue;
else
if(checkLoops((LayerGroupInfo)child,path)){returntrue;
else
if(child==null&&s!=null){
if(checkStyleGroupLoops(s,group,path)){returntrue;
ifastylegroupcontainstheenclosinglayergroup,orotherrecursivestructures.**@paramstyleGroupThestylegroup*@paramgroupThecurrentlayergroup*@parampathStackofeachvisited/parentLayerGroup*@returntrue
ifthestylegroupcontainsitself,oranotherLayerGroupcontainsitself*/privatestaticbooleancheckStyleGroupLoops(StyleInfostyleGroup,LayerGroupInfogroup,Stack<LayerGroupInfo>path){try{StyledLayerDescriptorsld=styleGroup.getSLD();finalboolean[]hasLoop={false};sld.accept(newGeoServerSLDVisitorAdapter((Catalog)GeoServerExtensions.bean("catalog"),group.getBounds()==null?null:group.getBounds().getCoordinateReferenceSystem()){privatefinalIllegalStateExceptionrecursionException=newIllegalStateException("Stylegroupcontainsrecursivestructure");@Overridepublicvoidvisit(StyledLayerDescriptorsld){try{super.visit(sld);
if(recursionException.equals(e)){hasLoop[0]=true;
else{throwe;
if(namedLayer.getName()!=null&&namedLayer.getName().equals(group.getName())){throwrecursionException;
if(child!=null){
if(isGroupInStack(child,path)){path.push(child);throwrecursionException;
else
if(checkLoops(child,path)){throwrecursionException;
if(groupInPath.getId()!=null&&groupInPath.getId().equals(group.getId())){returntrue;
if(layers==null){layers=newArrayList<>();
if(styles==null){styles=newArrayList<>();
if(p==null){p=catalog.getLayerByName(namedLayer.getName());
if(p==null){thrownewServiceException("Nolayerorlayergroupwithname\""+namedLayer.getName()+"\"");
if(dataStoreFeatureTypes.get(0).getName().equals("points")){pointsTypeInfo=dataStoreFeatureTypes.get(0);linesTypeInfo=dataStoreFeatureTypes.get(1);
else{pointsTypeInfo=dataStoreFeatureTypes.get(1);linesTypeInfo=dataStoreFeatureTypes.get(0);
if("file".equals(location.getScheme())){//needtheparentFileparentDir=newFile(location).getParentFile();location=parentDir.toURI().normalize();
if(layerInfo==null){returnwrapObject(newArrayList(),ArrayList.class);
if(layerInfo!=null&&layerInfo.getResource()instanceofFeatureTypeInfo){ResourceInfoobj=layerInfo.getResource();Collection<PropertyDescriptor>attributes=null;/*Check
ifit'sfeaturetypeorcoverage*/
if(objinstanceofFeatureTypeInfo){FeatureTypeInfofTpInfo;fTpInfo=(FeatureTypeInfo)obj;LayerAttributesListout=newLayerAttributesList(layerName);try{attributes=fTpInfo.getFeatureType().getDescriptors();for(PropertyDescriptorattr:attributes){out.addAttribute(attr.getName().getLocalPart(),attr.getType().getBinding().getSimpleName());
if(index>=getAttributesCount())returnnull;intcnt=0;for(Stringkey:attributes.keySet()){
if(index==cnt)returnkey;cnt++;
if(format.equals(outputFormat)||(outputFormat==null&&BaseRequest.JSON_MIME.equals(format))){link.setRel(Link.REL_SELF);link.setTitle("Thisdocument");
if(linkUpdater!=null){linkUpdater.accept(format,link);
if(referenceValue!=null){setting.setReferenceValue(referenceValue);
if(referenceValue!=null){assertXpathExists("//defaultValue/referenceValue",diDOM);assertXpathEvaluatesTo(referenceValue,"//defaultValue/referenceValue",diDOM);
if(referenceValue!=null){assertTrue("UnmarshalledreferenceValuedoesnotmatchtheoriginalone",di2.getDefaultValue().getReferenceValue().equals(referenceValue));
if(port>0){builder.port(port);
if(null!=schema){sb.append(SLASH).append(schema);
if(!"postgresql".equals(location.getScheme())){//don'tparse,returnnewobjectreturnnewInstance();
ifnootherpartsexist,otherwiseit'sschemaStringschema=null;
if(paths.length>2){schema=paths[1];
iftheyaren'tnull,otherwiseusesomeprimenumbersasplace//holdersreturn(host!=null)?host.hashCode():17^((port!=null)?port.hashCode():37)^((username!=null)?username.hashCode():57)^((schema!=null)?schema.hashCode():97)^((password!=null)?password.hashCode():137)^((database!=null)?database.hashCode():197);
if(this==obj){returntrue;
if(obj==null){returnfalse;
if(getClass()!=obj.getClass()){returnfalse;
if(!Objects.equals(this.host,other.host)){returnfalse;
if(!Objects.equals(this.database,other.database)){returnfalse;
if(!Objects.equals(this.schema,other.schema)){returnfalse;
if(!Objects.equals(this.username,other.username)){returnfalse;
if(!Objects.equals(this.password,other.password)){returnfalse;
if(!Objects.equals(this.port,other.port)){returnfalse;
ifnoDuplicatesparameterissettoFALSE.*/publicabstractList<Object>getDomainValues(Filterfilter,booleannoDuplicates);/***Returnsthedomainsummary.Ifthecountislowerthan<code>expandLimit</code>thenonlythe*countwillbereturned,otherwiseminandmaxwillalsobereturned**@paramfeatures*@paramattribute*@paramexpandLimit*@return*/protectedDomainSummarygetDomainSummary(FeatureCollectionfeatures,Stringattribute,intexpandLimit){//grabdomain,butatmostexpandLimit+1,toknow
iftherearetoomany
if(expandLimit!=0){TreeSetuniqueValues=DimensionsUtils.getUniqueValues(features,attribute,expandLimit+1);
if(uniqueValues.size()<=expandLimit||expandLimit<0){returnnewDomainSummary(uniqueValues);
if(loadDataInMemory()){returnHistogramUtils.buildHistogram(getDomainValues(filter,false),resolutionSpec);
if(Number.class.isAssignableFrom(getDimensionType())){DomainSummarysummary=getDomainSummary(filter,0);//emptydomaincase?
if(summary.getMin()==null||summary.getMax()==null){returnEMPTY_HISTOGRAM;
else
if(Date.class.isAssignableFrom(getDimensionType())){DomainSummarysummary=getDomainSummary(filter,0);Datemin=(Date)summary.getMin();Datemax=(Date)summary.getMax();//emptydomaincase?
if(min==null||max==null){returnEMPTY_HISTOGRAM;
else{//assumingcustomdimension,willhandleasstrings,oncethereissupport//forcustomdimensionsofdifferenttype(forstructuredreaders)thiswill//havetobemodifiedTreeMap<Object,Object>results=groupByDomainOnExpression(filter,dimensionProperty,dimensionAttributeName,String.class);//mapoutdomainrepresentationandhistogramvaluerepresentationList<Integer>counts=results.values().stream().map(v->((Number)v).intValue()).collect(Collectors.toList());StringdomainRepresentation=results.keySet().stream().map(v->v.toString()).collect(Collectors.joining(","));returnTuple.tuple(domainRepresentation,counts);
ifacollectioncanoptimizeoutavisit*(completelymissingrightnow,thatwouldbeasignificantAPIchange).**@return*/privatebooleanloadDataInMemory(){Stringvalue=GeoServerExtensions.getProperty("WMTS_HISTOGRAM_IN_MEMORY");returnBoolean.getBoolean(value);
if(resourceInfoinstanceofFeatureTypeInfo){//forvectorsthisinformationeasilyavailablereturnTuple.tuple(dimensionInfo.getAttribute(),dimensionInfo.getEndAttribute());
if(resourceInfoinstanceofCoverageInfo){returnCoverageDimensionsReader.instantiateFrom((CoverageInfo)resourceInfo).getDimensionAttributesNames(getDimensionName());
if(lockProviderName==null){delegate=newMemoryLockProvider();
else{Objectprovider=GeoWebCacheExtensions.bean(lockProviderName);
if(provider==null){thrownewRuntimeException("Couldnotfindlockprovider"+lockProvider+"inthespringapplicationcontext");
else
if(!(providerinstanceofLockProvider)){thrownewRuntimeException("Foundbean"+lockProvider+"inthespringapplicationcontext,butitwasnotaLockProvider");
else{delegate=(LockProvider)provider;
ifregisteredinthespringcontextorsetvia{@link*#set(GWC)}.**@returnThe{@linkGWC}mediatorbean*@throwsIllegalStateException
ifno{@linkGWC}instancewasfound.*/publicstaticsynchronizedGWCget(){
if(GWC.INSTANCE==null){GWC.INSTANCE=GeoServerExtensions.bean(GWC.class);
if(GWC.INSTANCE==null){thrownewIllegalStateException("Nobeanoftype"+GWC.class.getName()+"foundbyGeoServerExtensions");
if(this.catalogLayerEventListener!=null){catalog.removeListener(this.catalogLayerEventListener);
if(this.catalogStyleChangeListener!=null){catalog.removeListener(this.catalogStyleChangeListener);
ifthegivenstyleisactuallycached
if(log.isLoggable(Level.FINE)){log.fine("Truncateforlayer/stylecalled.Checking
ifstyle'"+styleName+"'iscachedforlayer'"+layerName+"'");
if(!isStyleCached(layerName,styleName)){log.fine("Style'"+styleName+"'isnotcachedforlayer"+layerName+"'.Noneedtotruncate.");return;
if(gridSubset==null){//layermaynolongerhavethisgridsubset,butwewanttotruncateanyremaining//tilesGridSetgridSet=gridSetBroker.get(gridSetId);gridSubset=GridSubsetFactory.createGridSubSet(gridSet);
if(intersectingBounds==null){continue;
if(!layerBounds.intersects(reqBounds)){log.fine("Requestedtruncationboundsdonotintersectcachedlayerbounds,ignoringtruncaterequest");returnnull;
if(styleName==null){styleNames=getCachedStyles(layerName);
if(styleNames.size()==0){styleNames.add("");
else{styleNames=Collections.singleton(styleName);
if(gridSetName==null){gridSetIds=layer.getGridSubsets();
else{gridSetIds=Collections.singleton(gridSetName);
if(format==null){mimeTypes=layer.getMimeTypes();
else{try{mimeTypes=Collections.singletonList(MimeType.createFromFormat(format));
if(gridSubset==null){//layermaynolongerhavethisgridsubset,butwewanttotruncateanyremaining//tilesGridSetgridSet=gridSetBroker.get(gridSetId);gridSubset=GridSubsetFactory.createGridSubSet(gridSet);
if(style.length()==0||style.equals(defaultStyle)){log.finer("'"+style+"'isthelayer'sdefaultstyle,"+"notaddingaparameterfilter");parameters=null;
else{parameters=Collections.singletonMap("STYLES",style);
if(defaultStyle!=null){cachedStyles.add(defaultStyle);
if(parameterFilters!=null){for(ParameterFilterpf:parameterFilters){
if(!"STYLES".equalsIgnoreCase(pf.getKey())){continue;
iftheremovaloftheentirecacheforthelayerhassucceeded,{@code*false}
iftherewasn'tacacheforthatlayer.*/publicsynchronizedbooleanlayerRemoved(finalStringprefixedName){try{returnstorageBroker.delete(prefixedName);
if(instance!=null){instance.reload();
ifsucceededor{@codenull}
ifitwasn't*possible.**<p>Preconditions:**<ul>*<li><code>{@linkGetMapRequest#isTiled()request.isTiled()}==true</code>*</ul>**@paramrequest*@paramrequestMistmatchTargettargetstringbuilderwheretowritethereasonoftherequest*mismatchwiththetilecache*@returntheGWCgeneratedtileresult
iftherequestmatchesatilecache,or{@codenull}*otherwise.*/publicfinalConveyorTiledispatch(finalGetMapRequestrequest,StringBuilderrequestMistmatchTarget){finalStringlayerName=request.getRawKvp().get("LAYERS");/**Thisisaquickwayofchecking
iftherequestwasforasinglelayer.Wecan'treally*userequest.getLayers()becauseintheeventthatalayerGroupwasrequested,therequest*parserturneditintoalistofactualLayers*/
if(layerName.indexOf(',')!=-1){requestMistmatchTarget.append("morethanonelayerrequested");returnnull;
if(!tld.layerExists(layerName)){requestMistmatchTarget.append("notatilelayer");returnnull;
if(!tileLayer.isEnabled()){requestMistmatchTarget.append("tilelayerdisabled");returnnull;
if(getConfig().isSecurityEnabled()){Stringbboxstr=request.getRawKvp().get("BBOX");Stringsrs=request.getRawKvp().get("SRS");ReferencedEnvelopebbox=null;try{bbox=(ReferencedEnvelope)newBBoxKvpParser().parse(bboxstr);
if(srs!=null){try{bbox=newReferencedEnvelope(bbox,CRS.decode(srs));
if(null==tileReq){returnnull;
if(!isCachingPossible(tileLayer,request,requestMistmatchTarget)){returnnull;
if(!tileLayerFormats.contains(mimeType)){requestMistmatchTarget.append("notilecacheforrequestedformat");returnnull;
if(CRS.getAxisOrder(crs)==AxisOrder.NORTH_EAST){axisFlip=true;
if(axisFlip){tileBounds=newBoundingBox(bbox.getMinY(),bbox.getMinX(),bbox.getMaxY(),bbox.getMaxX());
else{tileBounds=newBoundingBox(bbox.getMinX(),bbox.getMinY(),bbox.getMaxX(),bbox.getMaxY());
if(crsMatchingGridSubsets.isEmpty()){requestMistmatchTarget.append("nocacheexistsforrequestedCRS");returnnull;
if(gridSubset==null){requestMistmatchTarget.append("requestdoesnotaligntogrid(s)");for(GridSubsetgs:crsMatchingGridSubsets){requestMistmatchTarget.append('\'').append(gs.getName()).append("'");
if(log.isLoggable(Level.FINE)){e.printStackTrace();log.log(Level.FINE,"Exceptioncaughtcheckinggwcdispatchpreconditions",e);
if(null!=request.getRemoteOwsType()||null!=request.getRemoteOwsURL()){requestMistmatchTarget.append("requestusesremoteOWS");returnfalse;
if(null!=parameterFilters&&parameterFilters.size()>0){filters=newHashMap<String,ParameterFilter>();for(ParameterFilterpf:parameterFilters){filters.put(pf.getKey().toUpperCase(),pf);
else{filters=Collections.emptyMap();
if(request.isTransparent()){//
if(!filterApplies(filters,request,"TRANSPARENT")){//returnfalse;//
if(request.getEnv()!=null&&!request.getEnv().isEmpty()){
if(!filterApplies(filters,request,"ENV",requestMistmatchTarget)){returnfalse;
if(request.getFormatOptions()!=null&&!request.getFormatOptions().isEmpty()){
if(!filterApplies(filters,request,"FORMAT_OPTIONS",requestMistmatchTarget)){returnfalse;
if(0.0!=request.getAngle()){
if(!filterApplies(filters,request,"ANGLE",requestMistmatchTarget)){returnfalse;
if(null!=request.getRawKvp().get("BGCOLOR")){
if(!filterApplies(filters,request,"BGCOLOR",requestMistmatchTarget)){returnfalse;
if(0!=request.getBuffer()){
if(!filterApplies(filters,request,"BUFFER",requestMistmatchTarget)){returnfalse;
if(null!=request.getCQLFilter()&&!request.getCQLFilter().isEmpty()){
if(!filterApplies(filters,request,"CQL_FILTER",requestMistmatchTarget)){returnfalse;
if(request.getElevation()!=null&&!request.getElevation().isEmpty()){
if(null!=request.getElevation().get(0)&&!filterApplies(filters,request,"ELEVATION",requestMistmatchTarget)){returnfalse;
if(null!=request.getFeatureId()&&!request.getFeatureId().isEmpty()){
if(!filterApplies(filters,request,"FEATUREID",requestMistmatchTarget)){returnfalse;
if(null!=request.getFilter()&&!request.getFilter().isEmpty()){booleansameFilters=checkFilter(request.getFilter(),request.getCQLFilter(),filters);
if(!sameFilters&&!filterApplies(filters,request,"FILTER",requestMistmatchTarget)){returnfalse;
if(null!=request.getSortBy()&&!request.getSortBy().isEmpty()){
if(!filterApplies(filters,request,"SORTBY",requestMistmatchTarget)){returnfalse;
if(null!=request.getPalette()){
if(!filterApplies(filters,request,"PALETTE",requestMistmatchTarget)){returnfalse;
if(null!=request.getSld()){//
if(!filterApplies(filters,request,"SLD",requestMistmatchTarget)){//returnfalse;//
if(null!=request.getSldBody()){//
if(!filterApplies(filters,request,"SLD_BODY",requestMistmatchTarget)){//returnfalse;//
if(null!=request.getStartIndex()){
if(!filterApplies(filters,request,"STARTINDEX",requestMistmatchTarget)){returnfalse;
if(null!=request.getMaxFeatures()){
if(!filterApplies(filters,request,"MAXFEATURES",requestMistmatchTarget)){returnfalse;
if(null!=request.getTime()&&!request.getTime().isEmpty()){
if(null!=request.getTime().get(0)&&!filterApplies(filters,request,"TIME",requestMistmatchTarget)){returnfalse;
if(null!=request.getViewParams()&&!request.getViewParams().isEmpty()){
if(!filterApplies(filters,request,"VIEWPARAMS",requestMistmatchTarget)){returnfalse;
if(null!=request.getFeatureVersion()){
if(!filterApplies(filters,request,"FEATUREVERSION",requestMistmatchTarget)){returnfalse;
ifCQL_FILTERlistandFILTERlistsareequals**@paramfilter*@paramcqlFilter*@paramfilters*/privatebooleancheckFilter(Listfilter,ListcqlFilter,Map<String,ParameterFilter>filters){//Check
ifthetwofiltersareequalsandtheFILTERparameterisnotaParameterFilter//Checkisdoneonly
iftheFILTERparameterisnotpresent
if(!filters.containsKey("FILTER")){//Check
ifthefilterListandcqlFilterlistsarenotnullandnotemptybooleanhasFilter=filter!=null&&!filter.isEmpty();booleanhasCQLFilter=cqlFilter!=null&&!cqlFilter.isEmpty();//Ifthefiltersarepresent,check
iftheyareequals.//InthiscasetheFilterListhasbeentakenfromtheCQL_FILTERlist
if(hasCQLFilter&&hasFilter){//Firstcheckonthesizeintsize=filter.size();
if(size==cqlFilter.size()){//Checksameelementsbooleanequals=true;//Loopontheelementsfor(inti=0;i<size;i++){equals&=filter.get(i).equals(cqlFilter.get(i));
if(parameterFilter==null){requestMistmatchTarget.append("noparameterfilterexistsfor").append(key);returnfalse;
if(!applies){requestMistmatchTarget.append(key).append("doesnotapplytoparameterfilterofthesamename");
ifno{@linkTileLayer}named{@codelayeName}isfound*/publicTileLayergetTileLayerByName(StringlayerName)throwsIllegalArgumentException{TileLayertileLayer;try{tileLayer=tld.getTileLayer(layerName);
if{@codensPrefix==null}*/publicIterable<?extendsTileLayer>getTileLayersByNamespacePrefix(finalStringnsPrefix){
if(nsPrefix==null){returngetTileLayers();
if(namespaceFilter==null){Iterable<TileLayer>tileLayers=getTileLayers();returntileLayers;
if(-1==layerName.indexOf(':')){returnfalse;
if(layerInfo!=null){NamespaceInfolayerNamespace=layerInfo.getResource().getNamespace();
if(namespaceFilter.equals(layerNamespace)){returntrue;
if(!Sets.intersection(gridSetIds,layerGrids).isEmpty()){layerNames.add(layer.getName());
ifthediskquotamodulehasbeen*disabled(i.e.throughthe{@codeGWC_DISKQUOTA_DISABLED=true}environmentvariable)*/publicDiskQuotaConfiggetDiskQuotaConfig(){
if(!isDiskQuotaAvailable()){returnnull;
switchtothelockproviderjustconfiguredupdateLockProvider(gwcConfig.getLockProviderName());
if(!isDiskQuotaAvailable()){returnnull;
ifdiskquotaisdisabled*/publicQuotagetGlobalUsedQuota(){
if(!isDiskQuotaAvailable()){returnnull;
ifdiskquotaisnotenabled,theaggregatedquotausedbyalllayer*cachedforthegivengridsetotherwise.*/publicQuotagetUsedQuotaByGridSet(finalStringgridSetName){checkNotNull(gridSetName,"GridSetnameisnull");
if(!isDiskQuotaAvailable()){returnnull;
if(!gridSetName.equals(tileSet.getGridsetId())){return;
ifnospecificlimithasbeen*setforthatlayer*/publicQuotagetQuotaLimit(finalStringlayerName){
if(!isDiskQuotaAvailable()){returnnull;
if(layerQuotas==null){returnnull;
if(layerName.equals(lq.getLayer())){returnnewQuota(lq.getQuota());
ifcan'tbedetermined*/publicQuotagetUsedQuota(finalStringlayerName){
if(!isDiskQuotaAvailable()){returnnull;
if(request!=null){Dispatcher.REQUEST.set(request);
else{Dispatcher.REQUEST.remove();
ifmissingMap<String,String>parameterMap=newHashMap<String,String>();Map<String,String[]>params=actualRequest.getParameterMap();booleanhasService=false;for(Map.Entry<String,String[]>param:params.entrySet()){Stringkey=param.getKey();Stringvalue=param.getValue()[0];parameterMap.put(key,value);
if("service".equalsIgnoreCase(key)&&(value==null||value.isEmpty()||!"WMS".equalsIgnoreCase(value))){thrownewGeoWebCacheException("Failedtocascaderequest,serviceshouldbeWMSbutitwas:'"+value+"'");
if(!hasService){parameterMap.put("service","WMS");
if(isDiskQuotaAvailable()){try{monitor.getQuotaStore().createLayer(layerName);
ifthere'saTileLayernamed{@codelayerName}*/publicbooleantileLayerExists(finalStringlayerName){returntld.layerExists(layerName);
if(namespaceURI==null||XMLConstants.DEFAULT_NS_PREFIX.equals(namespaceURI)){namespace=getCatalog().getDefaultNamespace();
else{namespace=getCatalog().getNamespaceByURI(namespaceURI);
if(tileLayerExists(tileLayerName)){affectedLayers.add(tileLayerName);
if(!tileLayerExists(tileLayerName)){continue;
if(null==oldGridSet){thrownewIllegalArgumentException("GridSet"+oldGridSetName+"doesnotexist");
if(needsTruncate){log.warning("###ChangesingridsetforcetruncationofaffectedTilelayers");log.info("###Oldgridset:"+oldGridSet);log.info("###Newgridset:"+newGridSet);
if(null!=(gridSubet=layer.getGridSubset(oldGridSetName))){affectedLayers.put(layer,gridSubet);layer.removeGridSubset(oldGridSetName);
if(needsTruncate){deleteCacheByGridSetId(layer.getName(),oldGridSetName);
if(isRename&&!needsTruncate){/////TODO:quotaStore.renameGridSet(oldGridSetName,newGidSetName);//
if(null!=gridSetExtent&&sameSRS){gridSetExtent=newGridSet.getOriginalExtent().intersection(gridSetExtent);
if(zoomStart>maxZoomLevel){zoomStart=maxZoomLevel;
if(zoomStop>maxZoomLevel||zoomStop<zoomStart){zoomStop=maxZoomLevel;
if(lock!=null){lock.release();
if(response==null){finalOperationoperation;{GetMapRequestgetMap=newGetMapRequest();getMap.setFormat(mimeType);Object[]parameters={getMap};org.geoserver.platform.Serviceservice=(org.geoserver.platform.Service)GeoServerExtensions.bean("wms-1_1_1-ServiceDescriptor");
if(service==null){thrownewIllegalStateException("Didn'tfindservicedescriptor'wms-1_1_1-ServiceDescriptor'");
if(r.getBinding().isAssignableFrom(webMapClass)&&r.canHandle(operation)){synchronized(cachedTileEncoders){cachedTileEncoders.put(mimeType,r);response=r;break;
if(response==null){thrownewIllegalStateException("Didn'tfinda"+Response.class.getName()+"tohandle"+mimeType);
ifthe{@linkPublishedInfo}associatedwitha{@linkGeoServerTileLayer}is*queryableviaWMS**@paramgeoServerTileLayerThetilelayertoquery*@return<code>true</code>
ifthelayerisqueryable*/publicbooleanisQueryable(finalGeoServerTileLayergeoServerTileLayer){WMSwmsMediator=WMS.get();LayerInfolayerInfo=geoServerTileLayer.getLayerInfo();
if(layerInfo!=null){returnwmsMediator.isQueryable(layerInfo);
ifbackedbyaLayerGroupInfoSet<String>cachedStyles=info.cachedStyles();
if(styleName.equals(defaultStyle)||cachedStyles.contains(styleName)){affected.add(tl);
if(includeSecondaryStyles){styleFilter=ff.or(styleFilter,ff.equal(ff.property("styles.id"),ff.literal(style.getId()),true,MatchAction.ANY));
if(isLayerGroupFor(lg,style)){layerGroups.add(lg);
if(!layerGroups.contains(lg)){newGroups.add(lg);layerGroups.add(lg);foundNewParents=true;
if(style.equals(lg.getRootLayerStyle())||(lg.getRootLayerStyle()==null&&lg.getRootLayer()!=null&&style.equals(lg.getRootLayer().getDefaultStyle()))){returntrue;
ifwegothere//itmeanswehaveastyleinvolved,oralayerthathasthedefaultstylewesearch//butwedon'tknow
ifthedefaultstylegotoverriddenfinalintstyleCount=lg.getStyles().size();finalintlayerCount=lg.getLayers().size();finalintcount=Math.max(styleCount,layerCount);for(inti=0;i<count;i++){//paranoidcheckincasethetwolistsarenotinsyncStyleInfosi=i<styleCount?lg.getStyles().get(i):null;PublishedInfopi=i<layerCount?lg.getLayers().get(i):null;
if(piinstanceofLayerInfo){
if(style.equals(si)){returntrue;
else{LayerInfoli=(LayerInfo)pi;
if(style.equals(li.getDefaultStyle())){returntrue;
iftheCRSdoesnotprovidesuchinformation*(withtheexceptionofEPSG:900913,seeabove).*/publicReferencedEnvelopegetAreaOfValidity(finalCoordinateReferenceSystemcoordSys){GeometryaovGeom=getAreaOfValidityAsGeometry(coordSys,gridSetBroker);
if(aovGeom==null){returnnull;
if(is900913Compatible){break;
if(is900913Compatible){BoundingBoxprescribedBounds=gridSetBroker.getWorldEpsg3857().getBounds();returnJTS.toGeometry(newEnvelope(prescribedBounds.getMinX(),prescribedBounds.getMaxX(),prescribedBounds.getMinY(),prescribedBounds.getMaxY()));
if(envelope==null){returnnull;
if(envelope.getSpan(0)<tolerance||envelope.getSpan(1)<tolerance){//GeographicBoundingBoxlatLonBBox=CRS.getGeographicBoundingBox(targetCrs);ReferencedEnvelopebbox=newReferencedEnvelope(newGeneralEnvelope(latLonBBox));Polygongeometry=JTS.toGeometry(bbox);doubledistanceTolerance=Math.max(bbox.getSpan(0),bbox.getSpan(1))/2E5;GeometrydensifiedGeom=Densifier.densify(geometry,distanceTolerance);MathTransformmathTransform;try{CoordinateReferenceSystemsourceCRS=bbox.getCoordinateReferenceSystem();mathTransform=CRS.findMathTransform(sourceCRS,targetCrs);aovGeom=JTS.transform(densifiedGeom,mathTransform);
else{aovGeom=JTS.toGeometry(newEnvelope(envelope.getMinimum(0),envelope.getMaximum(0),envelope.getMinimum(1),envelope.getMaximum(1)));
iftheGridSetnamed{@codegridSetId}isaGWCinternallydefinedone,*{@codefalse}otherwise*/publicbooleanisInternalGridSet(finalStringgridSetId){returngridSetBroker.getEmbeddedNames().contains(gridSetId)||geoserverEmbeddedGridSets.contains(gridSetId);
if(tileLayer.getGridSubsets().contains(gridSetId)){tileLayer.removeGridSubset(gridSetId);deleteCacheByGridSetId(layerName,gridSetId);
if(tileLayer.getGridSubsets().isEmpty()){tileLayer.setEnabled(false);
if(lock!=null){lock.release();
if(layer!=null){tileLayer=newGeoServerTileLayer(layer,saneConfig,gridSetBroker);
else{LayerGroupInfolayerGroup=catalog.getLayerGroupByName(name);
if(layerGroup!=null){tileLayer=newGeoServerTileLayer(layerGroup,saneConfig,gridSetBroker);
if(tileLayer!=null){add(tileLayer);
else{log.warning("Requestedlayer"+name+"doesnotexist.Won'tcreateTileLayer");
ifsourcehasatilelayerassociated,falseotherwise,even
ifsource*isnotaninstanceof{@linkLayerInfo}or{@linkLayerGroupInfo}*/publicbooleanhasTileLayer(CatalogInfosource){finalStringtileLayerName;
if(sourceinstanceofResourceInfo){LayerInfolayerInfo=getCatalog().getLayerByName(((ResourceInfo)source).prefixedName());
if(layerInfo==null){returnfalse;
else
if(sourceinstanceofLayerInfo){tileLayerName=tileLayerName((LayerInfo)source);
else
if(sourceinstanceofLayerGroupInfo){tileLayerName=tileLayerName((LayerGroupInfo)source);
else{returnfalse;
ifsourceisnotofasupportedtype*/publicGeoServerTileLayergetTileLayer(CatalogInfosource){finalStringname;
if(sourceinstanceofResourceInfo){name=((ResourceInfo)source).prefixedName();
else
if(sourceinstanceofLayerInfo){name=tileLayerName(((LayerInfo)source));
else
if(sourceinstanceofLayerGroupInfo){name=tileLayerName(((LayerGroupInfo)source));
else{returnnull;
if(tileLayerinstanceofGeoServerTileLayer){return(GeoServerTileLayer)tileLayer;
if(li!=null){layerInfos=Arrays.asList(li);
else{//trickyhere,firstweneedtoflattenthegroup,andwealsoneed//tomakesurewearegettingthefulllayergroup,notjustpartofit//otherwisewearegoingtocachedifferentviewsfordifferentusersLayerGroupInfogroup=getCatalog().getLayerGroupByName(layerName);
if(group!=null){//usetheprefixednametoavoidclashesbecausetherawcatalogisnot//workspace-filteredLayerGroupInforawGroup;
if(group.getWorkspace()!=null){//LocalWorkspacehasaNameDequalifyingProxywhichwillstripofftheworkspace//
ifwejustcallprefixedNamerawGroup=rawCatalog.getLayerGroupByName(group.getWorkspace(),group.getName());
else{rawGroup=rawCatalog.getLayerGroupByName(group.getName());
if(rawGroup.layers().size()==group.layers().size()){layerInfos=group.layers();
if(layerInfos==null||layerInfos.isEmpty()){thrownewServiceException("Couldnotfindlayer"+layerName,"LayerNotDefined");
if(boundingBox!=null){for(LayerInfolayerInfo:layerInfos){//Unwrappotentialproxyinstances,sotheinstanceofSecuredLayerInfocheckworks.
if(layerInfoinstanceofProxy){layerInfo=ProxyUtils.unwrap(layerInfo,Proxy.getInvocationHandler(layerInfo).getClass());
if(layerInfoinstanceofSecuredLayerInfo){//testlayerbboxlimitsSecuredLayerInfosecuredLayerInfo=(SecuredLayerInfo)layerInfo;WrapperPolicypolicy=securedLayerInfo.getWrapperPolicy();AccessLimitslimits=policy.getLimits();
if(limitsinstanceofDataAccessLimits){//ensureweareallusingthesameCRSCoordinateReferenceSystemdataCrs=layerInfo.getResource().getCRS();
if(boundingBox.getCoordinateReferenceSystem()!=null&&!CRS.equalsIgnoreMetadata(dataCrs,boundingBox.getCoordinateReferenceSystem())){try{boundingBox=boundingBox.transform(dataCrs,true);
if(filter!=null){//extractfilterenvelopefromfilterEnvelopebox=(Envelope)filter.accept(ExtractBoundsFilterVisitor.BOUNDS_VISITOR,null);
if(box!=null){limitBox=newReferencedEnvelope(limitBox.intersection(box),dataCrs);
if(limitsinstanceofCoverageAccessLimits){
if(((CoverageAccessLimits)limits).getRasterFilter()!=null){Envelopebox=((CoverageAccessLimits)limits).getRasterFilter().getEnvelopeInternal();
if(box!=null){limitBox=newReferencedEnvelope(limitBox.intersection(box),dataCrs);
if(limitsinstanceofWMSAccessLimits){
if(((WMSAccessLimits)limits).getRasterFilter()!=null){Envelopebox=((WMSAccessLimits)limits).getRasterFilter().getEnvelopeInternal();
if(box!=null){limitBox=newReferencedEnvelope(limitBox.intersection(box),dataCrs);
if(!limitBox.covers(ReferencedEnvelope.EVERYTHING)&&(boundingBox==null||!limitBox.contains(boundingBox))){thrownewSecurityException("Accessdeniedtoboundingboxonlayer"+layerName);
if(layerInfo!=null){returnlayerInfo.getResource().getCRS();
if(instance!=null){GWC.INSTANCE.reset();
if(c!=null){c.reset();
ifthequotastorecannotbeinstantiated*/publicvoidtestQuotaConfiguration(JDBCConfigurationjdbcConfiguration)throwsConfigurationException,IOException{jdbcConfigurationStorage.testQuotaConfiguration(jdbcConfiguration);
if(gsEnvironment!=null&&gsEnvironment.isStale()&&gwcEnvironment!=null){
if(GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION&&gsEnvironment.getProps()!=null){PropertiesgwcProps=gwcEnvironment.getProps();
if(gwcProps==null){gwcProps=newProperties();
switch(type){caseVECTOR://localvectorlayercaseREMOTE://remoteWFSformatsKey="formats.vector";break;caseRASTER://localrasterlayercaseWMS://remoteWMSrastercaseWMTS://remoteWMTSrasterformatsKey="formats.raster";break;caseGROUP:formatsKey="formats.layergroup";break;default:thrownewIllegalArgumentException("Unknownpublishedtype:"+type);
if(commaSeparatedFormats!=null){List<String>splitToList=Splitter.on(",").omitEmptyStrings().trimResults().splitToList(commaSeparatedFormats);formats.addAll(splitToList);
if(blobStoresinstanceofList){return(List<BlobStoreInfo>)blobStores;
else{ArrayList<BlobStoreInfo>storeInfos=newArrayList<BlobStoreInfo>(agg.getBlobStoreCount());blobStores.forEach(storeInfos::add);returnstoreInfos;
ifthere's*nodefault*/publicBlobStoreInfogetDefaultBlobStore(){BlobStoreAggregatoragg=getBlobStoreAggregator();//TODOWeshouldbedoingthisontheaggregatorupstreaminGWCfor(BlobStoreInfoconfig:agg.getBlobStores()){
if(config.isDefault()){returnconfig;
if(config.getName().equals(oldId)){agg.modifyBlobStore(config);
else{synchronized(agg){agg.renameBlobStore(oldId,config.getName());agg.modifyBlobStore(config);
if(!exceptions.isEmpty()){Exceptionex=exceptions.pop();exceptions.forEach(ex::addSuppressed);
iftherunningblobstorescan'tbereplacedbytheprovided*onesortheconfigurationcan'tbesaved*@seeCompositeBlobStore#setBlobStores(Iterable)*/voidsetBlobStores(List<BlobStoreInfo>stores)throwsConfigurationException{Preconditions.checkNotNull(stores,"storesisnull");BlobStoreAggregatoragg=getBlobStoreAggregator();Collection<String>existingStoreNames=agg.getBlobStoreNames();Set<String>toDelete=newTreeSet<>(existingStoreNames);try{for(BlobStoreInfoinfo:stores){toDelete.remove(info.getName());
if(existingStoreNames.contains(info.getName())){agg.modifyBlobStore(info);
else{agg.addBlobStore(info);
if(sortBy.length==0){thrownewIllegalArgumentException("Nowaytobuildcomparatorsoutofanemptycomparatorset");
if(sortBy.length==1){returnbuildComparator(sortBy[0]);
else{List<Comparator<Feature>>comparators=newArrayList<Comparator<Feature>>();for(SortBycurr:sortBy){Comparator<Feature>comparator=buildComparator(curr);comparators.add(comparator);
if(sortBy==null){thrownewNullPointerException("ThesortByargumentmustbenotnull(considerSortBy.UNSORTED)");
if(sortBy==SortBy.NATURAL_ORDER){returnnewFidComparator(true);
else
if(sortBy==SortBy.REVERSE_ORDER){returnnewFidComparator(false);
else{returnnewPropertyComparator<Feature>(sortBy.getPropertyName(),sortBy.getSortOrder()==SortOrder.ASCENDING);
ifwehavetheJDBCDatastoreconfigurationready,otherwisecreateonefromthe//classpathdataDir=dd;try{Propertiesparams=getParameters();store=DataStoreFinder.getDataStore(params);
if(resource.getType()==Type.UNDEFINED){try(OutputStreamos=resource.out();InputStreamis=JDBCStatusStoreLoader.class.getResourceAsStream(JDBCSTATUS_NAME)){IOUtils.copy(is,os);
if(resource.getType()!=Type.UNDEFINED){Resourcebackup=dataDir.get(JDBCSTATUS_NAME+".bak");try(OutputStreamos=backup.out();InputStreamis=resource.in()){IOUtils.copy(is,os);is.close();os.close();
if(capture){this.messages.add(message);
if(this.messages.size()==this.messageNumber){capture=false;latch.countDown();
if(degreeSign.equals(unit)||"degrees".equals(unit)||"dd".equals(unit))result="degrees";
else
if("m".equals(unit)||"meters".equals(unit))result="m";
else
if("km".equals(unit)||"kilometers".equals(unit))result="mi";
else
if("in".equals(unit)||"inches".equals(unit))result="inches";
else
if("ft".equals(unit)||"feets".equals(unit))result="ft";
else
if("mi".equals(unit)||"miles".equals(unit))result="mi";
if(property==LayerGroupProvider.NAME){returnlayerGroupLink(id,itemModel);
if(property==LayerGroupProvider.WORKSPACE){returnworkspaceLink(id,itemModel);
if(!table.getSelection().isEmpty()){booleancanRemove=true;
if(!isAuthenticatedAsAdmin()){//
ifanygloballayergroupsareselected,don'tallow//deletefor(LayerGroupInfolg:table.getSelection()){
if(lg.getWorkspace()==null){canRemove=false;break;
else{removal.setEnabled(false);
if(wsName==null){returnnewSimpleBookmarkableLink(id,LayerGroupEditPage.class,groupNameModel,LayerGroupEditPage.GROUP,groupName);
else{returnnewSimpleBookmarkableLink(id,LayerGroupEditPage.class,groupNameModel,LayerGroupEditPage.GROUP,groupName,LayerGroupEditPage.WORKSPACE,wsName);
if(wsName!=null){returnnewSimpleBookmarkableLink(id,WorkspaceEditPage.class,newModel<String>(wsName),"name",wsName);
else{returnnewWebMarkupContainer(id);
if(validators!=null){for(IValidatorvalidator:validators){textArea.add(validator);
if(options!=null){setOptions(newArrayList<String>(Arrays.asList(options)));
if(type==null){setType(OutputType.BINARY);
if(msg!=null)thrownewRestException(msg,HttpStatus.UNPROCESSABLE_ENTITY);Comparable<?>rule=null;for(Comparable<?>ruleCandidate:ruleDAO.getRules()){
if(ruleString.equals(keyFor(ruleCandidate))){rule=ruleCandidate;break;
if(rule==null){thrownewResourceNotFoundException("Rulenotfound:"+ruleString);
if(!getManager().checkAuthenticationForAdminRole()){thrownewRestException("Amdinistrativeprivelegesrequired",HttpStatus.FORBIDDEN);
if(ruleKeys.isEmpty()||map.isEmpty())returnresult;for(Objectkey:ruleKeys){
if(map.containsKey(key))result.add(key);
if(rules.isEmpty())returnmap.keySet();Set<Object>result=newHashSet<>();Set<Object>ruleKeys=newHashSet<>();for(Comparable<?>rule:rules){ruleKeys.add(keyFor(rule));
if(!ruleKeys.contains(key))result.add(key);
iftheruleisok**@paramruleKey,ruleValue*/protectedStringvalidateRule(StringruleKey,StringruleValue){returnvalidateRuleKey(ruleKey);//TODO//rolesarenotvalidatedatthemoment
iftheruleisok**@paramruleKey*/protectedabstractStringvalidateRuleKey(StringruleKey);/***Convertan{@linkEntry}toaruleobject**@paramentry*/protectedabstractComparableconvertEntryToRule(Entry<String,String>entry);/***Validatesthestringrepresentationofrulekeysandvalues**@paramruleMap*/protectedvoidvalidateMap(Map<String,String>ruleMap){for(Entry<String,String>entry:ruleMap.entrySet()){Stringmsg=validateRule(entry.getKey(),entry.getValue());
if(msg!=null){thrownewRestException(msg,HttpStatus.UNPROCESSABLE_ENTITY);
if(!commonKeys.isEmpty()){Stringmsg="Alreadyexistingrules:"+StringUtils.join(commonKeys.iterator(),",");thrownewRestException(msg,HttpStatus.CONFLICT);
if(!nonExisting.isEmpty()){Stringmsg="Unknownrules:"+StringUtils.join(nonExisting.iterator(),",");thrownewRestException(msg,HttpStatus.CONFLICT);
ifanyoftherolesis*wejustremovealloftheothersfor(Stringrole:roles){
if(ANY.equals(role))returnCollections.singleton("*");
if(exinstanceofRestException){return(RestException)ex;//donothing
else{returnnewRestException("",HttpStatus.INTERNAL_SERVER_ERROR,ex);
if(copy.getGraphicFill()!=null){copy.setGraphicFill(null);copy.setColor(sb.colorExpression(Color.BLACK));
if(fill==null||isStaticTransparentFill(fill)){copy.setFill(sb.createFill());
if(fill.getOpacity()instanceofLiteral){//weirdcaseofpeoplesettingopacityto0.Incasetheopacityisreallyattribute//driven,//we'llleaveitbeDoublestaticOpacity=fill.getOpacity().evaluate(null,Double.class);
if(staticOpacity==null||staticOpacity==0){returntrue;
if(isDefaultGeometry(geometry)){expressions.add(defaultGeometryExpression);
else{expressions.add(geometry);
if(geometry==null){returntrue;
if(!(geometryinstanceofPropertyName)){returnfalse;
if("".equals(pn.getPropertyName())){returntrue;
if(gd==null){returnfalse;
if(current==null||!sameTranformation(current.getTransformation(),fts.getTransformation())){current=fts;reduced.add(current);
else{//flatten,wedon'tneedtodrawaprettypictureandhavingmultipleFTS//wouldresultinthefeaturebeingreturnedtwice,sincewecannot//assumefeatureidstobestableeithercurrent.rules().addAll(fts.rules());
if(extraRules.size()>0){FeatureTypeStylecopy=(FeatureTypeStyle)pages.peek();copy.rules().addAll(extraRules);
if(addSolidLineSymbolier){//addalsoablacklinetomakesurewegetsomethinginoutputeven//
iftheuserclicksinbetweensymbolsordashesLineSymbolizerls=sb.createLineSymbolizer(Color.BLACK);copy.symbolizers().add(ls);
if(Polygon.class.isAssignableFrom(geometryType)||MultiPolygon.class.isAssignableFrom(geometryType)){//weknowit'sapolygontype,butthereisnopolygonsymbolizer,addone//inthecurrentrulecopy.symbolizers().add(sb.createPolygonSymbolizer());
else
if(geometryType.equals(Geometry.class)){//dynamic,weneedtoaddanextrarulethentopaintaspolygon//only
iftheactualgeometryisapolygontypeRuleImplextra=buildDynamicGeometryRule(copy,geom,sb.createPolygonSymbolizer(),"Polygon","MultiPolygon");extraRules.add(extra);
if(Polygon.class.isAssignableFrom(geometryType)||MultiPolygon.class.isAssignableFrom(geometryType)){copy.symbolizers().add(sb.createPolygonSymbolizer());
else
if(LineString.class.isAssignableFrom(geometryType)||MultiLineString.class.isAssignableFrom(geometryType)){copy.symbolizers().add(sb.createLineSymbolizer());
else
if(Point.class.isAssignableFrom(geometryType)||MultiPoint.class.isAssignableFrom(geometryType)){copy.symbolizers().add(sb.createPointSymbolizer());
else{//ouch,it'sagenericgeometry...nowthisisgoingtobepainful,wehaveto//buildadynamicsymbolizerforeachpossiblegeometrytypeRuleImplextra=buildDynamicGeometryRule(copy,geom,sb.createPolygonSymbolizer(),"Polygon","MultiPolygon");extraRules.add(extra);extra=buildDynamicGeometryRule(copy,geom,sb.createLineSymbolizer(),"LineString","LinearRing","MultiLineString");extraRules.add(extra);extra=buildDynamicGeometryRule(copy,geom,sb.createPointSymbolizer(),"Point","MultiPoint");extraRules.add(extra);
if(!(descriptorinstanceofGeometryDescriptor)){//wedon'tknowwhatthiswillbe,weprobablyevaluatedafilterfunctionreturnGeometry.class;
else{//see
ifwearedealingwithapolygonreturn((GeometryDescriptor)descriptor).getType().getBinding();
if(stroke!=null){List<Expression>dashArray=stroke.dashArray();GraphicgraphicStroke=stroke.getGraphicStroke();
if(graphicStroke!=null||dashArray!=null&&dashArray.size()>0){addSolidLineSymbolier=true;
if(enc.getEncodingType()==PasswordEncodingType.ENCRYPT){KeyStoreProviderprov=getSecurityManager().getKeyStoreProvider();Stringalias=prov.aliasForGroupService(name);
if(prov.containsAlias(alias)==false){prov.setUserGroupKey(name,getSecurityManager().getRandomPassworddProvider().getRandomPasswordWithDefaultLength());prov.storeKeyStore();
if(configinstanceofXMLSecurityServiceConfig){validatingXMLSchema=((XMLSecurityServiceConfig)config).isValidating();//copyschemafileResourcexsdFile=getConfigRoot().get(XMLConstants.FILE_UR_SCHEMA);
if(xsdFile.getType()==Type.UNDEFINED){IOUtils.copy(getClass().getResourceAsStream(XMLConstants.FILE_UR_SCHEMA),xsdFile.out());
if(configinstanceofFileBasedSecurityServiceConfig){StringfileName=((FileBasedSecurityServiceConfig)config).getFileName();FileuserFile=newFile(fileName);
if(userFile.isAbsolute()){userResource=Files.asResource(userFile);
else{userResource=getConfigRoot().get(fileName);
if(userResource.getType()==Type.UNDEFINED){IOUtils.copy(getClass().getResourceAsStream("usersTemplate.xml"),userResource.out());
else{thrownewIOException("Cannotinitializefrom"+config.getClass().getName());
if(isValidatingXMLSchema()){XMLValidator.Singleton.validateUserGroupRegistry(doc);
if(userNode.getAttributes().getNamedItem(XMLConstants.A_USER_PASSWORD_UR)!=null){userPassword=xmlXPath.getUserPasswordExpression().evaluate(userNode);
if(propUsers==null){propUsers=newTreeSet<GeoServerUser>();helper.propertyMap.put((String)key,propUsers);
if(members==null){members=newTreeSet<GeoServerUser>();helper.group_userMap.put(group,members);
if(userGroups==null){userGroups=newTreeSet<GeoServerUserGroup>();helper.user_groupMap.put(member,userGroups);
ifit'safeaturelayer,setupthefeaturecollectionforit(somedecoratorsuse//it)
if(layerinstanceofFeatureLayer){try{WMSMapContentmapContent=context.getMapContent();SimpleFeatureCollectionfc=newKMLFeatureAccessor().loadFeatureCollection(layer,mapContent,context.getWms(),mapContent.getScaleDenominator());context.setCurrentFeatureCollection(fc);
if(einstanceofServiceException){throw(ServiceException)e;
else
if(einstanceofHttpErrorCodeException){throw(HttpErrorCodeException)e;
else{thrownewServiceException("FailedtoloadvectordataduringKMLgeneration",e);
if(folder==null){continue;
if(!getInfo().getServiceLevel().getOps().contains(WFSInfo.Operation.TRANSACTION_DELETE)){thrownewWFSException(delete,"TransactionDeletesupportisnotenabled");
if((f==null)||Filter.INCLUDE.equals(f)){thrownewWFSTransactionException("Mustspecifyfilterfordelete","MissingParameterValue");
if(store==null){thrownewWFSException(request,"CouldnotlocateFeatureStorefor'"+elementName+"'");
if(damaged==null){damaged=store.getFeatures(filter).getBounds();
if((request.getLockId()!=null)&&storeinstanceofFeatureLocking&&(request.isReleaseActionSome())){SimpleFeatureLockinglocking;locking=(SimpleFeatureLocking)store;//TODO:RevisitLock/Deleteinteractioningt2
if(false){//REVISIT:Thisisbad-byreleasinglocksbefore//weremovefeaturesweopenourselvesuptothe//dangerofsomeone
elselockingthefeatureswe//areabouttoremove.////Wecannotdoittheotherwayround,asthe//Featureswillnotexist////WecannotgrabthefidsofflineusingAUTO_COMMIT//becausewemayhaveremovedsomeofthemearlier//inthetransaction//locking.unLockFeatures(filter);store.removeFeatures(filter);
else{//Thisabitbetterandwhatshouldbedone,we//willneedtoreworkthegt2lockingapitowork//withfidsorsomething////Theonlyotherthingthatwouldwork//wouldbetospecifythatFeatureLockingis//requiredtoremovelockswhenremovingFeatures.////Whilethatsoundslikeagoodidea,it//wouldbeextraworkwhendoingreleasemodeALL.//DataStoredata=(DataStore)store.getDataStore();FeatureWriter<SimpleFeatureType,SimpleFeature>writer;writer=data.getFeatureWriter(typeName,filter,store.getTransaction());try{while(writer.hasNext()){Stringfid=writer.next().getID();SetfeatureIds=newHashSet();featureIds.add(factory.featureId(fid));locking.unLockFeatures(factory.id(featureIds));writer.remove();deleted++;
else{//Wedon'thavetoworryaboutlockingrightnowintdeletedCount=store.getFeatures(filter).size();
if(deletedCount>0)deleted+=deletedCount;store.removeFeatures(filter);
if(einstanceofFeatureLockException){code="MissingParameterValue";
if(exception.getCode()!=null){sb.append("<soap:faultcode>").append(exception.getCode()).append("</soap:faultcode>");
if(realObj==null){size=0;
else{size=realObj.size();
if(extra!=null){size++;
if(extra!=null)fakeObject.add(extra);
if(realObj!=null)fakeObject.addAll(realObj);returnfakeObject;
if(object==null){realModel.setObject(null);
else{Set<String>newObj=newHashSet<String>(object);newObj.remove(extra);realModel.setObject(newHashSet<String>(object));
if(s==null||s.isEmpty()){returnlabel;
else{returns;
if(label.equals(object)){realModel.setObject("");
else{realModel.setObject(object);
if(realObj==null){size=1;
else{size=realObj.size();
if(realObj!=null){fakeObject.addAll(realObj);
else{fakeObject.add(nullify);
if(object==null||object.contains(nullify)){realModel.setObject(null);
else{Set<String>newObj=newHashSet<String>(object);newObj.remove(nullify);realModel.setObject(newHashSet<String>(object));
if(si==null){error(newParamResourceModel("StyleEditPage.notFound",this,name).getString());doReturn(StylePage.class);return;
if(!isAuthenticatedAsAdmin()){//globalstylesonlyeditablebyfulladmin
if(si.getWorkspace()==null){styleForm.setEnabled(false);editor.add(newAttributeAppender("class",newModel<String>("disabled"),""));get("validate").add(newAttributeAppender("style",newModel<String>("display:none;"),""));add(newBehavior(){privatestaticfinallongserialVersionUID=-4336130086161028141L;@OverridepublicvoidrenderHead(Componentcomponent,IHeaderResponseresponse){super.renderHead(component,response);response.render(OnLoadHeaderItem.forScript("document.getElementById('mainFormSubmit').style.display='none';"));response.render(OnLoadHeaderItem.forScript("document.getElementById('uploadFormSubmit').style.display='none';"));
if(style!=null){styleName=(style.getWorkspace()==null?"":style.getWorkspace().getName()+":")+style.getName();
ifthereisnoURL
if(null==style.getLegend()||null==style.getLegend().getOnlineResource()||style.getLegend().getOnlineResource().isEmpty()){style.setLegend(null);
if(stylePath==null){//theoldstyleisnoavailableanymore,sousethenewpathstylePath=style;
if((!SLDHandler.FORMAT.equals(format))){getCatalog().getResourcePool().getStyle(stylePath);
ifnone.*/protectedURLgetDefinitionsURL(){GeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);
if(loader!=null){//notavailableforSystemTestDataResourcedefinition=loader.get("user_projections/"+FILENAME);
if(definition.getType()==Type.RESOURCE){Filefile=definition.file();URLurl=URLs.fileToUrl(file);
if(url!=null){returnurl;
else{LOGGER.log(Level.SEVERE,"HadtroublesconvertingfilenametoURL");
else{LOGGER.info(definition.path()+"wasnotfound,usingthedefaultsetof"+"coordinateoperationoverrides(normallyempty)");
if(columnValue.equals(property.getPropertyValue(modelObject)))returnc;
if(initializers==null){initializers=newArrayList<XStreamPersisterInitializer>(GeoServerExtensions.extensions(XStreamPersisterInitializer.class));
ifyoucannot*Declareyourinitializerasaspringbean)**@paraminitializer*/publicvoidaddInitializer(XStreamPersisterInitializerinitializer){getInitializers().add(initializer);
iftheinitializerwasfoundandremoved,falseotherwise*/publicbooleanremoveInitializer(XStreamPersisterInitializerinitializer){returngetInitializers().remove(initializer);}}
if(!projectionFileDir.mkdir()){FileUtils.deleteDirectory(projectionFileDir);assertTrue("Unabletocreateprojectiondir:"+projectionFileDir,projectionFileDir.mkdir());
ifdefined
if(standardName!=null&&!standardName.isEmpty()){writer.addVariableAttribute(coordinateVariable,newAttribute(NetCDFUtilities.STANDARD_NAME,standardName));
if(dimension==null){thrownewIllegalArgumentException("NoDimensionfoundforthismanager:"+manager.getName());
if(var==null){thrownewIllegalArgumentException("Unabletofindthespecifiedcoordinatevariable:"+dimensionName);
if(coverageDimension!=null){//2Dcoords(lat,lon/x,y)maybenullbooleanisRange=coverageDimension.isRange();
if(isRange){var=writer.findVariable(dimensionName+NetCDFUtilities.BOUNDS_SUFFIX);writer.write(var,manager.getDimensionData(true,null));
ifprojected
if(projection!=null){StringmappingName=projection.getName();
if(var!=null){writer.addVariableAttribute(var,newAttribute(NetCDFUtilities.GRID_MAPPING,mappingName));
if(projection!=null){Stringname=projection.getName();Variablevar=writer.findVariable(name);setGridMappingVariableAttributes(writer,crs,var,projection);setGeoreferencingAttributes(writer,crs,transform,var);
else{addGlobalAttributes(writer,crs,transform);
if(!(crsinstanceofProjectedCRS)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("TheprovidedCRSisnotaprojectedCRS\n"+"Noprojectioninformationneedstobeadded");
if(conversionFromBase!=null){//gettingthelistofparametersneededfortheNetCDFmappingSet<String>keySet=referencingToNetCDFParameters.keySet();//gettingthelistofparametersfromtheGTReferencingProjectionParameterValueGroupvalues=projection.getNetcdfParameters(conversionFromBase.getParameterValues());List<GeneralParameterValue>valuesList=values.values();//SetupNetCDFCFparameterstobewrittenMap<String,List<Double>>parameterValues=newHashMap<String,List<Double>>();//Loopovertheavailableconversionparametersfor(GeneralParameterValueparam:valuesList){Stringcode=param.getDescriptor().getName().getCode();//Check
ifoneoftheparametersisneededbyNetCDF
if(keySet.contains(code)){//GettheparametervalueDoublevalue=((ParameterValue)param).doubleValue();//GettherelatedNetCDFCFparameterupdateParameterValues(referencingToNetCDFParameters,code,value,parameterValues);
if(val.size()==1){//Setattributeassingleelementwriter.addVariableAttribute(var,newAttribute(key,val.get(0)));
else{//SetattributeasListelement(typicalcaseis//StandardParallelwithSP1andSP2)writer.addVariableAttribute(var,newAttribute(key,val));
if(!mappedKey.contains(NetCDFProjection.PARAMS_SEPARATOR)){updateParam(mappedKey,parameterValues,value);
else{String[]keys=mappedKey.split(NetCDFProjection.PARAMS_SEPARATOR);//Assignthesamevaluetomultipleparams.//Asaninstance,Lambert_conformal_conic_1spusesamevalues//forstandard_parallelandlatitude_of_projection_originfor(Stringkey:keys){updateParam(key,parameterValues,value);
if(parameterValues.containsKey(mappedKey)){List<Double>paramValues=parameterValues.get(mappedKey);paramValues.add(value);
else{List<Double>paramValues=newArrayList<Double>(1);paramValues.add(value);parameterValues.put(mappedKey,paramValues);
if(secMgr.checkAuthenticationForAdminRole()){returnnewNodePanel(id,config);
ifthefilterisapplicableforGUIlogins.Suchafiltercanbe*putintoachaindoingauthenticationforawebinterface.*/publicbooleanapplicableForHtml();/***returns<code>true</code>
ifthefilterisapplicableforservices(NOGUI).Suchafilter*canbeputintoachaindoingauthenticationforservices.*/publicbooleanapplicableForServices();}
ifneeded.*/publicvoidadd(doublex,doubley){finalintindex=this.size;this.size++;ensureCapacity(size);setOrdinate(index,0,x);setOrdinate(index,1,y);
if(index>=size){thrownewIndexOutOfBoundsException();
if(value==null){st.setNull(index,Types.VARCHAR);
else{st.setString(index,((Enum)value).name());
if(outputFormats==null){returnCollections.emptySet();
iftheoperation's*requestisa{@linkGetMapRequest}andtherequestedoutputformatiscontainedin{@link*#getOutputFormatNames()}.**<p>NOTE:requestedMIMETypesmaycomewithparameters,like,forexample:{@code*image/png;param1=value1}.ThisdefaultcanHandleimplementationperformsandexactmatch*checkagainsttherequestedandsupportedformatnames.Subclassesmayfeelfreetooverride*
ifneeded.**@seeorg.geoserver.ows.Response#canHandle(org.geoserver.platform.Operation)*/@OverridepublicbooleancanHandle(finalOperationoperation){GetMapRequestrequest;Object[]parameters=operation.getParameters();request=(GetMapRequest)OwsUtils.parameter(parameters,GetMapRequest.class);
if(request==null){returnfalse;
if(outputFormats.size()==0){//relyonlyonresponsebindingreturntrue;
iftherearenoheaderstobesetontheresponse.**@paramvaluemustbea{@linkWebMap}*@paramoperationTheoperationbeingperformed.*@return{@linkWebMap#getResponseHeaders()}:2xnstringarraycontainingstring-pairsofHTTP*headers/values*@seeResponse#getHeaders(Object,Operation)*@seeWebMap#getResponseHeaders()*/@OverridepublicString[][]getHeaders(Objectvalue,Operationoperation)throwsServiceException{Assert.isInstanceOf(WebMap.class,value);WebMapmap=(WebMap)value;String[][]responseHeaders=map.getResponseHeaders();returnresponseHeaders;}}
if(params.length==0)returnnewNewUserPage(getUserGroupServiceName()).setReturnPage(page);
elsereturnnewNewUserPage((String)params[0]).setReturnPage(page);
if(params.length==0){returnnewEditUserPage(getUserGroupServiceName(),newGeoServerUser("dummyuser")).setReturnPage(page);
if(params.length==1)returnnewEditUserPage(getUserGroupServiceName(),(GeoServerUser)params[0]).setReturnPage(page);
elsereturnnewEditUserPage((String)params[0],(GeoServerUser)params[1]).setReturnPage(page);
if(withRoles)assertTrue(gaService.getRolesForUser("user1").size()==0);
elseassertTrue(gaService.getRolesForUser("user1").size()==2);
ifeverythinggoeswell.
if(backupFacade.getRestoreExecutions().get(jobExecution.getId())!=null){this.restoreExecution=backupFacade.getRestoreExecutions().get(jobExecution.getId());this.restoreExecution.setRestoreCatalog(createRestoreCatalog());
else{Longid=null;RestoreExecutionAdapterrst=null;for(Entry<Long,RestoreExecutionAdapter>entry:backupFacade.getRestoreExecutions().entrySet()){id=entry.getKey();rst=entry.getValue();
if(rst.getJobParameters().getLong(Backup.PARAM_TIME).equals(jobExecution.getJobParameters().getLong(Backup.PARAM_TIME))){break;
else{id=null;rst=null;
if(rst!=null){ResourcearchiveFile=rst.getArchiveFile();CatalogrestoreCatalog=rst.getRestoreCatalog();List<String>options=rst.getOptions();Filterfilter=rst.getFilter();this.backupFacade.getRestoreExecutions().remove(id);this.restoreExecution=newRestoreExecutionAdapter(jobExecution,backupFacade.getTotalNumberOfRestoreSteps());this.restoreExecution.setArchiveFile(archiveFile);this.restoreExecution.setRestoreCatalog(restoreCatalog);this.restoreExecution.setFilter(filter);this.restoreExecution.getOptions().addAll(options);this.backupFacade.getRestoreExecutions().put(jobExecution.getId(),this.restoreExecution);
if(gsCataloginstanceofWrapper){gsCatalog=((Wrapper)gsCatalog).unwrap(Catalog.class);
if(jobExecution.getStatus()!=BatchStatus.STOPPED){LOGGER.fine("ExecutionsStepSummaries:"+backupFacade.getJobOperator().getStepExecutionSummaries(executionId));LOGGER.fine("ExecutionsParameters:"+backupFacade.getJobOperator().getParameters(executionId));LOGGER.fine("ExecutionsSummary:"+backupFacade.getJobOperator().getSummary(executionId));
if(jobExecution.getStatus()==BatchStatus.COMPLETED){JobParametersjobParameters=restoreExecution.getJobParameters();ResourcetempFolder=Resources.fromURL(jobParameters.getString(Backup.PARAM_INPUT_FILE_PATH));//CleanupTemporaryResourcesStringcleanUpTempFolders=jobParameters.getString(Backup.PARAM_CLEANUP_TEMP);
if(cleanUpTempFolders!=null&&Boolean.parseBoolean(cleanUpTempFolders)&&tempFolder!=null){
if(Resources.exists(tempFolder)){try{
if(!tempFolder.delete()){LOGGER.warning("ItwasnotpossibletocleanupTemporaryResources.PleasedoublecheckthatResourcesinsidetheTempGeoServerDataDirectoryhavebeenremoved.");
if(!bestEffort){this.restoreExecution.addFailureExceptions(Arrays.asList(e));thrownewRuntimeException(e);
else{this.restoreExecution.addWarningExceptions(Arrays.asList(e));
ifwearedealingwithanHTTPresponse,wrapitsothatflushcannot//becalledafterclose,whichmakesTomcatAPRruntimecrashtheJVM//(https://osgeo-org.atlassian.net/browse/GEOS-5985)
if(responseinstanceofHttpServletResponse){HttpServletResponsehr=(HttpServletResponse)response;response=newFlushSafeResponse(hr);
if(m_Iter!=null){returnm_Iter.hasNext();
else{returnfalse;
if(m_Iter!=null){
if(!m_Iter.hasNext()){thrownewNoSuchElementException();
else{returnnull;
if(isDownloadService){ids=(UniqueResourceIdentifiers)serviceMetadata.get(SPATIAL_DATASET_IDENTIFIER_TYPE.key,UniqueResourceIdentifiers.class);
if(!serviceMetadata.containsKey(CREATE_EXTENDED_CAPABILITIES.key)){
if(metadataURL==null||isDownloadService&&(ids==null||ids.isEmpty())){serviceMetadata.put(CREATE_EXTENDED_CAPABILITIES.key,false);
else{serviceMetadata.put(CREATE_EXTENDED_CAPABILITIES.key,true);
if(!model.getObject().getMetadata().containsKey(LANGUAGE.key)){model.getObject().getMetadata().put(LANGUAGE.key,"eng");
iftheserviceis//WFSorWCSWebMarkupContaineridentifiersContainer=newWebMarkupContainer("datasetIdentifiersContainer");identifiersContainer.setVisible(isDownloadService);configs.add(identifiersContainer);IModel<UniqueResourceIdentifiers>sdiModel=newMetadataMapModel(metadata,SPATIAL_DATASET_IDENTIFIER_TYPE.key,UniqueResourceIdentifiers.class);UniqueResourceIdentifiersEditoridentifiersEditor=newUniqueResourceIdentifiersEditor("spatialDatasetIdentifiers",sdiModel);identifiersContainer.add(identifiersEditor);}}
ifthedefaultprefixisnonnull,nullotherwise*@see#getTypeDefName()*/publicabstractStringgetQualifiedTypeDefName();/***getQualifiedTypeRefNamepurpose.**<p>Returnsaqualifiedtypereferencename<code>prefix:referencename</code>.**@returnthename
ifthedefaultprefixisnonnull,nullotherwise*@see#getTypeRefName()*/publicabstractStringgetQualifiedTypeRefName();/***getQualifiedTypeDefNamepurpose.**<p>Returnsaqualifiedtypedefinitionname<code>prefix:definitionname</code>withthe*specifiedprefix.**@paramprefixTheprefixtouseforqualification.*@returnthename
ifeitherthespecifiedordefaultprefixisnonnull,nullotherwise*@see#getTypeDefName()*/publicabstractStringgetQualifiedTypeDefName(Stringprefix);/***getQualifiedTypeRefNamepurpose.**<p>Returnsaqualifiedtypereferencename<code>prefix:referencename</code>withthe*specifiedprefix.**@paramprefixTheprefixtouseforqualification.*@returnthename
ifeitherthespecifiedordefaultprefixisnonnull,nullotherwise*@see#getTypeRefName()*/publicabstractStringgetQualifiedTypeRefName(Stringprefix);/***getJavaClasspurpose.**<p>ReturnsaninstanceoftheClassobjectwhichwouldbestrepresentthiselement.**<p>forexampleanelementoftypexs:intwouldreturn<code>Integer.class</code>.**@returnClassinstanceoftheClassobjectwhichwouldbestrepresentthiselement.*/publicabstractClassgetJavaClass();/***Thisisabitofahack,sothatGeoServercangeneratewiththebest(default)xmlmappings*foreachJavaclass.Thisshouldbeimplementedtheotherwayaround,withanicelookup*tabletogettheoneandonlydefault.Butthisisfareasiertoimplement,aswejustadd*thismethodsettotrueforthenamespaceelementclasseswelikebest.Ifforsomereasonwe*settwoNSE'sthatmaptothesamejavaclasstotruethenthingswillbehaverandomly,which*iswhythisisabitofahack.Apologies,it'slate,andIneedtofinishmydocs.*/publicbooleanisDefault(){returnfalse;
if(type.isAssignableFrom(String.class)){returndecode((String)input);
if(type.isAssignableFrom(Text.class)){returndecode(((Text)input).getValue());
if(featureSourceinstanceofFeatureStore){CSVFeatureStorecsvFeatureStore=(CSVFeatureStore)featureSource;csvFeatureStore.addFeatures(collection);
if{@link#matchHTTPMethod}is<code>true</code>*/Set<HTTPMethod>httpMethods;StringroleFilterName;publicRequestFilterChain(String...patterns){this.patterns=newArrayList<String>(Arrays.asList((patterns)));filterNames=newArrayList<String>();httpMethods=newTreeSet<HTTPMethod>();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;RequestFilterChainother=(RequestFilterChain)obj;
if(this.roleFilterName==null&&other.roleFilterName!=null)returnfalse;
if(this.roleFilterName!=null&&this.roleFilterName.equals(other.roleFilterName)==false)returnfalse;
if(this.isAllowSessionCreation()!=other.isAllowSessionCreation())returnfalse;
if(this.isDisabled()!=other.isDisabled())returnfalse;
if(this.isRequireSSL()!=other.isRequireSSL())returnfalse;
if(this.isMatchHTTPMethod()!=other.isMatchHTTPMethod())returnfalse;
if(filterNames==null){
if(other.filterNames!=null)returnfalse;
else
if(!filterNames.equals(other.filterNames))returnfalse;
if(httpMethods==null){
if(other.httpMethods!=null)returnfalse;
else
if(!httpMethods.equals(other.httpMethods))returnfalse;
if(name==null){
if(other.name!=null)returnfalse;
else
if(!name.equals(other.name))returnfalse;
if(patterns==null){
if(other.patterns!=null)returnfalse;
else
if(!patterns.equals(other.patterns))returnfalse;returntrue;
if(isDisabled()==true)returnCollections.emptyList();List<String>result=newArrayList<String>();
if(isRequireSSL())result.add(GeoServerSecurityFilterChain.SSL_FILTER);
if(isAllowSessionCreation())result.add(GeoServerSecurityFilterChain.SECURITY_CONTEXT_ASC_FILTER);
elseresult.add(GeoServerSecurityFilterChain.SECURITY_CONTEXT_NO_ASC_FILTER);
if(StringUtils.hasLength(getRoleFilterName()))result.add(getRoleFilterName());createCompiledFilterList(result);returnresult;
if(property==StoreProvider.DATA_TYPE){finalStoreInfostoreInfo=(StoreInfo)itemModel.getObject();PackageResourceReferencestoreIcon=icons.getStoreIcon(storeInfo);Fragmentf=newFragment(id,"iconFragment",StorePanel.this);f.add(newImage("storeIcon",storeIcon));returnf;
else
if(property==WORKSPACE){returnworkspaceLink(id,itemModel);
else
if(property==NAME){returnstoreNameLink(id,itemModel);
else
if(property==ENABLED){finalStoreInfostoreInfo=(StoreInfo)itemModel.getObject();PackageResourceReferenceenabledIcon;
if(storeInfo.isEnabled()){enabledIcon=icons.getEnabledIcon();
else{enabledIcon=icons.getDisabledIcon();
if(storeinstanceofDataStoreInfo){returnnewSimpleBookmarkableLink(id,DataAccessEditPage.class,storeNameModel,DataAccessEditPage.STORE_NAME,storeName,DataAccessEditPage.WS_NAME,wsName);
else
if(storeinstanceofCoverageStoreInfo){returnnewSimpleBookmarkableLink(id,CoverageStoreEditPage.class,storeNameModel,DataAccessEditPage.STORE_NAME,storeName,DataAccessEditPage.WS_NAME,wsName);
else
if(storeinstanceofWMSStoreInfo){returnnewSimpleBookmarkableLink(id,WMSStoreEditPage.class,storeNameModel,DataAccessEditPage.STORE_NAME,storeName,DataAccessEditPage.WS_NAME,wsName);
else
if(storeinstanceofWMTSStoreInfo){returnnewSimpleBookmarkableLink(id,WMTSStoreEditPage.class,storeNameModel,DataAccessEditPage.STORE_NAME,storeName,DataAccessEditPage.WS_NAME,wsName);
else{thrownewRuntimeException("Don'tknowwhattodowiththisstore"+store);
if(valueinstanceofRange){Ranger=(Range)value;
if(clz.isAssignableFrom(r.getElementClass())){returnr;
else{Comparablemin=(Comparable)Converters.convert(r.getMinValue(),clz);Comparablemax=(Comparable)Converters.convert(r.getMaxValue(),clz);returnnewRange(clz,min,max);
else{returnConverters.convert(this.value,clz);
if(fixedCapabilitiesValue!=null){returnthis.fixedCapabilitiesValue;
else{returnsuper.getCapabilitiesRepresentation(resource,dimensionName,dimensionInfo);
iftherequestiswithintheScripts*module.*/publicabstractclassScriptConverterextendsXStreamCatalogListConverter{/**XMLhandlingforScriptlists*/@ComponentpublicstaticclassXMLXStreamScriptListConverterextendsXMLXStreamListConverter{@AutowiredHttpServletRequestrequest;@OverrideprotectedXStreamcreateXStreamInstance(){returnnewSecureXStream();
if(checkPath(request)){try{link=URLDecoder.decode(link,"UTF-8");encodeAlternateAtomLinkNoExt(link,writer);writer.addAttribute("type",getMediaType());writer.endNode();
else{encodeAlternateAtomLink(link,writer);
if(checkPath(request)){try{link=URLDecoder.decode(link,"UTF-8");encodeAlternateAtomLinkNoExt(link,writer);writer.addAttribute("type",getMediaType());writer.endNode();
else{encodeAlternateAtomLink(link,writer);
if(checkPath(request)){try{link=URLDecoder.decode(link,"UTF-8");writer.startNode("href");writer.setValue(hrefNoExt(link));writer.endNode();
else{writer.startNode("href");writer.setValue(href(link));writer.endNode();
if(link.startsWith("/")){//absolute,encodefrom"root"returnpg.servletURI(link);
else{//encodeasrelativereturnpg.pageURI(link);
if(path.contains("scripts/apps")||(path.contains("scripts/function"))||(path.contains("scripts/wfs/tx"))||(path.contains("scripts/wps"))){returntrue;
else{returnfalse;
ifabsolutelynecessary*/protectedStringgetVersionInternal(){List<Properties>matches=newArrayList<>();try{Resource[]resources=newPathMatchingResourcePatternResolver().getResources("classpath*:META-INF/maven/*/*/pom.properties");for(Resourceresource:resources){try(InputStreamin=resource.getInputStream()){Propertiesproperties=newProperties();properties.load(in);
if(module!=null){
if(module.equals(properties.getProperty("artifactId"))){matches.add(properties);
if(matches.size()>=1){
if(matches.size()>1){LOGGER.log(Level.WARNING,"Found"+matches.size()+"matchingpom.propertiesformodule\""+name+"\",usingthefirstone.Thismaymeanyouhaveduplicatejarsonyourclasspath");
if(value==null||value.isEmpty()){LOGGER.log(Level.INFO,"{0}wasemptyorundefined,usingdefault\"{2}\"instead",logParams);returngetDefaultBean();
if(bean==null){LOGGER.log(Level.WARNING,"{0}hadunexpectedvalue\"{1}\",usingdefault\"{2}\"instead",logParams);bean=getDefaultBean();
if(value==null){thrownewIllegalStateException("Nodefaultvaluefor"+propertyName);
if(defaultBean==null){thrownewIllegalStateException(propertyName+"defaultvalue\""+value+"\"didnotprduceabean");
if(temp==null||temp.length()==0)return0;returnnewInteger(temp);
if(secMgr.listRoleServices().contains("default2")){SecurityRoleServiceConfigroleService=secMgr.loadRoleServiceConfig("default2");secMgr.removeRoleService(roleService);
if(coverage!=null){removeStore(coverage.getStore().getWorkspace().getName(),coverage.getStore().getName());
ifalltheTIMEDOMAINSarepresentString[]metadataNames=reader.getMetadataNames();assertNotNull(metadataNames);assertEquals("true",reader.getMetadataValue("HAS_TIME_DOMAIN"));assertEquals("2008-10-31T00:00:00.000Z,2008-11-01T00:00:00.000Z,2008-11-02T00:00:00.000Z",reader.getMetadataValue(metadataNames[0]));
ifalltheTIMEDOMAINSarepresentString[]metadataNames=reader.getMetadataNames();assertNotNull(metadataNames);assertEquals("true",reader.getMetadataValue("HAS_TIME_DOMAIN"));assertEquals("2008-10-31T00:00:00.000Z,2008-11-01T00:00:00.000Z,2008-11-02T00:00:00.000Z",reader.getMetadataValue(metadataNames[0]));//RemovalofthetemporarydirectoryoutputDirectory.delete();
ifanalreadyexistingdirectorycalled"mosaic"ispresentURLresource=getClass().getResource("test-data/mosaic");
if(resource!=null){FileoldDir=URLs.urlToFile(resource);
if(oldDir.exists()){FileUtils.deleteDirectory(oldDir);
ifthemosaichasbeenconfiguredcorrectlyStructuredGridCoverage2DReaderreader2=null;try{//Selectionofthereadertouseforthemosaicreader=imageMosaicFormat.getReader(DataUtilities.fileToURL(Resources.find(mosaic)));//configurethecoverageconfigureCoverageInfo(builder,store,reader);//checkthecoverageisactuallythereCoverageStoreInfostoreInfo=getCatalog().getCoverageStoreByName("watertemp4");assertNotNull(storeInfo);CoverageInfoci=getCatalog().getCoverageByName("mosaic");assertNotNull(ci);assertEquals(storeInfo,ci.getStore());//HarvestingoftheMosaicURLzipHarvest=MockData.class.getResource("harvesting.zip");//ExtractaBytearrayfromthezipfileInputStreamis=null;byte[]bytes;try{is=zipHarvest.openStream();bytes=IOUtils.toByteArray(is);
ifalltheTIMEDOMAINSarepresentString[]metadataNames=reader2.getMetadataNames();assertNotNull(metadataNames);assertEquals("true",reader2.getMetadataValue("HAS_TIME_DOMAIN"));assertEquals("2008-10-31T00:00:00.000Z,2008-11-01T00:00:00.000Z,2008-11-02T00:00:00.000Z",reader2.getMetadataValue(metadataNames[0]));//Removalofallthedataassociatedtothemosaicreader2.delete(true);
if(reader!=null){try{reader.dispose();
if(reader2!=null){try{reader2.dispose();
ifanalreadyexistingdirectorycalled"mosaic"ispresentURLresource=getClass().getResource("test-data/mosaic");
if(resource!=null){FileoldDir=URLs.urlToFile(resource);
if(oldDir.exists()){FileUtils.deleteDirectory(oldDir);
ifthemosaichasbeenconfiguredcorrectlyStructuredGridCoverage2DReaderreader2=null;try{//Selectionofthereadertouseforthemosaicreader=imageMosaicFormat.getReader(DataUtilities.fileToURL(Resources.find(mosaic)));//configurethecoverageconfigureCoverageInfo(builder,store,reader);//checkthecoverageisactuallythereCoverageStoreInfostoreInfo=getCatalog().getCoverageStoreByName("watertemp5");assertNotNull(storeInfo);CoverageInfoci=getCatalog().getCoverageByName("mosaic");assertNotNull(ci);assertEquals(storeInfo,ci.getStore());//HarvestingoftheMosaicURLzipHarvest=MockData.class.getResource("harvesting.zip");//Extractthefirstfileaspayload(thetiff)byte[]bytes=null;try(ZipInputStreamzis=newZipInputStream(zipHarvest.openStream())){ZipEntryentry;while((entry=zis.getNextEntry())!=null){
if("NCOM_wattemp_000_20081102T0000000_12.tiff".equals(entry.getName())){bytes=IOUtils.toByteArray(zis);
if(bytes==null){fail("CouldnotfindtheexpectedzipentryNCOM_wattemp_000_20081102T0000000_12.tiff");
if(reader!=null){try{reader.dispose();
if(reader2!=null){try{reader2.dispose();
ifalltheTIMEDOMAINSarepresentString[]metadataNames=reader2.getMetadataNames();assertNotNull(metadataNames);assertEquals("true",reader2.getMetadataValue("HAS_TIME_DOMAIN"));assertEquals("2008-10-31T00:00:00.000Z,2008-11-01T00:00:00.000Z,2008-11-02T00:00:00.000Z",reader2.getMetadataValue(metadataNames[0]));returnreader2;
if(argumentinstanceofConfigurationListener){listeners.add((ConfigurationListener)argument);returntrue;
ifthecallerforgetstocatchuncheckedexceptions.**@throwsException*/@TestpublicvoidtestNoConnectionLeakIfExceptionThrown()throwsException{FilterFactoryImplNamespaceAwareff=newFilterFactoryImplNamespaceAware();ff.setNamepaceContext(mappingFs.getMapping().getNamespaces());//thisfilterselectsthefeaturewithGMLID"scp.1",theonlyonewhichjoinsthebroken//featuretypeex:ConnectionUsageThirdNestedPropertyIsEqualToequals=ff.equals(ff.property("ex:nestedFeature/ex:ConnectionUsageFirstNested/ex:nestedFeature/ex:ConnectionUsageSecondNested/gml:name"),ff.literal("A_nested_second"));FeatureIteratorfIt=mappingFs.getFeatures(equals).features();try{testNestedIterators(fIt);fail("Expectedexceptionwasnotthrown!");
ifwehaveadatabaebackendandjoiningisenabledassumeTrue(sourceFs.getDataStore()instanceofJDBCDataStore&&AppSchemaDataAccessConfigurator.isJoining());sourceDataStore=(JDBCDataStore)sourceFs.getDataStore();ff=newFilterFactoryImplNamespaceAware();ff.setNamepaceContext(mappingFs.getMapping().getNamespaces());//retrieveonefeaturetotriggerallnecessaryinitializationstepssotheydon't//interfere//withthetest'soutcomePropertyIsEqualToequals=ff.equals(ff.property("gml:name"),ff.literal("C_parent"));try(FeatureIteratorfIt=mappingFs.getFeatures(equals).features()){assertTrue(fIt.hasNext());assertNotNull(fIt.next());
if(attrinstanceofJoiningNestedAttributeMapping){nestedFeaturesCount++;JoiningNestedAttributeMappingjoiningNestedAttr=(JoiningNestedAttributeMapping)attr;Map<Name,DataAccessMappingFeatureIterator>nestedFeatureIterators=joiningNestedAttr.getNestedFeatureIterators(mappingIt);assertNotNull(nestedFeatureIterators);
if(nestedFeatureIterators.size()>0){assertEquals(1,nestedFeatureIterators.size());FeatureTypeMappingnestedMapping=joiningNestedAttr.getFeatureTypeMapping(null);DataAccessMappingFeatureIteratornestedIt=nestedFeatureIterators.values().iterator().next();FeatureSourcenestedMappedSource=nestedIt.getMappedSource();assertEquals(sourceDataStore,nestedMappedSource.getDataStore());assertEquals(transaction,nestedIt.getTransaction());testNestedIteratorsRecursively(nestedMapping,nestedIt);
if("wfs".equals(service.getId().toLowerCase())&&PAGE_RESULTS.equals(req)){//allowtherequesttobesuccessfullyparsedasaGetFeature(needsatleasta//typenameorafeatureId)request.getKvp().put("featureId",Collections.singletonList("dummy"));//replacetheservicereturnnewService(service.getId(),this.service,service.getVersion(),service.getOperations());
if(operation.getId().equals("PageResults")){newOperation=newOperation("GetFeature",operation.getService(),operation.getMethod(),operation.getParameters());
if("wfs".equals(s.getId().toLowerCase())&&Integer.valueOf(2).equals(s.getVersion().getMajor())){
if(!s.getOperations().contains(PAGE_RESULTS)){s.getOperations().add(PAGE_RESULTS);
if(metadataLink!=null){MetadataLinkInfoml=gs.getCatalog().getFactory().createMetadataLink();ml.setAbout((String)metadataLink.get("about"));ml.setMetadataType((String)metadataLink.get("metadataType"));ml.setType((String)metadataLink.get("type"));service.setMetadataLink(ml);
if(keywords!=null){service.getKeywords().addAll(keywords);
if(null!=keywords){for(Stringkeyword:keywords){FilterpropContains=getFullSearch(keywords);//chainthefilterstogether
if(Filter.INCLUDE==filter){filter=propContains;
else{filter=or(filter,propContains);
if(store.supportsPredicate()){for(Stringkeyword:keywords){FilterpropContains=Predicates.fullTextSearch(keyword);//chainthefilterstogether
if(Filter.INCLUDE==ret){ret=propContains;
else{ret=or(ret,propContains);
else{
if(keywords.length>0){List<Filter>likes=newArrayList<Filter>();for(Stringword:keywords){for(Property<?>prop:getProperties()){
if(prop.isSearchable()){
if(prop.equals(NODE)||prop.equals(PHASE)||prop.equals(TASK)||prop.equals(USER)||prop.equals(PROCESS)){likes.add(FF.like(FF.property(prop.getName()),"*"+word+"*"));
ifIcanworkoutwhatsearching//means
if(count>0){query.setStartIndex((int)first);query.setMaxFeatures((int)count);
if(sort!=null){SortByImpl[]sortBys=newSortByImpl[1];finalProperty<?>property=getProperty(sort);
if(property.isSearchable()){//wereallyneedanotherflagFF.sort(property.getName(),SortOrder.ASCENDING);
if(!sort.isAscending()){sortBys[0].setSortOrder(SortOrder.DESCENDING);
if(validators==null){returnnull;
if(filteredClass.isAssignableFrom(validatorClass)){skip=true;break;
if(!skip){result.add(v);
ifthereisnolimit**@paramvalidators*/publicstaticintgetMaxSizeMB(Collection<Validator>validators){intmaxSize=Integer.MAX_VALUE;
if(validators!=null){for(Validatorv:validators){
if(vinstanceofMaxSizeValidator){MaxSizeValidatorms=(MaxSizeValidator)v;intmsSize=ms.getMaxSizeMB();maxSize=Math.min(maxSize,msSize);
if(maxSize<=0||maxSize==Integer.MAX_VALUE){return-1;
else{returnmaxSize;
iftheextensioncancreateobjectsofthespecifiedclass.**@paramclazzTheclassofobjecttocreate.*/<TextendsObject>booleancanCreate(Class<T>clazz);/***Createsaninstanceofthespecifiedclass.**<p>Thismethodisonlycalled
if{@link#canCreate(Class)}returns<code>true</code>.**@paramclazzTheclassofobjecttocreate.*@returnThenewobject.*/<TextendsObject>Tcreate(Class<T>clazz);}}
if(ugService.canCreateStore()){ugStore=newUserGroupStoreValidationWrapper(ugService.createStore());Set<GeoServerUserGroup>orig=ugStore.getGroupsForUser(user);Set<GeoServerUserGroup>add=newHashSet<GeoServerUserGroup>();Set<GeoServerUserGroup>remove=newHashSet<GeoServerUserGroup>();userGroupPalette.diff(orig,add,remove);ugStore.updateUser(user);for(GeoServerUserGroupg:add)ugStore.associateUserToGroup(user,g);for(GeoServerUserGroupg:remove)ugStore.disAssociateUserFromGroup(user,g);ugStore.store();
if(hasRoleStore(getSecurityManager().getActiveRoleService().getName())){roleStore=getRoleStore(getSecurityManager().getActiveRoleService().getName());roleStore=newRoleStoreValidationWrapper(roleStore);Set<GeoServerRole>orig=roleStore.getRolesForUser(user.getUsername());Set<GeoServerRole>add=newHashSet<GeoServerRole>();Set<GeoServerRole>remove=newHashSet<GeoServerRole>();rolePalette.diff(orig,add,remove);for(GeoServerRolerole:add){roleStore.associateRoleToUser(role,user.getUsername());
if(filterName==null)return;writeLock.lock();try{Set<AuthenticationCacheKey>toBeRemoved=newHashSet<AuthenticationCacheKey>();for(AuthenticationCacheKeykey:cache.keySet()){
if(filterName.equals(key.getFilterName()))toBeRemoved.add(key);
if(entry==null)returnnull;
if(entry.hasExpired(currentTime)){hasTobeRemoved=true;returnnull;
if(hasTobeRemoved)remove(filterName,cacheKey);
if("xml".equals(prefix)){continue;
if(tempDir.mkdir()){returntempDir;
if(!remove&&path!=null){FileurlToFile=URLs.urlToFile(path);urlToFile.mkdirs();file=newFile(urlToFile,contents.getName()+".gpkg");
else{file=resources.getOutputResource(null,outputName).file();
if(layer.getType()==LayerType.FEATURES){FeaturesLayerfeatures=(FeaturesLayer)layer;QNameftName=features.getFeatureType();QueryTypequery=Wfs20Factory.eINSTANCE.createQueryType();query.getTypeNames().add(ftName);
if(features.getSrs()==null){Stringns=ftName.getNamespaceURI()!=null?ftName.getNamespaceURI():ftName.getPrefix();FeatureTypeInfoft=catalog.getFeatureTypeByName(ns,ftName.getLocalPart());
if(ft!=null){try{query.setSrsName(newURI(ft.getSRS()));
else{query.setSrsName(features.getSrs());
if(features.getPropertyNames()!=null){query.getPropertyNames().addAll(features.getPropertyNames());
ifthereisone
if(features.getBbox()!=null){StringdefaultGeometry=catalog.getFeatureTypeByName(features.getFeatureType().getLocalPart()).getFeatureType().getGeometryDescriptor().getLocalName();Envelopee=features.getBbox();//HACK:becausewearegoingthroughwfs2.0,flipthecoordinates(specified//inxy)//whichwillthenbelaterflippedbacktoxy
if(query.getSrsName()!=null){try{CoordinateReferenceSystemcrs=CRS.decode(query.getSrsName().toString());
if(crsinstanceofGeographicCRS){//flipthebboxe=newEnvelope(e.getMinY(),e.getMaxY(),e.getMinX(),e.getMaxX());
if(filter==null){filter=bboxFilter;
else{filter=filterFactory.and(filter,bboxFilter);
if(!(collectioninstanceofSimpleFeatureCollection)){thrownewServiceException("GeoPackageOutputFormatdoesnotsupportComplexFeatures.");
if(features.getBbox()!=null){bounds=ReferencedEnvelope.reference(bounds.intersection(features.getBbox()));
if(features.isIndexed()){gpkg.createSpatialIndex(e);
else
if(layer.getType()==LayerType.TILES){TilesLayertiles=(TilesLayer)layer;GetMapRequestrequest=newGetMapRequest();request.setLayers(newArrayList<MapLayerInfo>());for(QNamelayerQName:tiles.getLayers()){LayerInfolayerInfo=null;
if("".equals(layerQName.getNamespaceURI())){layerInfo=catalog.getLayerByName(layerQName.getLocalPart());
else{layerInfo=catalog.getLayerByName(newNameImpl(layerQName.getNamespaceURI(),layerQName.getLocalPart()));
if(layerInfo==null){thrownewServiceException("Layernotfound:"+layerQName);
if(tiles.getBbox()==null){try{//generateonefromrequestslayersCoordinateReferenceSystemcrs=tiles.getSrs()!=null?CRS.decode(tiles.getSrs().toString()):null;ReferencedEnvelopebbox=null;for(MapLayerInfol:request.getLayers()){ResourceInfor=l.getResource();ReferencedEnvelopeb=null;
if(crs!=null){//transformfromlatlonbboxb=r.getLatLonBoundingBox().transform(crs,true);
else{//usenativebboxb=r.getNativeBoundingBox();
if(bbox!=null){//transformb=b.transform(bbox.getCoordinateReferenceSystem(),true);
if(bbox!=null){bbox.include(b);
else{bbox=b;
else{request.setBbox(tiles.getBbox());
if(tiles.getSrs()==null){//usesrsoffirstlayerResourceInfor=request.getLayers().iterator().next().getResource();request.setSRS(r.getSRS());
else{request.setSRS(tiles.getSrs().toString());
if(srs!=null&&!srs.isEmpty()){try{request.setCrs(CRS.decode(srs));
if(tiles.getSld()!=null){request.setStyleUrl(tiles.getSld().toURL());
else
if(tiles.getSldBody()!=null){request.setStyleBody(tiles.getSldBody());
else{request.setStyles(newArrayList<Style>());
if(tiles.getStyles()!=null){for(StringstyleName:tiles.getStyles()){StyleInfoinfo=catalog.getStyleByName(styleName);
if(info!=null){request.getStyles().add(info.getStyle());
if(request.getStyles().isEmpty()){for(MapLayerInfolayerInfo:request.getLayers()){request.getStyles().add(layerInfo.getDefaultStyle());
if(tiles.getFormat()!=null){formatOptions.put("format",tiles.getFormat());
if(tiles.getCoverage()!=null){
if(tiles.getCoverage().getMinZoom()!=null){formatOptions.put("min_zoom",tiles.getCoverage().getMinZoom());
if(tiles.getCoverage().getMaxZoom()!=null){formatOptions.put("max_zoom",tiles.getCoverage().getMaxZoom());
if(tiles.getCoverage().getMinColumn()!=null){formatOptions.put("min_column",tiles.getCoverage().getMinColumn());
if(tiles.getCoverage().getMaxColumn()!=null){formatOptions.put("max_column",tiles.getCoverage().getMaxColumn());
if(tiles.getCoverage().getMinRow()!=null){formatOptions.put("min_row",tiles.getCoverage().getMinRow());
if(tiles.getCoverage().getMaxRow()!=null){formatOptions.put("max_row",tiles.getCoverage().getMaxRow());
if(tiles.getGridSetName()!=null){formatOptions.put("gridset",tiles.getGridSetName());
if(tiles.getGrids()!=null){mapOutput.addTiles(gpkg,e,request,tiles.getGrids(),layer.getName());
else{mapOutput.addTiles(gpkg,e,request,layer.getName());
ifitisatemporaryfile
if(path!=null&&!remove){returnpath;
else{returnnewURL(resources.getOutputResourceUrl(outputName,"application/x-gpkg"));
ifthisrequestisnested,releasethepreviouscontrollersandgrabnewones//NestinghappensonlywithintegratedGWC,sometimesthenestedrequestissimilartothe//outsideone,e.g.,withtransparentintegration,othertimesit'scompletelydifferent,//e.g.native//tileservices).Wecannotaffordtohavethesamecontrollerlocktwice,thatwouldcause//deadlocks
if(REQUEST_CONTROLLERS.get()!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Nestedrequestfound,notlockingonit");
if(request!=null){requestWithOperation=newRequest(request);requestWithOperation.setOperation(operation);
if(controllers.size()==0){LOGGER.info("Control-flowinactive,therearenoconfiguredrules");
else{
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Request["+requestWithOperation+"]starting,processingthroughflowcontrollers");
if(timeout>0){longmaxWait=maxTime-System.currentTimeMillis();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Request["+requestWithOperation+"]checkingflowcontroller"+flowController);
if(!flowController.requestIncoming(requestWithOperation,maxWait)){thrownewHttpErrorCodeException(503,"Requestedtimeoutoutwhilewaitingtobeexecuted,pleaseloweryourrequestrate");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Request["+requestWithOperation+"]passedflowcontroller"+flowController);
else{flowController.requestIncoming(requestWithOperation,-1);
if(!failedOnFlowControllers){runningRequests.incrementAndGet();
if(REQUEST_CONTROLLERS.get()!=null){
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Requestcontrol-flowperformed,runningrequests:"+getRunningRequests()+",blockedrequests:"+getBlockedRequests());
if(request!=null&&request.getHttpResponse()!=null){//reporthowmuchtimewasspentgoingthoughtheflowcontrollerslongend=System.currentTimeMillis();request.getHttpResponse().addHeader(X_RATELIMIT_DELAY,String.valueOf(end-start));
if(applicationContextinstanceofConfigurableApplicationContext){//registerdefaultbeans
ifneededregistDefaultBeansIfNeeded((ConfigurableApplicationContext)applicationContext);
else{//wecannotregistdefaultbeans,thereisnothing
elsewecandoaboutthisLOGGER.warning("Applicationcontextnotconfigurable,control-flowdefaultbeanswillnotberegistered.");
if(provider==null){provider=newDefaultFlowControllerProvider(applicationContext);
ifthere//areactuallycontrollersaround
if(context!=null){context.nestingLevel--;
if(context.nestingLevel<=0||forceRelease){
if(Boolean.FALSE.equals(FAILED_ON_FLOW_CONTROLLERS.get())){runningRequests.decrementAndGet();
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Requestcompleted,runningrequests:"+getRunningRequests()+",blockedrequests:"+getBlockedRequests());
if(context!=null&&(context.nestingLevel<=0||forceRelease)){REQUEST_CONTROLLERS.remove();
if(SecurityContextHolder.getContext().getAuthentication()==null){SecurityContextHolder.getContext().setAuthentication(createAuthentication((HttpServletRequest)req));
if(s.getName().equals(getStylePage().getStyleInfo().getName()))returntrue;
if(s!=null){returns.getName().equals(getStylePage().getStyleInfo().getName());
if(property==layerProvider.defaultStyle){IModel<Boolean>model=newIModel<java.lang.Boolean>(){privatestaticfinallongserialVersionUID=-5895600269146950033L;publicBooleangetObject(){returndefaultEditedStyle(layer);
if(b){layer.setDefaultStyle(parent.getStyleInfo());
else{
if(layer.getStyles().size()==0){layer.setDefaultStyle(parent.getCatalog().getStyleByName("generic"));
else{StyleInfos=layer.getStyles().iterator().next();layer.setDefaultStyle(s);
else
if(property==layerProvider.associatedStyle){IModel<Boolean>model=newIModel<java.lang.Boolean>(){privatestaticfinallongserialVersionUID=-5895600269146950033L;publicBooleangetObject(){returnusesEditedStyle(layer);
if(b){layer.getStyles().add(parent.getStyleInfo());
else{StyleInfos=null;for(StyleInfocandidate:layer.getStyles()){
if(candidate.getName().equals(parent.getStyleInfo().getName())){s=candidate;break;
if(s!=null)layer.getStyles().remove(s);
else{returnnewLabel(id,text);
if(counter%2==0){item.add(newAttributeModifier("class","odd"));
else{item.add(newAttributeModifier("class","even"));
if(this.logStore==null){this.logStore=GeoServerExtensions.bean(LogStore.class);
if(property==LogEventProvider.SEVERITY){Severityseverity=item.getSeverity();PackageResourceReferenceiconRef=SEVERITY_ICONS.get(severity);returnnewIcon(id,iconRef);
if(property==LogEventProvider.REPOSITORY){returnrepositoryLink(id,item);
if(property==LogEventProvider.TIMESTAMP){returnnewLabel(id,DateUtil.serializeDateTime(item.getTimestamp()));
if(property==LogEventProvider.MESSAGE){returnmessageLink(id,item);
if(!item.getSeverity().equals(Severity.ERROR)){returnnewLabel(id,messageModel);
if(stackTrace!=null){stackTraceLabel.setDefaultModel(newModel<>(stackTrace));
if(logStore==null){logStore=GeoServerExtensions.bean(LogStore.class);
ifspatialfiltersareusedagainstnonspatialproperties,
ifso,throwsa*ServiceException(mandatedforCSWcitecompliance).Worksfineforsimpledatamodels,butyou*mightneedtouseacustomoneformorecomplexmodels(e.g.,SpatialFilterCheckerisknownnot*toworkwithebRIM)**@authorAndreaAime-GeoSolutions*/publicclassSpatialFilterCheckerextendsDefaultFilterVisitor{FeatureTypeschema;publicSpatialFilterChecker(FeatureTypeschema){this.schema=schema;
if(expressioninstanceofPropertyName){PropertyNamepn=((PropertyName)expression);
if(!(pn.evaluate(schema)instanceofGeometryDescriptor)){thrownewServiceException("Invalidspatialfilter,property"+pn.getPropertyName()+"isnotageometry");
if(!isJDBCTest())checkEmpty(service);checkValuesInserted(store);//rollbackstore.load();checkEmpty(store);checkEmpty(service);//commitinsertValues(store);store.store();checkValuesInserted(store);checkValuesInserted(service);
if(!isJDBCTest())checkValuesInserted(service);checkValuesModified(store);store.load();checkValuesInserted(store);checkValuesInserted(service);modifyValues(store);store.store();checkValuesModified(store);checkValuesModified(service);
if(!isJDBCTest())checkValuesInserted(service);checkValuesRemoved(store);store.load();checkValuesInserted(store);checkValuesInserted(service);removeValues(store);store.store();checkValuesRemoved(store);checkValuesRemoved(service);}}
if(transforminstanceofReprojectTransform){//ReprojectTransformdoesstuffwithtasknewType=type;
else{newType=transform.apply(task,null,type);
ifthisinitializercanhandlethespecifiedresourcehandle*/booleancanHandle(FeatureTypeInfoinfo,DataAccess<?extendsFeatureType,?extendsFeature>dataAccess);/***Initializesthespecifiedfeaturetypeinthespecifieddataaccess.IftemporaryNameis*provided,itmeanstheinitializershouldtrytoinitializerthefeaturetypewiththegiven*temporaryname,unlessthefeaturetypealreadyexists.**@returntrue
iftheinitializationusedthetemporaryname,falseotherwise*/booleaninitialize(FeatureTypeInfoinfo,DataAccess<?extendsFeatureType,?extendsFeature>dataAccess,NametemporaryName)throwsIOException;/**Preparesforthefeaturetypetobeflushed*/voidflush(FeatureTypeInfoinfo,DataAccess<?extendsFeatureType,?extendsFeature>dataAccess)throwsIOException;/***Performsanycleanupnecessarytocleanupthelayerfromthespecifiedstore.Incasea*previousinitializationusedatemporaryname,itwillbepasseddownandtheinitiliazer*shoulduseitforcleanuppurposes*/voiddispose(FeatureTypeInfoinfo,DataAccess<?extendsFeatureType,?extendsFeature>dataAccess,NametemporaryName)throwsIOException;}
if(workspace==null){workspace=id!=null?GeoServerApplication.get().getCatalog().getWorkspace(id):null;
if(fi==null){returnnull;
if(pm==null){//wehavetoskipthisonecontinue;
if(!featureRetrieved){//anexceptionhasoccurred,releasethefeatureiteratorcontext.closeIterator(fi);
if(!fi.hasNext()){context.closeIterator(fi);
if(workspace!=null){WorkspaceInfows=geoServer.getCatalog().getWorkspaceByName(workspace);service=geoServer.getService(ws,WCSInfo.class);
else{service=geoServer.getService(WCSInfo.class);
if(fcinstanceofFeatureCollectionDecorator){return((FeatureCollectionDecorator)fc).getName();
else{returnfc.getSchema().getName();
if(value.equalsIgnoreCase("NEAREST")){returnInterpolation.getInstance(Interpolation.INTERP_NEAREST);
else
if(value.equalsIgnoreCase("BILINEAR")){returnInterpolation.getInstance(Interpolation.INTERP_BILINEAR);
else
if(value.equalsIgnoreCase("BICUBIC2")){returnInterpolation.getInstance(Interpolation.INTERP_BICUBIC_2);
else
if(value.equalsIgnoreCase("BICUBIC")){returnInterpolation.getInstance(Interpolation.INTERP_BICUBIC);
if(signalArgs!=null&&signalArgs.get("topic")!=null)returnsignalArgs.get("topic").equals("unregister");returnfalse;
if(choices.get(i).equals("JTS:area")){index=0;break;
if(parentDirectory!=null&&name!=null){Filefile=newFile(newFile(parentDirectory),name).getAbsoluteFile();this.location=file.toURI();this.parentDirectory=null;this.name=null;
if(maskedLocation==null){//ensurethelocationissetgetLocation();//getthemaskedversionoftheURIthis.maskedLocation=GeoServerGeoGigRepositoryResolver.getURI(getRepoName());
if(this.location!=null){
if(this.repoName==null){//lookuptheresolver
if(RepositoryResolver.resolverAvailableForURIScheme(this.location.getScheme())){RepositoryResolverresolver=RepositoryResolver.lookup(this.location);this.repoName=resolver.getName(this.location);
if(!(oinstanceofRepositoryInfo)){returnfalse;
if(dimensionName.equals(ResourceInfo.TIME)){DatedateToMatch=null;
if(this.toMatchinstanceofDate){dateToMatch=(Date)this.toMatch;
else
if(this.toMatchinstanceofLong){//Assumemillistime
ifreferencevalueisgivenasLong:dateToMatch=newDate(((Long)this.toMatch).longValue());
else{try{dateToMatch=newDate(DateUtil.parseDateTime(this.toMatch.toString()));
else
if(dimensionName.equals(ResourceInfo.ELEVATION)){
if(this.toMatchinstanceofNumber){DoubledoubleToMatch=((Number)this.toMatch).doubleValue();retval=findNearestElevation(dimAccessor,doubleToMatch);
else{thrownewServiceException("Thedefaultvalueforelevationdimensionisnotanumber.Cannotfindadefaultelevationvalueforthelayer"+resource.getName());
else
if(dimensionName.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){retval=findNearestCustomDimensionValue(dimensionName.substring(ResourceInfo.CUSTOM_DIMENSION_PREFIX.length()),dimAccessor,this.toMatch.toString());
if(dateOrRangeinstanceofDate){Dated=(Date)dateOrRange;
if(d.before(toMatch)){currentDistance=toMatch.getTime()-d.getTime();
if(currentDistance<shortestDistance){shortestDistance=currentDistance;candidate=d;
else
if(d.after(toMatch)){currentDistance=d.getTime()-toMatch.getTime();
if(currentDistance<shortestDistance){candidate=d;
else
if(d.equals(toMatch)){candidate=d;break;
else
if(dateOrRangeinstanceofDateRange){DateRanged=(DateRange)dateOrRange;
if(d.getMaxValue().before(toMatch)){currentDistance=toMatch.getTime()-d.getMaxValue().getTime();
if(currentDistance<shortestDistance){shortestDistance=currentDistance;candidate=d.getMaxValue();
else
if(d.getMinValue().after(toMatch)){currentDistance=d.getMinValue().getTime()-toMatch.getTime();
if(currentDistance<shortestDistance){candidate=d.getMinValue();
else{//wearewithinthisrange,"match"willdo:candidate=toMatch;break;
if(doubleOrRangeinstanceofDouble){Doubled=(Double)doubleOrRange;intcomp=d.compareTo(toMatch);
if(comp<0){currentDistance=toMatch.doubleValue()-d.doubleValue();
if(currentDistance<shortestDistance){shortestDistance=currentDistance;candidate=d;
else
if(comp>0){currentDistance=d.doubleValue()-toMatch.doubleValue();
if(currentDistance<shortestDistance){candidate=d;
else{candidate=d;break;
else
if(doubleOrRangeinstanceofNumberRange<?>){NumberRange<Double>d=null;NumberRange<?>maybeD=(NumberRange<?>)doubleOrRange;
if(maybeD.getElementClass().equals(Double.class)){d=(NumberRange<Double>)maybeD;
else{d=maybeD.castTo(Double.class);
if(d.getMaxValue().doubleValue()<toMatch.doubleValue()){currentDistance=toMatch.doubleValue()-d.getMaxValue().doubleValue();
if(currentDistance<shortestDistance){shortestDistance=currentDistance;candidate=d.getMaxValue();
else
if(d.getMinValue().doubleValue()>toMatch.doubleValue()){currentDistance=d.getMinValue().doubleValue()-toMatch.doubleValue();
if(currentDistance<shortestDistance){candidate=d.getMinValue();
else{//wearewithinthisrange,"match"willdo:candidate=toMatch;break;
elsethatnullforthis://Stringtype=dimAccessor.getDomainDatatype(dimensionName);//Justuseacaseinsensitivelexicalstringcomparisonfornow:Comparator<String>comp=String.CASE_INSENSITIVE_ORDER;Collections.sort(domain,comp);longshortestDistance=Long.MAX_VALUE;longcurrentDistance=0;for(StringtoCompare:domain){intcompValue=comp.compare(toCompare,toMatch);
if(compValue<0){currentDistance=-compValue;
if(currentDistance<shortestDistance){shortestDistance=currentDistance;candidate=toCompare;
else{currentDistance=compValue;
if(currentDistance<shortestDistance){candidate=toCompare;//thedistancecanonlygrowafterthis//assumingthevaluesareinascendingorder,//sostopiteratingatthispointforefficiency:break;
if(fixedCapabilitiesValue!=null){returnthis.fixedCapabilitiesValue;
else{returnsuper.getCapabilitiesRepresentation(resource,dimensionName,dimensionInfo);
if(modifiedSince!=null){request.addHeader("If-Modified-Since",modifiedSince);
iftheoperationendssuccessfullyfalseotherwise*@throwsException
ifsomethinggoeswrong*/publicabstractbooleansynchronize(Odeserialized)throwsException;}
if(task!=null){data=task.getData();data.setParent(task);
else{finalImportContextcontext=context(importId);data=context.getData();data.setParent(context);
if(dir.getFiles().remove(file)){returnnewResponseEntity("",newHttpHeaders(),HttpStatus.NO_CONTENT);
else{thrownewRestException("Unabletoremovefile:"+file.getName(),HttpStatus.BAD_REQUEST);
if(fileName!=null){response=lookupFile(fileName,dir);response.setParent((ImportContext)dir.getParent());
if(!(context.getData()instanceofDirectory)){thrownewRestException("Dataisnotadirectory",HttpStatus.BAD_REQUEST);
if(file!=null){returnIterators.find(dir.getFiles().iterator(),newPredicate<FileData>(){@Overridepublicbooleanapply(FileDatainput){returninput.getFile().getName().equals(file);
if(lockType==LockType.READ&&isWriteMethod(method)){configurationLock.tryUpgradeLock();
if((r.getMinScaleDenominator()-TOLERANCE<=scaleDenominator)&&(r.getMaxScaleDenominator()+TOLERANCE>scaleDenominator)&&r.getSymbolizers()!=null&&r.getSymbolizers().length>0){result.add(r);
if(null==this.request.getLanguage()){this.locale=newLocale("en-CA");
else{this.locale=newLocale(this.request.getLanguage());
if(null==this.request.getIdentifier()||this.request.getIdentifier().isEmpty()){thrownewWPSException("Invalididentifier","Noidentifierpresent");
if("all".equalsIgnoreCase(identifier.getLocalPart())&&identifier.getNamespaceURI()==null){this.processDescriptionAll();return;
if(null==pf){thrownewWPSException("Invalididentifier","InvalidParameterValue");
if(false==this.dataTransformer.isTransmutable(pf,identifier)){thrownewWPSException("Invalididentifier","InvalidParameterValue");
if(false==this.dataTransformer.isTransmutable(pf,processName)){continue;
if(-1==maxOccurs){maxOccurs=Integer.MAX_VALUE;
if(transmuterinstanceofComplexTransmuter){start("ComplexData");this.complexParameter((ComplexTransmuter)transmuter);end("ComplexData");
else{this.literalData((LiteralTransmuter)transmuter);
if(transmuterinstanceofComplexTransmuter){start("ComplexOutput");this.complexParameter((ComplexTransmuter)transmuter);end("ComplexOutput");
else{this.literalData((LiteralTransmuter)transmuter);
if(mapLayers==null){returnnull;
if(env==null){returnnull;
if(epsgId==null){assertXpathEvaluatesTo("52.5-1.352.6-1.352.6-1.252.5-1.252.5-1.3","//gsml:MappedFeature[@gml:id='mf4']/gsml:shape//gml:posList",doc);
else{//Ican'tgetexacttransformationfigurestocomparewith..notimportanttotest//anyway
if(StringUtils.hasLength(adminRoleName)==false)returnnull;try{returngetRoleByName(adminRoleName);
if(StringUtils.hasLength(groupAdminRoleName)==false)returnnull;try{returngetRoleByName(groupAdminRoleName);
if(configinstanceofJDBCSecurityServiceConfig){JDBCSecurityServiceConfigjdbcConfig=(JDBCSecurityServiceConfig)config;StringfileNameDML=jdbcConfig.getPropertyFileNameDML();Resourcefile=checkORCreateJDBCPropertyFile(fileNameDML,getConfigRoot(),DEFAULT_DML_FILE);dmlProps=Util.loadUniversal(file.in());StringfileNameDDL=jdbcConfig.getPropertyFileNameDDL();
if(fileNameDDL!=null&&fileNameDDL.length()>0){file=checkORCreateJDBCPropertyFile(fileNameDDL,getConfigRoot(),DEFAULT_DDL_FILE);ddlProps=Util.loadUniversal(file.in());createTablesIfRequired((JDBCSecurityServiceConfig)config);
if(rs.next()){roleObject=createRoleObject(role);ps2=getDMLStatement("roleprops.selectForRole",con);ps2.setString(1,role);rs2=ps2.executeQuery();while(rs2.next()){StringpropName=rs2.getString(1);ObjectpropValue=rs2.getObject(2);
if(propName!=null){roleObject.getProperties().put(propName,propValue==null?"":propValue);
if(roleObject!=null){roleObject.getProperties().put(propName,propValue==null?"":propValue);
if(roleObject!=null){roleObject.getProperties().put(propName,propValue==null?"":propValue);
if(roleObject!=null){roleObject.getProperties().put(propName,propValue==null?"":propValue);
if(rs.next()){Stringparent=rs.getString(1);
if(parent!=null){//dowehaveaparent?roleObject=createRoleObject(parent);ps2=getDMLStatement("roleprops.selectForRole",con);ps2.setString(1,parent);rs2=ps2.executeQuery();while(rs2.next()){StringpropName=rs2.getString(1);ObjectpropValue=rs2.getObject(2);roleObject.getProperties().put(propName,propValue==null?"":propValue);
ifauserpropertynameequalsarolepropertyname,takethe*valuefromtouserpropertyanduseitfortheroleproperty.*/publicPropertiespersonalizeRoleParams(StringroleName,PropertiesroleParams,StringuserName,PropertiesuserProps)throwsIOException{Propertiesprops=null;//thisistrue
ifthesetismodified-->common//propertynamesexistprops=newProperties();booleanpersonalized=false;for(Objectkey:roleParams.keySet()){
if(userProps.containsKey(key)){props.put(key,userProps.get(key));personalized=true;
elseprops.put(key,roleParams.get(key));
ifyouwanttouseDTDvalidationforthesetests//(bypassingfalseasthesecondparamtogetAsDOM())//BUG:Currently,thisdoesn'tseemtoactuallyvalidatethedocument,although//'validation'fails
iftheDTDismissing//GeoServerInfoglobal=getGeoServer().getGlobal();//global.setProxyBaseUrl("src/test/resources/geoserver");//getGeoServer().save(global);Documentdoc=getAsDOM("wms?service=WMS&request=getCapabilities&version=1.1.1",true);assertXpathEvaluatesTo("0","count(//Attribution)",doc);//AddattributiontooneofthelayersLayerInfopoints=getCatalog().getLayerByName(MockData.POINTS.getLocalPart());AttributionInfoattr=points.getAttribution();attr.setTitle("PointProvider");getCatalog().save(points);doc=getAsDOM("wms?service=WMS&request=getCapabilities&version=1.1.1",true);assertXpathEvaluatesTo("1","count(//Attribution)",doc);assertXpathEvaluatesTo("1","count(//Attribution/Title)",doc);//Addhreftosamelayerattr=points.getAttribution();attr.setHref("http://example.com/points/provider");getCatalog().save(points);doc=getAsDOM("wms?service=WMS&request=getCapabilities&version=1.1.1",true);//print(doc);assertXpathEvaluatesTo("1","count(//Attribution)",doc);assertXpathEvaluatesTo("1","count(//Attribution/Title)",doc);assertXpathEvaluatesTo("1","count(//Attribution/OnlineResource)",doc);//Addlogotosamelayerattr=points.getAttribution();attr.setLogoURL("http://example.com/points/logo");attr.setLogoType("image/logo");attr.setLogoHeight(50);attr.setLogoWidth(50);getCatalog().save(points);doc=getAsDOM("wms?service=WMS&request=getCapabilities&version=1.1.1",true);//print(doc);assertXpathEvaluatesTo("1","count(//Attribution)",doc);assertXpathEvaluatesTo("1","count(//Attribution/Title)",doc);assertXpathEvaluatesTo("1","count(//Attribution/LogoURL)",doc);
ifthescalehintmustbeinunitsperdiagonalofa*pixel*@returnCapabilitiesas{@linkDocument}*/privateDocumentfindCapabilities(BooleanscaleHintUnitsPerDiaPixel)throwsException{//settheScalehintunitsperdiagonalpixelsetting.WMSwms=getWMS();WMSInfoinfo=wms.getServiceInfo();info.setRootLayerTitle("testthetitle");MetadataMapmm=info.getMetadata();mm.put(WMS.SCALEHINT_MAPUNITS_PIXEL,scaleHintUnitsPerDiaPixel);info.getGeoServer().save(info);Capabilities_1_3_0_Transformertr=newCapabilities_1_3_0_Transformer(wms,BASE_URL,wms.getAllowedMapFormats(),newHashSet<ExtendedCapabilitiesProvider>());GetCapabilitiesRequestreq=newGetCapabilitiesRequest();req.setBaseUrl(BASE_URL);req.setVersion(WMS.VERSION_1_3_0.toString());Documentdom=WMSTestSupport.transform(req,tr);Elementroot=dom.getDocumentElement();assertEquals(WMS.VERSION_1_3_0.toString(),root.getAttribute("version"));returndom;
if(group!=null){catalog.remove(group);
if(group!=null){catalog.remove(group);
if(event==null){thrownewNullArgumentException("Incomingobjectisnull");
if(eventinstanceofCatalogRemoveEvent){finalCatalogRemoveEventremoveEv=((CatalogRemoveEvent)event);//getthesourcefinalCatalogInfoinfo=removeEv.getSource();//disabletheproducertoavoidrecursionproducer.disable();//removetheselectedCatalogInfoJMSCatalogRemoveEventHandler.remove(catalog,info,getProperties());
else{//incomingobjectnotrecognized
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe("Unrecognizedeventtype");returnfalse;
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(this.getClass()+"isunabletosynchronizetheincomingevent:"+event);throwe;
if(infoinstanceofLayerGroupInfo){finalLayerGroupInfodeserObject=CatalogUtils.localizeLayerGroup((LayerGroupInfo)info,catalog);catalog.remove(deserObject);//catalog.save(CatalogUtils.getProxy(deserObject));//info=CatalogUtils.localizeLayerGroup((LayerGroupInfo)info,//catalog);
else
if(infoinstanceofLayerInfo){finalLayerInfolayer=CatalogUtils.localizeLayer((LayerInfo)info,catalog);catalog.remove(layer);//catalog.save(CatalogUtils.getProxy(layer));//info=CatalogUtils.localizeLayer((LayerInfo)info,catalog);
else
if(infoinstanceofMapInfo){finalMapInfolocalObject=CatalogUtils.localizeMapInfo((MapInfo)info,catalog);catalog.remove(localObject);//catalog.save(CatalogUtils.getProxy(localObject));//info=CatalogUtils.localizeMapInfo((MapInfo)info,catalog);
else
if(infoinstanceofNamespaceInfo){finalNamespaceInfonamespace=CatalogUtils.localizeNamespace((NamespaceInfo)info,catalog);catalog.remove(namespace);//catalog.save(CatalogUtils.getProxy(namespace));//info=CatalogUtils.localizeNamespace((NamespaceInfo)info,//catalog);
else
if(infoinstanceofStoreInfo){StoreInfostore=CatalogUtils.localizeStore((StoreInfo)info,catalog);catalog.remove(store);//catalog.save(CatalogUtils.getProxy(store));//info=CatalogUtils.localizeStore((StoreInfo)info,catalog);
else
if(infoinstanceofResourceInfo){finalResourceInforesource=CatalogUtils.localizeResource((ResourceInfo)info,catalog);catalog.remove(resource);//catalog.save(CatalogUtils.getProxy(resource));//info=CatalogUtils.localizeResource((ResourceInfo)info,catalog);
else
if(infoinstanceofStyleInfo){finalStyleInfostyle=CatalogUtils.localizeStyle((StyleInfo)info,catalog);catalog.remove(style);//checkoptionsfinalStringpurge=(String)options.get("purge");
if(purge!=null&&Boolean.parseBoolean(purge)){try{catalog.getResourcePool().deleteStyle(style,true);
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE)){LOGGER.severe(e.getLocalizedMessage());
else
if(infoinstanceofWorkspaceInfo){finalWorkspaceInfoworkspace=CatalogUtils.localizeWorkspace((WorkspaceInfo)info,catalog);catalog.remove(workspace);//catalog.detach(workspace);//info=CatalogUtils.localizeWorkspace((WorkspaceInfo)info,//catalog);
else
if(infoinstanceofCatalogInfo){//TODOmaywedon'twanttosendthisemptymessage!//TODOchecktheproducer//DONOTHING
if(LOGGER.isLoggable(java.util.logging.Level.WARNING)){LOGGER.warning("info-ID:"+info.getId()+"toString:"+info.toString());
else{thrownewIllegalArgumentException("Badincomingobject:"+info.toString());
if(kvp.containsKey("outputFormat")){Objectformat=kvp.get("outputFormat");setOutputFormat(kvp,rawKvp,format);
else
if(kvp.containsKey("f")){Objectformat=kvp.get("f");setOutputFormat(kvp,rawKvp,format);
ifexists)or*windows-style(fail
ifexists).**@returntrueiffjdbcstoreshoulddeletedestinationonrename*/publicbooleanisDeleteDestinationOnRename(){returnBoolean.valueOf(getProperty("deleteDestinationOnRename","false"));
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofStyleInfo))returnfalse;finalStyleInfoother=(StyleInfo)obj;
if(filename==null){
if(other.getFilename()!=null)returnfalse;
else
if(!filename.equals(other.getFilename()))returnfalse;
if(id==null){
if(other.getId()!=null)returnfalse;
else
if(!id.equals(other.getId()))returnfalse;
if(name==null){
if(other.getName()!=null)returnfalse;
else
if(!name.equals(other.getName()))returnfalse;
if(workspace==null){
if(other.getWorkspace()!=null)returnfalse;
else
if(!workspace.equals(other.getWorkspace()))returnfalse;
if(format==null){
if(other.getFormat()!=null)returnfalse;
else{
if(!format.equals(other.getFormat()))returnfalse;
if(languageVersion==null){
if(other.getFormatVersion()!=null)returnfalse;
else
if(!languageVersion.equals(other.getFormatVersion()))returnfalse;returntrue;
if(format==null){format=SLDHandler.FORMAT;
if(languageVersion==null&&sldVersion!=null){languageVersion=sldVersion;
if(languageVersion==null){languageVersion=SLDHandler.VERSION_10;
if(workspace!=null){returnworkspace.getName()+":"+getName();
else{returngetName();
if(!valueAsString.trim().equals("")){file=newFile(valueAsString);
if(!file.exists())file=null;
if(!fileField.getInput().trim().equals("")){file=newFile(fileField.getInput());
if(!file.exists())file=null;
if(value==null||value.trim().length()==0){returnnull;
if(!value.endsWith("%")){value+="%";
if(Double.class.isAssignableFrom(type)){return(IConverter<C>)percentConverter;
if(clazz==WicketTestApplication.class&&path.startsWith(wtapath)){StringnewPath=path.replace(wtapath,gsapath);returnsuper.load(GeoServerApplication.class,newPath);
if(factory==null){thrownewNullPointerException("Youmustprovideanonnullcomponentfactory");
if(execute.getResponseForm()!=null){responseDocument=execute.getResponseForm().getResponseDocument();rawDataOutput=execute.getResponseForm().getRawDataOutput();
if(responseDocument!=null&&rawDataOutput!=null){thrownewWPSException("Invalidrequest,onlyoneoftherawdataoutputorthe"+"responsedocumentshouldbespecifiedintherequest");
if(aep!=null)//removefromrequestrequest.removeAttribute(AUTHENTICATION_ENTRY_POINT_HEADER);//entrypointspecified?
if(getEntryEntryPoint()!=null){getEntryEntryPoint().commence(request,response,authException);return;
if(aep!=null){aep.commence(request,response,authException);return;
if(StringUtils.hasLength(authConfig.getAuthenticationFilterName())){GeoServerSecurityFilterauthFilter=getSecurityManager().loadFilter(authConfig.getAuthenticationFilterName());ep.setEntryEntryPoint(authFilter.getAuthenticationEntryPoint());
if(StringUtils.hasLength(authConfig.getAccessDeniedErrorPage())){//check
ifpageexists
if(GeoServerExtensions.file(authConfig.getAccessDeniedErrorPage())!=null)accessDeniedHandler.setErrorPage(authConfig.getAccessDeniedErrorPage());
elseLOGGER.warning("Cannotfind:"+authConfig.getAccessDeniedErrorPage());
if(predicateBuilder!=null){params=predicateBuilder.getNamedParameters();
if(order==null){this.sortOrder();
else{this.sortOrder(newSortBy[]{order});
if(order==null||order.length==0){this.sortOrder=null;
else{this.sortOrder=order;
if(queryType!=null){query.append("type_idin(:types)/*").append(queryType.getCanonicalName()).append("*/\nAND");
if(i>0)orderBy.append(",");orderBy.append(attributeName).append("").append(ascDesc(order));i++;
if(isMappedProp){//continuenormallyreturnnull;
if(isCountQuery){
if(Filter.INCLUDE.equals(this.originalFilter)){query.append("selectcount(oid)fromobjectwheretype_idin(:types)");
else{query.append("selectcount(oid)fromobjectwheretype_idin(:types)AND(\n");query.append(whereClause).append("\n)");
else{SortBy[]orders=this.sortOrder;
if(orders==null){query.append("selectidfromobjectwheretype_idin(:types)AND(\n");query.append(whereClause).append(")\n");query.append("ORDERBYoid");
else{querySortBy(query,whereClause,orders);
if(unsupportedFilter.equals(Filter.INCLUDE)){dialect.applyOffsetLimit(sql,offset,limit);offsetLimitApplied=true;
else{offsetLimitApplied=false;
ifthefileordirectorydenotedbythisresourceexists.**@seeFile#exists()*@paramresourceResourceindicated*@returntrueIfresourceisnotUNDEFINED*/publicstaticbooleanexists(Resourceresource){returnresource!=null&&resource.getType()!=Resource.Type.UNDEFINED;
ifthefileordirectorycanberead.**@seeFile#canRead()*@paramresourceResourceindicated*@returntrueIfresourceisnotUNDEFINED*/publicstaticbooleancanRead(Resourceresource){try{InputStreamis=resource.in();is.read();is.close();returntrue;
ifthefileordirectorybehindtheresourceishidden.Forfilesystembasedresources,*theplatform-dependenthiddenpropertyisused.Forotherresourceimplementations,filenames*startingwitha"."areconsideredhidden,irrespectiveoftheplatform.**@seeFile#isHidden()*@paramresourceResourceindicated*@returntrueIfresourceishidden*/publicstaticbooleanisHidden(Resourceresource){
if(resourceinstanceofSerializableResourceWrapper){resource=((SerializableResourceWrapper)resource).delegate;
if(resourceinstanceofFileSystemResourceStore.FileSystemResource||resourceinstanceofFiles.ResourceAdaptor){//thisisafilebasedresource,justcheckthefilereturnfind(resource).isHidden();
else{//notafilesystembasedresource,nopointincaching//weonlysupportlinuxstylehiddenfile.returnresource.name().startsWith(".");
if(resource==null){returnnull;
switch(resource.getType()){caseDIRECTORY:returnresource.dir();caseRESOURCE:returnresource.file();default:returnnull;
ifavailable,ornullfor{@link*Resource.Type#UNDEFINED}or{@linkResource.Type#RESOURCE}.**<p>ThisapproachisareproductionofGeoServerDataDirectoryfindDataDirlogicandwillnot*createanewdirectory.**@seeResource#dir()*@paramresourceResourceindicated*@returnFilereferencetoexistingdirectory,ornullforanexistingfile(or
ifdirectory*doesnotexist)*/publicstaticFiledirectory(Resourceresource){returndirectory(resource,false);
ifadirectoryexistsreturnsresource.dir,otherwiseitreturnsnull.**@seeResource#dir()*@paramresourceResourceindicated*@paramcreatetruetocreatedirectory(ifitdoesnotexsist)*@returnFilereferenceto(possiblynew)directory*/publicstaticFiledirectory(Resourceresource,booleancreate){finalFilef;
if(resource==null){f=null;
else
if(create){f=resource.dir();
else{
if(resource.getType()==Type.DIRECTORY){f=resource.dir();
else{f=null;
ifavailable,ornullfor*{@linkResource.Type#UNDEFINED}or{@linkResource.Type#DIRECTORY}.**<p>ThisapproachisareproductionofGeoServerDataDirectoryfindDataFilelogicandwillnot*createanewfile.**@seeResource#file()*@paramresourceResourceindicated*@returnExistingfile,ornull*/publicstaticFilefile(Resourceresource){returnfile(resource,false);
ifafileexistsreturnsresource.file,otherwiseitreturnsnull.**@seeResource#file()*@paramresourceResourceindicated*@paramcreatetruetocreate(ifneeded)*@returnfile,ornull*/publicstaticFilefile(Resourceresource,booleancreate){finalFilef;
if(resource==null){f=null;
else
if(create){f=resource.file();
else{
if(resource.getType()==Type.RESOURCE){f=resource.file();
else{f=null;
switch(resource.getType()){caseDIRECTORY:thrownewIOException("Newdirectory"+resource.path()+"alreadyexistsasDIRECTORY");caseRESOURCE:thrownewIOException("Newdirectory"+resource.path()+"alreadyexistsasRESOURCE");caseUNDEFINED:returnresource.dir();//willcreatedirectoryasneededdefault:returnnull;
switch(resource.getType()){caseDIRECTORY:thrownewIOException("Newfile"+resource.path()+"alreadyexistsasDIRECTORY");caseRESOURCE:thrownewIOException("Newfile"+resource.path()+"alreadyexistsasRESOURCE");caseUNDEFINED:returnresource.file();//willcreatedirectoryasneededdefault:returnnull;
if(resource.getType()==Type.DIRECTORY){ArrayList<Resource>results=newArrayList<Resource>();for(Resourcechild:resource.list()){
switch(child.getType()){caseRESOURCE:
if(child.lastmodified()>lastModified){results.add(child);
if(data.getType()==Type.DIRECTORY){for(Resourcechild:data.list()){copy(child,destination.get(child.name()));
else{try(InputStreamin=data.in()){copy(in,destination);
ifsuccessful,false
ifeitherthewriteordeletefailed.*/publicstaticbooleanrenameByCopy(Resourcesource,Resourcedestination){try{copy(source,destination);returnsource.delete();
if(filter.accept(child)){res.add(child);
if(recursive&&child.getType()==Type.DIRECTORY){res.addAll(list(child,filter,true));
ifthepathisrelativeitwillreturnaresourcefromthe*defaultresourceloaderotherwiseitwillreturnafilebasedresource**@parampathrelativeorabsolutepath*@returnresource*/publicstaticResourcefromPath(Stringpath){return((GeoServerResourceLoader)GeoServerExtensions.bean("resourceLoader")).fromPath(path);
ifthepathisrelativeitwillreturnaresourcerelativeto*theprovideddirectoryotherwiseitwillreturnafilebasedresource**@parampathrelativeorabsolutepath*@paramrelativeDirdirectorytowhichrelativepathsarerelative*@returnresource*/publicstaticorg.geoserver.platform.resource.ResourcefromPath(Stringpath,org.geoserver.platform.resource.ResourcerelativeDir){Filefile=newFile(path);
if(file.isAbsolute()){returnFiles.asResource(file);
else{returnrelativeDir.get(path.replace(File.separatorChar,'/'));
if((ss=StringUtils.removeStart(url,"resource:"))!=url){returnbaseDirectory.get(ss);
ifpathlookslikeanabsolutefile:URL,trystandardconversion
if(url.startsWith("file:/")){try{returnFiles.asResource(URLs.urlToFile(newURL(url)));
if(url.startsWith("file:")){url=url.substring(5);//remove'file:'prefixFilef=newFile(url);
if(f.isAbsolute()||f.exists()){returnFiles.asResource(f);//
ifit'sanabsolutepath,useitassuch
else{//otherwisetrytomapitinsidethedatadir
if(baseDirectory!=null){returnbaseDirectory.get(url);
else{//Treating'url'asanormalfilepathFilefile=newFile(url);
if(file.isAbsolute()||file.exists()){returnFiles.asResource(file);//
ifit'sanabsolutepath,useitassuch
if(baseDirectory!=null){Resourceres=baseDirectory.get(url);
if(exists(res)){returnres;
if(url.getProtocol().equalsIgnoreCase("resource")){returnbaseDirectory.get(Paths.convert(url.getPath()));
else
if(url.getProtocol().equalsIgnoreCase("file")){returnFiles.asResource(URLs.urlToFile(url));
else{returnnull;
if(resinstanceofFiles.ResourceAdaptor){returnres.file().toURI().toURL();
if(resinstanceofURIs.ResourceAdaptor){return((URIs.ResourceAdaptor)res).getURL();
if(!(oinstanceofSerializableResourceWrapper)){returnfalse;
if(resourceinstanceofSerializable){returnresource;
if(resource==null){returnnull;
if(!canExecute(sourcePath.toString())){return;
if(root==null||root.isEmpty()){root=DEFAULT_ROOT_DIRECTORY;
if(FilenameUtils.normalize(itemPath).startsWith(FilenameUtils.normalize(tmpUploadFolder.toString()))){canExecute=true;
if(paramInfo.getName()==TeradataDataStoreFactory.APPLICATION.key){info.getConnectionParameters().put(TeradataDataStoreFactory.APPLICATION.key,"GeoServer");
else{super.applyParamDefault(paramInfo,info);
ifexistingandenabledtoothis.enabledDimensions=WCSDimensionsHelper.getDimensionsFromMetadata(ci.getMetadata());this.subsettingCRS=subsettingCRS;this.reader=reader;this.envelopeDimensionsMapper=envelopeDimensionsMapper;timeDimension=enabledDimensions.get(ResourceInfo.TIME);elevationDimension=enabledDimensions.get(ResourceInfo.ELEVATION);
if(timeDimension!=null||elevationDimension!=null||!enabledDimensions.isEmpty()){accessor=newReaderDimensionsAccessor(reader);
ifthedimensionnameisempty**@paramdim*/publicstaticStringgetDimensionName(DimensionSubsetTypedim){//getbasicinformationStringdimension=dim.getDimension();//removecommonprefixes
if(dimension.startsWith("http://www.opengis.net/def/axis/OGC/0/")){dimension=dimension.substring("http://www.opengis.net/def/axis/OGC/0/".length());
else
if(dimension.startsWith("http://opengis.net/def/axis/OGC/0/")){dimension=dimension.substring("http://opengis.net/def/axis/OGC/0/".length());
else
if(dimension.startsWith("http://opengis.net/def/crs/ISO/2004/")){dimension=dimension.substring("http://opengis.net/def/crs/ISO/2004/".length());
if(dimension==null||dimension.length()<=0){thrownewWCS20Exception("Empty/invalidaxislabelprovided:"+dim.getDimension(),WCS20Exception.WCS20ExceptionCode.InvalidAxisLabel,"subset");
if(!(subsettingCRS==null||CRS.equalsIgnoreMetadata(subsettingCRS,sourceCRS))){//reprojectsourceenvelopetosubsettingcrsforinitializationtry{sourceEnvelopeInSubsettingCRS=newWCSEnvelope(CRS.transform(reader.getOriginalEnvelope(),subsettingCRS));
ifwecangetavalidrestrictedareausingtheprojectionhandlersProjectionHandlerhandler=ProjectionHandlerFinder.getHandler(newReferencedEnvelope(0,1,0,1,subsettingCRS),sourceCRS,true);
if(handler!=null){ReferencedEnvelopevalidArea=handler.getValidAreaBounds();Envelopeintersection=validArea.intersection(ReferencedEnvelope.reference(reader.getOriginalEnvelope()));ReferencedEnvelopere=newReferencedEnvelope(intersection,sourceCRS);sourceEnvelopeInSubsettingCRS=newWCSEnvelope(re.transform(subsettingCRS,true));
else{thrownewWCS20Exception("Unabletoinitializesubsettingenvelope",WCS20Exception.WCS20ExceptionCode.SubsettingCrsNotSupported,subsettingCRS.toWKT(),e);//TODOextractcode
ifwehavetosubset,
ifnotlet'ssendbackthebasiccoveragefinalEList<DimensionSubsetType>requestedDimensions=request.getDimensionSubset();
if(requestedDimensions==null||requestedDimensions.size()<=0){returnsourceEnvelopeInSubsettingCRS;
if(requestedDimensions.size()>maxDimensions){thrownewWCS20Exception("Invalidnumberofdimensions",WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,Integer.toString(requestedDimensions.size()));
if(WCSDimensionsSubsetHelper.TIME_NAMES.contains(dimension.toLowerCase())){
if(dimensionKeys.contains(ResourceInfo.TIME)){//fine,we'llparseitlatercontinue;
else{thrownewWCS20Exception("Invalidaxislabelprovided:"+dimension,WCS20Exception.WCS20ExceptionCode.InvalidAxisLabel,null);
if(WCSDimensionsSubsetHelper.ELEVATION_NAMES.contains(dimension.toLowerCase())){
if(dimensionKeys.contains(ResourceInfo.ELEVATION)){//fine,we'llparseitlatercontinue;
else{thrownewWCS20Exception("Invalidaxislabelprovided:"+dimension,WCS20Exception.WCS20ExceptionCode.InvalidAxisLabel,null);
if(dimensionKey.equalsIgnoreCase(dimension)){isCustomDimension=true;break;
if(isCustomDimension){continue;
if(!axesNames.contains(dimension)){thrownewWCS20Exception("Invalidaxislabelprovided:"+dimension,WCS20Exception.WCS20ExceptionCode.InvalidAxisLabel,dimension==null?"Null":dimension);
if(foundDimensions.contains(dimension)){thrownewWCS20Exception("Axislabelalreadyusedduringsubsetting",WCS20Exception.WCS20ExceptionCode.InvalidAxisLabel,dimension);
if(diminstanceofDimensionTrimType){//TRIMMINGfinalDimensionTrimTypetrim=(DimensionTrimType)dim;finaldoublelow=Double.parseDouble(trim.getTrimLow());finaldoublehigh=Double.parseDouble(trim.getTrimHigh());finalintaxisIndex=envelopeDimensionsMapper.getAxisIndex(sourceEnvelopeInSubsettingCRS,dimension);
if(axisIndex<0){thrownewWCS20Exception("Invalidaxisprovided",WCS20Exception.WCS20ExceptionCode.InvalidAxisLabel,dimension);
if(low>high&&!subsettingEnvelope.isLongitude(axisIndex)){thrownewWCS20Exception("LowgreaterthanHigh",WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,trim.getTrimLow());
else
if(diminstanceofDimensionSliceType){//SLICINGfinalDimensionSliceTypeslicing=(DimensionSliceType)dim;finalStringslicePointS=slicing.getSlicePoint();finaldoubleslicePoint=Double.parseDouble(slicePointS);finalintaxisIndex=envelopeDimensionsMapper.getAxisIndex(sourceEnvelopeInSubsettingCRS,dimension);
if(axisIndex<0){thrownewWCS20Exception("Invalidaxisprovided",WCS20Exception.WCS20ExceptionCode.InvalidAxisLabel,dimension);
if(sourceEnvelopeInSubsettingCRS.getMinimum(axisIndex)>slicePoint||slicePoint>sourceEnvelopeInSubsettingCRS.getMaximum(axisIndex)){thrownewWCS20Exception("SlicePointoutsidecoverageenvelope",WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,slicePointS);
else{thrownewWCS20Exception("Invalidelementfoundwhileattemptingtoparsedimensionsubsettingrequest",WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,dim.getClass().toString());
if(subsettingEnvelope.isEmpty()){thrownewWCS20Exception("Emptyintersectionaftersubsetting",WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,"");//TODOspitour//envelopetrimmed
if(!CRS.equalsIgnoreMetadata(subsettingCRS,sourceCRS)){//finalGeneralEnvelopesubsettingEnvelopeInSourceCRS=CRS.transform(//subsettingEnvelope,sourceCRS);//////intersect//subsettingEnvelopeInSourceCRS.intersect(sourceEnvelope);//////providedtrimextentdoesnotintersectcoverageenvelope//
if(subsettingEnvelopeInSourceCRS.isEmpty()){//thrownewWCS20Exception(//"Emptyintersectionaftersubsetting",//WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,"");//TODOspitourenvelopetrimmed//
if(timeDimension!=null){for(DimensionSubsetTypedim:request.getDimensionSubset()){Stringdimension=WCSDimensionsSubsetHelper.getDimensionName(dim);//onlycarefortimedimensions
if(!TIME_NAMES.contains(dimension.toLowerCase())){continue;
if(timeSubset!=null){thrownewWCS20Exception("Timedimensiontrimming/slicingspecifiedtwiceintherequest",WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,"subset");
if(diminstanceofDimensionTrimType){//TRIMMINGfinalDimensionTrimTypetrim=(DimensionTrimType)dim;finalDatelow=PARSER.parseDateTime(trim.getTrimLow());finalDatehigh=PARSER.parseDateTime(trim.getTrimHigh());//low>high???
if(low.compareTo(high)>0){thrownewWCS20Exception("LowgreaterthanHigh:"+trim.getTrimLow()+","+trim.getTrimHigh(),WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,"subset");
else
if(diminstanceofDimensionSliceType){//SLICINGfinalDimensionSliceTypeslicing=(DimensionSliceType)dim;finalStringslicePointS=slicing.getSlicePoint();finalDateslicePoint=PARSER.parseDateTime(slicePointS);timeSubset=newDateRange(slicePoint,slicePoint);
else{thrownewWCS20Exception("Invalidelementfoundwhileattemptingtoparsedimensionsubsettingrequest:"+dim.getClass().toString(),WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,"subset");
if(!(readerinstanceofStructuredGridCoverage2DReader)&&timeSubset!=null&&!timeSubset.getMinValue().equals(timeSubset.getMaxValue())){thrownewWCS20Exception("TrimmingontimeisnotsupportedatthemomentonnotStructuredGridCoverage2DReaders,onlyslicingis");
if(timeSubset!=null&&timeSubset.getMinValue().equals(timeSubset.getMaxValue())){timeSubset=interpolateTime(timeSubset,accessor);
if(!domainContainsPoint(slicePoint,domain)){//lookfortheclosesttimeDateprevious=null;DatenewSlicePoint=null;//forNNmatchingwedon'tneedtheranges,NNagainsttheirextremawillbefineTreeSet<Date>domainDates=getDomainDates(domain);for(Datecurr:domainDates){
if(curr.compareTo(slicePoint)>0){
if(previous==null){newSlicePoint=curr;break;
else{longdiffPrevious=slicePoint.getTime()-previous.getTime();longdiffCurr=curr.getTime()-slicePoint.getTime();
if(diffCurr>diffPrevious){newSlicePoint=curr;break;
else{newSlicePoint=previous;break;
else{previous=curr;
if(newSlicePoint==null){newSlicePoint=previous;
if(iteminstanceofDate){Datedate=(Date)item;results.add(date);
else
if(iteminstanceofDateRange){DateRangerange=(DateRange)item;results.add(range.getMinValue());results.add(range.getMaxValue());
if(slicePointinstanceofDate){DatesliceDate=(Date)slicePoint;for(Objectcurr:domain){
if(currinstanceofDate){Datedate=(Date)curr;intresult=date.compareTo(sliceDate);
if(result>0){returnfalse;
else
if(result==0){returntrue;
else
if(currinstanceofDateRange){DateRangerange=(DateRange)curr;
if(range.contains(sliceDate)){returntrue;
else
if(range.getMaxValue().compareTo(sliceDate)<0){returnfalse;
else
if(slicePointinstanceofNumber){//TODO:Shouldwecheckforotherdatatypes?NumbersliceNumber=(Number)slicePoint;for(Objectcurr:domain){
if(currinstanceofNumber){Doublenum=(Double)curr;intresult=num.compareTo((Double)sliceNumber);
if(result>0){returnfalse;
else
if(result==0){returntrue;
else
if(currinstanceofNumberRange){NumberRangerange=(NumberRange)curr;
if(range.contains(sliceNumber)){returntrue;
else
if(range.getMaxValue().compareTo(sliceNumber)<0){returnfalse;
if(elevationDimension!=null){for(DimensionSubsetTypedim:request.getDimensionSubset()){Stringdimension=WCSDimensionsSubsetHelper.getDimensionName(dim);//onlycareforelevationdimensions
if(!WCSDimensionsSubsetHelper.ELEVATION_NAMES.contains(dimension.toLowerCase())){continue;
if(elevationSubset!=null){thrownewWCS20Exception("Elevationdimensiontrimming/slicingspecifiedtwiceintherequest",WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,"subset");
if(diminstanceofDimensionTrimType){//TRIMMINGfinalDimensionTrimTypetrim=(DimensionTrimType)dim;finalDoublelow=PARSER.parseDouble(trim.getTrimLow());finalDoublehigh=PARSER.parseDouble(trim.getTrimHigh());//low>high???
if(low>high){thrownewWCS20Exception("LowgreaterthanHigh:"+trim.getTrimLow()+","+trim.getTrimHigh(),WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,"subset");
else
if(diminstanceofDimensionSliceType){//SLICINGfinalDimensionSliceTypeslicing=(DimensionSliceType)dim;finalStringslicePointS=slicing.getSlicePoint();finalDoubleslicePoint=PARSER.parseDouble(slicePointS);elevationSubset=newNumberRange<Double>(Double.class,slicePoint,slicePoint);
else{thrownewWCS20Exception("Invalidelementfoundwhileattemptingtoparsedimensionsubsettingrequest:"+dim.getClass().toString(),WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,"subset");
if(!(readerinstanceofStructuredGridCoverage2DReader)&&elevationSubset!=null&&!elevationSubset.getMinValue().equals(elevationSubset.getMaxValue())){thrownewWCS20Exception("TrimmingonelevationisnotsupportedatthemomentonnotStructuredGridCoverage2DReaders,onlyslicingis");
if(elevationSubset!=null&&elevationSubset.getMinValue().equals(elevationSubset.getMaxValue())){interpolateElevation(elevationSubset,accessor);
if(!domainContainsPoint(slicePoint,domain)){//lookfortheclosestelevationDoubleprevious=null;DoublenewSlicePoint=null;//forNNmatchingwedon'tneedtherange,NNagainsttheirextremawillbefineTreeSet<Double>domainDates=PARSER.getDomainNumber(domain);for(Doublecurr:domainDates){
if(curr.compareTo(slicePoint)>0){
if(previous==null){newSlicePoint=curr;break;
else{doublediffPrevious=slicePoint-previous;doublediffCurr=curr-slicePoint;
if(diffCurr>diffPrevious){newSlicePoint=curr;break;
else{newSlicePoint=previous;break;
else{previous=curr;
if(newSlicePoint==null){newSlicePoint=previous;
if(enabledDimensions!=null&&!enabledDimensions.isEmpty()){Set<String>dimensionKeys=enabledDimensions.keySet();for(DimensionSubsetTypedim:request.getDimensionSubset()){Stringdimension=getDimensionName(dim);
if(WCSDimensionsSubsetHelper.ELEVATION_NAMES.contains(dimension.toLowerCase())||WCSDimensionsSubsetHelper.TIME_NAMES.contains(dimension.toLowerCase())){continue;
if(dimensionKeys.contains(dimension)){List<Object>selectedValues=newArrayList<Object>();//nowdecidewhattodo
if(diminstanceofDimensionTrimType){//TRIMMINGfinalDimensionTrimTypetrim=(DimensionTrimType)dim;setSubsetRangeValue(dimension,trim.getTrimLow(),trim.getTrimHigh(),selectedValues);
else
if(diminstanceofDimensionSliceType){//SLICINGfinalDimensionSliceTypeslicing=(DimensionSliceType)dim;setSubsetValue(dimension,slicing.getSlicePoint(),selectedValues);
else{thrownewWCS20Exception("Invalidelementfoundwhileattemptingtoparsedimensionsubsettingrequest:"+dim.getClass().toString(),WCS20Exception.WCS20ExceptionCode.InvalidSubsetting,"subset");
if(domainDatatype!=null){PARSER.setRangeValues(low,high,selectedValues,domainDatatype);
else{//Trywithrecursivesettings//Trysettingthevalueasatime
if(!sliceSet){sliceSet=PARSER.setAsDateRange(low,high,selectedValues);
if(!sliceSet){sliceSet=PARSER.setAsIntegerRange(low,high,selectedValues);
if(!sliceSet){sliceSet=PARSER.setAsDoubleRange(low,high,selectedValues);
if(!sliceSet){//SettingitasaStringselectedValues.add(low+"/"+high);//CheckThat
if(domainDatatype!=null){PARSER.setValues(slicePoint,selectedValues,domainDatatype);
else{//Trywithrecursivesettings//Trysettingthevalueasatime
if(!sliceSet){sliceSet=PARSER.setAsDate(slicePoint,selectedValues);
if(!sliceSet){sliceSet=PARSER.setAsInteger(slicePoint,selectedValues);
if(!sliceSet){sliceSet=PARSER.setAsDouble(slicePoint,selectedValues);
if(!sliceSet){//SettingitasaStringselectedValues.add(slicePoint);
if(enabledDimensions!=null&&!enabledDimensions.isEmpty()){//extracttemporalsubsettingtemporalSubset=extractTemporalSubset();//extractelevationsubsettingelevationSubset=extractElevationSubset();//extractdimensionssubsettingdimensionsSubset=extractDimensionsSubset();
ifneededStringcoverageName=getCoverageName();//TODOconsiderdealingwiththeFormatinstanceinsteadofaStringparsingorcheck//againstWCSUtils.isSupportedMDOutputFormat(String).
if(!GetCoverage.formatSupportMDOutput(request.getFormat())){//Rightnow,onlyafewformatssupportmultidimensionaloutput.//Let'susedefaultvaluesfortheothers.WCSDefaultValuesHelperdefaultValuesHelper=newWCSDefaultValuesHelper(reader,accessor,request,coverageName);defaultValuesHelper.setDefaults(subsettingRequest);
ifavailable.SincethenativeCoverageNamemaybenullforsinglecoverage*formatswegetthefirstgridcoveragenamefromthereaderasbackup.**@throwsIOException*/privateStringgetCoverageName()throwsIOException{finalStringnativeName=coverageInfo.getNativeCoverageName();return(nativeName!=null?nativeName:reader.getGridCoverageNames()[0]);
if(readerinstanceofStructuredGridCoverage2DReader){structuredReader=(StructuredGridCoverage2DReader)reader;
else{thrownewIllegalArgumentException("ThemethodisonlysupportedforStructuredGridCoverage2DReaders");
if(source==null){thrownewIllegalArgumentException("NogranulesourceavailableforthatcoverageName");
if(timeDescriptor!=null){startTimeAttribute=timeDescriptor.getStartAttribute();endTimeAttribute=timeDescriptor.getEndAttribute();DatestartDate=(Date)feature.getAttribute(startTimeAttribute);DateendDate=(endTimeAttribute!=null)?(Date)feature.getAttribute(endTimeAttribute):startDate;DateRangerange=newDateRange(startDate,endDate);subRequest.setTemporalSubset(range);
if(elevationDescriptor!=null){startElevationAttribute=elevationDescriptor.getStartAttribute();endElevationAttribute=elevationDescriptor.getEndAttribute();NumberstartValue=(Number)feature.getAttribute(startElevationAttribute);NumberendValue=(endElevationAttribute!=null)?(Number)feature.getAttribute(endElevationAttribute):startValue;NumberRangerange=newNumberRange(startValue.getClass(),startValue,endValue);subRequest.setElevationSubset(range);
if(descriptor!=null){startAttribute=descriptor.getStartAttribute();endAttribute=descriptor.getEndAttribute();Objectvalue=feature.getAttribute(startAttribute);
if(endAttribute!=null){ObjectendValue=feature.getAttribute(endAttribute);ClassobjectClass=endValue.getClass();StringclassDataType=objectClass.toString();
if(classDataType.endsWith("Timestamp")){value=newDateRange(newDate(((Timestamp)value).getTime()),newDate(((Timestamp)endValue).getTime()));
else
if(classDataType.endsWith("Date")){value=newDateRange((Date)value,(Date)endValue);
else{value=newNumberRange(objectClass,(Number)value,(Number)endValue);
else{//filter=ff.within(geometryProperty,polygonLiteral);//
if(elevationRange!=null&&filter!=Filter.EXCLUDE){elevationDescriptor=WCSDimensionsHelper.getDimensionDescriptor(reader,coverageName,"ELEVATION");startElevation=elevationDescriptor.getStartAttribute();endElevation=elevationDescriptor.getEndAttribute();elevationFilter=filter(startElevation,endElevation,elevationRange.getMinValue(),elevationRange.getMaxValue(),filter);
if(timeRange!=null&&filter!=Filter.EXCLUDE){timeDescriptor=WCSDimensionsHelper.getDimensionDescriptor(reader,coverageName,"TIME");startTime=timeDescriptor.getStartAttribute();endTime=timeDescriptor.getEndAttribute();timeFilter=filter(startTime,endTime,timeRange.getMinValue(),timeRange.getMaxValue(),filter);
if(subset!=null&&!subset.isEmpty()){Set<String>dimensions=subset.keySet();Iterator<String>dimensionsIt=dimensions.iterator();//Filteringoverthedimensionswhile(dimensionsIt.hasNext()){finalStringdimensionName=dimensionsIt.next();List<Object>dimensionValues=subset.get(dimensionName);
if(dimensionValues==null||dimensionValues.isEmpty()){continue;
if(dimensionDescriptor!=null){finalStringstartAttrib=dimensionDescriptor.getStartAttribute();finalStringendAttrib=dimensionDescriptor.getEndAttribute();dimensionsFilter=filterDimension(startAttrib,endAttrib,dimensionValues,filter);
else{
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("Thespecifieddimension"+dimensionName+"hasnodescriptorsinthereader.Skippingit");continue;
if(dimensionValues!=null&&!dimensionValues.isEmpty()){//Notethatcurrently,dimensionValuesonlycontainoneelement(slicingspecifiesa//singlevalueforadimension)Objectelement=dimensionValues.get(0);Objectmin=null;Objectmax=null;
if(elementinstanceofDateRange){DateRangedateRange=(DateRange)element;min=dateRange.getMinValue();max=dateRange.getMaxValue();
else
if(elementinstanceofNumberRange){NumberRangenumberRange=(NumberRange)element;min=numberRange.getMinValue();max=numberRange.getMaxValue();
else
if(elementinstanceofDate||elementinstanceofNumber||elementinstanceofString){min=element;max=element;
else{thrownewIllegalArgumentException("Unsupportedobjecttype");
if(endAttribute==null){//singlevaluetimelocalFilter=ff.between(ff.property(startAttribute),ff.literal(min),ff.literal(max));
else{//rangevalue,weneedtoaccountforcontainmentthenFilterf1=ff.lessOrEqual(ff.property(startAttribute),ff.literal(max));Filterf2=ff.greaterOrEqual(ff.property(endAttribute),ff.literal(min));localFilter=ff.and(Arrays.asList(f1,f2));
if(filter==null){filter=localFilter;
else{filter=ff.and(filter,localFilter);
if(endAttribute==null){//singlevaluetimelocalFilter=ff.between(ff.property(startAttribute),ff.literal(minValue),ff.literal(maxValue));
else{//rangevalue,weneedtoaccountforcontainmentthenFilterf1=ff.lessOrEqual(ff.property(startAttribute),ff.literal(maxValue));Filterf2=ff.greaterOrEqual(ff.property(endAttribute),ff.literal(minValue));localFilter=ff.and(Arrays.asList(f1,f2));
if(filter==null){filter=localFilter;
else{filter=ff.and(filter,localFilter);
if(readerinstanceofStructuredGridCoverage2DReader){structuredReader=(StructuredGridCoverage2DReader)reader;
else{//TODO:onlystructuredGridCoverage2DReadersarecurrentlysupported.thrownewUnsupportedOperationException("OnlystructuredGridCoverage2DReadersarecurrentlysupported");
if(accessor==null){returndimensions;
if(timeD!=null){dimensions.add(timeD);
if(elevationD!=null){dimensions.add(elevationD);
if(descriptor==null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("UnabletofindavaliddescriptorforthespecifieddimensionID:"+dimensionID+"forthespecifiedcoverage"+coverageName+"\nReturningnoDimensionBean");
if(info!=null){units=info.getUnits();symbol=info.getUnitSymbol();
if(units==null){units=descriptor.getUnits();
if(symbol==null){symbol=descriptor.getUnitSymbol();
switch(dimensionType){caseTIME:value=coverageRequest.getTemporalSubset();break;caseELEVATION:value=coverageRequest.getElevationSubset();break;caseCUSTOM:Map<String,List<Object>>dimensionsSubset=coverageRequest.getDimensionsSubset();List<Object>elements=dimensionsSubset==null?null:dimensionsSubset.get(coverageDimension.getName().toUpperCase());
if(elements==null){thrownewIllegalArgumentException("Nodimensionsubsethasbeenfound");
if(elements.size()>1){thrownewUnsupportedOperationException("Multipleelementsinadditionaldimensionsarenotsupportedonsplittedrequests");
if(!(layerinstanceofStyleLayer)){continue;
ifthecopyisemptyorwedon'thavevectortransformations,skipit
if(copy.featureTypeStyles().isEmpty()||(styleVisitor.hasTransformations()&&!styleVisitor.hasVectorTransformations())){continue;
if(layerinstanceofRasterLayer&&!styleVisitor.hasVectorTransformations()){continue;
if(layerinstanceofFeatureLayer){//copymakingsureweretainallattributesFeatureLayerfl=newFeatureLayer(newUTFGridFeatureSource(layer.getFeatureSource(),null),copy);fl.setQuery(layer.getQuery());sl=fl;
else
if(layerinstanceofGridCoverageLayer){GridCoverageLayergc=(GridCoverageLayer)sl;sl=newGridCoverageLayer(gc.getCoverage(),copy);
else
if(layerinstanceofWMSLayer){//thesearepureraster,wecannotdoaUTFGridoutofthem...although//wecouldtryacascading
iftheremoteserveralsosupportsUTFGrid,//inthefuturecontinue;
else
if(layerinstanceofCachedGridReaderLayer){CachedGridReaderLayergr=(CachedGridReaderLayer)sl;sl=newCachedGridReaderLayer(gr.getReader(),copy);
else
if(layerinstanceofGridReaderLayer){GridReaderLayergr=(GridReaderLayer)sl;sl=newGridReaderLayer(gr.getReader(),copy);
else{LOGGER.log(Level.WARNING,"Skippingunknownlayer"+sl+"oftype"+sl.getClass());continue;
if(pinstanceofLayerInfo){
if(EoLayerType.BAND_COVERAGE.name().equals(((LayerInfo)p).getMetadata().get(EoLayerType.KEY))){layer=(LayerInfo)p;layerStyle=group.getStyles().get(pos);
if(layer.getResource().getStore().getWorkspace()!=null){pp.add(ResourceConfigurationPage.WORKSPACE,layer.getResource().getStore().getWorkspace().getName());
if(s.getWorkspace()==null){globalStyles.add(s);
if(workspace!=null){styles.addAll(GeoServerApplication.get().getCatalog().getStylesByWorkspace(workspace));
if(!this.allowed){Requestrequest=Dispatcher.REQUEST.get();//IfinHIDEmodestayhiddenCatalogModemode=getMode();
if(mode==CatalogMode.MIXED){//InMIXEDmodetheprocessstayhidden
if(request!=null&&"GetCapabilities".equalsIgnoreCase(request.getRequest())){//Andthrowunauthorizedaccessinothercase
else{throwunauthorizedAccess(resource);
else
if(mode==CatalogMode.CHALLENGE){//InCHALLENGEmodetheprocessisalwaysvisiblethis.allowed=true;//ButthrowunauthorizedaccessinExecuteandDescriberequest
if(request!=null&&!"GetCapabilities".equalsIgnoreCase(request.getRequest())&&("Execute".equalsIgnoreCase(request.getRequest())||"DescribeProcess".equalsIgnoreCase(request.getRequest()))){throwunauthorizedAccess(resource);
if(user==null||user.getAuthorities().size()==0)returnnewInsufficientAuthenticationException("Cannotaccess"+resourceName+"asanonymous");
elsereturnnewAccessDeniedException("Cannotaccess"+resourceName+"withthecurrentprivileges");}}
if(autocompleteValue==null){autocompleteValue=DEFAULT_AUTOCOMPLETE_VALUE;
if(policy.getLimits()==null){returnft;
else
if(policy.getLimits()instanceofVectorAccessLimits){VectorAccessLimitsval=(VectorAccessLimits)policy.getLimits();//getwhatwecanactuallyread(anditmakesiteasiertodealwithpropertynames)Queryquery=val.getReadQuery();//dowehaveanyattributefiltering?
if(query.getPropertyNames()==Query.ALL_NAMES){returnft;
if(ftinstanceofSimpleFeatureType){SimpleFeatureTypesft=(SimpleFeatureType)ft;Set<String>properties=newHashSet<String>(Arrays.asList(query.getPropertyNames()));SimpleFeatureTypeBuildertb=newSimpleFeatureTypeBuilder();tb.init(sft);for(AttributeDescriptorat:sft.getAttributeDescriptors()){StringattName=at.getLocalName();
if(!properties.contains(attName)){tb.remove(attName);
else{//
ifit'sacomplextype,wedon'thaveatypebuilderonallbranches,so//we'llrunanemptyqueryinsteadquery.setFilter(Filter.EXCLUDE);FeatureSourcefs=getFeatureSource(null,null);FeatureCollectionfc=fs.getFeatures(query);returnfc.getSchema();
else{thrownewIllegalArgumentException("SecureFeatureSourceshasbeenfed"+"withunexpectedAccessLimitsclass"+policy.getLimits().getClass());
if(policy.level==AccessLevel.METADATA){throwSecureCatalogImpl.unauthorizedAccess(this.getName());
else{return(FeatureSource)SecuredObjects.secure(fs,policy);
ifrequiredsettingsmissing@TestpublicvoidtestNoMetadataUrl()throwsException{finalServiceInfoserviceInfo=getGeoServer().getService(WCSInfo.class);finalMetadataMapmetadata=serviceInfo.getMetadata();clearInspireMetadata(metadata);metadata.put(CREATE_EXTENDED_CAPABILITIES.key,true);metadata.put(SERVICE_METADATA_TYPE.key,"application/vnd.iso.19139+xml");metadata.put(LANGUAGE.key,"fre");metadata.put(SPATIAL_DATASET_IDENTIFIER_TYPE.key,"one,http://www.geoserver.org/one;two,http://www.geoserver.org/two,http://metadata.geoserver.org/id?two");getGeoServer().save(serviceInfo);finalDocumentdom=getAsDOM(WCS_2_0_0_GETCAPREQUEST);finalNodeListnodeList=dom.getElementsByTagNameNS(DLS_NAMESPACE,"ExtendedCapabilities");assertEquals("NumberofINSPIREExtendedCapabilitieselements",0,nodeList.getLength());
iftheotherrequiredsettingsexistanddon't
iftheydon't@TestpublicvoidtestCreateExtCapMissingWithRequiredSettings()throwsException{finalServiceInfoserviceInfo=getGeoServer().getService(WCSInfo.class);finalMetadataMapmetadata=serviceInfo.getMetadata();clearInspireMetadata(metadata);metadata.put(SERVICE_METADATA_URL.key,"http://foo.com?bar=baz");metadata.put(SERVICE_METADATA_TYPE.key,"application/vnd.iso.19139+xml");metadata.put(LANGUAGE.key,"fre");metadata.put(SPATIAL_DATASET_IDENTIFIER_TYPE.key,"one,http://www.geoserver.org/one");getGeoServer().save(serviceInfo);finalDocumentdom=getAsDOM(WCS_2_0_0_GETCAPREQUEST);NodeListnodeList=dom.getElementsByTagNameNS(DLS_NAMESPACE,"ExtendedCapabilities");assertEquals("NumberofINSPIREExtendedCapabilitieselements",1,nodeList.getLength());
ifnone.*/protectedURLgetDefinitionsURL(){Stringcust_proj_file=System.getProperty(SYSTEM_DEFAULT_USER_PROJ_FILE);
if(cust_proj_file==null){GeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);
if(loader!=null){//NotavailableforSystemTestDataResourcecustom_proj=loader.get("user_projections/epsg_overrides.properties");
if(custom_proj.getType()==Type.RESOURCE){cust_proj_file=custom_proj.file().getAbsolutePath();
if(cust_proj_file!=null){Fileproj_file=newFile(cust_proj_file);
if(proj_file.exists()){URLurl=URLs.fileToUrl(proj_file);
if(url!=null){returnurl;
else{LOGGER.log(Level.SEVERE,"Hadtroublesconverting"+cust_proj_file+"toURL");
if(a==CatalogMode.HIDE||b==CatalogMode.HIDE){returnCatalogMode.HIDE;
else
if(a==CatalogMode.MIXED||b==CatalogMode.MIXED){returnCatalogMode.MIXED;
else
if(a==CatalogMode.CHALLENGE||b==CatalogMode.CHALLENGE){returnCatalogMode.CHALLENGE;
if(a==null)returnb;
if(b==null)returna;
if(ainstanceofVectorAccessLimits&&binstanceofVectorAccessLimits){returnintersection((VectorAccessLimits)a,(VectorAccessLimits)b);
else
if(ainstanceofCoverageAccessLimits&&binstanceofCoverageAccessLimits){returnintersection((CoverageAccessLimits)a,(CoverageAccessLimits)b);
else
if(ainstanceofWMSAccessLimits&&binstanceofWMSAccessLimits){returnintersection((WMSAccessLimits)a,(WMSAccessLimits)b);
if(a==null)returnb;
if(b==null)returna;CatalogModemode=intersection(a.getMode(),b.getMode());List<PropertyName>readAttributes=intersection(a.getReadAttributes(),b.getReadAttributes());FilterreadFilter=intersection(a.getReadFilter(),b.getReadFilter());List<PropertyName>writeAttributes=intersection(a.getReadAttributes(),b.getReadAttributes());FilterwriteFilter=intersection(a.getWriteFilter(),b.getWriteFilter());returnnewVectorAccessLimits(mode,readAttributes,readFilter,writeAttributes,writeFilter);
if(a==null)returnb;
if(b==null)returna;finalCatalogModemode=intersection(a.getMode(),b.getMode());finalMultiPolygonrasterFilter;{MultiPolygonaFilter=a.getRasterFilter(),bFilter=b.getRasterFilter();
if(aFilter==null)rasterFilter=bFilter;
else
if(bFilter==null)rasterFilter=aFilter;
else{Geometryintersection=aFilter.intersection(bFilter);
if(intersectioninstanceofMultiPolygon){rasterFilter=(MultiPolygon)intersection;
else{finalList<Polygon>accum=newArrayList<Polygon>();intersection.apply(newGeometryComponentFilter(){publicvoidfilter(Geometrygeom){
if(geominstanceofPolygon)accum.add((Polygon)geom);
if(rasterFilter!=null&&rasterFilter.getNumGeometries()==0){readFilter=Filter.EXCLUDE;
else{readFilter=intersection(a.getReadFilter(),b.getReadFilter());
if(a==null)returnb;
if(b==null)returna;CatalogModemode=intersection(a.getMode(),b.getMode());FilterreadFilter=intersection(a.getReadFilter(),b.getReadFilter());MultiPolygonrasterFilter=null;{MultiPolygonaFilter=a.getRasterFilter(),bFilter=b.getRasterFilter();
if(aFilter==null)rasterFilter=bFilter;
else
if(bFilter==null)rasterFilter=aFilter;
elserasterFilter=(MultiPolygon)aFilter.intersection(bFilter);
if(a==null)returnb;
if(b==null)returna;
if(a==Filter.INCLUDE&&b==Filter.INCLUDE){returnFilter.INCLUDE;
else
if(a==Filter.EXCLUDE||b==Filter.EXCLUDE){returnFilter.EXCLUDE;
else{returnfactory.and(a,b);
if(a==null)returnb;
if(b==null)returna;List<Integer>indices=newArrayList<Integer>(Math.min(a.length,b.length));List<GeneralParameterValue>bAsList=Arrays.asList(b);for(inti=0;i<a.length;i++){
if(bAsList.contains(a[i])){indices.add(i);
if(indices.size()==a.length){returna;
else{GeneralParameterValue[]results=newGeneralParameterValue[indices.size()];for(inti=0;i<indices.size();i++){results[i]=a[indices.get(i)];
if(a==null)returnb;
if(b==null)returna;List<PropertyName>results=newArrayList<PropertyName>();for(PropertyNamep:a){
if(b.contains(p)){results.add(p);
ifnonewasfound*/publicstaticfinalStringDEFAULT_SRS="EPSG:404000";/**thecatalog*/Catalogcatalog;/**thecurrentworkspace*/WorkspaceInfoworkspace;/**thecurrentstore*/StoreInfostore;publicCatalogBuilder(Catalogcatalog){this.catalog=catalog;
ifset,
elsethedefault*workspacefromthecatalog.*/voidbuildStore(StoreInfoinfo,Stringname){info.setName(name);info.setEnabled(true);//setworkspace,fallingbackondefault
ifnonespecified
if(workspace!=null){info.setWorkspace(workspace);
else{info.setWorkspace(catalog.getDefaultWorkspace());
if(store==null||!(storeinstanceofDataStoreInfo)){thrownewIllegalStateException("Datastorenotset.");
ifyouwanttoforcethemin(andspendtime*accordingly)**<p>Theresultingobjectisnotaddedtothecatalog,itmustbedonebythecallingcode*afterthefact.*/publicFeatureTypeInfobuildFeatureType(FeatureSourcefeatureSource){
if(store==null||!(storeinstanceofDataStoreInfo)){thrownewIllegalStateException("Datastorenotset.");
if(name==null){name=featureType.getName();
if(namespace==null){namespace=catalog.getDefaultNamespace();
if(crs==null&&featureType.getGeometryDescriptor()!=null){crs=featureType.getGeometryDescriptor().getCoordinateReferenceSystem();
ifthedatastoreitselfcanprovidesomemetadataforustry{setupMetadata(ftinfo,featureSource);
ifprejection*actuallyneedstobedone,andsyncitupwithsettingprojpolicyoncoveragelayers.*/publicvoidsetupProjectionPolicy(ResourceInforinfo){
if(rinfo.getSRS()!=null){rinfo.setProjectionPolicy(ProjectionPolicy.FORCE_DECLARED);
else{rinfo.setProjectionPolicy(ProjectionPolicy.NONE);
ifmissing,thenativebounds(warning,thismightbeveryexpensive,cases*inwhichthiscasetakeminutesarenotuncommon
ifthedatasetismadeofmillionof*features)*<li>updates,
ifpossible,thegeographicboundsaccordinglybyre-projectingthenative*boundsintoWGS84**@paramftinfo*@throwsIOException
ifcomputingthenativeboundsfailsor
ifatransformationerroroccurs*duringthegeographicboundscomputation*/publicvoidsetupBounds(ResourceInforinfo)throwsIOException{doSetupBounds(rinfo,null);
ifneeded
if(rinfo.getNativeBoundingBox()==null){ReferencedEnvelopebounds=getNativeBounds(rinfo,data);rinfo.setNativeBoundingBox(bounds);
ifmissingandwehaveenoughinforinfo.setLatLonBoundingBox(getLatLonBounds(rinfo.getNativeBoundingBox(),rinfo.getCRS()));
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Unabletogetresourceinfofromfeaturesource",ignore);
if(ftinfo.getTitle()==null){ftinfo.setTitle(rinfo!=null?rinfo.getTitle():ftinfo.getName());
if(rinfo!=null&&ftinfo.getDescription()==null){ftinfo.setDescription(rinfo.getDescription());
if(rinfo!=null&&(ftinfo.getKeywords()==null||ftinfo.getKeywords().isEmpty())){
if(rinfo.getKeywords()!=null){
if(ftinfo.getKeywords()==null){((FeatureTypeInfoImpl)ftinfo).setKeywords(newArrayList());
if(kw==null||"".equals(kw.trim())){LOGGER.fine("Emptykeywordignored");continue;
ifthenativeboundsarenotavailable*@throwsIOException*/publicReferencedEnvelopegetLatLonBounds(ReferencedEnvelopenativeBounds,CoordinateReferenceSystemdeclaredCRS)throwsIOException{
if(nativeBounds!=null&&declaredCRS!=null){//makesureweusethedeclaredCRS,notthenativeone,themaydiffer
if(!CRS.equalsIgnoreMetadata(DefaultGeographicCRS.WGS84,declaredCRS)){//transformtry{ReferencedEnvelopebounds=newReferencedEnvelope(nativeBounds,CRS.getHorizontalCRS(declaredCRS));returnbounds.transform(DefaultGeographicCRS.WGS84,true);
else{returnnewReferencedEnvelope(nativeBounds,DefaultGeographicCRS.WGS84);
ifthecouldnotbecomputed*@throwsIOException*/publicReferencedEnvelopegetNativeBounds(ResourceInforinfo)throwsIOException{returngetNativeBounds(rinfo,null);
if(rinfoinstanceofFeatureTypeInfo){FeatureTypeInfoftinfo=(FeatureTypeInfo)rinfo;//bounds
if(datainstanceofFeatureSource){bounds=((FeatureSource)data).getBounds();
else{bounds=ftinfo.getFeatureSource(null,null).getBounds();
ifnecessary,somedatastoresdo//notbuildaproperreferencedenvelopeCoordinateReferenceSystemcrs=ftinfo.getNativeCRS();
if(bounds!=null&&bounds.getCoordinateReferenceSystem()==null&&crs!=null){bounds=newReferencedEnvelope(bounds,crs);
if(bounds!=null){//expansionfactor
iftheboundsareemptyoronedimensionaldoubleexpandBy=1;//1meter
if(bounds.getCoordinateReferenceSystem()instanceofGeographicCRS){expandBy=0.0001;
if(bounds.getWidth()==0||bounds.getHeight()==0){bounds.expandBy(expandBy);
else
if(rinfoinstanceofCoverageInfo){//thecoverageboundscomputationpathisabitmorelinear,the//readersalwaysreturntheboundsandintheproperCRS(afaik)CoverageInfocinfo=(CoverageInfo)rinfo;GridCoverage2DReaderreader=null;
if(datainstanceofGridCoverage2DReader){reader=(GridCoverage2DReader)data;
else{reader=(GridCoverage2DReader)cinfo.getGridCoverageReader(null,GeoTools.getDefaultHints());
else
if(rinfoinstanceofWMSLayerInfo){//thelogictocomputethenativeboundsisprettyconvoluted,//let'srebuildthelayerinfoWMSLayerInforebuilt=buildWMSLayer(rinfo.getStore(),rinfo.getNativeName());bounds=rebuilt.getNativeBoundingBox();
else
if(rinfoinstanceofWMTSLayerInfo){//thelogictocomputethenativeboundsisprettyconvoluted,//let'srebuildthelayerinfoWMTSLayerInforebuilt=buildWMTSLayer(rinfo.getStore(),rinfo.getNativeName());bounds=rebuilt.getNativeBoundingBox();
ifneedbe
if(rinfo.getProjectionPolicy()==ProjectionPolicy.REPROJECT_TO_DECLARED&&bounds!=null){try{bounds=bounds.transform(rinfo.getCRS(),true);
iftrueanextenstivelookupwillbeperformed(moreaccurate,butmight*takevariousseconds)*@throwsIOException*/publicvoidlookupSRS(FeatureTypeInfoftinfo,booleanextensive)throwsIOException{lookupSRS(ftinfo,null,extensive);
iftrueanextenstivelookupwillbeperformed(moreaccurate,butmight*takevariousseconds)*@throwsIOException*/publicvoidlookupSRS(FeatureTypeInfoftinfo,FeatureSourcedata,booleanextensive)throwsIOException{CoordinateReferenceSystemcrs=ftinfo.getNativeCRS();
if(crs==null){
if(data!=null){crs=data.getSchema().getCoordinateReferenceSystem();
else{crs=ftinfo.getFeatureType().getCoordinateReferenceSystem();
if(crs!=null){try{Integercode=CRS.lookupEpsgCode(crs,extensive);
if(code!=null)ftinfo.setSRS("EPSG:"+code);
else{ftinfo.setSRS(DEFAULT_SRS);
if(resInfo.getNativeName()==null&&resInfo.getName()!=null){resInfo.setNativeName(resInfo.getName());
if(resInfo.getNativeName()!=null&&resInfo.getName()==null){resInfo.setName(resInfo.getNativeName());
if(featureType.getCatalog()==null){featureType.setCatalog(catalog);
ifmissing
if(featureType.getSRS()==null){lookupSRS(featureType,true);
if(featureType.getProjectionPolicy()==null){setupProjectionPolicy(featureType);
if(featureType.getLatLonBoundingBox()==null&&featureType.getNativeBoundingBox()==null){//bothmissing,wecomputethemsetupBounds(featureType);
else
if(featureType.getLatLonBoundingBox()==null){//nativeavailablebutgeographictobecomputedsetupBounds(featureType);
else
if(featureType.getNativeBoundingBox()==null&&crs!=null){//weknowthegeographicandwecanreprojectbacktonativeReferencedEnvelopeboundsLatLon=featureType.getLatLonBoundingBox();featureType.setNativeBoundingBox(boundsLatLon.transform(crs,true));
ifmissing
if(wmsLayer.getSRS()==null){wmsLayer.setSRS(full.getSRS());
if(wmsLayer.getNativeCRS()==null){wmsLayer.setNativeCRS(full.getNativeCRS());
if(wmsLayer.getProjectionPolicy()==null){wmsLayer.setProjectionPolicy(full.getProjectionPolicy());
if(wmsLayer.getLatLonBoundingBox()==null&&wmsLayer.getNativeBoundingBox()==null){//bothmissing,wecopythemwmsLayer.setLatLonBoundingBox(full.getLatLonBoundingBox());wmsLayer.setNativeBoundingBox(full.getNativeBoundingBox());
else
if(wmsLayer.getLatLonBoundingBox()==null){//nativeavailablebutgeographictobecomputedsetupBounds(wmsLayer);
else
if(wmsLayer.getNativeBoundingBox()==null&&wmsLayer.getNativeCRS()!=null){//weknowthegeographicandwecanreprojectbacktonativeReferencedEnvelopeboundsLatLon=wmsLayer.getLatLonBoundingBox();wmsLayer.setNativeBoundingBox(boundsLatLon.transform(wmsLayer.getNativeCRS(),true));
if(wmsLayer.getTitle()==null){wmsLayer.setTitle(full.getTitle());
if(wmsLayer.getDescription()==null){wmsLayer.setDescription(full.getDescription());
if(wmsLayer.getAbstract()==null){wmsLayer.setAbstract(full.getAbstract());
if(wmsLayer.getKeywords().isEmpty()){wmsLayer.getKeywords().addAll(full.getKeywords());
ifmissing
if(layer.getSRS()==null){layer.setSRS(full.getSRS());
if(layer.getNativeCRS()==null){layer.setNativeCRS(full.getNativeCRS());
if(layer.getProjectionPolicy()==null){layer.setProjectionPolicy(full.getProjectionPolicy());
if(layer.getLatLonBoundingBox()==null&&layer.getNativeBoundingBox()==null){//bothmissing,wecopythemlayer.setLatLonBoundingBox(full.getLatLonBoundingBox());layer.setNativeBoundingBox(full.getNativeBoundingBox());
else
if(layer.getLatLonBoundingBox()==null){//nativeavailablebutgeographictobecomputedsetupBounds(layer);
else
if(layer.getNativeBoundingBox()==null&&layer.getNativeCRS()!=null){//weknowthegeographicandwecanreprojectbacktonativeReferencedEnvelopeboundsLatLon=layer.getLatLonBoundingBox();layer.setNativeBoundingBox(boundsLatLon.transform(layer.getNativeCRS(),true));
if(layer.getTitle()==null){layer.setTitle(full.getTitle());
if(layer.getDescription()==null){layer.setDescription(full.getDescription());
if(layer.getAbstract()==null){layer.setAbstract(full.getAbstract());
if(layer.getKeywords().isEmpty()){layer.getKeywords().addAll(full.getKeywords());
if(coverageName!=null){reader=SingleGridCoverage2DReader.wrap(reader,coverageName);
if(reader==null)thrownewException("Unabletoacquireareaderforthiscoveragewithformat:"+csinfo.getFormat().getName());
if(cinfo.getNativeCRS()==null){cinfo.setNativeCRS(reader.getCoordinateReferenceSystem());
if(cinfo.getSRS()==null){cinfo.setSRS(nativeCRS.getIdentifiers().toArray()[0].toString());
if(cinfo.getProjectionPolicy()==null){
if(nativeCRS!=null&&!nativeCRS.getIdentifiers().isEmpty()){cinfo.setProjectionPolicy(ProjectionPolicy.REPROJECT_TO_DECLARED);
if(nativeCRS==null){cinfo.setProjectionPolicy(ProjectionPolicy.FORCE_DECLARED);
if(cinfo.getLatLonBoundingBox()==null&&cinfo.getNativeBoundingBox()==null){GeneralEnvelopeenvelope=reader.getOriginalEnvelope();cinfo.setNativeBoundingBox(newReferencedEnvelope(envelope));cinfo.setLatLonBoundingBox(newReferencedEnvelope(CoverageStoreUtils.getWGS84LonLatEnvelope(envelope)));
else
if(cinfo.getLatLonBoundingBox()==null){setupBounds(cinfo);
else
if(cinfo.getNativeBoundingBox()==null&&cinfo.getNativeCRS()!=null){ReferencedEnvelopeboundsLatLon=cinfo.getLatLonBoundingBox();cinfo.setNativeBoundingBox(boundsLatLon.transform(cinfo.getNativeCRS(),true));
if(cinfo.getGrid()==null){GridEnvelopeoriginalRange=reader.getOriginalGridRange();cinfo.setGrid(newGridGeometry2D(originalRange,reader.getOriginalGridToWorld(PixelInCell.CELL_CENTER),nativeCRS));
if(store==null||!(storeinstanceofCoverageStoreInfo)){thrownewIllegalStateException("Coveragestorenotset.");
if(reader==null)thrownewException("Unabletoacquireareaderforthiscoveragewithformat:"+csinfo.getFormat().getName());returnbuildCoverage(reader,coverageName,null);
ifthecoveragestorewasnotfoundorcouldnotberead,or
ifthe*coveragecouldnotbecreated.*/publicCoverageInfobuildCoverageByName(StringnativeCoverageName,StringspecifiedName)throwsException{
if(store==null||!(storeinstanceofCoverageStoreInfo)){thrownewIllegalStateException("Coveragestorenotset.");
if(reader==null)thrownewException("Unabletoacquireareaderforthiscoveragewithformat:"+csinfo.getFormat().getName());returnbuildCoverageInternal(reader,nativeCoverageName,null,specifiedName);
if(store==null||!(storeinstanceofCoverageStoreInfo)){thrownewIllegalStateException("Coveragestorenotset.");
ifwearedealingwithamulticoveragereader,wraptosimplifycode
if(nativeCoverageName!=null){reader=SingleGridCoverage2DReader.wrap(reader,nativeCoverageName);
if(namespace==null){namespace=catalog.getDefaultNamespace();
ifthenativesrsisset,//force
ifmissing
if(nativeCRS!=null){try{Integercode=CRS.lookupEpsgCode(nativeCRS,false);
if(code!=null){cinfo.setSRS("EPSG:"+code);cinfo.setProjectionPolicy(ProjectionPolicy.REPROJECT_TO_DECLARED);
if(nativeCRS==null){cinfo.setProjectionPolicy(ProjectionPolicy.FORCE_DECLARED);
ifit'samosaic,limitthenumberoftileswe'regoingtoreadtoone//(withtimeandelevationtheremightbehundredsofsuperimposedtiles)//-readingtheGridCoveragesubset/////////////////////////////////////////////////////////////////////////Formatformat=csinfo.getFormat();finalParameterValueGroupreadParams=format.getReadParameters();GridSampleDimension[]sampleDimensions=getCoverageSampleDimensions(reader,customParameters);List<CoverageDimensionInfo>coverageDimensions=getCoverageDimensions(sampleDimensions);cinfo.getDimensions().addAll(coverageDimensions);
if(specifiedName!=null){cinfo.setName(specifiedName);cinfo.setTitle(specifiedName);cinfo.getKeywords().add(newKeyword(specifiedName));
else{Stringname=reader.getGridCoverageNames()[0];cinfo.setName(name);cinfo.setTitle(name);cinfo.getKeywords().add(newKeyword(name));
if((nativeCRS.getIdentifiers()!=null)&&!nativeCRS.getIdentifiers().isEmpty()){cinfo.getRequestSRS().add(((Identifier)nativeCRS.getIdentifiers().toArray()[0]).toString());cinfo.getResponseSRS().add(((Identifier)nativeCRS.getIdentifiers().toArray()[0]).toString());
if(fName.equalsIgnoreCase("WorldImage")){//TODOcheck
ifcoveragecanencodeFormatcinfo.getSupportedFormats().add("GIF");cinfo.getSupportedFormats().add("PNG");cinfo.getSupportedFormats().add("JPEG");cinfo.getSupportedFormats().add("TIFF");
else
if(fName.toLowerCase().startsWith("geotiff")){//TODOcheck
ifcoveragecanencodeFormatcinfo.getSupportedFormats().add("GEOTIFF");
else{//TODOcheck
ifcoveragecanencodeFormatcinfo.getSupportedFormats().add(fName);
if(customParameters!=null){parameters.putAll(customParameters);
if(parameters.keySet().contains(maxAllowedTiles)){parameters.put(maxAllowedTiles,1);
if(parameters.keySet().contains(useJaiImageRead)){parameters.put(useJaiImageRead,false);
if(gc!=null){//removereadgridgeometrysinceitisrequestspecificparameters.remove(AbstractGridFormat.READ_GRIDGEOMETRY2D.getName().toString());sampleDimensions=gc.getSampleDimensions();///disposecoveragegc.dispose(true);
if(gc.getRenderedImage()instanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)gc.getRenderedImage());
else{finalImageLayoutimageLayout=reader.getImageLayout();
if(imageLayout==null){thrownewException("Unabletoacquiretestcoverageandimagelayoutforformat:"+format.getName());
if(cm==null){thrownewException("Unabletoacquiretestcoverageandcolormodelforformat:"+format.getName());
if(cm==null){thrownewException("Unabletoacquiretestcoverageandsamplemodelforformat:"+format.getName());
if(colorInterpretation==null)thrownewIOException("Unrecognizedsampledimensiontypeforbandnumber"+(i+1));sampleDimensions[i]=newGridSampleDimension(colorInterpretation.name());
if(uom!=null){label.append("(".intern());parseUOM(label,uom);label.append(")".intern());dim.setUnit(uom.toString());
else
if(uName.startsWith("RED")||uName.startsWith("GREEN")||uName.startsWith("BLUE")){//radianceinSIdim.setUnit("W.m-2.Sr-1");
switchtousethe//sampleDimension'sminandmaxasDimension'sRange//insteadofthewholeSampleDimensionRange//(thelattermayincludenodatacategories).dim.setRange(NumberRange.create(sdMin,sdMax));finalList<Category>categories=sd.getCategories();
if(categories!=null){for(Categorycat:categories){
if((cat!=null)&&cat.getName().toString(Locale.ENGLISH).equalsIgnoreCase("nodata")){doublemin=cat.getRange().getMinimum();doublemax=cat.getRange().getMaximum();dim.getNullValues().add(min);
if(min!=max){dim.getNullValues().add(max);
if(store==null||!(storeinstanceofWMSStoreInfo)){thrownewIllegalStateException("WMSstorenotset.");
if(namespace==null){namespace=catalog.getDefaultNamespace();
ifweusegetSRS()we'llgetthemallfor(Stringsrs:layer.getBoundingBoxes().keySet()){try{CoordinateReferenceSystemcrs=CRS.decode(srs);wli.setSRS(srs);wli.setNativeCRS(crs);
ifnecessary,andhandlewellknownWMSCRScodesStringsrs=wli.getSRS();try{
if(srs==null||srs.equals("CRS:84")){wli.setSRS("EPSG:4326");srs="EPSG:4326";wli.setNativeCRS(CRS.decode("EPSG:4326"));
else
if(srs.equals("CRS:83")){wli.setSRS("EPSG:4269");srs="EPSG:4269";wli.setNativeCRS(CRS.decode("EPSG:4269"));
else
if(srs.equals("CRS:27")){wli.setSRS("EPSG:4267");srs="EPSG:4267";wli.setNativeCRS(CRS.decode("EPSG:4267"));
if(envelope!=null){ReferencedEnvelopere=newReferencedEnvelope(envelope.getMinimum(0),envelope.getMaximum(0),envelope.getMinimum(1),envelope.getMaximum(1),wli.getNativeCRS());wli.setNativeBoundingBox(re);
if(llbbox!=null){ReferencedEnvelopere=newReferencedEnvelope(llbbox.getMinX(),llbbox.getMaxX(),llbbox.getMinY(),llbbox.getMaxY(),DefaultGeographicCRS.WGS84);wli.setLatLonBoundingBox(re);
else
if(wli.getNativeBoundingBox()!=null){try{wli.setLatLonBoundingBox(wli.getNativeBoundingBox().transform(DefaultGeographicCRS.WGS84,true));
if(layer.getKeywords()!=null){for(Stringkw:layer.getKeywords()){
if(kw!=null){wli.getKeywords().add(newKeyword(kw));
ifwe'recascadingfromaserverthatdoesaddthemStringpublished=wli.getName();
if(published.contains(":")){wli.setName(published.substring(published.lastIndexOf(':')+1));
if(store==null||!(storeinstanceofWMTSStoreInfo)){thrownewIllegalStateException("WMTSstorenotset.");
if(namespace==null){namespace=catalog.getDefaultNamespace();
ifweusegetSRS()we'llgetthemallfor(Stringsrs:layer.getBoundingBoxes().keySet()){try{CoordinateReferenceSystemcrs=CRS.decode(srs);wli.setSRS(srs);wli.setNativeCRS(crs);
ifnecessary,andhandlewellknownWMSCRScodesStringsrs=wli.getSRS();try{
if(srs==null||srs.equals("CRS:84")){wli.setSRS("EPSG:4326");srs="EPSG:4326";wli.setNativeCRS(CRS.decode("EPSG:4326"));
else
if(srs.equals("CRS:83")){wli.setSRS("EPSG:4269");srs="EPSG:4269";wli.setNativeCRS(CRS.decode("EPSG:4269"));
else
if(srs.equals("CRS:27")){wli.setSRS("EPSG:4267");srs="EPSG:4267";wli.setNativeCRS(CRS.decode("EPSG:4267"));
if(envelope!=null){ReferencedEnvelopere=newReferencedEnvelope(envelope.getMinimum(0),envelope.getMaximum(0),envelope.getMinimum(1),envelope.getMaximum(1),wli.getNativeCRS());wli.setNativeBoundingBox(re);
if(llbbox!=null){ReferencedEnvelopere=newReferencedEnvelope(llbbox.getMinX(),llbbox.getMaxX(),llbbox.getMinY(),llbbox.getMaxY(),DefaultGeographicCRS.WGS84);wli.setLatLonBoundingBox(re);
else
if(wli.getNativeBoundingBox()!=null){try{wli.setLatLonBoundingBox(wli.getNativeBoundingBox().transform(DefaultGeographicCRS.WGS84,true));
if(layer.getKeywords()!=null){for(Stringkw:layer.getKeywords()){
if(kw!=null){wli.getKeywords().add(newKeyword(kw));
ifwe'recascadingfromaserverthatdoesaddthemStringpublished=wli.getName();
if(published.contains(":")){wli.setName(published.substring(published.lastIndexOf(':')+1));
if(version.compareTo(newVersion("1.3.0"))<0){//aah,sheersimplicityreturnfalse;
else{//gah,hellgatesbreakingloose
if(srsName.startsWith("EPSG:")){try{StringepsgNative="urn:x-ogc:def:crs:EPSG:".concat(srsName.substring(5));returnCRS.getAxisOrder(CRS.decode(epsgNative))==AxisOrder.NORTH_EAST;
else{//CRSorAUTO,noneofthemisflippedsofarreturnfalse;
ifthelayerisvectorand*geometryless**@paramresource*@throwsIOException*/publicStyleInfogetDefaultStyle(ResourceInforesource)throwsIOException{//rasterwise,onlyonestyle
if(resourceinstanceofCoverageInfo||resourceinstanceofWMSLayerInfo||resourceinstanceofWMTSLayerInfo)returncatalog.getStyleByName(StyleInfo.DEFAULT_RASTER);//forvectorswedependonthethenatureofthedefaultgeometryStringstyleName;FeatureTypeInfofeatureType=(FeatureTypeInfo)resource;
if(featureType.getFeatureType()==null){returnnull;
if(gd==null){returnnull;
if(Point.class.isAssignableFrom(gtype)||MultiPoint.class.isAssignableFrom(gtype)){styleName=StyleInfo.DEFAULT_POINT;
else
if(LineString.class.isAssignableFrom(gtype)||MultiLineString.class.isAssignableFrom(gtype)){styleName=StyleInfo.DEFAULT_LINE;
else
if(Polygon.class.isAssignableFrom(gtype)||MultiPolygon.class.isAssignableFrom(gtype)){styleName=StyleInfo.DEFAULT_POLYGON;
else
if(Point.class.isAssignableFrom(gtype)||MultiPoint.class.isAssignableFrom(gtype)){styleName=StyleInfo.DEFAULT_POINT;
else{//fallbacktothegenericstylestyleName=StyleInfo.DEFAULT_GENERIC;
if(layer.getResource()instanceofFeatureTypeInfo){layer.setType(PublishedType.VECTOR);
else
if(layer.getResource()instanceofCoverageInfo){layer.setType(PublishedType.RASTER);
else
if(layer.getResource()instanceofWMTSLayerInfo){layer.setType(PublishedType.WMTS);
else
if(layer.getResource()instanceofWMSLayerInfo){layer.setType(PublishedType.WMS);
if(recursive){workspace.accept(newCascadeDeleteVisitor(catalog));
else{catalog.remove(workspace);
if(recursive){store.accept(newCascadeDeleteVisitor(catalog));
else{catalog.remove(store);
if(recursive){resource.accept(newCascadeDeleteVisitor(catalog));
else{catalog.remove(resource);
if(groupInfo.getRootLayer()!=null){attach(groupInfo.getRootLayer());
if(groupInfo.getRootLayerStyle()!=null){attach(groupInfo.getRootLayerStyle());
if(pinstanceofLayerInfo){attach((LayerInfo)p);
else{attach((LayerGroupInfo)p);
if(style!=null)attach(style);
if(length>0){att.setLength(length);
ifthereisnoboundingboxassociatedwiththe*CRS*/publicReferencedEnvelopegetBoundsFromCRS(ResourceInforesource){ReferencedEnvelopecrsReferencedEnvelope=null;ProjectionPolicyprojPolicy=resource.getProjectionPolicy();CoordinateReferenceSystemcrs=null;//findtherightcrstousebasedontheprojectionpolicy
if(projPolicy==ProjectionPolicy.NONE){crs=resource.getNativeCRS();
else{crs=resource.getCRS();
if(crs!=null){EnvelopecrsEnvelope=CRS.getEnvelope(crs);
if(crsEnvelope!=null){crsReferencedEnvelope=newReferencedEnvelope(crsEnvelope);
if(!features.isEmpty()){for(Iteratorf=features.iterator();f.hasNext();){SimpleFeaturefeature=(SimpleFeature)f.next();Stringname=feature.getFeatureType().getTypeName();StringnamespaceURI=feature.getFeatureType().getName().getNamespaceURI();typeNames.add(newQName(namespaceURI,name));
if(!getInfo().getServiceLevel().getOps().contains(WFSInfo.Operation.TRANSACTION_REPLACE)){thrownewWFSException(element,"TransactionREPLACEsupportisnotenabled");
if(featureTypeInfos.size()!=1){thrownewWFSException(element,"TransactionREPLACEmustonlyspecifyfeaturesfroma"+"singlefeaturetype");
if(featureStore==null){thrownewWFSException(element,"Couldnotobtainfeaturestore");
if(newFeatures.size()!=features.size()){thrownewWFSException(element,String.format("Specifiedfiltermatched%dfeaturesbut"+"%dweresupplied",features.size(),newFeatures.size()));
ifthestoreismakingfeatureid'swritableandattempt//toactuallyupdatetheID's//loadalltheexistingfeaturesintomemoryMap<String,SimpleFeature>oldFeatures=newLinkedHashMap<String,SimpleFeature>();SimpleFeatureIteratorit=features.features();try{while(it.hasNext()){SimpleFeaturef=it.next();oldFeatures.put(f.getID(),f);
if(oldFeature==null){leftovers.add(newFeature);continue;
if(secMgr.checkAuthenticationForAdminRole()&&DiskQuotaWarningPanel.getException()!=null){returnnewDiskQuotaWarningPanel(id);
else{returnnull;
if(gaConfig==null){gaConfig=newXMLRoleServiceConfig();gaConfig.setName(serviceName);
if(fail)Assert.fail(failMessage);//releaselockstore1.load();//getlockstore2.addRole(role_test1);fail=true;try{store1.clear();
if(fail)Assert.fail(failMessage);//releaselockstore2.store();store1.clear();store1.store();////endofpartone,nowcheckallmodifyingmethods//obtainalockstore1.addRole(role_test1);fail=true;try{store2.associateRoleToGroup(role_test2,"agroup");
if(fail)Assert.fail(failMessage);fail=true;try{store2.associateRoleToUser(role_test2,"auser");
if(fail)Assert.fail(failMessage);fail=true;try{store2.updateRole(role_test2);
if(fail)Assert.fail(failMessage);fail=true;try{store2.clear();
if(fail)Assert.fail(failMessage);fail=true;try{store2.setParentRole(role_test1,null);
if(fail)Assert.fail(failMessage);
if(listener.notified==0){listener.wait();//wait4seconds
if(!transform.isIdentity()){addTransform(root,transform);
if(transform.isIdentity()){return;
if(topology.getScreenToWorldTransform().isIdentity()){jsonArc=TopoJSONEncoder.serialize(arc.getCoordinateSequence());
else{jsonArc=TopoJSONEncoder.quantize(arc.getCoordinateSequence(),arc.getFactory().getPrecisionModel());
if(geom.getId()!=null){target.addProperty("id",geom.getId());
if(properties!=null){target.add("properties",properties);
if(properties.isEmpty()){returnnull;
if(valueinstanceofMap){jsonValue=properties((Map<String,Object>)value);
else
if(valueinstanceofBoolean){jsonValue=newJsonPrimitive((Boolean)value);
else
if(valueinstanceofNumber){Numbern=(Number)value;
if(ninstanceofDouble&&n.doubleValue()%1==0){n=Long.valueOf(n.longValue());
else
if(ninstanceofFloat&&n.floatValue()%1==0){n=Integer.valueOf(n.intValue());
else{jsonValue=newJsonPrimitive(String.valueOf(value));
if(size>0){Coordinatebuff=newCoordinate();coords.getCoordinate(0,buff);addCoordinate(arc,buff);//firstcoordinateas-isfor(inti=0;i<size;i++){//subsequentcoordinatesdeltaencodedcoords.getCoordinate(i,buff);addCoordinate(arc,buff);
if(size>0){Coordinatebuff=newCoordinate();coords.getCoordinate(0,buff);precisionModel.makePrecise(buff);addCoordinate(arc,buff);//firstcoordinateas-isdoublelastX;doublelastY;lastX=buff.x;lastY=buff.y;for(inti=1;i<size;i++){//subsequentcoordinatesdeltaencodedcoords.getCoordinate(i,buff);precisionModel.makePrecise(buff);doubledeltaX=buff.x-lastX;doubledeltaY=buff.y-lastY;lastX=buff.x;lastY=buff.y;buff.x=deltaX;buff.y=deltaY;precisionModel.makePrecise(buff);
if(buff.x==0d&&buff.y==0d){continue;
if(x%1==0){X=Integer.valueOf((int)x);
else{X=newDouble(x);
if(y%1==0){Y=Integer.valueOf((int)y);
else{Y=newDouble(y);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;InfoIdentityother=(InfoIdentity)obj;
if(clazz==null){
if(other.clazz!=null)returnfalse;
else
if(!clazz.equals(other.clazz))returnfalse;
if(!Arrays.equals(descriptor,other.descriptor))returnfalse;
if(!Arrays.equals(values,other.values))returnfalse;returntrue;}}
if(secMgr.checkAuthenticationForAdminRole()&&cluster.isEnabled()){returnnewNodeLinkPanel(id,cluster);
if(aparam!=null&&!aparam.isEmpty()&&avalues!=null&&!avalues.isEmpty()){this.parameter=aparam;this.values=avalues.split("(?<!\\\\)(,)");
else{dispose();thrownewRuntimeException("Missing\"animator\"mandatoryparams\"aparam\"and\"avalues\".");
if(this.values.length>this.getWmsConfiguration().getMaxAllowedFrames()){dispose();thrownewRuntimeException("Requesttoolong;reachedthemaximumallowednumberofframes.");
iftheuserselectedanythingfinalList<LayerGroupInfo>selection=groupTable.getSelection();
if(selection.size()==0){return;
ifthereissomethingtocancel,let'swarntheuseraboutwhat//couldgowrong,and
iftheuseraccepts,let'sdeletewhat'sneededdialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){@OverrideprotectedComponentgetContents(Stringid){//showaconfirmationpanelforalltheobjectswehavetoremovereturnnewConfirmRemovalPanel(id,selection);
iftheselectionhasbeenclearedoutit'ssignadeletion//occurred,sorefreshthetable
if(groupTable.getSelection().size()==0){setEnabled(false);target.add(groupTable);for(AbstractLinklink:groupTable.getSelectionLinks()){target.add(link);
if(LOGGER.isLoggable(Level.INFO)){LOGGER.log(Level.INFO,e.getMessage(),e);
if(format==null){returnnull;
else{return(Format)SecuredObjects.secure(format,policy);
if(info==null){returnnull;
else{return(ServiceInfo)SecuredObjects.secure(info,policy);
if(info==null){returnnull;
else{return(ResourceInfo)SecuredObjects.secure(info,policy);
if(params!=null){//gettheparams,
ifanysourceCRS=params.get("fromSRS").toOptionalString();targetCRS=params.get("toSRS").toOptionalString();
if(source==null){error(getLocalizer().getString("ReprojectPage.sourcePointNotSpecifiedError",ReprojectPage.this,"SourceGeometryisnotspecified"));
else{MathTransformmt=getTransform();
if(mt!=null){try{Geometrytarget=JTS.transform(source,mt);targetGeom.setModelObject(target);at.add(targetGeom);
if(target==null){error(getLocalizer().getString("ReprojectPage.targetPointNotSpecifiedError",ReprojectPage.this,"TargetGeometryisnotspecified"));
else{MathTransformmt=getTransform();
if(mt!=null){try{Geometrysource=JTS.transform(target,mt.inverse());sourceGeom.setModelObject(source);at.add(sourceGeom);
if(sourceCRS!=null&&targetCRS!=null){MathTransformmt=getTransform();
if(mt!=null){wktLink.setEnabled(true);ajaxTarget.add(wktLink);
if(mt!=null){wktLabel.setDefaultModel(newModel<String>(mt.toString()));
if(source!=null){MathTransformtx=ReferencingFactoryFinder.getCoordinateOperationFactory(hints).createOperation(source,target).getMathTransform();GeometryCoordinateSequenceTransformertransformer=newGeometryCoordinateSequenceTransformer();transformer.setMathTransform(tx);transformers.put(source,transformer);
else{thrownewRuntimeException("Sourcewasnullintryingtocreateareprojectedfeaturecollection!");
if(crs!=null){DefaultCRSFilterVisitordefaulter=newDefaultCRSFilterVisitor(FF,crs);filter=(Filter)filter.accept(defaulter,null);
if(crsDelegate!=null&&!CRS.equalsIgnoreMetadata(crs,crsDelegate)){ReprojectingFilterVisitorreprojector=newReprojectingFilterVisitor(FF,delegate.getSchema());filter=(Filter)filter.accept(reprojector,null);
if(sub!=null){try{ReprojectingFeatureCollectionwrapper=newReprojectingFeatureCollection(sub,target);wrapper.setDefaultSource(defaultSource);returnwrapper;
if(!i.hasNext()){bounds=newReferencedEnvelope();bounds.setToNull();
else{SimpleFeaturefirst=(SimpleFeature)i.next();bounds=newReferencedEnvelope(first.getBounds());
if(objectinstanceofGeometry){//checkforcrsGeometrygeometry=(Geometry)object;CoordinateReferenceSystemcrs=(CoordinateReferenceSystem)geometry.getUserData();
if(crs==null){//nocrsspecifiedongeometry,checkdefault
if(defaultSource!=null){crs=defaultSource;
if(crs!=null){//
ifequal,nothingtodo
if(!crs.equals(target)){GeometryCoordinateSequenceTransformertransformer=(GeometryCoordinateSequenceTransformer)transformers.get(crs);
if(transformer==null){transformer=newGeometryCoordinateSequenceTransformer();MathTransform2Dtx;try{tx=(MathTransform2D)ReferencingFactoryFinder.getCoordinateOperationFactory(hints).createOperation(crs,target).getMathTransform();
if(delegate!=null)delegate.close();delegate=null;
if(m_ProgressListener!=null){m_ProgressListener.complete();m_ProgressListener.dispose();
if(m_ProgressListener!=null){returnm_ProgressListener.isCanceled();
else{returnfalse;
if(m_ProgressListener!=null){m_ProgressListener.progress((float)step);
if(m_ProgressListener!=null){m_ProgressListener.progress((float)(step/totalNumberOfSteps)*100);
if(m_ProgressListener!=null){m_ProgressListener.setTask(Text.text(text));
if(m_ProgressListener!=null){m_ProgressListener.setTask(Text.text(description));
if(m_ProgressListener!=null){m_ProgressListener.setTask(Text.text(prefix));
if(r==null)returnnull;
else
if(rinstanceofFeatureTypeInfo)return(FeatureTypeInfo)SecuredObjects.secure(r,policy);
else
if(rinstanceofCoverageInfo)return(CoverageInfo)SecuredObjects.secure(r,policy);
else
if(rinstanceofWMSLayerInfo)return(WMSLayerInfo)SecuredObjects.secure(r,policy);
else
if(rinstanceofWMTSLayerInfo)return(WMTSLayerInfo)SecuredObjects.secure(r,policy);
elsethrownewRuntimeException("Don'tknowhowtomakeresourceoftype"+r.getClass());
if(resourceinstanceofSecuredFeatureTypeInfo||resourceinstanceofSecuredCoverageInfo||resourceinstanceofSecuredWMSLayerInfo||resourceinstanceofSecuredWMTSLayerInfo){resource=(ResourceInfo)SecureCatalogImpl.unwrap(resource);
ifavalueisrequired,falseotherwise*/publicDropDownChoiceParamPanel(finalStringid,finalIModel<Serializable>paramValue,finalIModel<String>paramLabelModel,finalList<?extendsSerializable>options,finalbooleanrequired){super(id,paramValue);StringrequiredMark=required?"*":"";Labellabel=newLabel("paramName",paramLabelModel.getObject()+requiredMark);add(label);choice=newDropDownChoice<>("paramValue",paramValue,options);choice.setRequired(required);
if(!required){choice.setNullValid(true);
if(temp==null||temp.length()==0)return0;returnnewInteger(temp);
if(prefix!=null){returnprefix+":boolean";
if(this.prefix!=null){returnthis.prefix+":boolean";
if(prefix!=null){returnprefix+":boolean";
if(this.prefix!=null){returnthis.prefix+":boolean";
if(prefix!=null){returnprefix+":decimal";
if(this.prefix!=null){returnthis.prefix+":decimal";
if(prefix!=null){returnprefix+":decimal";
if(this.prefix!=null){returnthis.prefix+":decimal";
if(prefix!=null){returnprefix+":integer";
if(this.prefix!=null){returnthis.prefix+":integer";
if(prefix!=null){returnprefix+":integer";
if(this.prefix!=null){returnthis.prefix+":integer";
if(prefix!=null){returnprefix+":negativeInteger";
if(this.prefix!=null){returnthis.prefix+":negativeInteger";
if(prefix!=null){returnprefix+":negativeInteger";
if(this.prefix!=null){returnthis.prefix+":negativeInteger";
if(prefix!=null){returnprefix+":nonNegativeInteger";
if(this.prefix!=null){returnthis.prefix+":nonNegativeInteger";
if(prefix!=null){returnprefix+":nonNegativeInteger";
if(this.prefix!=null){returnthis.prefix+":nonNegativeInteger";
if(prefix!=null){returnprefix+":positiveInteger";
if(this.prefix!=null){returnthis.prefix+":positiveInteger";
if(prefix!=null){returnprefix+":positiveInteger";
if(this.prefix!=null){returnthis.prefix+":positiveInteger";
if(prefix!=null){returnprefix+":long";
if(this.prefix!=null){returnthis.prefix+":long";
if(prefix!=null){returnprefix+":long";
if(this.prefix!=null){returnthis.prefix+":long";
if(prefix!=null){returnprefix+":int";
if(this.prefix!=null){returnthis.prefix+":int";
if(prefix!=null){returnprefix+":int";
if(this.prefix!=null){returnthis.prefix+":int";
if(prefix!=null){returnprefix+":short";
if(this.prefix!=null){returnthis.prefix+":short";
if(prefix!=null){returnprefix+":short";
if(this.prefix!=null){returnthis.prefix+":short";
if(prefix!=null){returnprefix+":byte";
if(this.prefix!=null){returnthis.prefix+":byte";
if(prefix!=null){returnprefix+":byte";
if(this.prefix!=null){returnthis.prefix+":byte";
if(prefix!=null){returnprefix+":unsignedLong";
if(this.prefix!=null){returnthis.prefix+":unsignedLong";
if(prefix!=null){returnprefix+":unsignedLong";
if(this.prefix!=null){returnthis.prefix+":unsignedLong";
if(prefix!=null){returnprefix+":unsignedShort";
if(this.prefix!=null){returnthis.prefix+":unsignedShort";
if(prefix!=null){returnprefix+":unsignedShort";
if(this.prefix!=null){returnthis.prefix+":unsignedShort";
if(prefix!=null){returnprefix+":unsignedInt";
if(this.prefix!=null){returnthis.prefix+":unsignedInt";
if(prefix!=null){returnprefix+":unsignedInt";
if(this.prefix!=null){returnthis.prefix+":unsignedInt";
if(prefix!=null){returnprefix+":unsignedByte";
if(this.prefix!=null){returnthis.prefix+":unsignedByte";
if(prefix!=null){returnprefix+":unsignedByte";
if(this.prefix!=null){returnthis.prefix+":unsignedByte";
if(prefix!=null){returnprefix+":float";
if(this.prefix!=null){returnthis.prefix+":float";
if(prefix!=null){returnprefix+":float";
if(this.prefix!=null){returnthis.prefix+":float";
if(prefix!=null){returnprefix+":double";
if(this.prefix!=null){returnthis.prefix+":double";
if(prefix!=null){returnprefix+":double";
if(this.prefix!=null){returnthis.prefix+":double";
if(prefix!=null){returnprefix+":date";
if(this.prefix!=null){returnthis.prefix+":date";
if(prefix!=null){returnprefix+":date";
if(this.prefix!=null){returnthis.prefix+":date";
if(prefix!=null){returnprefix+":dateTime";
if(this.prefix!=null){returnthis.prefix+":dateTime";
if(prefix!=null){returnprefix+":dateTime";
if(this.prefix!=null){returnthis.prefix+":dateTime";
if(prefix!=null){returnprefix+":duration";
if(this.prefix!=null){returnthis.prefix+":duration";
if(prefix!=null){returnprefix+":duration";
if(this.prefix!=null){returnthis.prefix+":duration";
if(prefix!=null){returnprefix+":gDay";
if(this.prefix!=null){returnthis.prefix+":gDay";
if(prefix!=null){returnprefix+":gDay";
if(this.prefix!=null){returnthis.prefix+":gDay";
if(prefix!=null){returnprefix+":gMonth";
if(this.prefix!=null){returnthis.prefix+":gMonth";
if(prefix!=null){returnprefix+":gMonth";
if(this.prefix!=null){returnthis.prefix+":gMonth";
if(prefix!=null){returnprefix+":gMonthDay";
if(this.prefix!=null){returnthis.prefix+":gMonthDay";
if(prefix!=null){returnprefix+":gMonthDay";
if(this.prefix!=null){returnthis.prefix+":gMonthDay";
if(prefix!=null){returnprefix+":gYear";
if(this.prefix!=null){returnthis.prefix+":gYear";
if(prefix!=null){returnprefix+":gYear";
if(this.prefix!=null){returnthis.prefix+":gYear";
if(prefix!=null){returnprefix+":gYearMonth";
if(this.prefix!=null){returnthis.prefix+":gYearMonth";
if(prefix!=null){returnprefix+":gYearMonth";
if(this.prefix!=null){returnthis.prefix+":gYearMonth";
if(prefix!=null){returnprefix+":time";
if(this.prefix!=null){returnthis.prefix+":time";
if(prefix!=null){returnprefix+":time";
if(this.prefix!=null){returnthis.prefix+":time";
if(prefix!=null){returnprefix+":ID";
if(this.prefix!=null){returnthis.prefix+":ID";
if(prefix!=null){returnprefix+":ID";
if(this.prefix!=null){returnthis.prefix+":ID";
if(prefix!=null){returnprefix+":IDREF";
if(this.prefix!=null){returnthis.prefix+":IDREF";
if(prefix!=null){returnprefix+":IDREF";
if(this.prefix!=null){returnthis.prefix+":IDREF";
if(prefix!=null){returnprefix+":IDREFS";
if(this.prefix!=null){returnthis.prefix+":IDREFS";
if(prefix!=null){returnprefix+":IDREFS";
if(this.prefix!=null){returnthis.prefix+":IDREFS";
if(prefix!=null){returnprefix+":ENTITY";
if(this.prefix!=null){returnthis.prefix+":ENTITY";
if(prefix!=null){returnprefix+":ENTITY";
if(this.prefix!=null){returnthis.prefix+":ENTITY";
if(prefix!=null){returnprefix+":ENTITIES";
if(this.prefix!=null){returnthis.prefix+":ENTITIES";
if(prefix!=null){returnprefix+":ENTITIES";
if(this.prefix!=null){returnthis.prefix+":ENTITIES";
if(prefix!=null){returnprefix+":NMTOKEN";
if(this.prefix!=null){returnthis.prefix+":NMTOKEN";
if(prefix!=null){returnprefix+":NMTOKEN";
if(this.prefix!=null){returnthis.prefix+":NMTOKEN";
if(prefix!=null){returnprefix+":NMTOKENS";
if(this.prefix!=null){returnthis.prefix+":NMTOKENS";
if(prefix!=null){returnprefix+":NMTOKENS";
if(this.prefix!=null){returnthis.prefix+":NMTOKENS";
if(prefix!=null){returnprefix+":NOTATION";
if(this.prefix!=null){returnthis.prefix+":NOTATION";
if(prefix!=null){returnprefix+":NOTATION";
if(this.prefix!=null){returnthis.prefix+":NOTATION";
if(prefix!=null){returnprefix+":string";
if(this.prefix!=null){returnthis.prefix+":string";
if(prefix!=null){returnprefix+":string";
if(this.prefix!=null){returnthis.prefix+":string";
if(prefix!=null){returnprefix+":normalizedString";
if(this.prefix!=null){returnthis.prefix+":normalizedString";
if(prefix!=null){returnprefix+":normalizedString";
if(this.prefix!=null){returnthis.prefix+":normalizedString";
if(prefix!=null){returnprefix+":token";
if(this.prefix!=null){returnthis.prefix+":token";
if(prefix!=null){returnprefix+":token";
if(this.prefix!=null){returnthis.prefix+":token";
if(prefix!=null){returnprefix+":QName";
if(this.prefix!=null){returnthis.prefix+":QName";
if(prefix!=null){returnprefix+":QName";
if(this.prefix!=null){returnthis.prefix+":QName";
if(prefix!=null){returnprefix+":Name";
if(this.prefix!=null){returnthis.prefix+":Name";
if(prefix!=null){returnprefix+":Name";
if(this.prefix!=null){returnthis.prefix+":Name";
if(prefix!=null){returnprefix+":NCName";
if(this.prefix!=null){returnthis.prefix+":NCName";
if(prefix!=null){returnprefix+":NCName";
if(this.prefix!=null){returnthis.prefix+":NCName";
if(namespaces.length%2!=0){thrownewRuntimeException("Invalidnumberofnamespacesprovided.");
if(hasUserGroupStore(userGroupServiceName)){store=newUserGroupStoreValidationWrapper(getUserGroupStore(userGroupServiceName));store.updateGroup(group);store.store();
if(hasRoleStore(getSecurityManager().getActiveRoleService().getName())){gaStore=getRoleStore(getSecurityManager().getActiveRoleService().getName());gaStore=newRoleStoreValidationWrapper(gaStore);Set<GeoServerRole>orig=gaStore.getRolesForGroup(group.getGroupname());Set<GeoServerRole>add=newHashSet<GeoServerRole>();Set<GeoServerRole>remove=newHashSet<GeoServerRole>();rolePalette.diff(orig,add,remove);for(GeoServerRolerole:add)gaStore.associateRoleToGroup(role,group.getGroupname());for(GeoServerRolerole:remove)gaStore.disAssociateRoleFromGroup(role,group.getGroupname());gaStore.store();
ifno*suchdirectoryexists.**@deprecateduse{@link#script(String)}*/@DeprecatedpublicFilefindScriptDir(Stringpath)throwsIOException{Resourcer=script(path);
if(r.getType()==Type.RESOURCE){returnr.dir();
ifitdoesnot*alreadyexist.**@deprecateduse{@link#script(String...)}*/@DeprecatedpublicFilefindOrCreateScriptDir(Stringpath){returnscript(path).dir();
ifthefiledoesnotexist.**@deprecateduse{@link#script(String...)}*/@DeprecatedpublicFilefindScriptFile(StringdirPath,Stringfilename)throwsIOException{Resourceres=script(dirPath+File.separator+filename);returnResources.exists(res)?res.file():null;
ifthefiledoesnot*exist.**@deprecateduse{@link#script(String...)}*/@DeprecatedpublicFilefindScriptFile(Stringpath)throwsIOException{Resourceres=script(path);returnResources.exists(res)?res.file():null;
ifnecessary.**@deprecateduse{@link#script(String...)}*/@DeprecatedpublicFilefindOrCreateScriptFile(Stringpath)throwsIOException{returnscript(path).file();
ifthedirectorydoesnotexist.**@deprecateduse{@link#app(String)}*/@DeprecatedpublicFilefindAppDir(Stringapp)throwsIOException{returnapp(app).dir();
ifitdoesnotalreadyexist.**@deprecateduse{@link#app(String)}*/@DeprecatedpublicFilefindOrCreateAppDir(Stringapp)throwsIOException{returnapp(app).dir();
if(appDir!=null){for(Resourcef:appDir.list()){
if("main".equals(FilenameUtils.getBaseName(f.name()))){main=f;break;
if(ext==null){returnnull;
if(ext!=null&&!ext.equalsIgnoreCase(e.getValue().getExtension())){continue;
if(engine==null){returnnull;
if(plugin.getScriptEngineFactoryClass().isInstance(engine.getFactory())){plugin.initScriptEngine(engine);break;
ifnosuchhook*canbefound.**<p>Thismethodworksbylookingupall{@linkScriptPlugin}instancesanddelegatingto*{@linkScriptPlugin#createAppHook()}.*/publicAppHooklookupAppHook(Resourcescript){ScriptPluginp=plugin(script.name());returnp!=null?p.createAppHook():newAppHook(null);
ifnosuchhook*canbefound.**<p>Thismethodworksbylookingupall{@linkScriptPlugin}instancesanddelegatingto*{@linkScriptPlugin#createWpsHook()}.*/publicWpsHooklookupWpsHook(Resourcescript){ScriptPluginp=plugin(script.name());returnp!=null?p.createWpsHook():null;
ifnosuchhook*canbefound.**<p>Thismethodworksbylookingupall{@linkScriptPlugin}instancesanddelegatingto*{@linkScriptPlugin#createFunctionHook()}.*/publicFunctionHooklookupFilterHook(Resourcescript){ScriptPluginp=plugin(script.name());returnp!=null?p.createFunctionHook():newFunctionHook(null);
ifnosuchhook*canbefound.**<p>Thismethodworksbylookingupall{@linkScriptPlugin}instancesanddelegatingto*{@linkScriptPlugin#createWfsTxHook()}.*/publicWfsTxHooklookupWfsTxHook(Resourcescript){ScriptPluginp=plugin(script.name());returnp!=null?p.createWfsTxHook():newWfsTxHook(null);
if(f.getExtensions().contains(ext)){returntrue;
ifnosuchhook*canbefound.**<p>Thismethodworksbylookingupall{@linkScriptPlugin}instancesanddelegatingto*{@linkScriptPlugin#createAppHook()}.*/@DeprecatedpublicAppHooklookupAppHook(Filescript){ScriptPluginp=plugin(script.getName());returnp!=null?p.createAppHook():newAppHook(null);
ifnosuchhook*canbefound.**<p>Thismethodworksbylookingupall{@linkScriptPlugin}instancesanddelegatingto*{@linkScriptPlugin#createWpsHook()}.*/@DeprecatedpublicWpsHooklookupWpsHook(Filescript){ScriptPluginp=plugin(script.getName());returnp!=null?p.createWpsHook():null;
ifnosuchhook*canbefound.**<p>Thismethodworksbylookingupall{@linkScriptPlugin}instancesanddelegatingto*{@linkScriptPlugin#createFunctionHook()}.*/@DeprecatedpublicFunctionHooklookupFilterHook(Filescript){ScriptPluginp=plugin(script.getName());returnp!=null?p.createFunctionHook():newFunctionHook(null);
ifnosuchhook*canbefound.**<p>Thismethodworksbylookingupall{@linkScriptPlugin}instancesanddelegatingto*{@linkScriptPlugin#createWfsTxHook()}.*/@DeprecatedpublicWfsTxHooklookupWfsTxHook(Filescript){ScriptPluginp=plugin(script.getName());returnp!=null?p.createWfsTxHook():newWfsTxHook(null);
if(f.getExtensions().contains(ext)){returntrue;
if(plugins==null){synchronized(this){
if(plugins==null){plugins=GeoServerExtensions.extensions(ScriptPlugin.class);for(ScriptPluginplugin:plugins){try{plugin.init(this);
if(ext.equalsIgnoreCase(plugin.getExtension())){returnplugin;
ifthefilehasno*extension.*/Stringext(StringscriptName)throwsIllegalArgumentException{Stringext=FilenameUtils.getExtension(scriptName);
if(ext==null){thrownewIllegalArgumentException(scriptName+"hasnoextension");
if(type==ScriptType.WPS){dir=this.wps();
else
if(type==ScriptType.FUNCTION){dir=this.function();
else
if(type==ScriptType.WFSTX){dir=this.wfsTx();
else
if(type==ScriptType.APP){dir=this.app();
if(type==ScriptType.APP){ResourceappDir=dir.get(name);returnappDir.get("main."+extension);
else{returndir.get(name+"."+extension);
if(dir.name().equals("function")){returnScriptType.FUNCTION;
else
if(dir.name().equals("tx")&&dir.parent().name().equals("wfs")){returnScriptType.WFSTX;
else
if(dir.name().equals("wps")||dir.parent().name().equals("wps")){returnScriptType.WPS;
else
if(dir.parent().name().equals("apps")){returnScriptType.APP;
else{thrownewIllegalArgumentException("Can'tdetermineScriptTypefor"+file+"'!");
if(dir.getName().equals("function")){returnScriptType.FUNCTION;
else
if(dir.getName().equals("tx")&&dir.getParentFile().getName().equals("wfs")){returnScriptType.WFSTX;
else
if(dir.getName().equals("wps")||dir.getParentFile().getName().equals("wps")){returnScriptType.WPS;
else
if(dir.getParentFile().getName().equals("apps")){returnScriptType.APP;
else{thrownewIllegalArgumentException("Can'tdetermineScriptTypefor"+file+"'!");
if(ext.equalsIgnoreCase(plugin.getExtension())){p=plugin;
if(p!=null){returnp.getEditorMode();
else{returnnull;
ifnototherwiseconfigured*/publicstaticintDEFAULT_MAX_REQUESTED_DIMENSION_VALUES=100;/**Whetherthisdimensionisenabledornot*/publicbooleanisEnabled();/***Setsthedimensionasenabled,ornot**@paramenabled*/publicvoidsetEnabled(booleanenabled);/**Theattributeonwhichthedimensionisbased.Usedonlyforvectordata*/publicStringgetAttribute();publicvoidsetAttribute(Stringattribute);/***Theattributeonwhichtheendofthedimensionisbased.Usedonlyforvectordata.This*attributeisoptional.*/publicStringgetEndAttribute();publicvoidsetEndAttribute(Stringattribute);/**Thewaythedimensionisgoingtobepresentedinthecapabilitiesdocuments*/publicDimensionPresentationgetPresentation();publicvoidsetPresentation(DimensionPresentationpresentation);/***Theintervalresolutionincase{@linkDimensionPresentation#DISCRETE_INTERVAL}presentation*hasbeenchosen(itcanbearepresentationofaelevationresolutionoratimeintervalin*milliseconds)*/publicBigDecimalgetResolution();publicvoidsetResolution(BigDecimalresolution);/***Theunitsattributefortheelevationdimension.Thismethodhasnoaffectonthetime*dimension.**@returnthevalueforunits*/publicStringgetUnits();publicvoidsetUnits(Stringunits);/***TheunitSymbolattributefortheelevationdimension.Thismethodhasnoaffectonthetime*dimension.**@returnthevalueforunitSymbol*/publicStringgetUnitSymbol();publicvoidsetUnitSymbol(StringunitSymbol);/***Thesettingforselectingthedefaultvalueforthisdimension.**@returnthecurrentdefaultvaluesetting*/publicDimensionDefaultValueSettinggetDefaultValue();publicvoidsetDefaultValue(DimensionDefaultValueSettingdefaultValue);/***Returnstrue
ifthenearestmatchbehaviorisimplemented.Rightnowit'sonlyavailablefor*theTIMEdimension,supportforotherdimensionsmightcomelater*/publicbooleanisNearestMatchEnabled();/***Enables/disablesnearestmatch.**@paramnearestMatch*/publicvoidsetNearestMatchEnabled(booleannearestMatch);/***Returnsastringspecifyingthesearchrange.Canbeempty,asinglevalue(tobeparsedin*thedatatypeofthedimension,inparticular,itwillbeaISOperiodfortimes)ora*{code}before/after{code}rangespecifyinghowfartosearchfromtherequestedvalue(e.g.,*{code}PT12H/PT1H{code}toallowsearching12hoursinthepastbutonly1hourinthe*future).**@return*/publicStringgetAcceptableInterval();/***Allowssettingthesearchrangefornearestmatches,seealso{@link*#getAcceptableInterval()}.**@paramacceptableInterval*/publicvoidsetAcceptableInterval(StringacceptableInterval);}
if(!(layerinstanceofGeoServerTileLayer)){return;
if(publishedInfoinstanceofLayerInfo){ResourceConfigurationPageresourceConfigPage;resourceConfigPage=newResourceConfigurationPage((LayerInfo)publishedInfo,false);//telltheresource/layereditpagetostartuponthetilecachetabresourceConfigPage.setSelectedTab(LayerCacheOptionsTabPanel.class);
if(returnPage!=null){resourceConfigPage.setReturnPage(returnPage);
else
if(publishedInfoinstanceofLayerGroupInfo){LayerGroupInfolayerGroup=(LayerGroupInfo)publishedInfo;WorkspaceInfoworkspace=layerGroup.getWorkspace();StringwsName=workspace==null?null:workspace.getName();PageParametersparameters=newPageParameters();parameters.add(LayerGroupEditPage.GROUP,layerGroup.getName());
if(wsName!=null){parameters.add(LayerGroupEditPage.WORKSPACE,wsName);
if(returnPage!=null){layerGroupEditPage.setReturnPage(returnPage);
if(listeners==null){listeners=newArrayList<ResourceListener>();handlers.put(resource,listeners);
if(listeners!=null){returnlisteners.remove(listener);
if(listeners!=null){//copylistenersintoanewcollection,//sothatlistenerscanremove/addthemselves
ifnecessarylisteners=newArrayList<>(listeners);for(ResourceListenerlistener:listeners){listener.changed(notification);
ifdelete,propagatedeletenotificationstochildren,whichcanbefoundintheevents//(see{@linkcreateEvents})
if(notification.getKind()==Kind.ENTRY_DELETE){for(Eventevent:notification.events()){
if(!notification.getPath().equals(event.getPath())){changedInternal(newResourceNotification(event.getPath(),Kind.ENTRY_DELETE,notification.getTimestamp(),notification.events()));
ifcreate,propagateCREATEeventstoitscreatedparents,whichcanbefoundinthe//events(see{@linkcreateEvents})Set<String>createdParents=newHashSet<String>();
if(notification.getKind()==Kind.ENTRY_CREATE){for(Eventevent:notification.events()){
if(!notification.getPath().equals(event.getPath())){createdParents.add(event.getPath());
ifnotacreatedparent)Stringpath=Paths.parent(notification.getPath());while(path!=null){booleanisCreate=createdParents.contains(path);changedInternal(newResourceNotification(path,isCreate?Kind.ENTRY_CREATE:Kind.ENTRY_MODIFY,notification.getTimestamp(),notification.events()));//stoppropagatingafterfirstmodifypath=isCreate?Paths.parent(path):null;
if(resource.getType()==Type.DIRECTORY&&kind==Kind.ENTRY_DELETE){for(Resourcechild:Resources.listRecursively(resource)){events.add(newResourceNotification.Event(child.path(),kind));
if(kind==Kind.ENTRY_CREATE){Resourceparent=resource.parent();while(parent!=null&&!Resources.exists(parent)){events.add(newResourceNotification.Event(parent.path(),kind));parent=parent.parent();
if(isAllowSessionCreation)((HttpServletRequest)req).getSession();//createsession
ifallowed//setthehintforothercomponentsreq.setAttribute(GeoServerSecurityFilterChainProxy.SECURITY_ENABLED_ATTRIBUTE,Boolean.TRUE);super.doFilter(req,res,chain);
if(max<min){form.error(newParamResourceModel("bfInvalidMinMax",getPage()).getString());
if(httpMethod!=null&&urlPath!=null){
if(getProxy().matcherForChain(chain).matches(request)){result=chain.getName();break;
if(urlPath==null||urlPath.indexOf("?")==-1){returnnull;
else{returnurlPath.substring(urlPath.indexOf("?")+1);
if(urlPath==null||urlPath.indexOf("?")==-1){returnurlPath;
else{returnurlPath.substring(0,urlPath.indexOf("?"));
if(rmsinstanceofLogoutHandler){((LogoutHandler)rms).logout(request,response,authentication);
if(rms!=null){returnrms;
if(rmsinstanceofAbstractRememberMeServices){((AbstractRememberMeServices)rms).setParameter(PARAMETER_NAME);
if(rmsinstanceofGeoServerTokenBasedRememberMeServices){//((GeoServerTokenBasedRememberMeServices)//rms).setUserGroupServiceName(rmsConfig.getUserGroupService());//
if(NetworkLinkMapOutputFormat.KML_MIME_TYPE.equals(request.getFormat())){request.setFormat(KMLMapOutputFormat.MIME_TYPE);
else{kmz=true;request.setFormat(KMZMapOutputFormat.MIME_TYPE);
if(superoverlay==null){superoverlay=Boolean.FALSE;
if(superoverlay){kml=newSuperOverlayNetworkLinkBuilder(context).buildKMLDocument();
else{kml=newSimpleNetworkLinkBuilder(context).buildKMLDocument();
ifnoconverteris*given,rolesareparsedbythedefaultconverter{@linkGeoServerRoleConverter}*<li>{@linkJ2EERoleSource#J2EE}-RolesarefetchedfromJ2EEcontainer**@authorMauroBartolomeoli(mauro.bartolomeoli@geo-solutions.it)*/publicclassJ2eeAuthenticationBaseFilterConfigextendsPreAuthenticatedUserNameFilterConfig{/**serialVersionUID*/privatestaticfinallongserialVersionUID=1L;/***RoleSourcelistvaluesextendedforfilterssupportingJ2EERoleSource.**@authorMauroBartolomeoli(mauro.bartolomeoli@geo-solutions.it)*/publicstaticenumJ2EERoleSourceimplementsRoleSource{Header,UserGroupService,RoleService,J2EE;@Overridepublicbooleanequals(RoleSourceother){returnother!=null&&other.toString().equals(toString());
if(nss==null){nss=defaultNss;
if(filter.getExpression1()instanceofPropertyName){PropertyNamepname=(PropertyName)filter.getExpression1();PropertyNamequalified=(PropertyName)pname.accept(this,extraData);returngetFactory(extraData).bbox(qualified,filter.getBounds());
else{returnsuper.visit(filter,extraData);
if(!cached.exists()||cached.lastModified()<mtime){Resource.Typetype=res.getType();
switch(type){caseRESOURCE:cached.getParentFile().mkdirs();cacheData(res,cached);break;caseDIRECTORY:cached.mkdirs();
if(cacheChildren){cacheChildren(res,cached);
if(createDirectory){cached.mkdirs();
else{cached.getParentFile().mkdirs();
if(minimalBounds.isEmpty()){LOGGER.debug(String.format("Featuretree'%s'notaffectedbychange%s...%s(took%s)",layerTreeName,oldCommit,newCommit,sw));return;
if(LOGGER.isDebugEnabled()){LOGGER.debug(String.format("Minimalboundsonlayer'%s'computedin%s:%s",tileLayerName,sw,formattedWKT(minimalBounds)));
if(nativeCrs==null){//nonativeCRSspecified,layermusthavebeenconfiguredwithanoverridingonesourceCrs=resource.getCRS();
else{sourceCrs=nativeCrs;
if(LOGGER.isDebugEnabled()){LOGGER.debug("geometrymaskreprojectedtogridset{}:{}",gridsetId,formattedWKT(geomInGridsetCrs));
if(zoomStop==null){zoomStop=gridSubset.getGridSet().getNumLevels()-1;
if(LOGGER.isDebugEnabled()){LOGGER.debug(String.format("Geometrybufferedbythesizeofatileatzoomlevel%s(%sunits):%s",zoomStop,bufferRatio,formattedWKT(geometry)));
if(LOGGER.isDebugEnabled()){LOGGER.debug("Simplifiedgeometry:{}",formattedWKT(geometry));
if(style.isEmpty()||style.equals(defaultStyle)){parameters=null;
else{parameters=Collections.singletonMap("STYLES",style);
if(zoomStart==null){zoomStart=0;
if(zoomStop==null){zoomStop=gridSubset.getGridSet().getNumLevels()-1;
if(LOGGER.isDebugEnabled()){LOGGER.debug(String.format("Truncatinglayer%s#%s#%swithgeommask%s",layerName,gridSetId,mimeType.getFormat(),formattedWKT(geomInGridsetCrs)));
if(defaultStyle!=null){cachedStyles.add(defaultStyle);
if(parameterFilters!=null){for(ParameterFilterpf:parameterFilters){
if(!"STYLES".equalsIgnoreCase(pf.getKey())){continue;
if(cachedStyles.isEmpty()){cachedStyles.add("");
ifthecreationof*theseobjectsisexpensive*/List<ProcessParameterIO>getProcessParameterIO();}
if(OS_SCHEMA==null){finalSchemaFactoryfactory=SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);try{OS_SCHEMA=factory.newSchema(OSEOTestSupport.class.getResource("/schemas/OpenSearch.xsd"));
if(ATOM_SCHEMA==null){finalSchemaFactoryfactory=SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);try{ATOM_SCHEMA=factory.newSchema(OSEOTestSupport.class.getResource("/schemas/searchResults.xsd"));
iftopopulatethegranulestable,ornot**@return*/protectedbooleanpopulateGranulesTable(){returnfalse;
if(dimensionName.equals(ResourceInfo.TIME)){retval=dimAccessor.getMinTime();
else
if(dimensionName.equals(ResourceInfo.ELEVATION)){retval=dimAccessor.getMinElevation();
else
if(dimensionName.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){StringcustDimName=dimensionName.substring(ResourceInfo.CUSTOM_DIMENSION_PREFIX.length());//see
ifwehaveanoptimizewaytogettheminimumStringmin=reader.getMetadataValue(custDimName.toUpperCase()+"_DOMAIN_MINIMUM");
if(min!=null){retval=min;
else{//ok,getthefulldomainthenList<String>domain=dimAccessor.getDomain(custDimName);
if(domain.isEmpty()){retval=null;
else{//Justalexical(string)sort.//Shouldwebepreparedfornumericanddatevalues?Collections.sort(domain);retval=domain.get(0);
if(layer.getType()==MapLayerInfo.TYPE_VECTOR){isRegionatingFriendly=isRegionatingFriendly&&layer.getFeature().getFeatureSource(null,null).getQueryCapabilities().isReliableFIDSupported();
else
if(layer.getType()==MapLayerInfo.TYPE_REMOTE_VECTOR){isRegionatingFriendly=isRegionatingFriendly&&layer.getRemoteFeatureSource().getQueryCapabilities().isReliableFIDSupported();
if(j>-1){name=name.substring(j+1);
if(!MODES.containsKey(mode)){thrownewServiceException("UnknownKMLmode:"+mode);
if("superoverlay".equals(mode)){Stringsubmode=KvpUtils.caseInsensitiveParam(request.getRawKvp(),"superoverlay_mode",wmsConfiguration.getKmlSuperoverlayMode());
if("raster".equalsIgnoreCase(submode)){modeOptions.put("overlaymode","raster");
else
if("overview".equalsIgnoreCase(submode)){modeOptions.put("overlaymode","overview");
else
if("hybrid".equalsIgnoreCase(submode)){modeOptions.put("overlaymode","hybrid");
else
if("auto".equalsIgnoreCase(submode)){modeOptions.put("overlaymode","auto");
else
if("cached".equalsIgnoreCase(submode)){modeOptions.put("overlaymode","cached");
else{thrownewServiceException("Unknownoverlaymode:"+submode);
if(request.getWidth()<1){request.setWidth(refreshMode||containsRasterData?DEFAULT_OVERLAY_SIZE:256);fo.put("autofit","true");
if(request.getHeight()<1){request.setHeight(refreshMode||containsRasterData?DEFAULT_OVERLAY_SIZE:256);fo.put("autofit","true");
if(fo.get("kmattr")==null){fo.put("kmattr",wmsConfiguration.getKmlKmAttr());
if(fo.get("kmscore")==null){fo.put("kmscore",wmsConfiguration.getKmScore());
if(fo.get("kmplacemark")==null){fo.put("kmplacemark",wmsConfiguration.getKmlPlacemark());
if(superoverlay==null){superoverlay=Boolean.FALSE;
if(superoverlay||refreshMode||containsRasterData){request.setFormat(NetworkLinkMapOutputFormat.KML_MIME_TYPE);
else
if(!Arrays.asList(KMZMapOutputFormat.OUTPUT_FORMATS).contains(request.getFormat())){request.setFormat(KMLMapOutputFormat.MIME_TYPE);
if(fo.get(entry.getKey())==null){fo.put(entry.getKey(),entry.getValue());
if(WPS_RESOURCE_DIR.exists()){FileUtils.deleteDirectory(WPS_RESOURCE_DIR);
if(WPS_RESOURCE_DIR.exists()){FileUtils.deleteDirectory(WPS_RESOURCE_DIR);
if(property.getName().equals("enabled")){Fragmentfragment=newFragment(id,"enabledFragment",WPSAccessRulePage.this);CheckBoxenabled=newCheckBox("enabled",(IModel<Boolean>)property.getModel(itemModel));enabled.setOutputMarkupId(true);fragment.add(enabled);returnfragment;
else
if(property.getName().equals("prefix")){returnnewLabel(id,property.getModel(itemModel));
else
if(property.getName().equals("title")){returnnewLabel(id,property.getModel(itemModel));
else
if(property.getName().equals("summary")){returnnewLabel(id,property.getModel(itemModel));
else
if(property.getName().equals("roles")){Fragmentfragment=newFragment(id,"rolesFragment",WPSAccessRulePage.this);TextArea<String>roles=newTextArea<String>("roles",(IModel<String>)property.getModel(itemModel)){public<CextendsObject>org.apache.wicket.util.convert.IConverter<C>getConverter(java.lang.Class<C>type){returnnewRolesConverter(availableRoles);};};StringBuilderselectedRoles=newStringBuilder();IAutoCompleteRenderer<String>roleRenderer=newRolesRenderer(selectedRoles);AutoCompleteBehavior<String>b=newRolesAutoCompleteBehavior(roleRenderer,settings,selectedRoles,availableRoles);roles.setOutputMarkupId(true);roles.add(b);fragment.add(roles);returnfragment;
else
if(property.getName().equals("edit")){Fragmentfragment=newFragment(id,"linkFragment",WPSAccessRulePage.this);//weuseasubmitlinktoavoidlosingtheothereditsintheformLinklink=newLink("link"){@OverridepublicvoidonClick(){ProcessGroupInfopfi=(ProcessGroupInfo)itemModel.getObject();setResponsePage(newProcessSelectionPage(WPSAccessRulePage.this,pfi));
if(listener.isCanceled()){thrownewProcessDismissedException(listener);
if(e!=null){this.minX=(int)e.getMinX();this.minY=(int)e.getMinY();this.maxX=(int)e.getMaxX();this.maxY=(int)e.getMaxY();
if(minX!=null&&maxX!=null&&minY!=null&&maxX!=null){finalintwidth=maxX-minX;finalintheight=maxY-minY;setConvertedInput(newGridEnvelope2D(newRectangle(minX,minY,width,height)));
else{setConvertedInput(null);
if(isLocalGeoToolsSchema(null,systemId)){returnnull;
if(isLocalGeoToolsSchema(baseURI,systemId)){returnnull;
if(systemId.startsWith("file:/")){returnisLocalGeotoolsSchema(systemId);
else
if(!systemId.contains("://")&&baseURI!=null){//locationrelativetoabaseURIreturnisLocalGeotoolsSchema(baseURI);
ifwehavedata,createamockservletcontextandstartupthespringconfiguration
if(testData.isTestDataAvailable()){//setupafakeWEB-INFdirectoryorg.springframework.core.io.ResourceLoaderrl;
if(testData.getDataDirectoryRoot().canWrite()){Filewebinf=newFile(testData.getDataDirectoryRoot(),"WEB-INF");webinf.mkdir();rl=newDirectoryResourceLoader(testData.getDataDirectoryRoot());
else{rl=newDefaultResourceLoader();
if(testData.isTestDataAvailable()){onTearDown(testData);destroyGeoServer();TestHttpClientProvider.endTest();//sometestsdoneedakickontheGCtofullycleanup
if(isMemoryCleanRequired()){System.gc();System.runFinalization();
if(applicationContext==null){return;
if(isQuietTests()){return"/QUIET_LOGGING.properties";
ifcoveragesareusedinthetest,sincereaders*mightstillbearoundintheheapasgarbagewithouthavingbeendisposedof*/protectedbooleanisMemoryCleanRequired(){returnfalse;
if(applicationContext.containsBean("wfsXsd-1.1")){return(XSD)applicationContext.getBean("wfsXsd-1.1");
else{returnnull;
if(applicationContext.containsBean("wfsXsd-1.0")){return(XSD)applicationContext.getBean("wfsXsd-1.0");
else{returnnull;
ifexists.*/protectedstaticvoiddisposeIfExists(XSDxsd){
if(xsd!=null){xsd.dispose();
ifprefixis*available,"localPart"
ifprefixisnull**@paramlayerName*/publicStringgetLayerId(QNamelayerName){returntoString(layerName);
if(ws!=null){newCascadeDeleteVisitor(cat).visit(ws);
if(ns!=null){cat.remove(ns);
if(store==null){return;
if(resource==null){return;
if(resource.equals(layer.getResource())){layer.accept(v);
if(s!=null){cat.remove(s);//removethesldfileaswellcat.getResourcePool().deleteStyle(s,true);
else{//handlecaseofsldfielstilllyingaroundFilesld=workspaceName!=null?cat.getResourceLoader().find("workspaces",workspaceName,"styles",name+".sld"):cat.getResourceLoader().find("styles",name+".sld");
if(sld!=null){sld.delete();
if(lg!=null){cat.remove(lg);
if(groups!=null&&!groups.isEmpty()){for(StringgroupName:groups){GeoServerUserGroupgroup=ugStore.getGroupByGroupname(groupName);
if(group==null){group=ugStore.createGroupObject(groupName,true);ugStore.addGroup(group);
if(roles!=null&&!roles.isEmpty()){GeoServerRoleServiceroleService=secMgr.getActiveRoleService();GeoServerRoleStoreroleStore=roleService.createStore();for(StringroleName:roles){GeoServerRolerole=roleStore.getRoleByName(roleName);
if(role==null){role=roleStore.createRoleObject(roleName);roleStore.addRole(role);
if(username!=null){Stringtoken=username+":";
if(password!=null){token+=password;
if(createSession){MockHttpSessionsession=newMockHttpSession(newMockServletContext());request.setSession(session);
ifnotmatched*@returnAninputstreamwhichistheresultoftherequest.*/protectedInputStreamget(Stringpath,intresponseCode)throwsException{MockHttpServletResponseresponse=getAsServletResponse(path);intstatus=response.getStatus();
if(responseCode!=status){Stringcontent=response.getContentAsString();
if(content==null||content.length()==0){thrownewServiceException("expectedstatus<"+responseCode+">butwas<"+status+">");
else{thrownewServiceException("expectedstatus<"+responseCode+">butwas<"+status+">:"+content);
ifthecontentisnotmade*ofchars.**@paramresponse*/protectedByteArrayInputStreamgetBinaryInputStream(MockHttpServletResponseresponse){returnnewByteArrayInputStream(getBinary(response));
ifthecontentisnotmade*ofchars.**@paramresponse*/protectedbyte[]getBinary(MockHttpServletResponseresponse){returnresponse.getContentAsByteArray();
if(statusCode!=status){Stringcontent=response.getContentAsString();
if(content==null||content.length()==0){thrownewServiceException("expectedstatus<"+statusCode+">butwas<"+status+">");
else{thrownewServiceException("expectedstatus<"+statusCode+">butwas<"+status+">:"+content);
if(statusCode!=status){Stringcontent=response.getContentAsString();
if(content==null||content.length()==0){thrownewServiceException("expectedstatus<"+statusCode+">butwas<"+status+">");
else{thrownewServiceException("expectedstatus<"+statusCode+">butwas<"+status+">:"+content);
iftrue,willavoidloadingandvalidatingagainsttheresponsedocument*schemaorDTD*@returnAresultoftherequestparsedintoadom.*/protectedDocumentgetAsDOM(finalStringpath,finalbooleanskipDTD)throwsException{InputStreamresponseContent=get(path);returndom(responseContent,skipDTD);
iftrue,willavoidloadingandvalidatingagainsttheresponsedocument*schemaorDTD*@paramencodingOveridefortheencodingofthedocument.*@returnAresultoftherequestparsedintoadom.*/protectedDocumentgetAsDOM(finalStringpath,finalbooleanskipDTD,Stringencoding)throwsException{returndom(get(path),skipDTD,encoding);
ifTRUEXMLschemavalidatewilbeperformed*@returntheparsedresponseXMLcontent*/protectedDocumentdom(MockHttpServletResponseresponse,booleanskipSchemaValidation){try(InputStreaminput=newByteArrayInputStream(response.getContentAsString().getBytes())){//parseresponseXMlcontentreturndom(input,skipSchemaValidation);
if(encoding!=null){input.setEncoding(encoding);
else{input.setEncoding(Charset.defaultCharset().name());
if(skipDTD){DocumentBuilderFactoryfactory=DocumentBuilderFactory.newInstance();factory.setNamespaceAware(true);factory.setValidating(false);DocumentBuilderbuilder=factory.newDocumentBuilder();builder.setEntityResolver(newEmptyResolver());Documentdom=builder.parse(input);returndom;
else{DocumentBuilderFactoryfactory=DocumentBuilderFactory.newInstance();factory.setNamespaceAware(true);DocumentBuilderbuilder=factory.newDocumentBuilder();returnbuilder.parse(input);
if(charset==null){charset=Charset.defaultCharset().name();
if(filterList!=null){chain=newMockFilterChain(servlet,(Filter[])filterList.toArray(newFilter[filterList.size()]));
else{chain=newMockFilterChain(servlet);
if(valueinstanceofString){request.addParameter(key,(String)value);
else{String[]values=(String[])value;request.addParameter(key,values);
if(cm.hasAlpha()){actual=newColor(cm.getRed(pixel),cm.getGreen(pixel),cm.getBlue(pixel),cm.getAlpha(pixel));
else{actual=newColor(cm.getRed(pixel),cm.getGreen(pixel),cm.getBlue(pixel),255);
if(resolution!=null){di.setResolution(newBigDecimal(resolution));
if(resolution!=null){di.setResolution(newBigDecimal(resolution));
if(validationErrors!=null&&validationErrors.size()>0){StringBuildersb=newStringBuilder();for(Exceptionve:validationErrors){sb.append(ve.getMessage()).append("\n");
if(exceptionCode!=null){assertEquals(exceptionCode,ex.getAttribute("code"));
if(locator!=null){assertEquals(locator,ex.getAttribute("locator"));
if(exceptionCode!=null){assertEquals(exceptionCode,ex.getAttribute("exceptionCode"));
if(locator!=null){assertEquals(locator,ex.getAttribute("locator"));
iffound*/protectedStringcheckOws11Exception(Documentdom)throwsException{returncheckOws11Exception(dom,null);
iffound*/protectedStringcheckOws11Exception(Documentdom,StringexceptionCode)throwsException{returncheckOws11Exception(dom,exceptionCode,null);
iffound*/protectedStringcheckOws11Exception(Documentdom,StringexceptionCode,Stringlocator)throwsException{returncheckOws11Exception(dom,"1.1.0",exceptionCode,locator);
iffound*/protectedStringcheckOws11Exception(Documentdom,Stringversion,StringexceptionCode,Stringlocator)throwsException{Elementroot=dom.getDocumentElement();assertEquals("ows:ExceptionReport",root.getNodeName());assertEquals(version,root.getAttribute("version"));assertEquals("http://www.opengis.net/ows/1.1",root.getAttribute("xmlns:ows"));
if(exceptionCode!=null){assertEquals(1,dom.getElementsByTagName("ows:Exception").getLength());Elementex=(Element)dom.getElementsByTagName("ows:Exception").item(0);assertEquals(exceptionCode,ex.getAttribute("exceptionCode"));
if(locator!=null){assertEquals(1,dom.getElementsByTagName("ows:Exception").getLength());Elementex=(Element)dom.getElementsByTagName("ows:Exception").item(0);assertEquals(locator,ex.getAttribute("locator"));
if(nodes.getLength()>0){returnnodes.item(0).getTextContent();
ifyoudon'twanttocheckit.**@returnsReturnsthemessageoftheinnerexception.*/protectedStringcheckOws20Exception(MockHttpServletResponseresponse,Integerstatus,StringexceptionCode,Stringlocator)throwsException{//checkthehttplevelassertEquals("application/xml",response.getContentType());
if(status!=null){assertEquals(status.intValue(),response.getStatus());
if(exceptionCode!=null){assertEquals(exceptionCode,ex.getAttribute("exceptionCode"));
if(locator!=null){assertEquals(locator,ex.getAttribute("locator"));
if(reader!=null)reader.close();
if(isQuietTests()){return;
if(isQuietTests()){return;
if(isQuietTests()){return;
if(elements.getLength()>0){return(Element)elements.item(0);
if(errors!=null&&errors.size()>0)throw(Exception)errors.get(0);returncaseInsensitiveKvp(input);
if(imageinstanceofBufferedImage){fail("Foundabufferedimageinthechain,theoriginalimageisnotfullydeferredloaded");
else{for(RenderedImageri:image.getSources()){assertDeferredLoading(ri);
if(null==myBody)returnnull;returnnewBufferedReader(newStringReader(newString(myBody)));
if(myBody==null||myMark<0||myMark>=myBody.length){
if(myBody==null||myBody.length==0){//Thispreventsanannoyingerrorwhenthestingisemptyornullreturn;
if(myBody==null||realOffset>=myBody.length){return-1;
if(myBody[myOffset+i]=='\n')break;
ifthelayergroupcannotbefoundanexceptionwillbethrow.*/protectedvoidaddKeywordsToLayerGroup(StringlayerGroupName){//createalistofkeywordsList<KeywordInfo>keywords=newArrayList<>();Keywordkeyword1=newKeyword("keyword1");keyword1.setLanguage("en");keyword1.setVocabulary("vocabulary1");keywords.add(keyword1);Keywordkeyword2=newKeyword("keyword2");keyword2.setLanguage("pt");keyword2.setVocabulary("vocabulary2");keywords.add(keyword2);//addkeywordstoalayergroupLayerGroupInfolayerGroup=getCatalog().getLayerGroupByName(layerGroupName);
if(layerGroup==null){//targetedlayergroupdoesn'texiststhrownewRuntimeException(String.format("Layergroup'%s'doesn'texists.",layerGroupName));
if(originalLayerInfo==null){//layerdon'texiststhrownewRuntimeException(String.format("Couldnotretrievealayerforname'%s'.",layerName));
ifthat'scorrectwmsInfo.setOnlineResource("http://onlineresource/fake");ContactInfocontactInfo=newContactInfoImpl();geosInfo.setContact(contactInfo);contactInfo.setContactPerson("contactPerson");contactInfo.setContactOrganization("contactOrganization");contactInfo.setContactPosition("contactPosition");contactInfo.setAddress("address");contactInfo.setAddressType("addressType");contactInfo.setAddressCity("city");contactInfo.setAddressState("state");contactInfo.setAddressPostalCode("postCode");contactInfo.setAddressCountry("country");contactInfo.setContactVoice("voice");contactInfo.setContactEmail("email");contactInfo.setContactFacsimile("fax");wmsInfo.setFees("fees");wmsInfo.setAccessConstraints("accessConstraints");GetCapabilitiesTransformertr;tr=newGetCapabilitiesTransformer(wmsConfig,baseUrl,mapFormats,legendFormats,null);tr.setIndentation(2);Documentdom=WMSTestSupport.transform(req,tr);Stringservice="/WMT_MS_Capabilities/Service";assertXpathEvaluatesTo("OGC:WMS",service+"/Name",dom);assertXpathEvaluatesTo("title",service+"/Title",dom);assertXpathEvaluatesTo("abstract",service+"/Abstract",dom);assertXpathEvaluatesTo("k1",service+"/KeywordList/Keyword[1]",dom);assertXpathEvaluatesTo("k2",service+"/KeywordList/Keyword[2]",dom);assertXpathEvaluatesTo(wmsInfo.getOnlineResource(),service+"/OnlineResource/@xlink:href",dom);assertXpathEvaluatesTo("contactPerson",service+"/ContactInformation/ContactPersonPrimary/ContactPerson",dom);assertXpathEvaluatesTo("contactOrganization",service+"/ContactInformation/ContactPersonPrimary/ContactOrganization",dom);assertXpathEvaluatesTo("contactPosition",service+"/ContactInformation/ContactPosition",dom);assertXpathEvaluatesTo("address",service+"/ContactInformation/ContactAddress/Address",dom);assertXpathEvaluatesTo("addressType",service+"/ContactInformation/ContactAddress/AddressType",dom);assertXpathEvaluatesTo("city",service+"/ContactInformation/ContactAddress/City",dom);assertXpathEvaluatesTo("state",service+"/ContactInformation/ContactAddress/StateOrProvince",dom);assertXpathEvaluatesTo("postCode",service+"/ContactInformation/ContactAddress/PostCode",dom);assertXpathEvaluatesTo("country",service+"/ContactInformation/ContactAddress/Country",dom);assertXpathEvaluatesTo("voice",service+"/ContactInformation/ContactVoiceTelephone",dom);assertXpathEvaluatesTo("fax",service+"/ContactInformation/ContactFacsimileTelephone",dom);assertXpathEvaluatesTo("email",service+"/ContactInformation/ContactElectronicMailAddress",dom);assertXpathEvaluatesTo("fees",service+"/Fees",dom);assertXpathEvaluatesTo("accessConstraints",service+"/AccessConstraints",dom);
if(!strict){patterns=Collections2.filter(patterns,newPredicate<DatePattern>(){@Overridepublicbooleanapply(DatePatterninput){return!input.isStrict();
if(parsed!=null){returnparsed;
if(m.matches()){Stringmatch=m.group(1);try{Dateparsed=dp.dateFormat().parse(match);
if(parsed!=null){returnparsed;
if("--debug".equalsIgnoreCase(args[i])){h=newDebugHandler();
if(h==null){h=newProductionHandler();
if(provider.hasGeoGig(repositoryName)){thrownewCommandSpecException("Thespecifiedrepositorynameisalreadyinuse,pleasetryadifferentname",HttpStatus.CONFLICT);
if(newRepo.isOpen()){thrownewCommandSpecException("Cannotruninitonanalreadyinitializedrepository.",HttpStatus.CONFLICT);
ifprovidedinrequestparametersStringauthorName=parameters.get(InitRequest.AUTHORNAME);StringauthorEmail=parameters.get(InitRequest.AUTHOREMAIL);
if(authorName!=null||authorEmail!=null){ConfigOpconfigOp=newRepo.command(ConfigOp.class);configOp.setAction(CONFIG_SET).setScope(LOCAL).setName("user.name").setValue(authorName).call();configOp.setAction(CONFIG_SET).setScope(LOCAL).setName("user.email").setValue(authorEmail).call();
if("file".equals(location.getScheme())){//needtheparentFileparentDir=newFile(location).getParentFile();location=parentDir.toURI().normalize();
if(reason!=null){notRemoved.put(root,reason);i.remove();
else{root.accept(visitor);
ifanyremovedobjectisonthelist)WebMarkupContainerremoved=newWebMarkupContainer("removedObjects");List<CatalogInfo>cascaded=visitor.getObjects(CatalogInfo.class,DELETE);//removetheresources,theyarecascaded,butwon'tbeshowintheUIfor(Iterator<CatalogInfo>it=cascaded.iterator();it.hasNext();){CatalogInfocatalogInfo=(CatalogInfo)it.next();
if(catalogInfoinstanceofResourceInfo)it.remove();
if(workspaces.size()==0)wsr.setVisible(false);wsr.add(newLabel("workspaces",names(workspaces)));//removedstoresWebMarkupContainerstr=newWebMarkupContainer("storesRemoved");removed.add(str);List<StoreInfo>stores=visitor.getObjects(StoreInfo.class);
if(stores.size()==0)str.setVisible(false);str.add(newLabel("stores",names(stores)));//removedlayersWebMarkupContainerlar=newWebMarkupContainer("layersRemoved");removed.add(lar);List<LayerInfo>layers=visitor.getObjects(LayerInfo.class,DELETE);
if(layers.size()==0)lar.setVisible(false);lar.add(newLabel("layers",names(layers)));//removedgroupsWebMarkupContainergrr=newWebMarkupContainer("groupsRemoved");removed.add(grr);List<LayerGroupInfo>groups=visitor.getObjects(LayerGroupInfo.class,DELETE);
if(groups.size()==0)grr.setVisible(false);grr.add(newLabel("groups",names(groups)));//removedstylesWebMarkupContainersyr=newWebMarkupContainer("stylesRemoved");removed.add(syr);List<StyleInfo>styles=visitor.getObjects(StyleInfo.class,DELETE);
if(styles.size()==0)syr.setVisible(false);syr.add(newLabel("styles",names(styles)));//modifiedobjectsroot(weshowit
ifanymodifiedobjectisonthelist)WebMarkupContainermodified=newWebMarkupContainer("modifiedObjects");modified.setVisible(visitor.getObjects(null,EXTRA_STYLE_REMOVED,GROUP_CHANGED,STYLE_RESET).size()>0);add(modified);//layersmodifiedWebMarkupContainerlam=newWebMarkupContainer("layersModified");modified.add(lam);layers=visitor.getObjects(LayerInfo.class,STYLE_RESET,EXTRA_STYLE_REMOVED);
if(layers.size()==0)lam.setVisible(false);lam.add(newLabel("layers",names(layers)));//groupsmodifiedWebMarkupContainergrm=newWebMarkupContainer("groupsModified");modified.add(grm);groups=visitor.getObjects(LayerGroupInfo.class,GROUP_CHANGED);
if(groups.size()==0)grm.setVisible(false);grm.add(newLabel("groups",names(groups)));
if(i<(objects.size()-1))sb.append(",");
ifacatalogobjectcanberemovedornot.**<p>Thismethodreturnsnon-nullincaseswheretheobjectshouldnotbeberemoved.The*returnvalueshouldbeadescriptionorreasonofwhytheobjectcannotberemoved.**@paraminfoTheobjecttoberemoved.*@returnAmessagestatingwhytheobjectcannotberemoved,ornulltoindicatethatitcan*beremoved.*/protectedStringResourceModelcanRemove(CatalogInfoinfo){returnnull;}}
if(o1.getPriority()<o2.getPriority())return-1;
else
if(o1.getPriority()==o2.getPriority()){return0;//
else
if(o1.getPriority()>o2.getPriority()){
else{return1;
ifit'canHandle'theincomingobject
ifso//addittothetreefor(finalIterator<?>it=beanSet.iterator();it.hasNext();){finalMap.Entry<String,?>entry=(Entry<String,?>)it.next();finalJMSEventHandlerSPI<S,O>spi=(JMSEventHandlerSPI)entry.getValue();
if(spi!=null){
if(spi.canHandle(eventType)){
if(LOGGER.isLoggable(Level.INFO))LOGGER.info("Creatinganinstanceof:"+spi.getClass());candidates.add(spi);
if(handler!=null)returnhandler;
if(LOGGER.isLoggable(Level.WARNING))LOGGER.log(Level.WARNING,e.getLocalizedMessage(),e);
if(LOGGER.isLoggable(Level.WARNING))LOGGER.warning(message);thrownewIllegalArgumentException(message);
if(spiBean!=null){JMSEventHandlerSPI<S,O>spi=JMSEventHandlerSPI.class.cast(spiBean);
if(spi!=null){returnspi.createHandler();
if(LOGGER.isLoggable(Level.WARNING))LOGGER.warning(message);thrownewIllegalArgumentException(message);}}
if(valinstanceofString){Strings=((String)val).trim();
if(s.length()>0){val=Double.parseDouble(s);
else{val=null;
if(val!=null){parsed=parseDate((Number)val);
if(kvp.containsKey("version")){Stringver=(String)kvp.get("version");
if(ver!=null&&"".equals(ver)){ver=null;
if(rawKvp.containsKey("acceptVersions")){Stringvalue=(String)rawKvp.get("acceptVersions");EObjectacceptVersions=Ows10Factory.eINSTANCE.createAcceptVersionsType();((Collection)EMFUtils.get(acceptVersions,"version")).addAll(KvpUtils.readFlat(value,KvpUtils.INNER_DELIMETER));kvp.put("acceptVersions",acceptVersions);
if(rawKvp.containsKey("sections")){Stringvalue=(String)rawKvp.get("sections");LOGGER.info("Sections:"+value);EObjectsections=Ows10Factory.eINSTANCE.createSectionsType();((Collection)EMFUtils.get(sections,"section")).addAll(KvpUtils.readFlat(value,KvpUtils.INNER_DELIMETER));kvp.put("sections",sections);
iftheysupportastorealongwithaservicereturnnull;
if(user==null)thrownewUsernameNotFoundException(userNotFoundMessage(username));RoleCalculatorcalculator=newRoleCalculator(this,getSecurityManager().getActiveRoleService());user.setAuthorities(calculator.calculateRoles(user));
if(layerinstanceofGeoServerTileLayer){GeoServerTileLayergsTileLayer=(GeoServerTileLayer)layer;LayerInfolayerInfo=gsTileLayer.getLayerInfo();
if(layerInfo!=null){returnCatalogIconFactory.get().getSpecificLayerIcon(layerInfo);
if(layerinstanceofWMSLayer){returnGWC;
if(headers!=null){
if(headers.length%2!=0){thrownewIllegalArgumentException("Theheadersmustbeaalternatedsequenceofkeys"+"andvalues,shouldhaveanevennumberofentries");
if(responseCharset!=null){contents=newString(response,Charset.forName(responseCharset));
else{contents=newString(response);
if(!DEFAULT_STYLEs.contains(styleName)){removeStyle(null,styleName);
if(System.getProperty(Importer.UPLOAD_ROOT_KEY)!=null){System.clearProperty(Importer.UPLOAD_ROOT_KEY);
if(layer.getType()==PublishedType.VECTOR){FeatureTypeInfofeatureType=(FeatureTypeInfo)layer.getResource();FeatureSourcesource=featureType.getFeatureSource(null,null);assertTrue(source.getCount(Query.ALL)>0);//doawfsrequestDocumentdom=getAsDOM("wfs?request=getFeature&typename="+featureType.getPrefixedName());assertEquals("wfs:FeatureCollection",dom.getDocumentElement().getNodeName());assertEquals(source.getCount(Query.ALL),dom.getElementsByTagName(featureType.getPrefixedName()).getLength());
if(store==null){return;
if("h2".equals(params.get("dbtype"))){databaseLocation=(String)params.get("database");
ifneeded
if(databaseLocation!=null){finalFiledbFile=newFile(databaseLocation);Filecontainer=dbFile.getParentFile();File[]dbFiles=container.listFiles(newFilenameFilter(){@Overridepublicbooleanaccept(Filedir,Stringname){returnname.startsWith(dbFile.getName());
ifthe*estimationcannotbeperformed**@paramobject*/publiclonggetSizeOf(Objectobject);}
if(values[i]!=null){Class<?>target=originalTypes[i].getType().getBinding();originalValues[i]=Converters.convert(values[i],target);
if(originalValues[i]==null)thrownewIOException("Couldnotmapback"+values[i]+"totype"+target);
if(ent!=null){ElementSetNameTypeesnt=Csw20Factory.eINSTANCE.createElementSetNameType();esnt.setValue(ent);kvp.put("elementsetname",esnt);
if(rawId==null){thrownewServiceException("Missingrequiredparameterid",ServiceException.MISSING_PARAMETER_VALUE,"id");
if(countco>4){thrownewIllegalArgumentException("Toomanycoordinates,openSearchcannothandlenonflatenvelopesyet");
if(crs!=null&&!CRS.equalsIgnoreMetadata(DefaultGeographicCRS.WGS84,crs)){thrownewOWS20Exception("OpenSearchforEOrequestsonlysupportboundigboxesinWGS84",OWS20Exception.OWSExceptionCode.InvalidParameterValue,"box");
if(minx>maxx){//datelinecrossingcasereturnnewReferencedEnvelope[]{newReferencedEnvelope(minx,180,miny,maxy,crs),newReferencedEnvelope(-180,maxx,miny,maxy,crs),};
else{returnnewReferencedEnvelope(minx,maxx,miny,maxy,crs);
if(mod==0){returnx>0?180:-180;
else{returnmod-180;
iftheobjectisacollection**@returnclassoftheobject*/Class<T>getObjectClass();/***Getthewrappedobject**<p>Mayreturneitheraninstaceof{@link#getObjectClass()}oracollectionofinstancesof*thatclass.**@returnwrappedobject*/ObjectgetObject();/***ApplyconfigurationtotheXStreamPersisterbasedontheconverter**@parampersisterTheXStreampersister*@paramxStreamMessageConverter*/voidconfigurePersister(XStreamPersisterpersister,XStreamMessageConverterxStreamMessageConverter);/***Applyconfigurationtothetemplatebasedonthedataformat**@paramconverterthe{@linkFreemarkerHTMLMessageConverter}touse*/voidconfigureFreemarker(FreemarkerHTMLMessageConverterconverter);/***Getthefreemarkertemplateassociatedwiththisresponse**@returnthefreemarkertemplate*/TemplategetTemplate();}
if(compressionLevel<ZipOutputStream.STORED||compressionLevel>ZipOutputStream.DEFLATED){thrownewIllegalArgumentException("InvalidCompressionLevel:"+compressionLevel);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Usingcompressionlevel"+compressionLevel);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Usingcompressionlevel"+ZipOutputStream.STORED);
if(outputinstanceofFile&&isZpFile((File)output)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Fileisalreadyazip,wehaveonlytocopyit");
if(outputinstanceofFile){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Zippingthefile");
if(file.isDirectory()){IOUtils.zipDirectory(file,zipout,FileFilterUtils.trueFileFilter());
else{//check
ifisazipfilealreadyzipFile(file,zipout);
else{//listoffiles
if(outputinstanceofCollection){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Zippingthecollection");
if(objinstanceofFile){//converttofileandaddtozipfinalFilefile=((File)obj);
if(file.isDirectory()){IOUtils.zipDirectory(file,zipout,FileFilterUtils.trueFileFilter());
else{//check
ifisazipfilealreadyzipFile(file,zipout);
else{
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Skippingobject-->"+obj.toString());
else{//errorthrownewIllegalArgumentException("Unabletozipprovidedoutput.Output-->"+output!=null?output.getClass().getCanonicalName():"null");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Finishedtozip");
iftheprovided{@linkFile}isaZipFile.**<p>Itthrows{@linkIllegalArgumentException}incasetheprovidedfiledoesnotexistsoris*notareadablefile.**@paramfilethe{@linkFile}tocheckforzip*@throwsIOExceptionincasesomethingbadhappen*/publicstaticbooleanisZpFile(Filefile){
if(file==null||!file.exists()||!file.canRead()){thrownewIllegalArgumentException("ProvidedFileisnotvalidand/orreqadable!-->File:"+file!=null?file.getAbsolutePath():"null");
ifthefileisadirectory
if(file.isDirectory()){returnfalse;
if(file.length()<4){returnfalse;
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.log(Level.SEVERE,e.getLocalizedMessage(),e);
if(in!=null){org.apache.commons.io.IOUtils.closeQuietly(in);
if(file==null||!file.exists()||!file.canRead()){thrownewIllegalArgumentException("ProvidedFileisnotvalidand/orreqadable!-->File:"+file!=null?file.getAbsolutePath():"null");
if(in!=null){org.apache.commons.io.IOUtils.closeQuietly(in);
ifwewanta*context-lesssearch)*@paramkeyThekeytoobtainthestringfor*@paramlocaleThelocaleidentifyingtheresourcesettoselectthestringsfrom*@paramstyleThe(optional)styleidentifyingtheresourcesettoselectthestringsfrom*(see{@linkorg.apache.wicket.Session})*@returnThestringresourcevalueornull
ifresourcenotfound*/publicStringloadStringResource(Class<?>clazz,finalStringkey,finalLocalelocale,finalStringstyle,Stringvariation){//LoadthepropertiesassociatedwiththepathIPropertiesFactorypropertiesFactory=Application.get().getResourceSettings().getPropertiesFactory();//AllGeoServerreleatedresourcesareloadedintoaGeoServerApplication*.propertiesfileStringpath="/GeoServerApplication";while(true){//IteratoroverallthecombinationsResourceNameIteratoriter=newResourceNameIterator(path,style,variation,locale,null,false);while(iter.hasNext()){StringnewPath=(String)iter.next();finalPropertiesprops=propertiesFactory.load(clazz,newPath);
if(props!=null){//LookupthequalifiedkeyStringqualifiedKey=clazz!=null?clazz.getSimpleName()+"."+key:key;Stringvalue=props.getString(qualifiedKey);
if(value!=null)returnvalue;
ifpossible
if(isStopResourceSearch(clazz)){break;
if(clazz==null){//nothingmoretosearch,donebreak;
if(component==null){returnnull;
ifapropertywiththe'key'providedby//theusercanbefound.
if(string==null){string=loadStringResource((Class<?>)null,key,locale,style,variation);
if(!(componentinstanceofPage)){//AddallthecomponentonthewaytothePageMarkupContainercontainer=component.getParent();while(container!=null){searchStack.add(container.getClass());
if(containerinstanceofPage){break;
ifitisonethatweshouldn'tbotherfurthersearchesupthe*classhierarchyforproperties.**@paramclazzTheclasstocheck*@returnWhethertostopthesearch*/protectedbooleanisStopResourceSearch(finalClass<?>clazz){
if(clazz==null||clazz.equals(Object.class)||clazz.equals(Application.class)){returntrue;
if(clazz.equals(WebPage.class)||clazz.equals(WebMarkupContainer.class)||clazz.equals(WebComponent.class)){returntrue;
if(envelope==null){returnnull;
if(westBoundLongitude<eastBoundLongitude){geogBoundingGeom=createBoundingPolygon(westBoundLongitude,eastBoundLongitude,southBoundLatitude,northBoundLatitude,numSteps);
else{//thegeographicboundscrossthedayline(lon-180/180),trickitintotwoadjacent//polygonsPolygoneastPolygon=createBoundingPolygon(-180,eastBoundLongitude,southBoundLatitude,northBoundLatitude,numSteps);PolygonwestPolygon=createBoundingPolygon(westBoundLongitude,180,southBoundLatitude,northBoundLatitude,numSteps);geogBoundingGeom=gf.createMultiPolygon(newPolygon[]{eastPolygon,westPolygon});
if(style==null){StyleFactorystyleFactory=CommonFactoryFinder.getStyleFactory(GeoTools.getDefaultHints());SLDParserparser=newSLDParser(styleFactory);try{parser.setInput(getClass().getResource(styleName));
if(ds==null){ds=createLatLonDataStore();LATLON=newWeakReference<DataStore>(ds);
if(lon%10==0){level=10;
if(lon%30==0){level=30;
if(lat%10==0){level=10;
if(lat%30==0){level=30;
if(identifiersModel.getObject()==null){identifiersModel.setObject(newUniqueResourceIdentifiers());
if("code".equals(name)){FragmentcodeFragment=newFragment(id,"txtFragment",UniqueResourceIdentifiersEditor.this);FormComponentFeedbackBordercodeBorder=newFormComponentFeedbackBorder("border");codeFragment.add(codeBorder);TextField<String>code=newTextField<String>("txt",newPropertyModel<String>(itemModel,"code"));code.setLabel(newParamResourceModel("th.code",UniqueResourceIdentifiersEditor.this));code.setRequired(true);codeBorder.add(code);returncodeFragment;
else
if("namespace".equals(name)){FragmentnsFragment=newFragment(id,"txtFragment",UniqueResourceIdentifiersEditor.this);FormComponentFeedbackBordernamespaceBorder=newFormComponentFeedbackBorder("border");nsFragment.add(namespaceBorder);TextField<String>namespace=newTextField<String>("txt",newPropertyModel<String>(itemModel,"namespace"));namespace.setLabel(newParamResourceModel("th.namespace",UniqueResourceIdentifiersEditor.this));namespace.add(newURIValidator());namespaceBorder.add(namespace);returnnsFragment;
else
if("metadataURL".equals(name)){FragmenturlFragment=newFragment(id,"txtFragment",UniqueResourceIdentifiersEditor.this);FormComponentFeedbackBordernamespaceBorder=newFormComponentFeedbackBorder("border");urlFragment.add(namespaceBorder);TextField<String>url=newTextField<String>("txt",newPropertyModel<String>(itemModel,"metadataURL"));url.add(newURIValidator());namespaceBorder.add(url);returnurlFragment;
else
if("remove".equals(name)){FragmentremoveFragment=newFragment(id,"removeFragment",UniqueResourceIdentifiersEditor.this);GeoServerAjaxFormLinkremoveLink=newGeoServerAjaxFormLink("remove"){@OverrideprotectedvoidonClick(AjaxRequestTargettarget,Formform){UniqueResourceIdentifiersidentifiers=identifiersModel.getObject();UniqueResourceIdentifiersdi=(UniqueResourceIdentifier)itemModel.getObject();identifiers.remove(sdi);target.add(container);
if(identifiers.size()==0){ValidationErrorerror=newValidationError();Stringmessage=newParamResourceModel("noSpatialDatasetIdentifiers",UniqueResourceIdentifiersEditor.this).getString();error.setMessage(message);validatable.error(error);
ifwedon'tusethisone,thecalltosetObjectwon'tbemade,andthemetadata//mapwon'tbeupdatedreturnnewIModelComparator(){@Overridepublicbooleancompare(Componentcomponent,ObjectnewObject){returnfalse;
if(mapLayers.size()==1){ResourceInfor=mapLayers.get(0).getResource();
if(e.getIdentifier()==null){e.setIdentifier(r.getTitle());
if(e.getDescription()==null){e.setDescription(r.getAbstract());
if(mapLayers.isEmpty()){return;
if(formatOpts.containsKey("min_zoom")){minZoom=Integer.parseInt(formatOpts.get("min_zoom").toString());
if(formatOpts.containsKey("max_zoom")){maxZoom=Integer.parseInt(formatOpts.get("max_zoom").toString());
else
if(formatOpts.containsKey("num_zooms")){maxZoom=minZoom+Integer.parseInt(formatOpts.get("num_zooms").toString());
if(minZoom!=null||maxZoom!=null){matrixSet=matrixSet.subMap(minZoom,maxZoom);
if(crs==null){Stringsrs=getSRS(request);try{crs=CRS.decode(srs);
if(formatOpts.containsKey("min_column")){minColumn=Integer.parseInt(formatOpts.get("min_column").toString());
if(formatOpts.containsKey("max_column")){maxColumn=Integer.parseInt(formatOpts.get("max_column").toString());
if(formatOpts.containsKey("min_row")){minRow=Integer.parseInt(formatOpts.get("min_row").toString());
if(formatOpts.containsKey("max_row")){maxRow=Integer.parseInt(formatOpts.get("max_row").toString());
ifwecanactuallytestthathere//tester.assertVisible("batchForm:tasksPanel:listContainer:items:1:itemProperties:0:component:down");//tester.assertInvisible("batchForm:tasksPanel:listContainer:items:1:itemProperties:0:component:up");//tester.assertVisible("batchForm:tasksPanel:listContainer:items:2:itemProperties:0:component:down");//tester.assertVisible("batchForm:tasksPanel:listContainer:items:2:itemProperties:0:component:up");//tester.assertInvisible("batchForm:tasksPanel:listContainer:items:3:itemProperties:0:component:down");//tester.assertVisible("batchForm:tasksPanel:listContainer:items:3:itemProperties:0:component:up");tester.clickLink("batchForm:tasksPanel:listContainer:items:2:itemProperties:0:component:up:link");tester.clickLink("batchForm:tasksPanel:listContainer:items:5:itemProperties:0:component:down:link");assertEquals("task3",provider.getItems().get(0).getTask().getName());assertEquals("task2",provider.getItems().get(1).getTask().getName());assertEquals("task1",provider.getItems().get(2).getTask().getName());//selectanddeleteCheckBoxselector=((CheckBox)tester.getComponentFromLastRenderedPage("batchForm:tasksPanel:listContainer:items:7:selectItemContainer:selectItem"));tester.getRequest().setParameter(selector.getInputName(),"true");tester.executeAjaxEvent(selector,"click");selector=((CheckBox)tester.getComponentFromLastRenderedPage("batchForm:tasksPanel:listContainer:items:9:selectItemContainer:selectItem"));tester.getRequest().setParameter(selector.getInputName(),"true");tester.executeAjaxEvent(selector,"click");tester.clickLink("batchForm:removeSelected");tester.executeAjaxEvent("dialog:dialog:content:form:submit","click");assertEquals(1,provider.size());assertEquals("task2",provider.getItems().get(0).getTask().getName());formTester=tester.newFormTester("batchForm");formTester.select("frequency:type",1);formTester.setValue("frequency:time","00:00");formTester.submit("save");//newbatchhasbeenscheduledassertNotNull(scheduler.getJobDetail(JobKey.jobKey(batch.getId().toString())));}}
if(qName!=null){//returnqName;//
if(value==null){returnnewQName(null);
if(i!=-1){Stringprefix=s.substring(0,i);Stringlocal=s.substring(i+1);//firstmatchtheprefixbacktoauri,sincetheprefixmightnotmatchtheone//usedbythecatalogStringnamespaceURI=namespaceContext.getNamespaceURI(prefix);NamespaceInfonsInfo=null;
if(namespaceURI!=null){nsInfo=data.getNamespaceByURI(namespaceURI);
else{//fallbacktojustlookingupbyprefixnsInfo=data.getNamespaceByPrefix(prefix);
if(nsInfo!=null){returnnewQName(nsInfo.getURI(),local,nsInfo.getPrefix());
if(cacheConfiguration.getCustomTicker()!=null){LOGGER.log(Level.SEVERE,"SettingacustomTickerinthecache{0}",cacheConfiguration.getCustomTicker().getClass().getName());builder.ticker(cacheConfiguration.getCustomTicker());
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"Loading{0}",filter);//theservice,whenintegrated,maymodifythefilterRuleFilterclone=filter.clone();returnrealRuleReaderService.getAccessInfo(clone);
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"Reloading{0}",filter);//theservice,whenintegrated,maymodifythefilterRuleFilterclone=filter.clone();//thisisasyncimplementationAccessInforet=realRuleReaderService.getAccessInfo(clone);returnFutures.immediateFuture(ret);//nextthereisanasynchronousimplementation,butintestsitseemstohang//returnListenableFutureTask.create(newCallable<AccessInfo>(){//@Override//publicAccessInfocall()throwsException{//if(LOGGER.isLoggable(Level.FINE))//LOGGER.log(Level.FINE,"Asynchreloading{0}",filter);//returnrealRuleReaderService.getAccessInfo(filter);//
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"Loading{0}",filter);//theservice,whenintegrated,maymodifythefilterRuleFilterclone=filter.clone();returnrealRuleReaderService.getAdminAuthorization(clone);
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"Reloading{0}",filter);//theservice,whenintegrated,maymodifythefilterRuleFilterclone=filter.clone();//thisisasyncimplementationAccessInforet=realRuleReaderService.getAdminAuthorization(clone);returnFutures.immediateFuture(ret);
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"Loadinguser'"+user.getName()+"'");AuthUserauth=realRuleReaderService.authorize(user.getName(),user.getPw());
if(auth==null)thrownewNoAuthException("Can'tauthuser["+user.getName()+"]");returnauth;
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"Reloadinguser'"+user.getName()+"'");//thisisasyncimplementationAuthUserauth=realRuleReaderService.authorize(user.getName(),user.getPw());
if(auth==null)thrownewNoAuthException("Can'tauthuser["+user.getName()+"]");returnFutures.immediateFuture(auth);//todo:wemaywantaasynchronousimplementation
if(LOGGER.isLoggable(Level.WARNING))LOGGER.log(Level.WARNING,"Forcingcacheinvalidation");ruleCache.invalidateAll();userCache.invalidateAll();authCache.invalidateAll();
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"Requestfor{0}",filter);
if(LOGGER.isLoggable(Level.INFO))
if(dumpCnt.incrementAndGet()%10==0){LOGGER.info("Rules:"+ruleCache.stats());LOGGER.info("Users:"+userCache.stats());LOGGER.info("Auth:"+authCache.stats());LOGGER.fine("params:"+cacheConfiguration);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"AdminAuthRequestfor{0}",filter);
ifanexternalpeerdoesn'twanttousetheguavadep.*/publicStringgetStatsString(){returnruleCache.stats().toString();
if(obj==null){returnfalse;
if(getClass()!=obj.getClass()){returnfalse;
if((this.name==null)?(other.name!=null):!this.name.equals(other.name)){returnfalse;
if((this.pw==null)?(other.pw!=null):!this.pw.equals(other.pw)){returnfalse;
ifarangetype,ortype<code>Range&lt;clz&gt;</code>*/publicObjectgetDefaultValue(ResourceInforesource,StringdimensionName,DimensionInfodimension,Classclz);/***Returnsthecapabilitiesrepresentationofthedefaultvalue.Forexample,itcouldbe*"current"*/publicStringgetCapabilitiesRepresentation(ResourceInforesource,StringdimensionName,DimensionInfodimensionInfo);}
ifwehaveallthemessagesweneed.Onlymessagesthat*matchoneoftheprovidedhandlerskeyswillbeselected.*/publicstaticList<Message>getMessagesByHandlerKey(inttimeoutMs,Function<List<Message>,Boolean>stop,String...keys){List<String>keysList=Arrays.asList(keys);returnJmsEventsListener.getMessages(timeoutMs,stop,(message)->{try{StringhandlerKey=message.getStringProperty(JMSEventHandlerSPI.getKeyName());
if(keysList.contains(handlerKey)){//wewantthismessagereturnStatus.SELECT_CONTINUE;
ifwehaveallthemessagesweneed.Theselectormethodis*usedtoselectonlycertainmessages.*/publicstaticList<Message>getMessages(inttimeoutMs,Function<List<Message>,Boolean>stop,Function<Message,Status>selector){List<Message>selected=newArrayList<>();Statusstatus=Status.NO_STATUS;intmax=(int)Math.ceil(timeoutMs/10.0);inti=0;while(i<max&&status!=Status.SELECT_STOP&&status!=Status.REJECT_STOP&&!stop.apply(selected)){try{//let'swaittenmillisecondsThread.sleep(10);
if(status==Status.SELECT_CONTINUE||status==Status.SELECT_STOP){//wewantthismessageselected.add(message);
if(status==Status.SELECT_STOP||status==Status.REJECT_STOP){//wearedonebreak;
if(handlerKey.equals(handlerName)&&messageinstanceofObjectMessage){//wefoundamessagethatmatch'sthedesiredhandlerStringobject=((ObjectMessage)message).getObject().toString();found.add(handler.deserialize(object));
if(feature==null){break;
if(schema!=null){url+="?currentSchema="+schema+",public";
if(ssl){url+=(schema==null?"?":"&")+"sslmode=require";
if(table!=null){Stringschema=SqlUtil.schema(table.getTableName());
if(schema!=null){((GSPostGISDatastoreEncoder)encoder).setSchema(schema);
if(ssl){url+="?sslmode=require";
if(ssl){url+="?sslmode=require";
if(schema!=null){url+=(ssl?"&":"?")+"options=--search_path%3D"+schema;
iftheackwassentDataStoreInfoinfo;WorkspaceInfowsInfo;finalStringstoreName="testStore";finalStringstoreId="Store-TEST";finalStringstoreWorkspace="Workspace-TEST";{info=createMock(DataStoreInfo.class);wsInfo=createMock(WorkspaceInfo.class);expect(info.getName()).andStubReturn(storeName);expect(info.getId()).andStubReturn(storeId);expect(info.getWorkspace()).andStubReturn(wsInfo);expect(wsInfo.getId()).andStubReturn(storeWorkspace);expectationTestStoreDelete(info,storeName,storeId,DataStoreInfo.class);
switch(type){caseADD:catListener.handleAddEvent((CatalogAddEvent)catEvent(info));break;caseMODIFY:catListener.handlePostModifyEvent((CatalogPostModifyEvent)catEvent(info));break;caseREMOVE:catListener.handleRemoveEvent((CatalogRemoveEvent)catEvent(id));break;
ifusingtheCatalogInfoobjects*directly*/privatestaticfinalclassTupleimplementsSerializable,Comparable<Tuple>{privatestaticfinallongserialVersionUID=1L;finalStringid,name;publicTuple(Stringid,Stringname){this.id=id;this.name=name;
if(ws==null){returnLists.newArrayList();
if(storeInfo==null){returnLists.newArrayList();
if(modelObject!=null){original=getCatalog().getResource(modelObject.id,ResourceInfo.class);List<LayerInfo>layers=getCatalog().getLayers((ResourceInfo)original);
if(!layers.isEmpty()){layer=layers.get(0);
else{modelObject=store.getModelObject();
if(modelObject!=null){original=getCatalog().getStore(modelObject.id,StoreInfo.class);
else{modelObject=workspace.getModelObject();
if(modelObject!=null){original=getCatalog().getWorkspace(modelObject.id);
else{thrownewIllegalStateException();
if((curr+1)%100==0){sw.stop();System.out.printf("inserted%ssofarin%s(last100in%s)\n",(curr+1),globalTime,sw);sw.reset();sw.start();
if(c.isAssignableFrom(original.getClass())){returnc;
if(prototypeinstanceofWorkspaceInfo){sw.start();catalog.add((WorkspaceInfo)prototype);sw.stop();StringoriginalWsName=((WorkspaceInfo)original).getName();NamespaceInfons=catalog.getNamespaceByPrefix(originalWsName);NamespaceInfoImplns2=newNamespaceInfoImpl();ns2.setPrefix(newName);ns2.setURI(ns.getURI()+newName);sw.start();catalog.add(ns2);sw.stop();
if(recursive){for(StoreInfostore:catalog.getStoresByWorkspace((WorkspaceInfo)original,StoreInfo.class)){copyOne(catalog,store,(Class<CatalogInfo>)interfaceOf(store),(LayerInfo)null,nameSuffix,sw,true,prototype);
else
if(prototypeinstanceofStoreInfo){sw.start();finalStoreInfops=(StoreInfo)prototype;
if(parent!=null){ps.setWorkspace((WorkspaceInfo)parent);
if(recursive){for(ResourceInforesource:catalog.getResourcesByStore((StoreInfo)original,ResourceInfo.class)){LayerInforesourceLayer=catalog.getLayerByName(resource.prefixedName());copyOne(catalog,resource,(Class<CatalogInfo>)interfaceOf(resource),resourceLayer,nameSuffix,sw,true,prototype);
else
if(prototypeinstanceofResourceInfo){((ResourceInfo)prototype).setNativeName(((ResourceInfo)original).getNativeName());((ResourceInfo)prototype).setName(newName);
if(parent!=null){((ResourceInfo)prototype).setStore((StoreInfo)parent);
if(layer==null){return;
if(originalinstanceofWorkspaceInfo){prototype=newWorkspaceInfoImpl();
else
if(originalinstanceofDataStoreInfo){prototype=newDataStoreInfoImpl(catalog);
else
if(originalinstanceofCoverageStoreInfo){prototype=newCoverageStoreInfoImpl(catalog);
else
if(originalinstanceofWMSStoreInfo){prototype=newWMSStoreInfoImpl((CatalogImpl)SecureCatalogImpl.unwrap(catalog));
else
if(originalinstanceofFeatureTypeInfo){prototype=newFeatureTypeInfoImpl(catalog);
else
if(originalinstanceofCoverageInfo){prototype=newCoverageInfoImpl(catalog);
else
if(originalinstanceofWMSLayerInfo){prototype=newWMSLayerInfoImpl((CatalogImpl)SecureCatalogImpl.unwrap(catalog));
else{thrownewIllegalArgumentException(original.toString());
if(service.getVersions().isEmpty()){service.getVersions().add(WFSInfo.Version.V_10.getVersion());service.getVersions().add(WFSInfo.Version.V_11.getVersion());
if(!service.getVersions().contains(WFSInfo.Version.V_20.getVersion())){service.getVersions().add(WFSInfo.Version.V_20.getVersion());
iftheyarenotset
if(service.getGML()==null){((WFSInfoImpl)service).setGML(newHashMap<WFSInfo.Version,GMLInfo>());
if(gml==null){addGml(service,WFSInfo.Version.V_10,SrsNameStyle.URL,false);
else
if(gml.getOverrideGMLAttributes()==null){gml.setOverrideGMLAttributes(true);
if(gml==null){addGml(service,WFSInfo.Version.V_11,SrsNameStyle.URN,false);
else
if(gml.getOverrideGMLAttributes()==null){gml.setOverrideGMLAttributes(false);
if(gml==null){addGml(service,WFSInfo.Version.V_20,SrsNameStyle.URN2,false);
if(service.getSRS()==null){((WFSInfoImpl)service).setSRS(newArrayList<String>());
if(iteminstanceofResource){try(InputStreamin=((Resource)item).in()){byte[]result=newbyte[contents.length];intlen=in.read(result);
if(len!=contents.length){returnfalse;
if(in.read()!=-1){returnfalse;
iftopicNameischangedfinalStringtopicConfiguredName=configuration.getProperty(TopicConfiguration.TOPIC_NAME_KEY);
if(topic==null||topicName.equals(topicConfiguredName)){topicName=topicConfiguredName;topic=neworg.apache.activemq.command.ActiveMQTopic(configuration.getProperty(TopicConfiguration.TOPIC_NAME_KEY));
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("UsingbrokerURI:"+brokerURI);
if(cf==null){//needtobeinitializedcf=newPooledConnectionFactory(brokerURI);
else{
if(changed){//clearpendingconnectionstry{destroyConnectionFactory();
ifbrokerURIismodified*/privatebooleancheckBrokerURI(finalString_brokerURI){
if(brokerURI==null){
if(_brokerURI==null||_brokerURI.length()==0){brokerURI=getDefaultURI();returntrue;
else{//initializetothenewconfigurationbrokerURI=_brokerURI;//checktheURIsyntaxtry{newURI(brokerURI);
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe(e.getLocalizedMessage());
else{
if(_brokerURI==null||_brokerURI.length()==0){//usethedefaultreturncheckBrokerURI(getDefaultURI());
else
if(brokerURI.equalsIgnoreCase(_brokerURI)){returnfalse;
else{//somethingischanged:resetbrokerURI=null;returncheckBrokerURI(_brokerURI);
if(cf!=null){//closealltheconnectionscf.clear();//stopthefactorycf.stop();//setnullcf=null;
if(brokerService!=null){brokerService.stop();
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("StartingtheembeddedbrokerURI");
if(brokerService==null){finalStringxBeanBroker=configuration.getProperty(ActiveMQEmbeddedBrokerConfiguration.BROKER_URL_KEY);//finalXBeanBrokerFactorybf=newXBeanBrokerFactory();brokerService=bf.createBroker(newURI(xBeanBroker));brokerService.setEnableStatistics(false);//overridethenameofthebrokerURIusingtheinstancenamewhich//shouldbeuniquewithinthenetworkbrokerName=configuration.getProperty(JMSConfiguration.INSTANCE_NAME_KEY);brokerService.setBrokerName(brokerName);brokerService.setUseLocalHostBrokerName(false);brokerService.setVmConnectorURI(newURI("vm://"+brokerName));
else{
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("TheembeddedbrokerURIservicealreadyexists,probablyitisalreadystarted");
if(brokerService.isStarted()){
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("SKIPPING:TheembeddedbrokerURIisalreadystarted");
if(!brokerService.isStarted()){brokerService.start();
if(brokerService.isStarted()){
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("EmbeddedbrokerURIisnowstarted");
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("UnabletostarttheembeddedbrokerURI"+e1.getLocalizedMessage());
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("UnabletostarttheembeddedbrokerURI");
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("EmbeddedbrokerURIisnowstopped");
if(brokerService==null){returntrue;
if(!brokerService.isStarted()){
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("EmbeddedbrokerURIisnowstopped");
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("EmbeddedbrokerURIisgoingtostop:waiting...");
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("UnabletostarttheembeddedbrokerURI"+e1.getLocalizedMessage());
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("UnabletostoptheembeddedbrokerURI");
ifneeded
if(EmbeddedBrokerConfiguration.isEnabled(config)){
if(!isEmbeddedBrokerStarted()){try{
if(!startEmbeddedBroker(config.getConfigurations())){
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("UnabletostarttheembeddedbrokerURI,forcestatustodisabled");
else{
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.info("StartedtheembeddedbrokerURI:"+brokerService.toString());
else{
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("ThebrokerURIseemstobealreadystarted");
if(event.getApplicationContext()==applicationContext){init();
if(IS_GDAL_AVAILABLE==null){try{InputStreamconf=GdalTestUtil.class.getResourceAsStream("/gdal_translate.properties");Propertiesp=newProperties();
if(conf!=null){p.load(conf);
ifthepropertyfilehasn'tbeenconfigured
if(GDAL_TRANSLATE==null)GDAL_TRANSLATE="gdal_translate";GDAL_DATA=p.getProperty("gdalData");GdalWrappergdal=newGdalWrapper(GDAL_TRANSLATE,Collections.singletonMap("GDAL_DATA",GDAL_DATA));IS_GDAL_AVAILABLE=gdal.isAvailable();
if(isGdalAvailable())returnGDAL_TRANSLATE;
elsereturnnull;
if(isGdalAvailable())returnCollections.singletonMap("GDAL_DATA",GDAL_DATA);
elsereturnCollections.emptyMap();
if(entry.getName().matches("^\\w+.asc.aux.xml$")){auxFileFound=true;//
else
if("tazdem.prj".equals(entry.getName())){
else
if(entry.getName().matches("^\\w+.prj$")){prjFileFound=true;//checkprojectioncheckGridProjection(zis);//
else
if("tazdem.asc".equals(entry.getName())){
else
if(entry.getName().matches("^\\w+.asc$")){gridFileFound=true;//checkgridcontentcheckGridContent(zis);
if(row<TEST_GRID_HEADER_LABEL.length){assertEquals(2,cols.length);assertEquals(TEST_GRID_HEADER_LABEL[row],cols[0].trim());assertEquals(TEST_GRID_HEADER_DATA[row],Double.valueOf(cols[1].trim()),EQUALS_TOLERANCE);
else{assertEquals(TEST_GRID_COLS,cols.length);assertEquals(75.0,Double.valueOf(cols[0].trim()),EQUALS_TOLERANCE);
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Loadedtilelayer'"+info.getName()+"'");
if(!initialized){initialize();
if(id==null){returnnull;
if(info!=null){Resourcefile=getFile(tileLayerId);layersById.remove(tileLayerId);layersByName.remove(info.getName());file.delete();
if(oldValue==null){finalStringduplicateNameId=layersByName.get(newValue.getName());
if(null!=duplicateNameId){thrownewIllegalArgumentException("TileLayerwithsamenamealreadyexists:"+newValue.getName()+":<"+duplicateNameId+">");
else{layersByName.remove(oldValue.getName());
if(einstanceofExecutionException){propagate(((ExecutionException)e).getCause());
if(file.getType()==Type.UNDEFINED){cleanup=true;
if(cleanup){file.delete();
if(file.getType()==Type.UNDEFINED){thrownewFileNotFoundException(tileLayerId);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("DepersistingGeoServerTileLayerInfofrom"+res.path());
if(source.equals(dest))return;//differentresourcebooleanwin=System.getProperty("os.name").startsWith("Windows");
if(win&&Resources.exists(dest)){//windowsdoesnotdoatomicrenames,andcannotrenameafile
ifthedestfile//exists
if(!dest.delete()){thrownewIOException("Couldnotdelete:"+dest.path());
else{source.renameTo(dest);
if(this.contentNegotiationManager==null){this.contentNegotiationManager=super.mvcContentNegotiationManager();this.contentNegotiationManager.getStrategies().add(0,newDelegatingContentNegotiationStrategy());
if(!(strategyinstanceofContentNegotiationManager||strategyinstanceofDelegatingContentNegotiationStrategy)){mediaTypes=strategy.resolveMediaTypes(webRequest);
if(mediaTypes.size()>0){returnmediaTypes;
if(applicationContext.containsBean("gwcConverter")){converters.add((HttpMessageConverter<?>)applicationContext.getBean("gwcConverter"));
if(handler.getVersions()!=null&&handler.getVersions().size()>0){//Springconfigurationallowsassociatingasinglemimetoextensions,pickthe//latestList<Version>versions=handler.getVersions();finalVersionfirstVersion=versions.get(versions.size()-1);configurer.mediaType(handler.getFormat(),MediaType.valueOf(handler.mimeType(firstVersion)));
if(response.getRawStatusCode()!=400){super.handleError(response);
if(checkTokenResponse.containsKey("message")&&checkTokenResponse.get("message").toString().startsWith("Problems")){logger.debug("check_tokenreturnederror:"+checkTokenResponse.get("message"));thrownewInvalidTokenException(accessToken);
if(headers.getContentType()==null){headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
if(executionId.endsWith(".xml")||executionId.endsWith(".zip")){executionId=executionId.substring(0,executionId.length()-4);
else
if(executionId.endsWith(".json")){executionId=executionId.substring(0,executionId.length()-5);
if(i!=null){BackupExecutionAdapterbackupExecution=null;try{backupExecution=getBackupFacade().getBackupExecutions().get(Long.parseLong(i));
if(backupExecution==null&&mustExist){thrownewResourceNotFoundException("Nosuchbackupexecution:"+i);
else{
if(allowAll){returnnewArrayList<BackupExecutionAdapter>(getBackupFacade().getBackupExecutions().values());
if(i!=null){RestoreExecutionAdapterrestoreExecution=null;try{restoreExecution=getBackupFacade().getRestoreExecutions().get(Long.parseLong(i));
if(restoreExecution==null&&mustExist){thrownewResourceNotFoundException("Nosuchrestoreexecution:"+i);
else{
if(allowAll){returnnewArrayList<RestoreExecutionAdapter>(getBackupFacade().getRestoreExecutions().values());
if(options!=null){for(Stringoption:options){String[]optionsTokens=option.split("=",2);
if(optionsTokens.length>0){params.put(optionsTokens[0],optionsTokens[1]);
if(exec.getStartTime()!=null){writer.startNode("startTime");writer.setValue(DateFormat.getInstance().format(exec.getStartTime()));writer.endNode();
if(exec.getEndTime()!=null){writer.startNode("endTime");writer.setValue(DateFormat.getInstance().format(exec.getEndTime()));writer.endNode();
if(exec.getLastUpdated()!=null){writer.startNode("lastUpdated");writer.setValue(DateFormat.getInstance().format(exec.getLastUpdated()));writer.endNode();
if(buf.length()>0){buf.append('\n');
if(ex.getMessage()!=null){buf.append(ex.getMessage());StringWritererrors=newStringWriter();ex.printStackTrace(newPrintWriter(errors));buf.append('\n').append(errors.toString());
if(dl.getJobInstance().getJobName().equals(Backup.BACKUP_JOB_NAME)){numSteps=backupFacade.getTotalNumberOfBackupSteps();
else
if(dl.getJobInstance().getJobName().equals(Backup.RESTORE_JOB_NAME)){numSteps=backupFacade.getTotalNumberOfRestoreSteps();
if("filter".equals(nodeName)){try{filter=ECQL.toFilter(reader.getValue());
iftherequestisget*/protectedbooleanget;/**flagindicating
iftherequestisaSOAPrequest*/protectedbooleansoap;/**Kvpparameters,onlynon-null
ifget=true*/protectedMapkvp;/**rawkvpparameters,unparsed*/protectedMaprawKvp;/**bufferedinputstream,onlynon-null
ifget=false*/protectedBufferedReaderinput;/**OWSservice(combinedwithrequestandversion)*/protectedStringservice;/**OWSrequest(ieoperation)combinedwithserviceandversion*/protectedStringrequest;/**OWSprotocolversion(combinedwithserviceandrequest)*/protectedStringversion;/***xmlnamespaceusedinrequestbody,onlyrelevantforpostrequestsandwhenrequestbody*contentisnamespacequalified*/protectedStringnamespace;/**Theowsservicedescriptoroftheservice/versionthatwasactuallydispatched*/protectedServiceserviceDescriptor;/**Precontextoftheurlpath*/protectedStringcontext;/**Remainingpathwithoutcontext*/protectedStringpath;/**Theoutputformatofhterequest*/protectedStringoutputFormat;/**Anyerrorsthatoccurtryingtodeterminetheservice*/protectedThrowableerror;/**Timewhentherequesthittheserver*/protectedDatetimestamp;/***TheOperationusedtocalltheservicecode.Availableonlyafterdispatchingisdone,it*willgiveaccesstothecurrentserviceobject,andtheparsedrequest*/protectedOperationoperation;/**Uniquelyidentifiesthisrequest*/protectedUUIDidentifier;/**SOAPnamespaceusedintherequest*/privateStringsoapNamespace;publicRequest(){timestamp=newDate();identifier=UUID.randomUUID();
iftherequestisaGETone*/publicbooleanisGet(){returnget;
iftherequestisaSOAPrequest.*/publicbooleanisSOAP(){returnsoap;
if(this.kvp==null){setKvp(kvp);
else{this.kvp.putAll(kvp);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;Requestother=(Request)obj;
if(identifier==null){
if(other.identifier!=null)returnfalse;
else
if(!identifier.equals(other.identifier))returnfalse;returntrue;
iftherequestwasnotaSOAPone**@return*/publicStringgetSOAPNamespace(){returnsoapNamespace;}}
if(request.getVersion()!=null){accepted=newArrayList<String>();accepted.add(request.getVersion());
if("1.0.0".equals(version)){Wcs10CapsTransformercapsTransformer=newWcs10CapsTransformer(geoServer);capsTransformer.setEncoding(Charset.forName((getServiceInfo().getGeoServer().getSettings().getCharset())));returncapsTransformer;
if("1.0.0".equals(version)){WCSInfowcs=getServiceInfo();Wcs10DescribeCoverageTransformerdescribeTransformer=newWcs10DescribeCoverageTransformer(wcs,catalog);describeTransformer.setEncoding(Charset.forName((wcs.getGeoServer().getSettings().getCharset())));returndescribeTransformer;
if(meta==null)thrownewWcsException("CannotfindsourceCoverage"+request.getSourceCoverage()+"inthecatalog!");//firstlet'srunsomesanitychecksontheinputscheckRangeSubset(meta,request.getRangeSubset());checkInterpolationMethod(meta,request.getInterpolationMethod());checkOutput(meta,request.getOutput());////PREPAREDOMAINSUBSETELEMENT//finalDomainSubsetTypedomainSubset=request.getDomainSubset();//timefinalTimeSequenceTypetemporalSubset=domainSubset.getTemporalSubset();//spatialfinalSpatialSubsetTypespatialSubset=domainSubset.getSpatialSubset();finalEListgrids=spatialSubset.getGrid();
if(grids.size()==0)thrownewIllegalArgumentException("InvalidnumberofGridforspatialsubsettingwasset:"+grids.size());finalRectifiedGridTypegrid=(RectifiedGridType)grids.get(0);finalListenvelopes=spatialSubset.getEnvelope();
if(envelopes.size()==0)thrownewIllegalArgumentException("InvalidnumberofEnvelopeforspatialsubsettingwasset:"+envelopes.size());finalGeneralEnveloperequestedEnvelope=(GeneralEnvelope)envelopes.get(0);finalOutputTypeoutput=request.getOutput();
if(output==null)thrownewIllegalArgumentException("Outputtypewasnull");finalCodeTypeoutputCRS=output.getCrs();finalintdimension=grid.getDimension().intValue();//WESUPPORT3DDIMENSIONONLYVIAABAND
if(dimension==3)thrownewWcsException("WesupportathirddimensiononlyviaaspecificaAxisinRange",InvalidParameterValue,null);////GRABAREADER////grabthereaderusingthedefaultparamsfinalGridCoverage2DReaderreader=(GridCoverage2DReader)meta.getGridCoverageReader(null,WCSUtils.getReaderHints(wcs));
if(reader==null){//cannotinstantiateareader,weshouldreturnanemptyarrayreturncoverageResults.toArray(newGridCoverage2D[]{});
if(outputCRS!=null){requestedCRS=outputCRS.getValue();
if(requestedCRS==null){targetCRS=reader.getOriginalEnvelope().getCoordinateReferenceSystem();requestedCRS=CRS.lookupIdentifier(targetCRS,true);
else{//FORCELON,LAT!!!!targetCRS=CRS.decode(requestedCRS,true);
if(limits!=null){////wehaveimposedlimitsfromtherequest,wejustusethemastheyare//finalint[]lowers=limits.getLow().getCoordinateValues();destinationG2W=null;destinationSize=newRectangle(lowers[0],lowers[1],limits.getSpan(0),limits.getSpan(1));
else
if(grid.getOffsetVector()!=null&&grid.getOffsetVector().size()>0){////wehaveNOimposedlimitsfromtherequest,weneedtocreateaproperG2Wwith//theRESOLUTIONwewheregiven.//NoticethatthisisspecifictoWCS1.0.0sincetherequestjustallowusto//specifyResXandResY//finalVectorTypeoffsetVector=(VectorType)grid.getOffsetVector().get(0);finalListoffsetValues=offsetVector.getValue();finaldoubleresX=(Double)offsetValues.get(0);finaldoubleresY=(Double)offsetValues.get(1);finalDirectPositionTypeorigin_=grid.getOrigin().getPos();destinationSize=null;destinationG2W=newAffineTransform2D(resX,0d,0d,resY,(Double)origin_.getValue().get(0),(Double)origin_.getValue().get(1));
else{thrownewWcsException("InvalidGridvalue:"+grid.toString(),InvalidParameterValue,null);
if(destinationSize!=null)//wehavebeenaskedtosupportaspecificrastersize,wewillsetthegrid2world//accordinglyrequestedGridGeometry=newGridGeometry2D(newGridEnvelope2D(destinationSize),getHorizontalEnvelope(requestedEnvelope));
else//wehavebeenaskedtosupportaspecificg2w,wewillsettherastersize//accordinglyrequestedGridGeometry=newGridGeometry2D(PixelInCell.CELL_CENTER,destinationG2W,getHorizontalEnvelope(requestedEnvelope),null);//NOTICEthatwealwayshavetorespecttheprovidedenvelopefinalParameterValue<GeneralGridGeometry>requestedGridGeometryParam=newDefaultParameterDescriptor<GeneralGridGeometry>(AbstractGridFormat.READ_GRIDGEOMETRY2D.getName().toString(),GeneralGridGeometry.class,null,requestedGridGeometry).createValue();GeneralParameterValue[]tmpArray=newGeneralParameterValue[readParameters.length+1];System.arraycopy(readParameters,0,tmpArray,0,readParameters.length);tmpArray[tmpArray.length-1]=requestedGridGeometryParam;readParameters=tmpArray;/**Test
iftheparameter"TIME"ispresentintheWMSrequest,andbythewayinthe*readingparameters.Ifitisthecase,onecanaddsittotherequest.Ifan*exceptionisthrown,wehavenothingtodo.*/finalList<GeneralParameterDescriptor>parameterDescriptors=newArrayList<GeneralParameterDescriptor>(readParametersDescriptor.getDescriptor().descriptors());Set<ParameterDescriptor<List>>dynamicParameters=reader.getDynamicParameters();parameterDescriptors.addAll(dynamicParameters);////TIME//ReaderDimensionsAccessordimensions=newReaderDimensionsAccessor(reader);DimensionInfotimeDimension=meta.getMetadata().get(ResourceInfo.TIME,DimensionInfo.class);
if(timeDimension!=null&&timeDimension.isEnabled()&&dimensions.hasTime()){finalList<Object>timeValues=newArrayList<Object>();
if(temporalSubset!=null&&temporalSubset.getTimePosition()!=null){//grabthetimepositionsfinalEListtimePosition=temporalSubset.getTimePosition();for(Iteratorit=timePosition.iterator();it.hasNext();){TimePositionTypetp=(TimePositionType)it.next();Datedate=(Date)tp.getValue();
if(date==null){date=dimensions.getMaxTime();
if(timeValues.isEmpty()){Datedate=dimensions.getMaxTime();timeValues.add(date);
if(maxValues>0&&maxValues<timeValues.size()){thrownewServiceException("Morethan"+maxValues+"timesspecifiedintherequest,bailingout.",ServiceException.INVALID_PARAMETER_VALUE,"time");
if(elevationDimension!=null&&elevationDimension.isEnabled()&&dimensions.hasElevation()){List<Double>elevations=newArrayList<Double>();//extractelevationvaluesListaxisSubset=null;
if(request.getRangeSubset()!=null){axisSubset=request.getRangeSubset().getAxisSubset();
if(axisSubset.size()>0){for(inta=0;a<axisSubset.size();a++){AxisSubsetTypeaxis=(AxisSubsetType)axisSubset.get(a);StringaxisName=axis.getName();
if(axisName.equalsIgnoreCase(WCSUtils.ELEVATION)){
if(axis.getSingleValue().size()>0){for(ints=0;s<axis.getSingleValue().size();s++){elevations.add(Double.parseDouble(((TypedLiteralType)axis.getSingleValue().get(s)).getValue()));
else
if(axis.getInterval().size()>0){IntervalTypeinterval=(IntervalType)axis.getInterval().get(0);intmin=Integer.parseInt(interval.getMin().getValue());intmax=Integer.parseInt(interval.getMax().getValue());intres=(interval.getRes()!=null?Integer.parseInt(interval.getRes().getValue()):1);intcount=(int)(Math.floor(max-min)/res+1);for(intb=0;b<count;b++){elevations.add(newDouble(min+b*res));
if(elevations.isEmpty()){elevations.add(dimensions.getMinElevation());
if(request.getRangeSubset()!=null){EList<?>axisSubset=request.getRangeSubset().getAxisSubset();finalintasCount=axisSubset==null?0:axisSubset.size();for(inti=0;i<asCount;i++){AxisSubsetTypeaxis=(AxisSubsetType)axisSubset.get(i);StringaxisName=axis.getName();
if(!axisName.equalsIgnoreCase(WCSUtils.ELEVATION)){ObjectdimInfo=meta.getMetadata().get(ResourceInfo.CUSTOM_DIMENSION_PREFIX+axisName);axisName=axisName.toUpperCase();//usinguppercasewithimagemosaic
if(dimInfoinstanceofDimensionInfo&&dimensions.hasDomain(axisName)){intvalueCount=axis.getSingleValue().size();
if(valueCount>0){List<Object>dimValues=newArrayList<Object>(valueCount);for(ints=0;s<valueCount;s++){dimValues.addAll(dimensions.convertDimensionValue(axisName,((TypedLiteralType)axis.getSingleValue().get(s)).getValue()));
ifwehaveafilteramongtheparams//Filterfilter=WCSUtils.getRequestFilter();
if(filter!=null){readParameters=CoverageUtils.mergeParameter(parameterDescriptors,readParameters,filter,"FILTER","Filter");
if(request.getInterpolationMethod()!=null){interpolationType=request.getInterpolationMethod().getLiteral();
if(interpolationType!=null){
if(interpolationType.equalsIgnoreCase("bilinear")){interpolation=Interpolation.getInstance(Interpolation.INTERP_BILINEAR);
else
if(interpolationType.equalsIgnoreCase("bicubic")){interpolation=Interpolation.getInstance(Interpolation.INTERP_BICUBIC);
else
if(interpolationType.equalsIgnoreCase("nearestneighbor")){interpolation=Interpolation.getInstance(Interpolation.INTERP_NEAREST);
if(meta.getStore().getFormat()instanceofImageMosaicFormat){GeneralParameterValue[]temp=newGeneralParameterValue[readParameters.length+1];System.arraycopy(readParameters,0,temp,0,readParameters.length);temp[temp.length-1]=ImageMosaicFormat.INTERPOLATION.createValue();((ParameterValue)temp[temp.length-1]).setValue(interpolation);readParameters=temp;
if((coverage==null)||!(coverageinstanceofGridCoverage2D)){thrownewIOException("Norasterdatafoundintherequest(itmaybethat"+"therequestbboxisoutsideofthecoveragearea,orthatthefiltersused"+"matchnoportionsofit.");
if(request.getRangeSubset()!=null){//
if(request.getRangeSubset().getAxisSubset().size()>1){//thrownewWcsException("Multifieldcoveragesarenotsupportedyet");//
if(axisSubset.size()>0){for(inta=0;a<axisSubset.size();a++){AxisSubsetTypeaxis=(AxisSubsetType)axisSubset.get(a);try{StringaxisName=axis.getName();
if(axisName.equalsIgnoreCase("Band")){int[]bands=null;
if(axis.getSingleValue().size()>0){bands=newint[axis.getSingleValue().size()];for(ints=0;s<axis.getSingleValue().size();s++){bands[s]=Integer.parseInt(((TypedLiteralType)axis.getSingleValue().get(s)).getValue())-1;
else
if(axis.getInterval().size()>0){IntervalTypeinterval=(IntervalType)axis.getInterval().get(0);intmin=Integer.parseInt(interval.getMin().getValue());intmax=Integer.parseInt(interval.getMax().getValue());intres=(interval.getRes()!=null?Integer.parseInt(interval.getRes().getValue()):1);bands=newint[(int)(Math.floor(max-min)/res+1)];for(intb=0;b<bands.length;b++)bands[b]=(min+b*res)-1;
if(targetCRS!=null){destinationEnvelope=CRS.transform(destinationEnvelope,targetCRS);destinationEnvelope.setCoordinateReferenceSystem(targetCRS);
if(destinationSize!=null){destinationGridGeometry=newGridGeometry2D(newGridEnvelope2D(destinationSize),destinationEnvelope);
else{destinationGridGeometry=newGridGeometry2D(PixelInCell.CELL_CENTER,destinationG2W,destinationEnvelope,null);
if(coverage!=null){CoverageCleanerCallback.addCoverages(coverage);
if(einstanceofWcsException){throw(WcsException)e;
else{thrownewWcsException(e);
if(CRS.equalsIgnoreMetadata(originalCRS,horizontalCRS)){returnoriginalEnvelope;
if(transform.isIdentity()){returnoriginalEnvelope;
ifneeded
if(!CRS.equalsIgnoreMetadata(requestCRS,nativeCRS)){retVal=CRS.transform(getHorizontalEnvelope(requestedEnvelope),nativeCRS);retVal.setCoordinateReferenceSystem(nativeCRS);
else{//wedonotneedtodoanything,butwedothisinordertoaboidproblemswiththe//envelopechecksretVal=newGeneralEnvelope(getHorizontalEnvelope(requestedEnvelope));
if(!retVal.intersects(nativeEnvelope,true))returnnull;//intersectretVal.intersect(nativeEnvelope);retVal.setCoordinateReferenceSystem(nativeCRS);returnretVal;
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,te.getLocalizedMessage(),te);
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,fe.getLocalizedMessage(),fe);
if(!CRS.equalsIgnoreMetadata(nativeCRS,requestCRS)){requestedBBOXInNativeGeographicCRS=CRS.transform(requestedEnvelope,nativeGeoCRS);requestedBBOXInNativeGeographicCRS.setCoordinateReferenceSystem(nativeGeoCRS);
if(requestedBBOXInNativeGeographicCRS==null)requestedBBOXInNativeGeographicCRS=newGeneralEnvelope(requestCRS);//STEP2intersectionwiththegeographicbboxforthiscoverage
if(!requestedBBOXInNativeGeographicCRS.intersects(nativeEnvelope,true))returnnull;//intersectwiththecoveragenativegeographicbbox//notethatforthemomentwegottousegeneralenvelopesincethereisno//intersectionotherwiserequestedBBOXInNativeGeographicCRS.intersect(nativeGeoEnvelope);requestedBBOXInNativeGeographicCRS.setCoordinateReferenceSystem(nativeGeoCRS);//nowgobacktothecoveragenativeCRSinordertocomputeanapproximaterequested//resolutionfinalGeneralEnvelopeapproximateRequestedBBox=CRS.transform(requestedBBOXInNativeGeographicCRS,requestCRS);approximateRequestedBBox.setCoordinateReferenceSystem(requestCRS);returnapproximateRequestedBBox;
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,te.getLocalizedMessage(),te);
if(bboxCRsinstanceofGeographicCRS){//try{//finalCoordinateOperationFactorycof=CRS.getCoordinateOperationFactory(true);//finalCoordinateOperationoperation=//cof.createOperation(gridEnvelope.getCoordinateReferenceSystem(),bboxCRs);//requestedEnvelopeBboxCRS=CRS.transform(operation,gridEnvelope);//
if(lower[i]>upper[i]){//finalCoordinateSystemAxisaxis=bboxCRs.getCoordinateSystem().getAxis(i);////see
ifthecoordinatescanbefixed//
if(bboxCRsinstanceofGeographicCRS&&axis.getDirection()==AxisDirection.EAST){////
if(requestedEnvelopeBboxCRS!=null){////trytoguesswhichoneneedstobefixed//finaldoubleenvMax=requestedEnvelopeBboxCRS.getMaximum(i);//
if(envMax>=lower[i])//upper[i]=upper[i]+(axis.getMaximumValue()-axis.getMinimumValue());//
else//lower[i]=lower[i]-(axis.getMaximumValue()-axis.getMinimumValue());////
else{////justfixtheupperandhope...//upper[i]=upper[i]+(axis.getMaximumValue()-axis.getMinimumValue());//
ifevenafterthefixwe'reinthewrongsituation,complain//
if(lower[i]>upper[i]){//thrownewWcsException(//"illegalbbox,minofdimension"+(i+1)+":"+lower[i]+"is"+//"greaterthanmaxofsamedimension:"+upper[i],//WcsExceptionCode.InvalidParameterValue,"BoundingBox");//
if(interpolation!=null){booleaninterpolationSupported=false;
if(interpolation.startsWith("nearest")){interpolation="nearestneighbor";
if(interpolation.equals("nearestneighbor")||(info.getDefaultInterpolationMethod()!=null&&info.getDefaultInterpolationMethod().equalsIgnoreCase(interpolation))){interpolationSupported=true;
if(interpolation.equalsIgnoreCase(method)){interpolationSupported=true;
if(!interpolationSupported)thrownewWcsException("TherequestedInterpolationmethodisnotsupportedbythisCoverage.",InvalidParameterValue,"RangeSubset");
if(output==null)return;//checkoutputformatStringformat=output.getFormat().getValue();StringdeclaredFormat=getDeclaredFormat(meta.getSupportedFormats(),format);
if(declaredFormat==null)thrownewWcsException("format"+format+"isnotsupportedforthiscoverage",InvalidParameterValue,"format");//checkrequestedCRS//
if(output.getCrs()!=null){//StringrequestedCRS=output.getCrs().getValue();//
if(getRequestResponseCRS(meta.getRequestCRSs(),requestedCRS)==null&&//getRequestResponseCRS(meta.getResponseCRSs(),requestedCRS)==null)//thrownewWcsException("CRS"+requestedCRS+"isnotsupportedforthiscoverage",//InvalidParameterValue,"CRS");//
else{////TherequestedCRSwasnotspecified...whattodo???//
ifthesupportedformatstringlistcontainsthespecifiedformat,doingacase*insensitivesearch.Iffoundthedeclaredoutputformatnameisreturned,otherwisenullis*returned.**@paramsupportedFormats*@paramformat*/privateStringgetDeclaredFormat(List<String>supportedFormats,Stringformat){//supportedformatsmaybesetupusingoldstyleformats,firstscan//theconfiguredlistfor(Stringsf:supportedFormats){
if(sf.equalsIgnoreCase(format.trim())){returnsf;
else{CoverageResponseDelegatedelegate=responseFactory.encoderFor(sf);
if(delegate!=null&&delegate.canProduce(format))returnsf;
ifnorangesubsethasbeenspecified(it'slegal)
if(rangeSubset==null)return;for(inta=0;a<rangeSubset.getAxisSubset().size();a++){AxisSubsetTypeaxisSubset=(AxisSubsetType)rangeSubset.getAxisSubset().get(a);
if(axisSubset.getName().equalsIgnoreCase("Band")){//prepareasupportstructuretoquicklygetthebandindexofakey//(andrememberwereplacedspaceswithunderscoresinthekeysto//avoidissueswiththekvpparsingofindentifiersthatincludespaces)//checkindexesint[]bands=null;
if(axisSubset.getSingleValue().size()>0){bands=newint[1];bands[0]=Integer.parseInt(((TypedLiteralType)axisSubset.getSingleValue().get(0)).getValue());
else
if(axisSubset.getInterval().size()>0){IntervalTypeinterval=(IntervalType)axisSubset.getInterval().get(0);intmin=Integer.parseInt(interval.getMin().getValue());intmax=Integer.parseInt(interval.getMax().getValue());intres=(interval.getRes()!=null?Integer.parseInt(interval.getRes().getValue()):1);bands=newint[(max-min)/res];for(intb=0;b<bands.length;b++)bands[b]=min+(b*res);
if(bands==null)thrownewWcsException("Invalidvaluesforaxis"+axisSubset.getName(),InvalidParameterValue,"AxisSubset");
else
if(axisSubset.getName().equalsIgnoreCase(WCSUtils.ELEVATION)){double[]elevations=null;
if(axisSubset.getSingleValue().size()>0){elevations=newdouble[axisSubset.getSingleValue().size()];for(ints=0;s<axisSubset.getSingleValue().size();s++){elevations[s]=Double.parseDouble(((TypedLiteralType)axisSubset.getSingleValue().get(s)).getValue());
else
if(axisSubset.getInterval().size()>0){IntervalTypeinterval=(IntervalType)axisSubset.getInterval().get(0);intmin=Integer.parseInt(interval.getMin().getValue());intmax=Integer.parseInt(interval.getMax().getValue());intres=(interval.getRes()!=null?Integer.parseInt(interval.getRes().getValue()):1);elevations=newdouble[(int)(Math.floor(max-min)/res+1)];for(intb=0;b<elevations.length;b++)elevations[b]=(min+b*res);
if(testData.isInludeRaster()){b.style(DEFAULT_RASTER_STYLE);createWorkspace(WCS_PREFIX,WCS_URI,null,WCS_TYPENAMES,b);
if(ftTypeNames!=null&&ftTypeNames.length>0){b.dataStore(wsName);for(QNametypeName:ftTypeNames){Stringlocal=typeName.getLocalPart();b.style(local);b.featureType(local);
if(covTypeNames!=null&&covTypeNames.length>0){for(QNametypeName:covTypeNames){Stringlocal=typeName.getLocalPart();String[]fileNameAndFormat=COVERAGES.get(typeName);b.coverageStore(local,fileNameAndFormat[0],fileNameAndFormat[1]);b.coverage(typeName,fileNameAndFormat[0],null,null);b.commit();
if(property.getName().equals("default")){returnnewLabel(id,property.getModel(itemModel));
else
if(property.getName().equals("makeDefault")){returnmakeDefaultLink(id,itemModel);
else
if(property.getName().equals("remove")){returnremoveLink(id,itemModel);
else{returnnull;
if(name.getModelObject()==null||"".equals(name.getModelObject())){name.setModelObject(typeName);target.add(name);
if(stypes==null||stypes.size()==0){error(newParamResourceModel("atLeastOneSource",AbstractConfigPage.this).getString());
else
if(AbstractConfigPage.this.onSubmit()){originalConfig.copyFrom(config);setResponsePage(master.getPage());
ifsubclassingworks**@authorchristian*/publicclassMemoryGeoserverUserGroupextendsGeoServerUserGroup{/***/privatestaticfinallongserialVersionUID=1L;publicMemoryGeoserverUserGroup(Stringname){super(name);}}
if(validator==null){SchemaFactoryfactory=SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);Schemaschema;try{schema=factory.newSchema(newStreamSource(MDTestSupport.class.getResource("/net/opengis/schemas/iso/19139/20070417/gmd/metadataEntity.xsd").toString()));
if(null==style.getLegend()){style.setLegend(GeoServerApplication.get().getCatalog().getFactory().createLegend());
if(rwl.isWriteLockedByCurrentThread())//writeUnLock();//
else//readUnLock();fireRoleChangedEvent();
if(rule.contains(XMLRoleService.DEFAULT_LOCAL_ADMIN_ROLE))found=true;
if(rule.contains(GeoServerRole.ADMIN_ROLE.getAuthority()))Assert.fail("Migrationofadminrolenotsuccessful");
if(((inputs==null)||inputs.isEmpty())&&((outputs==null)||outputs.isEmpty())){return;
ifwehavethestatusStringexecutionId=event.getStatus().getExecutionId();ResourceStatusstatus=resourceStates.get(executionId);
if(status==null){status=newResourceStatus();resourceStates.put(executionId,status);
iftheavailableinputshavealreadybeencheckedSet<String>inputsChecked=status.inputsChecked;
if((inputs!=null)&&(inputsChecked.size()<inputs.size())){for(Entry<String,Object>entry:inputs.entrySet()){Objectinput=entry.getValue();
if((input!=null)&&inputsChecked.add(entry.getKey())&&(inputinstanceofGridCoverage)){resourceManager.addResource(newGridCoverageResource((GridCoverage)input));
iftheavailableoutputshavealreadybeencheckedSet<String>outputsChecked=status.outputsChecked;
if((outputs!=null)&&(outputsChecked.size()<outputs.size())){for(Entry<String,Object>entry:outputs.entrySet()){Objectoutput=entry.getValue();
if((output!=null)&&outputsChecked.add(entry.getKey())&&(outputinstanceofGridCoverage)){resourceManager.addResource(newGridCoverageResource((GridCoverage)output));
if(bandIndexChar!=-1){coverageName=coverage.substring(0,bandIndexChar);bandIndex=coverage.substring(bandIndexChar+1,coverage.length());
if(property==NAME){returnworkspaceLink(id,itemModel);
else
if(property==DEFAULT){
if(getCatalog().getDefaultWorkspace().equals(itemModel.getObject()))returnnewIcon(id,CatalogIconFactory.ENABLED_ICON);
elsereturnnewLabel(id,"");
else
if(property==ISOLATED){
if(itemModel.getObject().isIsolated())returnnewIcon(id,CatalogIconFactory.ENABLED_ICON);
elsereturnnewLabel(id,"");
if(response.getStatus()==200){Documentdom=getAsDOM(restPath,200);ByteArrayOutputStreambaos=newByteArrayOutputStream();//print(dom);print(dom,baos);assertTrue(baos.toString().indexOf("<featureTypeStyles>")>0);//checkColorMap(baos.toString(),5);
ifthecomponentisthere,butnotvisibleassertNull(tester.getComponentFromLastRenderedPage("selectLayersContainer:selectLayers"));//selectthefirstdatastoretester.newFormTester("selector").select("storesDropDown",1);tester.executeAjaxEvent("selector:storesDropDown","change");//nowitshouldbethereassertNotNull(tester.getComponentFromLastRenderedPage("selectLayersContainer:selectLayers"));//select"chooseone"item(unselecttheform)tester.newFormTester("selector").setValue("storesDropDown","");tester.executeAjaxEvent("selector:storesDropDown","change");//nowitshouldbethereassertNull(tester.getComponentFromLastRenderedPage("selectLayersContainer:selectLayers"));
if(i%100==0){longcurr=System.currentTimeMillis();LOGGER.info(i+"-"+(curr-start));start=curr;
ifnone*@paramexpectedBuildings*/privatevoidcheckPropertyIsLikeMatchCase(BooleanmatchCase,intexpectedBuildings)throwsException{//@formatter:offStringxml="<wfs:GetFeatureservice=\"WFS\"version=\"2.0.0\""+"xmlns:wfs=\"http://www.opengis.net/wfs/2.0\""+"xmlns:fes=\"http://www.opengis.net/fes/2.0\""+"xmlns:cite=\"http://www.opengis.net/cite\">"+"<wfs:QuerytypeNames=\"cite:Buildings\">"+"<fes:Filter>"+"<fes:PropertyIsLikewildCard=\"*\"singleChar=\"%\"escapeChar=\"!\""+(matchCase==null?"":"matchCase=\""+matchCase+"\"")+">"+"<fes:ValueReference>cite:ADDRESS</fes:ValueReference>"+"<fes:Literal>*MAINSTREET</fes:Literal>"+"</fes:PropertyIsLike>"+"</fes:Filter>"+"</wfs:Query>"+"</wfs:GetFeature>";//@formatter:onDocumentdoc=postAsDOM("wfs",xml);assertEquals("wfs:FeatureCollection",doc.getDocumentElement().getNodeName());assertEquals(expectedBuildings,doc.getElementsByTagName("cite:Buildings").getLength());
if(infoinstanceofFeatureTypeInfo){FeatureTypeInfofeatureType=(FeatureTypeInfo)info;returnnewVector(featureType,dimensionInfo.getAttribute(),dimensionInfo.getEndAttribute(),acceptableRange,dataType);
else
if(infoinstanceofCoverageInfo){GridCoverageReaderreader=((CoverageInfo)info).getGridCoverageReader(null,null);
if(readerinstanceofStructuredGridCoverage2DReader&&ENABLE_STRUCTURED_READER_SUPPORT){StructuredGridCoverage2DReaderstructured=(StructuredGridCoverage2DReader)reader;DimensionDescriptordd=getDimensionDescriptor(structured,dimensionName);returnnewStructuredReader(structured,dd.getStartAttribute(),dd.getEndAttribute(),acceptableRange,dataType);
else
if(readerinstanceofGridCoverage2DReader){returnnewReader((GridCoverage2DReader)reader,acceptableRange,dimensionName,dataType);
if(dimensionName.equalsIgnoreCase(ResourceInfo.TIME)){returnDate.class;
else
if(dimensionName.equalsIgnoreCase(ResourceInfo.ELEVATION)){returnDouble.class;
ifit'sacustomedimensiondocustomlogicbasedontheresourceinfo,e.g.pickthe//attributes//fromfeaturetype/structuredreadersandusestringsforanything
elsethrownewIllegalArgumentException("Dimension"+dimensionName+"notsupportedfornearestmatchyet");
ifthedomainismadeofranges(theWMSspecseemsto*indicateainstantvalueneedstobeusedfortheusedtimeinwarning**@paramvalueThereferencevalue*@returnThenearestvalue,ornull
ifthedomainwasempty.Ifthenearestvalue*matches/overlapstheoriginalvalue,thentheoriginaloneisreturnedinstead(this*allowstotellapartnomatchvsexactmatchvsnearestmatchandeventuallysettheWMS*HTTPwarninghead)*@throwsIOException*/publicObjectgetNearest(Objectvalue)throwsIOException{//simplepointvspointcomparison?
if(endAttribute==null&&(!(valueinstanceofRange)||((Range)value).getMinValue().equals(((Range)value).getMaxValue()))){Datedate=(Date)(valueinstanceofRange?((Range)value).getMinValue():value);NearestVisitorvisitor=newNearestVisitor(attribute,date);Filterfilter=Filter.INCLUDE;
if(acceptableRange!=null){RangesearchRange=acceptableRange.getSearchRange(date);filter=FF.between(attribute,FF.literal(searchRange.getMinValue()),FF.literal(searchRange.getMaxValue()));
if(date.equals(result)){returnvalue;
else{returnresult;
else{//findthehighestamongthelowervaluesFilterlowerFilter=buildComparisonFilter(value,HIGHEST_AMONG_LOWERS);FeatureCollectionlowers=getMatches(lowerFilter);MaxVisitorlowersVisitor=newMaxVisitor(endAttribute==null?attribute:endAttribute);lowers.accepts(lowersVisitor,null);ComparablemaxOfSmallers=(Comparable)lowersVisitor.getResult().getValue();//findthelowestamongthehighervaluesFilterhigherFilter=buildComparisonFilter(value,LOWEST_AMONG_HIGHER);FeatureCollectionhighers=getMatches(higherFilter);MinVisitorhighersVisitor=newMinVisitor(attribute);highers.accepts(highersVisitor,null);ComparableminOfGreater=(Comparable)highersVisitor.getResult().getValue();returnclosest(value,maxOfSmallers,minOfGreater);
if(maxOfSmallersinstanceofRange){maxOfSmallers=((Range)maxOfSmallers).getMaxValue();
if(minOfGreaterinstanceofRange){minOfGreater=((Range)minOfGreater).getMinValue();
if(maxOfSmallers==null){
if(minOfGreater==null){//thereisnomatchresult=null;
else{result=minOfGreater;
else{
if(minOfGreater==null){result=maxOfSmallers;
else{
if(valueinstanceofRange){Rangerange=(Range)value;Objectmin=range.getMinValue();Objectmax=range.getMaxValue();doubledistanceBelow=distance(min,maxOfSmallers);doubledistanceAbove=distance(max,minOfGreater);result=distanceBelow<distanceAbove?maxOfSmallers:minOfGreater;
else{doubledistanceBelow=distance(value,minOfGreater);doubledistanceAbove=distance(value,maxOfSmallers);result=distanceBelow<distanceAbove?minOfGreater:maxOfSmallers;
if(resultinstanceofRange){
if(result==minOfGreater){return((Range)result).getMaxValue();
else{return((Range)result).getMinValue();
else{returnresult;
if(Number.class.isAssignableFrom(dataType)){Numberna=(Number)a;Numbernb=(Number)b;returnMath.abs(na.doubleValue()-nb.doubleValue());
else
if(Date.class.isAssignableFrom(dataType)){Dateda=(Date)a;Datedb=(Date)b;returnMath.abs(da.getTime()-db.getTime());
else{thrownewIllegalArgumentException("Nearestcalculationsondatatype"+dataType+"arenotsupported");
if(valueinstanceofRange){Rangerange=(Range)value;Literalqlower=FF.literal(range.getMinValue());Literalqupper=FF.literal(range.getMaxValue());returnbuildComparisonFilter(direction,qlower,qupper);
else{LiteralvalueReference=FF.literal(value);returnbuildComparisonFilter(direction,valueReference,valueReference);
if(direction==HIGHEST_AMONG_LOWERS){
if(acceptableRange!=null){RangesearchRange=acceptableRange.getSearchRange(qlower.getValue());returnFF.between(comparisonAttribute,FF.literal(searchRange.getMinValue()),qlower);
else{returnFF.lessOrEqual(comparisonAttribute,qlower);
else{
if(acceptableRange!=null){RangesearchRange=acceptableRange.getSearchRange(qupper.getValue());returnFF.between(comparisonAttribute,qupper,FF.literal(searchRange.getMaxValue()));
else{returnFF.greaterOrEqual(comparisonAttribute,qupper);
if(endAttribute!=null&&direction==HIGHEST_AMONG_LOWERS){returnendAttribute;
else{returnattribute;
if(domain.isEmpty()){returnnull;
if(!rangeFilterAccepts(rangeFilter,d)){continue;
if(result<0){maxOfSmallers=d;
else
if(result==0){//straightmatch,usetheoriginalvaluereturnvalue;
else{//weswitchedtohigher,endofsearchminOfGreater=d;break;
if(rangeFilter==null){returntrue;
if(domainValueinstanceofRange){returnrangeFilter.intersects((Range)domainValue);
else{returnrangeFilter.contains((Comparable)domainValue);
if(!(ainstanceofRange)){
if(!(binstanceofRange)){return((Comparable)a).compareTo(b);
else{//reversecomparisonreturncompare((Range)b,a)*-1;
else
if(ainstanceofRange){
if(binstanceofRange){Rangera=(Range)a;Rangerb=(Range)b;
if(ra.intersects(rb)){return0;
else
if(ra.getMinValue().compareTo(rb.getMaxValue())>=0){return1;
else{return-1;
else{returncompare((Range)a,b);
if(ra.getMinValue().compareTo(b)>0){//aisgreaterthanbreturn1;
else
if(ra.getMaxValue().compareTo(b)<0){//aislowerthanbreturn-1;
else{//acontainsbthen?return0;
if(ResourceInfo.TIME.equals(dimensionName)){returnaccessor.getTimeDomain();
else{thrownewIllegalArgumentException("Nearestmatchsupportonsimplegridreadersissupportedonly"+"fortimeatthemoment");
if(typeOfBlobStore.getModelObject()!=null){blobStoreForm.getModel().setObject(typeOfBlobStore.getModelObject().newConfigObject());blobStoreForm.addOrReplace(typeOfBlobStore.getModelObject().createPanel("blobSpecificPanel",blobStoreForm.getModel()));
if(originalStore!=null){typeOfBlobStore.getModel().setObject(BlobStoreTypes.getFromClass(originalStore.getClass()));blobStoreForm.addOrReplace(typeOfBlobStore.getModelObject().createPanel("blobSpecificPanel",blobStoreForm.getModel()));typeOfBlobStore.setEnabled(false);for(TileLayerlayer:GWC.get().getTileLayers()){
if(originalStore.getName().equals(layer.getBlobStoreId())){assignedLayers.add(layer.getName());
if(blobStore.isDefault()&&!cbDefault.getConvertedInput()){form.error(newParamResourceModel("defaultError",getPage()).getString());
else
if(cbDefault.getConvertedInput()&&!cbEnabled.getConvertedInput()){form.error(newParamResourceModel("enabledError",getPage()).getString());
if(otherBlobStore!=originalStore&&otherBlobStore.getName().equals(tfId.getConvertedInput())){form.error(newParamResourceModel("duplicateIdError",getPage()).getString());
if(originalStore!=null&&originalStore.isEnabled()&&!blobStore.isEnabled()&&assignedLayers.size()>0){dialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){privatestaticfinallongserialVersionUID=5257987095800108993L;privatebooleansuccess;privateStringerror=null;@OverrideprotectedComponentgetContents(Stringid){StringBuildersb=newStringBuilder();sb.append(newParamResourceModel("confirmDisableDialog.content",getPage()).getString());for(Stringlayer:assignedLayers){sb.append("\n&nbsp;&nbsp;");sb.append(escapeHtml(layer));
if(success){doReturn(BlobStoresPage.class);
else
if(error!=null){error(error);addFeedbackPanels(target);
else{try{save(originalStore,blobStore,assignedLayers);doReturn(BlobStoresPage.class);
ifnecessaryBlobStoreInfodefaultStore=null;
if(blobStore.isDefault()&&(originalStore==null||!originalStore.isDefault())){defaultStore=GWC.get().getDefaultBlobStore();
if(defaultStore!=null){defaultStore.setDefault(false);GWC.get().modifyBlobStore(defaultStore.getName(),defaultStore);
if(originalStore==null){GWC.get().addBlobStore(blobStore);
else{GWC.get().modifyBlobStore(originalStore.getName(),blobStore);
if(defaultStore!=null){defaultStore.setDefault(true);GWC.get().modifyBlobStore(defaultStore.getName(),defaultStore);
ifnecessary
if(originalStore!=null){booleanupdateId=!blobStore.getName().equals(originalStore.getName());booleandisable=originalStore.isEnabled()&&!blobStore.isEnabled();
if(updateId||disable){for(StringlayerName:assignedLayers){TileLayerlayer=GWC.get().getTileLayerByName(layerName);
if(updateId){layer.setBlobStoreId(blobStore.getName());
if(disable){layer.setEnabled(false);
if(properties.containsKey(key)){PointSymbolizerptSym=origRule.symbolizers.get(symbIdx);resultSymbolizers.add(injectPointSymbolizer(key,ptSym));
if(original.getGraphic()!=null){copy.setGraphic(injectGraphic(key,original.getGraphic()));
if(shouldUpdate(key+".opacity",opacity)){opacity=getLiteral(key+".opacity");
if(shouldUpdate(key+".rotation",rotation)){rotation=getLiteral(key+".rotation");
if(shouldUpdate(key+".size",size)){size=getLiteral(key+".size");
if(!original.graphicalSymbols().isEmpty()){List<Mark>markList=newArrayList<Mark>();List<ExternalGraphic>externalGraphicList=newArrayList<ExternalGraphic>();for(GraphicalSymbolsymbol:original.graphicalSymbols()){
if(symbolinstanceofMark){markList.add(injectMark(key,(Mark)symbol));
else
if(symbolinstanceofExternalGraphic){externalGraphicList.add(injectExternalGraphic(key,(ExternalGraphic)symbol));
else{marks=newMark[0];externalGraphics=newExternalGraphic[0];
if(original.getLocation()==null){locationExpression=null;
else{locationExpression=ExpressionExtractor.extractCqlExpressions(original.getLocation().toExternalForm());
if(locationExpression==null||isStatic(locationExpression)){location=original.getLocation();
else{location=newURL(properties.get(key+".url"));
if(mark.getWellKnownName()==null||isStatic(mark.getWellKnownName())){wellKnownName=mark.getWellKnownName();
else{wellKnownName=getLiteral(key+".name");
if(mark.getFill()==null){fill=null;
else{fill=injectFill(key+".fill",mark.getFill());
if(mark.getStroke()==null){stroke=null;
else{stroke=injectStroke(key+".stroke",mark.getStroke());
if(stroke.getColor()==null||isStatic(stroke.getColor())){color=stroke.getColor();
else{color=getLiteral(key+".color");
if(stroke.getDashOffset()==null||isStatic(stroke.getDashOffset())){dashOffset=stroke.getDashOffset();
else{dashOffset=getLiteral(key+".linecap");
if(stroke.getLineCap()==null||isStatic(stroke.getDashOffset())){lineCap=stroke.getLineCap();
else{lineCap=getLiteral(key+".linecap");
if(stroke.getLineJoin()==null||isStatic(stroke.getLineJoin())){lineJoin=stroke.getLineJoin();
else{lineJoin=getLiteral(key+".linejoin");
if(stroke.getOpacity()==null||isStatic(stroke.getOpacity())){opacity=stroke.getOpacity();
else{opacity=getLiteral(key+".opacity");
if(stroke.getWidth()==null||isStatic(stroke.getWidth())){width=stroke.getOpacity();
else{width=getLiteral(key+".opacity");
if(stroke.getGraphicStroke()==null){graphicStroke=null;
else{graphicStroke=injectGraphic(key+".graphic",stroke.getGraphicStroke());
if(stroke.getGraphicFill()==null){graphicFill=null;
else{graphicFill=injectGraphic(key+".graphic",stroke.getGraphicFill());
if(stroke.getDashArray()==null){dashArray=null;
else{dashArray=Arrays.copyOf(stroke.getDashArray(),stroke.getDashArray().length);
if(fill.getColor()==null||isStatic(fill.getColor())){color=fill.getColor();
else{color=getLiteral(key+".color");
if(fill.getOpacity()==null||isStatic(fill.getOpacity())){opacity=fill.getOpacity();
else{opacity=getLiteral(key+".opacity");
if(fill.getGraphicFill()==null){graphicFill=null;
else{graphicFill=injectGraphic(key+".graphic",fill.getGraphicFill());
ifthisreaderclassisreallynecessary**@authorAlessioFabiani,GeoSolutions*/publicclassWcs10DescribeCoverageKvpRequestReaderextendsEMFKvpRequestReader{privateCatalogcatalog;publicWcs10DescribeCoverageKvpRequestReader(Catalogcatalog){super(DescribeCoverageType.class,Wcs10Factory.eINSTANCE);this.catalog=catalog;
ifnotspecified,throwaresoundingexception(byspec)
if(!describeCoverage.isSetVersion())thrownewWcsException("Versionhasnotbeenspecified",WcsExceptionCode.MissingParameterValue,"version");returnrequest;}}
if(committed){Stringhandle=request.getHandle();Authenticationauth=SecurityContextHolder.getContext().getAuthentication();Stringuser=(auth!=null)?auth.getName():null;Map<String,Map<String,Object>>lcrs=layersChangesResume.get();for(Stringlayer:lcrs.keySet()){Map<String,Object>prop=lcrs.get(layer);Objectft=prop.remove(TYPE);Notificationn=newNotificationImpl(Notification.Type.Data,handle,null,ft,prop,user);notify(n);
if(properties==null){properties=newHashMap<String,Object>();properties.put(TYPE,info);map.put(featureTypeName,properties);
if(eventType==TransactionEventType.POST_INSERT){Integerinserted=properties.get(INSERTED)!=null?(Integer)properties.get(INSERTED):0;properties.put(INSERTED,inserted+affectedFeatures);
if(eventType==TransactionEventType.POST_UPDATE){Integerinserted=properties.get(UPDATED)!=null?(Integer)properties.get(UPDATED):0;properties.put(UPDATED,inserted+affectedFeatures);
if(eventType==TransactionEventType.PRE_DELETE){Integerinserted=properties.get(DELETED)!=null?(Integer)properties.get(DELETED):0;properties.put(DELETED,inserted+affectedFeatures);
if(properties.get(BOUNDS)!=null){featureBound.expandToInclude(((Bounds)properties.get(BOUNDS)).getBb());
iftheheadercontributionshouldapplytoaparticularpageornot.**<p>Thisimplementationalwaysreturnstrue,
ifclientsneedamoreflexiblemechanismfor*determiningwhichpagesapplytheyshouldsubclassandoverridethismethod.*/publicbooleanappliesTo(WebPagepage){returntrue;
ifthereisno*csscontribution.*/publicPackageResourceReferencegetCSS(){
if(scope!=null&&cssFilename!=null){returnnewPackageResourceReference(scope,cssFilename);
if*thereisnojavascriptcontribution.*/publicPackageResourceReferencegetJavaScript(){
if(scope!=null&&javaScriptFilename!=null){returnnewPackageResourceReference(scope,javaScriptFilename);
ifthereisnofaviconreplacement*/publicPackageResourceReferencegetFavicon(){
if(scope!=null&&faviconFilename!=null){returnnewPackageResourceReference(scope,faviconFilename);
if(type==TransactionEventType.PRE_INSERT){input.preInsert(event);
else
if(type==TransactionEventType.POST_INSERT){input.postInsert(event);
else
if(type==TransactionEventType.PRE_UPDATE){input.preUpdate(event);
else
if(type==TransactionEventType.POST_UPDATE){input.postUpdate(event);
else
if(type==TransactionEventType.PRE_DELETE){input.preDelete(event);
else{//TODO:POST_DELETE
if(details==null){details=newTransactionDetail();context.put(TransactionDetail.class,details);
if(delegate==null){synchronized(this){delegate=delegates.get(f);
if(delegate==null){delegate=newScriptTxDelegate(f,scriptMgr);delegates.put(f,delegate);
ifnoIDisrequested");
if(policy.getLimits()instanceofVectorAccessLimits){List<PropertyName>properties=((VectorAccessLimits)policy.getLimits()).getReadAttributes();
if(properties==null){this.readSchema=getSchema();
else{List<String>names=newArrayList<String>();for(PropertyNameproperty:properties){names.add(property.getPropertyName());
else{this.readSchema=getSchema();
if(canDelegate(visitor)){delegate.accepts(visitor,progress);
else{super.accepts(visitor,progress);
if(configuration.isEmpty()){initDefaults();
if(topicName.equalsIgnoreCase("VirtualTopic.>")){//overridetopicnamewiththedefaulttopicnameconfiguration.put(TopicConfiguration.TOPIC_NAME_KEY,TopicConfiguration.DEFAULT_TOPIC_NAME);storeConfig();
ifconfigurationischanged(sincelastboot)storechanges//ondiskbooleanoverride=override();
if(exts!=null){for(JMSConfigurationExtext:exts){override|=ext.override(this);
if(override){storeConfig();
if(exts!=null){for(JMSConfigurationExtext:exts){ext.initDefaults(this);
ifinstancenameischangedsincelastapplicationboot,
ifsosettheoverriddenvalue*intoconfigurationandreturnstrue**@returntrue
ifsomeparameterisoverriddenbyanExtensionproperty*/publicbooleanoverride(){returnoverride(INSTANCE_NAME_KEY,UUID.randomUUID().toString());
ifinstancenameischangedsincelastapplicationboot,
ifsosettheoverriddenvalue*intoconfigurationandreturnstrue*/publicfinalbooleanoverride(StringnameKey,ObjectdefaultVal){booleanoverride=false;finalStringovrName=getOverride(nameKey);
if(ovrName!=null){finalStringname=configuration.getProperty(nameKey);
if(name!=null&&!name.equals(ovrName)){override=true;
else{finalStringname=configuration.getProperty(nameKey);//noconfigurationfoundsetupdefaultsandreturnoverride==true
if(name==null){override=true;configuration.put(nameKey,defaultVal);
ifoverrideisset,nullotherwise*/publicstatic<T>TgetOverride(finalStringtheName){return(T)ApplicationProperties.getProperty(theName);
if(tempPath==null){returnnull;
if(tempDir.exists()==false)returnnull;
if(tempDir.isDirectory()==false)returnnull;
if(tempDir.canWrite()==false)returnnull;returntempDir;}}
if(configDirPath==null){System.clearProperty(GeoserverXMLResourceProvider.GEOWEBCACHE_CONFIG_DIR_PROPERTY);
else{System.setProperty(GeoserverXMLResourceProvider.GEOWEBCACHE_CONFIG_DIR_PROPERTY,configDirPath);
if(cacheDirPath==null){System.clearProperty(GeoserverXMLResourceProvider.GEOWEBCACHE_CACHE_DIR_PROPERTY);
else{System.setProperty(GeoserverXMLResourceProvider.GEOWEBCACHE_CACHE_DIR_PROPERTY,cacheDirPath);
if(layerInfo==null){LayerGroupInfogroupInfo=wms.getLayerGroupByName(layerName);
if(groupInfo==null||LayerGroupInfo.Mode.CONTAINER.equals(groupInfo.getMode())){thrownewServiceException(layerName+":nosuchlayeronthisserver","LayerNotDefined",getClass().getSimpleName());
else{
if(skipResource(groupInfo))continue;for(LayerInfoli:groupInfo.layers()){
if(skipResource(li))continue;layer=newMapLayerInfo(li);layers.add(layer);
else{
if(skipResource(layerInfo))continue;layer=newMapLayerInfo(layerInfo);layers.add(layer);
if(info==null){thrownewResourceNotFoundException("Nosuchcoveragestore:"+workspaceName+","+storeName);
if(readerinstanceofStructuredGridCoverage2DReader){StructuredGridCoverage2DReadersr=(StructuredGridCoverage2DReader)reader;
if(sr.isReadOnly()){thrownewRestException("Coveragestorefound,butitcannotharvestextraresources",HttpStatus.METHOD_NOT_ALLOWED);
else{thrownewRestException("Coveragestorefound,butitdoesnotsupportresourceharvesting",HttpStatus.METHOD_NOT_ALLOWED);
if(info==null){//createanewcoveragestoreLOGGER.info("Auto-configuringcoveragestore:"+storeName);info=builder.buildCoverageStore(storeName);add=true;
else{//usetheexistingLOGGER.info("Usingexistingcoveragestore:"+storeName);
if(method.isInline()){//TODO:createamethodtofigureouttherelativeurlinsteadofmakingassumption//aboutthestructureStringdefaultRoot="/data/"+workspaceName+"/"+storeName;StringBuilderurlBuilder;try{urlBuilder=newStringBuilder(Resources.find(uploadedFile).toURI().toURL().toString());
if(uploadedFile.getType()==Type.DIRECTORY&&uploadedFile.name().equals(storeName)){intdef=urlBuilder.indexOf(defaultRoot);
if(def>=0){url="file:data/"+workspaceName+"/"+storeName;
else{url=urlBuilder.toString();
else{intdef=urlBuilder.indexOf(defaultRoot);
if(def>=0){StringitemPath=urlBuilder.substring(def+defaultRoot.length());url="file:data/"+workspaceName+"/"+storeName+itemPath;
else{url=urlBuilder.toString();
if(url.contains("+")){url=url.replace("+","%2B");
if(url.contains("")){url=url.replace("","%20");
else{info.setURL(uploadedFileURL.toExternalForm());
if(add){
if(!catalog.validate(info,true).isValid()){thrownewRuntimeException("Validationfailed");
else{
if(!catalog.validate(info,false).isValid()){thrownewRuntimeException("Validationfailed");
ifsettononetonottrytoconfigurecoverage
if("none".equalsIgnoreCase(configure)){returnnull;
if(reader==null){thrownewRestException("Couldnotaquirereaderforcoverage.",HttpStatus.INTERNAL_SERVER_ERROR);
if(useJaiImageRead!=null){customParameters.put(AbstractGridFormat.USE_JAI_IMAGEREAD.getName().toString(),useJaiImageRead);
ifthenameofthecoveragewasspecifiedString[]names=reader.getGridCoverageNames();
if(names.length>1&&coverageName!=null){thrownewRestException("Thereaderfoundmorethanonecoverage,"+"coverageNamecannotbeusedinthiscase(itwouldgenerate"+"thesamenameforallcoveragesfound",HttpStatus.BAD_REQUEST);
if(names.length>1){for(Stringname:names){SingleGridCoverage2DReadersingleReader=newSingleGridCoverage2DReader(reader,name);configureCoverageInfo(builder,info,add,name,name,singleReader,customParameters);
else{configureCoverageInfo(builder,info,add,names[0],coverageName,reader,customParameters);
if(reader!=null){try{reader.dispose();
if(coverageFormatName==null){thrownewRestException("Unsupportedformat:"+format+",availableformatsare:"+FORMAT_LOOKUP.keySet().toString(),HttpStatus.BAD_REQUEST);
if(coverageName!=null){cinfo.setName(coverageName);
if(nativeName!=null){cinfo.setNativeCoverageName(nativeName);
if(!add){//updatetheexistingStringname=coverageName!=null?coverageName:nativeName;CoverageInfoexisting=catalog.getCoverageByCoverageStore(storeInfo,name);
if(existing==null){//grabthefirst
ifthereisonlyoneList<CoverageInfo>coverages=catalog.getCoveragesByCoverageStore(storeInfo);//singlecoveragereader?
if(coverages.size()==1&&coverages.get(0).getNativeName()==null){existing=coverages.get(0);
ifwehaveitornot
if(coverages.size()==0){//nocoveragesyetconfigured,changeaddflagandcontinueonadd=true;
else{for(CoverageInfoci:coverages){
if(ci.getNativeName().equals(name)){existing=ci;
if(existing==null){add=true;
if(existing!=null){builder.updateCoverage(existing,cinfo);catalog.validate(existing,false).throwIfInvalid();catalog.save(existing);cinfo=existing;
ifsrsisnotknownorunset,transformto4326
if("UNKNOWN".equals(cinfo.getSRS())){cinfo.setSRS("EPSG:4326");
if(add){catalog.validate(cinfo,true).throwIfInvalid();catalog.add(cinfo);LayerInfolayerInfo=builder.buildLayer(cinfo);booleanvalid=true;try{
if(!catalog.validate(layerInfo,true).isValid()){valid=false;
else{catalog.save(cinfo);
iftheformatacceptsawholedirectory
if(coverageFormat.accepts(directory.dir())){returndirectory;
if(f.getType()==Type.DIRECTORY){Resourceresult=findPrimaryFile(f,format);
if(result!=null){returnresult;
else{
if(coverageFormat.accepts(f.file())){returnf;
if(method.isInline()){//Mappingoftheinputdirectory
if(method==UploadMethod.url){//ForURLuploadmethod,workspaceandStoreNamearenotconsidereddirectory=createFinalRoot(null,null,postRequest);
else{directory=createFinalRoot(workspaceName,storeName,postRequest);
iftheRequestisaPOSTrequest,inordertosearchforanexistingcoverageResourcedirectory=null;
if(isPost&&storeName!=null){//Check
ifthecoveragealreadyexistsCoverageStoreInfocoverage=catalog.getCoverageStoreByName(storeName);
if(coverage!=null){
if(workspaceName==null||coverage.getWorkspace().getName().equalsIgnoreCase(workspaceName)){//IfthecoverageexiststhentheassociateddirectoryisdefinedbyitsURLdirectory=Resources.fromPath(URLs.urlToFile(newURL(coverage.getURL())).getPath(),catalog.getResourceLoader().get(""));
if(directory==null){directory=catalog.getResourceLoader().get(Paths.path("data",workspaceName,storeName));
if(contextinstanceofWebApplicationContext){WebApplicationContextwebContext=(WebApplicationContext)context;webContext.getServletContext().setAttribute(key,object);
if(tempDir.mkdir()){returntempDir;
ifpresentStringname;
if(filename!=null&&!filename.isEmpty()){name=filename;
else
if(!layerz.isEmpty()){StringfirstLayer=layerz.iterator().next();name=firstLayer.substring(firstLayer.lastIndexOf(":")+1);
else{thrownewProcessException("Layersparameterisempty");
if(styleNames!=null&&styleNames.size()!=layerz.size()){thrownewProcessException("LayersandstyleNamesmusthavethesamesize");
ifpresentfinalFilefile;StringoutputResourceName=name+".mbtiles";
if(path!=null){FileurlToFile=URLs.urlToFile(path);urlToFile.mkdirs();file=newFile(urlToFile,outputResourceName);
else{finalResourceresource=resources.getOutputResource(null,outputResourceName);file=resource.file();
if(layerInfo==null){thrownewServiceException("Layernotfound:"+layername);
ifnotpresent
if(boundingbox==null){try{//generateonefromrequestslayersReferencedEnvelopebbox=null;for(MapLayerInfol:request.getLayers()){ResourceInfor=l.getResource();//usenativebboxReferencedEnvelopeb=r.getNativeBoundingBox();
if(bbox!=null){//transformb=b.transform(bbox.getCoordinateReferenceSystem(),true);
if(bbox!=null){bbox.include(b);
else{bbox=b;
else{request.setBbox(boundingbox);
if(crs==null){//usecrsofthelayerResourceInfor=request.getLayers().iterator().next().getResource();crs=r.getCRS();request.setCrs(crs);
else{request.setCrs(crs);
if(bgColor!=null&&!bgColor.isEmpty()){request.setBgColor(Color.decode(bgColor));
if(stylePath!=null){request.setStyleUrl(stylePath);
else
if(styleBody!=null&&!styleBody.isEmpty()){request.setStyleBody(styleBody);
else{request.setStyles(newArrayList<Style>());
if(styleNames!=null&&!styleNames.isEmpty()){for(StringstyleName:styleNames){StyleInfoinfo=catalog.getStyleByName(styleName);
if(info!=null){request.getStyles().add(info.getStyle());
else{request.getStyles().add(null);
if(request.getStyles().isEmpty()){for(MapLayerInfoinfo:request.getLayers()){request.getStyles().add(info.getDefaultStyle());
ifpresent
if(minZoom!=null){formatOptions.put("min_zoom",minZoom);
if(maxZoom!=null){formatOptions.put("max_zoom",maxZoom);
if(minColumn!=null){formatOptions.put("min_column",minColumn);
if(maxColumn!=null){formatOptions.put("max_column",maxColumn);
if(minRow!=null){formatOptions.put("min_row",minRow);
if(maxRow!=null){formatOptions.put("max_row",maxRow);
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.log(Level.SEVERE,e.getMessage(),e);
if(mbtile!=null){try{mbtile.close();
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.log(Level.SEVERE,e.getMessage(),e);
ifitisatemporaryfile
if(path!=null){returnURLs.fileToUrl(file);
else{returnnewURL(resources.getOutputResourceUrl(outputResourceName,"application/x-mbtiles"));
if(mpProviders.contains("default2")){MasterPasswordProviderConfigdefault2=getSecurityManager().loadMasterPassswordProviderConfig("default2");getSecurityManager().removeMasterPasswordProvder(default2);
if(!(objinstanceofDataStoreInfo)){returnfalse;
if(user==null){returnnull;
if(wal!=null){returnwal;
else{returndefaultWorkspaceAccessLimits;
if(user==null){returnnull;
if(limits==null){limits=getAccessLimits(user,layer.getResource());
if(user==null){returnnull;
if(user==null){returnnull;
if(user==null){returnnull;
if(userMap==null){userMap=newHashMap<String,AccessLimits>();limits.put(userName,userMap);
if(len<0)returnendOfData();
if(len!=20)thrownewIllegalStateException("Weneeda'readFully'operation!");returnformats.read(newObjectId(id),bytes);
if(property==GeofenceAdminRulesModel.BUTTONS){returnnewButtonPanel(id,(ShortAdminRule)itemModel.getObject());
if(location==null||!(location.getComponent().getDefaultModel().getObject()instanceofShortAdminRule)){return;
if(movedRule.getId().equals(targetRule.getId())){return;
if(movedRule.getPriority()<targetRule.getPriority()){movedRule.setPriority(targetRule.getPriority()+1);
else{movedRule.setPriority(targetRule.getPriority());
if(rulesModel.canUp(rule)){tag.put("style","visibility:visible");
else{tag.put("style","visibility:hidden");
if(rulesModel.canDown(rule)){tag.put("style","visibility:visible");
else{tag.put("style","visibility:hidden");
if*namesearchedforisnotnamespacequalified,thenamatchonthelocalpartisattemptedtoo*/publicclassRecordDescriptorsMapextendsLinkedHashMap<Name,RecordDescriptor>{privatestaticfinallongserialVersionUID=335115347101959746L;publicRecordDescriptorget(Objectkey){
if(!(keyinstanceofName)){returnnull;
if(descriptor==null&&name.getNamespaceURI()==null){//relaxedmatch,see
ifwecanfindtherecordwithoutthenamespacefor(Map.Entry<Name,RecordDescriptor>entry:entrySet()){
if(entry.getKey().getLocalPart().equals(name.getLocalPart())){returnentry.getValue();
if(localClass==null){returnresultClassDescriptor;
if(localClassDescriptor!=null){//only
ifclassimplementsserializablefinallonglocalSUID=localClassDescriptor.getSerialVersionUID();finallongstreamSUID=resultClassDescriptor.getSerialVersionUID();
if(streamSUID!=localSUID){//checkforserialVersionUIDmismatch.finalStringBuffers=newStringBuffer("Overridingserializedclassversionmismatch:");s.append("localserialVersionUID=").append(localSUID);s.append("streamserialVersionUID=").append(streamSUID);Exceptione=newInvalidClassException(s.toString());e.printStackTrace();resultClassDescriptor=localClassDescriptor;//Uselocalclassdescriptorfordeserialization
if(!controller.requestIncoming(request,timeout)){state=ThreadState.TIMED_OUT;return;
ifavailable
if(waitLatch!=null){System.out.println(this+"waitingonwaitlatch");waitLatch.await();
if(processingDelay>0){sleep(processingDelay);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;Resourceother=(Resource)obj;
if(path==null){
if(other.path()!=null)returnfalse;
else
if(!path.equals(other.path()))returnfalse;returntrue;
if(att.isPk()&&att.isUse()){pkSet=true;
if(Geometry.class.isAssignableFrom(att.getType())&&att.isUse()){geomSet=true;
if(att.getSrid()!=null){sridSet=true;
if(!pkSet){error(newParamResourceModel("pkEmptyFailure",SolrConfigurationPage.this).getString());
if(!geomSet){error(newParamResourceModel("geomEmptyFailure",SolrConfigurationPage.this).getString());
else
if(!sridSet){error(newParamResourceModel("sridEmptyFailure",SolrConfigurationPage.this).getString());
if(!pkSet||!geomSet||!sridSet){target.add(feedbackPanel);return;
if(solrLayerConfiguration!=null){for(SolrAttributeatt:solrLayerConfiguration.getAttributes()){tempMap.put(att.getName(),att);
else{tempMap.clear();solrLayerConfiguration=newSolrLayerConfiguration(newArrayList<SolrAttribute>());solrLayerConfiguration.setLayerName(ri.getName());ri.getMetadata().put(SolrLayerConfiguration.KEY,solrLayerConfiguration);
if(tempMap.containsKey(at.getName())){SolrAttributeprev=tempMap.get(at.getName());prev.setEmpty(at.getEmpty());at=prev;
if(property==SolrAttributeProvider.PK){
if(isPK){Fragmentf=newFragment(id,"checkboxPk",SolrConfigurationPage.this);f.add(newCheckBox("pk",newPropertyModel<Boolean>(itemModel,"pk")));returnf;
else{Fragmentf=newFragment(id,"empty",SolrConfigurationPage.this);returnf;
else
if(property==SolrAttributeProvider.NAME&&(isGeometry||isPK)){Fragmentf=newFragment(id,"label",SolrConfigurationPage.this);f.add(newLabel("label",((SolrAttribute)itemModel.getObject()).getName()+"*"));returnf;
else
if(property==SolrAttributeProvider.TYPE&&isGeometry){Fragmentf=newFragment(id,"geometry",SolrConfigurationPage.this);f.add(newDropDownChoice("geometry",newPropertyModel(itemModel,"type"),GEOMETRY_TYPES,newGeometryTypeRenderer()));returnf;
else
if(property==SolrAttributeProvider.USE){Fragmentf=newFragment(id,"checkboxUse",SolrConfigurationPage.this);f.add(newCheckBox("use",newPropertyModel<Boolean>(itemModel,"use")));returnf;
else
if(property==SolrAttributeProvider.EMPTY){Fragmentf=newFragment(id,"checkboxEmpty",SolrConfigurationPage.this);f.add(newCheckBox("isEmpty",newPropertyModel<Boolean>(itemModel,"empty")));returnf;
else
if(property==SolrAttributeProvider.SRID){
if(isGeometry){Fragmentf=newFragment(id,"text",SolrConfigurationPage.this);f.add(newTextField<Integer>("text",newPropertyModel<Integer>(itemModel,"srid")));returnf;
else{Fragmentf=newFragment(id,"empty",SolrConfigurationPage.this);returnf;
else
if(property==SolrAttributeProvider.DEFAULT_GEOMETRY){
if(isGeometry){Fragmentf=newFragment(id,"checkboxDefaultGeometry",SolrConfigurationPage.this);f.add(newCheckBox("defaultGeometry",newPropertyModel<Boolean>(itemModel,"defaultGeometry")));returnf;
else{Fragmentf=newFragment(id,"empty",SolrConfigurationPage.this);returnf;
iftheattributesconfiguration
ifforneworfor*existinglayer*@see{@link#onSave}*@see{@link#onCancel}*/abstractvoiddone(AjaxRequestTargettarget,ResourceInfolayerInfo);}
if(rule.getId()==null){shiftIfNecessary(rule.getPriority(),rule);//localinti=0;while(i<rules.size()&&rules.get(i).getPriority()<rule.getPriority()){i++;
else{//dbRulebigRule=adminService().get(rule.getId());
if(bigRule.getPriority()!=rule.getPriority()){shiftIfNecessary(rule.getPriority(),rule);
if(index>0){swap(rule,rules.get(index-1));//localsortrules.remove(index);rules.add(index-1,rule);
if(index<rules.size()-1){swap(rule,rules.get(index+1));//localsortrules.remove(index);rules.add(index+1,rule);
ifnecessarybooleannecessary=false;for(ShortRulerule:rules){
if(rule.getPriority()==priority){necessary=true;continue;
if(necessary){//localfor(ShortRulerule:rules){
if(rule.getPriority()>=priority&&rule!=keep){rule.setPriority(rule.getPriority()+1);
if(ruleLimits==null){ruleLimits=newRuleLimits();ruleLimits.setRule(rule);
if(ruleId!=null){Rulerule=adminService().get(ruleId);
if(rule!=null){returnrule.getRuleLimits();
if(ruleId!=null){Rulerule=adminService().get(ruleId);
if(rule!=null){returnrule.getLayerDetails();
if(!available||value==null){returnBaseSystemInfoCollector.DEFAULT_VALUE;
if(valueinstanceofDouble||valueinstanceofFloat){returnString.format("%.2f%s",value,unit);
if(unit!=null&&unit.equalsIgnoreCase("bytes")){longbytes=Converters.convert(value,Long.class);returnhumanReadableByteCount(bytes);
else
if(unit!=null&&unit.equalsIgnoreCase("sec")){longseconds=Converters.convert(value,Long.class);returnLocalTime.MIN.plusSeconds(seconds).toString();
if(bytes<unit){returnbytes+"B";
if(!(context.getService()instanceofWMSInfo)){returnnull;
ifwehavetoencodealegendGetMapRequestrequest=context.getRequest();Booleanlegend=(Boolean)request.getFormatOptions().get("legend");
if(legend!=null&&legend&&Document.class.isAssignableFrom(featureClass)){returnnewLegendDecorator();
else{returnnull;
if(legendOptions!=null){kvpArray=newString[]{"LEGEND_OPTIONS",legendOptions};
if(position!=null){this.position=position;matchPattern=Pattern.compile(String.format("^(?:/[^/]*){%d}(/([^/]+)).*$",position));
if(match!=null){this.match=match;matchPattern=Pattern.compile(match);
if(activation!=null){activationPattern=Pattern.compile(activation);this.activation=activation;
if(expression==null){return;
if(attributes!=null){
if(attributes.contains(PATH)){
if(attributes.contains(NAME)){feature=SimpleFeatureBuilder.build(typeAll,newObject[]{itemPath.toString(),itemName},null);
else{feature=SimpleFeatureBuilder.build(typePath,newObject[]{itemPath.toString()},null);
else
if(attributes.contains(NAME)){feature=SimpleFeatureBuilder.build(typeName,newObject[]{itemName},null);
else{feature=SimpleFeatureBuilder.build(typeAll,newObject[]{itemPath.toString(),itemName},null);
if(feature==null){return;
if(newPath==null||newPath.isEmpty()){return;
ifnotnull
if(expression!=null){returnECQL.toExpression(expression);
if(objectinstanceofSimpleFeature){SimpleFeatureTypeft=((SimpleFeature)object).getFeatureType();returnestimateSizeByFeatureType(ft);
else
if(objectinstanceofSimpleFeatureCollection){SimpleFeatureCollectionfc=(SimpleFeatureCollection)object;intcount=fc.size();
if(count>0){SimpleFeatureTypeft=fc.getSchema();returncount+estimateSizeByFeatureType(ft);
if(Point.class.isAssignableFrom(type)){bytes+=12+16+16;//assumingapackedcoordinatesequence
else
if(Geometry.class.isAssignableFrom(type)){bytes+=12+16+16*64;//assuming64coordinatespergeometry
else
if(Number.class.isAssignableFrom(type)){
if(Double.class.isAssignableFrom(type)||Float.class.isAssignableFrom(type)){bytes+=8;
else
if(Float.class.isAssignableFrom(type)||Integer.class.isAssignableFrom(type)){bytes+=4;
else
if(Short.class.isAssignableFrom(type)){bytes+=2;
else
if(Byte.class.isAssignableFrom(type)){bytes+=1;
else
if(Character.class.isAssignableFrom(type)||Boolean.class.isAssignableFrom(type)){bytes+=1;
else
if(Date.class.isAssignableFrom(type)){bytes+=8;
else{//blindassumptionforanythingelse,similartoanarrayof64charentriesbytes+=16+64;
if(last==-1||!EXTENSIONS.contains(value.substring(last+1).toLowerCase())){ValidationErrorerror=newValidationError();error.setMessage("Notanimage");error.addKey("nonImage");input.error(error);return;
ifabsolute
if(uri!=null&&uri.isAbsolute()){try{StringbaseUrl=baseURL(onlineResource.getForm());
if(!value.startsWith(baseUrl)){onlineResource.warn("Recommenduseofstylesdirectoryat"+baseUrl);
if("text/html".equals(conn.getContentType())){ValidationErrorerror=newValidationError();error.setMessage("Unabletoaccessimage");error.addKey("imageUnavailable");input.error(error);return;//errormessageback!
else{GeoServerResourceLoaderresources=GeoServerApplication.get().getResourceLoader();try{Filestyles=resources.find("styles");String[]path=value.split(Pattern.quote(File.separator));WorkspaceInfowsInfo=styleModel.getObject().getWorkspace();Filetest=null;
if(wsInfo!=null){StringwsName=wsInfo.getName();List<String>list=newArrayList();list.addAll(Arrays.asList("workspaces",wsName,"styles"));list.addAll(Arrays.asList(path));test=resources.find(list.toArray(newString[list.size()]));
if(test==null){test=resources.find(styles,path);
if(test==null){ValidationErrorerror=newValidationError();error.setMessage("Filenotfoundinstylesdirectory");error.addKey("imageNotFound");input.error(error);
if(conn==null){ValidationErrorerror=newValidationError();error.setMessage("Unabletoaccessimage");error.addKey("imageUnavailable");onlineResource.error(error);
else{format.setModelValue(newString[]{conn.getContentType()});BufferedImageimage;try{image=ImageIO.read(conn.getInputStream());width.setModelValue(newString[]{""+image.getWidth()});height.setModelValue(newString[]{""+image.getHeight()});
if(StringUtils.isEmpty(baseUrl)){GeoServergs=GeoServerApplication.get().getGeoServer();baseUrl=gs.getGlobal().getSettings().getProxyBaseUrl();
if(StringUtils.isEmpty(baseUrl)){returnResponseUtils.baseURL(httpServletRequest);
if(onlineResource.getModelObject()!=null){URLurl=null;try{StringbaseUrl=baseURL(form);Stringexternal=onlineResource.getModelObject().toString();URIuri=newURI(external);
if(uri.isAbsolute()){url=uri.toURL();
if(!external.startsWith(baseUrl)){form.warn("Recommenduseofstylesdirectoryat"+baseUrl);
else{WorkspaceInfowsInfo=((StyleInfo)getDefaultModelObject()).getWorkspace();
if(wsInfo!=null){url=newURL(ResponseUtils.appendPath(baseUrl,"styles",wsInfo.getName(),external));
else{url=newURL(ResponseUtils.appendPath(baseUrl,"styles",external));
if("text/html".equals(conn.getContentType())){form.error("Unabletoaccessurl");returnnull;//errormessageback!
if(b){showhideStyleModel.setObject("");
else{showhideStyleModel.setObject("display:none");
if(index>=size())index%=size();returnsuper.get(index);}}
if(!XML_NAME_PATTERN.matcher(value).matches()){validatable.error(newValidationError("invalidXMLName").addKey("invalidXMLName").setVariable("name",value));
iftheObjectisnotencodeable.*/publicvoidencode(Objecto)throwsIllegalArgumentException{try{
if(!(oinstanceofCoverageInfo)){thrownewIllegalArgumentException(newStringBuffer("NotaGetCapabilitiesType:").append(o).toString());
if(coverageinstanceofGridCoverage2D){((GridCoverage2D)coverage).dispose(true);
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
if(coverageinstanceofGridCoverage2D){((GridCoverage2D)coverage).dispose(true);
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
if(coverageinstanceofGridCoverage2D){((GridCoverage2D)coverage).dispose(true);
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
if(coverageinstanceofGridCoverage2D){((GridCoverage2D)coverage).dispose(true);
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
if(!(oinstanceofIndexInfoEntry)){returnfalse;
if(o==this){returntrue;
if(disassociateRoles)returnugService.createGroupObject("g_all",true);
elsereturnugService.getGroupByGroupname("group1");
if(disassociateRoles)return".*"+getRemoveableObject().getGroupname()+".*ROLE_WMS.*";
elsereturn".*"+getRemoveableObject().getGroupname()+".*";}}
if(request.getMaxRecords()==null){maxRecords=10;
else{maxRecords=request.getMaxRecords();
if(offset<0){thrownewServiceException("startPositionmustbeapositivenumber",ServiceException.INVALID_PARAMETER_VALUE,"startPosition");
if(maxRecords==0&&resultType==ResultType.RESULTS){resultType=ResultType.HITS;
if(resultType!=ResultType.VALIDATE){//computethenumberofrecordswe'rereturningandthenextrecord
if(offset>numberOfRecordsMatched){numberOfRecordsReturned=0;nextRecord=0;
else
if(numberOfRecordsMatched-offset<=maxRecords){numberOfRecordsReturned=numberOfRecordsMatched-offset;nextRecord=0;
else{numberOfRecordsReturned=maxRecords;//mind,nextRecordis1basedtoonextRecord=offset+numberOfRecordsReturned+1;
ifwearenotinhitsmode
if(resultType==ResultType.RESULTS){
if(resultType!=ResultType.HITS){List<FeatureCollection>results=newArrayList<FeatureCollection>();for(inti=0;i<queries.size()&&maxRecords>0;i++){Queryq=queries.get(i);
if(offset>0){
if(offset>counts[i]){//skipthequeryaltogheteroffset-=counts[i];continue;
else{q.setStartIndex(offset);offset=0;
if(maxRecords>0){q.setMaxFeatures(maxRecords);maxRecords-=counts[i];
else{//skipthequery,wealreadyhaveenoughresultscontinue;
if(results.size()==1){records=results.get(0);
else
if(results.size()>1){records=newCompositeFeatureCollection(results);
if(resultType==ResultType.HITS){numberOfRecordsReturned=0;
if(filter!=null){filter=(Filter)filter.accept(newCaseInsenstiveFilterTransformer(),null);
if(!supportedTypes.contains(typeName)){thrownewServiceException("Unsupportedrecordtype"+typeName,ServiceException.INVALID_PARAMETER_VALUE,"typeNames");
ifaspatialoperator//isusedagainstanonspatialproperty
if(q.getFilter()!=null){rd.verifySpatialFilters(q.getFilter());
if(query.getElementName()!=null&&!query.getElementName().isEmpty()){//turntheQNameintoPropertyName.Wedon'tdoanyverificationcausethe//elementsintheactualfeaturecouldbepartsofsubstitutiongroups//oftheelementsinthefeature'sschemaList<PropertyName>result=newArrayList<PropertyName>();for(QNameqn:query.getElementName()){result.add(store.translateProperty(rd,Types.toTypeName(qn)));
else{ElementSetTypeelementSet=getElementSet(query);List<Name>properties=rd.getPropertiesForElementSet(elementSet);
if(properties!=null){List<PropertyName>result=newArrayList<PropertyName>();for(Namepn:properties){result.add(store.translateProperty(rd,pn));
else{//theprofileisthefullonereturnnull;
if(query.getElementName()!=null&&query.getElementName().size()>0){returnElementSetType.FULL;
if(elementSet==null){//thedefaultis"summary"elementSet=ElementSetType.SUMMARY;
if(typeName==null){returnCSWRecordDescriptor.getInstance();
if(typeName.equals(rd.getFeatureDescriptor().getName())){returnrd;
if(outputSchema==null){outputSchema=CSW.NAMESPACE;request.setOutputFormat(CSW.NAMESPACE);
if(outputSchema.equals(rd.getOutputSchema())){returnrd;
if(!(storeinstanceofDataStore)){returnnull;
if(factory==null){returnnull;
if(store==null){returnnull;
if(storeinstanceofDataStore){try{String[]names=((DataStore)store).getTypeNames();for(inti=0;i<names.length;i++){
if(names[i].indexOf(":")>=0)returnnewRetypingDataStore((DataStore)store);
ifrequired*@returnprocessedparameterswithrelativeURLsresolvedagainstdatadirectory*@deprecatedUnused,call{@linkResourcePool#getParams(Map,GeoServerResourceLoader)}*directly.*/publicstatic<K,V>Map<K,V>getParams(Map<K,V>m,ServletContextsc){GeoServerResourceLoaderloader;
if(sc!=null){StringbasePath=GeoServerResourceLoader.lookupGeoServerDataDirectory(sc);FilebaseDir=newFile(basePath);loader=newGeoServerResourceLoader(baseDir);
else{loader=GeoServerExtensions.bean(GeoServerResourceLoader.class);
if(factory.canProcess(params)){returnfactory;
if(displayName==null){returnnull;
if(displayName.equals(factory.getDisplayName())){returnfactory;
if(displayName.equals(factory.getClass().toString())){returnfactory;
if(initer.getFactoryClass().isAssignableFrom(factory.getClass())){try{initer.initialize(factory);
if(key.equalsIgnoreCase(params[i].key)){returnparams[i];
if(param.required){
if(param.sample!=null){//Requiredparamsmayhavenicesamplevalues//value=param.text(param.sample);
if(value==null){//ornotvalue="";
if(value!=null){defaults.put(key,value);
if(value!=null){map.put(key,value);
if(script!=null){ScriptProcessFactorypf=newScriptProcessFactory(scriptMgr);Namebuffer=newNameImpl(getNamespace(),pname);org.geotools.process.Processp=pf.create(buffer);Mapinputs=newHashMap();inputs.put("geom",newWKTReader().read("POINT(00)"));inputs.put("distance",1d);Mapoutputs=p.execute(inputs,null);assertEquals(2,outputs.size());assertNotNull((Geometry)outputs.get("geom"));assertEquals(1d,(Double)outputs.get("distance"),0.1);
else{System.out.println("Script"+pname+"doesnotexist,skippingtest");
if(startIndex>-1){xml+="startIndex='"+startIndex+"'";
if(count>-1){xml+="count='"+count+"'";
if(count>-1){xml+="count='"+count+"'";
if("startIndex".equalsIgnoreCase(k)){actualStartIndex=Integer.parseInt(v);
if("count".equalsIgnoreCase(k)){actualCount=Integer.parseInt(v);
if(expectedinstanceofId){Sets1=newHashSet();for(Identifierid:((Id)expected).getIdentifiers()){s1.add(id.toString());
else{assertEquals(expected,f);
if(file.exists()){assertTrue(file.delete());
if(bytes==null){//skiptestLOGGER.warning("app-schematestdatanotavailable:skippingtest");return;
if("name".equals(attribute.getLocalName())){namesCount++;
if(in!=null){byte[]original=toBytes(in);byte[]modified;StringoriginalAsString=newString(original,Charset.forName("UTF-8"));//modifypathsintheoriginalmappingfileStringmodifiedAsString=originalAsString.replace("file:./","file:../").replace("commonSchemas_new/","../commonSchemas_new/").replace("mappedPolygons.oasis","../mappedPolygons.oasis");modified=modifiedAsString.getBytes(Charset.forName("UTF-8"));returnmodified;
else{returnnull;
if(mapping!=null){DocumentmappingDom=dom(newByteArrayInputStream(mapping));//removemappingforMappedFeature/gml:name[2]attributeNodeListattrMappingNodes=mappingDom.getDocumentElement().getElementsByTagName("AttributeMapping");for(inti=0;i<attrMappingNodes.getLength();i++){NodeattrMapping=attrMappingNodes.item(i);NodeListchildren=attrMapping.getChildNodes();for(intj=0;j<children.getLength();j++){
if("MappedFeature/gml:name[2]".equals(children.item(j).getTextContent())){attrMapping.getParentNode().removeChild(attrMapping);break;
else{returnnull;
if(rd==GSRecordDescriptor.getInstance()){returnnewMemoryFeatureCollection(GSRecordDescriptor.getInstance().getFeatureType());
else{thrownewRuntimeException("Wasexpectingthegeoserverrecorddescriptor");
if(config!=null){
if(curr.getNativeName().equals(csqName)){Map<String,Object>map=newHashMap<>();map.put("name",csqName);map.put("dataStore",store.getName());IValidationErrorerr=newValidationError("duplicateSqlViewName").addKey("duplicateSqlViewName").setVariables(map);validatable.error(err);return;
if(esriProjs.getType()!=Type.RESOURCE){defaultPrjFormat.setEnabled(false);defaultPrjFormat.getModel().setObject(Boolean.FALSE);defaultPrjFormat.add(newAttributeModifier("title",newModel("Noesri.propertiesfile"+"foundinthedatadirectory'suser_projectionsfolder."+"Thisoptionisnotavailable")));
ifavailable
if(mimesTypesProvided){mimeTypeToForce.setModelObject(gmlInfo.getMimeTypeToForce().orElse(mimeTypes[0]));
if(checked){//forceMIMEtypeactivatedmimeTypeToForce.setVisible(true);Stringvalue=mimeTypeToForce.getModelObject();gmlInfo.setMimeTypeToForce(value);
else{//forceMIMEtypedeactivatedmimeTypeToForce.setVisible(false);gmlInfo.setMimeTypeToForce(null);
if(offset_millis==0){result.append("Z");
else{result.append((offset_millis>0)?"+":"-").append(doubleDigit.format(offset_hours)).append(":").append(doubleDigit.format(offset_minutes));
if(description.length()==0){return"Auto-generatedbygeoserver";
else{description.setLength(description.length()-1);returndescription.toString();
if(i<mapLayers.size()-1)layers.append(",");
if(m!=null){obj.put("metrics",m);rsp.setStatus(HttpServletResponse.SC_OK);
else{rsp.setStatus(HttpServletResponse.SC_NOT_FOUND);obj.put("message","metricsunavailable");
ifindexresulttypeisbeingusedprivatestaticfinalThreadLocal<XPathExpression>INDEX_RESULT_TYPE_XPATH=ThreadLocal.withInitial(()->{XPathxpath=XPathFactory.newInstance().newXPath();xpath.setNamespaceContext(WFS_20_NAMESPACES);try{returnxpath.compile("/wfs:GetFeature[@resultType='index']");
if(node==null){byte[]bytes=documentToBytes(document);InputStreamReaderinput=newInputStreamReader(newByteArrayInputStream(bytes));returnwfsXmlReader.read(request,input,kvp);
if(server.contains(m)){
if(m.equals("PLAIN")){returnnewPlainMechanism();
else
if(m.equals("EXTERNAL")){returnnewExternalMechanism();
else
if(m.equals("ANONYMOUS")){returnnewAnonymousMechanism();
if(Serializable.class.isAssignableFrom(param.type)){this.binding=param.type;this.value=(Serializable)defaultValue;
else
if(Repository.class.equals(param.type)||EntityResolver.class.isAssignableFrom(param.type)){this.binding=param.type;this.value=null;
else{//handletheparameterasastringandlettheDataStoreFactory//convertittotheappropriatetypethis.binding=String.class;this.value=defaultValue==null?null:String.valueOf(defaultValue);
if(param.metadata!=null){List<Serializable>options=(List<Serializable>)param.metadata.get(Param.OPTIONS);
if(options!=null&&options.size()>0){this.options=newArrayList<Serializable>(options);
if(Comparable.class.isAssignableFrom(this.binding)){Collections.sort((List)options);
if(this.value==null){this.value=options.get(0);
ifanexternalfilehasbeendefinedStringtableName=System.getProperty(NETCDF_STANDARD_NAME_TABLE);
if(tableName!=null&&!tableName.isEmpty()&&tableName.endsWith("xml")){FilenewFile=newFile(tableName);//Check
ifthefileisvalidbooleanvalid=newFile.exists()&&newFile.canRead()&&newFile.isFile();//Ifthefileisvalid,useithasstandardnametable
if(valid){netcdfFile=Files.asResource(newFile);
ifanexternalfilehasbeendefined
if(netcdfFile!=null){cfStandardTable=netcdfFile;
ifitiscontainedintheNetCDFDataDirectory
if(cfStandardTable==null&&NetCDFUtilities.EXTERNAL_DATA_DIR!=null){//GettingthedirectoryfileFilenetCDFDir=newFile(NetCDFUtilities.EXTERNAL_DATA_DIR);//CreatingaFilefilterFileFilterfilter=FileFilterUtils.nameFileFilter(NETCDF_STANDARD_NAME,IOCase.INSENSITIVE);//GettingthefilteredfilearrayFile[]files=netCDFDir.listFiles(filter);//Gettingthefile
ifpresent
if(files!=null&&files.length>0){cfStandardTable=Files.asResource(files[0]);
if(cfStandardTable==null){//GettinggeoServerdatadirGeoServerDataDirectorydatadir=GeoServerExtensions.bean(GeoServerDataDirectory.class);//Checking
ifthestandardtableispresenttry{cfStandardTable=datadir.get(NETCDF_STANDARD_NAME);
ifthefilecanbeparsed
if(cfStandardTable!=null&&cfStandardTable.getType()!=Resource.Type.UNDEFINED){NetCDFCFParserparser=null;try{parser=NetCDFCFParser.unmarshallXml(cfStandardTable.file());
if(parser!=null){this.parser=parser;
else{LOGGER.log(Level.WARNING,"NoCF-StandardFilefound");
ifpresent,ornull
ifnocf-standardtable*fileispresentorbadlyparsed.*/publicNetCDFCFParsergetParser(){returnparser;}}
iftheextensioncancreateobjectsofthespecifiedclass.**@paramclazzTheclassofobjecttocreate.*/<TextendsObject>booleancanCreate(Class<T>clazz);/***Createsaninstanceofthespecifiedclass.**<p>Thismethodisonlycalled
if{@link#canCreate(Class)}returns<code>true</code>.**@paramclazzTheclassofobjecttocreate.*@paramcontextAcontexttoinitializetheobject.*@returnThenewobject.*/<TextendsObject>Tcreate(Class<T>clazz,Map<Object,Object>context);}}
if(schema!=null&&scheduleSchemaCleanup){SchemaCleanerCallback.addSchema(schema);
if(l==null){l=newArrayList();
if(baseUrl==null)baseUrl=gs.getService(WFSInfo.class).getSchemaBaseURL();
if(ns2featureTypeInfos.entrySet().size()==0){//forWFS2.0encodingtoworkweneedtohaveatleastadependencyonGMLand//atargetnamespace.WearegoingtousetheGMLone.importGMLSchema(schema,factory,baseUrl);schema.setTargetNamespace(gmlSchema().getTargetNamespace());
else
if(ns2featureTypeInfos.entrySet().size()==1){//only1namespace,writetargetnamespaceoutStringtargetPrefix=(String)ns2featureTypeInfos.keySet().iterator().next();StringtargetNamespace=catalog.getNamespaceByPrefix(targetPrefix).getURI();schema.setTargetNamespace(targetNamespace);schema.getQNamePrefixToNamespaceMap().put(targetPrefix,targetNamespace);booleansimple=true;for(inti=0;i<featureTypeInfos.length&&simple;i++){try{simple=featureTypeInfos[i].getFeatureType()instanceofSimpleFeatureType;
if(!simple){//complexfeaturesmaybelongtodifferentworkspacesWorkspaceInfolocalWorkspace=LocalWorkspace.get();
if(localWorkspace!=null){//deactivateworkspacefilteringLocalWorkspace.remove();
if(!schema.getQNamePrefixToNamespaceMap().containsKey(nameSpaceinfo.getPrefix())){schema.getQNamePrefixToNamespaceMap().put(nameSpaceinfo.getPrefix(),nameSpaceinfo.getURI());
ifschemalocationisspecifiedtry{FeatureTypefeatureType=featureTypeInfos[0].getFeatureType();ObjectschemaUri=featureType.getUserData().get("schemaURI");
if(schemaUri!=null&&schemaUriinstanceofMap){//shouldalwaysbeaMap..setinAppSchemaDataAccessConfigurator//imposeiterationorder@SuppressWarnings("unchecked")Map<String,String>schemaURIs=newTreeMap<String,String>((Map<String,String>)schemaUri);//schemaissuppliedbytheuser..justincludethetoplevelschemainsteadof//buildingthetype
if(!findTypeInSchema(featureTypeInfos[0],schema,factory)){//mapofnamespacetoschemaLocationusedtopreventduplicateimportsMap<String,String>imports=newHashMap<String,String>();//setofschemaLocationsusedtopreventduplicateincludesSet<String>includes=newHashSet<String>();for(Stringnamespace:schemaURIs.keySet()){addReference(schema,factory,namespace,schemaURIs.get(namespace),imports,includes);
else{//differentnamespaces,writeoutimportstatements//setthefirstnamespaceasthetargetoneNamespaceInfons=featureTypeInfos[0].getNamespace();//hackforwfs1.0,thecitetestsmandatethatinthecaseofaheterogeneousschema//notargetnamespacebedeclared,thisconflictswithwfs2.0
if(!(thisinstanceofGML2)){schema.setTargetNamespace(ns.getURI());
if(schemaUri!=null&&schemaUriinstanceofMap){//shouldalwaysbeaMap..setinAppSchemaDataAccessConfigurator//imposeiterationorder@SuppressWarnings("unchecked")Map<String,String>schemaURIs=newTreeMap<String,String>((Map<String,String>)schemaUri);//schemaissuppliedbytheuser..justimportthespecifiedlocationfor(Stringnamespace:schemaURIs.keySet()){addReference(schema,factory,namespace,schemaURIs.get(namespace),imports,includes);
else{typeNames.append(info.getPrefixedName()).append(",");
if(typeNames.length()>0){typeNames.setLength(typeNames.length()-1);//schemanotfound,encodedescribefeaturetypeURLMap<String,String>params=newLinkedHashMap<String,String>(describeFeatureTypeParams);params.put("typeName",typeNames.toString().trim());StringschemaLocation=buildURL(baseUrl,"wfs",params,URLType.RESOURCE);Stringnamespace=catalog.getNamespaceByPrefix(prefix).getURI();//registerthenamespaceprefixschema.getQNamePrefixToNamespaceMap().put(prefix,namespace);XSDImportimprt=factory.createXSDImport();imprt.setNamespace(namespace);imprt.setSchemaLocation(schemaLocation);XSDSchemaresolved=null;
if(resolveAppSchemaImports){//actuallybuildtheschemaoutforthesetypesandsetitastheresolved//schemafortheimportList<FeatureTypeInfo>featureTypes=newArrayList();for(StringtypeName:typeNames.toString().split(",")){featureTypes.add(catalog.getFeatureTypeByName(typeName));
if(getWfsSchema()!=null){schema.getQNamePrefixToNamespaceMap().put("wfs",getWfsSchema().getTargetNamespace());
if(resolved!=null){imprt.setResolvedSchema(resolved);
if(resolved!=null){finalXSDSchemaImplrs=(XSDSchemaImpl)resolved;synchronized(rs.eAdapters()){rs.imported(imprt);
if(getWfsSchema()!=null&&imports.get(getWfsSchema().getTargetNamespace())==null){synchronized(Schemas.class){/**AddanimportfortheWFSschema.NeededforGML32OutputFormatonly.See*GML32.importGMLSchemawhereasimilarimportisusedforsimplefeatures(generated*schema).**NotthatthisdoesnotbreakDescribeFeatureTypebecauseitusesWFS1.1.*/schema.getQNamePrefixToNamespaceMap().put("wfs",getWfsSchema().getTargetNamespace());XSDImportwfsImport=factory.createXSDImport();wfsImport.setNamespace(getWfsSchema().getTargetNamespace());wfsImport.setSchemaLocation(getWfsSchema().getSchemaLocation());wfsImport.setResolvedSchema(getWfsSchema());schema.getContents().add(wfsImport);finalXSDSchemaImplwfsSchema=(XSDSchemaImpl)getWfsSchema();synchronized(wfsSchema.eAdapters()){wfsSchema.imported(wfsImport);
if(namespace.equals(schema.getTargetNamespace())){
if(includes.contains(schemaLocation)){logger.finer("SkippedgenerationofduplicateincludeforschemaLocation=\""+schemaLocation+"whilegeneratingschemafor"+schema.getTargetNamespace());
else{addInclude(schema,factory,schemaLocation);includes.add(schemaLocation);
else{
if(imports.get(namespace)!=null){
if(imports.get(namespace).equals(schemaLocation)){logger.finer("Skippedgenerationofduplicateimportfornamespace=\""+namespace+"\"schemaLocation=\""+schemaLocation+"whilegeneratingschemafor"+schema.getTargetNamespace());
else{logger.warning("Skippedgenerationofconflictingimportfornamespace=\""+namespace+"\"schemaLocation=\""+schemaLocation+"whilegeneratingschemafor"+schema.getTargetNamespace()+"(someXMLprocessorswillignoreallimportsforanamespaceafterthefirst)");
else{addImport(schema,factory,namespace,schemaLocation);imports.put(namespace,schemaLocation);
ifnot*required.**@returntheWFSschema,ornull
ifnone*/protectedXSDSchemagetWfsSchema(){returnnull;
if(!meta.enabled())continue;//buildtheschemaforthetypesinthesinglenamespace(anddon'tcleanthem,they//arenotdynamic)XSDSchemaschema=buildSchemaInternal(newFeatureTypeInfo[]{meta},null,false);//declarethenamespaceStringprefix=meta.getNamespace().getPrefix();StringnamespaceURI=meta.getNamespace().getURI();wfsSchema.getQNamePrefixToNamespaceMap().put(prefix,namespaceURI);//addthetypes+elementstothewfsschemafor(Iterator<XSDTypeDefinition>t=schema.getTypeDefinitions().iterator();t.hasNext();){wfsSchema.getTypeDefinitions().add(t.next());
if(!wfsSchema.getQNamePrefixToNamespaceMap().containsKey(entry.getKey())){wfsSchema.getQNamePrefixToNamespaceMap().put(entry.getKey(),entry.getValue());
iftheschemaforthetypeisalreadydefinedStringws=featureTypeMeta.getStore().getWorkspace().getName();Stringds=featureTypeMeta.getStore().getName();Stringname=featureTypeMeta.getName();ResourceschemaFile=resourceLoader.get("workspaces/"+ws+"/"+ds+"/"+name+"/schema.xsd");
if(schemaFile.getType()==Type.RESOURCE){
if(logger.isLoggable(Level.FINE)){logger.fine("Foundcustomizedschema.xsd:"+schemaFile.path());
if(gmlNamespace.equals(namespaceURI)){returngmlSchema();
if(ftSchema!=null){//respecttheprefix(xsvsxsd)givenbytheunderlyingschemafile
if(ftSchema.getSchemaForSchemaQNamePrefix()!=null){schema.setSchemaForSchemaQNamePrefix(ftSchema.getSchemaForSchemaQNamePrefix());
if(contentinstanceofXSDImport){XSDImportimprt=(XSDImport)content;
if(gmlNamespace.equals(imprt.getNamespace())){i.remove();
if(contentinstanceofXSDElementDeclaration){
if(contains((XSDNamedComponent)content,schema.getElementDeclarations())){i.remove();
else
if(contentinstanceofXSDTypeDefinition){
if(contains((XSDNamedComponent)content,schema.getTypeDefinitions())){i.remove();
if(!hasElement&&contentinstanceofXSDElementDeclaration){XSDElementDeclarationelement=(XSDElementDeclaration)content;
if(name.equals(element.getName())&&featureTypeMeta.getNamespace().getURI().equals(element.getTargetNamespace())){hasElement=true;
if(!hasElement){//needtocreateanelementdeclarationintheschemaXSDElementDeclarationelement=factory.createXSDElementDeclaration();element.setName(featureTypeMeta.getName());element.setTargetNamespace(featureTypeMeta.getNamespace().getURI());synchronized(Schemas.class){element.setSubstitutionGroupAffiliation(getFeatureElement());
if(typeinstanceofXSDComplexTypeDefinition){XSDTypeDefinitionbase=type.getBaseType();while(base!=null){
if(baseType.equals(base.getName())&&gmlNamespace.equals(base.getTargetNamespace())){candidates.add((XSDComplexTypeDefinition)type);break;
if(base.equals(base.getBaseType())){break;
if(candidates.size()!=1){thrownewIllegalStateException("Couldnotdeterminefeaturetypefor"+"generatedelement.Mustspecifyexplicitlyinschema.xsd.");
if(featureSubGroupElement==null){synchronized(this){
if(featureSubGroupElement==null){featureSubGroupElement=gmlSchema().resolveElementDeclaration(gmlNamespace,substitutionGroup);
if(!findTypeInSchema(featureTypeMeta,schema,factory)){//buildthetypemanuallyFeatureTypefeatureType=featureTypeMeta.getFeatureType();
if(featureTypeMeta.isCircularArcPresent()&&this.getClass().equals(GML3.class)){featureType=newCurveTypeWrapper(featureType);
if(pdinstanceofAttributeDescriptor){AttributeDescriptorattribute=(AttributeDescriptor)pd;
if(filterAttributeType(attribute)){GMLInfogml=getGMLConfig(gs.getService(WFSInfo.class));
if(gml==null||!gml.getOverrideGMLAttributes()){continue;
ifit'sXS.AnyType.It'snotaddedtoXS.Profile,because//alotoftypesextendXS.AnyTypecausingittobethereturned//binding..Icouldmakeitsothatitchecksagainstallprofiles//butwouldthatslowthingsdown?Atthemoment,itreturnsthe//firstmatchingone,soitdoesn'tgothroughallprofiles.
if(!(typeName.getLocalPart().equals(XS.ANYTYPE.getLocalPart())&&typeName.getNamespaceURI().equals(XS.NAMESPACE))){
if(attribute.getType()instanceofComplexType){//Ifnon-simplecomplexpropertynotinschema,recurse.//Notethatabstracttypeswillofcoursenotberesolved;thesemustbe//configuredatgloballevel,sotheycanbefoundbythe//encoder.
if(schema.resolveTypeDefinition(typeName.getNamespaceURI(),typeName.getLocalPart())==null){buildComplexSchemaContent((ComplexType)attribute.getType(),schema,factory);
else{Classbinding=attribute.getType().getBinding();typeName=findTypeName(binding);
if(typeName==null){//FallbackonStringlogger.finer("Fallbackmapping:attribute"+attribute.getName()+"toString");typeName=findTypeName(String.class);
if(typeName==null){thrownewNullPointerException("Couldnotfindatypeforproperty:"+attribute.getName()+"oftype:"+binding.getName());
if(typeName.getNamespaceURI().equals(td.getTargetNamespace())&&typeName.getLocalPart().equals(td.getName())){type=td;break;
if(type==null){type=schema.resolveTypeDefinition(typeName.getNamespaceURI(),typeName.getLocalPart());
if(e.getName().equals(c.getName())){
if(e.getTargetNamespace()==null){contains=c.getTargetNamespace()==null;
else{contains=e.getTargetNamespace().equals(c.getTargetNamespace());
if(profileinstanceofTypeMappingProfile){name=((TypeMappingProfile)profile).name(binding);
else
if(profileinstanceofSchema){Schemaschema=(Schema)profile;for(Map.Entry<Name,AttributeType>e:schema.entrySet()){AttributeTypeat=e.getValue();
if(at.getBinding()!=null&&at.getBinding().equals(binding)){name=at.getName();break;
if(name==null){for(AttributeTypeat:schema.values()){
if(binding.isAssignableFrom(at.getBinding())){name=at.getName();break;
if(name!=null){returnname;
if(gml2Schema==null){gml2Schema=xmlConfiguration.schema();
if(gml3Schema==null){gml3Schema=createGml3Schema();
if(gml32Schema==null){gml32Schema=createGml32Schema();
if(path==null){returnnull;
if(last==-1){
if(BASE.equals(path)){returnnull;
else{returnBASE;
else{returnpath.substring(0,last);
if(path==null){returnnull;
if(last==-1){returnpath;//toplevelresource
else{Stringitem=path.substring(last+1);returnitem;
if(name==null){returnnull;
if(last==-1){returnnull;//noextension
else{returnname.substring(last+1);
if(extension==null){returnnull;
if(last==-1){returnpath+"."+extension;
else{returnpath.substring(0,last)+"."+extension;
if(path==null||(path.length==1&&path[0]==null)){returnnull;
iftrue,throwsanerrorfortheWARNcharactersstaticfinalbooleanSTRICT_PATH=Boolean.valueOf(System.getProperty("STRICT_PATH","false"));/***Patternusedtocheckforinvalidfilecharacters.**<ul>*<li>backslash*</ul>*/staticfinalPatternVALID=Pattern.compile("^[^\\\\]*$");/***Patternusedtocheckforill-advisedfilecharacters:**<ul>*<li>star*<li>colon-potentialconflictwithxmlprefixseparatorandworkspacestyleseparator*<li>comma*<li>singlequote*<li>ampersand*<li>questionmark*<li>doublequote*<li>lessthan*<li>greaterthan*<li>bar*</ul>**Thesecharacterscancauseproblemsfordifferentprotocols.*/staticfinalPatternWARN=Pattern.compile("^[^:*,\'&?\"<>|]*$");/**Setofinvalidresourcenames(currentlyusedtoquicklyidentifyrelativepaths).*/staticfinalSet<String>INVALID=newHashSet<String>(Arrays.asList(newString[]{"..","."}));/***InternalmethodusedtoconvertalistofnamestoanormalResourcepath.**@paramstrictPathwhetherproblematiccharactersareanerror*@paramnamesListofresourcenamesformingapath*@returnresourcepathcomposedofprovidednames*@throwsIllegalArgumentExceptionIfnamesincludesany{@link#INVALID}chracters*/privatestaticStringtoPath(booleanstrictPath,List<String>names){StringBuilderbuf=newStringBuilder();finalintLIMIT=names.size();for(inti=0;i<LIMIT;i++){Stringitem=names.get(i);
if(item==null){continue;//skipnullnames
if(INVALID.contains(item)){thrownewIllegalArgumentException("Containsinvalid"+item+"path:"+buf);
if(!VALID.matcher(item).matches()){thrownewIllegalArgumentException("Containsinvalid"+item+"path:"+buf);
if(!WARN.matcher(item).matches()){
if(strictPath){thrownewIllegalArgumentException("Containsinvalid"+item+"path:"+buf);
if(i<LIMIT-1){buf.append("/");
if(path==null){thrownewNullPointerException("Resourcepathrequired");
if(path.contains("..")||".".equals(path)){thrownewIllegalArgumentException("Relativepathsnotsupported"+path);
if(!VALID.matcher(path).matches()){thrownewIllegalArgumentException("Containsinvalidchracters"+path);
if(!WARN.matcher(path).matches()){
if(strictPath){thrownewIllegalArgumentException("Containsinvalidchracters"+path);
if(path==null||path.length()==0){returnCollections.emptyList();
if(split==-1){returnCollections.singletonList(path);
if(item.length()!=0&&item!="/"){names.add(item);
if(item!=null&&item.length()!=0&&item!="/"){names.add(item);
if(base==null){
if(file.isAbsolute()){thrownewIllegalArgumentException("Unabletodeterminerelativepathasfilewasabsolute");
else{returnconvert(file.getPath());
if(file==null){returnPaths.BASE;
if(fileURI.toString().startsWith(baseURI.toString())){URIrelativize=baseURI.relativize(fileURI);returnrelativize.getPath();
else{returnconvert(file.getPath());
if(base==null){thrownewNullPointerException("Basedirectoryrequiredforrelativepath");
if(item==null)continue;
if(item.equals("."))continue;
if(item.equals("..")){
if(!resolvedPath.isEmpty()){resolvedPath.remove(resolvedPath.size()-1);continue;
else{thrownewIllegalStateException("Filelocation"+fileLocation+"outsideof"+base.getPath());
if(base==null){thrownewNullPointerException("Basedirectoryrequiredforrelativepath");
if(item==null)continue;
if(item.equals("."))continue;
if(item.equals("..")){
if(!resolvedPath.isEmpty()){resolvedPath.remove(resolvedPath.size()-1);continue;
else{thrownewIllegalStateException("Filelocation"+filePath+"outsideof"+base.getPath());
if(filePath==null){returnnull;
if(filePath.length()==0){returnfilePath;
if(File.separatorChar=='/'){returnfilePath;
else{returnfilePath.replace(File.separatorChar,'/');
if(path==null){thrownewNullPointerException("Initialpathrequiredtohandlerelativefilenames");
if(item==null)continue;
if(item.equals("."))continue;
if(item.equals("..")){
if(!resolvedPath.isEmpty()){resolvedPath.remove(resolvedPath.size()-1);continue;
else{thrownewIllegalStateException("Filelocation"+filename+"outsideof"+path);
ifthepagewasproperlyfilledtester.assertModelValue("form:enabled",wmts.isEnabled());tester.assertModelValue("form:title",wmts.getTitle());tester.assertModelValue("form:maintainer",wmts.getMaintainer());tester.assertModelValue("form:abstract",wmts.getAbstract());tester.assertModelValue("form:accessConstraints",wmts.getAccessConstraints());tester.assertModelValue("form:fees",wmts.getFees());tester.assertModelValue("form:onlineResource",wmts.getOnlineResource());
if("ROLE_AUTHENTICATED".equals(name))break;
if(fail)fail("NoruntimeexceptionforreadonlyRoleService");}}
if(!leaf.exists())leaf.mkdirs();tester.startPage(newFormTestPage(newComponentBuilder(){publicComponentbuildComponent(Stringid){returnnewFileBreadcrumbs(id,newModel(root),newModel(leaf)){@OverrideprotectedvoidpathItemClicked(Filefile,AjaxRequestTargettarget){lastClicked=file;setSelection(file);
iftherearependingmodificationsnotwrittentothebackendstore**@returntrue/false*/booleanisModified();/***Setstheparentrole,themethodmustcheck
ifparentRoleisnotequaltoroleand
if*parentRoleisnotcontainedinthedescendantsofrole**<p>Thiscodesequencewilldothejob<code>*RoleHierarchyHelperhelper=newRoleHierarchyHelper(getParentMappings());*
if(helper.isValidParent(role.getAuthority(),*parentRole==null?null:parentRole.getAuthority())==false)*thrownewIOException(parentRole.getAuthority()+*"isnotavalidparentfor"+role.getAuthority());*</code>**@paramrole*@paramparentRolemaybenulltoremoveaparent*/voidsetParentRole(GeoServerRolerole,GeoServerRoleparentRole)throwsIOException;}
if(args.length==1){StringpropertiesFileName=args[0];
if(!propertiesFileName.isEmpty()){properties=newFile(propertiesFileName);
else{properties=newFile("src/test/resources/jetty.properties");
if(property!=null){prop.put(key,property);
else
if(envProp!=null){prop.put(key,envProp);
if(server!=null){try{server.stop();
if(conn!=null){try{conn.stop();
if(props==null||!props.exists()){thrownewIllegalArgumentException("Badfilenameargument:"+props);
if(is!=null)is.close();
if(portVariable==null){return-1;
if(!Resources.exists(file)){thrownewIOException("Cannotlockanotexistingfile:"+file.path());
ifawritelockisholdbythisfilewatcher**@throwsIOException*/publicbooleanhasWriteLock()throwsIOException{returnResources.exists(lockFile)&&lockFile.lastmodified()==lockFileLastModified;
ifawritelockisholdbyanotherfilewatcher**@throwsIOException*/publicbooleanhasForeignWriteLock()throwsIOException{returnResources.exists(lockFile)&&lockFile.lastmodified()!=lockFileLastModified;
if(Resources.exists(lockFile)){
if(lockFile.lastmodified()==lockFileLastModified){lockFileLastModified=0;lockFile.delete();
else{LOGGER.warning("Triedtounlockforeignlock:"+lockFile.path());
else{LOGGER.warning("Triedtounlocknotexisitinglock:"+lockFile.path());
if(hasWriteLock())return;//alreadylocked
if(Resources.exists(lockFile)){LOGGER.warning("Cannotobtainlock:"+lockFile.path());Propertiesprops=newProperties();try(InputStreamin=lockFile.in()){props.load(in);
else{//successwriteLockFileContent(lockFile);lockFileLastModified=lockFile.lastmodified();LOGGER.info("Successfullock:"+lockFile.path());
if(!addr.isLoopbackAddress()&&addr.isSiteLocalAddress())ip=addr.getHostAddress();
if(bboxStr!=null){try{CRSAreaOfValidityMapBuilderbuilder=newCRSAreaOfValidityMapBuilder(width,height);Envelopeenvelope=parseEnvelope(bboxStr);RenderedImageimage=builder.createMapFor(crs,envelope);output=newByteArrayOutputStream();ImageIO.write(image,"PNG",output);
if(byteArray!=null){attributes.getResponse().write(byteArray);
if(content==null){thrownewResourceStreamNotFoundException();
if(steps.size()==1&&steps.get(0).getName().getNamespaceURI()==null||steps.get(0).getName().getNamespaceURI().equals(MetaDataDescriptor.NAMESPACE_APISO)){PropertyNamefullPath=MetaDataDescriptor.QUERYABLE_MAPPING.get(steps.get(0).getName().getLocalPart());
if(fullPath!=null){returnfullPath;
ifenabledistrueIModel<Boolean>enabledModel=newModel<Boolean>(false);enabled=newCheckBox("enabled",enabledModel);add(enabled);enabled.add(newAjaxFormComponentUpdatingBehavior("click"){@OverrideprotectedvoidonUpdate(AjaxRequestTargettarget){Booleanvisible=enabled.getModelObject();advancedConfigPanel.setVisible(visible);target.add(configsContainer);
if(enabled.getModelObject()){returnadvancedConfigPanel.getDependentFormComponents();
else{returnnewFormComponent[]{urlFormComponent};
if(enabled.getModelObject()){coverageUrl=advancedConfigPanel.buildURL()+coverageUrl;
ifpossible)*/GeometrysafeRoiInNativeCRS;/**ROInativeCRS*/CoordinateReferenceSystemnativeCRS;/**ROIreprojectedinthetargetCRS*/GeometryroiInTargetCRS;/**ROIreprojectedinthetargetCRS(reducedtoenvelope
ifpossible)*/GeometrysafeRoiInTargetCRS;/**InitialROICRS*/finalCoordinateReferenceSystemroiCRS;/**ROItargetCRS*/CoordinateReferenceSystemtargetCRS;/**Booleanindicating
iftheROIisaBBOX*/finalbooleanisROIBBOX;/**Booleanindicating
iftheroiCRSequalsthetargetCRS*/booleanroiCrsEqualsTargetCrs=true;/***Constructor.**@paramroioriginalROIasaJTSgeometry*@paramroiCRS{@linkCoordinateReferenceSystem}fortheprovidedgeometry.Ifthisisnull*theCRSmustbeprovidedwiththeUSerDataoftheroi*/publicROIManager(Geometryroi,CoordinateReferenceSystemroiCRS){this.originalRoi=roi;DownloadUtilities.checkPolygonROI(roi);//CheckROICRS
if(roiCRS==null){
if(!(roi.getUserData()instanceofCoordinateReferenceSystem)){thrownewIllegalArgumentException("ROIwithoutaCRSisnotusable!");
else{this.roiCRS=roiCRS;
if(nativeCRS==null){thrownewIllegalArgumentException("TheprovidednativeCRSisnull");
if(isROIBBOX){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"ROIisaBoundingBox");
iftheROIisaBBOXwetendtopreservethefactthatitisaBBOXsafeRoiInNativeCRS=roiInNativeCRS.getEnvelope();
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"ROIisnotaBoundingBox");
if(targetCRS==null){thrownewIllegalArgumentException("TheprovidedtargetCRSisnull");
if(roiInNativeCRS==null){thrownewIllegalStateException("ItlookslikeuseNativeCRShasnotbeencalledyet");
if(!CRS.equalsIgnoreMetadata(roiCRS,targetCRS)){MathTransformreprojectionTrasform=CRS.findMathTransform(roiCRS,targetCRS,true);
if(!reprojectionTrasform.isIdentity()){//avoiddoingthetransform
ifthisistheidentityroiCrsEqualsTargetCrs=false;
if(isROIBBOX){//weneedtousealargerbboxinnativeCRSroiInTargetCRS=DownloadUtilities.transformGeometry(safeRoiInNativeCRS,targetCRS);DownloadUtilities.checkPolygonROI(roiInTargetCRS);safeRoiInTargetCRS=roiInTargetCRS.getEnvelope();safeRoiInTargetCRS.setUserData(targetCRS);//BacktotheminimalroiInTargetCrsforfutureclipping
ifneeded.roiInTargetCRS=roiCrsEqualsTargetCrs?originalRoi:DownloadUtilities.transformGeometry(originalRoi,targetCRS);//touchsafeRoiInNativeCRSsafeRoiInNativeCRS=DownloadUtilities.transformGeometry(safeRoiInTargetCRS,nativeCRS);DownloadUtilities.checkPolygonROI(safeRoiInNativeCRS);safeRoiInNativeCRS=safeRoiInNativeCRS.getEnvelope();safeRoiInNativeCRS.setUserData(nativeCRS);
else{roiInTargetCRS=DownloadUtilities.transformGeometry(roiInNativeCRS,targetCRS);safeRoiInTargetCRS=roiInTargetCRS;
if(clip){//clippingmeanscarefullyfollowingtheROIshapereturnisRoiCrsEqualsTargetCrs()?originalRoi:getRoiInTargetCRS();
else{//useenvelopeoftheROItosimplycropandnotcliptheraster.Thisisimportant//sincewhen//reprojectingwemightreadabitmorethanneeded!returnisRoiCrsEqualsTargetCrs()?originalRoi.getEnvelope():getSafeRoiInTargetCRS().getEnvelope();
if(file.isDirectory()){returnfile.getName()+"/";
else{returnfile.getName();
if(lastModified==0L)returnnull;
else{returnDateFormat.getDateTimeInstance(DateFormat.MEDIUM,DateFormat.SHORT).format(newDate(file.lastModified()));
if(!file.isFile())return"";longsize=file.length();
if(size==0L)returnnull;
if(size<KBYTE){returnsize+"";
else
if(size<MBYTE){returnnewDecimalFormat("#.#").format(size/KBYTE)+"K";
else
if(size<GBYTE){returnnewDecimalFormat("#.#").format(size/MBYTE)+"M";
else{returnnewDecimalFormat("#.#").format(size/GBYTE)+"G";
if(tableHeight!=null){tag.getAttributes().put("style","overflow:auto;height:"+tableHeight);
if(!KEYPATTERN.matcher(ruleKey).matches())return"Invalid'"+ruleKey+"'notmatching"+KEYPATTERN;returnnull;
ifpathisrelative.**@paramresourceSpringresource*@paramstoretheResourceStore*@returnSpringresourcerelativetoDataDirectory*@throwsIOException*/publicstaticorg.springframework.core.io.Resourcerelative(org.springframework.core.io.Resourceresource,ResourceStorestore)throwsIOException{Filef=resource.getFile();
if(f!=null){
if(!f.isAbsolute()){//makerelativetodatadirectory--orcreatefilefromresourcestoreResourceres=store.get(Paths.convert(f.getPath()));returnnewSpringResourceAdaptor(res);
else{returnnewSpringResourceAdaptor(Files.asResource(f));
else{returnresource;
if(configinstanceofXMLSecurityServiceConfig){validatingXMLSchema=((XMLSecurityServiceConfig)config).isValidating();//copyschemafileResourcexsdFile=getConfigRoot().get(XMLConstants.FILE_RR_SCHEMA);
if(xsdFile.getType()==Type.UNDEFINED){IOUtils.copy(getClass().getResourceAsStream(XMLConstants.FILE_RR_SCHEMA),xsdFile.out());
if(configinstanceofFileBasedSecurityServiceConfig){StringfileName=((FileBasedSecurityServiceConfig)config).getFileName();FileroleFile=newFile(fileName);
if(roleFile.isAbsolute()){roleResource=Files.asResource(roleFile);
else{roleResource=getConfigRoot().get(fileName);
if(roleResource.getType()==Type.UNDEFINED){IOUtils.copy(getClass().getResourceAsStream("rolesTemplate.xml"),roleResource.out());
else{thrownewIOException("Cannotinitializefrom"+config.getClass().getName());
if(isValidatingXMLSchema()){XMLValidator.Singleton.validateRoleRegistry(doc);
if(parentName!=null&&parentName.length()>0){helper.role_parentMap.put(helper.roleMap.get(roleName),helper.roleMap.get(parentName));
if(bean==null){//buildthebeanfromtheURIintherepomodel,
ifit'saPostgreSQLlocation.URIlocation=repoModel.getObject().getLocation();
if(location!=null&&"postgresql".equals(location.getScheme())){//buildabeanfromthepartsbean=PostgresConfigBean.from(location);
else{bean=PostgresConfigBean.newInstance();
if(repoModel!=null){repoModel.detach();
ifwedon'thaveformatsconfigured,wecannotrespond
if(formats.isEmpty()){LOGGER.log(Level.FINE,"Emptyformats");returnfalse;
if(!super.canHandle(operation)){returnfalse;
if(request!=null&&(request.getOutputFormat()==null||!formats.containsKey(request.getOutputFormat()))){LOGGER.log(Level.FINE,"Formatsare:"+formats);returnfalse;
else{returntrue;
if(response.getBinding().equals(FeatureCollectionResponse.class)&&response!=this){responses.add(response);
if(!formats.equals(newFormats)){Map<String,String>replacement=newHashMap<String,String>();for(Stringformat:newFormats){replacement.put(format,format);
if(extension==null){extension=".txt";sb.append(extension);
if(!extension.startsWith(".")){sb.append(".");
if(transformer.getOutputProperties()!=null&&"yes".equals(transformer.getOutputProperties().getProperty("indent"))){try{transformer.setOutputProperty("{http://xml.apache.org/xslt}indent-amount","2");
if(sourceResponse==null){thrownewWFSException("Couldnotlocatearesponsethatcangeneratethedesiredsourceformat'"+info.getSourceFormat()+"'fortransformation'"+info.getName()+"'");
if(transformerException!=null){thrownewWFSException("FailedtorunthetheXSTLtransformation",transformerException);
if(r.getOutputFormats().contains(info.getSourceFormat())&&r.canHandle(sourceOperation)){returnr;
if(curr==null){thrownewWFSException("CouldnotfindaXSLTtransformationgenerating"+outputFormat+"forfeaturetype"+ft.getName(),ServiceException.INVALID_PARAMETER_VALUE,"typeName");
else
if(result==null){reference=ft;result=curr;
else
if(!result.equals(curr)){thrownewWFSException("MultiplefeaturetypesaremappedtodifferentXLSTtransformations,cannotproceed:"+result.getXslt()+","+curr.getXslt(),ServiceException.INVALID_PARAMETER_VALUE,"typeName");
if(info!=null){List<TransformInfo>transforms=repository.getTypeTransforms(info);result=filterByOutputFormat(outputFormat,transforms);
if(result==null){List<TransformInfo>transforms=repository.getGlobalTransforms();result=filterByOutputFormat(outputFormat,transforms);
if(outputFormat.equals(tx.getOutputFormat())){returntx;
if(executor!=null){executor.shutdown();executor.awaitTermination(10,TimeUnit.SECONDS);executor=null;
if(path.toLowerCase().contains("content")){templatePath=currentTemplate;
else{templatePath="empty.ftl";
iftemplateasksarequestparameterthatisnotpresentinrequestanexceptionis*thrown.*/@TestpublicvoidtestErrorWhenRequestParametersAreNotDefined(){ByteArrayOutputStreamoutStream=newByteArrayOutputStream();booleanerror=false;//removeoneparameterrequiredintemplateparameters.remove("LAYER");try{outputFormat.write(fcType,getFeatureInfoRequest,outStream);
ifthecharacterencodingistheoneexpectedassertTrue("UTF-8".equals(response.getCharacterEncoding()));
if(path.toLowerCase().contains("content")&&(this.resource!=null)&&this.resource.prefixedName().equals(featureType2.prefixedName())){templatePath="test_content.ftl";
if((i%2)==0){assertEquals("",info);
else{assertNotEquals("",info);
if(bytes==null){setModified(false);return;
if(ginstanceofPoint){Pointp=(Point)g;t.element("georss:point",p.getY()+""+p.getX());
if(ginstanceofLineString){LineStringl=(LineString)g;StringBuffersb=newStringBuffer();for(inti=0;i<l.getNumPoints();i++){Coordinatec=l.getCoordinateN(i);sb.append(c.y).append("").append(c.x).append("");
if(ginstanceofPolygon){Polygonp=(Polygon)g;LineStringline=p.getExteriorRing();StringBuffersb=newStringBuffer();for(inti=0;i<line.getNumPoints();i++){Coordinatec=line.getCoordinateN(i);sb.append(c.y).append("").append(c.x).append("");
if(ginstanceofPoint){elementName=org.geotools.gml2.GML.Point;
else
if(ginstanceofLineString){elementName=org.geotools.gml2.GML.LineString;
else
if(ginstanceofPolygon){elementName=org.geotools.gml2.GML.Polygon;
else
if(ginstanceofMultiPoint){elementName=org.geotools.gml2.GML.MultiPoint;
else
if(ginstanceofMultiLineString){elementName=org.geotools.gml2.GML.MultiLineString;
else
if(ginstanceofMultiPolygon){elementName=org.geotools.gml2.GML.MultiPolygon;
else{elementName=org.geotools.gml2.GML._Geometry;
if(feature.getDefaultGeometry()!=null){Geometryg=(Geometry)feature.getDefaultGeometry();//handlecaseofmultigeometrywithasinglegeometryinit
if(ginstanceofGeometryCollection){GeometryCollectionmg=(GeometryCollection)g;
if(mg.getNumGeometries()==1){g=mg.getGeometryN(0);
if(gd==null){//geometrylesslayers...features=source.getFeatures(query);
else{//makesurewearequeryingthesourcewiththebboxintherightCRS,
if//not,reprojectthebboxReferencedEnvelopeenv=newReferencedEnvelope(mapArea);CoordinateReferenceSystemsourceCRS=gd.getCoordinateReferenceSystem();
if(sourceCRS!=null&&!CRS.equalsIgnoreMetadata(mapArea.getCoordinateReferenceSystem(),sourceCRS)){env=env.transform(sourceCRS,true);
if(sourceCRS!=null&&!CRS.equalsIgnoreMetadata(wgs84,sourceCRS)){ReprojectingFeatureCollectioncoll=newReprojectingFeatureCollection(features,wgs84);coll.setDefaultSource(sourceCRS);features=coll;
if(features==null)thrownewNullPointerException();featureCollections.add(features);
if(getIndentation()>0){characters(ch,start,length);
ifaNameSpaceTranslatorwasregistered*forthatnamespace.**<p>Somethemagicforcreatinginstancesusingtheclassloaderoccurshere(ie.the*translatorsarenotloadedlazily)**@paramprefixThedesirednamespaceprefix*@paramnamespaceThedesirednamespace.*/publicvoidaddNameSpaceTranslator(Stringprefix,Stringnamespace){
if((prefix==null)||(namespace==null)){thrownewNullPointerException();
if(nstClass==null){return;
ifitwasnotfound*/publicNameSpaceTranslatorgetNameSpaceTranslator(Stringprefix){return(NameSpaceTranslator)namespaceTranslatorInstances.get(prefix);
if((nameSpaceTranslator!=null)&&NameSpaceTranslator.class.isAssignableFrom(nameSpaceTranslator)){namespaceTranslators.put(namespace,nameSpaceTranslator);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;Eventother=(Event)obj;
if(kind!=other.kind)returnfalse;
if(path==null){
if(other.path!=null)returnfalse;
else
if(!path.equals(other.path))returnfalse;returntrue;
if(created==null){created=Collections.emptyList();
if(removed==null){removed=Collections.emptyList();
if(modified==null){modified=Collections.emptyList();
if(size==0){returnnull;
if(!checkEquals(geoServerA.getGlobal(),geoServerB.getGlobal())){differences.add(newInfoDiff(geoServerA.getGlobal(),geoServerB.getGlobal()));
if(!checkEquals(geoServerA.getLogging(),geoServerB.getLogging())){differences.add(newInfoDiff(geoServerA.getLogging(),geoServerB.getLogging()));
if(!checkEquals(service,otherService)){//differentservicefound,theotherservicemaybeNULLwhichmeans//thatthisserviceonlyexistsinGeoServerAdifferences.add(newInfoDiff(service,otherService));
if(checkEqualsByNameAndWorkspace(info,candidateInfo)){//servicefoundreturncandidateInfo;
iftheserviceshavethesamenameandthesameworkspace.*/privatestaticbooleancheckEqualsByNameAndWorkspace(ServiceInfoinfoA,ServiceInfoinfoB){returnObjects.equals(infoA.getName(),infoB.getName())&&Objects.equals(infoA.getWorkspace(),infoB.getWorkspace());
if(!checkEquals(settings,otherSettings)){//differentsettingsfound,theothersettingsmaybeNULLwhichmeans//thatthissettingsonlyexistsinGeoServerAdifferences.add(newInfoDiff(settings,otherSettings));
if(Objects.equals(info.getId(),candidateInfo.getId())){//settingsfoundreturncandidateInfo;
if(settings!=null){allSettings.add(settings);
ifonlyoneoftheinfosisNULLtheyarenotthesame
if((infoA==null||infoB==null)&&infoA!=infoB){returnfalse;
if(Double.isNaN(sample)){returnreservedValue;
if(!Double.isNaN(updatingMin)){min=min>updatingMin?updatingMin:min;
if(!Double.isNaN(updatingMax)){max=max<updatingMax?updatingMax:max;
if(count!=null){intic=count.intValue();
if(ic<0){thrownewOWS20Exception("Invalid'count'value,shouldbepositiveorzero",OWSExceptionCode.InvalidParameterValue);
if(ic>configuredMaxFeatures){thrownewOWS20Exception("Invalid'count'value,shouldnotbegreaterthan"+configuredMaxFeatures,OWSExceptionCode.InvalidParameterValue);
else{query.setMaxFeatures(getDefaultRecords());
if(startIndex!=null){intis=startIndex.intValue();
if(is<=0){thrownewOWS20Exception("Invalid'startIndex'value,shouldbepositiveorzero",OWSExceptionCode.InvalidParameterValue);
if(info==null){returnOSEOInfo.DEFAULT_RECORDS_PER_PAGE;
else{returninfo.getRecordsPerPage();
if(info==null){returnOSEOInfo.DEFAULT_MAXIMUM_RECORDS;
else{returninfo.getMaximumRecordsPerPage();
if(value!=null){finalStringsv=Converters.convert(value,String.class);result.put(parameter,sv);
if(!StringUtils.isEmpty(value)&&!NOT_FILTERS.contains(parameter.key)){Filterfilter=null;
if(SEARCH_TERMS.key.equals(parameter.key)){filter=buildSearchTermsFilter(value);
else
if(GEO_UID.key.equals(parameter.key)){filter=buildUidFilter(value);
else
if(GEO_BOX.key.equals(parameter.key)){filter=buildBoundingBoxFilter(value);
else
if(GEO_LAT.key.equals(parameter.key)){filter=buildLatLonDistanceFilter(rawKvp);
else
if(GEO_NAME.key.equals(parameter.key)){filter=buildNameDistanceFilter(rawKvp);
else
if(isEoParameter(parameter)){filter=buildEoFilter(parameter,value);
if(filter!=null){filters.add(filter);
if(timeFilter!=null){filters.add(timeFilter);
if(geoFilter!=null){filters.add(geoFilter);
if(relation==null&&rawRelation!=null){finalList<String>dateRelationNames=Arrays.stream(DateRelation.values()).map(k->k.name()).collect(Collectors.toList());thrownewOWS20Exception("Invalidvalueforrelation,possiblevaluesare"+dateRelationNames,OWS20Exception.OWSExceptionCode.InvalidParameterValue,TIME_RELATION.key);
if(start==null&&rawStart!=null){thrownewOWS20Exception("Invalidexpressionforstarttime,useaISOtimeordateinstead:"+rawStart,OWS20Exception.OWSExceptionCode.InvalidParameterValue,TIME_START.key);
if(end==null&&rawEnd!=null){thrownewOWS20Exception("Invalidexpressionforendtime,useaISOtimeordateinstead:"+rawStart,OWS20Exception.OWSExceptionCode.InvalidParameterValue,TIME_END.key);
if(start==null&&end==null){
if(relation==null){//nothingspecifiedreturnnull;
else{thrownewOWS20Exception("Timerelationspecified,butstartandendtimevaluesaremissing",OWS20Exception.OWSExceptionCode.InvalidParameterValue,TIME_RELATION.key);
ifnull
if(relation==null){relation=DateRelation.intersects;
switch(relation){casecontains://theresourcecontainsthespecifiedrangeFilterfStart;
if(start==null){fStart=FF.isNull(startProperty);
else{fStart=FF.lessOrEqual(startProperty,FF.literal(start));
if(end==null){fEnd=FF.isNull(endProperty);
else{fEnd=FF.greaterOrEqual(endProperty,FF.literal(end));
if(start==null){returnfEnd;
else
if(end==null){returnfStart;
else{returnFF.and(fStart,fEnd);
if(start==null){returnfEnd;
else
if(end==null){returnfStart;
else{returnFF.or(fStart,fEnd);
if(start==null){returnfEnd;
else
if(end==null){returnfStart;
else{returnFF.and(fStart,fEnd);
if(start==null){fStart=FF.isNull(startProperty);
else{fStart=FF.equals(startProperty,FF.literal(start));
if(end==null){fEnd=FF.isNull(endProperty);
else{fEnd=FF.equals(endProperty,FF.literal(end));
if(lat==null||lon==null||radius==null){thrownewOWS20Exception("Whenspecifyingadistancesearch,lat,lonandradiusmustallbespecifiedatthesametime",OWS20Exception.OWSExceptionCode.InvalidParameterValue);
if(name==null||radius==null){thrownewOWS20Exception("Whenspecifyingadistancesearch,nameandradiusmustbothbespecified",OWS20Exception.OWSExceptionCode.InvalidParameterValue);
if(radius<=0){thrownewOWS20Exception("Searchradiusmustbepositive",OWS20Exception.OWSExceptionCode.InvalidParameterValue,"radius");
if(parsedinstanceofReferencedEnvelope){filter=FF.bbox(DEFAULT_GEOMETRY,(ReferencedEnvelope)parsed,MatchAction.ANY);
else
if(parsedinstanceofReferencedEnvelope[]){ReferencedEnvelope[]envelopes=(ReferencedEnvelope[])parsed;BBOXbbox1=FF.bbox(DEFAULT_GEOMETRY,envelopes[0],MatchAction.ANY);BBOXbbox2=FF.bbox(DEFAULT_GEOMETRY,envelopes[1],MatchAction.ANY);returnFF.or(bbox1,bbox2);
else{thrownewIllegalArgumentException("Unexpectedbboxparseresult:"+parsed);
if(rawGeometry==null&&rawRelation==null){returnnull;
if(relation==null&&rawRelation!=null){finalList<String>geoRelationNames=Arrays.stream(GeometryRelation.values()).map(k->k.name()).collect(Collectors.toList());thrownewOWS20Exception("Invalidvalueforrelation,possiblevaluesare"+geoRelationNames,OWS20Exception.OWSExceptionCode.InvalidParameterValue,GEO_RELATION.key);
if(relation==null){relation=GeometryRelation.intersects;
switch(relation){caseintersects:returnFF.intersects(DEFAULT_GEOMETRY,FF.literal(geometry));casecontains:returnFF.contains(FF.literal(geometry),DEFAULT_GEOMETRY);casedisjoint:returnFF.disjoint(DEFAULT_GEOMETRY,FF.literal(geometry));default:thrownewRuntimeException("Geometryrelationoftype"+relation+"notcoveredyet");
if(group.startsWith("\"")&&group.endsWith("\"")&&group.length()>1){group=group.substring(1,group.length()-1);
if(value==null){returnnull;
else{returngetParameter(key,value,targetClass);
if(converted==null){thrownewOWS20Exception(key+"cannotbeconvertedtoa"+targetClass.getSimpleName(),OWSExceptionCode.InvalidParameterValue,key);
if(prefix==null){returnfalse;
if(prefix.equals(OpenSearchParameters.EO_PREFIX)){returntrue;
if(pc.getPrefix().equals(prefix)){returntrue;
if(Date.class.isAssignableFrom(type)||Number.class.isAssignableFrom(type)){Matchermatcher;
if((matcher=FULL_RANGE_PATTERN.matcher(input)).matches()){Stringopening=matcher.group(1);Strings1=matcher.group(2);Strings2=matcher.group(3);Stringclosing=matcher.group(4);//parseandchecktheyareactuallyvalidnumbers/datesObjectv1=parseParameter(parameter,s1);Objectv2=parseParameter(parameter,s2);Filterf1,f2;Literall1=FF.literal(v1);Literall2=FF.literal(v2);
if("[".equals(opening)){f1=FF.greaterOrEqual(pn,l1);
else{f1=FF.greater(pn,l1);
if("]".equals(closing)){f2=FF.lessOrEqual(pn,l2);
else{f2=FF.less(pn,l2);
else
if((matcher=LEFT_RANGE_PATTERN.matcher(input)).matches()){Stringopening=matcher.group(1);Strings1=matcher.group(2);//parseandchecktheyareactuallyvalidnumbers/datesObjectv1=parseParameter(parameter,s1);Literall1=FF.literal(v1);
if("[".equals(opening)){returnFF.greaterOrEqual(pn,l1);
else{returnFF.greater(pn,l1);
else
if((matcher=RIGHT_RANGE_PATTERN.matcher(input)).matches()){Strings2=matcher.group(1);Stringclosing=matcher.group(2);//parseandchecktheyareactuallyvalidnumbers/datesObjectv2=parseParameter(parameter,s2);Literall2=FF.literal(v2);
if("]".equals(closing)){returnFF.lessOrEqual(pn,l2);
else{returnFF.less(pn,l2);
ifit'sacommaseparatedlistvssinglevalue//then
if(input.contains(",")){String[]splits=COMMA_SEPARATED.split(input);List<Filter>filters=newArrayList<>();for(Stringsplit:splits){Filterfilter=buildEqualityFilter(parameter,pn,split);filters.add(filter);
else{//ok,singleequalityfilterthenFilterfilter=buildEqualityFilter(parameter,pn,input);returnfilter;
if(converted==null){thrownewOWS20Exception("Value'"+value+"'ofkey"+parameter.key+"cannotbeconvertedtoa"+parameter.getType().getSimpleName(),OWSExceptionCode.InvalidParameterValue,parameter.key);
if(parentId==null){returnoseo.getCollectionSearchParameters();
else{returnoseo.getProductSearchParameters(parentId);
iftheurlisinvalidforuseasaMetadataLink*@paramurl*/publicstaticvoidvalidate(Stringurl){
if(url==null)return;URLdummy;try{dummy=newURL("http://dummy/");
if(!protocols.contains(protocol)){thrownewIllegalArgumentException("Protocol"+protocol+"isnotsupportedinurl"+url);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofMetadataLinkInfo)){returnfalse;
if(about==null){
if(other.getAbout()!=null)returnfalse;
else
if(!about.equals(other.getAbout()))returnfalse;
if(content==null){
if(other.getContent()!=null)returnfalse;
else
if(!content.equals(other.getContent()))returnfalse;
if(metadataType==null){
if(other.getMetadataType()!=null)returnfalse;
else
if(!metadataType.equals(other.getMetadataType()))returnfalse;
if(type==null){
if(other.getType()!=null)returnfalse;
else
if(!type.equals(other.getType()))returnfalse;returntrue;
iftheexceptioniscausedbySpringSecurity*/publicstaticbooleanisSecurityException(Throwablet){returnt!=null&&t.getClass().getPackage().getName().startsWith("org.springframework.security");
if(ch==null)return;RandomPasswordProviderrpp=newRandomPasswordProvider();rpp.getRandomPassword(ch);
if(ch==null)return;RandomPasswordProviderrpp=newRandomPasswordProvider();rpp.getRandomPassword(ch);
if(policy.getAccessLevel()!=AccessLevel.READ_WRITE){returnnewQuery(null,Filter.EXCLUDE);
else
if(policy.getLimits()==null){returnQuery.ALL;
else
if(policy.getLimits()instanceofVectorAccessLimits){VectorAccessLimitsval=(VectorAccessLimits)policy.getLimits();returnval.getWriteQuery();
else{thrownewIllegalArgumentException("SecureFeatureStorehasbeenfed"+"withunexpectedAccessLimitsclass"+policy.getLimits().getClass());
if(objinstanceofMap){Map<?,?>m=(Map<?,?>)obj;JSONObjectjson=newJSONObject();for(Entry<?,?>entry:m.entrySet()){Stringkey=(String)entry.getKey();Objectvalue=toJSONObject(entry.getValue());json.put(key,value);
else
if(objinstanceofCollection){Collection<?>collection=(Collection<?>)obj;JSONArrayjson=newJSONArray();for(Objectobject:collection){Objectvalue=toJSONObject(object);json.add(toJSONObject(value));
else
if(objinstanceofNumber){returnobj;
else
if(objinstanceofBoolean){returnobj;
else
if(obj==null){returnJSONNull.getInstance();
else{returnobj.toString();
iftheRemoteProcessclassbehavescorrectly.**@author"AlessioFabiani-alessio.fabiani@geo-solutions.it"*/publicclassRemoteProcessTestextendsWPSTestSupport{privatestaticfinalbooleanDISABLE="false".equalsIgnoreCase(System.getProperty("disableTest","true"));privateRemoteProcessFactoryfactory;@OverrideprotectedvoidsetUpSpring(List<String>springContextLocations){super.setUpSpring(springContextLocations);springContextLocations.add("testRemoteAppContext.xml");
if(DISABLE){return;
if(!"test".equals(machine.getServiceName().getNamespaceURI())){assertTrue(xmppUserName.equals(machine.getServiceName().getLocalPart()));assertTrue(Arrays.asList(serviceChannels).contains(machine.getServiceName().getNamespaceURI()));assertTrue(machine.getNodeJID().equals(machine.getServiceName().getNamespaceURI()+"@"+configuration.get("xmpp_bus")+"."+xmppDomain+"/"+xmppUserName));
if(server!=null){try{xmppRemoteClient.destroy();server.stop();
if(PresenceStanzaType.isAvailable(stanza.getPresenceType())){returnType.available;
else{returnType.unavailable;
if(presence==null){returnnewPresence(Type.unavailable,"AWAY",0,null);
else{try{Presencep=newPresence(type(presence),presence.getStatus(null),0,null);returnp;
if(factory==null){factory=newRemoteProcessFactory();//checkSPIwillseethefactory
ifweregisteritusinganiterator//providerGeoTools.addFactoryIteratorProvider(newFactoryIteratorProvider(){public<T>Iterator<T>iterator(Class<T>category){
if(ProcessFactory.class.isAssignableFrom(category)){return(Iterator<T>)Collections.singletonList(factory).iterator();
else{returnnull;
ifnoacceptlistprovided,wereturnthebiggestsupportedversion
if(acceptedList==null||acceptedList.isEmpty())returnprovided.last().toString();//nextfigureoutwhattheclientaccepts(andchecktheyaregoodversionnumbers)List<Version>accepted=newArrayList<Version>();for(Stringv:acceptedList){checkVersionNumber20(v,"AcceptVersions");accepted.add(newVersion(v));
if(provided.contains(version)){negotiated=version;break;
if(negotiated==null)thrownewOWS20Exception("Couldnotfindanymatchingversion",OWS20Exception.OWSExceptionCode.VersionNegotiationFailed);returnnegotiated.toString();
iftheversionnumberisnot*valid.**@paramvtheversionnumber(instringformat)*@paramthelocatorfortheserviceexception(maybenull)*/publicstaticvoidcheckVersionNumber20(Stringv,Stringlocator)throwsServiceException{
if(!v.matches("[0-9]{1,2}\\.[0-9]{1,2}(\\.[0-9]{1,2})?")){Stringmsg=v+"isaninvalidversionnumber";thrownewOWS20Exception("Couldnotfindanymatchingversion,"+msg,OWS20Exception.OWSExceptionCode.VersionNegotiationFailed,locator);
if(!coverageEnvelope.intersects((BoundingBox)ReferencedEnvelope.reference(readGG.getEnvelope()))){returnnull;
ifwehaveanysuppliedbyauser.//////firstIcreatedthecorrectReadGeometryfinalParameter<GridGeometry2D>readGGParam=(Parameter<GridGeometry2D>)AbstractGridFormat.READ_GRIDGEOMETRY2D.createValue();readGGParam.setValue(readGG);finalParameter<Interpolation>readInterpolation=(Parameter<Interpolation>)ImageMosaicFormat.INTERPOLATION.createValue();readInterpolation.setValue(interpolation);finalParameter<OverviewPolicy>readOverview=(Parameter<OverviewPolicy>)AbstractGridFormat.OVERVIEW_POLICY.createValue();readOverview.setValue(overviewPolicy);//thenItrytogetreadparametersassociatedwiththis//coverage
ifthereareany.GridCoverage2Dcoverage=null;GeneralParameterValue[]readParams=(GeneralParameterValue[])params;finalintlength=readParams==null?0:readParams.length;
if(length>0){////////Gettingparameterstocontrolhowtoreadthiscoverage.//Remembertochecktoactuallyhavethembeforeforwarding//themtothereader.////////wehaveavalidnumberofparameters,let'scheck
if//alsohaveaREAD_GRIDGEOMETRY2D.Insuchcasewejust//overrideitwiththeonewejustbuildforthis//request.finalStringreadGGName=AbstractGridFormat.READ_GRIDGEOMETRY2D.getName().toString();finalStringreadInterpolationName=ImageMosaicFormat.INTERPOLATION.getName().toString();finalStringoverviewPolicyName=AbstractGridFormat.OVERVIEW_POLICY.getName().toString();inti=0;booleanfoundInterpolation=false;booleanfoundGG=false;booleanfoundOverviewPolicy=false;for(;i<length;i++){finalStringparamName=readParams[i].getDescriptor().getName().toString();
if(paramName.equalsIgnoreCase(readGGName)){((Parameter)readParams[i]).setValue(readGG);foundGG=true;
else
if(paramName.equalsIgnoreCase(readInterpolationName)){((Parameter)readParams[i]).setValue(interpolation);foundInterpolation=true;
else
if(paramName.equalsIgnoreCase(overviewPolicyName)){//Overridethedefaultoverviewvalueusingtheonefoundonreadparams((Parameter)readParams[i]).setValue(overviewPolicy);foundOverviewPolicy=true;
if(!foundGG||!foundInterpolation||!foundOverviewPolicy){//||!(foundBgColor&&bgColor!=null)){//addthecorrectreadgeometrytothesupplied//paramssincewedidnotfindanythingList<GeneralParameterValue>paramList=newArrayList<GeneralParameterValue>();paramList.addAll(Arrays.asList(readParams));
if(!foundGG){paramList.add(readGGParam);
if(!foundInterpolation){paramList.add(readInterpolation);
if(!foundOverviewPolicy&&readOverview!=null&&readOverview.getValue()!=null){paramList.add(readOverview);
else{coverage=(GridCoverage2D)reader.read(newGeneralParameterValue[]{readGGParam,readInterpolation});
ifnone.*Notethatthereturnedinstancemaybeanimmutableone,notnecessarlythedefaultJava2D*implementation.**@paramgridToCRSThe"gridtoCRS"{@linkMathTransform}transform.*@returnThe"gridtoCRS"affinetransformofthegivencoverage,or{@codenull}
ifnoneor*
ifthetransformisnotaffine.*/publicstaticAffineTransformgetAffineTransform(finalMathTransformgridToCRS){
if(gridToCRS==null){returnnull;
if(gridToCRSinstanceofAffineTransform){return(AffineTransform)gridToCRS;
ifit'samosaic,limitthenumberoftileswe'regoingtoreadtoone//(withtimeandelevationtheremightbehundredsofsuperimposedtiles)//-readingtheGridCoveragesubset//finalGeneralEnvelopeoriginalEnvelope=reader.getOriginalEnvelope();finalGridEnvelopeoriginalRange=reader.getOriginalGridRange();finalFormatcoverageFormat=reader.getFormat();finalParameterValueGroupreadParams=coverageFormat.getReadParameters();finalMapparameters=CoverageUtils.getParametersKVP(readParams);finalintminX=originalRange.getLow(0);finalintminY=originalRange.getLow(1);finalintwidth=originalRange.getSpan(0);finalintheight=originalRange.getSpan(1);finalintmaxX=minX+(width<=5?width:5);finalintmaxY=minY+(height<=5?height:5);//wehavetobesurethatweareworkingagainstavalidgridrange.finalGridEnvelope2DtestRange=newGridEnvelope2D(minX,minY,maxX,maxY);//buildthecorrespondingenvelopefinalMathTransformgridToWorldCorner=reader.getOriginalGridToWorld(PixelInCell.CELL_CORNER);finalGeneralEnvelopetestEnvelope=CRS.transform(gridToWorldCorner,newGeneralEnvelope(testRange.getBounds()));testEnvelope.setCoordinateReferenceSystem(originalEnvelope.getCoordinateReferenceSystem());//makesuremosaicswithmanysuperimposedtileswon'tblowupwith//a"toomanyopenfiles"exceptionStringmaxAllowedTiles=ImageMosaicFormat.MAX_ALLOWED_TILES.getName().toString();
if(parameters.keySet().contains(maxAllowedTiles)){parameters.put(maxAllowedTiles,1);
if(reader_==null){thrownewException("Unabletoacquireareaderforthiscoveragewithformat:"+store.getFormat().getName());
if(version==null){thrownewWCS20Exception("Missingversion",OWS20Exception.OWSExceptionCode.MissingParameterValue,version);
if(!WCS20Const.V201.equals(version)&&!WCS20Const.V20.equals(version)){thrownewWCS20Exception("Couldnotunderstandversion:"+version);
if(serviceName==null){thrownewWCS20Exception("Missingservicename",OWS20Exception.OWSExceptionCode.MissingParameterValue,"service");
if(!"WCS".equals(serviceName)){thrownewWCS20Exception("Errorinservicename,expectedvalue:WCS",OWS20Exception.OWSExceptionCode.InvalidParameterValue,serviceName);
if(entry==null){entry=newUTFGridEntry(value++,feature);entryMap.put(id,entry);
if(resourceLocator==null&&inputinstanceofFile){resourceLocator=newDefaultResourceLocator();((DefaultResourceLocator)resourceLocator).setSourceUrl(URLs.fileToUrl((File)input));
if(topoObj!=null){layers.put(layerName,topoObj);
if(out.isInMemory()){byte[]data=out.getData();length=data.length;map=newRawMap(mapContent,data,MIME_TYPE);
else{Filef=out.getFile();length=f.length();map=newDeferredFileOutputStreamWebMap(mapContent,out,MIME_TYPE);
if(geom.isEmpty()){returnnull;
if(geominstanceofGeometryCollection&&geom.getNumGeometries()==1){geom=geom.getGeometryN(0);
if(geominstanceofPoint){topoGeom=createPoint((Point)geom);
else
if(geominstanceofMultiPoint){topoGeom=createMultiPoint((MultiPoint)geom);
else
if(geominstanceofLineString){topoGeom=createLineString((LineString)geom);
else
if(geominstanceofMultiLineString){topoGeom=createMultiLineString((MultiLineString)geom);
else
if(geominstanceofPolygon){topoGeom=createPolygon((Polygon)geom);
else
if(geominstanceofMultiPolygon){topoGeom=createMultiPolygon((MultiPolygon)geom);
else
if(geominstanceofGeometryCollection){topoGeom=createGeometryCollection((GeometryCollection)geom);
else{thrownewIllegalArgumentException("Unknowngeometrytype:"+geom.getGeometryType());
if(workspaceName!=null&&catalog.getWorkspaceByName(workspaceName)==null){thrownewResourceNotFoundException("Workspace"+workspaceName+"notfound");
if(layerName!=null){returnwrapList(catalog.getLayerByName(layerName).getStyles(),StyleInfo.class);
else
if(workspaceName!=null){returnwrapList(catalog.getStylesByWorkspace(workspaceName),StyleInfo.class);
if(layerName!=null){StyleInfoexisting=catalog.getStyleByName(style.getName());
if(existing==null){thrownewResourceNotFoundException();
if(makeDefault){l.setDefaultStyle(existing);
else{
if(workspaceName!=null){style.setWorkspace(catalog.getWorkspaceByName(workspaceName));
if(name==null){name=getNameFromStyle(styleSld);
if(name==null){name=getNameFromStyle(style);
if(sinfo==null){Stringmessage="Nosuchstyle:"+styleName;
if(workspace!=null){message="Nosuchstyle"+styleName+"inworkspace"+workspace;
else{returnsinfo;
if(style==null){thrownewResourceNotFoundException("Style"+styleName+"notfound");
if(recurse){newCascadeDeleteVisitor(catalog).visit(style);
else{//ensurethatnolayersreferencethestyleList<LayerInfo>layers=catalog.getLayers(style);
if(!layers.isEmpty()){thrownewRestException("Can'tdeletestylereferencedbyexistinglayers.",HttpStatus.FORBIDDEN);
if(styleName==null){styleName=getNameFromStyle(styleSld);
if(styleName==null){thrownewRestException("Stylemusthaveaname.",HttpStatus.BAD_REQUEST);
if(!existsStyleInCatalog(workspaceName,styleName)){thrownewRestException("Style"+styleName+"doesn'texist.",HttpStatus.FORBIDDEN);
if(raw){writeStyleRaw(info,newByteArrayInputStream(rawData));try{//figureout
ifweneedaversion
switchfor(StyleHandlerhandler:Styles.handlers()){
if(Objects.equals(info.getFormat(),handler.getFormat())){Versionversion=Styles.handler(info.getFormat()).version(content);
if(version!=null){info.setFormatVersion(version);
else{try{StyleHandlerhandler=Styles.handler(mimeType);Versionversion=handler.versionForMimeType(mimeType);StyledLayerDescriptorsld=handler.parse(content,version,null,entityResolver);writeStyle(info,sld,rawData,handler,version);catalog.save(info);
if(info.getWorkspace()!=null){
if(!info.getWorkspace().equals(original.getWorkspace())){thrownewRestException("Can'tchangetheworkspaceofastyle,instead"+"DELETEfromexistingworkspaceandPOSTtonewworkspace",HttpStatus.FORBIDDEN);
iftherewasanerrorpersistingthestyle,or
iftherewasavalidation*error.*/privatevoidwriteStyle(StyleInfoinfo,StyledLayerDescriptorsld,byte[]rawData,StyleHandlerhandler,Versionversion)throwsException{ResourcePoolresourcePool=catalog.getResourcePool();//Ifthereismorethanonelayer,assumethisisastylegroupandvalidateaccordingly.
if(sld.getStyledLayers().length>1){List<Exception>validationErrors=SLDNamedLayerValidator.validate(catalog,sld);
if(validationErrors.size()>0){throwvalidationErrors.get(0);
if(handlerinstanceofSLDHandler&&sld.getStyledLayers().length<=1){info.setFormat(handler.getFormat());resourcePool.writeStyle(info,style,true);
else{info.setFormat(handler.getFormat());info.setFormatVersion(version);writeStyleRaw(info,newByteArrayInputStream(rawData));
iftherewasanerrorpersistingthestyle*/privatevoidwriteStyleRaw(StyleInfoinfo,InputStreaminput)throwsIOException{try{catalog.getResourcePool().writeStyle(info,input);
iftherewasanerrorparsingthestyle.*/privateStyleparseSld(FilesldFile)throwsRestException{Stylestyle=null;InputStreamis=null;try{is=newFileInputStream(sldFile);SLDParserparser=newSLDParser(CommonFactoryFinder.getStyleFactory(null),is);EntityResolverresolver=catalog.getResourcePool().getEntityResolver();
if(resolver!=null){parser.setEntityResolver(resolver);
if(styles.length>0){style=styles[0];
if(style==null){thrownewRestException("Styleerror.",HttpStatus.BAD_REQUEST);
iftherewasanerrorextractingthearchive*/privateFileunzipSldPackage(InputStreamobject)throwsIOException{FiletempDir=Files.createTempDir();org.geoserver.util.IOUtils.decompress(object,tempDir);returntempDir;
if(matchingFiles==null||matchingFiles.length==0){thrownewRestException("Nosldfileprovided:",HttpStatus.FORBIDDEN);
iftherewasanerrorsavingtheimageresources*/privatevoidsaveImageResources(Filedirectory,StringworkspaceName)throwsIOException{ResourcestylesDir=workspaceName==null?dataDir.getStyles():dataDir.getStyles(catalog.getWorkspaceByName(workspaceName));File[]imageFiles=listImageFiles(directory);for(FileimageFile:imageFiles){IOUtils.copyStream(newFileInputStream(imageFile),stylesDir.get(imageFile.getName()).out(),true,true);
iftherewasanerrorgeneratingauniquename*/privateStringgetNameFromStyle(Stylestyle)throwsRestException{Stringname=null;
if(style!=null){name=style.getName();
if(name==null){//generatearandomonefor(inti=0;name==null&&i<100;i++){Stringcandidate="style-"+UUID.randomUUID().toString().substring(0,7);
if(catalog.getStyleByName(candidate)==null){name=candidate;
if(name==null){thrownewRestException("Unabletogeneratestylename,specifyonewith'name'"+"parameter",HttpStatus.INTERNAL_SERVER_ERROR);
ifastyleofthegivennameandworkspacealreadyexistsinthe*catalog.*/privateStyleInfocreateStyleInfo(StringworkspaceName,Stringname,StyleHandlerhandler,StringmimeType)throwsRestException{//ensurethatthestyledoesnotalreadyexist
if(catalog.getStyleByName(workspaceName,name)!=null){thrownewRestException("Style"+name+"alreadyexists.",HttpStatus.FORBIDDEN);
if(workspaceName!=null){sinfo.setWorkspace(catalog.getWorkspaceByName(workspaceName));
if(workspace!=null){uriComponents=builder.path("/workspaces/{workspaceName}/styles/{styleName}").buildAndExpand(workspace,name);
else{uriComponents=builder.path("/styles/{id}").buildAndExpand(name);
if(contentType!=null){returncontentType.split(";")[0];
if(contentType!=null&&contentType.split(";").length>1){StringcharsetRaw=contentType.split(";")[1];
if(charsetRaw.contains("=")&&charsetRaw.split("=").length>1){returncharsetRaw.split("=")[1];
ifstyleisinthecatalog.**@paramworkspaceNameThenameoftheworkspace,ornullforaglobalstyle*@paramstyleNameThenameofthestyle*@returntrue
ifthestyleexistsinthecatalog,falseotherwise.*/privatebooleanexistsStyleInCatalog(StringworkspaceName,StringstyleName){return(catalog.getStyleByName(workspaceName,styleName)!=null);
ifinvalid**@paramworkspaceNameTheworkspacename.Ignored
ifnull.*@throwsRestException
iftheworkspacenameisnotnullandtheworkspacedoesn'texistin*thecatalog*/privatevoidcheckWorkspaceName(StringworkspaceName)throwsRestException{
if(workspaceName!=null&&catalog.getWorkspaceByName(workspaceName)==null){thrownewResourceNotFoundException("Workspace"+workspaceName+"notfound");
if*itdoes**@paramworkspaceNameThenameoftheworkspace(ornullforaglobalstyle)*@paramstyleNameThenameofthestyle*@throwsRestException
ifthestyleexists*/privatevoidcheckStyleNotExists(StringworkspaceName,StringstyleName)throwsRestException{
if(existsStyleInCatalog(workspaceName,styleName)){thrownewRestException("Style"+styleName+"alreadyexists.",HttpStatus.FORBIDDEN);
ifitdoes**@paraminfoThestyleinfototest.Filenameshouldbeset.*@throwsRestException
ifthestyleresourceassociatedwiththestyleinfoexists.*/privatevoidcheckStyleResourceNotExists(StyleInfoinfo)throwsRestException{//ensurethataexistingresourcedoesnotalreadyexist,becausewemaynotwantto//overwriteitGeoServerDataDirectorydataDir=newGeoServerDataDirectory(catalog.getResourceLoader());
if(dataDir.style(info).getType()!=Resource.Type.UNDEFINED){thrownewRestException("Styleresource"+info.getFilename()+"alreadyexists.",HttpStatus.FORBIDDEN);
if(!hasTileLayerDef(metadataMap)){returnnull;
if(metadataMap.containsKey(CONFIG_KEY_CACHED_STYLES)){finalStringdefaultStyle=layer.getDefaultStyle()==null?"":layer.getDefaultStyle().prefixedName();StringcachedStylesStr=metadataMap.get(CONFIG_KEY_CACHED_STYLES,String.class);Set<String>cachedStyles=unmarshalSet(cachedStylesStr);TileLayerInfoUtil.setCachedStyles(tileLayerInfo,defaultStyle,cachedStyles);
if(!hasTileLayerDef(metadataMap)){returnnull;
if(tileLayerInfo!=null){tileLayerInfo.setName(tileLayerName(layerGroup));tileLayerInfo.setId(layerGroup.getId());
if(metadataMap.containsKey(CONFIG_KEY_FORMATS)){StringmimeFormatsStr=metadataMap.get(CONFIG_KEY_FORMATS,String.class);Set<String>mimeFormats=unmarshalSet(mimeFormatsStr);info.getMimeFormats().addAll(mimeFormats);
if(metadataMap.containsKey(CONFIG_KEY_AUTO_CACHE_STYLES)){booleanautoCacheStyles=metadataMap.get(CONFIG_KEY_AUTO_CACHE_STYLES,Boolean.class).booleanValue();info.setAutoCacheStyles(autoCacheStyles);
if(metadataMap.containsKey(CONFIG_KEY_IN_MEMORY_CACHED)){booleaninMemoryCached=metadataMap.get(CONFIG_KEY_IN_MEMORY_CACHED,Boolean.class);info.setInMemoryCached(inMemoryCached);
if(i.hasNext()){sb.append(",");
if{@codestr}can'tbeparsedtoaJSONArray*/privatestaticSet<XMLGridSubset>unmarshalGridSubsets(StringgridSubsetsStr)throwsIllegalArgumentException{Set<XMLGridSubset>gridSubsets=newHashSet<XMLGridSubset>();//backwardscompatibilitycheckforwhenstrcomesinas"EPSG:XXX,EPSG:YYY"String[]epsgCodes=gridSubsetsStr.split(",");for(Stringcode:epsgCodes){
if(code.trim().length()==0){continue;
if(metadata!=null){for(Stringkey:LegacyTileLayerInfoLoader._ALL_KEYS){metadata.remove(key);
if(cachedStyles.size()>0){metadata.put(CONFIG_KEY_CACHED_STYLES,marshalList(cachedStyles));
else{metadata.remove(CONFIG_KEY_CACHED_STYLES);
ifthefunctionthrowsanexceptionwhentheparametersnumber//isnotcorrectbooleancatchedException=false;try{//Addanewparameter,shouldtrowanexceptionargs.add(ff.literal(Object.class));f=factory.function(IsInstanceOf.NAME.getName(),args,null);
ifthefunctionthrowsanexceptionwhennoparameters//ispresentcatchedException=false;try{//Addanewparameter,shouldtrowanexceptionf=factory.function(IsInstanceOf.NAME.getName(),null,null);
if(!(context.getService()instanceofWMSInfo)){returnnull;
if(!(featureClass.equals(Folder.class))){returnnull;
ifwehavetoencoderelativelinksGetMapRequestrequest=context.getRequest();StringrelLinks=(String)request.getFormatOptions().get("relLinks");//Addprev/nextlinks
ifrequested
if(request.getMaxFeatures()!=null&&relLinks!=null&&relLinks.equalsIgnoreCase("true")){returnnewFolderRelativeLinksDecorator();
else{returnnull;
ifnotalayerlink,moveon
if(context.getCurrentLayer()==null||context.getCurrentFeatureCollection()==null){returnfeature;
ifany
if(prevStart>=0){encodeSequentialNetworkLink(folder,linkbase,prevStart,maxFeatures,"prev","Previouspage");
ifpotentiallyany
if(context.getCurrentFeatureCollection().size()>=maxFeatures){encodeSequentialNetworkLink(folder,linkbase,nextStart,maxFeatures,"next","Nextpage");
ifthequeriedfeaturetypeissimpleorcomplexbooleanisSimple=true;NamefeatureTypeName=newNameImpl(typeName.getNamespaceURI(),typeName.getLocalPart());FeatureTypeInfoftInfo=catalog.getFeatureTypeByName(featureTypeName);
if(ftInfo!=null){try{isSimple=ftInfo.getFeatureType()instanceofSimpleFeatureType;
if(isSimple){NamespaceInfons=catalog.getNamespaceByURI(typeName.getNamespaceURI());encoder.getNamespaces().declarePrefix(ns.getPrefix(),ns.getURI());
else{//complexfeaturesmaycontainelementsbelongingtoanynamespaceinthecatalog,//sowebetterhavethemalldeclaredintheencoder'snamespacecontextWorkspaceInfolocalWorkspace=LocalWorkspace.get();
if(localWorkspace!=null){//deactivateworkspacefilteringLocalWorkspace.remove();
if(encoder.getNamespaces().getURI(nameSpaceinfo.getPrefix())==null){encoder.getNamespaces().declarePrefix(nameSpaceinfo.getPrefix(),nameSpaceinfo.getURI());
if(extraFormat.contains("yaml")&&content.get("application/json")!=null){//sameschemaasJSONmediaType.schema(content.get("application/json").getSchema());
else
if(extraFormat.contains("text")){mediaType.schema(newStringSchema());
else{mediaType.schema(newBinarySchema());
if(proxyBase==null){//
ifnosystempropertyfallbacktoconfigurationproxyBase=geoServer.getSettings().getProxyBaseUrl();
iftheproxybaseisset
if(proxyBase!=null&&proxyBase.trim().length()>0){baseURL.setLength(0);baseURL.append(proxyBase);
if(pam==null){pam=fac.createParameter();pam.setTask(task);pam.setName(name);task.getParameters().put(name,pam);
if(att==null){att=fac.createAttribute();att.setConfiguration(config);att.setName(name);config.getAttributes().put(name,att);
if(config.getTasks().get(task.getName())!=null){thrownewIllegalArgumentException("tasknamealreadyexistsinconfiguration");
if(config.getBatches().get(batch.getName())!=null){thrownewIllegalArgumentException("batchnamealreadyexistsinconfiguration");
ifithasbeensoftremoved)thisbatchelement*willbeactivated
ifnecessaryandreturned.**@parambatchthebatch.*@paramtaskthetask.*@returntheneworexistingbatchelement.*/publicBatchElementaddBatchElement(finalBatchbatch,finalTasktask){BatchElementbatchElement=getOrCreateBatchElement(batch,task);
if(!batch.getElements().contains(batchElement)){batch.getElements().add(batchElement);batchElement.setBatch(batch);
ifithasbeensoftremoved)thisbatchelement*willbeactivated
ifnecessaryandreturned.**@parambatchthebatch.*@paramtaskthetask.*@parampositiontheposition.*@returntheneworexistingbatchelement.*/publicBatchElementaddBatchElement(finalBatchbatch,finalTasktask,finalintposition){BatchElementbatchElement=getOrCreateBatchElement(batch,task);batch.getElements().remove(batchElement);batch.getElements().add(position,batchElement);batchElement.setBatch(batch);returnbatchElement;
if(batch.getId()!=null){batchElement=dao.getBatchElement(batch,task);
if(batchElement!=null){batchElement.setActive(true);
if(batchElement==null){batchElement=fac.createBatchElement();batchElement.setTask(task);batchElement.setBatch(batch);
if(param.getValue()!=null){Matchermatcher=PATTERN_ATTRIBUTEREF.matcher(param.getValue());
if(matcher.find()){returnmatcher.group(1);
if(attName!=null){attNames.add(attName);
if(att.getName().equals(getAssociatedAttributeName(param))){result.add(param);
ifbatchisdeletable(notrunning)**@parambatchthebatchtoverify*@returnwhetheritisdeletable*/publicbooleanisDeletable(Batchbatch){returndao.getCurrentBatchRuns(batch).isEmpty();
ifconfigurationisdeletable(nobatchesarerunning)**@paramconfigtheconfigtoverify*@returnwhetheritisdeletable*/publicbooleanisDeletable(Configurationconfig){for(Batchbatch:config.getBatches().values()){
if(!dao.getCurrentBatchRuns(batch).isEmpty()){returnfalse;
ifpossible(i.e.
ifthetaskisnotbeingrunalready).**@paramelementthebatchelement.*@returntherun,ornull
ifthetaskisbeingrunelsewhere)*/@Transactional("tmTransactionManager")publicRunrunIfPossible(BatchElementelement,BatchRunbr){
if(dao.getCurrentRun(element.getTask())==null){Runrun=fac.createRun();br.getRuns().add(run);run.setBatchRun(br);run.setStart(newDate());run.setBatchElement(element);returndao.save(run);
else{returnnull;
ifpossible(i.e.
ifthetaskisnotbeingcommittedalready).**@paramelementthebatchelement.*@returntherun,ornull
ifthetaskisbeingcommittedelsewhere)*/@Transactional("tmTransactionManager")publicRunstartCommitIfPossible(Runrun){
if(run==null){System.out.println("runisnull");
if(run.getBatchElement()==null){System.out.println("batchelement"+run.getId()+"isnull");
if(dao.getCommittingRun(run.getBatchElement().getTask())==null){run.setStatus(Run.Status.COMMITTING);returndao.save(run);
else{returnnull;
if(!run.getStatus().isClosed()){
if(run.getEnd()==null){//thetaskstoppedwhilerunningrun.setStatus(Status.FAILED);run.setEnd(newDate());
else
if(br.getStatus()==Status.COMMITTING){//
ifthebatchrunwasalreadyinthecommitphase,//wewerealreadypastthepointofrollingbackrun.setStatus(Status.NOT_COMMITTED);
else{//thetaskwasfinished,butwasneithercommittedorrolledbackrun.setStatus(Status.NOT_ROLLED_BACK);
if(coverage!=null){coverages.add(coverage);
if(resolution!=null){di.setResolution(newBigDecimal(resolution));
switchovertoStyledMapRendereranddosomefancystuffwithcachinglayers,butI*thinkweareawaysoffwithitsmaturitytotrythatyet.SoLitetreatsusquitewell,asitis*statelessandthereforeloadsupniceandfast.**<p>**@authorChrisHolmes,TOPP*@authorSimoneGiannecchini,GeoSolutions*@version$Id$*/publicabstractclassRenderedImageMapResponseextendsAbstractMapResponse{/**Whichformattoencodetheimagein
ifoneisnotsupplied*/privatestaticfinalStringDEFAULT_MAP_FORMAT="image/png";/**WMSServiceconfiguration**/protectedfinalWMSwms;/***/publicRenderedImageMapResponse(WMSwms){this(DEFAULT_MAP_FORMAT,wms);
ifwehavetoseeatranslucentorbitmaskquantizerGetMapRequestrequest=mapContent.getRequest();QuantizeMethodmethod=(QuantizeMethod)request.getFormatOptions().get(PaletteManager.QUANTIZER);booleanuseBitmaskQuantizer=method==QuantizeMethod.Octree||!supportsTranslucency||(method==null&&image.getColorModel().getTransparency()!=Transparency.TRANSLUCENT);//format:spliton';'tohandlesubtypeslike'image/gif;subtype=animated'finalStringformat=request.getFormat().split(";")[0];//dowehavetousethebitmaskquantizer?IndexColorModelicm=mapContent.getPalette();
if(useBitmaskQuantizer){//userprovidedpalette?
if(icm!=null){image=forceIndexed8Bitmask(image,PaletteManager.getInverseColorMapOp(icm));
else
if(palettedFormatName.equalsIgnoreCase(format)){//orformatthatneedspalettetobeapplied?image=forceIndexed8Bitmask(image,null);
else{
if(!(image.getColorModel()instanceofIndexColorModel)){//trytoforceaRGBAsetupimage=newImageWorker(image).rescaleToBytes().forceComponentColorModel().getRenderedImage();ColorIndexerindexer=null;//userprovidedpalette?
if(mapContent.getPalette()!=null){indexer=newCachingColorIndexer(newLRUColorIndexer(icm,1024));
else
if(palettedFormatName.equalsIgnoreCase(format)){//buildthepaletteandgrabtheoptimizedcolorindexerindexer=newQuantizer(256).subsample().buildColorIndexer(image);
ifwehaveanindexertransformtheimage
if(indexer!=null){image=newImageWorker(image).colorIndex(indexer).getRenderedImage();
if((method.getName().startsWith("get")||method.getName().startsWith("is"))&&method.getParameterTypes().length==0){Stringproperty=method.getName().substring(method.getName().startsWith("get")?3:2);returnhandleGet(proxy,method,property);
if(method.getName().startsWith("set")&&args.length==1){Stringproperty=method.getName().substring(3);handleSet(proxy,method,args[0],property);returnnull;
if(properties!=null&&properties().containsKey(property)){//returnthepreviouslysetobjectreturnproperties().get(property);
else{returnhandleGetUnSet(proxy,method,property);
if(properties!=null){returnproperties;
if(properties!=null){returnproperties;
if(wkspace==null){thrownewResourceNotFoundException("Nosuchworkspace:'"+workspaceName+"'found");
if(catalog.getWorkspaceByName(workspace.getName())!=null){thrownewRestException("Workspace'"+workspace.getName()+"'alreadyexists",HttpStatus.UNAUTHORIZED);
if(makeDefault){catalog.setDefaultWorkspace(workspace);LOGGER.info("madeworkspace"+name+"default");
ifonedoesnot//alreadyexistNamespaceInfonamespace=catalog.getNamespaceByPrefix(workspace.getName());
if(namespace==null){LOGGER.fine("Automaticallycreatingnamespaceforworkspace"+workspace.getName());namespace=catalog.getFactory().createNamespace();namespace.setPrefix(workspace.getName());namespace.setURI("http://"+workspace.getName());namespace.setIsolated(workspace.isIsolated());catalog.add(namespace);
if("default".equals(workspaceName)){catalog.setDefaultWorkspace(workspace);
else{//namemustexistWorkspaceInfowks=catalog.getWorkspaceByName(workspaceName);
if(wks==null){thrownewRestException("Can'tchangeanonexistantworkspace("+workspaceName+")",HttpStatus.NOT_FOUND);
if(infoName!=null&&!workspaceName.equals(infoName)){thrownewRestException("Can'tchangenameofworkspace",HttpStatus.FORBIDDEN);
if(ws==null){thrownewRestException("Workspace'"+workspaceName+"'notfound",HttpStatus.NOT_FOUND);
if(!recurse){
if(!catalog.getStoresByWorkspace(ws,StoreInfo.class).isEmpty()){thrownewRestException("Workspacenotempty",HttpStatus.FORBIDDEN);
if(ns!=null){
if(!catalog.getFeatureTypesByNamespace(ns).isEmpty()){thrownewRestException("Namespaceforworkspacenotempty.",HttpStatus.FORBIDDEN);
else{//recursivedeletenewCascadeDeleteVisitor(catalog).visit(ws);
if(properties==null){try{properties=model.toMap();
if(def.equals(wkspace)){properties.put("isDefault",Boolean.TRUE);
else{properties.put("isDefault",Boolean.FALSE);
if(!dsProps.isEmpty())properties.putIfAbsent(propsName,dsProps);
if(workspace==null){returnnull;
if(objinstanceofWorkspaceInfo){converter.encodeLink("/workspaces/"+converter.encode(ref),writer);
if(objectinstanceofWorkspaceInfo){return"WorkspaceInfo";
if(attributes==null&&(filter==null||filter==Filter.INCLUDE)){returnQuery.ALL;
else{Queryq=newQuery();q.setFilter(filter);//TODO:
switchthistopropertynameswhenpossibleq.setPropertyNames(flattenNames(attributes));returnq;
if(names==null){returnnull;
if(attributes==null){oos.writeInt(-1);
else{oos.writeInt(attributes.size());for(PropertyNameproperty:attributes){oos.writeObject(property.getPropertyName());//TODO:writeoutthenamespacesupportaswell
if(size==-1){returnnull;
else{List<PropertyName>properties=newArrayList<PropertyName>();for(inti=0;i<size;i++){Stringname=(String)ois.readObject();properties.add(FF.property(name));//TODO:readoutthenamespacesupportaswell
if(this==obj)returntrue;
if(!super.equals(obj))returnfalse;
if(getClass()!=obj.getClass())returnfalse;VectorAccessLimitsother=(VectorAccessLimits)obj;
if(readAttributes==null){
if(other.readAttributes!=null)returnfalse;
else
if(!readAttributes.equals(other.readAttributes))returnfalse;
if(writeAttributes==null){
if(other.writeAttributes!=null)returnfalse;
else
if(!writeAttributes.equals(other.writeAttributes))returnfalse;
if(writeFilter==null){
if(other.writeFilter!=null)returnfalse;
else
if(!writeFilter.equals(other.writeFilter))returnfalse;returntrue;}}
if(((ResourceInfo)model.getObject()).getCRS()==null){//nonative,theonlymeaningfulpolicyistoforceri.setProjectionPolicy(ProjectionPolicy.FORCE_DECLARED);
if(nativeBBox!=null){nativeBoundsPanel.setModelObject(nativeBBox);
ifthenativeboundsarenotaroundcomputethem
if(nativeBounds==null){ResourceInforesource=(ResourceInfo)BasicResourceConfig.this.getDefaultModelObject();CatalogBuildercb=newCatalogBuilder(GeoServerApplication.get().getCatalog());nativeBounds=cb.getNativeBounds(resource);resource.setNativeBoundingBox(nativeBounds);nativeBBox.setModelObject(nativeBounds);target.add(nativeBBox);
if(policy==ProjectionPolicy.REPROJECT_TO_DECLARED){finalbooleanlenient=true;try{CRS.findMathTransform(nativeCrs,declaredCrs,lenient);
if(baseAuthorities!=null){for(AuthorityURLInfobaseAuth:baseAuthorities){names.add(baseAuth.getName());
if(is!=null){is.close();
if(lines==0){assertEquals(attribs[0],"State");assertEquals(attribs[1],"inc1980");assertEquals(attribs[4],"inc2000");assertEquals(attribs[8],"inc2012");
if(attribs[0].equalsIgnoreCase("Tennessee")){//Tennessee,7711,15903,21800,25946,28455,32172,34089,37678assertEquals("7711",attribs[1]);assertEquals("37678",attribs[8]);
ifitisnotneededformatter.setDecimalSeparatorAlwaysShown(false);formatter.setDecimalFormatSymbols(null);//setdefaultnumberoffractiondigitsformatter.setMaximumFractionDigits(5);//minimunfractiondigitsto0sotheygetnotrendered
ifnotneededformatter.setMinimumFractionDigits(0);
if(featureWriter==null){//checkforabstractGeometrytype
if(gtype==Geometry.class){featureWriter=newGeometryWriter();
else{thrownewIllegalArgumentException("NoSVGFeaturewriterdefinedfor"+gtype);
if(gtype==Point.class){//featureWriter=newPointWriter();//
else
if(gtype==MultiPoint.class){//featureWriter=newMultiPointWriter();//
else
if(gtype==LineString.class){//featureWriter=newLineStringWriter();//
else
if(gtype==MultiLineString.class){//featureWriter=newMultiLineStringWriter();//
else
if(gtype==Polygon.class){//featureWriter=newPolygonWriter();//
else
if(gtype==MultiPolygon.class){//featureWriter=newMultiPolygonWriter();//
else{//thrownewIllegalArgumentException(//"NoSVGFeaturewriterdefinedfor"+gtype);//
if(config.isCollectGeometries()){this.writerHandler=new*CollectSVGHandler(featureWriter);
else{this.writerHandler=new*SVGFeatureWriterHandler();this.writerHandler=newFIDSVGHandler(this.writerHandler);*this.writerHandler=newBoundsSVGHandler(this.writerHandler);this.writerHandler=new*AttributesSVGHandler(this.writerHandler);
ifareferencespacehasbeenset,returnsatranslatedYcoordinatewichisinvertedbased*ontheheightofsuchareferencespace,otherwisejustreturns<code>y</code>*/publicdoublegetY(doubley){return(maxY-y)+minY;
if((style!=null)&&!"#circle".equals(style)&&style.startsWith("#")){style=style.substring(1);
else{style=null;
if(doCollect){write("<path");write("d=\"");
if(doCollect){write("\"/>\n");
if(doCollect){this.writerHandler=newCollectSVGHandler(featureWriter);LOGGER.finer("Establishedacollectingfeatureswriterhandler");
else{this.writerHandler=newSVGFeatureWriterHandler();StringtypeName=featureType.getTypeName();/**REVISIT:getridofallthisattributestuff,since
ifattributesareneededitfits*bettertohaveSVGwithgmlattributesasanotheroutputformatforWFS'sgetFeature.*/Listatts=newArrayList(0);//config.getAttributes(typeName);
if(atts.contains("#FID")){this.writerHandler=newFIDSVGHandler(this.writerHandler);atts.remove("#FID");LOGGER.finer("AddedFIDhandlerdecorator");
if(atts.contains("#BOUNDS")){this.writerHandler=newBoundsSVGHandler(this.writerHandler);atts.remove("#BOUNDS");LOGGER.finer("AddedBOUNDShandlerdecorator");
if(atts.size()>0){this.writerHandler=newAttributesSVGHandler(this.writerHandler);LOGGER.finer("AddedATTRIBUTEShandlerdecorator");
if((value!=null)&&!(valueinstanceofGeometry)){write('');write(type.getDescriptor(i).getName().getLocalPart());write("=\"");encodeAttribute(String.valueOf(value));write('\"');
ifnullispassedasargument
if(inData==null){return;
iftheithcharacterisspecialcharacter,replacebycode
if(charToCompare=='"'){write("&quot;");
else
if(charToCompare>127){writeUnicodeEscapeSequence(charToCompare);
else{write(charToCompare);
if((i>3)&&(prev.distance(curr)<=minCoordDistance)){++coordsSkipCount;continue;
if(pointsAsCircles){write("cx=\"");write(getX(p.getX()));write("\"cy=\"");write(getY(p.getY()));
else{write("x=\"");write(getX(p.getX()));write("\"y=\"");write(getY(p.getY()));//IssueGEOS-193,fromJohnSteining.write("\"xlink:href=\"#point");//puttingthisintofixtheissue,butIamnotsureabout//thebroaderimplications-Idon'tthinkweneeditfor//pointsAsCircles.Anditlookslikethequotegetsclosed//somewhereelse,butI'mnotsurewhere.
if(g!=null){delegate=(SVGFeatureWriter)writers.get(g.getClass());
if(delegate==null){thrownewIllegalArgumentException("NoSVGFeaturewriterdefinedfor"+g);
if(property==DataAccessRuleProvider.RULEKEY){returneditRuleLink(id,itemModel,property);
if(property==DataAccessRuleProvider.ROLES){returnnewLabel(id,property.getModel(itemModel));
if(containsKey(key)){hitCount++;
ifthefactoryisenabled,falseotherwise*/publicbooleanisEnabled();/***Enables/disablesthefactory**@paramenabled*/publicvoidsetEnabled(booleanenabled);/***Thelistofprocessesgeneratedbythisfactorythatneedstobefilteredout(disabled)or*exertaccesscontrolon*/publicList<ProcessInfo>getFilteredProcesses();/***Themetadatamap,cancontainanysortofinformationthatnoncorepluginsmightuseto*handleinformationrelatedtothisfactory*/MetadataMapgetMetadata();/**Createacopyofthisclass*/ProcessGroupInfoclone();/**ReturnrolesgrantedtoworkswiththeWPSonthisgroups*/List<String>getRoles();voidsetRoles(List<String>roles);}
ifunknown*/StringgetUnit();/***Setsthedimenionsunitname**@paramunit*/voidsetUnit(Stringunit);/***/SampleDimensionTypegetDimensionType();voidsetDimensionType(SampleDimensionTypedimensionType);}
if(componentinstanceofFormComponent){FormComponent<?>formComponent=(FormComponent<?>)component;formComponent.processInput();
if(J2eeAuthenticationBaseFilterConfig.J2EERoleSource.J2EE.equals(getRoleSource())){returngetRolesFromJ2EE(request,principal);
if(request.isUserInRole(role.getAuthority()))roles.add(role);RoleCalculatorcalc=newRoleCalculator(service);calc.addInheritedRoles(roles);calc.addMappedSystemRoles(roles);returnroles;}}
if(f.getID()!=null){atts.addAttribute(GML.NAMESPACE,"id","gml:id",null,f.getID());
if(ugService==null){thrownewIllegalArgumentException("Unabletoloadusergroupservice"+upAuthConfig.getUserGroupServiceName());
if(auth==null){returnnull;
if(auth.getDetails()instanceofGeoServerWebAuthenticationDetails){((GeoServerWebAuthenticationDetails)auth.getDetails()).setUserGroupServiceName(userGroupServiceName);
if(auth.getAuthorities().contains(GeoServerRole.AUTHENTICATED_ROLE)==false){List<GrantedAuthority>roles=newArrayList<GrantedAuthority>();roles.addAll(auth.getAuthorities());roles.add(GeoServerRole.AUTHENTICATED_ROLE);UsernamePasswordAuthenticationTokennewAuth=newUsernamePasswordAuthenticationToken(auth.getPrincipal(),auth.getCredentials(),roles);newAuth.setDetails(auth.getDetails());returnnewAuth;
if("cite:Lakes".equals(layer.getTitle())){returnnull;
else{returnsuper.beforeLayer(content,layer);
ifatempdirisavailbale
if(newJdbcSecurityConfigValidator(getSecurityManager()).getTempDir()!=null){oldConfig=newJDBCRoleServiceConfig(config);StringinvalidPath="abc"+File.separator+"def.properties";config.setPropertyFileNameDDL(invalidPath);try{//getSecurityManager().saveRoleService(config);validator.validateModifiedRoleService(config,oldConfig);fail();
ifatempdirisavailbale
if(newJdbcSecurityConfigValidator(getSecurityManager()).getTempDir()!=null){oldConfig=newJDBCRoleServiceConfig(config);StringinvalidPath="abc"+File.separator+"def.properties";config.setPropertyFileNameDML(invalidPath);try{//getSecurityManager().saveRoleService(config);validator.validateModifiedRoleService(config,oldConfig);fail();
ifatempdirisavailbale
if(newJdbcSecurityConfigValidator(getSecurityManager()).getTempDir()!=null){oldConfig=newJDBCUserGroupServiceConfig(config);StringinvalidPath="abc"+File.separator+"def.properties";config.setPropertyFileNameDDL(invalidPath);try{//getSecurityManager().saveUserGroupService(config);validator.validateModifiedUserGroupService(config,oldConfig);fail();
ifatempdirisavailbale
if(newJdbcSecurityConfigValidator(getSecurityManager()).getTempDir()!=null){oldConfig=newJDBCUserGroupServiceConfig(config);StringinvalidPath="abc"+File.separator+"def.properties";config.setPropertyFileNameDML(invalidPath);try{//getSecurityManager().saveUserGroupService(config);validator.validateModifiedUserGroupService(config,oldConfig);fail();
if(transparent==null){transparent=true;
if(cm.getTransparency()==Transparency.OPAQUE&&transparent){forceTransparent=true;
if(fileSource!=null&&fileSourceinstanceofString){location=(String)fileSource;
if(location==null){RenderedImageimage=coverage.getRenderedImage();
if(forceTransparent){ImageWorkeriw=newImageWorker(image);iw.forceComponentColorModel();finalImageLayouttempLayout=newImageLayout(image);tempLayout.unsetValid(ImageLayout.COLOR_MODEL_MASK).unsetValid(ImageLayout.SAMPLE_MODEL_MASK);RenderedImagealpha=ConstantDescriptor.create(Float.valueOf(image.getWidth()),Float.valueOf(image.getHeight()),newByte[]{Byte.valueOf((byte)255)},newRenderingHints(JAI.KEY_IMAGE_LAYOUT,tempLayout));iw.addBand(alpha,false);image=iw.getRenderedImage();cm=image.getColorModel();
if(vrtFile==null||!vrtFile.exists()||!vrtFile.canRead()){thrownewIOException("UnabletogetavalidfilewithattachedGroundControlPoints");
if(warpedFile==null||!warpedFile.exists()||!warpedFile.canRead()){thrownewIOException("Unabletogetavalidgeorectifiedfile");
if(cminstanceofIndexColorModel){expand=true;
else
if(cminstanceofComponentColorModel&&cm.getNumComponents()==1&&cm.getComponentSize()[0]==1){expand=true;
if(expand){removeFiles.add(warpedFile);warpedFile=expandRgba(warpedFile.getAbsolutePath());
ifwehavetheoutputpathmovethefinalfilethere
if(Boolean.TRUE.equals(store)&&outputPath!=null){Fileoutput=newFile(outputPath);
if(output.exists()){
if(!output.delete()){thrownewWPSException("Outputfile"+outputPath+"existsbutcannotbeoverwritten");
else{Fileparent=output.getParentFile();
if(!parent.exists()){
if(!parent.mkdirs()){thrownewWPSException("Outputfileparentdirectory"+parent.getAbsolutePath()+"doesnotexistandcannotbecreated");
if(!warpedFile.renameTo(output)){thrownewWPSException("Couldnotmove"+warpedFile.getAbsolutePath()+"to"+outputPath+",it'slikelyapermissionissue");
if(resourceManager!=null&&!Boolean.TRUE.equals(store)){resourceManager.addResource(newWPSFileResource(warpedFile));
if(reader!=null){try{reader.dispose();
iftheinput*dataisafeaturecollection.**@paramtargetQuery*@paramgridGeometry*@returnThetransformedquery,ornull
ifnoinversionispossible/meaningful*/publicQueryinvertQuery(QuerytargetQuery,GridGeometrygridGeometry){returntargetQuery;
ifthe*inputdataisagridcoverageoragridcoveragereader**@paramtargetQuery*@paramgridGeometry*@returnThetransformedquery,ornull
ifnoinversionispossible/meaningful*/publicGridGeometryinvertGridGeometry(QuerytargetQuery,GridGeometrytargetGridGeometry){//weneedtheentireimage,wedon'tknowhowtoinvertthewarpingreturnnull;
if(targetEnvelope!=null&&targetEnvelope.size()>0){add("-te");addAll(targetEnvelope);
if(width!=null&&height!=null){add("-ts");add(Integer.toString(width));add(Integer.toString(height));
if(order!=null){add("-order");add(Integer.toString(order));
if(re==null){returnCollections.emptyList();
else{returnnewArrayList<String>(){{add(Double.toString(re.getMinX()));add(Double.toString(re.getMinY()));add(Double.toString(re.getMaxX()));add(Double.toString(re.getMaxY()));
if(vrtFile!=null&&vrtFile.exists()&&vrtFile.canRead()){returnvrtFile;
if(envVars!=null){builder.environment().putAll(envVars);
else{builder.environment().putAll(System.getenv());
if(exitValue!=0){
if(logFile.exists()&&logFile.canRead()){Stringerror=getError(logFile);thrownewWPSException("ErrorlaunchingOScommand:'"+gdalCommand+"'witharguments'"+arguments+"'andenvvars'"+envVars+"':\n"+error);
if(logFile!=null){logFile.delete();
if(file!=null&&file.exists()&&file.canRead()){file.delete();
if(info.getMetadata()==null){info.setMetadata(newMetadataMap());
if(provider==testCacheProvider1){providerName="testCacheProvider1";
if(batch!=null){dao.delete(batch);
if(config!=null){dao.delete(config);
if(waterView!=null){cat.remove(waterView);
if(target.exists()){assertTrue(target.delete());
if(waterView!=null){cat.remove(waterView);
if("NCOM_wattemp_000_20081031T0000000_12.tiff".equals(location)){octoberId=feature.getString("id");
if(errors.size()>0){SAXParseExceptionsax=(SAXParseException)errors.get(0);
if(sax.getLineNumber()<0){result.append("INVALIDXML:"+sax.getLocalizedMessage()+"\n");result.append("\n");exceptionNum=1;//skipahead(youonlyevergetoneerrorinthiscase)
if((exceptionNum<errors.size())){SAXParseExceptionsax=(SAXParseException)errors.get(exceptionNum);
if(sax.getLineNumber()<=linenumber){Stringhead="---------------------".substring(0,header.length()-1);Stringbody="--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------";intcolNum=sax.getColumnNumber();//protectagainstcol0problems
if(colNum<1){colNum=1;
if(colNum>body.length()){body=body+body+body+body+body+body;//makeitlonger(notusuallyrequired,but//mightbeforSLD_BODY=...whichisall//oneline)
if(colNum>body.length()){colNum=body.length();
else{keep_going=false;//reportlater(sax.getLineNumber()>linenumber)
else{keep_going=false;//nomoreerrorstoreport
if(reader!=null){reader.close();
ifthefile'sokay)*/@DeprecatedpublicListvalidateSLD(InputSourcexml,StringbaseUrl){returnvalidateSLD(xml);
ifthefile'sokay)*/publicListvalidateSLD(InputSourcexml){URLschemaURL=SLDValidator.class.getResource("/schemas/sld/StyledLayerDescriptor.xsd");returnResponseUtils.validate(xml,schemaURL,false,entityResolver);}}
if(c.getAlpha()==255){returnString.format("rgb(%d,%d,%d)",c.getRed(),c.getGreen(),c.getBlue());
else{returnString.format(Locale.ENGLISH,"rgba(%d,%d,%d,%.2f)",c.getRed(),c.getGreen(),c.getBlue(),c.getAlpha()/255.);
if(s==null){returnfalse;
if(length==7||length==8){//#RRGGBBor0xRRGGBBreturnColor.decode(s);
else{
if(s.startsWith("#")){s=s.substring(1);
else
if(s.startsWith("0x")){s=s.substring(2);
iftherootdirectorywasinitiated(testmayhavebeenskipped)
if(ROOT_DIRECTORY!=null){//removeroottestsdirectoryIOUtils.delete(ROOT_DIRECTORY);
ifthedatastorewascorrectlycreatedDataStoreInfostoreInfo=getCatalog().getDataStoreByName(dataStoreName);assertThat(storeInfo,notNullValue());DataAccessstore=storeInfo.getDataStore(null);assertThat(store,notNullValue());List<Name>names=store.getNames();assertThat(store,notNullValue());//checkthatatleastthetablepointsisavailableNamefound=names.stream().filter(name->name!=null&&name.getLocalPart().equals("points")).findFirst().orElse(null);assertThat(found,notNullValue());//checkthatthepointslayerwascorrectlycreatedLayerInfolayerInfo=getCatalog().getLayerByName(newNameImpl(WORKSPACE_URI,"points"));assertThat(layerInfo,notNullValue());assertThat(layerInfo.getResource(),notNullValue());assertThat(layerInfo.getResource(),instanceOf(FeatureTypeInfo.class));//checkthatwehavetheexpectedfeaturesFeatureTypeInfofeatureTypeInfo=(FeatureTypeInfo)layerInfo.getResource();intcount=featureTypeInfo.getFeatureSource(null,null).getCount(Query.ALL);assertThat(count,is(4));
if(ByteOrder.LITTLE_ENDIAN.toString().equals(str)){returnnewStringResourceModel("byteOrderLittleEndian",BilLayerConfigPanel.this).getObject();
else
if(ByteOrder.BIG_ENDIAN.toString().equals(str)){returnnewStringResourceModel("byteOrderBigEndian",BilLayerConfigPanel.this).getObject();
if(layerInfo.getResource().getCatalog()==null)newCatalogBuilder(GeoServerApplication.get().getCatalog()).attach(layerInfo);returnlayerInfo;
if(localNamespace!=null){//theURIsoftheprovidednamespaceandofthelocalworkspacenamespacematchedreturnfacade.getResourceByName(localNamespace,name,clazz);
if(localNamespace!=null){//theURIsoftheprovidednamespaceandofthelocalworkspacenamespacematchedreturnfacade.getResourcesByNamespace(localNamespace,clazz);
if(localNamespace!=null&&Objects.equals(localNamespace.getURI(),uri)){//localworkspacenamespaceURIisequaltotheprovidedURIreturnlocalNamespace;
ifthereisanyglobalnamespacematchingtheprovidedurifor(NamespaceInfonamespace:facade.getNamespacesByURI(uri)){
if(!namespace.isIsolated()){//wefoundaglobalnamespacereturnnamespace;
ifavailable.**@returncurrentlocalworkspaceorNULL*/privateWorkspaceInfogetLocalWorkspace(){returnLocalWorkspace.get();
iftheprovidedstoreisvisibleinthecurrentcontext.**@paramstorethestoretocheck,maybeNULL*@returnthestore
ifvisible,otherwiseNULL*/private<TextendsStoreInfo>TenforceStoreIsolation(Tstore){
if(store==null){//nothingtodo,thestoreisalreadyNULLreturnnull;
ifthestoreworkspaceisvisibleinthiscontextreturncanSeeWorkspace(workspace)?store:null;
iftheprovidedresourceisvisibleinthecurrentcontext.**@paramresourcetheresourcetocheck,maybeNULL*@returntheresource
ifvisible,otherwiseNULL*/private<TextendsResourceInfo>TenforceResourceIsolation(Tresource){
if(resource==null){//nothingtodo,theresourceisalreadyNULLreturnnull;
if(store==null){//sincewecan'tcheck
ifthestoreisvisibleweletitgoreturnresource;
iftheresourcestoreworkspaceisvisibleinthiscontextreturncanSeeWorkspace(workspace)?resource:null;
iftheprovidedlayerisvisibleinthecurrentcontext.**@paramlayerthelayertocheck,maybeNULL*@returnthelayer
ifvisible,otherwiseNULL*/private<TextendsLayerInfo>TenforceLayerIsolation(Tlayer){
if(layer==null){//nothingtodo,thelayerisalreadyNULLreturnnull;
if(resource==null){//thisshouldnothappen,thereisnotmuchwecandoreturnlayer;
if(store==null){//sincewecan'tcheck
ifthestoreisvisibleweletitgoreturnlayer;
ifthelayerresourcestoreworkspaceisvisibleinthiscontextreturncanSeeWorkspace(workspace)?layer:null;
iftheprovidedstyleisvisibleinthecurrentcontext.**@paramstylethestyletocheck,maybeNULL*@returnthestyle
ifvisible,otherwiseNULL*/private<TextendsStyleInfo>TenforceStyleIsolation(Tstyle){
if(style==null){//nothingtodo,thestyleisalreadyNULLreturnnull;
ifthestyleworkspaceisvisibleinthiscontextreturncanSeeWorkspace(workspace)?style:null;
iftheprovidedlayergroupisvisibleinthecurrentcontext.Notethatlayergroup*containedlayergroupswillnotbefiltered.**@paramlayerGroupthelayergrouptocheck,maybeNULL*@returnthelayergroup
ifvisible,otherwiseNULL*/private<TextendsLayerGroupInfo>TenforceLayerGroupIsolation(TlayerGroup){
if(layerGroup==null){//nothingtodo,thelayergroupisalreadyNULLreturnnull;
ifthelayergroupworkspaceisvisibleinthiscontextreturncanSeeWorkspace(workspace)?layerGroup:null;
iftheprovidedworkspaceisvisibleinthecurrentcontext.**<p>ThismethodreturnsTRUE
iftheprovidedworkspaceisoneofthedefaultones*(NO_WORKSPACEorANY_WORKSPACE)or
iftheprovidedworkspaceisNULLorisnotisolated.If*noOWSservicerequestisinprogressTRUEwillalsobereturned.**<p>Ifnoneoftheconditionsaboveissatisfied,then
ifalocalworkspaceexists(i.e.we*areinthecontextofavirtualservice)and
ifthelocalworkspacematchestheprovided*workspaceTRUEisreturned,otherwiseFALSEisreturned.**@paramworkspacetheworkspacetocheckforvisibility*@returnTRUE
iftheworkspaceisvisibleinthecurrentcontext,otherwiseFALSE*/privatebooleancanSeeWorkspace(WorkspaceInfoworkspace){
if(workspace==CatalogFacade.NO_WORKSPACE||workspace==CatalogFacade.ANY_WORKSPACE||workspace==null||!workspace.isIsolated()||Dispatcher.REQUEST.get()==null){//theworkspacecontentisvisibleinthiscontextreturntrue;
ifweareinthecontextofone//ofitsvirtualservicesreturnlocalWorkspace!=null&&Objects.equals(localWorkspace.getName(),workspace.getName());
ifanelementshouldbevisible*@returnalistwrappedwithamodificationproxythatcontainsthevisiblecatalogobjects*/private<TextendsCatalogInfo>List<T>filterIsolated(List<T>objects,Class<T>type,Function<T,T>filter){//unwrapthecatalogobjectslistList<T>unwrapped=ModificationProxy.unwrap(objects);//filterthenonvisiblecatalogobjectsandwraptheresultinglistwithamodification//proxyreturnModificationProxy.createList(unwrapped.stream().filter(store->filter.apply(store)!=null).collect(Collectors.toList()),type);
ifanelementshouldbevisible*@returnaniteratoroverthecatalogobjectsvisibleinthecurrentcontext*/private<TextendsCatalogInfo>CloseableIterator<T>filterIsolated(CloseableIterator<T>objects,Function<T,T>filter){List<T>iterable=newArrayList<>();//consumetheiteratorwhile(objects.hasNext()){Tobject=objects.next();
if(filter.apply(object)!=null){//thiscatalogobjectisvisibleinthecurrentcontextiterable.add(object);
iftheURI*oftheprovidednamespacematchesthelocalworkspaceassociatenamespaceURI,wereturnthe*namespaceassociatedwiththecurrentlocalworkspace,otherwiseNULLisreturned.**@paramnamespacethenamespacewewilltrytomatchagainstthelocalworkspace*@returnthenamespaceassociatedwiththelocalworkspace
ifmatched,otherwiseNULL*/privateNamespaceInfotryMatchLocalNamespace(NamespaceInfonamespace){WorkspaceInfolocalWorkspace=getLocalWorkspace();
if(localWorkspace!=null){//getthenamespaceforthecurrentlocalworkspaceNamespaceInfolocalNamespace=facade.getNamespaceByPrefix(localWorkspace.getName());
if(localNamespace!=null&&Objects.equals(localNamespace.getURI(),namespace.getURI())){//theURIsmatch,let'sreturnthelocalworkspacenamespacereturnlocalNamespace;
ifnolocalworkspaceis*set*/privateNamespaceInfogetLocalNamespace(){WorkspaceInfolocalWorkspace=getLocalWorkspace();
if(localWorkspace!=null){//getthenamespaceassociatedwiththelocalworkspacereturnfacade.getNamespaceByPrefix(localWorkspace.getName());
if(StoreInfo.class.isAssignableFrom(type)){return(CloseableIterator<T>)filterIsolated((CloseableIterator<StoreInfo>)objects,this::enforceStoreIsolation);
else
if(ResourceInfo.class.isAssignableFrom(type)){return(CloseableIterator<T>)filterIsolated((CloseableIterator<ResourceInfo>)objects,this::enforceResourceIsolation);
else
if(LayerInfo.class.isAssignableFrom(type)){return(CloseableIterator<T>)filterIsolated((CloseableIterator<LayerInfo>)objects,this::enforceLayerIsolation);
else
if(LayerGroupInfo.class.isAssignableFrom(type)){return(CloseableIterator<T>)filterIsolated((CloseableIterator<LayerGroupInfo>)objects,this::enforceLayerGroupIsolation);
else
if(StyleInfo.class.isAssignableFrom(type)){return(CloseableIterator<T>)filterIsolated((CloseableIterator<StyleInfo>)objects,this::enforceStyleIsolation);
if(layer.getResource().getStore().getWorkspace()!=null){pp.add(ResourceConfigurationPage.WORKSPACE,layer.getResource().getStore().getWorkspace().getName());
if(s.getWorkspace()==null){globalStyles.add(s);
if(workspace!=null){styles.addAll(GeoServerApplication.get().getCatalog().getStylesByWorkspace(workspace));
if(layers!=null){String[]splittedLayers=layers.split(",");this.layers.addAll(Arrays.asList(splittedLayers));
if("true".equalsIgnoreCase(sldTitle)||"on".equalsIgnoreCase(sldTitle)){useSldTitle=true;
if((!layers.isEmpty()&&!layers.contains(layer.getTitle()))||applicableRules.length==0){continue;
if(dispatcherRequest!=null){request.setKvp(dispatcherRequest.getKvp());request.setRawKvp(dispatcherRequest.getRawKvp());
if(dispatcherRequest!=null&&dispatcherRequest.getKvp().get("legend_options")!=null){legendOptions.putAll((Map)dispatcherRequest.getKvp().get("legend_options"));
if(title!=null){FontnewFont=LegendUtils.getLabelFont(request);newFont=newFont.deriveFont(Font.BOLD);newFont=newFont.deriveFont((float)newFont.getSize()+2);FontoldFont=g2d.getFont();g2d.setFont(newFont);
if(LegendUtils.isFontAntiAliasing(legend.request)){g2d.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_ON);
else{g2d.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_OFF);
if(legend.title!=null){titleWidth=legend.title.getWidth();titleHeight=legend.title.getHeight();
if(titleWidth>legendWidth){tmpWidth=titleWidth;tmpWidth+=((int)Math.ceil(TITLE_INDENT*2*scaleFactor));//indentthetitle
if(size.getWidth()>width){width=(int)Math.ceil(size.getWidth());
if(legend.title!=null){height+=legend.title.getHeight();
if(width<legend.title.getWidth()){width=legend.title.getWidth();width+=((int)Math.ceil(TITLE_INDENT*2*scaleFactor));//indentthetitle
if(legend.title!=null){finalGraphics.drawImage(legend.title,((strokeWidth-legend.title.getWidth())/2),//center(strokeHeight-height),null);titleHeightOffset+=legend.title.getHeight();
if(layer.getTitle()==null){returnnull;
if(useSldTitle&&layer.getStyle()!=null&&layer.getStyle().getDescription()!=null&&layer.getStyle().getDescription().getTitle()!=null){returnlayer.getStyle().getDescription().getTitle().toString();
if(resource!=null){returnresource.getTitle();
else{returnlayer.getTitle();
if(info.getDataStore(null)instanceofOpenSearchAccess){openSearchAccesses.add(info);
if(test.contains(mbtiles)){mbtilesFound=true;
if(allowProcess(processName)){count++;
if(count==0){//doesitgenerateatleastoneprocesswearegoingtoactuallyproduce?//
ifnotthefactoryitselfisgoingtobefilteredoutreturnnull;
else
if(count==processNames.size()){returnpf;
if(getEnableRedirectAuthenticationEntryPoint()||request.getRequestURI().endsWith(getLoginEndpoint())){response.sendRedirect(loginUri.toString());
if(r!=null){r.dispose();
if(iis!=null){iis.close();
if(is!=null){try{is.close();
ifitissingle,nullotherwise.*/publicTreeNode<T>getSelectedNode(){
if(selectedNodeModel.getObject().size()==1){returnselectedNodeModel.getObject().iterator().next();
if(!selectedNodeModel.getObject().isEmpty()){for(TreeNode<T>selectedNode:selectedNodeModel.getObject()){views.add(getNearestViewInternal(selectedNode));
else{returnnewPanel[]{};
ifthereisnotyetaviewforthisnode,itwillreturnthenearest*parentnode.Refreshingthisviewrefreshesallchildnodesaswell.Itisefficienttoonly*refreshthenecessarynode(s)onajaxrequests,ratherthanthewholetree.*/publicPanelgetNearestView(TreeNode<T>node){returngetNearestViewInternal(node);
ifnecessary.Eventsaren'tcalled.Callerisresponsiblefor*refreshingtheview(s).*/publicvoidsetSelectedNodes(Collection<TreeNode<T>>selectedNodes){setSelectedNodes(selectedNodes,null);
ifnecessary,fireevents,andrefreshthewholetreeview.*/publicvoidsetSelectedNodes(Collection<TreeNode<T>>selectedNodes,AjaxRequestTargettarget){//expand
ifnecessaryfor(TreeNode<T>selectedNode:selectedNodes){
if(selectedNode!=null){TreeNode<T>node=selectedNode.getParent();while(node!=null){node.getExpanded().setObject(true);node=node.getParent();
if(target!=null){target.add(this);
ifnecessary.Eventsaren'tcalled.Calleris*responsibleforrefreshingtheview(s).*/publicvoidsetSelectedNode(TreeNode<T>selectedNode){setSelectedNode(selectedNode,null);
ifnecessary,fireevents,andrefreshthewhole*treeview.*/publicvoidsetSelectedNode(TreeNode<T>selectedNode,AjaxRequestTargettarget){setSelectedNodes(selectedNode==null?Collections.emptySet():Collections.singleton(selectedNode),target);
ifnodehasbeenselected.**@paramnodenodetotest.*@returnwhethernodeisselectedornot.*/publicbooleanisSelected(TreeNode<T>node){for(TreeNode<T>selectedNode:selectedNodeModel.getObject()){
if(selectedNode.isSameAs(node)){returntrue;
ifanodehasamark**@parammarkNamenameofthemark*@paramnodethenodethatmayormaynotbemarked*@returnwhetherthemodeismarked*/publicbooleanhasMark(StringmarkName,TreeNode<T>node){returnmarks.get(markName).getMarked().contains(node.getUniqueId());
if(target!=null){for(SelectionListener<T>listener:selectionListeners){listener.onSelect(target);
ifthereisnotyetaviewforthisnode,itwillreturnthenearest*parentnode.Refreshingthisviewrefreshesallchildnodesaswell.Itisefficienttoonly*refreshthenecessarynode(s)onajaxrequests,ratherthanthewholetree.**@paramnode*@return*/protectedTreeNodeViewgetNearestViewInternal(TreeNode<T>node){TreeNode<T>parent=node.getParent();
if(parent==null){returngetRoot();
else{TreeNodeViewparentView=getNearestViewInternal(parent);
if(parentView.getNode().isSameAs(parent)){TreeNodeViewchildView=parentView.getChildView(node.getUniqueId());
if(childView!=null){returnchildView;
if(node.getObject().isLeaf()){returnnewTreeLeafView(id,node);
else{returnnewTreeExpandableNodeView(id,node);
if(ctrl){//toggleselectionofthisnodeSet<TreeNode<T>>newSelectedNodes=newHashSet<TreeNode<T>>();
if(isSelected(getNode())){for(TreeNode<T>selectedNode:getSelectedNodes()){
if(!selectedNode.isSameAs(getNode())){newSelectedNodes.add(selectedNode);
else{newSelectedNodes.addAll(getSelectedNodes());newSelectedNodes.add(getNode());
else
if(shift){//groupselecttonearestsiblingbooleanselect=false;booleanmoveOn=false;Set<TreeNode<T>>newSelectedNodes=newHashSet<TreeNode<T>>(getSelectedNodes());for(TreeNode<T>sibling:getNode().getParent().getChildren()){
if(!select&&(sibling.isSameAs(getNode())||isSelected(sibling))){select=true;moveOn=!sibling.isSameAs(getNode());//we_must_//moveonto//clickednode
else
if(select&&(sibling.isSameAs(getNode())||(!moveOn&&isSelected(sibling)))){select=false;break;
if(select){newSelectedNodes.add(sibling);target.add(getNearestViewInternal(sibling));
if(!select){newSelectedNodes.add(getNode());setSelectedNodesInternal(newSelectedNodes,target);
ifweneverwentoutofselect,therewasno//selectedsiblingtobeingwithandweare//justgoingtoignorethis.
else{//replaceselection,oldoneisremovedtarget.add(getSelectedViews());setSelectedNodesInternal(Collections.singleton(getNode()),target);
if(selectableLabel.getBehaviors().contains(SELECTED_BEHAVIOR)){
if(!isSelected(getNode())){selectableLabel.remove(SELECTED_BEHAVIOR);
else{
if(isSelected(getNode())){selectableLabel.add(SELECTED_BEHAVIOR);
if(selectableLabel.getBehaviors().contains(mark.getBehaviour())){
if(!mark.getMarked().contains(getNode().getUniqueId())){selectableLabel.remove(mark.getBehaviour());
else{
if(mark.getMarked().contains(getNode().getUniqueId())){selectableLabel.add(mark.getBehaviour());
if(!getModelObject()&&!selectedNodeModel.getObject().isEmpty()){//
ifanynodesinthecurrentselectionbecomehidden,weunselect//themautomaticallySet<TreeNode<T>>newSelectedNodes=newHashSet<TreeNode<T>>();for(TreeNode<T>selectedNode:selectedNodeModel.getObject()){TreeNode<T>node=selectedNode.getParent();booleanselectionHidden=false;while(!selectionHidden&&node!=null){//loopthroughparents
if(node.isSameAs(nodeModel.getObject())){selectionHidden=true;
if(!selectionHidden){newSelectedNodes.add(selectedNode);
if(newSelectedNodes.size()!=selectedNodeModel.getObject().size()){setSelectedNodesInternal(newSelectedNodes,target);target.add(TreeExpandableNodeView.this);
if(objectinstanceofQuery){monitor.query((Query)object,newRequestDataVisitor(){publicvoidvisit(RequestDatadata,Object...aggregates){try{writeBodyAndError(data,zout,body,error,true);
else
if(objectinstanceofList){for(RequestDatadata:(List<RequestData>)object){writeBodyAndError(data,zout,body,error,true);
else{writeBodyAndError((RequestData)object,zout,body,error,false);
if(body&&data.getBody()!=null){//TODO:figureouttheproperextensionforthebodyfilezout.putNextEntry(newZipEntry(postfix?"body_"+id+".txt":"body.txt"));zout.write(data.getBody());
if(error&&data.getError()!=null){zout.putNextEntry(newZipEntry(postfix?"error_"+id+".txt":"error.txt"));data.getError().printStackTrace(newPrintStream(zout));
if(exportsObjinstanceofScriptable){exports=(Scriptable)exportsObj;
else{thrownewScriptException("Couldn'tgetexportsforfunction.");
ifascripthasalready//calledrequire('geoscript').geoObject=object;
if(parts.isEmpty()){continue;
switch(part){caseCollection:resource="/collection.json";name="collection.json";break;caseDescription:resource="/test123-description.html";name="description.html";break;caseMetadata:resource="/test123-metadata.xml";name="metadata.xml";break;caseOwsLinks:resource="/test123-links.json";name="owsLinks.json";break;default:thrownewRuntimeException("Unexpectedpart"+part);
if(parts.contains(CollectionPart.Collection)){assertEquals(201,response.getStatus());assertEquals("http://localhost:8080/geoserver/rest/oseo/collections/TEST123",response.getHeader("location"));assertTest123CollectionCreated();
else{assertEquals(400,response.getStatus());assertThat(response.getContentAsString(),containsString("collection.json"));//failed,nothing
elsetocheckreturn;
if(parts.contains(CollectionPart.Description)){assertTest123Description();
if(parts.contains(CollectionPart.Metadata)){assertTest123Metadata();
if(parts.contains(CollectionPart.OwsLinks)){assertTest123Links();
if(addGranuleTable){populateGranules(conn);
if(buffer==null){buffer=line;
else{buffer=buffer+"\n"+line;
if(line.trim().endsWith(";")){statements.add(buffer);buffer=null;
if(statement.contains("GIST")||statement.contains("createextension")){continue;
if(statement.contains("geography(Polygon,4326)")){statement=statement.replace("geography(Polygon,4326)","POLYGON");
else
if(statement.contains("geometry(Polygon,4326)")){statement=statement.replace("geometry(Polygon,4326)","POLYGON");
if(pc==EOP_GENERIC||pc==expectedClass){continue;
else{assertThat(adName,not(startsWith(pc.getPrefix())));
if(p!=null){returnp.getValue();
else{returnnull;
if(p!=null){p.setValue(value);
else{List<Property>properties=newArrayList<>(sf.getValue());AttributeDescriptorad=(AttributeDescriptor)sf.getType().getDescriptor(name);properties.add(newAttributeImpl(value,ad,null));
ifgmlprefixingisused.*/booleanisGMLPrefixing();/**Setsflagdetermining
ifgmlprefixingisused.*/voidsetGMLPrefixing(booleangmlPrefixing);/***Returnsthemaximuminputsize,inkilobytes.Theinputsizeiscomputedastheamountof*bytesneededtofullystoreinmemorytheinputdata,{code}widthxheigthxpixelsize{code}*(whetherthatmemorywillactuallybefullyusedornotdependsonthedatasource)A*negativeornullvalueimpliesthereisnoinputlimit.*/longgetMaxInputMemory();/**Setsthemaximuminputsize.See{@link#getMaxInputMemory()}*/voidsetMaxInputMemory(longsize);/***Returnsthemaximumoutputsize,inkilobytes.Theoutputsizeiscomputedastheamountof*bytesneededtostoreinmemorytheresultingimage{code}widthxheigthxpixelsize{code}.*Whetherthatmemorywillbeusedornotdependsonthedatasourceaswellastheoutput*format.Anegativeornullvalueimpliesthereisnooutputlimit.*/longgetMaxOutputMemory();/**@paramsize*/voidsetMaxOutputMemory(longsize);/**ReturnstheoverviewpolicyusedwhenreturningWCSdata*/OverviewPolicygetOverviewPolicy();/***SetstheoverviewpolicyttobeusedwhenprocessingWCSdata**@parampolicy*/voidsetOverviewPolicy(OverviewPolicypolicy);/**Enablestheuseofsubsampling*/booleanisSubsamplingEnabled();/**Enableds/disablestheuseofsubsamplingduringthecoveragereads*/publicvoidsetSubsamplingEnabled(booleanenabled);/***Allowsuserstorequestdatainlat-lonorder.**<p>Defaultto<code>false</code>.**@paramlatLon<code>true</code>forlat-lonorder,<code>false</code>otherwise.*/publicvoidsetLatLon(booleanlatLon);/***Tellsmewhetherweshouldspitoutdatainlat-lonorlon-latorder.**@return<code>true</code>forlat-lonorder,<code>false</code>otherwise.*/publicbooleanisLatLon();/**Thesrs'sthatthewcsservicesupports(notallversionsofWCSsupportthis)*/List<String>getSRS();/***Returnsthemaximumnumberofdimensionitemsthatcanberequestedbyaclientwithout*gettingaserviceexception.Thedefaultis*{DimensionInfo#DEFAULT_MAX_REQUESTED_DIMENSION_VALUES}thatis,nolimit.**@return*/defaultintgetMaxRequestedDimensionValues(){returnDimensionInfo.DEFAULT_MAX_REQUESTED_DIMENSION_VALUES;
ifnotimplementednothingisdone}}
if(getCoverage.getSourceCoverage()==null){
if(kvp.get("coverage")==null)thrownewWcsException("sourcecoverageparameterismandatory",MissingParameterValue,"sourcecoverage");
elsegetCoverage.setSourceCoverage((String)((List)kvp.get("coverage")).get(0));
ifnotspecified,throwaresoundingexception(byspec)
if(!getCoverage.isSetVersion())thrownewWcsException("Versionhasnotbeenspecified",WcsExceptionCode.MissingParameterValue,"version");//dotheversionnegotiationdanceList<String>provided=newArrayList<String>();provided.add(Wcs10GetCoverageRequestReader.VERSION);List<String>accepted=null;
if(getCoverage.getVersion()!=null){accepted=newArrayList<String>();accepted.add(getCoverage.getVersion());
if(!Wcs10GetCoverageRequestReader.VERSION.equals(version)){thrownewWcsException("Aninvalidversionnumberhasbeenspecified",WcsExceptionCode.InvalidParameterValue,"version");
if(!getCoverage.isSetInterpolationMethod()){getCoverage.setInterpolationMethod(parseInterpolation(kvp));
if(crsName==null)thrownewWcsException("CRSparameterismandatory",MissingParameterValue,"crs");finalCoordinateReferenceSystemcrs=decodeCRS100(crsName);
if(crs==null)thrownewWcsException("CRSparameterisinvalid:"+crsName,InvalidParameterValue,"crs");//finalVerticalCRSverticalCRS=CRS.getVerticalCRS(crs);//finalbooleanhasVerticalCRS=verticalCRS!=null;////atleastonebetweenBBOXandTIMEmustbethere//finalGeneralEnvelopebbox=(GeneralEnvelope)kvp.get("BBOX");
if(bbox==null)thrownewWcsException("bboxparameterismandatory",MissingParameterValue,"bbox");//afabiani:considerElevationasband,forcingthebboxtobe2Donly
if(bbox.getDimension()!=2)thrownewWcsException("Requestedboundingboxisnot2-dimensional:"+bbox.getDimension(),InvalidParameterValue,"bbox");finalGeneralEnvelopeenvelope=newGeneralEnvelope(/*TODO:ignore3DCRSfornowcrs*/bbox.getDimension()==3?DefaultGeographicCRS.WGS84_3D:crs);
if(/*TODO:ignore3DCRSfornow!hasVerticalCRS*/bbox.getDimension()==2)envelope.setEnvelope(bbox.getLowerCorner().getOrdinate(0),bbox.getLowerCorner().getOrdinate(1),bbox.getUpperCorner().getOrdinate(0),bbox.getUpperCorner().getOrdinate(1));//
else
if(/*TODO:ignore3DCRSfornowhasVerticalCRS*/bbox.getDimension()==//3)////3D//envelope.setEnvelope(bbox.getLowerCorner().getOrdinate(0),//bbox.getLowerCorner()//.getOrdinate(1),bbox.getLowerCorner().getOrdinate(2),//bbox.getUpperCorner()//.getOrdinate(0),bbox.getUpperCorner().getOrdinate(1),//bbox.getUpperCorner()//.getOrdinate(2));
elsethrownewWcsException("bboxnotcompliantwiththespecifiedCRS",InvalidParameterValue,"bbox");////TIME//TimeSequenceTypetimeSequence=null;Objecttime=kvp.get("TIME");
if(time!=null&&timeinstanceofTimeSequenceType){timeSequence=(TimeSequenceType)time;
else
if(time!=null){timeSequence=Wcs10Factory.eINSTANCE.createTimeSequenceType();
if(timeinstanceofCollection){for(ObjecttPos:(Collection<Object>)time){addToTimeSequence(timeSequence,tPos);
if(timeSequence==null&&bbox==null)thrownewWcsException("Boundingboxcannotbenull,TIMEhasnotbeenspecified",WcsExceptionCode.MissingParameterValue,"BBOX");////GRIDmanagement//finalRectifiedGridTypegrid=Gml4wcsFactory.eINSTANCE.createRectifiedGridType();finalObjectw=kvp.get("width");finalObjecth=kvp.get("height");
if(w!=null&&h!=null){////normalgridmanagement,onlytheenvelopeandtherasterdimensionshavebeen//specified,//weneedtocomputeRESX,RESY,RESZafterwards////getWandHintwidth=winstanceofInteger?((Integer)w):Integer.parseInt((String)w);intheight=winstanceofInteger?((Integer)h):Integer.parseInt((String)h);grid.getAxisName().add("x");grid.getAxisName().add("y");finalObjectd=kvp.get("depth");
if(d!=null){//afabiani:weconsider2DgrdisonlythrownewWcsException("3Dgridsarenotsupported.",InvalidParameterValue,"depth");////checkthattheenvelopeis3Dorthrowanerror//
if(bbox.getDimension()!=3)//thrownewWcsException("Founddepthbutenvelopeisof//dimension"//+bbox.getDimension(),InvalidParameterValue,"");//////noticethatasforthespecthiselementrepresentsthenumber//ofticksonthe////thirddimension//grid.getAxisName().add("z");////finalintdepth=Integer.parseInt((String)d);//grid.setDimension(BigInteger.valueOf(3));////noticethatthethirdelementindicateshowmanylayerswedo//haverequestedonthethirddimension//grid.setLimits(newGeneralGridEnvelope(newint[]{0,0,0},new//int[]{width,height,depth},false));////////3Dgrid//grid.setDimension(BigInteger.valueOf(3));
else{//2dgridgrid.setDimension(BigInteger.valueOf(2));grid.setLimits(newGridEnvelope2D(0,0,width,height));
else{////wemightbeworkingwitharectifiedgridrequestthereweneed//totryandusethattype.wecannotbuildarastergridatthis//stageyetsincewehavenoideaabouthowtheenvelopewillbeintersectedwiththe//nativeenvelopeforthisraster//finalObjectrx=kvp.get("resx");finalObjectry=kvp.get("resy");
if(rx!=null&&ry!=null){//getresxeresybutcorrectalsothesignforthemtakingintoaccountfinalCoordinateSystemcs=crs.getCoordinateSystem();finalAxisDirectionnorthingDirection=cs.getAxis(1).getDirection();finalintyAxisCorrection=AxisDirection.NORTH.equals(northingDirection)?-1:1;finalAxisDirectioneastingDirection=cs.getAxis(0).getDirection();finalintxAxisCorrection=AxisDirection.EAST.equals(eastingDirection)?1:-1;finaldoubleresX=Double.parseDouble((String)rx)*xAxisCorrection;finaldoubleresY=Double.parseDouble((String)ry)*yAxisCorrection;//basiccheck,theresolutioncannotbelargerthananyofthetwospans//fortheenvelopebecauseotherwisethesizeinrasterspacewillbeinvalid//Weexpectthefinalrasterareatobeatleast2pixeloneachrasterdimension
if(Math.abs(envelope.getSpan(0)/Math.abs(resX))<2||Math.abs(envelope.getSpan(1)/Math.abs(resY))<2)thrownewIllegalArgumentException(Errors.format(ErrorKeys.ILLEGAL_ARGUMENT_$1,"resolutions"));//nowcomputeoffsetvectorforthetransformfromtheenvelope//FollowingISO19123weusetheCELL_CENTERconventionbutwiththerasterfinaldoubleorigX=envelope.getLowerCorner().getOrdinate(0)+resX/2;finaldoubleorigY=envelope.getUpperCorner().getOrdinate(1)+resY/2;//createoffsetpointfinalPointTypeorigin=Gml4wcsFactory.eINSTANCE.createPointType();finalDirectPositionTypedp=Gml4wcsFactory.eINSTANCE.createDirectPositionType();origin.setPos(dp);origin.setSrsName(crsName);//createresolutionsvectorfinalVectorTyperesolutionVector=Gml4wcsFactory.eINSTANCE.createVectorType();////Thirddimensionmanagement//finalObjectrz=kvp.get("resz");
if(rz!=null){//afabiani:weconsider2DgrdisonlythrownewWcsException("3Dgridsarenotsupported.",InvalidParameterValue,"resz");////eventualdepth//finaldoubleresZ=Double.parseDouble((String)rz);////checkthattheenvelopeis3Dorthrowanerror//
if(bbox.getDimension()!=3)//thrownewWcsException("FoundResZbutenvelopeisof//dimension"//+bbox.getDimension(),InvalidParameterValue,//"");//finaldoubleorigZ=bbox.getLowerCorner().getOrdinate(2);//////3Dgrid//grid.setDimension(BigInteger.valueOf(3));////settheoriginposition//dp.setDimension(grid.getDimension());//dp.setValue(Arrays.asList(origX,origY,origZ));//grid.setOrigin(origin);//////settheresolutionvector//resolutionVector.setDimension(grid.getDimension());//resolutionVector.setValue(Arrays.asList(resX,resY,//resZ));//grid.getOffsetVector().add(resolutionVector);
else{//2dgridgrid.setDimension(BigInteger.valueOf(2));//settheoriginpositiondp.setDimension(grid.getDimension());dp.setValue(Arrays.asList(origX,origY));grid.setOrigin(origin);//settheresolutionvectorresolutionVector.setDimension(grid.getDimension());resolutionVector.setValue(Arrays.asList(resX,resY));grid.getOffsetVector().add(resolutionVector);
elsethrownewWcsException("Couldnotrecognizegridresolution",InvalidParameterValue,"");
if(tPosinstanceofDate){finalTimePositionTypetimePosition=Gml4wcsFactory.eINSTANCE.createTimePositionType();timePosition.setValue(tPos);timeSequence.getTimePosition().add(timePosition);
else
if(tPosinstanceofDateRange){DateRangerange=(DateRange)tPos;finalTimePeriodTypetimePeriod=Wcs10Factory.eINSTANCE.createTimePeriodType();finalTimePositionTypestart=Gml4wcsFactory.eINSTANCE.createTimePositionType();start.setValue(range.getMinValue());timePeriod.setBeginPosition(start);finalTimePositionTypeend=Gml4wcsFactory.eINSTANCE.createTimePositionType();end.setValue(range.getMaxValue());timePeriod.setEndPosition(end);timeSequence.getTimePeriod().add(timePeriod);
if(kvp.get("Band")!=null){Objectaxis=kvp.get("Band");
if(axisinstanceofAxisSubsetType){rangeSubset.getAxisSubset().add(axis);
elsecheckTypeAxisRange(rangeSubset,axis,"Band");
if(kvp.get("ELEVATION")!=null){Objectaxis=kvp.get("ELEVATION");
if(axisinstanceofAxisSubsetType){rangeSubset.getAxisSubset().add(axis);
elsecheckTypeAxisRange(rangeSubset,axis,"ELEVATION");
if(axisinstanceofString){Stringbands=(String)axis;
if(bands!=null){
if(bands.contains("/")){List<String>unparsed=KvpUtils.readFlat(bands,newTokenizer("/"));IntervalTypeinterval=Wcs10Factory.eINSTANCE.createIntervalType();TypedLiteralTypemin=Wcs10Factory.eINSTANCE.createTypedLiteralType();TypedLiteralTypemax=Wcs10Factory.eINSTANCE.createTypedLiteralType();TypedLiteralTyperes=Wcs10Factory.eINSTANCE.createTypedLiteralType();
if(unparsed.size()==2){min.setValue(unparsed.get(0));max.setValue(unparsed.get(1));interval.setMin(min);interval.setMax(max);
else{min.setValue(unparsed.get(0));max.setValue(unparsed.get(1));res.setValue(unparsed.get(2));interval.setMin(min);interval.setMax(max);interval.setRes(res);
else{List<String>unparsed=KvpUtils.readFlat(bands,KvpUtils.INNER_DELIMETER);
if(unparsed.size()==0){thrownewWcsException("Requestedaxissubsetcontainswrongnumberofvalues(shouldhaveatleast1):"+unparsed.size(),WcsExceptionCode.InvalidParameterValue,"band");
else
if(axisinstanceofDouble||axisinstanceofInteger){finalAxisSubsetTypeaxisSubset=Wcs10Factory.eINSTANCE.createAxisSubsetType();axisSubset.setName(axisName);TypedLiteralTypesingleValue=Wcs10Factory.eINSTANCE.createTypedLiteralType();singleValue.setValue(String.valueOf(axis));axisSubset.getSingleValue().add(singleValue);rangeSubset.getAxisSubset().add(axisSubset);
if(format==null)thrownewWcsException("formatparameterismandatory",MissingParameterValue,"format");finalStringcrsName=(String)(kvp.get("response_crs")!=null?kvp.get("response_crs"):kvp.get("crs"));CoordinateReferenceSystemcrs=null;
if(crsName!=null){crs=decodeCRS100(crsName);crsType.setValue(CRS.lookupIdentifier(crs,true));output.setCrs(crsType);
if("WGS84(DD)".equals(crsName)){crsName="EPSG:4326";
if(kvp.containsKey("interpolation")){return(InterpolationMethodType)kvp.get("interpolation");
if(this==obj)returntrue;
if(!super.equals(obj))returnfalse;
if(getClass()!=obj.getClass())returnfalse;WCSInfoImplother=(WCSInfoImpl)obj;
if(gmlPrefixing!=other.gmlPrefixing)returnfalse;
if(latLon!=other.latLon)returnfalse;
if(maxInputMemory!=other.maxInputMemory)returnfalse;
if(maxOutputMemory!=other.maxOutputMemory)returnfalse;
if(overviewPolicy!=other.overviewPolicy)returnfalse;
if(srs==null){
if(other.srs!=null)returnfalse;
else
if(!srs.equals(other.srs))returnfalse;
if(subsamplingEnabled==null){
if(other.subsamplingEnabled!=null)returnfalse;
else
if(!subsamplingEnabled.equals(other.subsamplingEnabled))returnfalse;returntrue;
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
ifrootlayerisnothiddenLayerGroupInfolayerGroup=sc.getLayerGroupByName("topp","eoRoadsLayerGroup");assertNotNull(layerGroup);assertNotNull(layerGroup.getRootLayer());//
ifrootlayerishiddenlayerGroup=sc.getLayerGroupByName("topp","eoStatesLayerGroup");assertNull(layerGroup);
if(wsi!=null){StringwsName=wsi.getName();assertTrue(wsName.equalsIgnoreCase("nurc"));
if(wsi!=null){StringwsName=wsi.getName();assertTrue(wsName.equalsIgnoreCase("nurc"));
iftheroadslayerispresentbooleanhasRoadsLayer=false;//EnsurethebaselayerispresentbooleanhasBasesLayer=false;while(it1.hasNext()){LayerInfonext=it1.next();assertNotSame(next,roadsLayer);assertNotSame(next,statesLayer);hasBasesLayer|=next.equals(basesLayer);
if(wsi!=null){StringwsName=wsi.getName();assertTrue(wsName.equalsIgnoreCase("topp"));
if(wsi!=null){StringwsName=wsi.getName();assertTrue(wsName.equalsIgnoreCase("topp"));
if(managerinstanceofResourceAccessManager){resourceManager=(ResourceAccessManager)manager;
else{thrownewIllegalArgumentException("WeshouldhaveaResourceAccessManager");
if(it==null)returnnull;try{LinkedList<T>list=newLinkedList<T>();while(it.hasNext()){list.add(it.next());
if(input!=null){returnf.evaluate(input);
ifroot).*/publicTreeNode<T>getParent();/***Getnodedataobject.**@returndataobject*/publicTgetObject();/***Provideamodelforwhethernodeisexpandedornot.Mustcontainthesamevalueforeach*instancerepresentingthesamenode.**@returnexpandedmodel,null
ifthenodeisaleaf.*/publicIModel<Boolean>getExpanded();/***ProvideauniqueIDforthisnode.**@returnuniqueid*/publicStringgetUniqueId();/***Determine
ifthenodeisaleaf.**@returntrue
ifthenodeisaleaf*/defaultbooleanisLeaf(){returngetChildren().size()==0;
ifthisisthesamenode(allfieldsmustbethesameaswell)**@paramnode*@return*/defaultbooleanisSameAs(TreeNode<T>node){return(getUniqueId().equals(node.getUniqueId()));}}
if(rootClass.isAssignableFrom(clazz)){return(Class<?extendsInfo>)rootClass;
if(rootClazz==null){returnCollections.emptyList();
else{List<InfoIdentity>list=newArrayList<>();for(String[]descriptor:descriptors.get(rootClazz)){String[]idValues=newString[descriptor.length];for(inti=0;i<descriptor.length;i++){try{idValues[i]=PropertyUtils.getNestedProperty(info,descriptor[i]).toString();
iftherequestwasrunningthroughaGeoserversecurity*filterchain.Thedefaultis<code>false</code>.**<p>Themandatory{@linkGeoServerSecurityContextPersistenceFilter}objectsetsthisattribute*to<code>true</code>*/publicstaticfinalStringSECURITY_ENABLED_ATTRIBUTE="org.geoserver.security.enabled";privatebooleanchainsInitialized;//securitymanagerGeoServerSecurityManagersecurityManager;FilterChainProxyproxy;//appcontextApplicationContextappContext;publicGeoServerSecurityFilterChainProxy(GeoServerSecurityManagersecurityManager){this.securityManager=securityManager;this.securityManager.addListener(this);chainsInitialized=false;
ifthecurrent{@linkHttpServletRequest}hastraveledthrougha*securityfilterchain.*/publicstaticbooleanisSecurityEnabledForCurrentRequest(){
if(REQUEST.get()==null){returntrue;
if(Boolean.TRUE.equals(REQUEST.get().getAttribute(SECURITY_ENABLED_ATTRIBUTE)))returntrue;returnfalse;
if(proxy!=null){proxy.init(filterConfig);
else{//FilterChainProxydoesn'ttoanythinginit'sinit()methodsoibelieveit'sok//
ifitdoesn'tgetcalledLOGGER.warning("init()calledbutproxynotyetconfigured");
if(!securityManager.isInitialized()){//nothingtodoreturn;
if(filter==null){thrownewNullPointerException("Nofilternamed"+filterName+"could"+"befound");
if(chainsInitialized){for(SecurityFilterChainchain:proxy.getFilterChains()){for(Filterfilter:chain.getFilters()){filter.destroy();
if(chain.isMatchHTTPMethod()==false)methods=null;List<String>tmp=chain.getPatterns();
if(tmp==null)returnnewGeoServerRequestMatcher(methods,(RequestMatcher[])null);//resolvemultiplepatternsseparatedbyacommaList<String>patterns=newArrayList<String>();for(Stringpattern:tmp){String[]array=pattern.split(",");for(StringsinglePattern:array)patterns.add(singlePattern);
if(filter==null){try{Objectobj=GeoServerExtensions.bean(filterName,appContext);
if(obj!=null&&objinstanceofFilter){filter=(Filter)obj;
if(!browserSupportsOL3(mapContent)){thrownewServiceException("OpenLayers3isnotsupportedonthecurrentbrowser");
if(agent==null){//playitsafereturnfalse;
if(!matcher.matches()){returntrue;
else{returnInteger.valueOf(matcher.group(1))>8;
if("ft".equals(unit)||"feets".equals(unit))result="feet";
ifnodesareemptyassertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:geometry/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:curve/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:point/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:linestring/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:surface/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:polygon/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:multicurve/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:multipoint/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:multilinestring/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:multisurface/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:multipolygon/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:geometryref/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:curveref/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:pointref/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:linestringref/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:surfaceref/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:polygonref/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:multicurveref/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:multipointref/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:multilinestringref/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:multisurfaceref/*",doc);assertXpathCount(0,"wfs:FeatureCollection/gml:featureMember/ex:MyTestFeature[@gml:id='2']/ex:multipolygonref/*",doc);}}
if(session!=null){synchronized(this.session){this.session=s;
else{synchronized(s){this.session=s;
if(session!=null){synchronized(session){
if(session.isSessionInvalidated()){return;//skip
if(fp!=null){
if(alreadyRecovered){fp.warn("Therewasanerrorwhichseemsalreadyfixed:"+ex.getLocalizedMessage());
else{fp.error(ex.getLocalizedMessage());
if*theydo,therenderingprocessisstopped**@authorAndreaAime-OpenGeo*/publicclassMaxErrorEnforcer{GTRendererrenderer;intmaxErrors;interrors;ExceptionlastException;/***Buildsanewmaxerrorsenforcer.IfmaxErrorsisnotpositivetheenforcerwilldonothing**@paramrenderer*@parammaxErrors*/publicMaxErrorEnforcer(GTRendererrenderer,intmaxErrors){this.renderer=renderer;this.maxErrors=maxErrors;this.errors=0;
if(maxErrors>0){renderer.addRenderListener(newRenderListener(){publicvoidfeatureRenderer(SimpleFeaturefeature){}publicvoiderrorOccurred(Exceptione){errors++;lastException=e;
if(errors>MaxErrorEnforcer.this.maxErrors){MaxErrorEnforcer.this.renderer.stopRendering();
ifthemaxerrorthresholdwasexceeded*/publicbooleanexceedsMaxErrors(){returnmaxErrors>0&&errors>maxErrors;
ifnonehappened)*/publicExceptiongetLastException(){returnlastException;}}
if("WFS".equalsIgnoreCase(request.getService())&&(version==null||V_20.compareTo(newVersion(version))<=0)&&method!=null&&(method.equalsIgnoreCase("GetFeature")||method.equalsIgnoreCase("GetFeatureWithLock")||method.equalsIgnoreCase("GetPropertyValue"))&&timeout>0&&operation.getParameters().length>0&&operation.getParameters()[0]instanceofBaseRequestType){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("StartingtotrackNSGtimeoutonthisrequest");
if(timeoutVerifier!=null){//checkbeforeencodetimeoutVerifier.checkTimeout();//wrap
ifneeded
if(resultinstanceofFeatureCollectionResponse){FeatureCollectionResponsefeatureCollectionResponse=(FeatureCollectionResponse)result;List<FeatureCollection>collections=featureCollectionResponse.getFeatures();List<FeatureCollection>wrappers=collections.stream().map(fc->TimeoutFeatureCollection.wrap(timeoutVerifier,fc)).collect(Collectors.toList());featureCollectionResponse.setFeatures(wrappers);
ifthereisatimeoutparameterObject[]parameters=operation.getParameters();
if(parameters!=null&&parameters.length>0&&parameters[0]instanceofBaseRequestType){BaseRequestTyperequest=(BaseRequestType)parameters[0];Objecttimeout=request.getExtendedProperties().get(TIMEOUT_REQUEST_ATTRIBUTE);
if(timeout!=null){Longconverted=Converters.convert(timeout,Long.class);
if(converted!=null&&converted>0){returnconverted*1000l;
else{thrownewWFSException(request,"Invalidtimeoutvalue:"+timeout);
if(propertyName.equals("type")){Stringtype;try{Stringkey="type."+limit.getValidator().getClass().getName();type=newParamResourceModel(key,ProcessLimitsPage.this).getString();
else
if(propertyName.equals("editor")){WPSInputValidatorvalidator=limit.getValidator();
if(validatorinstanceofMaxSizeValidator){Fragmentf=newFragment(id,"textEditor",ProcessLimitsPage.this);PropertyModelmaxSizeModel=newPropertyModel(itemModel,"validator.maxSizeMB");TextField<Integer>text=newTextField<Integer>("text",maxSizeModel,Integer.class);f.add(text);returnf;
else
if(validatorinstanceofMultiplicityValidator){Fragmentf=newFragment(id,"textEditor",ProcessLimitsPage.this);PropertyModelmaxMultiplicityModel=newPropertyModel(itemModel,"validator.maxInstances");TextField<Integer>text=newTextField<Integer>("text",maxMultiplicityModel,Integer.class);f.add(text);returnf;
else
if(validatorinstanceofNumberRangeValidator){Fragmentf=newFragment(id,"rangeEditor",ProcessLimitsPage.this);PropertyModelrangeModel=newPropertyModel(itemModel,"validator.range");RangePanelrangeEditor=newRangePanel("range",rangeModel);f.add(rangeEditor);returnf;
if(validator.isUnset()){continue;
if(paramValidators!=null){for(WPSInputValidatorvalidator:paramValidators){validatorTypes.add(validator.getClass());//wedeepclonethevalidatortoavoidchangingtheWPSstateuntil//themainsecuritypagegetssubmittedresult.add(newInputLimit(name,validator.copy()));
ifweneedtoaddsomemissingvalidator
if(param.getMaxOccurs()>1&&!validatorTypes.contains(MultiplicityValidator.class)){intmax=0;
if(param.getMaxOccurs()<Integer.MAX_VALUE){max=param.getMaxOccurs();
if(isComplex){
if(!validatorTypes.contains(MaxSizeValidator.class)){result.add(newInputLimit(name,newMaxSizeValidator(0)));
else{
if(isNumeric(param)&&!validatorTypes.contains(NumberRangeValidator.class)){result.add(newInputLimit(name,newNumberRangeValidator(null)));
if(!isEmpty(ldapConfig.getPopulatedAttributes())){populatedAttributes=ldapConfig.getPopulatedAttributes().trim().split("[\\s]*,[\\s]*");
if(att!=null){Objectvalue=att.get();
if(valueinstanceofString){gsUser.getProperties().put(attName,value);
if(user==null){thrownewUsernameNotFoundException(userNotFoundMessage(username));
if(dco!=null){group.set(newGeoServerUserGroup(dco.getStringAttribute(groupNameAttribute)));
if(dco!=null){user.set(createUser(dco));
if(roleObj!=null){Object[]usernames=roleObj.getObjectAttributes(groupMembershipAttribute);
if(usernames!=null){for(Objectusername:usernames){Stringuser=username.toString();Matcherm=userMembershipPattern.matcher(user);
if(m.matches()){user=m.group(1);
if(this==obj){returntrue;
if(obj==null){returnfalse;
if(getClass()!=obj.getClass()){returnfalse;
if(c1==null){
if(other.c1!=null){returnfalse;
else
if(!c1.equals(other.c1)){returnfalse;
if(c2==null){
if(other.c2!=null){returnfalse;
else
if(!c2.equals(other.c2)){returnfalse;
if(constructor==null){//proxyallinterfacesimplementedbythesourceobjectList<Class>proxyInterfaces=(List)Arrays.asList(proxyObject.getClass().getInterfaces());//ensurethatthespecifiedclassisincludedbooleanadd=true;for(Classinterfce:proxyObject.getClass().getInterfaces()){
if(clazz.isAssignableFrom(interfce)){add=false;break;
if(add){//makethelistmutable(Arrays.asListisnot)andthenaddtheextra//interfacesproxyInterfaces=newArrayList<Class>(proxyInterfaces);proxyInterfaces.add(clazz);
ifoneexists.**<p>Thismethodhandlestwocases,thefirstisthecaseofa{@linkWrappingProxy}inwhich*theunderlyingproxyobjectisreturned..Thesecondisthe{@linkProxyList}caseinwhich*theunderlyinglistisreturned.**@paramobjectTheproxyobject.*@paramhandlerClassTheinvocationhandlerclass.*@returnTheunderlyingproxiedobject,ortheobjectpassedin
ifnounderlyingobjectis*recognized.*/publicstatic<T>Tunwrap(Tobject,Class<?extendsInvocationHandler>handlerClass){
if(objectinstanceofProxy){InvocationHandlerh=handler(object,handlerClass);
if(h!=null&&hinstanceofWrappingProxy){return(T)((WrappingProxy)h).getProxyObject();
if(objectinstanceofProxyList){return(T)((ProxyList)object).proxyList;
ifnonmatchiningthespecifiedclasscanbefound.*/publicstatic<HextendsInvocationHandler>Hhandler(Objectobject,Class<H>handlerClass){
if(objectinstanceofProxy){InvocationHandlerh=Proxy.getInvocationHandler(object);
if(handlerClass.isInstance(h)){return(H)h;
if(event==null){thrownewIllegalArgumentException("Incomingobjectisnull");
if(eventinstanceofCatalogAddEvent){finalCatalogAddEventaddEv=((CatalogAddEvent)event);//getthesourcefromtheincomingeventfinalCatalogInfoinfo=addEv.getSource();//disabletheproducertoavoidrecursionproducer.disable();//addtheincomingCatalogInfotothelocalcatalogJMSCatalogAddEventHandler.add(catalog,info);
else{//incomingobjectnotrecognized
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe("Unrecognizedeventtype");returnfalse;
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(this.getClass()+"isunabletosynchronizetheincomingevent:"+event);throwe;
if(infoinstanceofLayerGroupInfo){finalLayerGroupInfodeserObject=CatalogUtils.localizeLayerGroup((LayerGroupInfo)info,catalog);catalog.add(ModificationProxy.unwrap(deserObject));
else
if(infoinstanceofLayerInfo){finalLayerInfolayer=CatalogUtils.localizeLayer((LayerInfo)info,catalog);catalog.add(ModificationProxy.unwrap(layer));
else
if(infoinstanceofMapInfo){finalMapInfolocalObject=CatalogUtils.localizeMapInfo((MapInfo)info,catalog);catalog.add(ModificationProxy.unwrap(localObject));
else
if(infoinstanceofNamespaceInfo){finalNamespaceInfonamespace=CatalogUtils.localizeNamespace((NamespaceInfo)info,catalog);catalog.add(ModificationProxy.unwrap(namespace));
else
if(infoinstanceofStoreInfo){StoreInfostore=CatalogUtils.localizeStore((StoreInfo)info,catalog);catalog.add(ModificationProxy.unwrap(store));
else
if(infoinstanceofResourceInfo){finalResourceInforesource=CatalogUtils.localizeResource((ResourceInfo)info,catalog);catalog.add(ModificationProxy.unwrap(resource));
else
if(infoinstanceofStyleInfo){finalStyleInfodeserializedObject=CatalogUtils.localizeStyle((StyleInfo)info,catalog);catalog.add(ModificationProxy.unwrap(deserializedObject));
else
if(infoinstanceofWorkspaceInfo){finalWorkspaceInfoworkspace=CatalogUtils.localizeWorkspace((WorkspaceInfo)info,catalog);catalog.add(ModificationProxy.unwrap(workspace));
else
if(infoinstanceofCatalogInfo){//TODOmaywedon'twanttosendthisemptymessage!//TODOchecktheproducer//DONOTHING
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("info-ID:"+info.getId()+"toString:"+info.toString());
else{thrownewIllegalArgumentException("Badincomingobject:"+info.getClass());
if(lakes!=null&&forests!=null){LayerGroupInfonature=buildGroup(NATURE_GROUP,lakes,forests);catalog.add(nature);LayerGroupInfociteNature=buildGroup(CITE_NATURE_GROUP,lakes,forests);citeNature.setWorkspace(catalog.getWorkspaceByName(MockData.CITE_PREFIX));catalog.add(citeNature);
if(gaStore!=null){gaTest.removeValues(gaStore);gaStore.store();
if(ugStore!=null){ugTest.removeValues(ugStore);ugStore.store();
if(gaStore!=null){gaStore.clear();gaStore.store();
if(ugStore!=null){ugStore.clear();ugStore.store();
if(secMgr.listRoleServices().contains(getRORoleServiceName())){SecurityRoleServiceConfigconfig=secMgr.loadRoleServiceConfig((getRORoleServiceName()));secMgr.removeRoleService(config);
if(secMgr.listUserGroupServices().contains(getROUserGroupServiceName())){SecurityUserGroupServiceConfigconfig=secMgr.loadUserGroupServiceConfig(getROUserGroupServiceName());secMgr.removeUserGroupService(config);
if(behaviorinstanceofAbstractDefaultAjaxBehavior){Stringname=behavior.getClass().getSimpleName();
if(name.startsWith("WindowClosedBehavior")){tester.executeBehavior((AbstractAjaxBehavior)behavior);
if(behaviorinstanceofAbstractDefaultAjaxBehavior){Stringname=behavior.getClass().getSimpleName();
if(name.startsWith("CloseButtonBehavior")){tester.executeBehavior((AbstractAjaxBehavior)behavior);
if(msg.toString().matches(regExp))returntrue;
if(name.equals(item.getModelObject().getName()))tester.clickLink(item.getPageRelativePath()+":itemProperties:0:component:link");
if(object==null)returnnull;//wrappingcheckClassclazz=object.getClass();
if(!canSecure(clazz))thrownewIllegalArgumentException("Don'tknowhowtowrapobjectsofclass"+object.getClass());//scanclassesfromthemostspecifictothemostgeneral(inheritance//wise).Startwithdatastoresanddataaccess,whichdoprovide//metadata
if(DataStore.class.isAssignableFrom(clazz)){returnnewReadOnlyDataStore((DataStore)object,policy);
else
if(DataAccess.class.isAssignableFrom(clazz)){returnnewReadOnlyDataAccess((DataAccess)object,policy);
ifthe//challengemodeissettotrue,otherwisewe'rehidemodeandwe//shouldjustreturnareadonlywrapper,aFeatureSource
if(SimpleFeatureSource.class.isAssignableFrom(clazz)){
if((policy.level==AccessLevel.READ_ONLY||policy.level==AccessLevel.METADATA||policy.level==AccessLevel.HIDDEN)&&policy.response!=Response.CHALLENGE){returnnewSecuredSimpleFeatureSource((SimpleFeatureSource)object,policy);
else
if(SimpleFeatureLocking.class.isAssignableFrom(clazz)){returnnewSecuredSimpleFeatureLocking((SimpleFeatureLocking)object,policy);
else
if(SimpleFeatureStore.class.isAssignableFrom(clazz)){returnnewSecuredSimpleFeatureStore((SimpleFeatureStore)object,policy);
else
if(SimpleFeatureSource.class.isAssignableFrom(clazz)){returnnewSecuredSimpleFeatureSource((SimpleFeatureSource)object,policy);
else
if(FeatureSource.class.isAssignableFrom(clazz)){
if((policy.level==AccessLevel.READ_ONLY||policy.level==AccessLevel.METADATA||policy.level==AccessLevel.HIDDEN)&&policy.response!=Response.CHALLENGE){returnnewSecuredFeatureSource((FeatureSource)object,policy);
else
if(FeatureLocking.class.isAssignableFrom(clazz)){returnnewSecuredFeatureLocking((FeatureLocking)object,policy);
else
if(FeatureStore.class.isAssignableFrom(clazz)){returnnewSecuredFeatureStore((FeatureStore)object,policy);
else
if(FeatureSource.class.isAssignableFrom(clazz)){returnnewSecuredFeatureSource((FeatureSource)object,policy);
if(SimpleFeatureCollection.class.isAssignableFrom(clazz)){returnnewSecuredSimpleFeatureCollection((SimpleFeatureCollection)object,policy);
else
if(FeatureCollection.class.isAssignableFrom(clazz)){returnnewSecuredFeatureCollection((FeatureCollection)object,policy);
else
if(SimpleFeatureIterator.class.isAssignableFrom(clazz)){returnnewSecuredSimpleFeatureIterator((SimpleFeatureIterator)object);
else
if(FeatureIterator.class.isAssignableFrom(clazz)){returnnewSecuredFeatureIterator((FeatureIterator)object);
if(StructuredGridCoverage2DReader.class.isAssignableFrom(clazz)){returnnewSecuredStructuredGridCoverage2DReader((StructuredGridCoverage2DReader)object,policy);
else
if(GridCoverage2DReader.class.isAssignableFrom(clazz)){returnnewSecuredGridCoverage2DReader((GridCoverage2DReader)object,policy);
else
if(AbstractGridFormat.class.isAssignableFrom(clazz)){returnnewSecuredGridFormat((AbstractGridFormat)object,policy);
if(WebMapServer.class.isAssignableFrom(clazz)){try{returnnewSecuredWebMapServer((WebMapServer)object);
if(WebMapTileServer.class.isAssignableFrom(clazz)){try{returnnewSecuredWebMapTileServer((WebMapTileServer)object);
if(!(featureSourceinstanceofSimpleFeatureSource)){thrownewIllegalStateException("Cannotapplydynamicdimensionrestrictionstocomplexfeatures.");
if(origional==0l){return0l;//cannotmodifyafilethatdoesnotexsist
if(this.event==null){this.event=notification;
ifnotwewill*waitforsignal.Iftheeventstillhasnotarrivedafterfivesecondsnullwillbe*returned.**@returnNotificationevent,ornull
ifitdoesnotarrivewithin5seconds*@throwsInterruptedException*/publicTawait(longhowlong,TimeUnitunit)throwsInterruptedException{finallongDELAY=unit.convert(howlong,TimeUnit.MILLISECONDS);lock.lock();try{
if(this.event==null){longmark=System.currentTimeMillis();while(this.event==null){longcheck=System.currentTimeMillis();
if(mark+DELAY<check){returnnull;//eventdidnotshowup!
ifthat'sstill//availableSimpleFeatureTypeft=(SimpleFeatureType)task.getMetadata().get(FeatureType.class);GMLVersionversion=(GMLVersion)task.getMetadata().get(GML_VERSION_KEY);
if(version==null){version=GMLVersion.GML3;
if(ft==null){FeatureTypeInfofti=(FeatureTypeInfo)task.getLayer().getResource();ft=buildFeatureTypeFromInfo(fti);
if(crs==null){resource.setSRS(GENERIC_2D_CODE);resource.setNativeCRS(null);
else{Integercode=null;try{code=CRS.lookupEpsgCode(crs,true);
ifwecouldnotfindacode,reprojecttoatargetCRS
if(code==null){targetCRS=CRS.decode("EPSG:4326",true);resource.setSRS("EPSG:4326");resource.setNativeCRS(crs);
else
if(CRS.getAxisOrder(crs)==AxisOrder.NORTH_EAST){targetCRS=CRS.decode("EPSG:"+code,true);resource.setSRS("EPSG:"+code);resource.setNativeCRS(targetCRS);
else{resource.setSRS("EPSG:"+code);resource.setNativeCRS(crs);
if(targetCRS!=crs){ReprojectTransformtransform=newReprojectTransform(crs,targetCRS);TransformChain<VectorTransform>chain=newVectorTransformChain(transform);task.setTransform(chain);
if(GML.NAMESPACE.equals(gmlNamespace)){version=GMLVersion.GML32;
else{//missing,orthegeneric"http://opengis.net/gml"usedforGML3.1and2.xgrrr//trytousesomeversiondetectionbasedonheuristics(e.g.,tagsthat//weknowarespecifictoaparticularversion).Thesecouldcertainlyusesome//improvement...while(parser.next()!=XmlPullParser.END_DOCUMENT){
if(parser.getEventType()!=XmlPullParser.START_TAG){continue;
if("outerBoundaryIs".equals(tag)||"innerBoundaryIs".equals(tag)){version=GMLVersion.GML2;break;
if(hasSchema){//wetrustthefeaturetypefoundbytheparserthen,butwestill//havetofigureouttheCRSresult=sf.getFeatureType();
if(result.getCoordinateReferenceSystem()==null){Geometryg=(Geometry)sf.getDefaultGeometry();
if(g!=null&&g.getUserData()instanceofCoordinateReferenceSystem){CoordinateReferenceSystemcrs=(CoordinateReferenceSystem)g.getUserData();result=FeatureTypes.transform(result,crs);
ifwehavetheschema,wefigureouttheattributesanyways//sinceweneedtodecidewhattodooftheGMLbaseones
if(typeName==null){typeName=sf.getFeatureType().getTypeName();
if(result!=null){SimpleFeatureTypeBuildertb=newSimpleFeatureTypeBuilder();tb.init(result);for(StringgmlAttribute:GML_ATTRIBUTES){
if(!guessedTypes.containsKey(gmlAttribute)&&tb.get(gmlAttribute)!=null){tb.remove(gmlAttribute);
if(validAttributeType.isAssignableFrom(binding)){valid=true;break;
if(!valid&&tb.get(name)!=null){tb.remove(name);
if(typeName!=null){SimpleFeatureTypeBuildertb=newSimpleFeatureTypeBuilder();tb.setName(typeName);for(AttributeDescriptorad:guessedTypes.values()){tb.add(ad);
else{//uhoh,emptyGMLfile?thrownewIllegalArgumentException("CouldnotfindanyGMLfeatureinthefile");
if(value==null){return;
ifwehavealreadyestablishedit'sastring,bailoutAttributeDescriptorad=guessedTypes.get(name);Classtarget=null;
if(ad!=null){target=ad.getType().getBinding();
if(String.class.equals(target)||Geometry.class.equals(target)){return;
if(valueinstanceofGeometry){//forgeometries,specialcaseasweneedtohandletheCRSandwebasically//havenopromotions,eitherallequal,orallGeometry.class
if(target==null){Geometryg=(Geometry)value;AttributeTypeBuildertypeBuilder=newAttributeTypeBuilder();typeBuilder.setName(name);typeBuilder.setBinding(value.getClass());
if(g.getUserData()instanceofCoordinateReferenceSystem){typeBuilder.setCRS((CoordinateReferenceSystem)g.getUserData());
else
if(Geometry.class.isAssignableFrom(target)&&!target.isInstance(value)){AttributeTypeBuildertypeBuilder=newAttributeTypeBuilder();typeBuilder.init(ad);typeBuilder.setBinding(Geometry.class);AttributeDescriptorgeometryDescriptor=typeBuilder.buildDescriptor(name);guessedTypes.put(name,geometryDescriptor);
else{Hintshints=newHints(ConverterFactory.SAFE_CONVERSION,true);
if(target==null){for(Classc:TYPE_GUESS_TARGETS){Objectconverted=Converters.convert(value,c,hints);
if(converted!=null){target=c;break;
if(target==null){target=String.class;
ifallfails,usestring
if(converted==null){target=String.class;
if(originalTarget!=target){AttributeTypeBuildertypeBuilder=newAttributeTypeBuilder();typeBuilder.setName(name);typeBuilder.setBinding(target);AttributeDescriptornewDescriptor=typeBuilder.buildDescriptor(name);guessedTypes.put(name,newDescriptor);
ifthetimeoutparameterisnegative*/privatestaticfinalintCONN_TIMEOUT=30000;/***Setsthereadtimeouttoaspecifiedtimeout,inmilliseconds.Anon-zerovaluespecifiesthe*timeoutwhenreadingfromInputstreamwhenaconnectionisestablishedtoaresource.Ifthe*timeoutexpiresbeforethereisdataavailableforread,a{@link*java.net.SocketTimeoutException}israised.**<p>Atimeoutofzeroisinterpretedasaninfinitetimeout.**<p>Somenon-standardimplementationofthismethodmayignorethespecifiedtimeout.Tosee*thereadtimeoutset,pleasecallgetReadTimeout().**@paramtimeoutanintthatspecifiesthetimeoutvaluetobeusedinmilliseconds*@throws{@linkIllegalArgumentException}-
ifthetimeoutparameterisnegative*/privatestaticfinalintREAD_TIMEOUT=30000;privateRestTemplaterestTemplate;privatestaticStringrolePrefix="ROLE_";staticbooleanisEmpty(Stringproperty){returnproperty==null||property.isEmpty();
if(!isEmpty(restRoleServiceConfig.getAdminRoleName())){this.adminGroup=restRoleServiceConfig.getAdminRoleName();
if(!isEmpty(restRoleServiceConfig.getGroupAdminRoleName())){this.groupAdminGroup=restRoleServiceConfig.getGroupAdminRoleName();
if(roleObjinstanceofString){populateRoles((String)roleObj,roles);
else
if(roleObjinstanceofJSONArray){for(Objectrole:((JSONArray)roleObj)){populateRoles((String)role,roles);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("SettingROLESforUser["+username+"]to"+finalRoles);
if(role.startsWith(rolePrefix)){//removestandardroleprefixrole=role.substring(rolePrefix.length());
ifisanADMINGeoServerRoleadminRole=getAdminRole();
if(roles.contains(GeoServerRole.ADMIN_ROLE)||roles.contains(adminRole)){roles.clear();roles.add(GeoServerRole.ADMIN_ROLE);
ifRoleAnonymousispresentotherthanotherroles
if(roles.size()>1&&roles.contains(GeoServerRole.ANONYMOUS_ROLE)){roles.remove(GeoServerRole.ANONYMOUS_ROLE);
if(role!=null){set.add(role);
if(role.startsWith(rolePrefix)){//removestandardroleprefixrole=role.substring(rolePrefix.length());
if(role.startsWith(rolePrefix)){//removestandardroleprefixrole=role.substring(rolePrefix.length());
if(targetRole.startsWith(rolePrefix)){//removestandardroleprefixtargetRole=targetRole.substring(rolePrefix.length());
if(roleName.equalsIgnoreCase(targetRole)){returncreateRoleObject(roleName);
if(adminGroup==null){try{return(GeoServerRole)connectToRESTEndpoint(restRoleServiceConfig.getBaseUrl(),restRoleServiceConfig.getAdminRoleRESTEndpoint(),restRoleServiceConfig.getAdminRoleJSONPath(),newRestEndpointConnectionCallback(){@OverridepublicObjectexecuteWithContext(Stringjson)throwsException{try{StringtargetRole=JsonPath.read(json,restRoleServiceConfig.getAdminRoleJSONPath());
if(targetRole.startsWith(rolePrefix)){//removestandardroleprefixtargetRole=targetRole.substring(rolePrefix.length());
if(groupAdminGroup==null){returngetAdminRole();
if(restTemplate==null){restTemplate=restTemplate();
switch(status){case200:case201:BufferedReaderbr=newBufferedReader(newInputStreamReader(clientResponse.getBody()));StringBuildersb=newStringBuilder();Stringline;while((line=br.readLine())!=null){sb.append(line+"\n");
if(clientResponse!=null){try{clientResponse.close();
if(repository!=null){try{URIlocation=repository.getLocation();LOGGER.fine(format("ClosingcachedGeoGigrepositoryinstance%s",location!=null?location:repoId));repository.close();LOGGER.finer(format("ClosedcachedGeoGigrepositoryinstance%s",location!=null?location:repoId));
if(handlerinstanceofHandlerMethod){return((HandlerMethod)handler).getBean();
ifalreadyispasswordField.setResetPassword(false);FormComponentFeedbackBorderrequiredFieldFeedback;requiredFieldFeedback=newFormComponentFeedbackBorder("border");requiredFieldFeedback.add(passwordField);add(requiredFieldFeedback);
if("sample_image".equalsIgnoreCase(name)){returntrue;
if(!mosaic.getName().equalsIgnoreCase(FilenameUtils.getBaseName(name))){returnfalse;
if(ext!=null){try{shpFileType=ShpFileType.valueOf(ext.toUpperCase());
if(!f.delete()){//throwingexceptionherecausedsporadictestfailureson//windowsrelatedtofilelockingbutonlyinthecleanup//methodSystemTestData.tearDownLOGGER.warning("unabletodeletemosaicfile"+f.getAbsolutePath());
ifalreadyexistsdelete();Collection<Granule>granules=mosaic.granules();
if(granules.isEmpty()){LOGGER.warning("Nogranulesinmosaic,nothingtowrite");return;
if(first==null){thrownewIOException("UnabletodetermineCRSformosaic");
if(mosaic.getTimeMode()!=TimeMode.NONE){typeBuilder.add("time",Date.class);
if(g.getEnvelope()==null){LOGGER.warning("Skipping"+g.getFile().getAbsolutePath()+",noenvelope");
if(mosaic.getTimeMode()!=TimeMode.NONE){f.setAttribute("time",g.getTimestamp());
ifwehavetoaddthetime,dosonow
if(mosaic.getTimeMode()!=TimeMode.NONE){FilepropertyFile=newFile(mosaic.getFile(),mosaic.getName()+".properties");FileInputStreamfis=null;FileOutputStreamfos=null;try{fis=newFileInputStream(propertyFile);Propertiesprops=newProperties();props.load(fis);fis.close();props.setProperty("TimeAttribute","time");fos=newFileOutputStream(propertyFile);props.store(fos,null);
if(raster.getTransferType()==DataBuffer.TYPE_DOUBLE)ps.print(raster.getSampleDouble(i,j,band));
else
if(raster.getTransferType()==DataBuffer.TYPE_FLOAT)ps.print(raster.getSampleFloat(i,j,band));
elseps.print(raster.getSample(i,j,band));
if(i<(raster.getMinX()+raster.getWidth()-1));ps.print("");
ifweshouldvalidateornotBooleanstrict=(Boolean)kvp.get("strict");
if(strict==null){strict=Boolean.FALSE;
if(wfs.isCiteCompliant()){strict=Boolean.TRUE;
if(!"Transaction".equalsIgnoreCase(requestReader.getElement().getLocalPart())){
if(!parser.getValidationErrors().isEmpty()){WFSExceptionexception=newWFSException("Invalidrequest","InvalidParameterValue");for(Iteratore=parser.getValidationErrors().iterator();e.hasNext();){Exceptionerror=(Exception)e.next();exception.getExceptionText().add(error.getLocalizedMessage());
if(!meta.enabled()){continue;
if(depinstanceoforg.geotools.gml2.GMLConfiguration){return((org.geotools.gml2.GMLConfiguration)dep).getSrsSyntax();
if(depinstanceoforg.geotools.gml3.GMLConfiguration){return((org.geotools.gml3.GMLConfiguration)dep).getSrsSyntax();
if(depinstanceoforg.geotools.gml2.GMLConfiguration){((org.geotools.gml2.GMLConfiguration)dep).setSrsSyntax(srsSyntax);
if(depinstanceoforg.geotools.gml3.GMLConfiguration){((org.geotools.gml3.GMLConfiguration)dep).setSrsSyntax(srsSyntax);
if(clazz.isAssignableFrom(expectedType)){returntrue;
if(clazz.isAssignableFrom(expectedType)){returnobj;
if(!(oinstanceofGridCoverage2D)){thrownewIllegalArgumentException("ProvidedobjectisnotaGridCoverage2D:"+(o!=null?o.getClass().toString():"null"));
if(EPSGCode==null){thrownewIllegalStateException("UnabletolookupepsgcodeforthisCRS:"+crs);
if(dimensionsHelper!=null){//handletime
ifnecessaryhandleTimeMetadata(dimensionsHelper);//handleelevation
ifnecessaryhandleElevationMetadata(dimensionsHelper);//handleadditionaldimensions
ifnecessaryhandleAdditionalDimensionMetadata(dimensionsHelper);
if(customDimension!=null){setAdditionalDimensionMetadata(dimensionName,customDimension,helper);
ifweareinthelistofinstantscase,orinthelistofperiodscase//listcaseinti=0;for(Stringitem:domain){Datedate=WCSDimensionsValueParser.parseAsDate(item);
if(date!=null){finalStringdimensionId=helper.getCoverageId()+"_dd_"+i;encodeDate(date,helper,dimensionId);continue;
if(number!=null){element(TAG.SINGLE_VALUE,item.toString());continue;
if(range!=null){encodeInterval(range.getMinValue().toString(),range.getMaxValue().toString(),null,null);continue;
if(iteminstanceofString){element(TAG.SINGLE_VALUE,item.toString());
else
if(iteminstanceofDateRange){//finalStringdimensionId=helper.getCoverageId()+"_dd_"+//i;//encodeDateRange((DateRange)item,helper,dimensionId);//
if(dimensionTag.equals(TAG.ADDITIONAL_DIMENSION)){prolog=TAG.ADDITIONAL_DIMENSION+"name=\""+name+"\"";defaultValue=helper.getDefaultValue(name);
else
if(dimensionTag.equals(TAG.ELEVATION_DOMAIN)){prolog=TAG.ELEVATION_DOMAIN;defaultValue=helper.getBeginElevation();
else
if(dimensionTag.equals(TAG.TIME_DOMAIN)){prolog=TAG.TIME_DOMAIN;defaultValue=helper.getEndTime();
if(timeDimension!=null){start(initStartMetadataTag(TAG.TIME_DOMAIN,null,timeDimension,helper));finalDimensionPresentationpresentation=timeDimension.getPresentation();finalStringid=helper.getCoverageId();
switch(presentation){caseCONTINUOUS_INTERVAL:encodeTimePeriod(helper.getBeginTime(),helper.getEndTime(),id+"_tp_0",null,null);break;caseDISCRETE_INTERVAL:encodeTimePeriod(helper.getBeginTime(),helper.getEndTime(),id+"_tp_0",helper.getTimeResolutionUnit(),helper.getTimeResolutionValue());break;default://TODO:check
ifweareinthelistofinstantscase,orinthelistof//periodscase//listcasefinalTreeSet<Object>domain=helper.getTimeDomain();inti=0;for(Objectitem:domain){//gml:idismandatoryfortimeinstant...
if(iteminstanceofDate){encodeDate((Date)item,helper,id+"_td_"+i);
else
if(iteminstanceofDateRange){encodeDateRange((DateRange)item,helper,id+"_td_"+i);
if(elevationDimension!=null){start(initStartMetadataTag(TAG.ELEVATION_DOMAIN,null,elevationDimension,helper));finalDimensionPresentationpresentation=elevationDimension.getPresentation();
switch(presentation){//Where_er_meanselevationrangecaseCONTINUOUS_INTERVAL:encodeInterval(helper.getBeginElevation(),helper.getEndElevation(),null,null);break;caseDISCRETE_INTERVAL:encodeInterval(helper.getBeginElevation(),helper.getEndElevation(),helper.getElevationResolutionUnit(),helper.getElevationResolutionValue());break;default://TODO:check
ifweareinthelistofinstantscase,orinthelistof//periodscase//listcasefinalTreeSet<Object>domain=helper.getElevationDomain();for(Objectitem:domain){
if(iteminstanceofNumber){element(TAG.SINGLE_VALUE,item.toString());
else
if(iteminstanceofNumberRange){NumberRangerange=(NumberRange)item;encodeInterval(range.getMinValue().toString(),range.getMaxValue().toString(),null,null);
if(intervalUnit!=null&&intervalValue!=null){atts=newAttributesImpl();atts.addAttribute("","unit","unit","",intervalUnit);element("gml:TimeInterval",intervalValue.toString(),atts);
if(intervalUnit!=null&&intervalValue!=null){atts=newAttributesImpl();atts.addAttribute("","unit","unit","",intervalUnit);element(TAG.INTERVAL_PERIOD,intervalValue.toString(),atts);
if(dimensionHelper!=null){
if(dimensionHelper.getElevationDimension()!=null){uomLabels=uomLabels+"m";//TODO:CheckelevationuomhasElevation=true;
if(dimensionHelper.getTimeDimension()!=null){uomLabels=uomLabels+"s";hasTime=true;
if(dimensionHelper!=null&&(hasTime||hasElevation)){envelopeName="gml:EnvelopeWithTimePeriod";
else{envelopeName="gml:Envelope";
if(dimensionHelper!=null&&hasTime){element("gml:beginPosition",dimensionHelper.getBeginTime());element("gml:endPosition",dimensionHelper.getEndTime());
if(crsinstanceofGeographicCRS){return"Deg";
if(fileReference!=null){encodeFileReference(fileReference);
else{encodeAsDataBlocks(gc2d);
switch(dataType){caseDataBuffer.TYPE_BYTE:caseDataBuffer.TYPE_INT:caseDataBuffer.TYPE_SHORT:caseDataBuffer.TYPE_USHORT:iterator.getPixel(valuesI);for(inti=0;i<numBands;i++){//spitoutchars(String.valueOf(valuesI[i]));
if(i+1<numBands){chars(",");
if(i+1<numBands){chars(",");
if(nodataValues!=null&&nodataValues.length>0){for(doublenodata:nodataValues){finalAttributesImplnodataAttr=newAttributesImpl();nodataAttr.addAttribute("","reason","reason","","http://www.opengis.net/def/nil/OGC/0/unknown");element("swe:nilValue",String.valueOf(nodata),nodataAttr);
else
if(gc2d!=null){//dowehavealreadyaaNO_DATAvalueathand?NoDataContainernoDataProperty=CoverageUtilities.getNoDataProperty(gc2d);
if(noDataProperty!=null){Stringnodata=Double.valueOf(noDataProperty.getAsSingleValue()).toString();//TODOtestmefinalAttributesImplnodataAttr=newAttributesImpl();nodataAttr.addAttribute("","reason","reason","","http://www.opengis.net/def/nil/OGC/0/unknown");element("swe:nilValue",nodata,nodataAttr);
else{//let'ssuggestsomemeaningfulvaluefromthedatatypeoftheunderlying//imageNumbernodata=CoverageUtilities.suggestNoDataValue(gc2d.getRenderedImage().getSampleModel().getDataType());finalAttributesImplnodataAttr=newAttributesImpl();nodataAttr.addAttribute("","reason","reason","","http://www.opengis.net/def/nil/OGC/0/unknown");element("swe:nilValue",nodata.toString(),nodataAttr);
if(!setRange(sd.getRange())){SampleDimensionTypesdType=sd.getDimensionType();handleSampleDimensionType(sdType);
if(sdType==null){//picktheonewiththelargestdomainandbedonewithitsdType=SampleDimensionType.REAL_64BITS;
if(range!=null&&!Double.isInfinite(range.getMaximum())&&!Double.isInfinite(range.getMinimum())){start("swe:interval");chars(range.getMinValue()+""+range.getMaxValue());end("swe:interval");returntrue;
if(sdinstanceofGridSampleDimension){GridSampleDimensiongridSd=((GridSampleDimension)sd);setRange=setRange(gridSd.getRange());
if(!setRange){//fallbackonsampleDimensionTypeSampleDimensionTypesdType=sd.getSampleDimensionType();handleSampleDimensionType(sdType);
if(!(transforminstanceofAffineTransform2D)){thrownewIllegalStateException("Invalidgridtoworlprovided:"+transform.toString());
if(grids!=null){for(Gridgrid:grids){this.levels.add(grid.clone());
ifthisisaGWCinternallydefinedGridSet*/publicbooleanisInternal(){returninternal;
iftheequivalencecan'tbeestablished*/publicDoublegetMetersPerUnit(CoordinateReferenceSystemcrs){
if(crs==null){returnnull;
iftheprovidedunitcan'tbeconvertedtometers*/staticDoublemetersPerUnit(finalUnit<?>unit){doublemeters;finalUnit<Angle>degree=NonSI.DEGREE_ANGLE;finalUnit<Angle>dms=Units.DEGREE_MINUTE_SECOND;
if(degree.equals(unit)){meters=GridSetFactory.EPSG4326_TO_METERS;
else{try{meters=unit.getConverterToAny(SI.METRE).convert(1);
ifthereisn'tanyresolutionrelateddescriptor*/booleancanCompute(){returnresDescriptor!=null||(resXDescriptor!=null&&resYDescriptor!=null);
if(env==null){env=newGeneralEnvelope(featureBBox);
else{env.add(featureBBox);
if(env!=null){envelope=newReferencedEnvelope(env);
if(isHeterogeneousCrs){StringcrsId=(String)feature.getAttribute(crsAttribute);CoordinateReferenceSystemgranuleCrs=catalog.getResourcePool().getCRS(crsId);transformResolution(feature,schemaCrs,granuleCrs,resolution);
iftheCRStransformationistheidentity
if(!transform.isIdentity()){BoundingBoxbounds=feature.getBounds();MathTransforminverse=transform.inverse();//Getthecentercoordinateinthegranule'sCRSdoublecenter[]=newdouble[]{(bounds.getMaxX()+bounds.getMinX())/2,(bounds.getMaxY()+bounds.getMinY())/2};transform.transform(center,0,center,0,1);//Setup2segmentsingranule'sCRSdouble[]coords=newdouble[6];double[]resCoords=newdouble[6];//centercoords[0]=center[0];coords[1]=center[1];//DXfromcentercoords[2]=center[0]+resolution[0];coords[3]=center[1];//DYfromcentercoords[4]=center[0];coords[5]=center[1]+resolution[1];//TransformthecoordinatesbacktoschemaCrsinverse.transform(coords,0,resCoords,0,3);doubledx1=resCoords[2]-resCoords[0];doubledx2=resCoords[3]-resCoords[1];doubledy1=resCoords[4]-resCoords[0];doubledy2=resCoords[5]-resCoords[1];//ComputingeuclideandistancesdoubletransformedDX=Math.sqrt(dx1*dx1+dx2*dx2);doubletransformedDY=Math.sqrt(dy1*dy1+dy2*dy2);resolution[0]=transformedDX;resolution[1]=transformedDY;
if(!StructuredGridCoverage2DReader.class.isAssignableFrom(reader.getClass())){////CASEA:simplereaders:returnthenativeresolutiongridGeometry//
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Theunderlyingreaderisnotstructured;returningnativeresolution");
else{////CASEB:StructuredGridCoverage2DReader//StructuredGridCoverage2DReaderstructuredReader=(StructuredGridCoverage2DReader)reader;StringcoverageName=reader.getGridCoverageNames()[0];Map<String,DimensionDescriptor>descriptors=structuredReader.getDimensionDescriptors(coverageName).stream().collect(Collectors.toMap(dd->dd.getName(),dd->dd));ResolutionProviderprovider=newResolutionProvider(descriptors);////Dowehaveanyresolutiondescriptoravailable?//
ifnot,gotostandardcomputation.//
if(!provider.canCompute()){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Theunderlyingreaderisstructuredbutnoresolutiondescriptorsareavailable"+".Returningnativeresolution");
if(features==null||features.isEmpty()){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Nofeaturesavailableforthespecifiedquery.Returningnativeresolution");
ifaROIhasbeenprovided
if(roiManager!=null){CoordinateReferenceSystemtargetCRS=roiManager.getTargetCRS();GeometryDescriptorgeomDescriptor=granules.getSchema().getGeometryDescriptor();CoordinateReferenceSystemindexCRS=geomDescriptor.getCoordinateReferenceSystem();ReferencedEnvelopeenvelope=null;
if(targetCRS!=null&&!roiManager.isRoiCrsEqualsTargetCrs()){envelope=newReferencedEnvelope(roiManager.getSafeRoiInTargetCRS().getEnvelopeInternal(),targetCRS);MathTransformreprojectionTrasform=null;
if(!CRS.equalsIgnoreMetadata(targetCRS,indexCRS)){reprojectionTrasform=CRS.findMathTransform(targetCRS,indexCRS,true);
if(!reprojectionTrasform.isIdentity()){envelope=envelope.transform(indexCRS,true);
else{envelope=newReferencedEnvelope(roiManager.getSafeRoiInNativeCRS().getEnvelopeInternal(),indexCRS);
ifspecified
if(filter!=null){filters.add(filter);
if(!hasNext()){thrownewNoSuchElementException();
else{SimpleFeatureresult=next;next=null;returnresult;
if(next!=null){returntrue;
if(raw!=null){next=SimpleFeatureBuilder.retype(raw,featureType);
if(globalQuota==null){LOGGER.info("There'snoGWCglobaldiskquotaconfigured,settingadefaultof100MiB");globalQuota=newQuota(100,StorageUnit.MiB);diskQuotaConfig.setGlobalQuota(globalQuota);
if(diskQuotaModel.getObject().getQuotaStore()==null){storeNameModel.setObject(JDBCQuotaStoreFactory.H2_STORE);
if(idx>0){dialectNames.add(beanName.substring(0,idx));
if(config.getJNDISource()==null){connectionTypeModel.setObject("PRIVATE_POOL");
else{connectionTypeModel.setObject("JNDI");
if(!gwc.isDiskQuotaAvailable()){returnnewQuota();//fake
if(TimeUnit.SECONDS!=unit){frequency=(int)TimeUnit.SECONDS.convert(frequency,unit);diskQuotaConfig.setCacheCleanUpFrequency(frequency);diskQuotaConfig.setCacheCleanUpUnits(TimeUnit.SECONDS);
if(lastRun==null){resourceId="DiskQuotaConfigPanel.cleanUpLastRunNever";
else{resourceId="DiskQuotaConfigPanel.cleanUpLastRun";longtimeAgo=(System.currentTimeMillis()-lastRun.getTime())/1000;StringtimeUnits="s";
if(timeAgo>60*60*24){timeUnits="d";timeAgo/=60*60*24;
else
if(timeAgo>60*60){timeUnits="h";timeAgo/=60*60;
else
if(timeAgo>60){timeUnits="m";timeAgo/=60;
if(null!=titleKey){AttributeModifierattributeModifier=newAttributeModifier("title",newStringResourceModel(titleKey,(Component)null,null));checkBox.add(attributeModifier);
if(x>=minx&&x<maxx&&y>=miny&&y<maxy)returntrue;returnfalse;
ifthistileis(oneof)therootofthecurrent*dataset*/publicTilegetParent(){//
ifwegottooneoftheroottilesforthisdataset,juststop
if(z==0)returnnull;
elsereturnnewTile((long)Math.floor(x/2.0),(long)Math.floor(y/2.0),z-1);
ifarequestdoes*notspecifyadatatype.*/publicstaticfinalStringDEFAULT_DATA_TYPE="bil.defaultDataTypeAttribute";/**MetadatakeyforthebyteorderofBILresponsedata.*/publicstaticfinalStringBYTE_ORDER="bil.byteOrderAttribute";/***Metadatakeyforthe"nodata"valuetouseforBILresponsedata.Nodatavaluesinthe*sourcedatawillbetranslatedtothisvaluewhenBILrequestsareprocessed.*/publicstaticfinalStringNO_DATA_OUTPUT="bil.noDataOutputAttribute";}
if((object==null)||!this.supports(object.getClass())){thrownewIllegalArgumentException("ObjectmustbeaFilterInvocation");
if(delegate==null||dao.isModified()){synchronized(this){delegate=newRESTfulPathBasedFilterInvocationDefinitionMap();for(Stringrule:dao.getRules()){processPathList(rule);
if(line==null){break;
if(log.isDebugEnabled()){log.debug("Line"+counter+":"+line);
if(line.startsWith("//")){continue;
if(line.lastIndexOf('=')==-1){continue;
if(line.lastIndexOf("==")!=-1){thrownewIllegalArgumentException("Onlysingleequalsshouldbeusedinline"+line);
if(!StringUtils.hasText(name)||!StringUtils.hasText(value)){thrownewIllegalArgumentException("Failedtoparseavalidname/valuepairfrom"+line);
if(log.isDebugEnabled())log.debug("~~~~~~~~~~name="+name+"firstColonIndex="+firstColonIndex);
if(firstColonIndex!=-1){antPath=name.substring(0,firstColonIndex);methods=name.substring((firstColonIndex+1),name.length());
if(log.isDebugEnabled())log.debug("~~~~~~~~~~name="+name+"antPath="+antPath+"methods="+methods);String[]methodList=null;
if(methods!=null){methodList=methods.split(",");//VerifymethodListisvalidfor(intii=0;ii<methodList.length;ii++){booleanmatched=false;for(intjj=0;jj<validMethodNames.length;jj++){
if(methodList[ii].equals(validMethodNames[jj])){matched=true;break;
if(!matched){thrownewIllegalArgumentException("TheHTTPMethodName("+methodList[ii]+"doesNOTequalavalidname(GET,PUT,POST,DELETE)");
if(log.isDebugEnabled()){log.debug("methodList="+Arrays.toString(methodList));
if(!character.toLowerCase().equals(character)){thrownewIllegalArgumentException("YouareusingAntPaths,yetyouhavespecifiedanuppercasecharacterinline:"+line+"(character'"+character+"')");
if(str==null||separator==null||str.length()==0||separator.length()==0){returnstr;
if(pos==-1){returnstr;
if(str==null||str.length()==0){returnstr;
if(separator==null||separator.length()==0){return"";
if(pos==-1||pos==(str.length()-separator.length())){return"";
if(!RemoteOWSTestSupport.isRemoteWFSStatesAvailable(LOGGER))return;Documentdoc=getAsDOM("wms?request=getmap&service=wms&version=1.1.1"+"&format="+KMLMapOutputFormat.MIME_TYPE+"&layers=topp:states"+"&styles=Default"+"&height=1024&width=1024&bbox=-180,-90,180,90&srs=EPSG:4326"+"&remote_ows_type=wfs"+"&remote_ows_url="+RemoteOWSTestSupport.WFS_SERVER_URL+"&cql_filter=PERSONS>20000000");//print(doc);assertEquals(1,doc.getElementsByTagName("Placemark").getLength());
ifwehaveconfigsalreadyDefaultValueConfigurationsconfigs=configModel.getObject();
if(configs!=null){result.addAll(configs.getConfigurations());
else{configs=newDefaultValueConfigurations(newArrayList<DefaultValueConfiguration>());
if(!dimensionNames.contains(config.getDimension())){it.remove();
if(mdinstanceofDimensionInfo){//skipdisableddimensionsDimensionInfodi=(DimensionInfo)md;
if(!di.isEnabled()){continue;
if(key.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){dimensionName=key.substring(ResourceInfo.CUSTOM_DIMENSION_PREFIX.length());
else{dimensionName=key;
if(dimension.equals(config.getDimension())){return;
if(DEFAULT_VALUE_EXPRESSION.equals(property)){Fragmentf=newFragment(id,"ecqlEditor",DynamicDimensionsTabPanel.this);TextArea<String>ta=newTextArea<String>("editor");//adimensionexpressioncannotrefertoitselfList<String>otherDimensions=newArrayList<String>(enabledDimensionNames);StringcurrentDimension=((DefaultValueConfiguration)itemModel.getObject()).getDimension();otherDimensions.remove(currentDimension);ta.add(newECQLValidator().setValidAttributes(otherDimensions));ta.setModel((IModel<String>)property.getModel(itemModel));ta.setOutputMarkupId(true);ObjectcurrentPolicy=POLICY.getModel(itemModel).getObject();ta.setVisible(DefaultValuePolicy.EXPRESSION.equals(currentPolicy));f.add(ta);returnf;
else
if(POLICY.equals(property)){Fragmentf=newFragment(id,"policyChoice",DynamicDimensionsTabPanel.this);finalDropDownChoice<DefaultValuePolicy>dd=newDropDownChoice<DefaultValueConfiguration.DefaultValuePolicy>("choice",Arrays.asList(DefaultValuePolicy.values()));dd.setChoiceRenderer(newEnumChoiceRenderer(DynamicDimensionsTabPanel.this));dd.setModel((IModel<DefaultValuePolicy>)property.getModel(itemModel));f.add(dd);returnf;
ifwegothere,everythingbeforeithasbeenpopulated
if(property==DEFAULT_VALUE_EXPRESSION){MarkupContainerparent=item.getParent();//drilldownintothecontainerstogettheactualformcomponents//wewantfinalDropDownChoice<?>dd=(DropDownChoice<?>)((Fragment)((ListItem<?>)parent.get(3)).get(0)).get(0);finalTextArea<?>ta=(TextArea<?>)((Fragment)((ListItem<?>)parent.get(4)).get(0)).get(0);dd.add(newOnChangeAjaxBehavior(){privatestaticfinallongserialVersionUID=-6159626785706793328L;@OverrideprotectedvoidonUpdate(AjaxRequestTargettarget){DefaultValuePolicycurrentPolicy=(DefaultValuePolicy)dd.getConvertedInput();ta.setVisible(DefaultValuePolicy.EXPRESSION.equals(currentPolicy));target.add(ta);target.add(table);
if(property==DEFAULT_VALUE_EXPRESSION){tag.put("style","width:99%");
else{tag.put("style","width:1%");
if(config.getPolicy()==DefaultValuePolicy.EXPRESSION&&config.getDefaultValueExpression()==null){error(newParamResourceModel("expressionRequired",DynamicDimensionsTabPanel.this).getString());
if(componentinstanceofTextArea){TextAreatextArea=(TextArea)component;textArea.updateModel();
if(attribute==null)attribute=checkAttribute(featureType);
if(attribute==null)thrownewServiceException("Regionatingattributehasnotbeenspecified");//MakesuretheattributeisactuallythereAttributeDescriptorad=ft.getDescriptor(attribute);
if(ad==null){thrownewServiceException("Couldnotfindregionatingattribute"+attribute+"inlayer"+featureType.getName());
if(h2Type==null)thrownewServiceException("Attributetype"+ad.getType()+"isnot"+"supportedforexternalsortingon"+featureType.getName()+"#"+attribute);
ifthegeometryindextableisthereStatementst=null;try{st=cacheConn.createStatement();try{st.executeQuery("SELECT*FROMFEATUREIDXLIMIT1");
if(String.class.equals(ad.getType().getBinding())){intlength=FeatureTypes.getFieldLength(ad);
if(length<=0)length=255;return"VARCHAR("+length+")";
else{returnCLASS_MAPPINGS.get(ad.getType().getBinding());
if(geom.getLocalName().equals(attribute)){q.setPropertyNames(newString[]{geom.getLocalName()});
else{q.setPropertyNames(newString[]{attribute,geom.getLocalName()});
if(!CRS.equalsIgnoreMetadata(nativeCrs,Tile.WGS84))tx=CRS.findMathTransform(nativeCrs,Tile.WGS84,true);//readallthefeaturesandfilltheindextable//makeitsotheinsertionisasinglebigtransaction,should//befaster,//provideditdoesnotkillH2...conn.setAutoCommit(false);fi=fs.getFeatures(q).features();while(fi.hasNext()){//grabthecentroidandtransformitin4326
ifnecessarySimpleFeaturef=(SimpleFeature)fi.next();Geometryg=(Geometry)f.getDefaultGeometry();
if(g.isEmpty()){continue;
if(Double.isNaN(centroid.getX())||Double.isNaN(centroid.getY())){LOGGER.warning("Couldnotcalculatecentroidforfeature"+f.getID()+";g="+g.toText());continue;
if(tx!=null)tx.transform(coords,0,coords,0,1);//insertps.setDouble(1,coords[0]);ps.setDouble(2,coords[1]);ps.setString(3,f.getID());ps.setObject(4,getSortAttributeValue(f));ps.execute();
if(fi!=null)fi.close();
if(!nextCalled)try{next=rs.next();nextCalled=true;
if(!nextCalled)hasNext();nextCalled=false;try{doublex=rs.getDouble(1);doubley=rs.getDouble(2);builder.add(gf.createPoint(newCoordinate(x,y)));returnbuilder.buildFeature(rs.getString(3));
if(s.equals(searchValue))returnindex;index++;
if(key.equals(rule.getKey())){returnrule;
if(requestinstanceofHttpServletRequest){request=newAdvancedDispatchHttpRequest((HttpServletRequest)request);
if(delegate.getClass().getSimpleName().endsWith("MockHttpServletRequest")){return;
if(path==null){return;
if(slash>-1){this.servletPath=path.substring(0,slash);
else{this.servletPath=path;
if(question>-1){this.servletPath=this.servletPath.substring(0,question);
if(servletPath!=null&&delegate.getPathInfo()!=null&&delegate.getPathInfo().startsWith(servletPath))returndelegate.getPathInfo().substring(servletPath.length());
elsereturndelegate.getPathInfo();
if(!sq.getFeatureTypes().isEmpty()){item.getReturnFeatureType().addAll(sq.getFeatureTypes());
else{//WFS2.0mandatestheelement,buttheemptystringisnotavalidQName//WFS2.0.2allowstheelementtobeomitted,buttheemptystringisstillschema//invalid//inordertosupportbothversionsforthetimebeingwe'llhavetolistthem//all...catalog.getFeatureTypes().stream().map(ft->newQName(ft.getNamespace().getURI(),ft.getName(),ft.getNamespace().getPrefix())).forEach(qn->item.getReturnFeatureType().add(qn));
if(schema==null){return;
if(list==null){list=newArrayList<XSDSchema>();schemas.set(list);
if(list!=null){schemas.remove();for(XSDSchemaschema:list){Schemas.dispose(schema);
if(configFile.getType()==Type.UNDEFINED){IOUtils.copy(getClass().getResourceAsStream("filter.properties"),configFile.out());
if(watcher!=null&&watcher.isModified()){synchronized(this){
if(watcher.isModified()){filters=watcher.read();
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer("Testing"+path+"formonitorfiltering");
if(filters!=null){for(Filterf:filters){
if(f.matches(path)){returntrue;
if(infoinstanceofFeatureTypeInfo){returnnewVectorAccessLimits(CatalogMode.HIDE,null,Filter.EXCLUDE,null,Filter.EXCLUDE);
else
if(infoinstanceofCoverageInfo){returnnewCoverageAccessLimits(CatalogMode.HIDE,Filter.EXCLUDE,null,null);
else
if(infoinstanceofWMSLayerInfo){returnnewWMSAccessLimits(CatalogMode.HIDE,Filter.EXCLUDE,null,false);
else{//TODO:LogwarningaboutunknownresourcetypereturnnewDataAccessLimits(CatalogMode.HIDE,Filter.EXCLUDE);
if(hideLayer(layer)||hideResource(layer.getResource())){returnhide(layer.getResource());
if(hideLayer(layer)||hideResource(layer.getResource())){returnhide(layer.getResource());
if(hideResource(resource)){returnhide(resource);
else{returnsuper.getAccessLimits(user,resource);
if(hideWorkspace(workspace)){returnnewWorkspaceAccessLimits(CatalogMode.HIDE,false,false,false);
else{returnsuper.getAccessLimits(user,workspace);
if(hideStyle(style)){returnnewStyleAccessLimits(CatalogMode.HIDE);
else{returnsuper.getAccessLimits(user,style);
if(hideLayerGroup(layerGroup)){returnnewLayerGroupAccessLimits(CatalogMode.HIDE);
if(hideLayerGroup(layerGroup)){returnnewLayerGroupAccessLimits(CatalogMode.HIDE);
else{returnsuper.getAccessLimits(user,layerGroup,containers);
if(filter.hideResource(resource)){returntrue;
if(filter.hideLayer(layer)){returntrue;
if(filter.hideWorkspace(workspace)){returntrue;
if(filter.hideStyle(style)){returntrue;
if(filter.hideLayerGroup(layerGroup)){returntrue;
if(filters==null){filters=GeoServerExtensions.extensions(CatalogFilter.class);
if(filters==null||filters.isEmpty())returndelegate.getSecurityFilter(user,clazz);//Resultistheconjunctionofdelegate'sfilter,andthoseofalltheCatalogFiltersArrayList<Filter>convertedFilters=newArrayList<Filter>(this.filters.size()+1);convertedFilters.add(delegate.getSecurityFilter(user,clazz));//Delegate'sfilterfor(CatalogFilterfilter:getCatalogFilters()){convertedFilters.add(filter.getSecurityFilter(clazz));//EachCatalogFilter'sfilter
if(info.isGetMapMimeTypeCheckingEnabled())info.getGetMapMimeTypes().addAll(getMapMimeTypesComponent.getPalette().getModelCollection());
elseinfo.getGetMapMimeTypes().clear();info.setGetFeatureInfoMimeTypeCheckingEnabled(getFeatureInfoMimeTypesComponent.isMimeTypeCheckingEnabled());
if(info.isGetFeatureInfoMimeTypeCheckingEnabled())info.getGetFeatureInfoMimeTypes().addAll(getFeatureInfoMimeTypesComponent.getPalette().getModelCollection());
elseinfo.getGetFeatureInfoMimeTypes().clear();super.handleSubmit(info);
if(input!=null&&!input.equals("")){file=newFile(input);
if(model.getObject()==null)model.setObject(defaultValue);returnmodel;
if(filter.applicableForServices())result.add(filterName);
if(globalGroupRule.getModelObject()){returnnewParamResourceModel("globalGroup",AbstractDataAccessRulePage.this).getString();
else{returnnewParamResourceModel("workspace",AbstractDataAccessRulePage.this).getString();
if(globalGroupRule.getModelObject()){returngetGlobalLayerGroupNames();
else{returngetWorkspaceNames();
if(rolesFormComponent.isHasAnyRole()){rule.getRoles().clear();rule.getRoles().add(GeoServerRole.ANY_ROLE.getAuthority());
if(globalGroupRule.getModelObject()){//justtobeonthesafesiderule.setLayer(null);
iftheworkspaceis*)*/ArrayList<String>getLayerNames(StringrootName){ArrayList<String>result=newArrayList<String>();
if(!rootName.equals("*")){FilterwsResources=Predicates.equal("store.workspace.name",rootName);try(CloseableIterator<ResourceInfo>it=getCatalog().list(ResourceInfo.class,wsResources)){while(it.hasNext()){result.add(it.next().getName());
if(!result.contains(name)){result.add(name);
if(form.findSubmittingButton()!=form.get("save")){return;
if((roleInputString==null||roleInputString.trim().isEmpty())&&!rolesFormComponent.isHasAnyRole()){form.error(newParamResourceModel("emptyRoles",getPage()).getString());
if(request.targetCRS!=null){element("crs",epsgCode(request.targetCRS));
if(temp!=null){path="path=\""+URLs.fileToUrl(temp)+"\"";
if(remove!=null){removal="remove=\""+remove+"\"";
if(argumentinstanceofEvent){Eventevt=(Event)argument;returnsource==null||evt.getSource().equals(source);
else{returnfalse;
if(Resources.exists(node.getObject())){newClipboard.add(node);
if(componentinstanceofPage)setResponsePage((Page)component);
else{
if(!"component".equals(component.getId()))thrownewIllegalArgumentException("Componentfactorywasaskedtoproduceacomponetwith"+"id'component'butreturnedonewithid'"+component.getId());add(component);
if(!(oinstanceofCapsInfo)){returnfalse;
if(serviceLinks==null){serviceLinks=newArrayList<CapsInfo>();byService.put(key,serviceLinks);
elsegoingMonkeyProcess.clearCommands();
if(status!=null){//thestatusmust
switchfromdismissingtoplaingoneAssert.assertEquals(ProcessState.DISMISSING,status.getPhase());
if(status!=null){//thestatusmust
switchfromdismissingtoplaingoneAssert.assertEquals(ProcessState.DISMISSING,status.getPhase());
iffirstofthemreturnsmore//ofone//ofoutputresultitems(e.g.sextante:kriging,gs:MultiRaw),thenthenextWPSprocess//onlygets//thefirstitem.//TheInternalWPSInputProviderclassdoesnotfilterbynameordatatypetoextractthe//correct//outputitem.Documentd=postAsDOM("wps",xml);//print(d);checkValidationErrors(d);assertEquals("wps:ExecuteResponse",d.getDocumentElement().getNodeName());assertXpathExists("/wps:ExecuteResponse/wps:Status/wps:ProcessSucceeded",d);assertXpathEvaluatesTo("1","count(//wps:Output)",d);assertXpathEvaluatesTo("Echo='1234'","/wps:ExecuteResponse/wps:ProcessOutputs/wps:Output[ows:Identifier='result']/wps:Data/wps:LiteralData",d);
if(!RemoteOWSTestSupport.isRemoteWMSStatesAvailable(LOGGER)){LOGGER.warning("RemoteOWStestsdisabled,skippingtestwith"+id+"referencesource");return;
if(box.getCrs()!=null){re=newReferencedEnvelope(CRS.decode(box.getCrs()));
else{re=newReferencedEnvelope();
if(property.equals(BatchRunsModel.START)){returnnewSimpleAjaxLink<String>(id,(IModel<String>)property.getModel(runModel)){privatestaticfinallongserialVersionUID=-9184383036056499856L;@OverridepublicvoidonClick(AjaxRequestTargettarget){setResponsePage(newBatchRunPage(batchModel,runModel,getPage()));
else
if(property.equals(BatchRunsModel.STOP)){
if(runModel.getObject().getStatus().isClosed()||!TaskManagerBeans.get().getSecUtil().isWritable(((GeoServerSecuredPage)getPage()).getSession().getAuthentication(),runModel.getObject().getBatch())){returnnewLabel(id);
else{SimpleAjaxSubmitLinklink=newSimpleAjaxSubmitLink(id,null){privatestaticfinallongserialVersionUID=-9184383036056499856L;@OverrideprotectedvoidonSubmit(AjaxRequestTargettarget,Form<?>form){TaskManagerBeans.get().getBjService().interrupt(runModel.getObject());info(newParamResourceModel("runInterrupted",BatchRunsPage.this).getString());((GeoServerBasePage)getPage()).addFeedbackPanels(target);
iftherequestedoperationisnotsupported,aconveyorotherwise*/staticSimpleConveyormatch(StringoperationName,HttpServletRequestrequest,HttpServletResponseresponse,StorageBrokerstorageBroker,KvpMapparameters){
if(operationName==null||operationName.isEmpty()){//nooperationrequested,weletinvokerhandlethisathrowthecorrespondent//exceptionreturnnull;
switch(operationName.toUpperCase()){case"DESCRIBEDOMAINS":returnnewSimpleConveyor(Operation.DESCRIBE_DOMAINS,request,response,storageBroker,parameters);case"GETHISTOGRAM":returnnewSimpleConveyor(Operation.GET_HISTOGRAM,request,response,storageBroker,parameters);case"GETFEATURE":returnnewSimpleConveyor(Operation.GET_FEATURE,request,response,storageBroker,parameters);default://operationnotsupportedreturnnull;
if(filters!=null){for(Filterf:filters){f.destroy();
if(filter<filters.size()){filters.get(filter++).doFilter(request,response,this);
else{//resumetheactualchaindelegate.doFilter(request,response);
if(s!=null){nonNullCopies.add(s);
if(nonNullCopies.size()==0){pages.pop();pages.push(null);
else{copy.symbolizers().clear();copy.symbolizers().addAll(nonNullCopies);
if(r!=null){nonNullCopies.add(r);
if(nonNullCopies.size()==0){pages.pop();pages.push(null);
else{copy.rules().clear();copy.rules().addAll(nonNullCopies);
if(ft!=null){nonNullCopies.add(ft);
if(nonNullCopies.size()==0){pages.pop();pages.push(null);
else{copy.featureTypeStyles().clear();copy.featureTypeStyles().addAll(nonNullCopies);
if(!dynamic){pages.pop();pages.push(null);
if(!dynamic){pages.pop();pages.push(null);
if(!dynamic){pages.pop();pages.push(null);
if(!dynamic){dynamic=!(sizeExpression!=null&&(sizeExpressioninstanceofLiteral||sizeExpressioninstanceofNilExpression))||hasDynamicGraphic(gr);
ifithasdynamicgraphicsinsidefor(GraphicalSymbolgs:gr.graphicalSymbols()){
if(gsinstanceofExternalGraphic){ExternalGraphiceg=(ExternalGraphic)gs;try{Iconicon=null;
if(eg.getInlineContent()!=null){icon=eg.getInlineContent();
else{Stringlocation=eg.getLocation().toExternalForm();//expandembeddedcqlexpressionExpressionexpanded=ExpressionExtractor.extractCqlExpressions(location);//
ifnotaliteralthereisanattributedependency
if(!(expandedinstanceofLiteral)){returntrue;
iffound,
ifnotSLDasksustogotothenextone//andthusweshouldignorethisone
if(icon!=null){break;
if(!(stroke.getWidth()instanceofLiteral)){dynamic=true;
if(wfs3.equals(service)&&"GetCapabilities".equals(request.getRequest())){request.setServiceDescriptor(fallback);returnfallback;
if(wfs3.equals(request.getServiceDescriptor())){Stringheader=request.getHttpRequest().getHeader(HttpHeaders.ACCEPT);ObjectparsedRequest=operation.getParameters()[0];MethodformatSetter=OwsUtils.setter(parsedRequest.getClass(),"outputFormat",String.class);MethodformatGetter=OwsUtils.getter(parsedRequest.getClass(),"outputFormat",String.class);try{//canwemanipulatetheformat,andit'snotalreadyset?
if(formatGetter!=null&&formatSetter!=null&&formatGetter.invoke(parsedRequest)==null){
if(header!=null){//figureoutwhichformatwewanttouse,takethefistsupportedoneLinkedHashSet<String>acceptedFormats=newLinkedHashSet<>(Arrays.asList(header.split("\\s*,\\s*")));List<String>availableFormats=DefaultWebFeatureService30.getAvailableFormats(result.getClass());acceptedFormats.retainAll(availableFormats);
if(!acceptedFormats.isEmpty()){Stringformat=acceptedFormats.iterator().next();setOutputFormat(request,parsedRequest,formatSetter,format);
else{//handledefaults
ifreallynothingisspecifiedStringdefaultType="getFeature".equals(request.getRequest())?RFCGeoJSONFeaturesResponse.MIME:BaseRequest.JSON_MIME;setOutputFormat(request,parsedRequest,formatSetter,defaultType);
if(value==null){value=supplier.get();
if(this.types==null){types=Collections.EMPTY_LIST;
if(this.ns==null){//nssettonull,
ifallgiventypesarefromthesamenamespace,usthatone
if(!types.isEmpty()){Iterator<FeatureTypeInfo>i=types.iterator();NamespaceInfonamespace=i.next().getNamespace();while(i.hasNext()){FeatureTypeInfotype=i.next();
if(!namespace.equals(type.getNamespace())){namespace=null;break;
if(namespace!=null){this.ns=namespace;
if(ns!=null){returnns.getURI();
if(types.isEmpty()){schemaLocation=ResponseUtils.appendQueryString(schemaLocation,"namespace="+ns.getURI());
else{StringBuffersb=newStringBuffer("typeName=");for(FeatureTypeInfotype:types){sb.append(type.getPrefixedName()).append(",");
if(ns==null){//theremustbetypesfromdifferentnamespacesincluded,buildaschema//withimports
if(types.isEmpty()){//buildforallnamespacesbuildSchemaImports(catalog.getNamespaces(),schema,factory);
else{Set<NamespaceInfo>namespaces=newHashSet<NamespaceInfo>();for(FeatureTypeInfotype:types){namespaces.add(type.getNamespace());
else{schema.setTargetNamespace(ns.getURI());schema.getQNamePrefixToNamespaceMap().put(ns.getPrefix(),ns.getURI());schema.getQNamePrefixToNamespaceMap().put("wfs",WFS.NAMESPACE);schema.getQNamePrefixToNamespaceMap().put("gml",GML.NAMESPACE);//importwfsschemasynchronized(Schemas.class){Schemas.importSchema(schema,wfs.getSchema());
if(featureTypes==null||featureTypes.isEmpty()){//graballfromcatalogfeatureTypes=catalog.getFeatureTypesByNamespace(ns);
iftheschemaforthetypeisalreadydefinedStringprefix=featureTypeInfo.getNamespace().getPrefix();Stringstore=featureTypeInfo.getStore().getName();Stringname=featureTypeInfo.getName();ResourceschemaFile=catalog.getResourceLoader().get("workspaces"+"/"+prefix+"/"+store+"/"+name+"/schema.xsd");
if(schemaFile.getType()==Type.RESOURCE){//schemafilefound,parseitandlookupthecomplextypeListlocators=newArrayList();for(XSDxsd:wfs.getAllDependencies()){locators.add(xsd.createSchemaLocator());
if(ftSchema!=null){//addthecontentsofthisschematotheschemabeingbuilt//lookupthecomplextypeListcontents=ftSchema.getContents();for(Iteratori=contents.iterator();i.hasNext();){XSDSchemaContentcontent=(XSDSchemaContent)i.next();content.setElement(null);
if(filterAttributeType(attribute)){continue;
if(typeName==null){thrownewNullPointerException("Couldnotfindatypeforproperty:"+attribute.getName()+"oftype:"+binding.getName());
if(type==null){thrownewIllegalStateException("Couldnotfindtype:"+typeName);
if(requestedSchema==null){requestedSchema=CSW.NAMESPACE;
if(requestinstanceofGetRecordByIdType){GetRecordByIdTypegr=(GetRecordByIdType)request;returngr.getOutputSchema();
else
if(requestinstanceofGetRecordsType){GetRecordsTypegr=(GetRecordsType)request;returngr.getOutputSchema();
else{thrownewIllegalArgumentException("Unsupportedrequestobjecttype:"+request);
if(result.getRecords()!=null){FeatureTyperecordSchema=result.getRecords().getSchema();
if(recordSchema!=null&&!recordType.equals(recordSchema)){thrownewIllegalArgumentException("Cannotencodethiskindofrecord"+recordSchema.getName()+"intoschema"+schema);
if(getResultType(request)==ResultType.VALIDATE){//thisoneisoutputschemaindependenttransformAcknowledgement(output,request,csw);
else{transformResponse(output,result,request,csw);
if(requestinstanceofGetRecordsType){return((GetRecordsType)request).getResultType();
else{returnResultType.RESULTS;
if(!parser.getValidationErrors().isEmpty()){WPSExceptionexception=newWPSException("Invalidrequest","InvalidParameterValue");for(Exceptionerror:(List<Exception>)parser.getValidationErrors()){LOGGER.warning(error.getLocalizedMessage());exception.getExceptionText().add(error.getLocalizedMessage());
if(styleInfo!=null){Stringstyle=styleInfo.prefixedName();url+=style;urlModel.setObject(url);
if(target!=null){target.add(image);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;JAIInfoImplother=(JAIInfoImpl)obj;
if(allowInterpolation!=other.allowInterpolation)returnfalse;
if(allowNativeMosaic!=other.allowNativeMosaic)returnfalse;
if(allowNativeWarp!=other.allowNativeWarp)returnfalse;
if(imageIOCache!=other.imageIOCache)returnfalse;
if(jpegAcceleration!=other.jpegAcceleration)returnfalse;
if(Double.doubleToLongBits(memoryCapacity)!=Double.doubleToLongBits(other.memoryCapacity))returnfalse;
if(Double.doubleToLongBits(memoryThreshold)!=Double.doubleToLongBits(other.memoryThreshold))returnfalse;
if(pngAcceleration!=other.pngAcceleration)returnfalse;
if(recycling!=other.recycling)returnfalse;
if(tilePriority!=other.tilePriority)returnfalse;
if(tileThreads!=other.tileThreads)returnfalse;
if(getPngEncoderType()!=other.getPngEncoderType())returnfalse;returntrue;
if(pngEncoderType==null){returnPngEncoderType.PNGJ;
else{returnpngEncoderType;
if(jaiext==null){jaiext=newJAIEXTInfoImpl();
if(!isNew()&&!skipSecuritySettings){/**BACKUPSecurityResources*/finalStringoutputFolderURL=jobExecution.getJobParameters().getString(Backup.PARAM_OUTPUT_FILE_PATH);finalResourcetargetBackupFolder=Resources.fromURL(outputFolderURL);finalResourcesecurityTargetResource=BackupUtils.dir(targetBackupFolder,SECURITY_RESOURCE_NAME);//CopytheSecurityfilesintothedestinationresourcetry{Resources.copy(security,securityTargetResource);
if(testGssm!=null){try{testGssm.destroy();
else
if(!skipSecuritySettings){/**RESTORESecurityResources*//***CreateanewGeoServerSecurityManagerinstanceusingtheINPUTDATADIR.**<p>Trytoloadtheconfigurationfromthereand
ifeverythingisok:1.Replacethe*securityfolders2.DestroyandreloadtheappContextGeoServerSecurityManager3.*IssueSecurityManagerListenerextensionshandlePostChanged(...)*/finalStringinputFolderURL=jobExecution.getJobParameters().getString(Backup.PARAM_INPUT_FILE_PATH);finalResourcesourceRestoreFolder=Resources.fromURL(inputFolderURL);finalResourcesourceSecurityResource=BackupUtils.dir(sourceRestoreFolder,SECURITY_RESOURCE_NAME);//TestthatthesecurityfolderhasbeencorrectlysavedGeoServerSecurityManagertestGssm=null;try{testGssm=newGeoServerSecurityManager(newGeoServerDataDirectory(newGeoServerResourceLoader(sourceRestoreFolder.dir())));testGssm.setApplicationContext(Backup.getContext());testGssm.reload();//TODO:Performmorevalidationtestshereusing"testGssm"//TODO:SavedetailedwarningsandvalidationissuesontheJobContext
if(testGssm!=null){try{testGssm.destroy();
if(Resources.exists(security)&&!security.delete()){//Trytorestoretheoriginalonetry{Resources.copy(tmpDir,security);
if(!isDryRun()){try{Resources.copy(sourceSecurityResource,security);
else{//Trytorestoretheoriginalone
if(Resources.exists(security)&&!security.delete()){logValidationExceptions((ValidationResult)null,newUnexpectedJobExecutionException("ExceptionoccurredwhilestoringGeoServersecurityandservicessettings!",newIOException("Itwasnotpossibletocleanupthetargetsecurityfolder!")));
ifspecifiedforaspecificOWSuseoftheBoundingBoxType.Formoreinformation,seeSubclauses10.2.5andC.13.&lt;/documentation&gt;*&lt;documentation&gt;ThistypeisadaptedfromDirectPositionTypeanddoubleListofGML3.1.Theadaptationsincludeomissionofalltheattributes,sincetheneededinformationisincludedintheBoundingBoxType.&lt;/documentation&gt;*&lt;/annotation&gt;*&lt;listitemType="double"/&gt;*&lt;/simpleType&gt;**</code>*</pre>**@generated*/publicclassPositionTypeBindingextendsAbstractSimpleBinding{Ows10Factoryowsfactory;publicPositionTypeBinding(Ows10Factoryowsfactory){this.owsfactory=owsfactory;
if(mapcrs!=null){mapContent.getViewport().setBounds(newReferencedEnvelope(envelope,mapcrs));
else{mapContent.getViewport().setBounds(newReferencedEnvelope(envelope,DefaultGeographicCRS.WGS84));
iftheuserdidnotspecifyone**@paramrequest*@paramlayers*/privateList<Style>getStyles(finalGetFeatureInfoRequestrequest,List<MapLayerInfo>layers){List<Style>getMapStyles=request.getGetMapRequest().getStyles();List<Style>styles=newArrayList<Style>();List<MapLayerInfo>getMapLayers=request.getGetMapRequest().getLayers();for(inti=0;i<layers.size();i++){finalStringtargetLayer=layers.get(i).getName();Styles=null;for(intj=0;j<getMapLayers.size();j++){
if(getMapLayers.get(j).getName().equals(targetLayer)){
if(getMapStyles!=null&&getMapStyles.size()>j){s=getMapStyles.get(j);
else{s=getMapLayers.get(j).getDefaultStyle();
if(s!=null){styles.add(s);
else{thrownewServiceException("Failedtolocatestyleforlayer"+targetLayer);
if(filters==null||filters.size()<=currentLayer){returnnull;
else{returnfilters.get(currentLayer);
if(sorts==null||sorts.size()<=currentLayer){returnnull;
else{SortBy[]layerSort=sorts.get(currentLayer);finalMapLayerInfolayer=layers.get(currentLayer);
if(layer.getType()==MapLayerInfo.TYPE_VECTOR||layer.getType()==MapLayerInfo.TYPE_REMOTE_VECTOR){//forvisualconsistency,wemustreturntheinformationthatisontopofthe//mapfirst,togetthiswejustneedtoinvertthesort(thecodereturnsthe//featuresitencountersfirst,untilFEATURE_COUNTisreached).//Failingtodosowillresultintheuserseeingonefeaturebutgetting//information//onthosebelowit(giventhesorthasbeenspecified,itshouldbeconsidered//asparticularlyimportantfortheuser,unlikeanormalinforequestinwhich//performanceandbackwardscompatibilityarefavored).SortBy[]result=newSortBy[layerSort.length];for(inti=0;i<layerSort.length;i++){SortBysb=layerSort[i];SortOrderorder=sb.getSortOrder();SortByreverse=FF.sort(sb.getPropertyName().getPropertyName(),order==SortOrder.ASCENDING||order==null?SortOrder.DESCENDING:SortOrder.ASCENDING);result[i]=reverse;
else{//forrastersnoneedtoinvertreturnlayerSort;
if(propertyNames==null||propertyNames.size()==0||propertyNames.get(currentLayer)==null){returnQuery.ALL_NAMES;
else{List<String>layerPropNames=propertyNames.get(currentLayer);returnlayerPropNames.toArray(newString[layerPropNames.size()]);
if(viewParams==null||viewParams.size()<currentLayer){returnnull;
else{returnviewParams.get(currentLayer);
if(image==null){return;
if(list==null){list=newArrayList<RenderedImage>();images.set(list);
if(coverage==null){return;
if(list==null){list=newArrayList<GridCoverage2D>();coverages.set(list);
if(list!=null){images.remove();for(RenderedImageimage:list){
if(imageinstanceofRenderedImageList){RenderedImageListril=(RenderedImageList)image;for(inti=0;i<ril.size();i++){disposeImage((RenderedImage)ril.get(i));
else{disposeImage(image);
if(imageinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)image);
else
if(imageinstanceofBufferedImage){BufferedImagebi=(BufferedImage)image;bi.flush();
if(list!=null){coverages.remove();for(GridCoverage2Dcoverage:list){coverage.dispose(true);
if(listener.isCanceled()){thrownewProcessDismissedException(listener);
if(parsed){return;
if(providerLongSteps>0){subListener=newSubProgressListener(listener,(stepsSoFar/totalSteps)*100,(providerLongSteps/totalSteps)*100);
else{subListener=newNullProgressListener();
if(einstanceofWPSException){throw(WPSException)e;
if(request==null||!"GetCapabilities".equalsIgnoreCase(request.getRequest())){return;
if(request.getHttpRequest()instanceofRequestWrapper){RequestWrapperrequestWrapper=(RequestWrapper)request.getHttpRequest();Mapparameters=requestWrapper.getOriginalParameters();requestRawKvp=newKvpMap(KvpUtils.normalize(parameters));
if(request.getHttpRequest()instanceofRequestWrapper){requestUri=((RequestWrapper)request.getHttpRequest()).getOriginalRequestURI();
if(!matcher.matches()){return;
if(!echoParameter.getActivated()){continue;
if(rawParameter!=null&&Utils.caseInsensitiveSearch(echoParameter.getParameter(),kvp)==null){
if(rawParameter.getValue()instanceofString){kvp.put((String)rawParameter.getKey(),(String)rawParameter.getValue());
ifhandlerisnotfound
if(handler==null){thrownewIllegalArgumentException("Unabletolocateavalidhandlerfortheincomingevent:"+event);
elsetrytosynchronizeeventusingtheobtainedhandlerhandler.synchronize(event);
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.severe("Unabletosynchronizeevent:"+event+"locally");
if(c!=null){return(RegionatingStrategy)c.newInstance(gs);
if(myStrategyClass!=null)returnmyStrategyClass;try{myStrategyClass=Class.forName(myClassName);
if(statusObj==null){statusObj=ReadOnlyConfiguration.DEFAULT_READ_ONLY_VALUE;
if(workspaceName==null){returncatalog.getDefaultWorkspace();
else{returncatalog.getWorkspaceByName(workspaceName);
if(wi==null){//lackofdefaultworkspace(allow)versusincorrectworkspace(deny//unlessadmin)returnconfig.getWorkspace()==null||secManager.checkAuthenticationForAdminRole(user);
else{WorkspaceAccessLimitslimits=secureCatalog.getResourceAccessManager().getAccessLimits(user,wi);returnlimits==null||limits.isReadable();
if(batch.getConfiguration()!=null){wif=getWorkspace(batch.getConfiguration().getWorkspace());
if(batch.getWorkspace()!=null){//otherwiseignorethis,don'tusedefaultwswi=getWorkspace(batch.getWorkspace());
else{wi=getWorkspace(batch.getWorkspace());
if(wi!=null){WorkspaceAccessLimitslimits=secureCatalog.getResourceAccessManager().getAccessLimits(user,wi);check1=limits==null||limits.isReadable();
else{//lackofdefaultworkspace(allow)versusincorrectworkspace(denyunlessadmin)check1=batch.getWorkspace()==null||secManager.checkAuthenticationForAdminRole(user);
if(wif!=null){WorkspaceAccessLimitslimits=secureCatalog.getResourceAccessManager().getAccessLimits(user,wif);check2=limits==null||limits.isReadable();
else{//lackofdefaultworkspace(allow)versusincorrectworkspace(denyunlessadmin)check2=batch.getConfiguration()==null||batch.getConfiguration().getWorkspace()==null||secManager.checkAuthenticationForAdminRole(user);;
if(wi==null){//lackofdefaultworkspace(allow)versusincorrectworkspace(deny//unlessadmin)returnconfig.getWorkspace()==null||secManager.checkAuthenticationForAdminRole(user);
else{WorkspaceAccessLimitslimits=secureCatalog.getResourceAccessManager().getAccessLimits(user,wi);returnlimits==null||limits.isWritable();
if(batch.getConfiguration()!=null){wif=getWorkspace(batch.getConfiguration().getWorkspace());
if(batch.getWorkspace()!=null){//otherwiseignorethis,don'tusedefaultwswi=getWorkspace(batch.getWorkspace());
else{wi=getWorkspace(batch.getWorkspace());
if(wi!=null){WorkspaceAccessLimitslimits=secureCatalog.getResourceAccessManager().getAccessLimits(user,wi);check1=limits==null||limits.isWritable();
else{//lackofdefaultworkspace(allow)versusincorrectworkspace(denyunlessadmin)check1=batch.getWorkspace()==null||secManager.checkAuthenticationForAdminRole(user);
if(wif!=null){WorkspaceAccessLimitslimits=secureCatalog.getResourceAccessManager().getAccessLimits(user,wif);check2=limits==null||limits.isWritable();
else{//lackofdefaultworkspace(allow)versusincorrectworkspace(denyunlessadmin)check2=batch.getConfiguration()==null||batch.getConfiguration().getWorkspace()==null||secManager.checkAuthenticationForAdminRole(user);
if(wi==null){//lackofdefaultworkspace(allow)versusincorrectworkspace(deny//unlessadmin)returnconfig.getWorkspace()==null||secManager.checkAuthenticationForAdminRole(user);
else{WorkspaceAccessLimitslimits=secureCatalog.getResourceAccessManager().getAccessLimits(user,wi);returnlimits==null||limits.isAdminable();
if(batch.getConfiguration()!=null){//otherwiseignorethis,don'tusedefaultwswif=getWorkspace(batch.getConfiguration().getWorkspace());
if(batch.getWorkspace()!=null){wi=getWorkspace(batch.getWorkspace());
else{wi=getWorkspace(batch.getWorkspace());
if(wi!=null){WorkspaceAccessLimitslimits=secureCatalog.getResourceAccessManager().getAccessLimits(user,wi);check1=limits==null||limits.isAdminable();
else{//lackofdefaultworkspace(allow)versusincorrectworkspace(denyunlessadmin)check1=batch.getWorkspace()==null||secManager.checkAuthenticationForAdminRole(user);
if(wif!=null){WorkspaceAccessLimitslimits=secureCatalog.getResourceAccessManager().getAccessLimits(user,wif);check2=limits==null||limits.isAdminable();
else{//lackofdefaultworkspace(allow)versusincorrectworkspace(denyunlessadmin)check2=batch.getConfiguration()==null||batch.getConfiguration().getWorkspace()==null||secManager.checkAuthenticationForAdminRole(user);
if(old!=null){LOGGER.warning("Replacingexceptioncode"+old+"with"+this);
if(httpMessage!=null){builder.append("httpMessage=").append(httpMessage);
if(httpCode==null){returnmsg;
else{returnmsg+NEW_LINE+"HTTPcode:"+httpCode;
if(data!=null){IOUtils.delete(data);
ifitfails,lookinto//web.xmljusttokeepcompatibility(shouldberemovednextversion)//andfinally,
ifnothingisfound,giveupandreturnthedefaultbaseURLStringurl=((geoserver!=null)?geoserver.getSettings().getProxyBaseUrl():null);//
if((geoserver!=null)&&(url!=null)){//url=appendContextPath(url,httpServletRequest.getContextPath());//
if((url==null)||(url.trim().length()==0)){
if(httpServletRequest!=null){url=httpServletRequest.getSession().getServletContext().getInitParameter(PROXY_PARAM);
if((url==null)||(url.trim().length()==0)){url=httpServletRequest.getScheme()+"://"+httpServletRequest.getServerName()+":"+httpServletRequest.getServerPort()+httpServletRequest.getContextPath()+"/";
else{url=appendContextPath(url,httpServletRequest.getContextPath());
if(!url.endsWith("/")){url=url+"/";
ifitfails,lookinto//web.xmljusttokeepcompatibility(shouldberemovednextversion)//andfinally,
ifnothingisfound,giveupandreturnthedefaultbaseURLStringurl=geoserver.getSettings().getProxyBaseUrl();
if((geoserver!=null)&&(url!=null)){url=appendContextPath(url,httpServletRequest.getRequestURI());
if((url==null)||(url.trim().length()==0)){
if(httpServletRequest!=null){url=httpServletRequest.getSession().getServletContext().getInitParameter(PROXY_PARAM);
if((url==null)||(url.trim().length()==0)){url=httpServletRequest.getScheme()+"://"+httpServletRequest.getServerName()+":"+httpServletRequest.getServerPort()+httpServletRequest.getRequestURI()+"/";
else{url=appendContextPath(url,httpServletRequest.getRequestURI());
if(url.endsWith("/")){url=url.substring(0,url.length()-1);
if(url.endsWith("/")){url=url.substring(0,url.length()-1);
if(contextPath.startsWith("/")){contextPath=contextPath.substring(1);
iftheappendedquerystringrequiresa'?'or*'&'tobeprepended.**@paramurlThebaseurl.*@paramqueryStringThequerystringtobeappended,shouldnotcontainthe'?'character.*@returnAfullurlwiththequerystringappended.*/publicstaticStringappendQueryString(Stringurl,StringqueryString){
if(url.endsWith("?")||url.endsWith("&")){returnurl+queryString;
if(url.indexOf('?')!=-1){returnurl+"&"+queryString;
ifUserContainerexistshasbeencreated.**@paramrequestHttpServletRequestprovidingcurrentSession*/publicstaticbooleanisLoggedIn(HttpServletRequestrequest){//checktheuserisnottheanonymousoneAuthenticationauthentication=SecurityContextHolder.getContext().getAuthentication();return(authentication!=null)&&!(authenticationinstanceofAnonymousAuthenticationToken);
iftheresponseisencodedingzip,deflateorplainbytes.Thecorrectinput*streamwrapperisthenselectedandreturned.**<p>ThismethodwasaddedaspartofGEOS-420**@paramurlTheurltothesldfile*@returnTheInputStreamusedtovalidateandparsetheSLDxml.*@throwsIOException*/publicstaticInputStreamgetInputStream(URLurl)throwsIOException{//OpentheconnectionURLConnectionconn=url.openConnection();//Ifitisthehttporhttpsscheme,thenaskforgzip
iftheserversupportsit.
if(conninstanceofHttpURLConnection){//Sendtherequestedencodingtotheremoteserver.conn.setRequestProperty("Accept-Encoding","gzip,deflate");
if(conninstanceofHttpURLConnection){//GetthecontentencodingoftheserverresponseStringencoding=conn.getContentEncoding();//Ifnull,setittoaemtpystring
if(encoding==null){encoding="";
if(encoding.equalsIgnoreCase("gzip")){//Forgzipinputstream,useaGZIPInputStreamreturnnewGZIPInputStream(conn.getInputStream());
else
if(encoding.equalsIgnoreCase("deflate")){//Ifitisencodedasdeflate,thenselecttheinflaterinputstream.returnnewInflaterInputStream(conn.getInputStream(),newInflater(true));
else{//Elsereadtherawbytesreturnconn.getInputStream();
else{//Elsereadtherawbytes.returnconn.getInputStream();
if(rawOptionString==null){returnmap;
if(cloc<=0){thrownewIllegalArgumentException("Key-value-pair:'"+curKVP+"'isn'tproperlyformed.Itmustbeoftheform'Key:Value1,Value2...'");
if(values.indexOf(",")!=-1){ListvalueList=newArrayList();StringTokenizercommaSplitter=newStringTokenizer(values,",");while(commaSplitter.hasMoreElements())valueList.add(commaSplitter.nextToken());map.put(key,valueList);
else{map.put(key,values);
ifthere'sonedeclaredforthegivenstoretype,or*adefaultoneotherwise*/publicstaticStoreEditPanelgetStoreEditPanel(finalStringcomponentId,finalFormeditForm,finalStoreInfostoreInfo,finalGeoServerApplicationapp){
if(storeInfo==null){thrownewNullPointerException("storeInfoparam");
if(app==null){thrownewNullPointerException("GeoServerApplicationparam");
if(panelInfo==null||panelInfo.getComponentClass()==null){//there'seithernopanelinfospecificforthiskindofstore,oritprovidesno//componentclasspanelInfo=getDefaultPanelInfo(storeInfo,app);
if(storeInfoinstanceofDataStoreInfo&&"defaultVector".equals(provider.getId())){panelInfo=provider;break;
else
if(storeInfoinstanceofCoverageStoreInfo&&"defaultRaster".equals(provider.getId())){panelInfo=provider;break;
if(panelInfo==null){
if(storeInfoinstanceofDataStoreInfo){thrownewIllegalStateException("BeanoftypeDataStorePanelInfonamed"+"'defaultDataStorePanel'notprovidedbyapplicationcontext");
else
if(storeInfoinstanceofCoverageStoreInfo){thrownewIllegalStateException("BeanoftypeDataStorePanelInfonamed"+"'defaultCoverageStorePanel'notprovidedbyapplicationcontext");
else{thrownewIllegalArgumentException("Unknownstoretype:"+storeInfo.getClass().getName());
if(panelInfo.getComponentClass()==null){thrownewIllegalStateException("DefaultDataStorePanelInfo'"+panelInfo.getId()+"'doesnotdefineacomponentClassproperty");
if(panelInfo.getIconBase()==null||panelInfo.getIcon()==null){thrownewIllegalStateException("DefaultDataStorePanelInfo'"+panelInfo.getId()+"'doesnotdefinedefaulticon");
ifthere'sno*contributionspecificforthegivenstoreInfo'stype*/privatestaticDataStorePanelInfofindPanelInfo(finalStoreInfostoreInfo,finalGeoServerApplicationapp){finalCatalogcatalog=storeInfo.getCatalog();finalResourcePoolresourcePool=catalog.getResourcePool();Class<?>factoryClass=null;
if(storeInfoinstanceofDataStoreInfo){DataAccessFactorystoreFactory;try{storeFactory=resourcePool.getDataStoreFactory((DataStoreInfo)storeInfo);
if(storeFactory!=null){factoryClass=storeFactory.getClass();
else
if(storeInfoinstanceofCoverageStoreInfo){AbstractGridFormatgridFormat;gridFormat=resourcePool.getGridCoverageFormat((CoverageStoreInfo)storeInfo);
if(gridFormat!=null){factoryClass=gridFormat.getClass();
else{thrownewIllegalArgumentException("Unknownstoretype:"+storeInfo.getClass().getName());
if(factoryClass==null){thrownewIllegalArgumentException("Can'tlocatethefactoryforthestore");
if(providerFactoryClass==null){continue;
if(factoryClass.equals(providerFactoryClass)){returnprovider;
else
if(providerFactoryClass.isAssignableFrom(factoryClass)){fallbacks.add(provider);
if(fallbacks.size()==1){returnfallbacks.get(0);
else
if(fallbacks.size()>1){//sortbyclasshierarchy,picktheclosestmatchCollections.sort(fallbacks,newComparator<DataStorePanelInfo>(){publicintcompare(DataStorePanelInfoo1,DataStorePanelInfoo2){Class<?>c1=o1.getFactoryClass();Class<?>c2=o2.getFactoryClass();
if(c1.equals(c2)){return0;
if(c1.isAssignableFrom(c2)){return1;
if(c2.isAssignableFrom(c1)){;
if(f1.getFactoryClass().equals(f2.getFactoryClass())){Stringmsg="Multipleeditorpanelsfor:("+f1.getFactoryClass()+"):"+f1+","+f2;thrownewRuntimeException(msg);
if(validators==null||validators.isEmpty()){returndelegate;
if(v.supports(value.getClass())){v.validate(value,errors);
if(errors.hasErrors()){thrownewValidationException(errors,getInputId());
ifthereaderisastructuredgridcoverageonesetVisible(isStructuredCoverage(model));//addthecheckboxtoenableexposingalayerasadatasetMapModeldatasetModel=newMapModel(newPropertyModel<MetadataMap>(model,"resource.metadata"),WCSEOMetadata.DATASET.key);CheckBoxdataset=newCheckBox("dataset",datasetModel);add(dataset);
ifit'sWCSEODatasetworthy",e);
ifany;otherwise,loadsinternaldefaults.*/publicvoidloadConfiguration(){//startwiththedefaultconfiguration,override
ifwecanloadthefileToolConfigurationconfiguration=getDefaultConfiguration();try{
if(configFile.getType()==Type.RESOURCE){InputStreamin=configFile.in();try{XStreamxstream=buildXStream();configuration=(ToolConfiguration)xstream.fromXML(in);
if(configuration==null){LOGGER.log(Level.INFO,"Couldnotfind/loadthe"+getConfigurationFile()+"configurationfile,usinginternaldefaults");configuration=getDefaultConfiguration();
if(configuration==null){thrownewIllegalStateException("Nodefaultconfigurationavailable,givingup");
if(supported.contains(format.getToolFormat())){toBeAdded.add(format);
else{LOGGER.severe("Skipping'"+format.getGeoserverFormat()+"'asitstoolformat'"+format.getToolFormat()+"'isnotamongtheonessupportedby"+configuration.getExecutable());
if(configFile!=null){configFile.removeListener(listener);
if(size>0&&size>maxSizeMB*MB){errors.reject(CODE,getErrorMessage(size));
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;MaxSizeValidatorother=(MaxSizeValidator)obj;
if(maxSizeMB!=other.maxSizeMB)returnfalse;returntrue;
if(iteminstanceofResource){Resourceres=(Resource)item;returnres.getType()==Type.RESOURCE;
if(namePropertyName==null){thrownewRuntimeException("Nonamepropertynamewasprovided.");
if(timePropertyName==null){thrownewRuntimeException("Notimepropertynamewasprovided.");
if(FEATURE_CACHE_LIMIT>0&&features.getSchema()instanceofSimpleFeatureType){returnnewFeatureSizeFeatureCollection((SimpleFeatureCollection)features,DataUtilities.simple(source),gtQuery);
else{returnfeatures;
if(featureCache!=null){returnnewCachedWrappingFeatureIterator(featureCache);
if(featureCache!=null){returnfeatureCache.size();
if(FEATURE_CACHE_LIMIT>0){try{//tryoptimizedmethod,willreturn-1
ifthereisnofastwaytocomputeintcount=featureSource.getCount(query);//zeroisalegitvalue,cacheandexit
if(count==0){featureCache=newArrayList<>();returncount;
if(count>0){returncount;
if(tempFeatureCache.size()<FEATURE_CACHE_LIMIT){tempFeatureCache.add(feature);
ifthecountisbelowlimit,keepthecache,otherwiseclearit
if(count<=FEATURE_CACHE_LIMIT){featureCache=tempFeatureCache;
else{tempFeatureCache.clear();
ifan*incomingrequestspecicfiesmatchingvaluesoftheproperties.**<p>Thefollowingbeandeclarationwouldcreatetheabovekvpparsersothatitonlyengageswhen*theserviceis"MyService",andtherequestis"MyRequest".**<pre>*<code>*&lt;beanid="myKvpParser"class="org.xzy.MyKvpParser"&gt;*&lt;propertyname="service"&gt;MyService&lt;/property&gt;*&lt;propertyname="request"&gt;MyRequest&lt;/property&gt;*&lt;bean&gt;*</code>*</pre>**@authorJustinDeoliveira,TheOpenPlanningProject,jdeolive@openplans.org*/publicabstractclassKvpParser{/**logger*/protectedstaticLoggerLOGGER=org.geotools.util.logging.Logging.getLogger("org.geoserver.ows");/**Thekey.*/Stringkey;/**Theclassofparsedobjects.*/Classbinding;/**Theservicetobindto*/Stringservice;/**Theversionoftheservicetobindto*/Versionversion;/**Therequesttobindto*/Stringrequest;publicKvpParser(Stringkey,Classbinding){this.key=key;this.binding=binding;
ifitcouldnotbeparsed.*@throwsExceptionIntheeventofanunsuccesfulparse.*/publicabstractObjectparse(Stringvalue)throwsException;}
if(configurationinstanceofGMLConfiguration){GMLConfigurationgml=(GMLConfiguration)configuration;gml.setGeometryFactory(gf);
if(request.getAcceptVersions()!=null)accepted=request.getAcceptVersions().getVersion();Stringversion=RequestUtils.getVersionOws11(provided,accepted);
if(!"1.0.0".equals(version)){thrownewWPSException("Couldnotunderstandversion:"+version);
ifWPSconfigisloaded
if(wps==null){thrownewServiceException("WPSconfignotloaded.Checklogsfordetails.");
if(kw!=null){si.getKeywords().add(kw);
if(wps.getAccessConstraints()!=null){si.getAccessConstraints().add(wps.getAccessConstraints());
if(settings.getContact().getContactOrganization()!=null){sp.setProviderName(settings.getContact().getContactOrganization());
else{sp.setProviderName("GeoServer");
ifbeingimplemented.
if(host==null){try{InetAddressaddr=InetAddress.getByName(data.getRemoteAddr());host=addr.getHostName();
if(requestinstanceofGetCapabilitiesType){returnnewWFS11((EObject)request);
else
if(requestinstanceofnet.opengis.wfs20.GetCapabilitiesType){returnnewWFS20((EObject)request);
if(request==null){thrownewIllegalArgumentException("requestmustbenotnull");
if(geoServer.getSettings().isVerboseExceptions()){ByteArrayOutputStreamstackTrace=newByteArrayOutputStream();e.printStackTrace(newPrintStream(stackTrace));sb.append("\nDetails:\n");sb.append(ResponseUtils.encodeXML(newString(stackTrace.toByteArray())));
if(fts.rules().isEmpty()){it.remove();
if(rule.symbolizers().isEmpty()){it.remove();
if(copy.getTransformation()instanceofFunction){transformations=true;Functionf=(Function)fts.getTransformation();ClassreturnType=getFunctionReturnType(f);
if(Object.class.equals(returnType)||FeatureCollection.class.isAssignableFrom(returnType)){vectorTransformations=true;super.visit(fts);
else{//shaveoffcopy.rules().clear();
if(composite!=null&&BlendingMode.lookupByName(composite)!=null){options.remove(FeatureTypeStyle.COMPOSITE);options.remove(FeatureTypeStyle.COMPOSITE_BASE);
if(symbolizer==null){it.remove();
ifitcouldnotbedetermined**@paramf*/ClassgetFunctionReturnType(Functionf){FunctionNamename=f.getFunctionName();
if(name==null||name.getReturn()==null){returnObject.class;
if(gsinstanceofMark){MarkmarkCopy=copy((Mark)gs);symbolsCopy.add(markCopy);
else
if(gsinstanceofExternalGraphic){
if(gr.getSize()!=null&&!Expression.NIL.equals(gr.getSize())){Markmark=sf.createMark(ff.literal("square"),null,sf.createFill(colorFunction),sizeCopy,Expression.NIL);symbolsCopy.add(mark);
else{//it'susingthedefaultsize,computeit
ifpossible(mightbeusingdynamic//symbolizers...)ExternalGraphiceg=(ExternalGraphic)gs;LiteralsizeExpression=estimateGraphicSize(eg);Markmark=sf.createMark(ff.literal("square"),null,sf.createFill(colorFunction),sizeExpression,Expression.NIL);symbolsCopy.add(mark);
if(STRICT){
if(!copy.equals(gr)){thrownewIllegalStateException("WasunabletoduplicateprovidedGraphic:"+gr);
if(styleinstanceofGraphicStyle2D){GraphicStyle2Dgs2d=(GraphicStyle2D)style;size=gs2d.getImage().getWidth();
else
if(styleinstanceofIconStyle2D){IconStyle2Dis2d=(IconStyle2D)style;size=is2d.getIcon().getIconWidth();
if(copy.getGraphicFill()!=null){copy.setGraphicFill(null);
if(copy.getGraphicFill()!=null){copy.setGraphicFill(null);
if(copy.getGraphicStroke()!=null){copy.setWidth(getSymbolsSize(copy.getGraphicStroke()));copy.setGraphicStroke(null);
if(copy.dashArray()!=null){copy.dashArray().clear();
if(size!=null&&!Expression.NIL.equals(size)){returnsize;
else{for(GraphicalSymbolgs:graphic.graphicalSymbols()){
if(gsinstanceofMark){returnff.literal(SLDStyleFactory.DEFAULT_MARK_SIZE);
else
if(gsinstanceofExternalGraphic){returnestimateGraphicSize((ExternalGraphic)gs);
if(previousWorkspace.equals(newWorkspace)){return;
if(existing!=null){sb.append(existing.getName()).append("");
if(sb.length()>0){Stringmessage="Thefollowingresourcesalreadyexistonthesamenamespace:"+sb.toString();validatable.error(newValidationError().setMessage(message));
if(property==null){returnnull;
else{Objectvalue=property.getValue();returnvalue;
ifthepropertyfileispresent
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Checkingpropertiesfile");
if(properties==null||!Resources.exists(properties)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Propertiesfilenotfound");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Copyingthedefaultpropertiesfileinsidethedatadirectory");
if(is!=null){IOUtils.copy(is,properties.out());
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,e.getMessage(),e);
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Propertiesfilefound");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Loadingconfiguration");
if(newConfiguration!=null){configuration=newConfiguration;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Newconfigurationloaded:\n"+configuration);
if(Resources.exists(file)&&Resources.canRead(file)){//loadcontentsPropertiesproperties=watcher.getProperties();//parsecontentsnewConfiguration=parseConfigurationValues(properties);
else{
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Unabletoreadconfgurationfilefordownloadservice:"+file.path()+"continuingwithdefaultconfiguration-->\n"+configuration);
if(LOGGER.isLoggable(Level.INFO)){LOGGER.log(Level.INFO,e.getLocalizedMessage(),e);
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Unabletoreadconfgurationfilefordownloadservice:"+file.path()+"continuingwithdefaultconfiguration-->\n"+configuration);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Parsingthepropertiesfile");
if(value!=null){//checkandassigntry{finallongparseLong=Long.parseLong(value);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(key+"parsedto"+parseLong);
if(parseLong>0){returnparseLong;
if(LOGGER.isLoggable(Level.INFO)){LOGGER.log(Level.INFO,e.getLocalizedMessage(),e);
if(value!=null){//checkandassigntry{finalintparseInt=Integer.parseInt(value);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(key+"parsedto"+parseInt);
if(parseInt>0){returnparseInt;
if(LOGGER.isLoggable(Level.INFO)){LOGGER.log(Level.INFO,e.getLocalizedMessage(),e);
if(watcher.isStale()){//reloadDownloadServiceConfigurationnewConfiguration=loadConfiguration();
if(newConfiguration!=null){synchronized(newConfiguration){configuration=newConfiguration;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Newconfigurationloaded:\n"+configuration);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,t.getLocalizedMessage(),t);
if(layerinstanceofSecuredWMSLayer){SecuredWMSLayersecured=(SecuredWMSLayer)layer;finalWrapperPolicypolicy=secured.getPolicy();//check
ifwecancascadeGetFeatureInfo
if(policy.getLimits()instanceofWMSAccessLimits){WMSAccessLimitslimits=(WMSAccessLimits)policy.getLimits();
if(!limits.isAllowFeatureInfo()){
if(policy.getResponse()==org.geoserver.security.Response.CHALLENGE){SecureCatalogImpl.unauthorizedAccess(layer.getName());
else{thrownewIllegalArgumentException("Layer"+layer.getName()+"isnotqueriable");
if(getMapinstanceofSecuredGetMapRequest){SecuredGetMapRequestsgm=(SecuredGetMapRequest)getMap;StringencodedFilter=sgm.buildCQLFilter();
if(encodedFilter!=null){delegate.setProperty("CQL_FILTER",encodedFilter);
if(ldapConfig.getUserDnPattern()==null&&ldapConfig.getUserFilter()==null){error("Neitheruserdnpatternoruserfilterspecified");return;
if(authentication==null||!authentication.isAuthenticated()){thrownewAuthenticationException("Cannotauthenticate"+username);
ifthescalehintmustbeinunitsperdiagonalofa*pixel*@returnCapabilitiesas{@linkDocument}*/privateDocumentfindCapabilities(BooleanscaleHintUnitsPerDiaPixel)throwsException{//settheScalehintunitsperdiagonalpixelsetting.WMSwms=getWMS();WMSInfoinfo=wms.getServiceInfo();MetadataMapmm=info.getMetadata();mm.put(WMS.SCALEHINT_MAPUNITS_PIXEL,scaleHintUnitsPerDiaPixel);info.getGeoServer().save(info);GetCapabilitiesTransformertr=newGetCapabilitiesTransformer(wms,BASE_URL,FORMATS,LEGEND_FORMAT,null);GetCapabilitiesRequestreq=newGetCapabilitiesRequest();req.setBaseUrl(BASE_URL);req.setVersion(WMS.VERSION_1_1_1.toString());Documentdom=WMSTestSupport.transform(req,tr);Elementroot=dom.getDocumentElement();Assert.assertEquals(WMS.VERSION_1_1_1.toString(),root.getAttribute("version"));returndom;
if(layerRequired.equalsIgnoreCase(nodeValue)){return(Element)e.getParentNode();//returnsthelayerelementassociatedtothe//requiredlayername.
if(charSet!=null){templateWriter=newBufferedWriter(newOutputStreamWriter(outputStream,charSet.name()));
else{templateWriter=newBufferedWriter(newOutputStreamWriter(outputStream,template.getEncoding()));
if(link.startsWith("/")){//absolute,encodefrom"root"returnpg.servletURI(link);
else{//encodeasrelativereturnpg.pageURI(link);
if(context.getTasks()!=null&&context.getTasks().size()>0){WorkspaceInfows=null;ImportTasktask=context.getTasks().get(0);
if(targetWorkspace!=null){LOGGER.fine("-[RemoteProcessClient-importLayer]LookingforWorkspaceinthecatalog:"+targetWorkspace);ws=importer.getCatalog().getWorkspaceByName(targetWorkspace);
if(ws!=null){LOGGER.fine("-[RemoteProcessClient-importLayer]Workspacefound:"+ws);context.setTargetWorkspace(ws);
else{LOGGER.fine("-[RemoteProcessClient-importLayer]Workspace*NOT*found-usingtheDefaultone:"+importer.getCatalog().getDefaultWorkspace());context.setTargetWorkspace(importer.getCatalog().getDefaultWorkspace());
if(defaultStyle!=null){StyleInfostyle=importer.getCatalog().getStyleByName(defaultStyle);
if(style==null&&targetWorkspace!=null){style=importer.getCatalog().getStyleByName(targetWorkspace,defaultStyle);
if(style!=null){task.getLayer().setDefaultStyle(style);
if(name!=null){task.getLayer().setName(name);
if(title!=null){task.getLayer().setTitle(title);
if(description!=null){task.getLayer().setAbstract(description);
if(metadata!=null){task.getLayer().getMetadata().put("owc_properties",metadata);
if(ws!=null){task.getLayer().getResource().getStore().setWorkspace(ws);
if(task.getLayer().getResource()instanceofCoverageInfo){((CoverageInfoImpl)task.getLayer().getResource()).setNativeCoverageName(name);
if(context.getState()==ImportContext.State.COMPLETE){
if(context.getTasks()!=null&&context.getTasks().size()>0){//ImportTasktask=context.getTasks().get(0);//assertEquals(ImportTask.State.READY,task.getState());//assertEquals("thelayername",task.getLayer().getResource().getName());task=context.getTasks().get(0);//WARNING:TheImporterConfiguresJustTheFirstLayer
if(task.getLayer().getResource()instanceofCoverageInfo){CoverageInfoci=((CoverageInfo)task.getLayer().getResource());GridCoverageReaderreader=null;try{reader=ci.getGridCoverageReader(null,null);String[]cvNames=reader.getGridCoverageNames();
if(cvNames!=null&&cvNames.length>0){finalStringnativeCoverageName=cvNames[0];ci.setNativeCoverageName(nativeCoverageName);//if(type.equals("application/x-netcdf"))SetDimensions
if(readerinstanceofStructuredGridCoverage2DReader){StructuredGridCoverage2DReaderstructuredReader=((StructuredGridCoverage2DReader)reader);//GettingdimensiondescriptorsfinalList<DimensionDescriptor>dimensionDescriptors=structuredReader.getDimensionDescriptors(nativeCoverageName);DimensionDescriptortimeDimension=null;DimensionDescriptorelevationDimension=null;finalList<DimensionDescriptor>customDimensions=newArrayList<DimensionDescriptor>();//CollectdimensionDescriptorinfofor(DimensionDescriptordimensionDescriptor:dimensionDescriptors){
if(dimensionDescriptor.getName().equalsIgnoreCase(ResourceInfo.TIME)){timeDimension=dimensionDescriptor;
else
if(dimensionDescriptor.getName().equalsIgnoreCase(ResourceInfo.ELEVATION)){elevationDimension=dimensionDescriptor;
else{customDimensions.add(dimensionDescriptor);
if(defaultTimeNeeded){DimensionInfodi=newDimensionInfoImpl();di.setEnabled(true);di.setPresentation(DimensionPresentation.LIST);di.setAttribute(timeDimension.getStartAttribute());ci.getMetadata().put(ResourceInfo.TIME,di);
if(defaultElevationNeeded){DimensionInfodi=newDimensionInfoImpl();di.setEnabled(true);di.setPresentation(DimensionPresentation.LIST);di.setUnits("EPSG:5030");di.setUnitSymbol("m");di.setAttribute(elevationDimension.getStartAttribute());ci.getMetadata().put(ResourceInfo.ELEVATION,di);
else{break;
else{Thread.sleep(1500);
if(s.toSrsSyntax()==srsSyntax){returns;
if(si!=null){getCatalog().remove(si);
if(event==null){thrownewNullArgumentException("Incomingobjectisnull");
if(config==null){thrownewIllegalStateException("Unabletoloadconfiguration");
else
if(!ReadOnlyConfiguration.isReadOnly(config)){try{Resourcefile=loader.get("styles").get(event.getResourceName());
if(!Resources.exists(file)){finalStringstyleAbsolutePath=event.getResourcePath();
if(styleAbsolutePath.indexOf("workspaces")>0){file=loader.get(styleAbsolutePath.substring(styleAbsolutePath.indexOf("workspaces")));
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE))LOGGER.severe(this.getClass()+"isunabletosynchronizetheincomingevent:"+event);throwe;
if(builder.getCoverage.version==Version.v1_0_0){tx=newWCS10GetCoverageTransformer(getCatalog());
else{CoverageResponseDelegateFinderresponseFactory=(CoverageResponseDelegateFinder)getGeoServerApplication().getBean("coverageResponseDelegateFactory");tx=newWCS11GetCoverageTransformer(getCatalog(),responseFactory);
if(USE_JAI_IMAGEREAD.getName().getCode().equals(parameterKey)||ACCURATE_RESOLUTION.getName().getCode().equals(parameterKey)||ALLOW_MULTITHREADING.getName().getCode().equals(parameterKey)){assertThat(parameterKey,c,CoreMatchers.instanceOf(CheckBoxParamPanel.class));
else
if(EXCESS_GRANULE_REMOVAL.getName().getCode().equals(parameterKey)||FOOTPRINT_BEHAVIOR.getName().getCode().equals(parameterKey)||MERGE_BEHAVIOR.getName().getCode().equals(parameterKey)||OVERVIEW_POLICY.getName().getCode().equals(parameterKey)){assertThat(parameterKey,c,CoreMatchers.instanceOf(DropDownChoiceParamPanel.class));
else
if(BACKGROUND_COLOR.getName().getCode().equals(parameterKey)||OUTPUT_TRANSPARENT_COLOR.getName().getCode().equals(parameterKey)||INPUT_TRANSPARENT_COLOR.getName().getCode().equals(parameterKey)){assertThat(parameterKey,c,CoreMatchers.instanceOf(ColorPickerPanel.class));
else
if(SORT_BY.getName().getCode().equals(parameterKey)||BACKGROUND_VALUES.getName().getCode().equals(parameterKey)||SUGGESTED_TILE_SIZE.getName().getCode().equals(parameterKey)){assertThat(parameterKey,c,CoreMatchers.instanceOf(TextParamPanel.class));
if(bandCode.equals(parameterKey)){editorFound.set(true);
ifthisinstanceofgeoserveractaspureslave*/privatevolatileBooleanstatus=false;@AutowiredpublicJMSConfigurationconfig;publicJMSApplicationListener(ToggleTypetype){this.type=type;
if(type.equals(ToggleType.SLAVE)){statusObj=config.getConfiguration(ToggleConfiguration.TOGGLE_SLAVE_KEY);
if(statusObj==null){statusObj=ToggleConfiguration.DEFAULT_SLAVE_STATUS;
else{statusObj=config.getConfiguration(ToggleConfiguration.TOGGLE_MASTER_KEY);
if(statusObj==null){statusObj=ToggleConfiguration.DEFAULT_MASTER_STATUS;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Incomingeventoftype"+event.getClass().getSimpleName());
if(eventinstanceofToggleEvent){//enable/disabletheproducerfinalToggleEventtEv=(ToggleEvent)event;
if(tEv.getType().equals(this.type)){setStatus(tEv.toggleTo());
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Incomingapplicationeventoftype"+event.getClass().getSimpleName());
if(producerEnabled){//
ifproduceisdisable->enableit
if(!this.status){synchronized(this.status){
if(!this.status){this.status=true;
else{//
ifproduceisEnabled->disable
if(this.status){synchronized(this.status){
if(this.status){this.status=false;
if(delegate==null){thrownewNullPointerException("LockProviderdelegaterequired");
if(delegateinstanceofNullLockProvider){return"GlobalLockProvider";
if(value==null){return;
if(value.getAuthority()==null||value.getIdentifier()==null){ValidationErrorerror=newValidationError();error.setMessage(newResourceModel("LayerIdentifierFormField.validationError").getObject());arg.error(error);
if(id==null&&auth==null){setConvertedInput(null);return;
if(info==null){info=newLayerIdentifier();setModelObject(info);
ifitexistsandputthecontentsintothe*fields.*/@OverrideprotectedvoidonBeforeRender(){LayerIdentifierInfoinfo=getModelObject();
if(info!=null){authority.setModelObject(info.getAuthority());identifier.setModelObject(info.getIdentifier());
ifoneexists.**<p>Thetilecachelocationisdeterminedfrom{@linkGeoServer#getTileCache()}.Iftheabove*methodreturnsnullthismethodfallsbacktothebehaviourof{@link*#getGetMapUrl(WMSMapContent,MapLayer,Envelope,String[])}.**<p>Ifthe<tt>layer</tt>argumentis<code>null</code>,therequestismadeincludingall*layersinthe<tt>mapContexT</tt>.**<p>Ifthe<tt>bbox</tt>argumentis<code>null</code>.{@link*WMSMapContent#getAreaOfInterest()}isusedforthebboxparameter.**@paramreqThegetMaprequest.*@paramlayerTheMaplayer,maybe<code>null</code>.*@paramlayerIndexTheindexofthelayerintherequest*@parambboxTheboundingboxoftherequest,maybe<code>null</code>.*@paramkvpAdditionaloroveriddingkvpparameters,maybe<code>null</code>*@paramgeoserver*@returnThefullurlforagetMaprequest.*/publicstaticStringgetTiledGetMapUrl(GeoServergeoserver,GetMapRequestreq,Layerlayer,intlayerIndex,Envelopebbox,String[]kvp){HashMap<String,String>params=getGetMapParams(req,layer.getTitle(),layerIndex,layer.getStyle().getName(),bbox,kvp);StringbaseUrl=getTileCacheBaseUrl(req,geoserver);
if(baseUrl==null){returnResponseUtils.buildURL(req.getBaseUrl(),"wms",params,URLType.SERVICE);
ifany).**<p>Ifthetilecachesetintheconfiguration({@linkGeoServer#getTileCache()})issettoan*asbsoluteurl,itissimplyreturned.Otherwisethevalueisappendedtotheschemeandhost*ofthesupplied<tt>request</tt>.**@paramreqTherequest.*@paramgeoServerThegeoserverconfiguration.*@returnTheurltothetilecache,or<code>null</code>
ifnotilecacheset.*/privatestaticStringgetTileCacheBaseUrl(GetMapRequestreq,GeoServergeoServer){//firstcheck
iftilecachesetStringtileCacheBaseUrl=(String)geoServer.getGlobal().getMetadata().get("tileCache");
if(tileCacheBaseUrl!=null){//twopossibilities,localpath,orfullremotepathtry{newURL(tileCacheBaseUrl);//fullurl,returnitreturntileCacheBaseUrl;
if(layer!=null&&layer.getTitle()!=null){sb.append(layer.getTitle());
if(layer!=null&&layer.equals(req.getLayers().get(i).getName())){++count;
if(count==1){useLayerIndex=false;
if(layer!=null){layers.append(layer);
if(style!=null){styles.append(style);
else{//usedefaultforlayer
if(useLayerIndex){styles.append(req.getLayers().get(layerIndex).getDefaultStyle().getName());
else{for(inti=0;i<req.getLayers().size();i++){
if(layer.equals(req.getLayers().get(i).getName())){styles.append(req.getLayers().get(i).getDefaultStyle().getName());
else{//nolayerspecified,uselayers+stylesspecifiedbyrequestfor(inti=0;i<req.getLayers().size();i++){MapLayerInfomapLayer=req.getLayers().get(i);Styles=(Style)req.getStyles().get(0);layers.append(mapLayer.getName()).append(",");styles.append(s.getName()).append(",");
if(layer!=null){//onlygetfiltersforthelayerintindex=0;
if(useLayerIndex){index=layerIndex;
else{for(;index<req.getLayers().size();index++){
if(req.getLayers().get(index).getName().equals(layer)){break;
if(req.getRawKvp().get("filter")!=null){//splitoutthefilterweneedListfilters=KvpUtils.readFlat((String)req.getRawKvp().get("filter"),KvpUtils.OUTER_DELIMETER);params.put("filter",(String)filters.get(index));
else
if(req.getRawKvp().get("cql_filter")!=null){//splitoutthefilterweneedListfilters=KvpUtils.readFlat((String)req.getRawKvp().get("cql_filter"),KvpUtils.CQL_DELIMITER);params.put("cql_filter",(String)filters.get(index));
else
if(req.getRawKvp().get("featureid")!=null){//semanticsoffeatureidslightlydifferent,replicateentirevalueparams.put("featureid",req.getRawKvp().get("featureid"));
if(req.getRawKvp().get("time")!=null){//semanticsoffeatureidslightlydifferent,replicateentirevalueparams.put("time",req.getRawKvp().get("time"));
if(req.getRawKvp().get("elevation")!=null){//semanticsoffeatureidslightlydifferent,replicateentirevalueparams.put("elevation",req.getRawKvp().get("elevation"));
else{//includeall
if(req.getRawKvp().get("filter")!=null){params.put("filter",req.getRawKvp().get("filter"));
else
if(req.getRawKvp().get("cql_filter")!=null){params.put("cql_filter",req.getRawKvp().get("cql_filter"));
else
if(req.getRawKvp().get("featureid")!=null){params.put("featureid",req.getRawKvp().get("featureid"));
if(bbox==null){bbox=req.getBbox();
if(bbox!=null){params.put("bbox",encode(bbox));
if(req.getFormatOptions()!=null&&!req.getFormatOptions().isEmpty()){params.put("format_options",encodeFormatOptions(req.getFormatOptions()));
if(req.getViewParams()!=null&&!req.getViewParams().isEmpty()){params.put("viewParams",encodeFormatOptions(req.getViewParams()));
if(propertyName!=null&&!propertyName.isEmpty()){params.put("propertyName",propertyName);
if(req.getSld()!=null){//therequestencoderwillurl-encodetheurl,
ifithasalreadyurlencoded//chars,thewillbeencodedtwicetry{Stringsld=URLDecoder.decode(req.getSld().toExternalForm(),"UTF-8");params.put("sld",sld);
if(req.getSldBody()!=null){params.put("sld_body",req.getSldBody());
if(req.getEnv()!=null&&!req.getEnv().isEmpty()){params.put("env",encodeFormatOptions(req.getEnv()));
if(tilesOrigin!=null&&!tilesOrigin.isEmpty()){params.put("tilesorigin",tilesOrigin);
if(req.isTiled()){params.put("tiled",req.isTiled()?"true":"false");
if(palette!=null&&!palette.isEmpty()){params.put("palette",palette);
if(req.getBuffer()>0){params.put("buffer",Integer.toString(req.getBuffer()));
if(Double.compare(req.getAngle(),0.0)!=0){params.put("angle",Double.toString(req.getAngle()));
if((val=kvp.get(key))!=null){ObjectfoValue=formatOptions.get(key);//
ifnotfoundinformatoption
if(foValue==null){Objectparsed=KvpUtils.parseKey(key,val,service,request,version,parsers);
if(parsed!=null){formatOptions.put(key,parsed);
else{formatOptions.put(key,val);
ifthe*formatOptionsmapisempty.**@paramformatOptionsThemapofformationoptions.*@paramsbStringBuffertoappendto.*/publicstaticvoidencodeFormatOptions(MapformatOptions,StringBuffersb){
if(formatOptions==null||formatOptions.isEmpty()){return;
if(valinstanceofCollection){Iteratori=((Collection)val).iterator();while(i.hasNext()){sb.append(i.next()).append(",");
else
if(val.getClass().isArray()){intlen=Array.getLength(val);for(inti=0;i<len;i++){Objecto=Array.get(val,i);
if(o!=null){sb.append(o).append(",");
else{sb.append(val.toString());
if(sb.length()>0){sb.setLength(sb.length()-1);
ifthe*formatOptionsmapisempty.*/publicstaticStringencodeFormatOptions(MapformatOptions){StringBuffersb=newStringBuffer();encodeFormatOptions(formatOptions,sb);returnsb.toString();
iftheformatOptionslistisempty.*/publicstaticStringencodeFormatOptions(List<Map<String,String>>formatOptions){
if(formatOptions==null||formatOptions.isEmpty()){return"";
if(first){first=false;
else{sb.append(",");
if(monitor.isEnabled()){LOGGER.info("Monitorextensionenabled");
else{Stringmsg="Monitorextensiondisabled";
if(monitor.getConfig().getError()!=null){msg+=":"+monitor.getConfig().getError().getLocalizedMessage();
ifenabled,andignorenonhttprequests
if(!monitor.isEnabled()||!(requestinstanceofHttpServletRequest)){chain.doFilter(request,response);return;
if(requestFilter.filter(req)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(req.getRequestURI()+"wasfilteredfrommonitoring");
if(req.getQueryString()!=null){data.setQueryString(URLDecoder.decode(req.getQueryString(),"UTF-8"));
if(serverName==null){serverName=req.getServerName();
if(SecurityContextHolder.getContext()!=null&&SecurityContextHolder.getContext().getAuthentication()!=null){Authenticationauth=SecurityContextHolder.getContext().getAuthentication();Objectprincipal=auth.getPrincipal();
if(principal!=null){
if(principalinstanceofUserDetails){data.setRemoteUser(((UserDetails)principal).getUsername());
else
if(principalinstanceofString){data.setRemoteUser((String)principal);
iftheabovemethodfailstogetusauser
if(data.getRemoteUser()==null||data.getRemoteUser().isEmpty()){data.setRemoteUser(req.getRemoteUser());
if(error!=null){data.setStatus(Status.FAILED);data.setErrorMessage(error.getLocalizedMessage());data.setError(error);
if(data.getStatus()!=Status.FAILED){data.setStatus(Status.FINISHED);
if(error!=null){
if(errorinstanceofRuntimeException){throw(RuntimeException)error;
else{thrownewRuntimeException(error);
if(forwardedFor!=null){String[]ips=forwardedFor.split(",");returnips[0];
else{returnreq.getRemoteAddr();
ifthespecifiedonewasnotused.
if(referer==null)referer=req.getHeader("Referrer");returnreferer;
ifnecessarybyte[]getBody(HttpServletRequestreq){longmaxBodyLength=monitor.config.getMaxBodySize();
if(maxBodyLength==0)returnnull;try{byte[]body=((MonitorServletRequest)req).getBodyContent();//TODO:trimmingatthispointmaynowberedundant
if(body!=null&&maxBodyLength!=MonitorServletRequest.BODY_SIZE_UNBOUNDED&&body.length>maxBodyLength)body=Arrays.copyOfRange(body,0,(int)maxBodyLength);returnbody;
if("ALL".equals(value)){returnAllSomeType.ALL_LITERAL;
if("SOME".equals(value)){returnAllSomeType.SOME_LITERAL;
if(enabled){catalog.setResourceLoader(resourceLoader);readCatalog(catalog,xp);
else{super.loadCatalog(catalog,xp);
if(enabled){readConfiguration(geoServer,xp);
else{super.loadGeoServer(geoServer,xp);
if(enabled){//removeDefaultpersister
if(configPersister!=null){geoserver.removeListener(configPersister);configPersister=null;
if(listener!=null){geoserver.removeListener(listener);listener=null;
else{
if(listener==null){//addeventlistenerwhichpersistschangesfinalList<XStreamServiceLoader>loaders=GeoServerExtensions.extensions(XStreamServiceLoader.class);listener=newServicePersister(loaders,geoserver);geoserver.addListener(listener);
if(configPersister==null){configPersister=newGeoServerConfigPersister(resourceLoader,xpf.createXMLPersister());//attachbackthepersistergeoserver.addListener(configPersister);
if(property==GroupListProvider.GROUPNAME){returneditGroupLink(id,itemModel,property);
else
if(property==GroupListProvider.ENABLED){
if((Boolean)property.getModel(itemModel).getObject())returnnewIcon(id,CatalogIconFactory.ENABLED_ICON);
elsereturnnewLabel(id,"");
if(!canCreateStore){h.add(newLabel("message",newStringResourceModel("noCreateStore",this,null)).add(newAttributeAppender("class",newModel("info-link"),"")));
else{h.add(newLabel("message",newModel()));
iftheexternal*processhangs.**<p>Taskletperiodicallychecksforterminationstatus(i.e.{@link*#doExecute(StepContribution,ChunkContext,JobExecution)}finisheditsexecutionor{@link*#setTimeout(long)}expiredorjobwasinterrupted).Thecheckintervalisgivenby{@link*#setTerminationCheckInterval(long)}.**<p>Whenjobinterruptisdetectedtasklet'sexecutionisterminatedimmediatelybythrowing*{@linkJobInterruptedException}.**<p>{@link#setInterruptOnCancel(boolean)}specifieswhetherthetaskletshouldattemptto*interruptthethreadthatexecutesthesystemcommand
ifitisstillrunningwhentaskletexits*(abnormally).**@authorRobertKasanicky*@authorWillSchipp*@authorAlessioFabiani,GeoSolutions*/@SuppressWarnings("rawtypes")publicabstractclassAbstractCatalogBackupRestoreTasklet<T>extendsBackupRestoreItemimplementsStoppableTasklet,InitializingBean{protectedstaticLoggerLOGGER=Logging.getLogger(AbstractCatalogBackupRestoreTasklet.class);/***/protectedstaticMap<String,Filter<Resource>>resources=newHashMap<String,Filter<Resource>>();/***/static{resources.put("demo",AnyFilter.INSTANCE);resources.put("images",AnyFilter.INSTANCE);resources.put("logs",newFilter<Resource>(){@Overridepublicbooleanaccept(Resourceres){
if(res.name().endsWith(".properties")){returntrue;
if(res.name().toLowerCase().endsWith("sld")||//excludeeverythingendswithSLDext(SLD,YSLD,...)res.name().toLowerCase().endsWith(".xml")||res.name().toLowerCase().endsWith(".css"))//excludeCSSalso{returnfalse;
if(currentExecution.isStopping()){stopped=true;
if(theTask.isDone()){returntheTask.get();
else
if(System.currentTimeMillis()-t0>timeout){theTask.cancel(interruptOnCancel);JobInterruptedExceptionexception=newJobInterruptedException("Job"+currentExecution+"didnotfinishwithinthetimeout.");logValidationExceptions((T)null,exception);returnRepeatStatus.FINISHED;
else
if(execution!=null&&execution.isTerminateOnly()){theTask.cancel(interruptOnCancel);JobInterruptedExceptionexception=newJobInterruptedException("Job"+currentExecution+"interruptedwhileexecuting.");logValidationExceptions((T)null,exception);returnRepeatStatus.FINISHED;
else
if(stopped){theTask.cancel(interruptOnCancel);contribution.setExitStatus(ExitStatus.STOPPED);returnRepeatStatus.FINISHED;
if(resource!=null&&Resources.exists(resource)){List<Resource>resources=Resources.list(resource,entry.getValue(),false);ResourcetargetDir=BackupUtils.dir(baseDir,resource.name());for(Resourceres:resources){
if(res.getType()!=Type.DIRECTORY){Resources.copy(res.file(),targetDir);
else{Resources.copy(res,BackupUtils.dir(targetDir,res.name()));
if(iteminstanceofServiceInfo){ServiceInfoservice=(ServiceInfo)item;XStreamServiceLoaderloader=findServiceLoader(service);try{loader.save(service,backupFacade.getGeoServer(),BackupUtils.dir(directory,fileName));
else{//unwrapdynamicproxiesOutputStreamout=Resources.fromPath(fileName,directory).out();try{
if(getXp()==null){xstream=getxStreamPersisterFactory().createXMLPersister();setXp(xstream.getXStream());
if(l.getFilename().equals(fileName)){item=l.load(backupFacade.getGeoServer(),Resources.fromPath(fileName,directory));
if(item!=null&&iteminstanceofServiceInfo){returnitem;
if(item==null){try{
if(getXp()==null){xstream=getxStreamPersisterFactory().createXMLPersister();setXp(xstream.getXStream());
if(getCurrentJobExecution()!=null){getCurrentJobExecution().addWarningExceptions(Arrays.asList(e));
if(l.getServiceClass().isInstance(service)){loader=l;break;
if(loader==null){thrownewIllegalArgumentException("Noloaderfor"+service.getName());
if{@link#setTimeout(long)}hasbeenexceededoruserinterruptsthejob.<code>*false</code>bydefault*/publicvoidsetInterruptOnCancel(booleaninterruptOnCancel){this.interruptOnCancel=interruptOnCancel;
if{@link*#setInterruptOnCancel(boolean)}hasbeensettotrue.Otherwisetheunderlyingcommandwill*beallowedtofinishbeforethetaskletends.**@since3.0*@seeStoppableTasklet#stop()*/@Overridepublicvoidstop(){stopped=true;}}
if(Proxy.isProxyClass(value.getClass())){ModificationProxyh=(ModificationProxy)Proxy.getInvocationHandler(value);Objectpo=(T)h.getProxyObject();vc=(Class<T>)po.getClass();
else{vc=(Class<T>)value.getClass();
if(vcMap==null){vcMap=maps.computeIfAbsent(vc,k->newConcurrentSkipListMap<K,T>());
if(Proxy.isProxyClass(value.getClass())){ModificationProxyh=(ModificationProxy)Proxy.getInvocationHandler(value);value=(T)h.getProxyObject();
if(!oldName.equals(newName)){Map<Name,T>nameMap=getMapForValue(nameMultiMap,actualValue);nameMap.remove(oldName);nameMap.put(newName,actualValue);
if(clazz.isAssignableFrom(key)){Map<Name,T>valueMap=nameMultiMap.get(key);
if(valueMap!=null){for(Tv:valueMap.values()){finalUu=(U)v;
if(predicate==TRUE||predicate.test(u)){result.add(u);
if(clazz.isAssignableFrom(key)){Map<String,T>valueMap=idMultiMap.get(key);
if(valueMap!=null){Tt=valueMap.get(id);
if(t!=null){return(U)t;
if(clazz.isAssignableFrom(key)){Map<Name,T>valueMap=nameMultiMap.get(key);
if(valueMap!=null){Tt=valueMap.get(name);
if(t!=null){return(U)t;
if(clazz.isAssignableFrom(key)){Map<Name,T>valueMap=nameMultiMap.get(key);
if(valueMap!=null){for(Tv:valueMap.values()){finalUu=(U)v;
if(predicate==TRUE||predicate.test(u)){returnu;
if(valueMap!=null){for(Tv:valueMap.values()){
if(vinstanceofCatalogInfo){Methodsetter=OwsUtils.setter(v.getClass(),"catalog",Catalog.class);
if(setter!=null){try{setter.invoke(v,catalog);
switchCatalogInfotonewcatalogimpl",e);
iftherearenoresourcestoread.**@paramstrictfalsebydefault*/publicvoidsetStrict(booleanstrict){this.strict=strict;
ifnecessary.*/@OverridepublicTread()throwsException,UnexpectedInputException,ParseException{
if(noInput){returnnull;
if(currentResource==-1){currentResource=0;delegate.setResource(resources[currentResource]);delegate.open(newExecutionContext());
ifcurrentoneisexhausted.*Itemsareappendedtothebuffer.**@returnnextitemfrominput*/privateTreadNextItem()throwsException{Titem=readFromDelegate();while(item==null){currentResource++;
if(currentResource>=resources.length){returnnull;
if(iteminstanceofResourceAware){((ResourceAware)item).setResource(getCurrentResource());
if(!this.noInput){delegate.close();
if(resources.length==0){
if(strict){thrownewIllegalStateException("Noresourcestoread.Setstrict=false
ifthisisnotanerrorcondition.");
else{logger.warn("Noresourcestoread.Setstrict=true
ifthisshouldbeanerrorcondition.");noInput=true;return;
if(executionContext.containsKey(getExecutionContextKey(RESOURCE_KEY))){currentResource=executionContext.getInt(getExecutionContextKey(RESOURCE_KEY));//contextcouldhavebeensavedbeforereadinganything
if(currentResource==-1){currentResource=0;
else{currentResource=-1;
if(saveState){executionContext.putInt(getExecutionContextKey(RESOURCE_KEY),currentResource);delegate.update(executionContext);
if(currentResource>=resources.length||currentResource<0){returnnull;
if(hasRoleStore(roleServiceName)==false){thrownewRuntimeException("Workflowerror,newrolenotpossibleforreadonlyservice");
if(parentRoleName!=null){GeoServerRoleparentRole=store.getRoleByName(parentRoleName);store.setParentRole(role,parentRole);
ifthepassedconfigisdifferentbythedefaultvalues**@paramconfig*@throwsIOException*/publicbooleanoverride(JMSConfigurationconfig)throwsIOException;}
if(request!=null){List<Query>queries=request.getQueries();QueryqueryType=queries.get(fcIndex);//mayhavemultipletypenamesineachquery,soaddthemallfor(QNamename:queryType.getTypeNames()){//getafeaturetypenamefromthequeryNamefeatureTypeName=newNameImpl(name.getNamespaceURI(),name.getLocalPart());ResourceInfometa=catalog.getResourceByName(featureTypeName,ResourceInfo.class);
if(meta==null){thrownewWFSException(request,"Couldnotfindfeaturetype"+featureTypeName+"intheGeoServercatalog");
if(metas==null){metas=newHashSet<ResourceInfo>();ns2metas.put(featureTypeName.getNamespaceURI(),metas);
else{FeatureTypefeatureType=((FeatureCollection)featureCollections.get(fcIndex)).getSchema();//loadthemetadataforthefeaturetypeStringnamespaceURI=featureType.getName().getNamespaceURI();FeatureTypeInfometa=catalog.getFeatureTypeByName(featureType.getName());
if(meta==null)thrownewWFSException(request,"Couldnotfindfeaturetype"+featureType.getName()+"intheGeoServercatalog");//addittothemapSetmetas=ns2metas.get(namespaceURI);
if(metas==null){metas=newHashSet();ns2metas.put(namespaceURI,metas);
if(wfs.isFeatureBounding()){configuration.getProperties().remove(GMLConfiguration.NO_FEATURE_BOUNDS);
else{configuration.getProperties().add(GMLConfiguration.NO_FEATURE_BOUNDS);
if(wfs.isCiteCompliant()){//citecomplianceforcesustoforgosrsDimensionattributeconfiguration.getProperties().add(GMLConfiguration.NO_SRS_DIMENSION);
else{configuration.getProperties().remove(GMLConfiguration.NO_SRS_DIMENSION);
if(OPTIMIZED_ENCODING){configuration.getProperties().add(GMLConfiguration.OPTIMIZED_ENCODING);
else{configuration.getProperties().remove(GMLConfiguration.OPTIMIZED_ENCODING);
if(wfs.isEncodeFeatureMember()){configuration.getProperties().add(GMLConfiguration.ENCODE_FEATURE_MEMBER);
else{configuration.getProperties().remove(GMLConfiguration.ENCODE_FEATURE_MEMBER);
if(dispatcherRequest!=null){encoder.setOmitXMLDeclaration(dispatcherRequest.isSOAP());
if(wfs.isCanonicalSchemaLocation()){encoder.setSchemaLocation(getWfsNamespace(),getCanonicalWfsSchemaLocation());
else{encoder.setSchemaLocation(getWfsNamespace(),buildSchemaURL(request.getBaseURL(),getRelativeWfsSchemaLocation()));
if(riinstanceofFeatureTypeInfo){FeatureTypeInfometa=(FeatureTypeInfo)ri;FeatureTypefeatureType=meta.getFeatureType();ObjectuserSchemaLocation=featureType.getUserData().get("schemaURI");
if(userSchemaLocation!=null&&userSchemaLocationinstanceofMap){Map<String,String>schemaURIs=(Map<String,String>)userSchemaLocation;for(Stringnamespace:schemaURIs.keySet()){encoder.setSchemaLocation(namespace,schemaURIs.get(namespace));
else{typeNames.append(meta.getPrefixedName());
if(m.hasNext()){typeNames.append(",");
else{encoder.getNamespaces().declarePrefix(ri.getStore().getWorkspace().getName(),namespaceURI);
if(typeNames.length()>0){params.put("typeName",typeNames.toString());//setthemadeupschemalocationfortypesnotprovidedbytheuserStringschemaLocation=buildURL(request.getBaseURL(),"wfs",params,URLType.SERVICE);LOGGER.finer("Unabletofinduser-definedschemalocationfor:"+namespaceURI+".Usingabuiltschemalocationbydefault:"+schemaLocation);encoder.setSchemaLocation(namespaceURI,schemaLocation);
if(isComplexFeature(results)){complexFeatureStreamIntercept(results,output,encoder);
else{encode(results,output,encoder);
if(gml!=null){gml.setNumDecimals(numDecimals);
if(configurationinstanceofWFSConfiguration){schemaBuilder=((WFSConfiguration)configuration).getSchemaBuilder();
else{schemaBuilder=newFeatureTypeSchemaBuilder.GML3(geoServer);
if(schema.getFeatureTypes().isEmpty()){//nofeaturetypessolet'susethebaseWFSschemareturnnewEncoder(configuration,configuration.schema());
if(this.getXSLT()==null){thrownewFileNotFoundException("Unabletolocatexsltresourcefile");
if(!(results.getFeature().get(fcIndex).getSchema()instanceofSimpleFeatureTypeImpl)){hasComplex=true;break;
if(request.getServletPath().equals("/geogig")){returnmediaTypes;
ifitem.gridLevelsisnull
if(SecurityNamedServiceTabbedPanel.class.isAssignableFrom(panelInfo.getComponentClass())){//thispanelsupportstabs,layoutintabbedmodeadd(newTabbedLayoutPanel("panel",config));
else{//
elselayoutinbasicmodeadd(newBasicLayoutPanel("panel",config));
if(pageInfo.getServiceClass().isAssignableFrom(serviceClass)){panelInfos.add(pageInfo);
if(panelInfos.isEmpty()){thrownewRuntimeException("Unabletofindpanelinfoforserviceconfig:"+config+",serviceclass:"+serviceClass);
if(panelInfos.size()>1){//filterbystrictequalsList<SecurityNamedServicePanelInfo>l=newArrayList(panelInfos);for(Iterator<SecurityNamedServicePanelInfo>it=l.iterator();it.hasNext();){finalSecurityNamedServicePanelInfotargetPanelInfo=it.next();
if(!targetPanelInfo.getServiceClass().equals(serviceClass)){it.remove();
else
if(!targetPanelInfo.getServiceConfigClass().equals(config.getClass())){it.remove();
if(l.size()==1){//filterdowntoonematchreturnl.get(0);
if(wpt==null){wpt=newArrayList<WptType>();
if(rte==null){rte=newArrayList<RteType>();
if(trk==null){trk=newArrayList<TrkType>();
if(version==null){return"1.1";
else{returnversion;
if(wr.canHandle(item)){wr.writeAdditionalResources(backupFacade,Files.asResource(resource.getFile()),item);
if(Math.ulp(value)*scale>1d)returnvalue;returnMath.floor(value*scale+0.5)/scale;}}
if(!resource.getType().equals(Type.UNDEFINED)){returnresource.delete();
if(!resource.getType().equals(Type.UNDEFINED)){returnresource.renameTo(get(target));
if(resourceListeners==null){resourceListeners=newArrayList<>();listeners.put(resource,resourceListeners);
if(resourceListeners!=null){returnresourceListeners.remove(listener);
if(originalListeners!=null){List<ResourceListener>resourceListeners=newArrayList<>(originalListeners);for(ResourceListenerlistener:resourceListeners){listener.changed(notification);
ifdelete,propagatedeletenotificationstochildren,whichcanbefoundinthe//events(see{@linkcreateEvents})
if(notification.getKind()==ResourceNotification.Kind.ENTRY_DELETE){for(ResourceNotification.Eventevent:notification.events()){
if(!notification.getPath().equals(event.getPath())){this.changed(newResourceNotification(event.getPath(),ResourceNotification.Kind.ENTRY_DELETE,notification.getTimestamp(),Collections.emptyList()));
ifcreate,propagateCREATEeventstoitscreatedparents,whichcanbefoundinthe//events(see{@linkcreateEvents})Set<String>createdParents=newHashSet<>();
if(notification.getKind()==ResourceNotification.Kind.ENTRY_CREATE){for(ResourceNotification.Eventevent:notification.events()){
if(!notification.getPath().equals(event.getPath())){createdParents.add(event.getPath());
ifnotacreatedparent)List<String>paths=Lists.newArrayList(Paths.names(notification.getPath()));paths.remove(paths.size()-1);while(paths.size()>0){Stringpath=Paths.path(paths.toArray(newString[0]));booleanisCreate=createdParents.contains(path);this.changed(newResourceNotification(path,isCreate?ResourceNotification.Kind.ENTRY_CREATE:ResourceNotification.Kind.ENTRY_MODIFY,notification.getTimestamp(),notification.events()));//stoppropagatingafterfirstmodifypaths.remove(paths.size()-1);
if(name==null){this.type=Type.DIRECTORY;this.parent=null;this.path=null;
else{this.type=Type.UNDEFINED;this.parent=parent;this.path=buildPath();
if(getType().equals(Type.UNDEFINED)||getType().equals(Type.DIRECTORY)){thrownewUnsupportedOperationException();
if(bytes==null&&getType().equals(Type.UNDEFINED)){List<Event>events=SimpleResourceNotificationDispatcher.createEvents(this,ResourceNotification.Kind.ENTRY_CREATE);createNotification=newResourceNotification(path,ResourceNotification.Kind.ENTRY_CREATE,System.currentTimeMillis(),events);this.type=Type.RESOURCE;
else{createNotification=null;
if(getType().equals(Type.DIRECTORY)){thrownewUnsupportedOperationException();
if(createNotification!=null){dispatcher.changed(createNotification);
if(resource.getType().equals(Type.UNDEFINED)){resource.type=Type.DIRECTORY;
if(child.name.equals(pathName)){resource=child;found=true;break;
if(!found){HeapResourcenewResource=newHeapResource(store,pathName,resource);resource.children.add(newResource);resource=newResource;
if(!getType().equals(Type.UNDEFINED)){
if(parent!=null){parent.children.remove(this);
if(dest==this){returnfalse;
if(!"JTS".equals(processName.getNamespaceURI())){returntrue;
else{return"buffer".equals(processName.getLocalPart());
elseassertXpathCount(0,"//xsd:complexType",doc);assertXpathCount(0,"//xsd:element",doc);
elseassertXpathCount(0,"//xsd:complexType",doc);assertXpathCount(0,"//xsd:element",doc);
if(!schemaLocation.equals(getExSchemaOneLocation())){assertEquals(getExSchemaTwoLocation(),schemaLocation);
elseassertXpathCount(0,"//xsd:complexType",doc);assertXpathCount(0,"//xsd:element",doc);
elseassertXpathCount(0,"//xsd:complexType",doc);assertXpathCount(0,"//xsd:element",doc);
elseassertXpathCount(0,"//xsd:complexType",doc);assertXpathCount(0,"//xsd:element",doc);
if(targetNamespace.equals(FeatureChainingMockData.EX_URI)){assertEquals(2,numberOfImports);assertEquals(3,numberOfIncludes);@SuppressWarnings("serial")Set<String>expectedExSchemaLocations=newHashSet<String>(){{add(getExSchemaOneLocation());add(getExSchemaTwoLocation());add(getExSchemaThreeLocation());
else{//IfthetargetNamespaceisnottheexnamespace,onlyoneexschemacanbeimported.//Theotherexschemaisignored(awarningislogged).//Thereasonforthisisthattheeffectofimportingmultipleschemaswith//thesametargetnamespaceisundefined,soFeatureTypeSchemaBuilderdoes//notdoit.assertEquals(2,numberOfImports);assertEquals(1,numberOfIncludes);StringschemaLocation="//xsd:include["+1+"]/@schemaLocation";
if(targetNamespace.equals(AbstractAppSchemaMockData.GSML_URI)){//gsmlincludeassertXpathEvaluatesTo(AbstractAppSchemaMockData.GSML_SCHEMA_LOCATION_URL,schemaLocation,doc);namespaces.remove(AbstractAppSchemaMockData.GSML_URI);
else{//omincludeassertEquals(FeatureChainingMockData.OM_URI,targetNamespace);assertXpathEvaluatesTo(FeatureChainingMockData.OM_SCHEMA_LOCATION_URL,schemaLocation,doc);namespaces.remove(FeatureChainingMockData.OM_URI);
if(namespace.equals(AbstractAppSchemaMockData.GSML_URI)){//gsmlimportassertXpathEvaluatesTo(AbstractAppSchemaMockData.GSML_SCHEMA_LOCATION_URL,schemaLocation,doc);namespaces.remove(AbstractAppSchemaMockData.GSML_URI);
else
if(namespace.equals(FeatureChainingMockData.EX_URI)){//eximportStringloc=evaluate(schemaLocation,doc);assertTrue(loc.equals(getExSchemaOneLocation())||loc.equals(getExSchemaTwoLocation())||loc.equals(getExSchemaThreeLocation()));namespaces.remove(FeatureChainingMockData.EX_URI);
else{//omimportassertEquals(FeatureChainingMockData.OM_URI,namespace);assertXpathEvaluatesTo(FeatureChainingMockData.OM_SCHEMA_LOCATION_URL,schemaLocation,doc);namespaces.remove(FeatureChainingMockData.OM_URI);
elseassertXpathCount(0,"//xsd:complexType",doc);assertXpathCount(0,"//xsd:element",doc);
if(schemaLocation.startsWith(AbstractAppSchemaMockData.GSML_URI)){//GSMLschemalocationwasencodedfirstassertEquals(gsmlLocation+""+wfsLocation,schemaLocation);
else{//WFSschemalocationwasencodedfirstassertEquals(wfsLocation+""+gsmlLocation,schemaLocation);
elseisencodedassertXpathCount(0,"//gsml:MappedFeature[@gml:id='"+id+"']/gsml:specification/gsml:GeologicUnit",doc);
ifwecangetmf4byitsname.*/@TestpublicvoidtestGetFeaturePropertyFilter(){Stringxml=//"<wfs:GetFeature"//+GETFEATURE_ATTRIBUTES//+">"//+"<wfs:QuerytypeName=\"gsml:MappedFeature\">"//+"<ogc:Filter>"//+"<ogc:PropertyIsEqualTo>"//+"<ogc:PropertyName>gml:name</ogc:PropertyName>"//+"<ogc:Literal>MURRADUCBASALT</ogc:Literal>"//+"</ogc:PropertyIsEqualTo>"//+"</ogc:Filter>"//+"</wfs:Query>"//+"</wfs:GetFeature>";validate(xml);checkGetMf4Only(xml);
ifwecangetmf4withaFeatureIdfidfilter.*/@TestpublicvoidtestGetFeatureWithFeatureIdFilter(){Stringxml=//"<wfs:GetFeature"//+GETFEATURE_ATTRIBUTES//+">"//+"<wfs:QuerytypeName=\"gsml:MappedFeature\">"//+"<ogc:Filter>"//+"<ogc:FeatureIdfid=\"mf4\"/>"//+"</ogc:Filter>"//+"</wfs:Query>"//+"</wfs:GetFeature>";validate(xml);checkGetMf4Only(xml);
ifwecangetmf4withaGmlObjectIdgml:idfilter.*/@TestpublicvoidtestGetFeatureWithGmlObjectIdFilter(){Stringxml=//"<wfs:GetFeature"//+GETFEATURE_ATTRIBUTES//+">"//+"<wfs:QuerytypeName=\"gsml:MappedFeature\">"//+"<ogc:Filter>"//+"<ogc:GmlObjectIdgml:id=\"mf4\"/>"//+"</ogc:Filter>"//+"</wfs:Query>"//+"</wfs:GetFeature>";validate(xml);checkGetMf4Only(xml);
ifencodedwithinGeologicUnititself//notethatthiscanneverbeschema-valid,butthebestthatthe//encodercandowhenconfiguredtousefeatureMembers.assertXpathCount(1,"//gsml:GeologicUnit[@xlink:href='#gu.25699']",doc);assertXpathCount(1,"//gsml:GeologicUnit[@xlink:href='#gu.25678']",doc);assertXpathCount(1,"//gsml:GeologicUnit[@xlink:href='#gu.25682']",doc);//restorefixturesettingswfs=getGeoServer().getService(WFSInfo.class);wfs.setEncodeFeatureMember(encodeFeatureMember);getGeoServer().save(wfs);
ifit'snotrunningagainstadatabaseassumeTrue(rootMapping.getSource().getDataStore()instanceofJDBCDataStore);JDBCDataStorestore=(JDBCDataStore)rootMapping.getSource().getDataStore();NestedFilterToSQLnestedFilterToSQL=createNestedFilterEncoder(rootMapping);FilterFactoryImplNamespaceAwareff=newFilterFactoryImplNamespaceAware();ff.setNamepaceContext(rootMapping.getNamespaces());/**testthesamelikefiltertestedinmethodtestNestedFilterEncoding*/PropertyIsLikelike=ff.like(ff.property("gsml:specification/gsml:GeologicUnit/gml:description"),"*sedimentary*");//Encodingoffiltersinvolvingnestedattributesisdisabled-->CANNOTbeencodedComplexFilterSplittersplitterLike=newComplexFilterSplitter(store.getFilterCapabilities(),rootMapping);splitterLike.visit(like,null);FilterpreFilter=splitterLike.getFilterPre();FilterpostFilter=splitterLike.getFilterPost();assertEquals(Filter.INCLUDE,preFilter);assertEquals(like,postFilter);//filtermustbe"unrolled"(i.e.reversemapped)firstFilterunrolled=AppSchemaDataAccess.unrollFilter(like,rootMapping);//FilterisnestedassertTrue(NestedFilterToSQL.isNestedFilter(unrolled));assertContainsFeatures(fs.getFeatures(like),"mf1","mf2","mf3");
ifanonspatialpropertyisusedinaspatialfilter*/@TestpublicvoidtestSpatialFilterNonGeomProperty()throwsException{Stringrequest="csw?service=CSW&version=2.0.2&request=GetRecords&typeNames=csw:Record&resultType=results"+"&elementName=dc:identifier,ows:BoundingBox&constraint=BBOX(dct:spatial,-250,-250,-190,-100)";Documentd=getAsDOM(request);//print(d);checkOws10Exception(d);
if(v==null){returnOptional.empty();
if(Point.class.isAssignableFrom(geomtype))returnnewRandomRegionatingStrategy(gs).getFilter(context,layer);returnnewGeometryRegionatingStrategy(gs).getFilter(context,layer);
if(m==Mode.HYBRID){m=Mode.LIVE;
if(srs==null){//oldpropertynamesrs=props.getProperty("bboxLogCrs","EPSG:4326");
if(mode==null){//oldpropertynamemode=props.getProperty("bboxLogLevel","no_wfs");
if(mode==null){returnnull;
if(storage==null){//storagekeynotfound,forbackwardcompatibilitylookupmodeModemode=getMode();
if(mode==Mode.HISTORY||mode==Mode.HYBRID){storage="hibernate";
if(storage==null){storage=MemoryMonitorDAO.NAME;
if(storage.equalsIgnoreCase(d.getName())){dao=d;break;
if(dao==null){LOGGER.warning("monitoringstorage"+storage+"notfound,fallingbackto'"+MemoryMonitorDAO.NAME+"'");dao=newMemoryMonitorDAO();
if(value!=null){Tconverted=Converters.convert(value,target,newHints(ConverterFactory.SAFE_CONVERSION,true));
if(converted==null){thrownewIllegalArgumentException("Object"+value+"couldnotbeconvertedtothetargetclass"+target);
else{returnnull;
if(fw!=null&&fw.isModified()){synchronized(this){
if(fw.isModified()){try{props=fw.read();//backwardcompatibilityhackforsync->hibernate.sync
if(props.getProperty("sync")!=null){props.setProperty("hibernate.sync",props.getProperty("sync"));
if(loader!=null){Resourcef=getConfigurationFile(loader);configurationFiles.add(f);
else
if(fw!=null&&fw.getResource()!=null){configurationFiles.add(fw.getResource());
if(!Resources.exists(f)){IOUtils.copy(MonitorConfig.class.getResourceAsStream(MonitorConfig.PROPERTYFILENAME),f.out());
if(loader!=null){Resourcef=getConfigurationFile(loader);ResourcetargetDir=Files.asResource(resourceLoader.findOrCreateDirectory(Paths.convert(loader.getBaseDirectory(),f.parent().dir())));Resources.copy(f.file(),targetDir);
else
if(fw!=null&&fw.getResource()!=null){Resources.copy(fw.getFile(),Files.asResource(resourceLoader.getBaseDirectory()));
else
if(props!=null){FilemonitoringConfigurationFile=Resources.file(resourceLoader.get(MonitorConfig.PROPERTYFILENAME),true);OutputStreamout=Files.out(monitoringConfigurationFile);try{props.store(out,"");
if(Resources.exists(f)){fw=newPropertyFileWatcher(f);fw.setKnownLastModified(System.currentTimeMillis());
if(theResourceinstanceofLayerGroupInfo){LayerGroupInfogroupInfo=(LayerGroupInfo)theResource;
if(groupInfo.isQueryDisabled()){returntrue;
else
if(theResourceinstanceofLayerInfo){LayerInfolayerInfo=(LayerInfo)theResource;
if(!wms.isQueryable(layerInfo)){returntrue;
else
if(theResourceinstanceofMapLayerInfo){LayerInfolayerInfo=((MapLayerInfo)theResource).getLayerInfo();
if(!wms.isQueryable(layerInfo)){returntrue;
if(theResourceinstanceofLayerGroupInfo){LayerGroupInfogroupInfo=(LayerGroupInfo)theResource;
if(groupInfo.isQueryDisabled()){returntrue;
else
if(theResourceinstanceofLayerInfo){LayerInfolayerInfo=(LayerInfo)theResource;
if(!wms.isQueryable(layerInfo)){returntrue;
else
if(theResourceinstanceofMapLayerInfo){LayerInfolayerInfo=((MapLayerInfo)theResource).getLayerInfo();
if(!wms.isQueryable(layerInfo)){returntrue;
if((getMapPart.getSldBody()!=null||getMapPart.getSld()!=null)&&wms.isDynamicStylingDisabled()){thrownewServiceException("Dynamicstyleusageisforbidden");
if((getMapPart.getSldBody()!=null||getMapPart.getSld()!=null)&&(rawKvp.get("QUERY_LAYERS")==null||"".equals(rawKvp.get("QUERY_LAYERS")))){//inthiscaseweassumealllayersinSLDbodyaretobequeried(GSownextension)(request.setQueryLayers(getMapLayers);
else{request.setQueryLayers(newGetFeatureInfoKvpParser("QUERY_LAYERS",wms).parse((String)rawKvp.get("QUERY_LAYERS")));
if(request.getQueryLayers().isEmpty()){thrownewServiceException("Eithernolayerwasqueryable,ornolayerswerespecifiedusingQUERY_LAYERS",WMSErrorCode.LAYER_NOT_QUERYABLE.get(request.getVersion()),"QUERY_LAYERS");
if(kvp.containsKey("propertyName")){List<List<String>>propertyNames=(List<List<String>>)kvp.get("propertyName");
if(propertyNames.size()==1&&request.getQueryLayers().size()>1){//assumeweaskedthesamelistforalllayerswhile(propertyNames.size()<request.getQueryLayers().size()){propertyNames.add(propertyNames.get(0));
if(propertyNames.size()!=request.getQueryLayers().size()){thrownewServiceException("Mismatchbetweenthepropertynamesetcount"+propertyNames.size()+"andthequerylayerscount"+request.getQueryLayers().size(),"InvalidParameter","propertyName");
if(queryLayers.size()>0){//we'vealreadyexpandedbaselayerssolet'savoidlistthenames,theyarenot//theoriginalonesanymorethrownewServiceException("QUERY_LAYERScontainslayersnotcitedinLAYERS."+"Itshouldbeapropersubsetofthoseinstead");
if(format==null){format="text/plain";
else{List<String>infoFormats=wms.getAvailableFeatureInfoFormats();
if(!infoFormats.contains(format)){thrownewServiceException("Invalidformat'"+format+"',supportedformatsare"+infoFormats,"InvalidFormat","info_format");
if(wms.getAllowedFeatureInfoFormats().contains(format)==false)throwwms.unallowedGetFeatureInfoFormatException(format);
if(version.compareTo(WMS.VERSION_1_3_0)>=0){colPixel="I";rowPixel="J";
if(!kvp.containsKey(colPixel)&&!kvp.containsKey(rowPixel)){
if(!wms.getServiceInfo().isCiteCompliant()&&kvp.containsKey("X")&&kvp.containsKey("Y")){colPixel="X";rowPixel="Y";
else{colPixel="X";rowPixel="Y";
if(x<0||x>getMapPart.getWidth()||y<0||y>getMapPart.getHeight()){thrownewServiceException(String.format("%d,%dnotindimensionsofimage:%d,%d",x,y,getMapPart.getWidth(),getMapPart.getHeight()),"InvalidPoint");
if(clazz.equals(LayerInfo.class)&&OwsUtils.getter(clazz,"prefixedName",String.class)!=null&&RequestInfo.get()!=null&&!RequestInfo.get().getPagePath().contains("/workspaces/")){ref=(String)OwsUtils.get(source,"prefixedName");
else
if(OwsUtils.getter(clazz,"name",String.class)!=null){ref=(String)OwsUtils.get(source,"name");
else
if(OwsUtils.getter(clazz,"id",String.class)!=null){ref=(String)OwsUtils.get(source,"id");
else
if(OwsUtils.getter(clazz,"id",Long.class)!=null){//ForsomereasonImporterobjectshaveLongidssothiscatchesthat//caseref=OwsUtils.get(source,"id").toString();
else{thrownewRuntimeException("Couldnotdetermineidentifierfor:"+clazz.getName());
if("GetFeature".equalsIgnoreCase(operation.getId())||"GetFeatureWithLock".equalsIgnoreCase(operation.getId())){//alsocheckthattheresultTypeis"results"GetFeatureRequestreq=GetFeatureRequest.adapt(operation.getParameters()[0]);
if(req.isResultTypeResults()){//callsubclasshookreturncanHandleInternal(operation);
ifit'snotawarningwillbeissued.*/publicStringgetCapabilitiesElementName(){Stringof=getOutputFormat();
if(of==null){returnnull;
if(XML_ELEMENT.matcher(of).matches()){returnof;
else{LOGGER.severe("ERRORIN"+this.getClass()+"IMPLEMENTATION.getCapabilitiesElementName()shouldreturna"+"validXMLelementnamestringforuseintheWFS1.0.0capabilitiesdocument.");Stringname=this.getClass().getName();
if(name.indexOf('.')!=-1){name=name.substring(name.lastIndexOf('.')+1);
if(name==null){returnCollections.emptyList();
else{returnArrays.asList(name);
iftheywantthefulllistofvalidoutputformat*elementnamestobereturnedintheWFS1.0capabilities*/protectedList<String>getAllCapabilitiesElementNames(){List<String>result=newArrayList<String>();for(Stringname:getOutputFormats()){
if(XML_ELEMENT.matcher(name).matches()){result.add(name);
ifneedbe,thedefaultimpelementationreturns<code>*true</code>**@paramoperationTheoperationbeingperformed.*@return<code>true</code>
iftheoutputformatcanhandletheoperation,otherwise<code>*false</code>*/protectedbooleancanHandleInternal(Operationoperation){returntrue;
if(valueinstanceofFeatureCollectionResponse){write((FeatureCollectionResponse)value,output,operation);
else{write(FeatureCollectionResponse.adapt(value),output,operation);
if(metainstanceofFeatureTypeInfo){intftiDecimals=((FeatureTypeInfo)meta).getNumDecimals();
if(ftiDecimals>0){numDecimals=numDecimals==-1?ftiDecimals:Math.max(numDecimals,ftiDecimals);
if(numDecimals==-1){numDecimals=settings.getNumDecimals();
if(!relinquishLoggingControl){booleanreload=false;StringloggingLevel=logging.getLevel();StringloggingLocation=logging.getLocation();BooleanstdOutLogging=logging.isStdOutLogging();
if(propertyNames.contains("level")){loggingLevel=(String)newValues.get(propertyNames.indexOf("level"));reload=true;
if(propertyNames.contains("location")){loggingLocation=(String)newValues.get(propertyNames.indexOf("location"));reload=true;
if(propertyNames.contains("stdOutLogging")){stdOutLogging=(Boolean)newValues.get(propertyNames.indexOf("stdOutLogging"));reload=true;
if(reload){try{LoggingUtils.initLogging(resourceLoader,loggingLevel,!stdOutLogging,loggingLocation);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;WorkspaceAccessLimitsother=(WorkspaceAccessLimits)obj;
if(readable!=other.readable)returnfalse;
if(writable!=other.writable)returnfalse;returntrue;}}
if(pendingDeletes.contains(layerId)){thrownewIllegalArgumentException("Tilelayer'"+layerId+"'wasdeleted.");
if(tileLayerInfo==null){tileLayerInfo=tileLayerCatalog.getLayerById(layerId);
if(tileLayerInfo==null){thrownewIllegalArgumentException("GeoServerTileLayerInfo'"+layerId+"'doesnotexist.");
if(null==tileLayer){thrownewIllegalArgumentException("GeoServerlayerorlayergroup'"+layerId+"'doesnotexist");
if(!pendingDeletes.isEmpty()){names=newHashSet<String>(storedNames);for(Stringid:pendingDeletes){GeoServerTileLayerInfoold=tileLayerCatalog.getLayerById(id);names.remove(old.getName());
if(!pendingModications.isEmpty()){for(Map.Entry<String,GeoServerTileLayerInfo>e:pendingModications.entrySet()){GeoServerTileLayerInfoold=tileLayerCatalog.getLayerById(e.getKey());
if(old!=null){//it'samodification,notanaddition.MakesurethenameisnotoutdatedStringoldName=old.getName();StringnewName=e.getValue().getName();
if(!Objects.equal(oldName,newName)){
if(names==null){names=newHashSet<String>(storedNames);
if(pendingDeletes.contains(layerName)){returnfalse;
ifthisavirtualservicerequestWorkspaceInfolocalWorkspace=LocalWorkspace.get();PublishedInfolocalPublished=LocalPublished.get();
if(localWorkspace!=null){//yupthisisavirtualservicerequest,soweneedtofilterlayersperworkspaceWorkspaceInfolayerWorkspace;PublishedInfopublishedInfo=layer.getPublishedInfo();
if(publishedInfoinstanceofLayerInfo){//thisisanormallayerlayerWorkspace=((LayerInfo)publishedInfo).getResource().getStore().getWorkspace();
else{//thisisalayergrouplayerWorkspace=((LayerGroupInfo)publishedInfo).getWorkspace();
ifthelayerdoesn'thaveanworkspace(thisispossibleforlayergroups)
if(layerWorkspace==null){//noworkspacemeansthatitdoesn'tbelongtothisworkspacereturnnull;
ifthelayermatchesthevirtualserviceworkspacewereturnthelayerotherwise//NULLisreturned
if(!localWorkspace.getName().equals(layerWorkspace.getName())){returnnull;
if(localPublished!=null&&!localPublished.getName().equals(publishedInfo.getName())){returnnull;
else
if(localPublished!=null){//thisimplieswe'relookingatagloballayergroup,thereisnosuchathing//asagloballayerPublishedInfopublishedInfo=layer.getPublishedInfo();
if(!(publishedInfoinstanceofLayerGroupInfo)){returnnull;
else{LayerGroupInfolg=(LayerGroupInfo)publishedInfo;
if(lg.getWorkspace()!=null||!lg.getName().equals(localPublished.getName())){returnnull;
if(layerId==null){returnOptional.ofNullable(null);
if(!pendingModications.isEmpty()){for(GeoServerTileLayerInfoinfo:pendingModications.values()){Stringname=info.getName();
if(name.equals(layerName)){storedName=info.getName();break;
if(layerId==null||pendingDeletes.contains(layerId)){returnnull;
if(modifiedState!=null&&!layerName.equals(modifiedState.getName())){returnnull;
if(!pendingModications.isEmpty()){for(GeoServerTileLayerInfoinfo:pendingModications.values()){Stringname=info.getName();
if(name.equals(layerName)){tileLayerInfo=info;break;
if(null==tileLayerInfo){tileLayerInfo=tileLayerCatalog.getLayerByName(layerName);
if(null==tileLayerInfo){returnnull;
if(pendingDeletes.contains(tileLayerInfo.getId())){returnnull;
if(pendingModications.containsKey(tileLayerInfo.getId())){//foundincatalogbutnotinpendingmodifications,meansnamechangedreturnnull;
if(pendingDeletes.isEmpty()){count=layerIds.size();
else{for(StringlayerId:layerIds){
if(pendingDeletes.contains(layerId)){continue;
if{@codetlinstanceof}{@linkGeoServerTileLayer}.*@seeTileLayerConfiguration#canSave(TileLayer)*/@OverridepublicbooleancanSave(TileLayertl){returntlinstanceofGeoServerTileLayer&&(!tl.isTransientLayer());
if(layerInfo!=null&&!isLayerExposable(layerInfo)){LOGGER.warning("Requestedlayer"+layerInfo.getName()+"hasnogeometry.Won'tcreateTileLayer");return;
if(pendingDeletes.remove(info.getId())){LOGGER.finer("Addinganewlayer"+info.getName()+"beforesavingthedeletedonewiththesameid");
if(!exists){thrownewNoSuchElementException("NoGeoServerTileLayernamed'"+info.getName()+"'exists");
if(tileLayerInfo!=null){finalStringlayerId=tileLayerInfo.getId();pendingModications.remove(layerId);//cacheremovalmustoccurbeforelayerIdisaddedtopendingDeletes//otherwisebrokersandblobstoreswillnotbeabletoobtain//thetilelayerinformationtheyneedtoperformcacheremoval//becausetheCatalogConfigurationwilltreatthelayeras
if//itnolongerexiststry{GWC.get().layerRemoved(tileLayerInfo.getName());
else{thrownewNoSuchElementException("Tilelayer"+layerName+"doesnotexist");
if(old==null){//it'sanadditionStringlayerName=modified.getName();mediator.layerAdded(layerName);
else{//it'samodificationissueTileLayerInfoChangeNotifications(old,modified);
if(isRename){mediator.layerRenamed(oldLayerName,layerName);
if(!oldFormats.equals(newFormats)){oldFormats.removeAll(newFormats);for(StringremovedFormat:oldFormats){StringstyleName=null;StringgridSetName=null;BoundingBoxbounds=null;mediator.truncate(layerName,styleName,gridSetName,bounds,removedFormat);
if(!newStyles.equals(oldStyles)){oldStyles=newHashSet<String>(oldStyles);oldStyles.removeAll(newStyles);for(StringremovedStyle:oldStyles){mediator.truncateByLayerAndStyle(layerName,removedStyle);
ifwehaveanworkspaceprefixintworkspaceSeparatorIndex=layerName.indexOf(":");
if(workspaceSeparatorIndex>=0&&workspaceSeparatorIndex+1<layerName.length()){//let'scheck
ifwereallyhaveaworkspacenameasprefixStringworkspaceName=layerName.substring(0,workspaceSeparatorIndex);
if(catalog.getWorkspaceByName(workspaceName)!=null){//wereallyhaveanworkspaceasprefixsolet'sremoveitreturnlayerName.substring(workspaceSeparatorIndex+1);
if(riinstanceofFeatureTypeInfo){fts.add((FeatureTypeInfo)ri);
if(!fts.isEmpty()){featureTypes.put(entry.getKey(),fts);
if(featureTypes.size()==1){returnfeatureTypes.keySet().iterator().next();
if(containsComplexTypes(types)){//wehavecomplexfeaturessoweaddalltheavailablecatalogfeaturetypesschema=schemaBuilder.build(newFeatureTypeInfo[0],baseURL,true,true);schemaBuilder.addApplicationTypes(schema);
else{//simplefeaturesoweaddonlythefeaturetypesweneedschema=schemaBuilder.build(types,baseURL,true,true);
iftheprovidedfeaturetypescontainscomplextypes.*/privatestaticbooleancontainsComplexTypes(FeatureTypeInfo[]featureTypes){for(FeatureTypeInfofeatureType:featureTypes){try{
if(!(featureType.getFeatureType()instanceofSimpleFeatureType)){returntrue;
if(wfsSchema==null||!(wfsSchemainstanceofXSDSchemaImpl)){returnschema;
if(buildingsStyle==null){//undotherenameperformedinoneofthetestmethodsStyleInfosi=catalog.getStyleByName("BuildingsNew");
if(si!=null){si.setName(MockData.BUILDINGS.getLocalPart());catalog.save(si);
if(!(event.getSource()instanceofStyleInfo)){//onlyinterestedinstyleinfoeventsreturn;
if("sf".equalsIgnoreCase(ws.getName())){form.select("context:panel:workspace",wsIdx);break;
if(form.findSubmittingButton()!=form.get("submit")){return;
if(maxPoolField!=null&&corePoolField!=null){finalStringmp=maxPoolField.getValue();finalStringcp=corePoolField.getValue();
if(!(mp==null||cp==null||mp.trim().isEmpty()||cp.trim().isEmpty())){try{maxPool=Integer.valueOf(mp);
if(maxPool>=1&&corePool>=1&&maxPool<corePool){form.error(newParamResourceModel("poolSizeCheck",getPage()).getString());
if(clazz.isInstance(object)){returnclazz.cast(object);
else{returnnull;
if(fullName.indexOf('@')!=-1||fullName.indexOf('/')!=-1){thrownewIllegalArgumentException("Invalidproperty"+fullName+",thiscodecanonlyhandlepropertieswiththe'name'or'prefix:name'structure");
ifpossibleStringname=fullName;Stringprefix=null;intidx=fullName.indexOf(':');
if(idx>0){prefix=fullName.substring(0,idx);name=fullName.substring(idx+1);
if(prefix!=null&&pn.getNamespaceContext()!=null){Stringns=pn.getNamespaceContext().getURI(prefix);result.add(newNameImpl(ns,name));
else{result.add(name);
if(names.contains(p.getName())||//names.contains(p.getName().getLocalPart())){//builder.append(pd.getName(),p);//
if(names.contains(p.getName())||names.contains(p.getName().getLocalPart())){//thismakesthethingtypespecific,butatleastitworksfortherecordcase//TODO:eventuallyfigureouthowtomakethisforthegeneralcase...
if(p.getType().equals(CSWRecordDescriptor.SIMPLE_LITERAL)){builder.append(CSWRecordDescriptor.DC_ELEMENT_NAME,p);
else{builder.append(p.getName(),p);
if(colors==null)thrownewException("Classnumnotsetted,colorrampnull");returncolors;
if(size==0){return;
if(filter.isDone()){break;
if(filter.isGeometryChanged()){geometryChanged();
if(!(otherinstanceofMultiPoint)){returnfalse;
if(getNumGeometries()!=other.getNumGeometries()){returnfalse;
if(!getGeometryN(i).equalsExact(other.getGeometryN(i),tolerance)){returnfalse;
if(isEmpty()){returnnull;
if(exceptioninstanceofOWS20Exception){OWS20Exceptionex=(OWS20Exception)exception;
if(ex.getHttpCode()!=null){response.setStatus(ex.getHttpCode());
else{response.setStatus(500);
else{response.setStatus(500);
iftheexpectednumberofeventswereconsumed.*/privatevoidwaitAndCheckEvents(GeoServerInstanceinstance,intexpectedEvents){instance.waitEvents(expectedEvents,2000);assertThat(instance.getConsumedEventsCount(),is(expectedEvents));instance.resetConsumedEventsCount();
if(MediaType.TEXT_HTML.isCompatibleWith(contentType)){writeHTML(wrapper,outputWriter);
else{writeJSON(wrapper,outputWriter);
if(mapperParameters==null){mapperParameters=newHashMap<String,String>();
if(!existingTypes.containsValue(clazz)){createType(clazz,template);
if(!nestedPropDefs.isEmpty()){addNestedPropertyTypes(template,nestedPropDefs);
if(targetClassPropName.trim().length()==0){targetObjectType=null;targetPropertyName=null;
else{classNameSeparatorIndex=targetClassPropName.indexOf('.');simpleClassName=targetClassPropName.substring(0,classNameSeparatorIndex);targetObjectType=toClass(simpleClassName);targetPropertyName=targetClassPropName.substring(1+classNameSeparatorIndex);
if("text".equalsIgnoreCase(textType)){textProperty=Boolean.TRUE;
else{textProperty=null;
if(simpleClassName.equalsIgnoreCase(c.getSimpleName())){returnc;
if(targetPropertyOid!=null){targetPropertyOid=targetPropertyOid.intValue();
if(typeProperties==null){typeProperties=Maps.newHashMap();perTypeProps.put(objectType,typeProperties);
if(rowSet.first()){do{Numberoid=(Number)rowSet.getObject(1);StringtypeName=rowSet.getString(2);Class<?>clazz;try{clazz=Class.forName(typeName);
if(1==update){log("createdtype"+typeName);
if(getter==null){continue;
if(returnType.isPrimitive()||returnType.isEnum()||INDEXABLE_TYPES.contains(returnType)){finalClass<?>componentType=returnType.isArray()?returnType.getComponentType():returnType;booleanisText=componentType.isEnum()||CharSequence.class.isAssignableFrom(componentType);isText&=!"id".equals(propertyName);//idisnotonthefulltextsearchlistof//propertiesaddPropertyType(template,clazz,propertyName,null,false,isText);
else{log("Ignoringproperty"+propertyName+":"+returnType.getSimpleName());
if(targetPropertyOf!=null){finalIntegertargetPropId=getTypeId(targetPropertyOf);checkState(null!=targetPropId,Joiner.on("").join("Property",propertyOf.getName(),".",propertyName,"referencesproperty",targetPropertyOf.getName(),".",targetPropertyName,"buttargetpropertytypdoesnotexist"));Map<String,PropertyType>targetPropertyTypes;targetPropertyTypes=this.propertyTypes.get(targetPropId);checkState(targetPropertyTypes!=null,"PropertyTypesoftargettype"+targetPropertyOf.getName()+"notfoundwhileaddingproperty"+propertyName+"of"+propertyOf.getName());targetPropertyType=targetPropertyTypes.get(targetPropertyName);checkState(targetPropertyType!=null);
if(pt.getOid().equals(propId)){returnpt;
ifitwasnotaddedtothedatabase*(i.e.alreadyexists)*/privatePropertyTypeaddPropertyType(finalNamedParameterJdbcOperationstemplate,finalClass<?>infoClazz,finalStringpropertyName,@NullablefinalPropertyTypetargetProperty,finalbooleanisCollection,finalbooleanisText){checkNotNull(template);checkNotNull(infoClazz);checkNotNull(propertyName);finalIntegertypeId=getTypeId(infoClazz);
if(null==typeId){thrownewIllegalStateException("Unknowntypeidfor"+infoClazz.getName());
if(exists==0){log("Adding",propertyName);IntegertargetPropertyOid=targetProperty==null?null:targetProperty.getOid();Stringinsert=String.format("insertintoproperty_type(oid,target_property,type_id,name,collection,text)"+"values(%s,:target,:type,:name,:collection,:isText)",dialect.nextVal("seq_PROPERTY_TYPE"));params=params("target",targetPropertyOid,"type",typeId,"name",propertyName,"collection",isCollection,"isText",isText);logStatement(insert,params);KeyHolderkeyHolder=newGeneratedKeyHolder();template.update(insert,newMapSqlParameterSource(params),keyHolder,newString[]{"oid"});//lookslikesomedb'sreturnthepkdifferentthanothers,soletstrybothwaysNumberpTypeKey=(Number)keyHolder.getKeys().get("oid");
if(pTypeKey==null){pTypeKey=keyHolder.getKey();
else{log("Notaddingpropertytype",infoClazz.getSimpleName(),".",propertyName,"asitalreadyexists");pType=null;
if(pType!=null){Map<String,PropertyType>map=this.propertyTypes.get(typeId);
if(map==null){map=Maps.newHashMap();this.propertyTypes.put(typeId,map);
if(propertyName.length()>1){charfirst=propertyName.charAt(0);charsecond=propertyName.charAt(1);
if(!Character.isUpperCase(second)){propertyName=Character.toLowerCase(first)+propertyName.substring(1);
if(null==propTypes){continue;
if(Predicates.ANY_TEXT.getPropertyName().equals(propertyName)){for(PropertyTypepropertyType:propTypes.values()){
if(propertyType.isText()){matches.add(propertyType);
else{PropertyTypepropertyType=propTypes.get(propertyName);
if(null!=propertyType){matches.add(propertyType);
if(objectinstanceofNamespaceInfo&&"name".equalsIgnoreCase(propertyName)){//HACKforderivedproperty,ModificationProxyevaluatesittotheoldvaluevalue=((NamespaceInfo)object).getPrefix();
else
if(objectinstanceofLayerInfo&&"name".equalsIgnoreCase(propertyName)){//HACKforderivedproperty,ModificationProxyevaluatesittooldvalue.Remove//whenlayernameisdecoupledfromresourcenamevalue=((LayerInfo)object).getResource().getName();
else
if(objectinstanceofLayerInfo&&"title".equalsIgnoreCase(propertyName)){//HACKforderivedproperty,ModificationProxyevaluatesittooldvalue.Remove//whenlayernameisdecoupledfromresourcenamevalue=((LayerInfo)object).getResource().getTitle();
else
if(objectinstanceofPublishedInfo&&"prefixedName".equalsIgnoreCase(propertyName)){//HACKforderivedproperty,itisnotaregularjavabeanpropertyvalue=((PublishedInfo)object).prefixedName();
else{//proceedasitshouldvalue=ff.property(propertyName).evaluate(object);
ifKMLisnot//thereassertXpathEvaluatesTo("1","count(//wfs:GetFeature/wfs:ResultFormat/wfs:OGR-KML)",dom);
if(entry.getName().equals("Buildings.kml")){break;
ifatleastonelayersupportsfiltering,overallfilteringshouldbesupportedresponse=getAsServletResponse("wms?service=WMS&version=1.1.0&request=GetMap&layers=wcs:World,gs:staticRaster"+"&styles=&bbox=0.2372206885127698,40.562080748421806,"+"14.592757149389236,44.55808294568743&width=768&height=330"+"&srs=EPSG:4326&format=application/openlayers");content=response.getContentAsString();assertThat(content.contains("varsupportsFiltering=true;"),is(true));
if(userAgent!=null){request.addHeader("USER-AGENT",userAgent);
if(requestinstanceofHttpServletRequest){HttpServletRequestrequestHTTP=(HttpServletRequest)request;
if(requestNeedsWrapper(requestHTTP)){request=newRequestWrapper(requestHTTP);
if(wrapped.getPathInfo().endsWith("search")){request="search";
else{request="description";
if("service".equalsIgnoreCase(name)){returnnewString[]{"OSEO"};
if("request".equalsIgnoreCase(name)){returnnewString[]{request};
if("service".equalsIgnoreCase(name)){return"OSEO";
if("request".equalsIgnoreCase(name)){returnrequest;
if(pipeline==null){synchronized(pipelines){pipeline=pipelines.get(key);
if(pipeline==null){pipeline=newConcurrentLinkedQueue();pipelines.put(key,pipeline);
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("Queuingtaskintopipeline"+key);
if(job!=null){
if(!job.lock.tryLock())continue;//anotherthreadalreadyhandlingthisjob
if(job.future!=null){//jobhasbeensubmitted,
ifitisdoneremoveitfrom//thequeue
if(job.future.isDone()){
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("Removingtaskfromqueue"+job.key);
else{//startthejob
if(LOGGER.isLoggable(Level.FINEST)){LOGGER.finest("Executingtaskinqueue"+job.key);
if(expectedResult==null){assertThat(result,nullValue());
else{assertThat(result,notNullValue());assertThat(result,is(expectedResult));
if((geometryClass==MultiPoint.class)||(geometryClass==Point.class)){writePointDefs();
if(!styleName.startsWith("#")){writer.write("class=\""+styleName+"\"");
if(featureReader!=null){featureReader.close();
if(getSecurityManager().isStrongEncryptionAvailable()==false){config.setConfigPasswordEncrypterName(getStrongPBEPasswordEncoder().getName());try{validator.validateManagerConfig(config,newSecurityManagerConfig());fail("invalidstrongpasswordencodershouldfail");
if(!getSecurityManager().isStrongEncryptionAvailable()){config.setPasswordEncoderName(getStrongPBEPasswordEncoder().getName());try{validator.validateAddUserGroupService(config);fail("invalidstrongpasswordencodershouldfail");//getSecurityManager().saveUserGroupService(config);
ifneededGeoServerUserGroupServiceservice=getSecurityManager().loadUserGroupService(XMLUserGroupService.DEFAULT_NAME);
if(service.getUserByUsername(USERNAME)==null){GeoServerUseruser=service.createUserObject(USERNAME,USERPW,true);GeoServerUserGroupStorestore=service.createStore();store.addUser(user);store.store();service.load();
if(x<50&&y<50){//upperleftsquare:verticallines
if(x%5==0)raster.setSample(x,y,0,0);
elseraster.setSample(x,y,0,width);
else
if(x<50&&y>height-50){//lowerleftsquare:horizontallines
if(y%5==0)raster.setSample(x,y,0,0);
elseraster.setSample(x,y,0,width);
else
if(x>width-50&&y<50){//upperrightsquare:descendingdiagonallines
if((x-y)%5==0)raster.setSample(x,y,0,0);
elseraster.setSample(x,y,0,width);
else
if(x>width-50&&y>height-50){//lowerrightsquare:ascendingdiagonallines
if((x+y)%5==0)raster.setSample(x,y,0,0);
elseraster.setSample(x,y,0,width);
else
if(x%50==0||y%50==0||(x-y)%100==0)raster.setSample(x,y,0,0);//biggerlines
elseraster.setSample(x,y,0,x+y);//normalbackground
if(isNew){config.processInput();
if(isNew&&nameExists){error.addKey("errRepositoryNameExists");
else
if("file".equals(scheme)){FilerepoDir=newFile(location);finalFileparent=repoDir.getParentFile();
if(!parent.exists()||!parent.isDirectory()){error.addKey("errParentDoesntExist");
if(!parent.canWrite()){error.addKey("errParentReadOnly");
if(isNew){
if(repoDir.exists()){error.addKey("errDirectoryExists");
else
if(!isGeogigDirectory(repoDir)){error.addKey("notAGeogigRepository");
else
if("postgresql".equals(scheme)){try{
if(isNew){
if(resolver.repoExists(location)){error.addKey("errRepositoryExists");
else{//trytoconnectresolver.open(location);
if(!error.getKeys().isEmpty()){validatable.error(error);
if(url==null){thrownewRuntimeException("Couldnotfindthemainregistryfile");
if(url!=null){registry.updateFromStream(url);
if(!servicesFile.exists()){thrownewFileNotFoundException("Couldnotfindservices.xmlunder:"+dir.getAbsolutePath());
if(global.get("suppressStdOutLogging")!=null){logging.setStdOutLogging(!get(global,"suppressStdOutLogging",Boolean.class));
else{logging.setStdOutLogging(true);
if(service!=null){LOGGER.info("Loadingservice'"+service.getId()+"'");geoServer.add(service);
if(o==null){
if(def!=null){returndef;
if(clazz.isPrimitive()){
if(clazz==int.class){return(T)Integer.valueOf(0);
if(clazz==double.class){return(T)Double.valueOf(0d);
if(clazz==boolean.class){return(T)Boolean.FALSE;
ifitworkswiththe"correct"//spelling.MockHttpServletRequestreq=request("POST","/bar/foo","78.56.34.12",null,null);((MockHttpServletRequest)req).addHeader("Referrer","http://testhost/testpath");filter.doFilter(req,response(),chain);RequestDatadata=dao.getLast();assertEquals("POST",data.getHttpMethod());assertEquals("/bar/foo",data.getPath());assertEquals("78.56.34.12",data.getRemoteAddr());assertEquals("http://testhost/testpath",data.getHttpReferer());assertNull(data.getCacheResult());assertNull(data.getMissReason());
if(body==null)body="";//MockHttpServletRequest#getInputStreamdoesn'tlikenullbodies//andthrowsNullPointerException.Itshouldprobablydosomethingusefullikereturnan//emptystreamorthrow//IOException.req.setContent(body.getBytes("UTF-8"));
if(referer!=null)req.addHeader("Referer",referer);returnreq;
if(request.getId()==null){thrownewServiceException("IDparameternotprovidedforGetRepositoryItemBeanoperation",ServiceException.MISSING_PARAMETER_VALUE,"id");
if(input.getReference()!=null){//thisisareferenceInputReferenceTyperef=input.getReference();//grabthelocationandmethodStringhref=ref.getHref();
if(href.startsWith("http://geoserver/wfs")){provider=newInternalWFSInputProvider(input,ppio,context);
else
if(href.startsWith("http://geoserver/wcs")){provider=newInternalWCSInputProvider(input,ppio,context);
else
if(href.startsWith("http://geoserver/wps")){provider=newInternalWPSInputProvider(input,ppio,executor,context);
else{intmaxSizeMB=Validators.getMaxSizeMB(validators);validators=Validators.filterOutClasses(validators,MaxSizeValidator.class);provider=newRemoteRequestInputProvider(input,(ComplexPPIO)ppio,executor.getConnectionTimeout(),maxSizeMB*1024*1024);
else{provider=newSimpleInputProvider(input,ppio);
ifnecessaryreturnValidatingInputProvider.wrap(provider,validators);
if(value==null){value=getValueInternal(listener);
if(errors.size()>0){thrownewWPSException("FailedtoparseKVPrequest",errors.get(0));
if(r!=null){Mapkvp=newHashMap(r.getKvp());r.setKvp(newCaseInsensitiveMap(parsed));
ifgdal_translateisavailable**@throwsIOException*/publicstaticbooleanisAvailable()throwsIOException{returnnewGdalTranslateTransform(newArrayList<String>()).checkAvailable();
if(datainstanceofFileData){FileDatafd=(FileData)data;returnfd.getFile();
else{thrownewIOException("Canrungdal_translateonlyagainstfiledata");
ifrolesStringis*nullorempty**<p>TheuserNamemaybenullandshouldonlybepassed
iftherolehaspersonalizedrole*parameters**@paramroleString*@paramuserName*/publicabstractGeoServerRoleconvertRoleFromString(StringroleString,StringuserName);}
if(boundingBoxType==null){returnnull;
else{returntoTargetType(boundingBoxType);
if(bbox.getCrs()!=null){crs=CRS.decode(bbox.getCrs());
if(ReferencedEnvelope.class.isAssignableFrom(getType())||BoundingBox.class.isAssignableFrom(getType())){returnnewReferencedEnvelope(lower[0],upper[0],lower[1],upper[1],crs);
else
if(Envelope.class.isAssignableFrom(getType())){returnnewEnvelope(lower[0],upper[0],lower[1],upper[1]);
else
if(org.opengis.geometry.Envelope.class.isAssignableFrom(getType())){GeneralEnvelopege=newGeneralEnvelope(lower,upper);ge.setCoordinateReferenceSystem(crs);returnge;
else{thrownewWPSException("FailedtoconvertfromOWS1.1Boundingboxtype"+"totheinternalrepresentation:"+getType());
if(object==null){thrownewIllegalArgumentException("Cannotencodeanullboundingbox");
if(objectinstanceofEnvelope){Envelopeenv=(Envelope)object;
if(objectinstanceofReferencedEnvelope){ReferencedEnvelopere=(ReferencedEnvelope)object;crs=re.getCoordinateReferenceSystem();
else
if(org.opengis.geometry.Envelope.class.isAssignableFrom(getType())){org.opengis.geometry.Envelopeenv=(org.opengis.geometry.Envelope)object;crs=env.getCoordinateReferenceSystem();bbox.setLowerCorner(Arrays.asList(env.getLowerCorner().getCoordinate()));bbox.setUpperCorner(Arrays.asList(env.getUpperCorner().getCoordinate()));
else{thrownewWPSException("Failedtoconvertfrom"+object+"toanOWS1.1Boundingboxtype");
if(crs!=null){try{Integercode=CRS.lookupEpsgCode(crs,false);
if(code!=null){bbox.setCrs("EPSG:"+code);
if(!restManager.getReader().existGeoserver()){thrownewTaskException("Failedtoconnecttogeoserver"+extGS.getUrl());
if(!restManager.getReader().existsWorkspace(ws)){createWorkspaces.add(ws);
if(si!=null){StringwsStyle=wsName(si.getWorkspace());
if(!restManager.getReader().existsStyle(wsStyle,si.getName())){createStyles.add(si);
if(wsStyle!=null&&!restManager.getReader().existsWorkspace(wsStyle)){createWorkspaces.add(wsStyle);
if(!restManager.getPublisher().createWorkspace(newWs,newURI(catalog.getNamespaceByPrefix(newWs).getURI()))){thrownewTaskException("Failedtocreateworkspace"+newWs);
if(createStore){try{
if(!createStore(extGS,restManager,store,ctx,actualStoreName)){thrownewTaskException("Failedtocreatestore"+ws+":"+actualStoreName);
else{LOGGER.log(Level.INFO,"Storeexists:"+storeName+"on"+extGS.getName()+",skippingcreation.");
if(!restManager.getPublisher().configureResource(ws,storeType,storeName,resource.getName(),re)){thrownewTaskException("Failedtoconfigureresource"+ws+":"+re.getName());
if(createStore&&(storeType==StoreType.DATASTORES?restManager.getReader().existsFeatureType(ws,actualStoreName,actualStoreName):restManager.getReader().existsCoverage(ws,actualStoreName,actualStoreName))){
if(!restManager.getPublisher().configureResource(ws,storeType,actualStoreName,actualStoreName,re)){thrownewTaskException("Failedtoconfigureresource"+ws+":"+re.getName());
else{
if(!restManager.getPublisher().createResource(ws,storeType,actualStoreName,re)){thrownewTaskException("Failedtocreateresource"+ws+":"+re.getName());
if(!restManager.getStyleManager().publishStyleZippedInWorkspace(wsName(layer.getDefaultStyle().getWorkspace()),createStyleZipFile(si),si.getName())){thrownewTaskException("Failedtocreatestyle"+si.getName());
if(layer.getDefaultStyle()!=null){layerEncoder.setDefaultStyle(wsName(layer.getDefaultStyle().getWorkspace()),layer.getDefaultStyle().getName());
if(!restManager.getPublisher().configureLayer(ws,tempName,layerEncoder)){thrownewTaskException("Failedtoconfigurelayer"+ws+":"+resource.getName());
ifnecessaryrestManager.getPublisher().removeResource(ws,storeType,storeName,tempName);
if(createStore){restManager.getPublisher().removeStore(ws,actualStoreName,storeType,true,Purge.ALL);
ifexists
if(storeType==StoreType.DATASTORES?restManager.getReader().existsFeatureType(ws,storeName,resource.getName()):restManager.getReader().existsCoverage(ws,storeName,resource.getName())){
if(!restManager.getPublisher().removeLayer(ws,resource.getName())||!restManager.getPublisher().removeResource(ws,storeType,storeName,resource.getName())){thrownewTaskException("Failedtoremoveoldlayer"+ws+":"+resource.getName());
if(!actualStoreName.equals(storeName)){//removeoldstore
ifexists
if(storeType==StoreType.DATASTORES?restManager.getReader().existsDatastore(ws,storeName):restManager.getReader().existsCoveragestore(ws,storeName)){
if(!restManager.getPublisher().removeStore(ws,storeName,storeType,true,Purge.ALL)){thrownewTaskException("Failedtoremoveoldstore"+ws+":"+storeName);
if(!restManager.getStoreManager().update(ws,actualStoreName,newGSGenericStoreEncoder(storeType,null,null,storeName,null,null))){thrownewTaskException("Failedtorenamestore"+ws+":"+actualStoreName+"to"+storeName);
if(!restManager.getPublisher().configureResource(ws,storeType,storeName,tempName,re)){thrownewTaskException("Failedtorenameresource"+ws+":"+tempName+"to"+storeName);
if(!restManager.getPublisher().configureLayer(ws,resource.getName(),layerEncoder)){thrownewTaskException("Failedtoadvertiselayer"+ws+":"+layer.getName());
if(!restManager.getPublisher().removeLayer(ws,tempName)||!restManager.getPublisher().removeResource(ws,storeType,actualStoreName,tempName)){thrownewTaskException("Failedtoremovelayer"+ws+":"+tempName);
if(createStore){
if(!restManager.getPublisher().removeStore(ws,actualStoreName,storeType,true,Purge.ALL)){thrownewTaskException("Failedtoremovestore"+ws+":"+actualStoreName);
if(!restManager.getPublisher().removeStyleInWorkspace(wsName(style.getWorkspace()),style.getName(),true)){thrownewTaskException("Failedtoremovestyle"+layer.getDefaultStyle().getName());
if(!restManager.getPublisher().removeWorkspace(createdWs,true)){thrownewTaskException("Failedtoremoveworkspace"+ws);
if(exgr.getOnlineResource()==null){return;
if(uri==null){return;
if(resPicture!=null&&resPicture.getType()!=Type.UNDEFINED){pictures.add(resPicture);
if(uri.getScheme()!=null&&!uri.getScheme().equals("file")){returnnull;
else
if(uri.getScheme().equals("file")&&uri.isAbsolute()&&!uri.isOpaque()){returnFiles.asResource(newFile(uri.toURL().getFile()));
else{returngeoServerDataDirectory.get(uri.getSchemeSpecificPart());
if(restManager.getReader().existsLayer(ws,layer.getName(),true)){
if(!restManager.getPublisher().removeLayer(ws,resource.getName())||!restManager.getPublisher().removeResource(ws,storeType,storeName,resource.getName())){thrownewTaskException("Failedtoremovelayer"+ws+":"+resource.getName());
if(!restManager.getPublisher().removeStore(ws,storeName,storeType,false,Purge.ALL)){
if(neverReuseStore()){thrownewTaskException("Failedtoremovestore"+ws+":"+storeName);
elsestoreisstillinuse
iftheywerecreatedbythistask.
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;IpRequestMatcherother=(IpRequestMatcher)obj;
if(ip==null){
if(other.ip!=null)returnfalse;
else
if(!ip.equals(other.ip))returnfalse;returntrue;}}
if(Notification.class.isAssignableFrom(type)){returnINSTANCE;
if("wms".equals(service.getId().toLowerCase())&&NcWmsService.GET_TIME_SERIES_REQUEST.equals(req)){/**HACK:weareusingGetFeatureInfoRequestandGetFeatureInfoKvpReaderforparsingaGetTimeSeries.AsthevalidINFO_FORMATsare*different,weneedtofooltheGetFeatureInfoKvpReader*/Mapkvp=request.getKvp();StringrequestedFormat=(String)kvp.get("INFO_FORMAT");kvp.put("INFO_FORMAT","text/plain");kvp.put(NcWmsService.TIME_SERIES_INFO_FORMAT_PARAM_NAME,requestedFormat);returnnewService(service.getId(),this.service,service.getVersion(),service.getOperations());
if(currType.getXmlConstant().equalsIgnoreCase(value)){type=currType;break;
if(type==null)thrownewWcsException("Couldnotunderstandgridtype'"+value+"'",InvalidParameterValue,"GridType");
if(type==GridType.GT2dGridIn3dCrs)thrownewWcsException("GeoServerdoesnotsupporttype"+type.name(),InvalidParameterValue,"GridType");returntype.getXmlConstant();}}
if(progress>status.progress||StringUtils.equals(task,status.task)){
if(status.getPhase()==ProcessState.QUEUED){status.setPhase(ProcessState.RUNNING);
if(e!=null){status.setException(e);
if(status.getPhase()==ProcessState.RUNNING){fireSucceded();
else
if(status.getPhase()==ProcessState.DISMISSING){fireDismissed();
else{fireFailed(null);
ifwejustforcedtheprocesstobailout
if(status.phase!=ProcessState.DISMISSING){this.exception=exception;fireFailed(exception);
iftheprocesshasbeencancelled*/publicvoidcheckDismissed(){
if(status.getPhase()==ProcessState.DISMISSING){thrownewProcessDismissedException();
if(rs.wasNull())returnnull;returni;
if(value!=null){ASYNCH_RESOURCE_THREADS=Integer.parseInt(value);
else{//empiricaldeterminationafterbenchmarks,thevalueisrelatednotthe//availableCPUs,butbyhowwellthediskhandlesparallelaccess,different//disksubsystemswillhaveadifferentoptimalvalueASYNCH_RESOURCE_THREADS=4;
ifwewanttohaveabackgroundthreadforloadingresources,ornot
if(resources.size()>1){queue=newLinkedBlockingQueue<>(10000);//createabackgroundthreadallowingthisconstructortoreturnimmediatelyand//startaccumulatinginthequeueasynchronouslythread=newThread(()->{//parallelizeIOinalocalthreadpoolExecutorServiceexecutor=Executors.newFixedThreadPool(ASYNCH_RESOURCE_THREADS);BlockingQueue<Object>sourceQueue=newLinkedBlockingQueue<>(resources);for(inti=0;i<ASYNCH_RESOURCE_THREADS;i++){//eachIOthreadwillexitwhencloseiscalledorwhenthe//terminatoris//reached,weneedoneterminatorperIOthreadsourceQueue.add(TERMINATOR);executor.submit(()->{try{Objecto;while(!completed&&(o=sourceQueue.take())!=TERMINATOR){Resourcer=(Resource)o;try{Tmapped=mapper.apply(r);
if(mapped!=null){queue.put(mapped);
else
if(resources.size()==1){//don'tstartathreadforasingleresource,thereisnoparallelismadvantagefinalResourcer=resources.get(0);try{mapped=mapper.apply(r);
else{//nothingfoundmapped=null;completed=true;
if(mapped!=null){returntrue;
if(completed){returnfalse;
if(o==TERMINATOR){completed=true;returnfalse;
else{mapped=(T)o;returntrue;
if(hasNext()){Tresult=mapped;mapped=null;returnresult;
else{thrownewNoSuchElementException();
if(thread!=null&&thread.isAlive()){thread.interrupt();completed=true;queue.clear();
if(colors==null)thrownewException("Classnumnotsetted,colorrampnull");returncolors;
if(!(layerModel.getObject()instanceofLayerInfo)||CatalogConfiguration.isLayerExposable((LayerInfo)layerModel.getObject())){editor=newGeoServerTileLayerEditor("tileLayerEditor",layerModel,tileLayerModel);add(editor);
else{add(newLabel("tileLayerEditor",newResourceModel("geometryLessLabel")));
if(editor!=null){editor.save();
ifitcontainsarefrerenceto{@link*WMSMapContent},inwhichcaseit'smandatorythatthemapcontext's{@link*WMSMapContent#dispose()}methodiscalled.*/publicfinalvoiddispose(){
if(mapContent!=null){mapContent.dispose();
if(responseHeaders==null){responseHeaders=newHashMap<String,String>();
if(responseHeaders==null||responseHeaders.size()==0){returnnull;
if(filename!=null&&extension!=null){returnfilename+extension;
ifwecangettheoriginalrequest,beforethegroupexpansionhappenedRequestrequest=Dispatcher.REQUEST.get();Stringfilename=null;
if(request!=null&&request.getRawKvp()!=null&&request.getRawKvp().get("LAYERS")!=null){Stringlayers=((String)request.getRawKvp().get("LAYERS")).trim();
if(layers.length()>0){filename=layers.replace(",","_");
if(filename==null&&mapContent!=null){StringBuffersb=newStringBuffer();for(Layerlayer:mapContent.layers()){Stringtitle=layer.getTitle();
if(title!=null&&!title.equals("")){sb.append(title).append("_");
if(sb.length()>0){sb.setLength(sb.length()-1);filename=sb.toString();
if(filename!=null){filename=filename.replace(":","-");
ifitisthere
if(panelContainer.get("content")!=null){panelContainer.remove("content");
if(target!=null){target.add(panelContainer);
if(serviceClass.isAssignableFrom(pageInfo.getServiceClass())){panelInfos.add(pageInfo);
if(panelInfos.isEmpty()){thrownewRuntimeException("Unabletofindpanelinfoforserviceclass:"+serviceClass);
if(!CRS.equalsIgnoreMetadata(sourceCRS,targetCRS)){/**Operations.DEFAULT.resample(coverage,targetCRS,null,*Interpolation.getInstance(Interpolation.INTERP_NEAREST))*/finalParameterValueGroupparam=(ParameterValueGroup)processor.getOperation("Resample").getParameters();param.parameter("Source").setValue(coverage);param.parameter("CoordinateReferenceSystem").setValue(targetCRS);param.parameter("GridGeometry").setValue(null);param.parameter("InterpolationType").setValue(interpolation);coverage=(GridCoverage2D)((Resample)processor.getOperation("Resample")).doOperation(param,hints);
if(intersectionEnvelope.isEmpty()){thrownewWcsException("TheIntersectionisnull.ChecktherequestedBBOX!");
if(!intersectionEnvelope.equals((GeneralEnvelope)sourceEnvelope)){//getthecroppedgridgeometry//finalGridGeometry2DcropGridGeometry=getCroppedGridGeometry(//intersectionEnvelope,gridCoverage);/*Operations.DEFAULT.crop(coverage,intersectionEnvelope)*/finalParameterValueGroupparam=(ParameterValueGroup)processor.getOperation("CoverageCrop").getParameters();param.parameter("Source").setValue(coverage);param.parameter("Envelope").setValue(intersectionEnvelope);//param.parameter("ConserveEnvelope").setValue(conserveEnvelope);croppedGridCoverage=(GridCoverage2D)((Crop)processor.getOperation("CoverageCrop")).doOperation(param,hints);
else{croppedGridCoverage=(GridCoverage2D)coverage;
ifthefileextensionis*notdependontheobjectbeingencoded*/publicStringgetFileExtension(){return".bin";
if(parent!=null){parent.children.add(this);
if(debugMode){print(page,true,true,true);
ifany.Usedtofigureoutthe"nativemime"*asrequiredbytheWCS2.0spec.**@authorAndreaAime-GeoSolutions*/publicinterfaceCoverageMimeTypeMapper{StringgetMimeType(CoverageInfoinfo)throwsIOException;}
if(geoserver.getService(WCSInfo.class).isLatLon()){finalParameterValueGroupgp=writerHelper.getGeotoolsWriteParams();gp.parameter(GeoTiffFormat.RETAIN_AXES_ORDER.getName().toString()).setValue(true);
if(encondingParameters.containsKey("interleave")){//ok,theinterleavinghasbeenspecified,let'sseewhatwegotfinalStringinterleavingS=encondingParameters.get("interleave");
if(interleavingS.equals("pixel")||interleavingS.equals("Pixel")){//okwewantpixelinterleaving,TIFFImageWriteralwayswrites//withpixelinterleavinghence,wearegood!
else
if(interleavingS.equals("band")||interleavingS.equals("Band")){//TODOimplementthisinTIFFWriter,asitisnotsupportedrightnowthrownewOWS20Exception("BandedInterleavingnotsupported",ows20Code(WcsExceptionCode.InterleavingNotSupported),interleavingS);
else{thrownewOWS20Exception("InvalidInterleavingtypeprovided",ows20Code(WcsExceptionCode.InterleavingInvalid),interleavingS);
ifthetilesizeexceedstheimagedimension,let'sretiletosavespaceonoutputimagefinalGridEnvelopegr=sourceCoverage.getGridGeometry().getGridRange();
if(gr.getSpan(0)<tileDimensions.width){tileDimensions.width=gr.getSpan(0);
if(gr.getSpan(1)<tileDimensions.height){tileDimensions.height=gr.getSpan(1);
if(econdingParameters.containsKey("tiling")){finalStringtilingS=econdingParameters.get("tiling");
if(tilingS!=null&&Boolean.valueOf(tilingS)){//tileW
if(econdingParameters.containsKey("tilewidth")){finalStringtileW_=econdingParameters.get("tilewidth");
if(tileW_!=null){try{finalinttileW=Integer.valueOf(tileW_);
if(tileW>0&&(tileW%16==0)){tileDimensions.width=tileW;
else{//tilewidthnotsupportedthrownewOWS20Exception("Providedtilewidthisinvalid",ows20Code(WcsExceptionCode.TilingInvalid),Integer.toString(tileW));
if(econdingParameters.containsKey("tileheight")){finalStringtileH_=econdingParameters.get("tileheight");
if(tileH_!=null){try{finalinttileH=Integer.valueOf(tileH_);
if(tileH>0&&(tileH%16==0)){tileDimensions.height=tileH;
else{//tileheightnotsupportedthrownewOWS20Exception("Providedtileheightisinvalid",ows20Code(WcsExceptionCode.TilingInvalid),Integer.toString(tileH));
if(econdingParameters.containsKey("compression")){GeoTiffWriteParamswp=helper.getImageIoWriteParams();helper.disableSourceCopyOptimization();StringcompressionS=econdingParameters.get("compression");
if(compressionS!=null&&!compressionS.equalsIgnoreCase("none")){
if(compressionS.equals("LZW")){wp.setCompressionMode(GeoTiffWriteParams.MODE_EXPLICIT);wp.setCompressionType("LZW");//lookforapredictorStringpredictorS=econdingParameters.get("predictor");
if(predictorS!=null){
if(predictorS.equals("None")){
else
if(predictorS.equals("Horizontal")){wp.setTIFFCompressor(newTIFFLZWCompressor(BaselineTIFFTagSet.PREDICTOR_HORIZONTAL_DIFFERENCING));
else
if(predictorS.equals("Floatingpoint")){//NOTSUPPORTEDYETthrownewOWS20Exception("FloatingPointpredictorisnotsupported",ows20Code(WcsExceptionCode.PredictorNotSupported),predictorS);
else{//invalidpredictorthrownewOWS20Exception("InvalidPredictorprovided",ows20Code(WcsExceptionCode.PredictorInvalid),predictorS);
else
if(compressionS.equals("JPEG")){wp.setCompressionMode(GeoTiffWriteParams.MODE_EXPLICIT);wp.setCompressionType("JPEG");//startwiththedefaultone,visuallylosslesswp.setCompressionQuality(DEFAULT_JPEG_COMPRESSION_QUALITY);//checkquality
if(econdingParameters.containsKey("jpeg_quality")){finalStringquality_=econdingParameters.get("jpeg_quality");
if(quality_!=null){try{finalintquality=Integer.valueOf(quality_);
if(quality>0&&quality<=100){wp.setCompressionQuality(quality/100.f);
else{//invalidqualitythrownewOWS20Exception("Providedqualityvalueforthejpegcompressionininvalid",ows20Code(WcsExceptionCode.JpegQualityInvalid),quality_);
else
if(compressionS.equals("PackBits")){wp.setCompressionMode(GeoTiffWriteParams.MODE_EXPLICIT);wp.setCompressionType("PackBits");
else
if(compressionS.equals("DEFLATE")||compressionS.equals("Deflate")){wp.setCompressionMode(GeoTiffWriteParams.MODE_EXPLICIT);wp.setCompressionType("Deflate");
else
if(compressionS.equals("Huffman")){wp.setCompressionMode(GeoTiffWriteParams.MODE_EXPLICIT);wp.setCompressionType("CCITTRLE");
else{//compressionnotsupportedthrownewOWS20Exception("Providedcompressiondoesnotseemsupported",ows20Code(WcsExceptionCode.CompressionInvalid),compressionS);
if(request!=null){//wfs2.0hasmorerequirementsforexceptioncodesandhandles
if(OwsUtils.has(request,"version")){Objectver=OwsUtils.get(request,"version");Versionversion=Version.negotiate(ver!=null?ver.toString():null);
if(version!=null&&version.compareTo(Version.V_20)<0){returnthis;//not2.0
if(locator==null&&OwsUtils.has(request,"handle")){//checktherequestobjectlocator=(String)OwsUtils.get(request,"handle");
if(locator==null){locator=determineDefaultLocator(request);
if(code==null){code=Code.OperationProcessingFailed.name();
if(requestinstanceofRequestObject){//requestobjectadapterclassName=request.getClass().getSuperclass().getSimpleName();
if(className.endsWith("Request")){returnclassName.substring(0,className.length()-"Request".length());
if(adaptee.getClass().getName().contains("wfs20")){//locatoronlyforWFS20,implementationpackageiscurrentlynet.opengis.wfs20returnclassName;
else
if(className.endsWith("TypeImpl")){//underlyingemfrequestobjectreturnclassName.substring(0,className.length()-"TypeImpl".length());
if(!kvp.containsKey("typenames")&&kvp.containsKey("typename")&&getWFS().isCiteCompliant()&&!kvp.containsKey("STOREDQUERY_ID")){thrownewWFSException("WFS2.0requirestypeNames,nottypeName");
if(formatOptions!=null){for(Objectkey:formatOptions.keySet()){
if(key.toString().toLowerCase().startsWith(PREFIX)){returnnewKmlCentroidOptions(CaseInsensitiveMap.wrap(formatOptions));
ifthe"contain"optionisset.**<p>Thisoptioncausesthecentroidbuildertofindapoint(viasampling
ifnecessary)that*iscontainedwithinapolygongeometry.**@see#getSamples()*/publicbooleanisContain(){returnBoolean.valueOf(raw.getOrDefault(CONTAIN,"false").toString());
ifthe"clip"optionisset.**<p>Thisoptioncausesthecentroidbuildertoclipgeometriesbytherequestboundingbox*beforecomputingthecentroid.*/publicbooleanisClip(){returnBoolean.valueOf(raw.getOrDefault(CLIP,"false").toString());
if(lfr.getFeaturesLocked()==null){lfr.setFeaturesLocked(((WfsFactory)getFactory()).createFeaturesLockedType());
if(lfr.getFeaturesNotLocked()==null){lfr.setFeaturesNotLocked(((WfsFactory)getFactory()).createFeaturesNotLockedType());
if(lfr.getFeaturesLocked()==null){lfr.setFeaturesLocked(((Wfs20Factory)getFactory()).createFeaturesLockedType());
if(lfr.getFeaturesNotLocked()==null){lfr.setFeaturesNotLocked(((Wfs20Factory)getFactory()).createFeaturesNotLockedType());
if(output==null){return0;
if(output==null){output=newMonitorOutputStream(super.getOutputStream());
if(useLegacyGeoServerLoader){BeanDefinitiondef=reader.getBeanFactory().getBeanDefinition("geoServerLoader");def.setBeanClassName("org.geoserver.test.TestGeoServerLoaderProxy");
if(!status.isAvailable()){return;//skiptest
ifloadingfailedwms.setInterpolation(WMSInterpolation.Nearest);
if(cataloginstanceofWrapper)catalog=((Wrapper)catalog).unwrap(Catalog.class);CatalogFactoryfactory=catalog.getFactory();List<Map>baseMaps=(List<Map>)props.get("BaseMapGroups");
if(baseMaps!=null){O:for(MapbaseMap:baseMaps){LayerGroupInfobm=factory.createLayerGroup();bm.setName((String)baseMap.get("baseMapTitle"));//processbasemaplayersList<String>layerNames=(List)baseMap.get("baseMapLayers");for(StringlayerName:layerNames){ResourceInforesource=null;
if(layerName.contains(":")){String[]qname=layerName.split(":");resource=catalog.getResourceByName(qname[0],qname[1],ResourceInfo.class);
else{resource=catalog.getResourceByName(layerName,ResourceInfo.class);
if(resource==null){LOGGER.warning("Ignoringlayergroup'"+bm.getName()+"',resource'"+layerName+"'doesnotexist");continueO;
if(layers.isEmpty()){LOGGER.warning("Ignoringlayergroup'"+bm.getName()+"',nolayerfoundforresource'"+layerName+"'");continueO;
if(styleNames.isEmpty()){//usedefaultsfor(PublishedInfol:bm.getLayers()){bm.getStyles().add(null);
else{for(inti=0;i<styleNames.size();i++){StringstyleName=styleNames.get(i);styleName=styleName.trim();StyleInfostyle=null;
if("".equals(styleName)){style=null;
else{style=catalog.getStyleByName(styleName);
if(e==null){e=newReferencedEnvelope();e.setToNull();
iftheparametervalueis*"index"itissubstitutedby"hits".**<p>AnewentrynamedRESULT_TYPE_INDEXspecifyingthattheoriginalresulttypewas"index"is*addedtoKVPmaps**<p>TheobjectthatmanageresponseoftypeHitsOutputFormatisreplacedwithIndexOutputFormat*beforeresponsehasbeendispatched**@authorsandr*/publicclassIndexResultTypeDispatcherCallbackextendsAbstractDispatcherCallback{privatestaticfinalLoggerLOGGER=Logging.getLogger(IndexResultTypeDispatcherCallback.class);privateGeoServergs;privateIndexConfigurationManagerindexConfiguration;privatestaticfinalStringRESULT_TYPE_PARAMETER="resultType";privatestaticfinalStringRESULT_TYPE_INDEX="index";staticfinalStringRESULT_TYPE_INDEX_PARAMETER="RESULT_TYPE_INDEX";publicIndexResultTypeDispatcherCallback(GeoServergs,IndexConfigurationManagerindexConfiguration){this.gs=gs;this.indexConfiguration=indexConfiguration;
if(resultType!=null&&resultType.toString().equals(RESULT_TYPE_INDEX)){request.getKvp().put(RESULT_TYPE_PARAMETER,ResultTypeType.HITS);request.getKvp().put(RESULT_TYPE_INDEX_PARAMETER,true);
if(request.getKvp().get(RESULT_TYPE_INDEX_PARAMETER)!=null&&(Boolean)request.getKvp().get(RESULT_TYPE_INDEX_PARAMETER)){IndexOutputFormatr=newIndexOutputFormat(this.gs,this.indexConfiguration);r.setRequest(request);newResponse=r;
iftheprincipalequals{@linkGeoServerUser#ROOT_USERNAME}<code>null</code>mustbe*returned.(Nevercachethisuser)**<p>Forpre-authenticationfilters,thenameoftheprincipalissufficient.Allotherfilters*shouldincludesomeinformationderivedfromthecredentials,otherwiseanattackercould*authenticateusingonlytheprincipalinformation.**<p>Asanexample,thederivedinformationcouldbeanmd5checksumofthecredentials**<p>IfthereisanalreadyexistingHTTPSession,thismethodshouldreturn<code>null</code>*IftheHTTPrequestattributenamed*GeoServerSecurityContextPersistenceFilter.ALLOWSESSIONCREATION_ATTRistrue,thismethod*shouldreturn<code>null</code>**@paramrequest*/publicStringgetCacheKey(HttpServletRequestrequest);}
if(lakes!=null&&forests!=null){group.setName(NATURE_GROUP);group.getLayers().add(lakes);group.getLayers().add(forests);group.getStyles().add(null);group.getStyles().add(null);CatalogBuildercb=newCatalogBuilder(catalog);cb.calculateLayerGroupBounds(group);catalog.add(group);
if(nature!=null){containerGroup.setName(CONTAINER_GROUP);containerGroup.setMode(Mode.CONTAINER);containerGroup.getLayers().add(nature);containerGroup.getStyles().add(null);CatalogBuildercb=newCatalogBuilder(catalog);cb.calculateLayerGroupBounds(containerGroup);catalog.add(containerGroup);
if(roadSegments!=null&&neatline!=null){opaqueGroup.setName(OPAQUE_GROUP);opaqueGroup.setMode(Mode.OPAQUE_CONTAINER);opaqueGroup.getLayers().add(roadSegments);opaqueGroup.getLayers().add(neatline);opaqueGroup.getStyles().add(null);opaqueGroup.getStyles().add(null);CatalogBuildercb=newCatalogBuilder(catalog);cb.calculateLayerGroupBounds(opaqueGroup);catalog.add(opaqueGroup);
ifyouwanttousethedefaultstyle)*@returnAnewmaplayer.*/protectedLayercreateMapLayer(QNamelayerName,StringstyleName)throwsIOException{Catalogcatalog=getCatalog();LayerInfolayerInfo=catalog.getLayerByName(layerName.getLocalPart());Stylestyle=layerInfo.getDefaultStyle().getStyle();
if(styleName!=null){style=catalog.getStyleByName(styleName).getStyle();
if(info!=null){FeatureSource<?extendsFeatureType,?extendsFeature>featureSource;featureSource=info.getFeatureSource(null,null);layer=newFeatureLayer(featureSource,style);
else{//tryacoverageCoverageInfocinfo=catalog.getCoverageByName(layerName.getNamespaceURI(),layerName.getLocalPart());GridCoverage2Dcov=(GridCoverage2D)cinfo.getGridCoverage(null,null);layer=newGridCoverageLayer(cov,style);
if(layer==null){thrownewIllegalArgumentException("Couldnotfindlayerfor"+layerName);
ifsomethinggoeswrong*@paramimagetheimgagetocheckitisnot"blank"*@parambgColorthebackgroundcolorforwhichdifferingpixelsarelookedfor*/protectedvoidassertNotBlank(StringtestName,BufferedImageimage,ColorbgColor){intpixelsDiffer=countNonBlankPixels(testName,image,bgColor);assertTrue(testName+"imageiscomlpetelyblank",0<pixelsDiffer);
ifsomethinggoeswrong*@paramimagetheimagetocheckitisnot"blank"*@parambgColorthebackgroundcolorforwhichdifferingpixelsarelookedfor*/protectedvoidassertBlank(StringtestName,BufferedImageimage,ColorbgColor){intpixelsDiffer=countNonBlankPixels(testName,image,bgColor);assertEquals(testName+"imageiscompletelyblank",0,pixelsDiffer);
if(image.getRGB(x,y)!=bgColor.getRGB()){++pixelsDiffer;
if(((System.getProperty("java.awt.headless")==null)||!System.getProperty("java.awt.headless").equals("true"))&&INTERACTIVE){Frameframe=newFrame(frameName);frame.addWindowListener(newWindowAdapter(){publicvoidwindowClosing(WindowEvente){e.getWindow().dispose();
if(width>0){assertEquals(width,image.getWidth());
if(height>0){assertEquals(height,image.getHeight());
if(rootLayer!=null){group.setRootLayer(rootLayer);group.setRootLayerStyle(rootLayer.getDefaultStyle());
if(!next.enabled()||next.getName().equals(MockData.GEOMETRYLESS.getLocalPart())){it.remove();
if(!p.getValidationErrors().isEmpty()){for(Iteratore=p.getValidationErrors().iterator();e.hasNext();){SAXParseExceptionex=(SAXParseException)e.next();System.out.println(ex.getLineNumber()+","+ex.getColumnNumber()+"-"+ex.toString());
ifthedifferencebetweenthemisinferiororequaltothe*providedprecision.**@paramrawValuerawvaluethatshouldcontainanumber*@paramexpectedtheexpectednumericvalue*@paramprecisionprecisionthatshouldbeusedtocomparethetwovalues*/publicstaticvoidcheckNumberSimilar(StringrawValue,doubleexpected,doubleprecision){//trytoextractadoublevalueassertThat(rawValue,is(notNullValue()));assertThat(rawValue.trim().isEmpty(),is(false));doublevalue=0;try{value=Double.parseDouble(rawValue);
ifwehaveanythingtoimportprovider=newWMTSLayerProvider();provider.setStoreId(storeId);
if(provider.size()<=0){error(newParamResourceModel("storeEmpty",this,store.getName(),store.getWorkspace().getName()).getString());
if(property==WMTSLayerProvider.NAME){returnnewLabel(id,property.getModel(itemModel));
else
if(property==WMTSLayerProvider.STATUS){Fragmentf=newFragment(id,"labelIcon",WMTSLayerImporterPage.this);f.add(newImage("icon",newIconModel(itemModel)));f.add(newLabel("label",newStatusModel(itemModel)));returnf;
else
if(property==WMTSLayerProvider.ACTION){finalLayerResourceresource=(LayerResource)itemModel.getObject();finalLayerStatusstatus=resource.getStatus();
if(status==LayerStatus.PUBLISHED||status==LayerStatus.NEWLY_PUBLISHED||status==LayerStatus.UPDATED){returnresourceChooserLink(id,itemModel,newParamResourceModel("NewLayerPage.publishAgain",this));
else{returnresourceChooserLink(id,itemModel,newParamResourceModel("NewLayerPage.publish",this));
ifnothingwasselectedweneedtogoback
if(selection.size()==0){error(newParamResourceModel("selectionEmpty",WMTSLayerImporterPage.this).getString());
else{publishLayers(selection);
if(exists!=null){//TODOwhattodo
iflayeralreadyexists?builder.updateWMTSLayer(exists,wli);layer.setStatus(LayerStatus.UPDATED);updateCount++;
else{try{catalog.add(wli);catalog.add(li);layer.setStatus(LayerStatus.NEWLY_PUBLISHED);importCount++;
if(importCount>0){info("Succesfullyimported"+importCount+"layers");
else{info("Nonewlayerswereimported");
if(updateCount>0){info("Updated"+updateCount+"layers");
if(errorCount>0){error("Unabletoimport"+errorCount+"layers,youmaywanttoimportthemmanually");
if(resource.getStatus()==LayerStatus.ERROR){returnnewPackageResourceReference(GeoServerBasePage.class,"img/icons/silk/error.png");
else
if(resource.getStatus()==LayerStatus.NEW){returnnewPackageResourceReference(GeoServerBasePage.class,"img/icons/silk/add.png");
else
if(resource.getStatus()==LayerStatus.NEWLY_PUBLISHED){returnCatalogIconFactory.ENABLED_ICON;
else
if(resource.getStatus()==LayerStatus.UPDATED){returnnewPackageResourceReference(GeoServerBasePage.class,"img/icons/silk/pencil.png");
else
if(resource.getStatus()==LayerStatus.PUBLISHED){returnCatalogIconFactory.MAP_ICON;
else{returnnull;
if(signalArgs!=null&&signalArgs.get("topic")!=null)returnsignalArgs.get("topic").equals("loadavg");returnfalse;
if(pID!=null&&pID.equalsIgnoreCase("master")&&msg!=null&&msg.equals("loadavg")){Map<String,Object>outputs=newHashMap<String,Object>();try{finalList<RemoteMachineDescriptor>registeredProcessingMachines=xmppClient.getRegisteredProcessingMachines();synchronized(registeredProcessingMachines){RemoteMachineDescriptorregisteredProcessingMachine=null;for(RemoteMachineDescriptornode:registeredProcessingMachines){
if(serviceJID.equals(node.getNodeJID())){registeredProcessingMachine=node;registeredProcessingMachine.setAvailable(true);break;
if(registeredProcessingMachine!=null){for(Entry<String,String>result:signalArgs.entrySet()){
if(result.getKey().startsWith("result_")){finalStringkey=result.getKey().substring("result_".length());finalStringserviceResultString=URLDecoder.decode(result.getValue(),"UTF-8");finalJSONObjectserviceResultJSON=(JSONObject)JSONSerializer.toJSON(serviceResultString);finalObjectoutput=xmppClient.unPickle(xmppClient.pickle(serviceResultJSON));//XMPPOutputVisitor
if(outputinstanceofMap){Map<String,Object>resultParams=(Map<String,Object>)output;//transformthetextualvalueintoarealWPS//outputtry{finalObjectvalue=(resultParams.get(key+"_value")!=null?resultParams.get(key+"_value"):null);finalStringdescription=(resultParams.get(key+"_description")!=null&&resultParams.get(result.getKey()+"_description")instanceofString?(String)resultParams.get(key+"_description"):null);
if("vmem".equalsIgnoreCase(key)){registeredProcessingMachine.setMemPercUsed((Double)value);
if("loadavg".equalsIgnoreCase(key)){registeredProcessingMachine.setLoadAverage((Double)value);
if(encodingParameters!=null&&!encodingParameters.isEmpty()&&encodingParameters.containsKey(QUALITY_KEY)){StringcompressionQuality=(String)encodingParameters.get(QUALITY_KEY);try{quality=Float.parseFloat(compressionQuality);
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Specifiedqualityisnotvalid(itshouldbeintherange[0,1])."+"quality="+compressionQuality+"\nUsingdefaultQuality:"+DEFAULT_QUALITY);
if(format==null){thrownewRuntimeException("Noformatfor"+obj);
if(reader==null){thrownewRuntimeException("Noreaderfor"+cs.getURL());
if(srs==null){srs=real.getSRS();
if(getClass().getResourceAsStream(filename)==null){returnthis;
if(layerName.equals(layer.getName())){l=layer;break;
if(l==null){thrownewRuntimeException("Nosuchlayer:"+layerName);
if(styleNames!=null){StringstyleName=styleNames.get(i);for(StyleInfostyle:styles){
if(styleName.equals(style.getName())){s=style;break;
if(!featureTypes.isEmpty()||!coverages.isEmpty()){
if(!featureTypes.isEmpty()){DataStoreInfods=dataStores.peekLast();expect(catalog.getResourcesByStore(ds,FeatureTypeInfo.class)).andReturn(featureTypes).anyTimes();expect(catalog.getResourcesByStore(ds,ResourceInfo.class)).andReturn((List)featureTypes).anyTimes();expect(catalog.getFeatureTypesByDataStore(ds)).andReturn(featureTypes).anyTimes();
if(!coverages.isEmpty()){CoverageStoreInfocs=coverageStores.peekLast();expect(catalog.getResourcesByStore(cs,CoverageInfo.class)).andReturn(coverages).anyTimes();expect(catalog.getResourcesByStore(cs,ResourceInfo.class)).andReturn((List)coverages).anyTimes();expect(catalog.getCoveragesByCoverageStore(cs)).andReturn(coverages).anyTimes();
else
if(!dataStores.isEmpty()||!coverageStores.isEmpty()){WorkspaceInfows=workspaces.peekLast();NamespaceInfons=namespaces.peekLast();expect(catalog.getStoresByWorkspace(ws.getName(),DataStoreInfo.class)).andReturn(dataStores).anyTimes();expect(catalog.getStoresByWorkspace(ws,DataStoreInfo.class)).andReturn(dataStores).anyTimes();expect(catalog.getDataStoresByWorkspace(ws.getName())).andReturn(dataStores).anyTimes();expect(catalog.getDataStoresByWorkspace(ws)).andReturn(dataStores).anyTimes();expect(catalog.getStoresByWorkspace(ws.getName(),CoverageStoreInfo.class)).andReturn(coverageStores).anyTimes();expect(catalog.getStoresByWorkspace(ws,CoverageStoreInfo.class)).andReturn(coverageStores).anyTimes();expect(catalog.getCoverageStoresByWorkspace(ws.getName())).andReturn(coverageStores).anyTimes();expect(catalog.getCoverageStoresByWorkspace(ws)).andReturn(coverageStores).anyTimes();List<StoreInfo>l=newLinkedList<StoreInfo>(dataStores);l.addAll(coverageStores);expect(catalog.getStoresByWorkspace(ws.getName(),StoreInfo.class)).andReturn(l).anyTimes();expect(catalog.getStoresByWorkspace(ws,StoreInfo.class)).andReturn(l).anyTimes();expect(catalog.getStylesByWorkspace(ws.getName())).andReturn(styles).anyTimes();expect(catalog.getStylesByWorkspace(ws)).andReturn(styles).anyTimes();expect(catalog.getLayerGroupsByWorkspace(ws.getName())).andReturn(layerGroups).anyTimes();expect(catalog.getLayerGroupsByWorkspace(ws)).andReturn(layerGroups).anyTimes();//addalltheresourcesforthisworkspaceList<ResourceInfo>m=newLinkedList(featureTypesByNamespace);m.addAll(coveragesByNamespace);expect(catalog.getResourcesByNamespace(ns,ResourceInfo.class)).andReturn(m).anyTimes();//expect(catalog.getResourcesByNamespace(ns.getPrefix(),//ResourceInfo.class)).andReturn(m).anyTimes();expect(catalog.getResourcesByNamespace(ns,FeatureTypeInfo.class)).andReturn(featureTypesByNamespace).anyTimes();//expect(catalog.getResourcesByNamespace(ns.getPrefix(),FeatureTypeInfo.class))//.andReturn(featureTypesByNamespace).anyTimes();expect(catalog.getResourcesByNamespace(ns,CoverageInfo.class)).andReturn(coveragesByNamespace).anyTimes();//expect(catalog.getResourcesByNamespace(ns.getPrefix(),CoverageInfo.class))//.andReturn(coveragesByNamespace).anyTimes();dataStoresAll.addAll(dataStores);dataStores=newLinkedList();coverageStoresAll.addAll(coverageStores);coverageStores=newLinkedList();featureTypesAll.addAll(featureTypesByNamespace);featureTypesByNamespace=newLinkedList();coveragesAll.addAll(coveragesByNamespace);coveragesByNamespace=newLinkedList();
else
if(!workspaces.isEmpty()){//alltheresourcesList<ResourceInfo>l=newLinkedList<ResourceInfo>(featureTypesAll);l.addAll(coveragesAll);expect(catalog.getResources(ResourceInfo.class)).andReturn(l).anyTimes();expect(catalog.getResources(FeatureTypeInfo.class)).andReturn(featureTypesAll).anyTimes();expect(catalog.getResources(CoverageInfo.class)).andReturn(coverages).anyTimes();expect(catalog.getFeatureTypes()).andReturn(featureTypesAll).anyTimes();expect(catalog.getCoverages()).andReturn(coveragesAll).anyTimes();//addallthestoresList<StoreInfo>m=newLinkedList<StoreInfo>(dataStoresAll);m.addAll(coverageStoresAll);expect(catalog.getStores(StoreInfo.class)).andReturn(m).anyTimes();expect(catalog.getStores(DataStoreInfo.class)).andReturn(dataStoresAll).anyTimes();expect(catalog.getStores(CoverageStoreInfo.class)).andReturn(coverageStoresAll).anyTimes();//addallthelayersexpect(catalog.getLayers()).andReturn(layers).anyTimes();//addallthestylesexpect(catalog.getStyles()).andReturn(styles).anyTimes();//addallthelayergroupsexpect(catalog.getLayerGroups()).andReturn(layerGroups).anyTimes();//addalltheworkspaces/namespacesexpect(catalog.getWorkspaces()).andReturn(workspaces).anyTimes();expect(catalog.getNamespaces()).andReturn(namespaces).anyTimes();//defaultworkspace/namespaceexpect(catalog.getDefaultWorkspace()).andReturn(workspaces.peekFirst()).anyTimes();expect(catalog.getDefaultNamespace()).andReturn(namespaces.peekFirst()).anyTimes();replay(catalog);featureTypesAll=newLinkedList();coveragesAll=newLinkedList();dataStoresAll=newLinkedList();coverageStoresAll=newLinkedList();styles=newLinkedList();workspaces=newLinkedList();namespaces=newLinkedList();
if(p.getDescriptor().getType()==CSWRecordDescriptor.SIMPLE_LITERAL){Objectvalue=((ComplexAttribute)p).getProperty("value").getValue();list.add(value);
switch(list){case"available":LOGGER.fine(()->logMessage("GETavailableWMSlayersfrom",workspaceName,storeName,null));returnnewAvailableResources(getAvailableLayersInternal(workspaceName,storeName,quietOnNotFound),"wmsLayerName");case"configured":LOGGER.fine(()->logMessage("GETconfiguredWMSlayersfrom",workspaceName,storeName,null));returnwrapList(getConfiguredLayersInternal(workspaceName,storeName,quietOnNotFound),WMSLayerInfo.class);default:thrownewRestException("Unknownlisttype"+list,HttpStatus.NOT_IMPLEMENTED);
if(Objects.nonNull(storeName)){returnCollections.singleton(getStoreInternal(ns,storeName));
else{returncatalog.getStoresByWorkspace(ns.getPrefix(),WMSStoreInfo.class);
if(Objects.isNull(workspaceName)){thrownewNullPointerException();
else{NamespaceInfons=catalog.getNamespaceByPrefix(workspaceName);
if(Objects.isNull(ns)){thrownewResourceNotFoundException("Couldnotfindworkspace"+workspaceName);
else{returnns;
if(Objects.isNull(storeName)){thrownewNullPointerException();
else{returncatalog.getStoreByName(ns.getPrefix(),storeName,WMSStoreInfo.class);
if(Objects.isNull(layerName)){thrownewNullPointerException();
else
if(Objects.isNull(storeName)){layer=catalog.getResourceByName(ns,layerName,WMSLayerInfo.class);
if(Objects.isNull(layer)){thrownewResourceNotFoundException("Nosuchcascadedwms:"+workspaceName+","+layerName);
else{returnlayer;
else{WMSStoreInfostore=getStoreInternal(ns,storeName);layer=catalog.getResourceByStore(store,layerName,WMSLayerInfo.class);
if(Objects.isNull(layer)){thrownewResourceNotFoundException("Nosuchcascadedwms:"+workspaceName+","+layerName);
else{returnlayer;
if(recurse){//byrecurseweclearoutallthelayersthatpublicthisresourcefor(LayerInfol:layers){catalog.remove(l);LOGGER.info("DELETElayer"+l.getName());
else{
if(!layers.isEmpty()){thrownewRestException("wmslayerreferencedbylayer(s)",HttpStatus.FORBIDDEN);
if(resource.getStore()!=null){
if(Objects.nonNull(storeName)&&!Objects.equals(storeName,resource.getStore().getName())){thrownewRestException("Expectedwmsstore"+storeName+"butclientspecified"+resource.getStore().getName(),HttpStatus.FORBIDDEN);
else{store=getStoreInternal(ns,storeName);resource.setStore(store);
if(resource.getNamespace()!=null){
if(!workspaceName.equals(resource.getNamespace().getPrefix())){thrownewRestException("Expectedworkspace"+workspaceName+"butclientspecified"+resource.getNamespace().getPrefix(),HttpStatus.FORBIDDEN);
else{resource.setNamespace(catalog.getNamespaceByPrefix(workspaceName));
if(foundns!=null&&!foundns.getPrefix().equals(workspaceName)){LOGGER.warning("Namespace:"+ns.getPrefix()+"doesnotmatchworkspace:"+workspaceName+",overriding.");foundns=null;
if(foundns==null){//inferfromworkspaceresource.setNamespace(ns);
if(workspaceName==null||storeName==null||layerName==null){returnnull;
if(store==null){returnnull;
if(objinstanceofNamespaceInfo){NamespaceInfons=(NamespaceInfo)obj;converter.encodeLink("/namespaces/"+converter.encode(ns.getPrefix()),writer);
if(objinstanceofWMSStoreInfo){WMSStoreInfostore=(WMSStoreInfo)obj;converter.encodeLink("/workspaces/"+converter.encode(store.getWorkspace().getName())+"/wmsstores/"+converter.encode(store.getName()),writer);
if(jndi){tester.assertComponent(base+"jndiName",TextField.class);tester.assertVisible(base+"jndiName");
else{for(Stringc:Arrays.asList(newString[]{"driverClassName","connectURL","userName","password"})){tester.assertComponent(base+c,FormComponent.class);tester.assertVisible(base+c);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofLoggingInfo)){returnfalse;
if(level==null){
if(other.getLevel()!=null)returnfalse;
else
if(!level.equals(other.getLevel()))returnfalse;
if(location==null){
if(other.getLocation()!=null)returnfalse;
else
if(!location.equals(other.getLocation()))returnfalse;
if(stdOutLogging!=other.isStdOutLogging())returnfalse;returntrue;}}
if(params.length==0){returnnewEditServiceAccessRulePage(newServiceAccessRule());
elsereturnnewEditServiceAccessRulePage((ServiceAccessRule)params[0]);
if("wms".equals(rule.getService())&&"GetMap".equals(rule.getMethod()))returnrule.getKey();
if(uploadResource!=null){thrownewIllegalStateException("TheuploadIdwasalreadyset!");
else{createUploadResource(filePath,uploadId);
if(raf!=null){raf.close();
ifsuccessivestartpositionindexmatches*actualpartialfilelength*/publicBooleanvalidateUpload(StringuploadId,LongtotalByteToUpload,LongstartPosition,LongendPosition,LongtotalFileSize){Booleanvalidated=false;ResumableUploadResourceuploadResource=getResource(uploadId);
if(uploadResource!=null&&uploadResource.getFile().exists()){
if(uploadResource.getFile().length()==startPosition){validated=true;
if(resource!=null){resource.clear();
if(file.lastModified()<expirationThreshold){file.delete();
ifuploadwithuploadIdisterminated:</br>**<ul>*<li>ifresourceexistsintempfoldertheuploadisnotterminate*<li>ifsidecarfileexistsintempfoldertheuploadisterminated*<li>ifnoresourceorsidecarisfoundtheresourceisunknown*</ul>*/publicBooleanisUploadDone(StringuploadId)throwsIOException,IllegalStateException{ResumableUploadResourceresource=getResource(uploadId);
if(resource!=null){returnfalse;
else{
if(getSideCarFile(uploadId).exists()){returntrue;
else{thrownewIllegalStateException("Resourceuploadednotfound");
if(files.size()==1){returnnewResumableUploadResource(uploadId,files.iterator().next());
if(files.size()>1){thrownewIllegalStateException("FoundmultiplefileswithsameuploadId");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Associatingresourcewithuploadid:"+id);
if(this.file.exists()){this.file.delete();
if(this.file.exists()){this.file.delete();
if(message==null)thrownewNullPointerException("Messagecannotbenull");
if(argument==null)thrownewNullPointerException(message+"cannotbenull");}}
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;ProcessInfoImplother=(ProcessInfoImpl)obj;
if(enabled==null){
if(other.enabled!=null)returnfalse;
else
if(!enabled.equals(other.enabled))returnfalse;
if(id==null){
if(other.id!=null)returnfalse;
else
if(!id.equals(other.id))returnfalse;
if(metadata==null){
if(other.metadata!=null)returnfalse;
else
if(!metadata.equals(other.metadata))returnfalse;
if(name==null){
if(other.name!=null)returnfalse;
else
if(!name.equals(other.name))returnfalse;
if(roles==null){
if(other.roles!=null)returnfalse;
else
if(!roles.equals(other.roles))returnfalse;
if(validators==null){
if(other.validators!=null)returnfalse;
else
if(!validators.equals(other.validators))returnfalse;returntrue;
if(signalArgs!=null&&signalArgs.get("topic")!=null)returnsignalArgs.get("topic").equals("register");returnfalse;
if(serviceName.length<=1)return;finalNamename=newNameImpl(serviceName[0],serviceName[1]);try{StringserviceDescriptorString=URLDecoder.decode(signalArgs.get("message"),"UTF-8");JSONObjectserviceDescriptorJSON=(JSONObject)JSONSerializer.toJSON(serviceDescriptorString);finalStringtitle=(String)serviceDescriptorJSON.get("title");finalStringdescription=(String)serviceDescriptorJSON.get("description");JSONArrayinput=(JSONArray)serviceDescriptorJSON.get("input");JSONArrayoutput=(JSONArray)serviceDescriptorJSON.get("output");//INPUTSMap<String,Parameter<?>>inputs=newLinkedHashMap<String,Parameter<?>>();
if(input!=null){for(intii=0;ii<input.size();ii++){finalObjectobj=input.get(ii);
if(objinstanceofJSONArray){finalJSONArrayjsonArray=(JSONArray)obj;finalStringparamName=(String)jsonArray.get(0);Stringss=((String)jsonArray.get(1));ss=ss.substring(1,ss.length()-1);finalJSONObjectparamType=(JSONObject)JSONSerializer.toJSON(ss);finalStringclassName=(String)paramType.get("type");finalParameterTemplateparamTemplate=xmppClient.convertToJavaClass(className,XMPPClient.class.getClassLoader(),paramType.get("default"));finalStringchoosenInputMimeTypeParam=paramName+"InputMimeType";
if(paramTemplate.getMeta()!=null&&paramTemplate.getMeta().get("mimeTypes")!=null&&(paramType.get("input_mime_type")instanceofString)){paramTemplate.getMeta().put("chosenMimeType",choosenInputMimeTypeParam);finalParameterinputChoosenMimeTypeParam=newParameter(choosenInputMimeTypeParam,String.class,Text.text(""),Text.text(""),false,0,1,paramType.get("input_mime_type").toString(),null);inputs.put(choosenInputMimeTypeParam,inputChoosenMimeTypeParam);
if(output!=null){for(intoo=0;oo<output.size();oo++){Objectobj=output.get(oo);
if(objinstanceofJSONArray){finalJSONArrayjsonArray=(JSONArray)obj;finalStringparamName=(String)jsonArray.get(0);Stringss=((String)jsonArray.get(1));ss=ss.substring(1,ss.length()-1);finalJSONObjectparamType=(JSONObject)JSONSerializer.toJSON(ss);finalStringclassName=(String)paramType.get("type");ParameterTemplateparamTemplate=xmppClient.convertToJavaClass(className,XMPPClient.class.getClassLoader(),paramType.get("default"));finalStringchoosenOutputMimeTypeParam=paramName+"OutputMimeType";
if(paramTemplate.getMeta()!=null&&paramTemplate.getMeta().get("mimeTypes")!=null&&(paramType.get("output_mime_type")instanceofString)){paramTemplate.getMeta().put("chosenMimeType",choosenOutputMimeTypeParam);finalParameteroutputChoosenMimeTypeParam=newParameter(choosenOutputMimeTypeParam,String.class,Text.text(""),Text.text(""),false,0,1,paramType.get("output_mime_type").toString(),null);outputs.put(choosenOutputMimeTypeParam,outputChoosenMimeTypeParam);
if(externalRoot==null||externalRoot.isEmpty()){return;
ifpresentrootDir.append(externalRoot);//NOTEthateachdirectoryendswiththedirectorynameandnotwithapathseparator//AppendingtheWorkspacedirectory
ifpresent
if(workspace!=null&&!workspace.isEmpty()){rootDir.append(File.separator);rootDir.append(workspace);
ifpresent
if(store!=null&&!store.isEmpty()){rootDir.append(File.separator);rootDir.append(store);
if(propertyNames.contains("jAI")){//TODO:checkwhythepropertynameisreportedasjAI//insteadofJAI//MakesuretoproceedwithJAIinit//onlyincasetheglobalchangeinvolvedthatsectioninitJAI(global.getJAI());
if(ImageWorker.isJaiExtEnabled()){
if(jai.getJAIEXTInfo()!=null){JAIEXTInfojaiext=jai.getJAIEXTInfo();Set<String>jaiOperations=jaiext.getJAIOperations();Set<String>jaiExtOperations=jaiext.getJAIEXTOperations();
if(jaiOperations!=null&&!jaiOperations.isEmpty()){JAIExt.registerOperations(jaiOperations,false);for(StringopName:jaiOperations){//RemoveoperationswitholddescriptorsCoverageProcessor.removeOperationFromProcessors(opName);JAIExt.setJAIAcceleration(opName,true);
if(jaiExtOperations!=null&&!jaiExtOperations.isEmpty()){Set<String>newJai=newTreeSet<String>(jaiExtOperations);
if(jaiOperations!=null&&!jaiOperations.isEmpty()){newJai.removeAll(jaiOperations);
if(!JAIExt.isJAIExtOperation(opName)){//RemoveoperationswitholddescriptorsCoverageProcessor.removeOperationFromProcessors(opName);
if(jai.isRecycling()&&!(jaiDef.getRenderingHint(JAI.KEY_TILE_FACTORY)instanceofConcurrentTileFactory)){finalConcurrentTileFactoryrecyclingFactory=newConcurrentTileFactory();jaiDef.setRenderingHint(JAI.KEY_TILE_FACTORY,recyclingFactory);jaiDef.setRenderingHint(JAI.KEY_TILE_RECYCLER,recyclingFactory);
else{
if(!jai.isRecycling()){finalPassThroughTileFactorypassThroughFactory=newPassThroughTileFactory();jaiDef.setRenderingHint(JAI.KEY_TILE_FACTORY,passThroughFactory);jaiDef.setRenderingHint(JAI.KEY_TILE_RECYCLER,passThroughFactory);
if(eventinstanceofJMSGlobalModifyEvent)returntrue;
elsereturnfalse;
switchtothemiluserSecurityContextHolder.getContext().setAuthentication(milUser);//...directaccessavailableforforestsassertNotNull(sc.getLayerByName(forestsLayer.prefixedName()));assertNull(sc.getLayerByName(statesLayer.prefixedName()));assertNull(sc.getLayerByName(roadsLayer.prefixedName()));//...howeverasmilviagroupaccesswecanseealllayersLayerGroupInfosecuredNamedGroup=sc.getLayerGroupByName(NAMED_GROUP_NAME);assertEquals(3,securedNamedGroup.layers().size());LayerGroupInfosecuredOpaqueGroup=sc.getLayerGroupByName(OPAQUE_GROUP_NAME);assertEquals(2,securedOpaqueGroup.layers().size());
if(propertyValue.equals("UNKNOWN"))returnnull;return"Bean:"+propertyValue;
if(wmsInfo!=null){geoServer.remove(wmsInfo);
if(userFilter==null||userFilter.equals("")){//authenticateusingdnreturnsuper.authenticate(authentication);
else{returnauthenticateUsingFilter(authentication);
ifrequired
if(userFormat!=null&&!userFormat.equals("")){username=MessageFormat.format(userFormat,username);
if(!StringUtils.hasLength(password)){logger.debug("Rejectingemptypasswordforuser"+username);thrownewBadCredentialsException(messages.getMessage("BindAuthenticator.emptyPassword","EmptyPassword"));
if(ppolicy!=null){user.setAttributeValue(ppolicy.getID(),ppolicy);
ifaninvalidusernameisusedandthe//methodmay//becalledmultipletimestotrydifferentnames,sowetrapthe//exception//unlessasubclasswishestoimplementmorespecializedbehaviour.
if((einstanceoforg.springframework.ldap.AuthenticationException)||(einstanceoforg.springframework.ldap.OperationNotSupportedException)){handleBindException(userDnStr,username,e);
else{throwe;
if(user==null){thrownewBadCredentialsException(messages.getMessage("BindAuthenticator.badCredentials","Badcredentials"));
if(result!=0){returnresult;
ifwewereinproductionallthetime)System.setProperty("wicket.configuration","deployment");//makesurethatwechecktheenglishi18nwhenneededLocale.setDefault(Locale.ENGLISH);GeoServerApplicationapp=(GeoServerApplication)applicationContext.getBean("webApplication");tester=newWicketTester(app,false);app.init();
if(tester!=null&&!tester.getFeedbackMessages(IFeedbackMessageFilter.ALL).isEmpty()){tester.cleanupFeedbackMessages();
ifenabled,thecomponentclassesareprintedaswell*@paramdumpValue
ifenabled,thecomponentvaluesareprintedaswell*/publicvoidprint(Componentc,booleandumpClass,booleandumpValue){
if(isQuietTests()){return;
ifenabled,thecomponentclassesareprintedaswell*@paramdumpValue
ifenabled,thecomponentvaluesareprintedaswell*/publicvoidprint(Componentc,booleandumpClass,booleandumpValue,booleandumpPath){
if(isQuietTests()){return;
ifanycomponentwilldo*/publicComponentfindComponentByContent(MarkupContainerroot,Objectcontent,Class<?>componentClass){ComponentContentFinderfinder=newComponentContentFinder(content);root.visitChildren(componentClass,finder);returnfinder.candidate;
if(content.equals(component.getDefaultModelObject())){this.candidate=component;visit.stop();
if(binstanceofAjaxEventBehavior&&((AjaxEventBehavior)b).getEvent().equals(event)){return(AjaxEventBehavior)b;
ifthepropertyfileispresent
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Checkingpropertiesfile");
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,e.getMessage(),e);
if(properties==null||!properties.exists()){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Propertiesfilenotfound");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Copyingthedefaultpropertiesfileinsidethedatadirectory");
if(url!=null){properties=loader.createFile(PROPERTYFILENAME);loader.copyFromClassPath(DEFAULT_PROPERTY_PATH,properties,RemoteProcessFactoryConfigurationWatcher.class);
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,e.getMessage(),e);
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Propertiesfilefound");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Loadingconfiguration");
if(newConfiguration!=null){configuration=newConfiguration;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Newconfigurationloaded:\n"+configuration);
if(file.exists()&&file.canRead()){//loadcontentsPropertiesproperties=watcher.getProperties();//parsecontentsnewConfiguration=parseConfigurationValues(properties);
else{
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Unabletoreadconfgurationfileforremoteprocessfactory:"+file.getAbsolutePath()+"continuingwithdefaultconfiguration-->\n"+configuration);
if(LOGGER.isLoggable(Level.INFO)){LOGGER.log(Level.INFO,e.getLocalizedMessage(),e);
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Unabletoreadconfgurationfileforremoteprocessfactory:"+file.getAbsolutePath()+"continuingwithdefaultconfiguration-->\n"+configuration);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Parsingthepropertiesfile");
if(prop.equalsIgnoreCase(RemoteProcessFactoryConfiguration.DEFAULT_SLEEP_TIME_NAME)){//getvalueStringvalue=(String)remoteProcessFactoryProperties.get(RemoteProcessFactoryConfiguration.DEFAULT_SLEEP_TIME_NAME);//checkandassigntry{finallongparseLong=Long.parseLong(value);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("maxFeaturesparsedto"+parseLong);
if(parseLong>0){remoteProcessStubCycleSleepTime=parseLong;
if(LOGGER.isLoggable(Level.INFO)){LOGGER.log(Level.INFO,e.getLocalizedMessage(),e);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("remoteProcessStubCycleSleepTimeassignedto"+remoteProcessStubCycleSleepTime);
else{configKvPs.put(prop,remoteProcessFactoryProperties.getProperty(prop));
if(watcher.isStale()){//reloadRemoteProcessFactoryConfigurationnewConfiguration=loadConfiguration();
if(newConfiguration!=null){synchronized(newConfiguration){configuration=newConfiguration;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Newconfigurationloaded:\n"+configuration);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,t.getLocalizedMessage(),t);
if*youdomodifyanythinginthisclass(especiallythemodels),manuallyretestthattheeditsare*notlostontabswitch.*/@SuppressWarnings("serial")publicabstractclassAbstractStylePageextendsGeoServerSecuredPage{staticfinalPatternHEX_COLOR=Pattern.compile("^#(?:[0-9a-fA-F]{3}){1,2}$");staticclassChooseColorPanelextendsPanel{finalTextField<String>chooser;finalStringinitialColor;publicChooseColorPanel(Stringid,StringinitialColor){super(id);chooser=newTextField<>("chooser",newModel<>());chooser.setOutputMarkupId(true);this.initialColor=initialColor;add(chooser);
if(ArrayUtils.contains(styleHandler().imageExtensions(),FilenameUtils.getExtension(r.name()).toLowerCase())){imageSet.add(r.name());
if(imageModel.getObject()!=null){try{returnnewFileSystemResourceReference(imageModel.getObject(),FileSystemResourceReference.getPath(stylesDir.resolve(imageModel.getObject())));
else{returnnull;
if(image.getConvertedInput()==null&&(upload.getConvertedInput()==null||upload.getConvertedInput().isEmpty())){form.error(newParamResourceModel("missingImage",getPage()).getString());
if(style!=null){layers=catalog.getLayers(style);
if(layers.size()>0){layerModel=newModel<LayerInfo>(layers.get(0));return;
if(defaultWs!=null){DataStoreInfodefaultStore=catalog.getDefaultDataStore(defaultWs);
if(defaultStore!=null){List<ResourceInfo>resources=catalog.getResourcesByStore(defaultStore,ResourceInfo.class);for(ResourceInforesource:resources){layers=catalog.getLayers(resource);
if(layers.size()>0){layerModel=newModel<LayerInfo>(layers.get(0));return;
if(layers.size()>0){layerModel=newModel<LayerInfo>(layers.get(0));return;
if(style==null){styleModel=newCompoundPropertyModel<StyleInfo>(getCatalog().getFactory().createStyle());styleModel.getObject().setName("");styleModel.getObject().setLegend(getCatalog().getFactory().createLegend());
else{
if(style.getLegend()==null){style.setLegend(getCatalog().getFactory().createLegend());
if(style!=null){tabs.add(publishingTab);tabs.add(previewTab);tabs.add(attributeTab);
if(tabPanelInfo.isEnabledOnNew()||style!=null){
if(titleKey!=null){titleModel=neworg.apache.wicket.model.ResourceModel(titleKey);
else{titleModel=newModel<String>(tabPanelInfo.getComponentClass().getSimpleName());
if(getLayerInfo()==null||getLayerInfo().getId()==null){
switch(index){case1:tabbedPanel.error("CannotshowPublishingoptions:NoLayersavailable.");addFeedbackPanels(target);return;case2:tabbedPanel.error("CannotshowLayerPreview:NoLayersavailable.");addFeedbackPanels(target);return;case3:tabbedPanel.error("CannotshowAttributePreview:NoLayersavailable.");addFeedbackPanels(target);return;default:break;
if(Strings.isEmpty(imageFileName)){FileUploadfu=imagePanel.getFileUpload();imageFileName=fu.getClientFileName();intteller=0;GeoServerDataDirectorydd=GeoServerApplication.get().getBeanOfType(GeoServerDataDirectory.class);Resourceres=dd.getStyles(style.getWorkspace(),imageFileName);while(Resources.exists(res)){imageFileName=FilenameUtils.getBaseName(fu.getClientFileName())+"."+(++teller)+"."+FilenameUtils.getExtension(fu.getClientFileName());res=dd.getStyles(style.getWorkspace(),imageFileName);
if(cmSelection!=null){defaultColor=cmSelection.toString();
else{defaultColor="#000";
if(chosenColor!=null){//it'seasytodoubleclickacolorintheeditor,butit//won'tselectthe#,workaroundthattoallowaseamless//editingexperience
if(HEX_COLOR.matcher("#"+defaultColor).matches()&&chosenColor.startsWith("#")){chosenColor=chosenColor.substring(1);
if(style==null){StyleInfos=getStyleInfo();PageParametersparameters=newPageParameters();parameters.add(StyleEditPage.NAME,s.getName());
if(s.getWorkspace()!=null){parameters.add(StyleEditPage.WORKSPACE,s.getWorkspace().getName());
ifweareonthepreviewtab
if(style!=null&&tabbedPanel.getSelectedTab()==2){tabbedPanel.visitChildren(StyleEditTabPanel.class,(component,visit)->{
if(componentinstanceofOpenLayersPreviewPanel){OpenLayersPreviewPanelpreviewPanel=(OpenLayersPreviewPanel)component;try{target.appendJavaScript(previewPanel.getUpdateCommand());
ifitisnull.
if(styleModel.getObject().getLegend()==null){styleModel.getObject().setLegend(getCatalog().getFactory().createLegend());
if(form.hasError()){addFeedbackPanels(target);
else{doReturn(StylePage.class);
if(errors.isEmpty()){form.info("Novalidationerrors.");
else{for(Exceptione:errors){form.error(sldErrorWithLineNo(e));
if(einstanceofSAXParseException){SAXParseExceptionse=(SAXParseException)e;return"line"+se.getLineNumber()+":"+e.getLocalizedMessage();
if(message!=null){returnmessage;
else{returnnewParamResourceModel("genericError",this).getString();
if(sld.getStyledLayers().length>1){validationErrors.addAll(SLDNamedLayerValidator.validate(getCatalog(),sld));
if(ininstanceofBufferedReader){bin=(BufferedReader)in;
else{bin=newBufferedReader(in);
ifthederivedSLDhasnot*subsequentlybeenmanuallyedited.**<p>TherecoveryisaccomplishedbyupdatingthecatalogtopointtotheoriginalCSSfile,*andchangingthestyle'sformatto"css".**@paramsiThe{@linkStyleInfo}forwhichtocheckforandpotentiallyrecoveraCSSversion.*/protectedvoidrecoverCssStyle(StyleInfosi){
if(si==null){return;
ifaCSSstylehandlerisregistered.try{Styles.handler("css");
if("sld".equalsIgnoreCase(si.getFormat())){Stringfilename=si.getFilename();StringfilenameCss=filename.substring(0,filename.lastIndexOf('.'))+".css";GeoServerDataDirectorydataDir=newGeoServerDataDirectory(getCatalog().getResourceLoader());ResourcecssResource=dataDir.get(si,filenameCss);
if(!cssResource.getType().equals(Resource.Type.UNDEFINED)){//IfthereisanexistingCSSfilewiththestyle'sname,check
ifitshouldbe//recovered.ResourcesldResource=dataDir.get(si,filename);longsldNewerByMs=sldResource.lastmodified()-cssResource.lastmodified();
if(sldNewerByMs>favorSLDIfNewerByMS){LOGGER.log(Level.WARNING,"ACSSversionof"+si.getName()+"hasbeenrecovered("+filenameCss+"),buttheSLDismorerecentby"+sldNewerByMs+"ms.ThestylewillbeleftasanSLD.");
else{LOGGER.log(Level.WARNING,"ACSSversionof"+si.getName()+"hasbeenrecovered("+filenameCss+").ThestylewillbeconvertedtoCSS.");si.setFilename(filenameCss);si.setFormat("css");getCatalog().save(si);
if(componentinstanceofStyleEditTabPanel){((StyleEditTabPanel)component).configurationChanged();
if(filter==null){LOGGER.warning("Cannotfindfilter:"+GeoServerSecurityFilterChain.FORM_LOGOUT_FILTER);return;
if(id==null){this.layerGroup=layerGroup;
if(id!=null){returnGeoServerApplication.get().getCatalog().getLayerGroup(id);
else{returnlayerGroup;
if(target!=null){//forceittoreloadtheattributelistattributes.getModel().detach();target.add(attributePanel);
if(cqlFilterString!=null&&!cqlFilterString.isEmpty()){cqlFilter=ECQL.toFilter(cqlFilterString);FeatureTypeft=typeInfo.getFeatureType();
if(ftinstanceofSimpleFeatureType){SimpleFeatureTypesft=(SimpleFeatureType)ft;BeanToPropertyValueTransformertransformer=newBeanToPropertyValueTransformer("localName");Collection<String>featureAttributesNames=CollectionUtils.collect(sft.getAttributeDescriptors(),transformer);FilterAttributeExtractorfilterAttriubtes=newFilterAttributeExtractor(null);cqlFilter.accept(filterAttriubtes,null);Set<String>filterAttributesNames=filterAttriubtes.getAttributeNameSet();for(StringfilterAttributeName:filterAttributesNames){
if(!featureAttributesNames.contains(filterAttributeName)){thrownewResourceConfigurationException(ResourceConfigurationException.CQL_ATTRIBUTE_NAME_NOT_FOUND_$1,newObject[]{filterAttributeName});
ifwehitthiscontroller,it'sa405supportedMethods(Sets.newHashSet(POST.toString()));
if(repoProvider.isPresent()){returnimportRepoService.importRepository(repoProvider.get(),repoName,Maps.newHashMap());
else{throwNO_PROVIDER;
if(repoProvider.isPresent()){returnimportRepoService.importRepository(repoProvider.get(),repoName,(requestBody==null)?Maps.newHashMap():requestBody.getParameters());
else{throwNO_PROVIDER;
if(repoProvider.isPresent()){returnimportRepoService.importRepository(repoProvider.get(),repoName,(requestBody==null)?Maps.newHashMap():requestBody.toSingleValueMap());
else{throwNO_PROVIDER;
ifsubclassingworks**@authorchristian*/publicclassMemoryGeoserverUserextendsGeoServerUser{privatestaticfinallongserialVersionUID=1L;publicMemoryGeoserverUser(Stringusername,GeoServerUserGroupServiceservice){super(username);
if(wmsStore.getWorkspace()!=null){//ensurethespecifiedworkspacematchestheonedictatedbytheuriWorkspaceInfows=wmsStore.getWorkspace();
if(!workspaceName.equals(ws.getName())){thrownewRestException("Expectedworkspace"+workspaceName+"butclientspecified"+ws.getName(),HttpStatus.FORBIDDEN);
else{wmsStore.setWorkspace(catalog.getWorkspaceByName(workspaceName));
if(info.getWorkspace()!=null&&!original.getWorkspace().equals(info.getWorkspace())){thrownewRestException("Attemptingtomove"+storeName+"from"+original.getWorkspace().getName()+"to"+info.getWorkspace().getName()+"viaPUT",HttpStatus.FORBIDDEN);
if(!original.getName().equals(info.getName())){thrownewRestException("Attemptingtorename"+storeName+"to"+info.getName()+"viaPUT",HttpStatus.FORBIDDEN);
if(original==null){thrownewResourceNotFoundException("Nosuchwmsstore:"+workspaceName+","+storeName);
if(!recurse){
if(!catalog.getResourcesByStore(cs,WMSLayerInfo.class).isEmpty()){thrownewRestException("wmsstorenotempty",HttpStatus.UNAUTHORIZED);
else{newCascadeDeleteVisitor(catalog).visit(cs);
if(workspace==null||store==null){returnnull;
if(objinstanceofWorkspaceInfo){converter.encodeLink("/workspaces/"+converter.encode(ref),writer);
if(properties==null){try{properties=model.toMap();
if(!dsProps.isEmpty())properties.putIfAbsent("wmsLayers",dsProps);
if(fail){Assert.fail("NoUsernameNotFoundExceptionthrown");
if("persrole1".equals(role.getAuthority())){assertEquals("A",role.getProperties().get("propertyA"));assertEquals("X",role.getProperties().get("propertyX"));GeoServerRoleanonymousRole=roleStore.getRoleByName(role.getAuthority());assertFalse(role.isAnonymous());assertTrue(anonymousRole.isAnonymous());assertFalse(role==anonymousRole);assertFalse(role.equals(anonymousRole));assertTrue(theUser.getUsername().equals(role.getUserName()));assertNull(anonymousRole.getUserName());
else
if("persrole2".equals(role.getAuthority())){assertEquals("B",role.getProperties().get("propertyB"));assertEquals("Y",role.getProperties().get("propertyY"));
else{Assert.fail("Unknownrole"+role.getAuthority()+"foruser"+username);
ifwe*)refactorserverconfiguration.Whenthathappensthisclasscanberetired.**@authorJustinDeoliveira,TheOpenPlanningProject,jdeolive@openplans.org*/publicclassCiteComplianceHackimplementsHandlerInterceptor{GeoServergs;ClassserviceClass;publicCiteComplianceHack(GeoServergs,ClassserviceClass){this.gs=gs;this.serviceClass=serviceClass;
if(handlerinstanceofDispatcher){Dispatcherdispatcher=(Dispatcher)handler;dispatcher.setCiteCompliant(getInfo().isCiteCompliant());
if(arginstanceofcom.vividsolutions.jts.geom.Geometry){newArgs.add(geoscript.geom.Geometry.wrap((com.vividsolutions.jts.geom.Geometry)arg));
else{newArgs.add(arg);
if(resultinstanceofgeoscript.geom.Geometry){return((geoscript.geom.Geometry)result).getG();
else{returnresult;
ifthereisareadparamtakinganOGCfilter,andinWMS*
iftheremoteserversupportsCQLfiltersandonfeatureinforequests.Forworkspacesit*willbejustINCLUDEorEXCLUDEtoallowordenyaccesstotheworkspace*/transientFilterreadFilter;/***BuildsagenericDataAccessLimits**@paramreadFilterThisfilterwillbemergedwiththerequestreadfilterstolimitthe*features/tilesthatcanbeactuallyread*/publicDataAccessLimits(CatalogModemode,FilterreadFilter){super(mode);this.readFilter=readFilter;
if(filter!=null){ByteArrayOutputStreambos=newByteArrayOutputStream();Encoderencoder=newEncoder(CONFIGURATION);encoder.encode(filter,OGC.Filter,bos);out.writeObject(bos.toByteArray());
else{out.writeObject(null);
if(serializedReadFilter!=null){try{Parserp=newParser(CONFIGURATION);return(Filter)p.parse(newByteArrayInputStream(serializedReadFilter));
else{returnnull;
if(this==obj)returntrue;
if(!super.equals(obj))returnfalse;
if(getClass()!=obj.getClass())returnfalse;DataAccessLimitsother=(DataAccessLimits)obj;
if(readFilter==null){
if(other.readFilter!=null)returnfalse;
else
if(!readFilter.equals(other.readFilter))returnfalse;returntrue;}}
ifitdoesnotexist.**@paramconnection*@paramschema*@returnstatementtocreateschema
ifitdoesn'texist*/StringcreateSchema(Connectionconnection,Stringschema);/***Areviewsautomaticallyupdatedwhendependentobjectisrenamed?**@returntrueorfalse*/booleanautoUpdateView();}
iftheenvironmentdoesnotcontaintheclasses...skipmethodSearch("JBossEAP6.0",CONNECTION_METHODS,"org.jboss.jca.adapters.jdbc.jdk6.WrappedConnectionJDK6","getUnderlyingConnection");methodSearch("JBossJCA",CONNECTION_METHODS,"org.jboss.jca.adapters.jdbc.WrappedConnection","getUnderlyingConnection");methodSearch("JBossResourceAdapter",CONNECTION_METHODS,"org.jboss.resource.adapter.jdbc.WrappedConnection","getUnderlyingConnection");
if(unwrapped!=null){returnunwrapped;
else{thrownewIllegalArgumentException("Thisconnectionisnotunwrappable,"+"checkcanUnwrapbeforecallingunwrap");
if(unwrapped!=null){returnunwrapped;
else{thrownewIllegalArgumentException("Thisstatementisnotunwrappable,"+"checkcanUnwrapbeforecallingunwrap");
ifwehaveaknownmethodtouse
if(methods.containsKey(implementation)){MethodaccessMethod=methods.get(implementation);
if(accessMethod==IGNORE){returnnull;//reflectionhasalreadybeentriedandcomeupempty
else{//Scanforsuperclass/interfacemethodfor(Entry<Class<?>,Method>entry:methods.entrySet()){Class<?>wrapper=entry.getKey();MethodaccessMethod=entry.getValue();
if(wrapper.isInstance(conn)){Tunwrapped=unwrapInternal(target,conn,wrapper,accessMethod);
if(unwrapped!=null){methods.put(implementation,accessMethod);returnunwrapped;
if(target.isAssignableFrom(method.getReturnType())&&method.getParameterTypes().length==0&&method.isAccessible()){//possibleaccessormethodTunwrapped=unwrapInternal(target,conn,implementation,method);
if(unwrapped!=null){methods.put(implementation,method);returnunwrapped;
ifnotavailable*/private<T>TunwrapInternal(Class<T>target,Tconn,Class<?>wrapper,MethodaccessMethod){
if(accessMethod==null){LOGGER.finest("Using"+wrapper.getName()+"doesnothaveaccessMethodtounwrap"+target.getSimpleName());returnnull;//skipinaccessiblemethod
if(result==null){LOGGER.finest("Using"+wrapper.getName()+"."+accessMethod.getName()+"()tounwrap"+target.getSimpleName()+"producedanull");returnnull;
if(result==conn){LOGGER.finest("Using"+wrapper.getName()+"."+accessMethod.getName()+"()tounwrapdidnotresultinnative"+target.getSimpleName()+":"+result.getClass().getSimpleName());returnnull;
if(!target.isInstance(result)){LOGGER.finest("Using"+wrapper.getName()+"."+accessMethod.getName()+"()tounwrapdidnotresultinnative"+target.getSimpleName()+":"+result.getClass().getSimpleName());returnnull;
if(iteminstanceofCoverageStoreInfo&&((CoverageStoreInfo)item).getType().equals(COVERAGE_TYPE)){returntrue;
ifnotexistsResources.directory(targetBackupFolder,!Resources.exists(targetBackupFolder));finalCoverageStoreInfomosaicCoverageStore=backupFacade.getCatalog().getResourcePool().clone((CoverageStoreInfo)item,true);finalStringmosaicName=mosaicCoverageStore.getName();finalStringmosaicUrlBase=mosaicCoverageStore.getURL();finalResourcemosaicIndexBase=Resources.fromURL(mosaicUrlBase);finalResourcemosaicBaseFolder=Files.asResource((Resources.directory(mosaicIndexBase)!=null?Resources.directory(mosaicIndexBase):Resources.directory(mosaicIndexBase.parent())));//CreatethetargetmosaicfolderResourcetargetMosaicBaseFolder=BackupUtils.dir(targetBackupFolder,mosaicBaseFolder.name());
if(Resources.exists(mosaicIndexBase)){for(Entry<String,Filter<Resource>>entry:resources.entrySet()){List<Resource>mosaicIndexerResources=Resources.list(mosaicIndexBase,entry.getValue(),true);for(Resourceres:mosaicIndexerResources){
if(!FilenameUtils.getBaseName(res.name()).equals(mosaicName)&&!FilenameUtils.getBaseName(res.name()).equals(mosaicBaseFolder.name())&&Resources.exists(res)&&Resources.canRead(res)){finalStringrelative=mosaicIndexBase.parent().dir().toURI().relativize(res.file().toURI()).getPath();ResourcetargetFtl=Resources.fromPath(relative,targetBackupFolder);
if(!targetFtl.parent().dir().exists()){targetFtl.parent().dir().mkdirs();
if(indexerFile.exists()&&indexerFile.canRead()){indexerProperties.load(newFileInputStream(indexerFile));
if(bounds==null){bounds=calculateBounds();
if(feature==null)continue;ReferencedEnvelopebbox=ReferencedEnvelope.reference(feature.getBounds());
if(bbox==null||bbox.isEmpty()||bbox.isNull())continue;extent.expandToInclude(bbox);
if(iterinstanceofFeatureIterator){((FeatureIterator<?>)iter).close();
if(parentProperty==null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Unabletogetthespecifiedpropertyforthecurrentfeature:"+ONLINE_PARENT_NODE+"\nNocustomizationwillbeapplied");
if(value==null||!(valueinstanceofCollection)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Unabletogetavalueforthecurrentproperty:"+parentPropertyName.getPropertyName()+"\nNocustomizationwillbeapplied");
if(links!=null){while(links.hasNext()){link=links.next();updatedOnlineResources.add(createOnlineResourceElement(link));
if(links!=null){try{links.close();
if(!(mapinstanceofSerializable)){thrownewIllegalArgumentException("mapisnotserializable");
if(obj==null){returnnull;
if(System.currentTimeMillis()>(start+maxWait))fail("WaitedforthethreadtobeblockedmorethanmaxWait:"+maxWait);Thread.sleep(10);
if(System.currentTimeMillis()>(start+maxWait))fail("WaitedforthethreadtobeterminatedmorethanmaxWait:"+maxWait);Thread.sleep(20);
if(System.currentTimeMillis()>(start+maxWait)){//forcefullydestroythethreadt.interrupt();
if(gsCookieValue!=null){httpRequest.setCookies(newCookie(CookieKeyGenerator.COOKIE_NAME,gsCookieValue));
if(ipAddress!=null&&!ipAddress.equals("")){httpRequest.setRemoteAddr(ipAddress);
else{httpRequest.setRemoteAddr("127.0.0.1");
if(!proxyIp.equals("")){httpRequest.addHeader("x-forwarded-for",proxyIp+","+ipAddress);
if(!state.equals(finalState)){fail("Waited"+maxWait+"msforFlowControllerTestingThreadtogetinto"+state+",butitisstillinstate"+finalState);
if(settingsInfo==null){settingsInfo=newSettingsInfoImpl();settingsInfo.setVerbose(false);
if(workspaceName!=null){Catalogcatalog=geoServer.getCatalog();WorkspaceInfoworkspaceInfo=catalog.getWorkspaceByName(workspaceName);settingsInfo.setWorkspace(workspaceInfo);geoServer.add(settingsInfo);geoServer.save(geoServer.getSettings(workspaceInfo));name=settingsInfo.getWorkspace().getName();
if(workspaceName!=null){WorkspaceInfoworkspaceInfo=geoServer.getCatalog().getWorkspaceByName(workspaceName);SettingsInfooriginal=geoServer.getSettings(workspaceInfo);
if(original==null){settingsInfo.setWorkspace(workspaceInfo);geoServer.add(settingsInfo);geoServer.save(geoServer.getSettings(workspaceInfo));
else{OwsUtils.copy(settingsInfo,original,SettingsInfo.class);original.setWorkspace(workspaceInfo);geoServer.save(original);
if(workspaceName!=null){WorkspaceInfoworkspaceInfo=geoServer.getCatalog().getWorkspaceByName(workspaceName);SettingsInfosettingsInfo=geoServer.getSettings(workspaceInfo);geoServer.remove(settingsInfo);
ifnameisroot
if(GeoServerUser.ROOT_USERNAME.equals(token.getPrincipal())==false)returnnull;//checkpassword
if(token.getCredentials()!=null){
if(getSecurityManager().checkMasterPassword(token.getCredentials().toString())){Collection<GrantedAuthority>roles=newArrayList<GrantedAuthority>();roles.add(GeoServerRole.ADMIN_ROLE);UsernamePasswordAuthenticationTokenresult=newUsernamePasswordAuthenticationToken(GeoServerUser.ROOT_USERNAME,null,roles);result.setDetails(token.getDetails());returnresult;
if(description.getParentId()==null){params=Collections.emptyMap();
else{params=params("parentId",description.getParentId());
if(!p.required){spec+="?";
if("searchTerms".equals(param.getName())){StringsearchTermsDocLink=buildSearchTermsDocLink(description);contentsEncoder=()->{element("atom:link",(Runnable)null,attributes(//"rel","profile",//"href",searchTermsDocLink,//"title","Simplesearchtermparameterspecification"));};
else
if("geometry".equals(param.getName())){contentsEncoder=()->{for(Stringtype:newString[]{"LINESTRING","POINT","POLYGON","MULTILINESTRING","MULTIPOINT","MULTIPOLYGON"}){element("atom:link",(Runnable)null,attributes("rel","profile",//"href","http://www.opengis.net/wkt/"+type,//"title","ThisserviceacceptsWKT"+type));
if(!param.isRequired()){map.put("minimum","0");
if(param.metadata!=null){String[]keys=newString[]{OpenSearchParameters.MIN_INCLUSIVE,OpenSearchParameters.MAX_INCLUSIVE};for(Stringkey:keys){Objectvalue=param.metadata.get(key);
if(value!=null){map.put(key,String.valueOf(value));
if(!map.containsKey("pattern")){Classtype=param.getType();
if(Integer.class==type){map.put("pattern","[+-][0-9]+");
else
if(Float.class==type||Double.class==type){map.put("pattern","[-+]?[0-9]*\\.?[0-9]+");
else
if(Date.class.isAssignableFrom(type)){map.put("pattern","^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}(\\.[0-9]+)?(Z|[\\+\\-][0-9]{2}:[0-9]{2})$");
if(debugMode){print(page,true,true);
if("type".equals(property.getName())){DropDownChoice<EoLayerType>layerTypes=newDropDownChoice<EoLayerType>("type",(IModel<EoLayerType>)property.getModel(itemModel),EoLayerType.getRasterTypes(true),newEoLayerTypeRenderer());Fragmentfragment=newFragment(id,"typeFragment",EoCoverageSelectorPage.this);fragment.add(layerTypes);returnfragment;
if(stores.getModelObject()!=null){try{CoverageStoreInfostore=(CoverageStoreInfo)stores.getModelObject();GridCoverageReaderreader=store.getGridCoverageReader(null,null);String[]names=reader.getGridCoverageNames();Arrays.sort(names);for(Stringname:names){LayerInfoli=getPreExistingLayer(name,store);
if(li==null){selections.add(newEoCoverageSelection(name,EoLayerType.IGNORE));
else
if(reportSkippedLayers){info("Skippingcoverage"+name+"asit'salreadypartofthegroupas"+li.getName());
if(entry.getLayer()instanceofLayerInfo){LayerInfoli=(LayerInfo)entry.getLayer();
if(li.getResource()instanceofCoverageInfo){CoverageInfoci=(CoverageInfo)li.getResource();//
ifsamestore,checkthenativename
if(ci.getStore().getId().equals(si.getId())){
if(ci.getNativeName().equals(coverageName)){returnli;
if(item.getType()!=EoLayerType.IGNORE){try{LayerInfolayer=createLayer(groupName,item,builder);
if(layer==null){error=true;
else{items.add(newEoLayerGroupEntry(layer,layer.getDefaultStyle(),layerGroupPage.lgModel.getObject().getName()));info("Layer"+layer.getName()+"successfullycreatedandaddedtotheEOlayergroup");
if(!error){setResponsePage(returnPage);
else{updateCoveragesList(true);
if(groupName!=null){name=groupName+"_"+name;
if(!dimensionsPresent){
if(layerType==EoLayerType.BAND_COVERAGE){error(newParamResourceModel("EoLayerGroupError.invalidBandCoverage",null,coverageName).getString());
else{error(newParamResourceModel("EoLayerGroupError.invalidLayer",null,coverageName).getString());
if(layerType==EoLayerType.BITMASK){StyleInfored=getCatalog().getStyleByName("red");
if(red!=null){layer.setDefaultStyle(red);
else{warn("Defaultstyleforbitmasklayers'red'wasnotfound,thedefault'raster'layergotassignedinstead.Pleasefix");
ifthelayerisofbandtype,acustomdimensionEnable*alldimensionsfound.*/privatebooleanenableDimensions(CoverageInfoci,EoLayerTypetype){booleantimeDimension=false;booleancustomDimension=false;GridCoverage2DReaderreader=null;try{//acquireareaderreader=(GridCoverage2DReader)ci.getGridCoverageReader(null,null);
if(reader==null){thrownewRuntimeException("Unabletoacquirereaderforthiscoverageinfo:"+ci.getName());
if(ci.getNativeCoverageName()!=null){reader=SingleGridCoverage2DReader.wrap(reader,ci.getNativeCoverageName());
if(LOGGER.isLoggable(Level.FINE)){booleanhasRange=ra.hasRange(domain);booleanhasResolution=ra.hasResolution(domain);LOGGER.fine(ci.getName()+":found"+domain+"dimension(hasRange:"+hasRange+",hasResolution:"+hasResolution+")");
if(Boolean.parseBoolean(elev)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(ci.getName()+":foundELEVATIONdimension");
if(Boolean.parseBoolean(time)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(ci.getName()+":foundTIMEdimension");
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.log(Level.SEVERE,"Failedtoaccesscoveragereadercustomdimensions",e);
if(type==EoLayerType.BAND_COVERAGE){returntimeDimension&&customDimension;
else{returntimeDimension;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;EoCoverageSelectionother=(EoCoverageSelection)obj;
if(coverageName==null){
if(other.coverageName!=null)returnfalse;
else
if(!coverageName.equals(other.coverageName))returnfalse;
if(type!=other.type)returnfalse;returntrue;
if(property==RoleListProvider.ROLENAME){returneditRoleLink(id,itemModel,property);
else
if(RoleListProvider.ParentPropertyName.equals(property.getName())){returneditParentRoleLink(id,itemModel,property);
else
if(property==RoleListProvider.HASROLEPARAMS){
if((Boolean)property.getModel(itemModel).getObject())returnnewIcon(id,CatalogIconFactory.ENABLED_ICON);
elsereturnnewLabel(id,"");
if(!canCreateStore){h.add(newLabel("message",newStringResourceModel("noCreateStore",this,null)).add(newAttributeAppender("class",newModel("info-link"),"")));
else{h.add(newLabel("message",newModel()));
if(expectedPort!=null){assertEquals("UnexpectedPORTvalue",expectedPort.intValue(),uri.getPort());
else{assertEquals("UnexpectedPORTvalue",5432,uri.getPort());
if(expectedSchema!=null){assertEquals("UnexpectedSCHEMAvalue",expectedSchema,paths[2]);
else{assertEquals("UnexpectedSCHEMAvalue","public",paths[2]);
if(queryParams[0].startsWith("user=")){userPair=queryParams[0];passwordPair=queryParams[1];
else{passwordPair=queryParams[0];userPair=queryParams[0];
if(expectedPort!=null){assertEquals("UnexpectedPORTvalue",expectedPort,bean.getPort());
else{assertEquals("UnexpectedPORTvalue",Integer.valueOf(5432),bean.getPort());
if(expectedSchema!=null){assertEquals("UnexpectedSCHEMAvalue",expectedSchema,bean.getSchema());
else{assertEquals("UnexpectedSCHEMAvalue","public",bean.getSchema());
ifthisdataproviderissetupforediting(itwillreusemodels).Defaultsto*false*/publicbooleanisEditable(){returneditable;
if(matchers!=null){returnmatchers;
if(keywords==null){returnnewMatcher[0];
if(isSpecial(c)){sb.append(escapeSeq);
ifacharacterisspecialtotheregexsystem.**@paramchrthecharactertotest*@returnisthecharacteraspecialcharacter.*/privatebooleanisSpecial(finalcharchr){return((chr=='.')||(chr=='?')||(chr=='*')||(chr=='^')||(chr=='$')||(chr=='+')||(chr=='[')||(chr==']')||(chr=='(')||(chr==')')||(chr=='|')||(chr=='\\')||(chr=='&'));
if(comparator!=null){Collections.sort(items,comparator);
if(items.size()<=count){//thelisthasbeenpagedforus.returnitems.iterator();
if(last>items.size())last=items.size();returnitems.subList((int)first,(int)last).iterator();
iftheyhaveamoreefficientway*offilteringthaninmemorykeywordcomparison*/protectedList<T>getFilteredItems(){List<T>items=getItems();//
ifneeded,filter
if(keywords!=null&&keywords.length>0){returnfilterByKeywords(items);
else{//makeadeepcopyanyways,thecatalogdoesnotdothatforusreturnnewArrayList<T>(items);
if(property.isSearchable()){Objectvalue=property.getPropertyValue(item);
if(value!=null){//bruteforcecheckforkeywordsfor(Matchermatcher:matchers){matcher.reset(String.valueOf(value));
if(matcher.matches()){result.add(item);breakITEM;
if(p.isVisible())results.add(p);
if(sort==null){returnnull;
if(property!=null){Comparator<T>comparator=property.getComparator();
if(comparator!=null){
if(!sort.isAscending())returnnewReverseComparator<T>(comparator);
elsereturncomparator;
if(sort==null||sort.getProperty()==null)returnnull;for(Property<T>property:getProperties()){
if(sort.getProperty().equals(property.getName())){returnproperty;
if(editable){IModel<T>result=modelCache.get(object);
if(result==null){result=newModel(object);modelCache.put((T)object,result);
else{returnnewModel(object);
if(null!=keywords){for(Stringkeyword:keywords){FilterpropContains=Predicates.fullTextSearch(keyword);//chainthefilterstogether
if(Filter.INCLUDE==filter){filter=propContains;
else{filter=or(filter,propContains);
ifitmakessensetosearchoverthisproperty*/publicbooleanisSearchable();
ifit'snot,manuallyoverridethegetModel()*method*/publicabstractstaticclassAbstractProperty<T>implementsProperty<T>{privatestaticfinallongserialVersionUID=6286992721731224988L;Stringname;booleanvisible;publicAbstractProperty(Stringname){this(name,true);
ifyouneedtomakeoneyou'llhavetorollyourowngetModel()*implementation({@linkBeanProperty}providesagoodexample)*/publicIModel<?>getModel(IModel<T>itemModel){Objectvalue=getPropertyValue((T)itemModel.getObject());
if(valueinstanceofIModel){return(IModel<?>)value;
else{returnnewModel<Serializable>((Serializable)value);
if(bean==null)returnnull;try{returnPropertyUtils.getProperty(bean,propertyPath);
ifanypropertyisnull?Weassumenull<(notnull)
if(p1==null)returnp2!=null?-1:0;
else
if(p2==null)return1;returnp1.compareTo(p2);
if(uploadPanel.getFileUpload()==null){uploadPanel.error(newParamResourceModel("fileRequired",getPage()).getString());
else{Stringdir=uploadPanel.getDirectory();Resourcedest=store().get(Paths.path(dir,uploadPanel.getFileUpload().getClientFileName()));
if(Resources.exists(dest)){uploadPanel.error(newParamResourceModel("resourceExists",getPage()).getString().replace("%","/"+dest.path()));
else{try(OutputStreamos=dest.out()){IOUtils.copy(uploadPanel.getFileUpload().getInputStream(),os);treeView.setSelectedNode(newResourceNode(dest,expandedStates),target);returntrue;
if(Resources.exists(dest)){editPanel.error(newParamResourceModel("resourceExists",getPage()).getString().replace("%","/"+dest.path()));
else{try(OutputStreamos=dest.out()){StringnewContents=editPanel.getContents();
if(newContents!=null){os.write(newContents.getBytes());
if(!newContents.endsWith("\n")){os.write(System.lineSeparator().getBytes());
if(newContents!=null){os.write(newContents.getBytes());
if(!newContents.endsWith("\n")){os.write(System.lineSeparator().getBytes());
if(clipBoard.isCopy()&&Resources.serializable(dest).equals(src)){//
ifwearecopyingaresourcetoitsown//directory,wewillgiveitanewname.for(inti=1;Resources.exists(dest);i++){dest=store().get(Paths.path(dir,FilenameUtils.getExtension(src.name()).isEmpty()?src.name()+"."+i:FilenameUtils.getBaseName(src.name())+"."+i+"."+FilenameUtils.getExtension(src.name())));
if(Resources.exists(dest)){pastePanel.error(newParamResourceModel("resourceExists",getPage()).getString().replace("%","/"+dest.path()));
else{try{
if(clipBoard.isCopy()){try(InputStreamis=src.in()){try(OutputStreamos=dest.out()){IOUtils.copy(is,os);
else{
if(!store().move(src.path(),dest.path())){thrownewIOException(newParamResourceModel("moveFailed",getPage()).getString().replace("%","/"+dest.path()));
ifoperationwascomplete
if(!sources.isEmpty()){pastePanel.getSourceField().setModelObject(listResources(sources));target.add(pastePanel.getFeedbackPanel());target.add(pastePanel.getSourceField());returnfalse;
if(Resources.exists(dest)){renamePanel.error(newParamResourceModel("resourceExists",getPage()).getString().replace("%","/"+dest.path()));
else{BooleanexpandedModel=expandedStates.getResourceExpandedState(src).getObject();
if(!src.renameTo(dest)){renamePanel.error(newParamResourceModel("renameFailed",getPage()).getString());
else{
if(clipBoard.getItems().contains(newResourceNode(src,expandedStates))){clipBoard.clearRemoved();clipBoard.addItem(newResourceNode(dest,expandedStates),target);
iftheoriginal//nodewasexpanded,weexpandthisoneaswell.//(childnodesmightstillloosetheirexpanded//statethough)expandedStates.getResourceExpandedState(dest).setObject(expandedModel);//selectthenewnodetreeView.setSelectedNode(newResourceNode(dest,expandedStates),target);returntrue;
if(!res.delete()){error(newParamResourceModel("deleteFailed",getPage()).getString().replace("%",res.path()));target.add(getFeedbackPanel());
ifdeletednodewasonclipboard,removeitformthe//clipboardclipBoard.clearRemoved();//removeselectiontreeView.setSelectedNodes(Collections.emptySet(),target);returntrue;
if(!node.isLeaf()){containsDir=true;
if(node.getObject().path().isEmpty()){containsRoot=true;
if(enabled!=button.isEnabled()){button.setEnabled(enabled);
if(enabled){button.remove(DISABLED_BEHAVIOR);
else{button.add(DISABLED_BEHAVIOR);
if(resources.isEmpty()){return"";
ifaresourceistextualornot(byextension)**@paramresourcetheresource*@returnwhetherthatresourceislikelytextualornot.*/privatestaticbooleanisTextual(Resourceresource){
if(resource.getType()!=Resource.Type.RESOURCE){returnfalse;
if(i>=0){Stringext=resource.name().substring(i+1).toLowerCase();for(Stringt:TEXTUAL_EXTENSIONS){
if(ext.equals(t)){returntrue;
if(delegate.isAvailable()&&delegate.canProduce(outputFormat)){returndelegate;
if(delegate.isAvailable()){formats.addAll(delegate.getOutputFormats());
ifhedidn'texistsandmarksitapreconfiguredone.*/privatevoidaddGridSet(StringgridSetName,SRSsrs,double[]resolutions,String[]scaleNames,BoundingBoxboundingBox,Stringdescription,doublemetersPerUnit){GWCgwc=GWC.get();//thisgridsetshouldnotbeeditablebytheuserGridSetgridSet=gwc.getGridSetBroker().get(gridSetName);
if(gridSet!=null){//thisgridsetalreadyexistsreturn;
if(TYPES==null){//thetreemapwithcomparatormakessurethatthetypesarealwaysdisplayedinthe//sameorder,alphabeticallysortedonnameTYPES=newTreeMap<Class<?extendsBlobStoreInfo>,BlobStoreType<?>>(newComparator<Class<?>>(){@Overridepublicintcompare(Class<?>o1,Class<?>o2){returno1.toString().compareTo(o2.toString());
if(reader.hasMoreChildren()){while(reader.hasMoreChildren()){reader.moveDown();ref=reader.getValue();reader.moveUp();
else{ref=reader.getValue();
if(result==null){result=catalog.getFeatureTypeByName(ref);
if(!activated){Utils.debug(LOGGER,"Rule%sisdeactivated.",id,urlTransform);returnurlTransform;
if(activationPattern.isPresent()){
if(!activationPattern.get().matcher(urlTransform.getOriginalRequestUri()).matches()){Utils.debug(LOGGER,"Rule%sdoesn'tapplytoURL'%s'.",id,urlTransform);returnurlTransform;
if(!matcher.matches()){Utils.debug(LOGGER,"Rule%sdoesn'tmatchURL'%s'.",id,urlTransform);returnurlTransform;
if(coverageStore==null){//revertthebluemablemodifiedchangeCatalogcat=getCatalog();CoverageStoreInfoc=cat.getCoverageStoreByName("BlueMarbleModified");
if(c!=null){c.setName("BlueMarble");cat.save(c);
iftherequestpath*matches*@parammediaTypesThelistof{@linkMediaType}storeturnwhenthepathmatches*/publicPutIgnoringExtensionContentNegotiationStrategy(PatternsRequestConditionpathMatcher,List<MediaType>mediaTypes){this.pathMatcher=pathMatcher;this.mediaTypes=mediaTypes;
if(pathMatcher.getMatchingCondition(request)!=null&&("PUT".equals(request.getMethod())||"POST".equals(request.getMethod()))){returnmediaTypes;
if(delaySeconds>0){try{System.out.println("Delayingresponsebeforequerying");Thread.sleep(delaySeconds*1000);
if(!(objinstanceofVertex))returnfalse;Vertexv=(Vertex)obj;returnv.position.equals(position)&&v.index==index;
if(workspace!=null&&!workspace.isEmpty()){return"/geoserver/"+workspace+"/wms";
else{return"/geoserver/wms";
if(!arg0.equals("UTF-8")){thrownewServletDebugException();
if(request.isGet()){encodeGetEcho(request);
else{encodePostEcho();
if(queryString!=null&&!fullRequest.contains("?")){fullRequest+="?"+queryString;
if(request!=null){Documentdom=parseAsXML(request);dumpAsXML(dom);
if(!data.startsWith("<?xml")){data="<?xmlversion=\"1.0\"encoding=\"UTF-8\"?>\n"+data;
if(sampleModel==null){thrownewNullPointerException("sampleModelcannotbenull");
if(location==null){location=newPoint(0,0);
ifnonereturnsapositivevalue**@paramobject*/publicstaticlonggetSizeOf(Objectobject){for(ObjectSizeEstimatorestimator:estimators){longsize=estimator.getSizeOf(object);
if(size>0){returnsize;
ifit'sgoingto//happen.//thismaynotfailonallplatforms
ifset/getisbrokenhowever,assomeplatformsmay//ignorethestacksizeintheThreadconstructor.returnnewThread(Thread.currentThread().getThreadGroup(),runnable,"RoundTripThread",5);
if(buffer.length()>0){fail(buffer.toString());
if(buffer.length()>0){fail(buffer.toString());
if(value!=null){capabilitiesCacheHeadersEnabled=Boolean.parseBoolean(value);
else{capabilitiesCacheHeadersEnabled=true;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Cachecontrolforcapabilitiesrequestsand304supportisenabled:"+capabilitiesCacheHeadersEnabled);
if(handleCachingHeaders(request)){returnnewRevalidateTagResponse(response);
ifthecachingheadersareenabledandtherequestisaGetCapabilitiesone**@paramrequest*@return*/privatebooleanhandleCachingHeaders(Requestrequest){returncapabilitiesCacheHeadersEnabled&&"GetCapabilities".equalsIgnoreCase(request.getRequest());
ifthecallbackwillhandlecacheheadersinGetCapabilitiesrequests/responses**@return*/publicbooleanisCapabilitiesCacheHeadersEnabled(){returncapabilitiesCacheHeadersEnabled;
ifwehavetoaddcachecontrolheaders.Won'talterthem
iftheresponsealreadyset*them.*/publicString[][]getHeaders(Objectvalue,Operationoperation)throwsServiceException{String[][]headers=delegate.getHeaders(value,operation);
if(headers==null){//
ifnoheadersatall,addandexitreturnnewString[][]{{HttpHeaders.CACHE_CONTROL,"max-age=0,must-revalidate"}};
else{//willaddonly
ifnotalreadythereMap<String,String>map=ArrayUtils.toMap(headers);map.putIfAbsent(HttpHeaders.CACHE_CONTROL,"max-age=0,must-revalidate");headers=newString[map.size()][2];inti=0;for(Map.Entry<String,String>entry:map.entrySet()){headers[i][0]=entry.getKey();headers[i][1]=entry.getValue();i++;
if(MultiLineString.class.isAssignableFrom(binding)){GeometryTypecurvedType=newGeometryTypeImpl(type.getName(),MultiCurvedGeometry.class,type.getCoordinateReferenceSystem(),type.isIdentified(),type.isAbstract(),type.getRestrictions(),type.getSuper(),type.getDescription());returnnewGeometryDescriptorImpl(curvedType,gd.getName(),gd.getMinOccurs(),gd.getMaxOccurs(),gd.isNillable(),gd.getDefaultValue());
else
if(LineString.class.isAssignableFrom(binding)){GeometryTypecurvedType=newGeometryTypeImpl(type.getName(),CurvedGeometry.class,type.getCoordinateReferenceSystem(),type.isIdentified(),type.isAbstract(),type.getRestrictions(),type.getSuper(),type.getDescription());returnnewGeometryDescriptorImpl(curvedType,gd.getName(),gd.getMinOccurs(),gd.getMaxOccurs(),gd.isNillable(),gd.getDefaultValue());
else{returngd;
if(pdinstanceofGeometryDescriptor){pd=wrapGeometryDescriptor((GeometryDescriptor)pd);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;CurveTypeWrapperother=(CurveTypeWrapper)obj;
if(delegate==null){
if(other.delegate!=null)returnfalse;
else
if(!delegate.equals(other.delegate))returnfalse;returntrue;}}
if(gsContactInfo!=null){ServiceContactgwcContactInfo=newServiceContact();gwcContactInfo.setIndividualName(gsContactInfo.getContactPerson());gwcContactInfo.setPositionName(gsContactInfo.getContactPosition());gwcContactInfo.setAddressType(gsContactInfo.getAddressType());gwcContactInfo.setAddressStreet(gsContactInfo.getAddress());gwcContactInfo.setAddressCity(gsContactInfo.getAddressCity());gwcContactInfo.setAddressPostalCode(gsContactInfo.getAddressPostalCode());gwcContactInfo.setAddressCountry(gsContactInfo.getAddressCountry());gwcContactInfo.setPhoneNumber(gsContactInfo.getContactVoice());gwcContactInfo.setFaxNumber(gsContactInfo.getContactFacsimile());gwcContactInfo.setAddressEmail(gsContactInfo.getAddressElectronicMailAddress());serviceProvider.setServiceContact(gwcContactInfo);
if(roleName==null){for(StringserviceName:securityManager.listUserGroupServices()){for(GeoServerUseruser:securityManager.loadUserGroupService(serviceName).getUsers()){resultSet.add(user.getUsername());
else{for(StringserviceName:securityManager.listRoleServices()){GeoServerRoleServiceroleService=securityManager.loadRoleService(serviceName);GeoServerRolerole=roleService.getRoleByName(roleName);
if(role!=null){resultSet.addAll(roleService.getUserNamesForRole(role));
switchbetweenServiceLoginFilter/HtmlLoginSecurityFilterChainPagenewPage=newSecurityVariableFilterChainPage(newServiceLoginFilterChain(),SecurityFilterChainsPanel.this.secMgrConfig,true);newPage.setReturnPage(getPage());setResponsePage(newPage);
if(isAdmin){////target.add(removeLink.setEnabled(!getSelection().isEmpty()));//
if(einstanceofSecurityConfigException){SecurityConfigExceptionsce=(SecurityConfigException)e;msg=newStringResourceModel("security."+sce.getId()).setParameters(sce.getArgs()).getObject();
else{msg=e;
if(chaininstanceofVariableFilterChain)editPage=newSecurityVariableFilterChainPage(((VariableFilterChain)chain),SecurityFilterChainsPanel.this.secMgrConfig,false);
elseeditPage=newSecurityFilterChainPage(chain,SecurityFilterChainsPanel.this.secMgrConfig,false);editPage.setReturnPage(getPage());setResponsePage(editPage);
if(property==NAME){returncreateEditLink(id,itemModel,property);
if(property==SecurityFilterChainProvider.POSITION){returnpositionPanel(id,itemModel);
if(property==SecurityFilterChainProvider.REMOVE){returnremoveLink(id,itemModel);
if(Boolean.TRUE.equals(property.getModel(itemModel).getObject()))returnnewIcon(id,CatalogIconFactory.ENABLED_ICON);
if(Boolean.FALSE.equals(property.getModel(itemModel).getObject()))returnnewLabel(id,"");returnnewLabel(id,property.getModel(itemModel));
if(chain.canBeRemoved()==false){ImageAjaxLinkblankLink=newImageAjaxLink(id,newPackageResourceReference(getClass(),"../img/icons/blank.png")){@OverrideprotectedvoidonClick(AjaxRequestTargettarget){}};blankLink.getImage().add(newAttributeModifier("alt",newModel("")));add(blankLink);returnblankLink;
if(getChains().indexOf(theChain)==0){tag.put("style","visibility:hidden");
else{tag.put("style","visibility:visible");
if(getChains().indexOf(theChain)==getChains().size()-1){tag.put("style","visibility:hidden");
else{tag.put("style","visibility:visible");
if("ft".equals(unit)||"feets".equals(unit))this.jsUnit="feet";
if(crs!=null){//CoordinateSystemcoordinateSystem=crs.getCoordinateSystem();//coordinateSystem.getName();//coordinateSystem.getRemarks();//coordinateSystem.getDimension();////if(crsinstanceofSingleCRS){//Datumdatum=((SingleCRS)crs).getDatum();//datum.getName();//datum.getAlias();//datum.getAnchorPoint();//datum.getRemarks();//datum.getScope();//
if(domainOfValidity!=null){areaOfValidity=domainOfValidity.getDescription()==null?"":domainOfValidity.getDescription().toString(locale);Collection<?extendsGeographicExtent>geographicElements=domainOfValidity.getGeographicElements();for(GeographicExtentex:geographicElements){aovCoords.append("").append(ex);
if(config.isImport()){
if(oldResourceStore!=null){try{Resourceroot=oldResourceStore.get("");for(Resourcechild:root.list()){
if(!ArrayUtils.contains(config.getIgnoreDirs(),child.name())){Resources.copy(child,get(child.name()));
else{LOGGER.warning("Cannotimportresources:nooldresourcestoreavailable.");
if(oldResourceStore!=null&&pathNames.size()>0&&ArrayUtils.contains(dir.getConfig().getIgnoreDirs(),pathNames.get(0))){returnoldResourceStore.get(path);
if(entry.createResource()){resourceNotificationDispatcher.changed(newResourceNotification(path(),ResourceNotification.Kind.ENTRY_CREATE,System.currentTimeMillis(),events));
if(getType()==Type.DIRECTORY){thrownewIllegalStateException("Directory(notafile)");
if(getType()==Type.RESOURCE){thrownewIllegalStateException("File(notadirectory)");
if(getType()!=Type.DIRECTORY){returnCollections.EMPTY_LIST;
if(this==obj){returntrue;
if(obj==null){returnfalse;
if(!(objinstanceofJDBCResource)){returnfalse;
if(entry.delete()){resourceNotificationDispatcher.changed(newResourceNotification(path(),ResourceNotification.Kind.ENTRY_DELETE,System.currentTimeMillis(),events));returntrue;
else{returnfalse;
if(destinstanceofJDBCResource){result=entry.renameTo(((JDBCResource)dest).entry);
else{result=Resources.renameByCopy(this,dest);
if(result){resourceNotificationDispatcher.changed(newResourceNotification(path(),ResourceNotification.Kind.ENTRY_DELETE,System.currentTimeMillis(),eventsDelete));resourceNotificationDispatcher.changed(newResourceNotification(path(),eventsRename.get(0).getKind(),System.currentTimeMillis(),eventsRename));
ifnocorrespondinguserisfound**<p>Returns<code>null</code>
iftheuserisdisabled**@paramkey*/GeoServerUsergetUser(Stringkey)throwsIOException;/***Assuresthateachuserinthecorresponding{@linkGeoServerUserGroupService}hasan*authenticationkey.**<p>returnsthenumberofaddedauthenticationkeys**@throwsIOException*/intsynchronize()throwsIOException;/**Returns<code>true</code>itthemappercandealwithreadonlyuuser/groupservices*/booleansupportsReadOnlyUserGroupService();StringgetBeanName();voidsetUserGroupServiceName(StringserviceName);StringgetUserGroupServiceName();publicGeoServerSecurityManagergetSecurityManager();publicvoidsetSecurityManager(GeoServerSecurityManagersecurityManager);/**Returnsthelistofconfigurationparameterssupportedbythismapper.*/publicSet<String>getAvailableParameters();/**Configuresthemapperparameters.*/publicvoidconfigureMapper(Map<String,String>parameters);/**Returnsthemapperparameters.*/publicMap<String,String>getMapperConfiguration();/**Validatesthegivenparameter.*/publicvoidvalidateParameter(StringparamName,Stringvalue)throwsFilterConfigException;}
if(fs==null)returnnull;return(FeatureSource)SecuredObjects.secure(fs,policy);
if(policy.response==Response.CHALLENGE){returnSecureCatalogImpl.unauthorizedAccess();
elsereturnnewUnsupportedOperationException("Thisdataaccessisreadonly,servicecodeissupposedtoperformwritesviaFeatureStoreinstead");}}
if(ascending){returnresult;
else{returnresult*-1;
if(a1instanceofAttribute){o1=(Comparable)((Attribute)a1).getValue();
else{o1=a1!=null?(Comparable)a1:null;
if(a2instanceofAttribute){o2=(Comparable)((Attribute)a2).getValue();
else{o2=a2!=null?(Comparable)a2:null;
if(o1==null){
if(o2==null){return0;
else{return-1;
else
if(o2==null){return1;
else{returno1.compareTo(o2);
if(range!=null){this.min=range.getMinimum();this.max=range.getMaximum();
if(min!=null&&max!=null){setConvertedInput(newNumberRange<>(Double.class,min,max));
else{setConvertedInput(null);
if(!factories.isEmpty()){returnnewGeoToolsConverter<C>(factories,type);
if(converter!=null){Tconverted=converter.convert(value,target);
if(converted!=null){returnconverted;
if(converter==null){continue;
if(converted!=null){returnconverted;
if(crs!=null){tinfo.setNativeCRS(crs);
if(metadataURL==null||createExtendedCapabilities!=null&&!createExtendedCapabilities){return;
if(secMgr.listAuthenticationProviders().contains("default2")){SecurityAuthProviderConfigconfig=secMgr.loadAuthenticationProviderConfig("default2");secMgr.removeAuthenticationProvider(config);
if(chooser.isJpegPreferred()){jpegResponse.formatImageOutputStream(image,outStream,mapContent);
else{pngResponse.formatImageOutputStream(image,outStream,mapContent);
if(chooser.isJpegPreferred()){return"jpg";
else{return"png";
if(argumentinstanceofConfigChangeEvent){ConfigChangeEventevt=(ConfigChangeEvent)argument;returnsuper.matches(argument)&&nullsafeEquals(this.id,evt.getObjectId())&&nullsafeEquals(this.name,evt.getObjectName())&&nullsafeEquals(this.workspaceId,evt.getWorkspaceId())&&nullsafeEquals(this.clazz,evt.getObjectInterface())&&nullsafeEquals(this.type,evt.getChangeType());
else{returnfalse;
ifnotdisablethepanelandemitwarningmessagebooleanisAdmin=getSecurityManager().checkAuthenticationForAdminRole();setEnabled(isAdmin);form.add(newLabel("message",isAdmin?newModel():newStringResourceModel("notAdmin",this,null)));
if(!isAdmin){form.get("message").add(newAttributeAppender("class",newModel("info-link"),""));
if(isNew)secMgrConfig.getFilterChain().getRequestChains().add(chain);//getSecurityManager().saveSecurityConfig(secMgrConfig);doReturn();
if(test.contains(mbtiles)){gpkgFound=true;
if(batch.getElements().indexOf(be)==0){tag.put("style","visibility:hidden");
else{tag.put("style","visibility:visible");
if(batch.getElements().indexOf(be)==batch.getElements().size()-1){tag.put("style","visibility:hidden");
else{tag.put("style","visibility:visible");
if(!Resources.exists(path)){thrownewIllegalArgumentException("Unabletolocatethefilepath:\'"+path+"\'");
if(!Resources.exists(path)){thrownewIllegalArgumentException("Unabletolocatethefilepath:\'"+path+"\'");
ifnoauthenticationentrypointisgiven,{@link*GeoServerExceptionTranslationFilter}usestheentrypointfoundintheservletrequestattribute*{@linkGeoServerSecurityFilter#AUTHENTICATION_ENTRY_POINT_HEADER}**<p>Theproperty{@link#accessDeniedErrorPage}isoptionalandneededincaseofan{@link*AccessDeniedException}.Geoserverdefaultis<b>/accessDenied.jsp</b>**@authorchristian*/publicclassExceptionTranslationFilterConfigextendsSecurityFilterConfig{privatestaticfinallongserialVersionUID=1L;privateStringauthenticationFilterName;privateStringaccessDeniedErrorPage;publicStringgetAccessDeniedErrorPage(){returnaccessDeniedErrorPage;
iftheprocessexecution*isnotcomplete.Oncetheoutputisretrievedtheprocesswillbemarkedasterminatedandit*won'tbepossibletogetitsoutputsorstatusanymore.**@paramexecutionId*@paramtimeout*/Map<String,Object>getOutput(StringexecutionId,longtimeout)throwsProcessException;/***Attemptstocanceltheprocessexecution.Iftheprocessisqueuedforexecutionitwillbe*removedfromthequeue,
ifit'sstillrunningabesteffortattempttostoptheprocesswill*bemade.*/voidcancel(StringexecutionId);}
iftheuserselectedanythingfinalList<?extendsCatalogInfo>selection=catalogObjects.getSelection();
if(selection.size()==0)return;dialog.setTitle(newParamResourceModel("confirmRemoval",this));//
ifthereissomethingtocancel,let'swarntheuseraboutwhat//couldgowrong,and
iftheuseraccepts,let'sdeletewhat'sneededdialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){protectedComponentgetContents(Stringid){//showaconfirmationpanelforalltheobjectswehavetoremovereturnnewConfirmRemovalPanel(id,selection){@OverrideprotectedStringResourceModelcanRemove(CatalogInfoinfo){returnSelectionRemovalLink.this.canRemove(info);
iftheselectionhasbeenclearedoutit'ssignadeletion//occurred,sorefreshthetable
if(catalogObjects.getSelection().size()==0){setEnabled(false);target.add(SelectionRemovalLink.this);target.add(catalogObjects);
ifacatalogobjectcanberemovedornot.**<p>Thismethodreturnsnon-nullincaseswheretheobjectshouldnotbeberemoved.The*returnvalueshouldbeadescriptionorreasonofwhytheobjectcannotberemoved.**@paraminfoTheobjecttoberemoved.*@returnAmessagestatingwhytheobjectcannotberemoved,ornulltoindicatethatitcan*beremoved.*/protectedStringResourceModelcanRemove(CatalogInfoinfo){returnnull;}}
if(tileX<minxTileX||tileX>maxTileX||tileY<minTileY||tileY>maxTileY){returnfalse;
ifitwaseditedafterbeinggeneratedfromCSS.FilemanuallyEditedSld=Paths.get(testData.getDataDirectoryRoot().getAbsolutePath(),"styles/"+oldCssStyleWithSLDManuallyEdited+".sld").toFile();manuallyEditedSld.setLastModified(t0.getTime()+1000000L);
iftheyweresubsequently*edited.*/@TestpublicvoidtestIgnoreCssStyleIfSLDWasEdited()throwsException{StyleInfostyleInfo=catalog.getStyleByName(oldCssStyleWithSLDManuallyEdited);StyleEditPageedit=newStyleEditPage(styleInfo);tester.startPage(edit);tester.assertRenderedPage(StyleEditPage.class);tester.assertNoErrorMessage();//AssertthatthepagedisplaystheformatasSLDtester.assertModelValue("styleForm:context:panel:format","sld");//AssertthattheeditortextareacontainsSLDStringeditorContents=(String)tester.getComponentFromLastRenderedPage("styleForm:styleEditor:editorContainer:editorParent:editor").getDefaultModelObject();Styles.handler("sld").parse(editorContents,null,null,null);//Assertthatthecatalog'sStyleInfoisstillaSLDstyleStyleInfosi=catalog.getStyleByName(oldCssStyleWithSLDManuallyEdited);assertEquals("sld",si.getFormat());assertEquals(oldCssStyleWithSLDManuallyEdited+".sld",si.getFilename());}}
elseworksStringtarget="http://example.com/";FormTesterft=tester.newFormTester("form");ft.setValue("panel:wms.attribution.logo",target);ft.submit();tester.assertModelValue("form:panel:wms.attribution.logo",target);
if(roleService.canCreateStore()){returnroleService.createStore();
else{thrownewIOException("Providedroleserviceisread-only:"+roleService.getName());
if(roleService==null){thrownewIllegalArgumentException("Providedroleservicedoesnotexist:"+serviceName);
if(role==null){thrownewIllegalArgumentException("Providedroledoesnotexist:"+roleName);
if(requestinstanceofGetRepositoryItemType){returntrue;
else{thrownewIllegalArgumentException("Unsupportedrequestobjecttype:"+request);
if(null!=input){IOUtils.copy(input,output);
else{thrownewHttpErrorCodeException(404,"Repositoryitemhadnocontent");
if(pv.isBoundingBox()){EnvelopePanelenvelope=newEnvelopePanel("paramValue",property);envelope.setCRSFieldVisible(true);item.add(envelope);
else
if(pv.isCoordinateReferenceSystem()){CRSPanelcrs=newCRSPanel("paramValue",property);item.add(crs);
else
if(pv.isEnum()){EnumPanelpanel=newEnumPanel("paramValue",((Class<Enum>)pv.getParameter().type),property);item.add(panel);
else
if(pv.isComplex()){ComplexInputPanelinput=newComplexInputPanel("paramValue",pv,0);item.add(input);
else{Fragmentf=newFragment("paramValue","literal",WPSRequestBuilderPanel.this);FormComponentliteral=newTextField("literalValue",property);literal.setRequired(p.minOccurs>0);literal.setLabel(newModel<String>(p.key));f.add(literal);item.add(f);
if(pv.isComplex()){DropDownChoicemime=newDropDownChoice("mime",newPropertyModel(pv,"mimeType"),pv.getSupportedMime());item.add(mime);
else{item.add(newLabel("mime","").setVisible(false));//placeholder
if(execute.processName!=null){responseWindow.setDefaultModel(newModel<String>(getDescribeXML(execute.processName)));responseWindow.show(target);
if(pageinstanceofGeoServerBasePage){((GeoServerBasePage)page).addFeedbackPanels(target);
if(execute.processName!=null)initProcessView();//usernameandpasswordforauthenticatedrequestsfinalWebMarkupContainerauthenticationContainer=newWebMarkupContainer("authenticationContainer");authenticationContainer.setOutputMarkupId(true);add(authenticationContainer);finalWebMarkupContaineruserpwdContainer=newWebMarkupContainer("userpwdContainer");userpwdContainer.setOutputMarkupId(true);userpwdContainer.setVisible(false);authenticationContainer.add(userpwdContainer);finalTextFieldusername=newTextField("username",newPropertyModel(this,"username"));userpwdContainer.add(username);finalPasswordTextFieldpassword=newPasswordTextField("password",newPropertyModel(this,"password"));password.setRequired(false);userpwdContainer.add(password);CheckBoxcheckbox=newCheckBox("authenticate",newPropertyModel(this,"authenticate"));checkbox.add(newAjaxFormComponentUpdatingBehavior("change"){@OverrideprotectedvoidonUpdate(AjaxRequestTargettarget){userpwdContainer.setVisible(authenticate);target.add(authenticationContainer);
if(pf==null){error("Nosuchprocess:"+execute.processName);descriptionContainer.setVisible(false);inputContainer.setVisible(false);outputContainer.setVisible(false);
else{description=pf.getDescription(name).toString(Locale.ENGLISH);execute.inputs=buildInputParameters(pf,name);execute.outputs=buildOutputParameters(pf,name);inputView.removeAll();outputView.removeAll();descriptionContainer.setVisible(true);inputContainer.setVisible(true);outputContainer.setVisible(true);
if(p.minOccurs>0){spec+="*";
if(p.minOccurs>1||p.maxOccurs!=1){spec+="("+p.minOccurs+"-";
if(p.maxOccurs==-1){spec+="unbounded";
else{spec+=p.maxOccurs;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("InspectingthehttprequestlookingfortheJSessionID.");
if(cookies!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Found"+cookies.length+"cookies!");
if(c.getName().toLowerCase().contains(SESSION_COOKIE_NAME)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("FoundJSessioncookie:"+c.getValue());
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Foundnocookies!");
if(procName!=null)execRequest.processName=procName;builder=newWPSRequestBuilderPanel("requestBuilder",execRequest);form.add(builder);//thexmlpopupwindowfinalModalWindowxmlWindow=newModalWindow("xmlWindow");add(xmlWindow);xmlWindow.setPageCreator(newModalWindow.PageCreator(){publicPagecreatePage(){returnnewPlainCodePage(xmlWindow,responseWindow,getRequestXML());
if(time.getObject()==null){time.setObject(newDimensionInfoImpl());
if(elevation.getObject()==null){elevation.setObject(newDimensionInfoImpl());
if(resourceinstanceofCoverageInfo){CoverageInfoci=(CoverageInfo)resource;try{GridCoverage2DReaderreader=(GridCoverage2DReader)ci.getGridCoverageReader(null,null);ReaderDimensionsAccessorra=newReaderDimensionsAccessor(reader);for(Stringdomain:ra.getCustomDomains()){booleanhasRange=ra.hasRange(domain);booleanhasResolution=ra.hasResolution(domain);RasterDimensionModelmm=newRasterDimensionModel(metadata,domain,DimensionInfo.class,hasRange,hasResolution);
if(mm.getObject()==null){mm.setObject(newDimensionInfoImpl());
if(!model.hasRange&&!model.hasResolution){editor.disablePresentationMode(DimensionPresentation.DISCRETE_INTERVAL);
ifthenamespacefailsassertNull(getCatalog().getWorkspaceByName("def"));assertNull(getCatalog().getNamespaceByPrefix("def"));
iftheworkspaceshouldbeisolated,otherwisefalse*/privatevoidcreateWorkspace(Stringname,Stringnamespace,booleanisolated){//makesuretheformisinitiatedinit();//gettheworkspacecreationformFormTesterform=tester.newFormTester("form");//filltheformwiththeprovidedvaluesform.setValue("name",name);form.setValue("uri",namespace);form.setValue("isolated",isolated);//submittheformform.submit();}}
if(iterator!=null){iterator.close();
if(geometryEncoding==GeometryEncoding.LATLONG||!(feature.getDefaultGeometry()instanceofGeometryCollection)){start("georss:where");geometryEncoding.encode((Geometry)feature.getDefaultGeometry(),this);end("georss:where");end("entry");
else{GeometryCollectioncol=(GeometryCollection)feature.getDefaultGeometry();start("georss:where");geometryEncoding.encode(col.getGeometryN(0),this);end("georss:where");end("entry");for(inti=1;i<col.getNumGeometries();i++){encodeRelatedGeometryEntry(col.getGeometryN(i),feature.getID(),link,link+"#"+i);
if((ev==null)||ev.isNull()){try{ev=fs.getFeatures().getBounds();
if(configinstanceofCredentialsFromRequestHeaderFilterConfig)validateFilterConfig((CredentialsFromRequestHeaderFilterConfig)config);
elsesuper.validateFilterConfig(config);
if(config.getUserNameHeaderName()==null||"".equals(config.getUserNameHeaderName())){thrownewCredentialsFromRequestHeaderFilterConfigException(CredentialsFromRequestHeaderFilterConfigException.USERNAME_HEADER_REQUIRED,null);
if(config.getUserNameRegex()==null||"".equals(config.getUserNameRegex())){thrownewCredentialsFromRequestHeaderFilterConfigException(CredentialsFromRequestHeaderFilterConfigException.USERNAME_REGEX_REQUIRED,null);
if(config.getPasswordHeaderName()==null||"".equals(config.getPasswordHeaderName())){thrownewCredentialsFromRequestHeaderFilterConfigException(CredentialsFromRequestHeaderFilterConfigException.PASSWORD_HEADER_REQUIRED,null);
if(config.getPasswordRegex()==null||"".equals(config.getPasswordRegex())){thrownewCredentialsFromRequestHeaderFilterConfigException(CredentialsFromRequestHeaderFilterConfigException.PASSWORD_REGEX_REQUIRED,null);
if(item.get("panel")instanceofContentPanel){//toggleoffitem.addOrReplace(newWebMarkupContainer("panel"));item.get("toggle").add(newAttributeModifier("class",newModel("collapsed")));
else{//toggleonitem.addOrReplace(createPanel("panel",item.getModel()));item.get("toggle").add(newAttributeModifier("class",newModel("expanded")));
if(info.getId()!=null){super.doSaveStore(info);
if(store!=null)//store.dispose();//
if(oldStore!=null){//error(newParamResourceModel("ImporterError.duplicateStore",//AbstractDBMSPage.this,generalParams.name,//workspace.getName())//.getString());//return;//
if(store!=null)//store.dispose();//
if(eventinstanceofCatalogPostModifyEvent)returntrue;
elsereturnfalse;
switch(mode){caseADMIN:authorizedRoles.put(mode,Collections.singleton(ROOT_ROLE));break;default:authorizedRoles.put(mode,EVERYBODY);
if(getChild(name)!=null)thrownewIllegalArgumentException("ThispathElement"+name+"isalreadyamongmychildren");SecureTreeNodechild=newSecureTreeNode(this);children.put(name,child);returnchild;
iftheuserisallowedtoaccessthePathElementwiththespecifiedaccessmode.Ifno*informationcanbefoundinthecurrentnode,thedecisionisdelegatedtotheparent.Ifthe*rootisreachedandithasnosecuritydefinition,accesswillbegranted.Otherwise,the*firstpathelementwitharolelistforthespecifiedaccessmodewillreturntrue
ifthe*userhasa{@linkGrantedAuthority}matchingoneofthespecifiedroles,falseotherwise**@paramuser*@parammode*/publicbooleancanAccess(Authenticationuser,AccessModemode){Set<String>roles=getAuthorizedRoles(mode);
if(GeoServerSecurityFilterChainProxy.isSecurityEnabledForCurrentRequest()==false)returntrue;//
ifwedon'tknow,weasktheparent,otherwiseweassume//theobjectisunsecured
if(roles==null){returnparent.canAccess(user,mode);
iftherolesisjust"*"anygrantedauthoritywillmatch
if(roles.equals(EVERYBODY))returntrue;//let'sscanthruthetheauthoritiesgrantedtotheuserand//see
ifhematchesanyofthewriteroles
if(user==null||user.getAuthorities()==null)returnfalse;//lookforamatchontheroles,usingthe"root"rulesaswell(rootcandoeverything)for(GrantedAuthorityauthority:user.getAuthorities()){finalStringuserRole=authority.getAuthority();
if(roles.contains(userRole)||ROOT_ROLE.equals(userRole))returntrue;
ifwe*don'thavearule,meaningtherulewillhavetosearchedintheparentnode*/publicSet<String>getAuthorizedRoles(AccessModemode){returnauthorizedRoles.get(mode);
if(next==null){returnresult;
else{curr=next;//don'treturninfoaboutanodethathasnoexplicit//ruleassociated,theparentwilldo
if(curr.authorizedRoles!=null&&!curr.authorizedRoles.isEmpty()){result=curr;
ifitfullymatchestheprovidedpath**@parampathElements*/publicSecureTreeNodegetNode(String...pathElements){SecureTreeNodecurr=this;for(inti=0;i<pathElements.length;i++){finalSecureTreeNodenext=curr.getChild(pathElements[i]);
if(next==null){returnnull;
else{curr=next;
ifafieldispublicstaticfinal**@paramfield*/staticbooleanisConstant(Fieldfield){intmodifier=field.getModifiers();returnModifier.isStatic(modifier)&&Modifier.isPublic(modifier)&&Modifier.isFinal(modifier);
switch(elementSet){caseBRIEF:returnCSWRecordDescriptor.BRIEF_ELEMENTS;caseSUMMARY:returnCSWRecordDescriptor.SUMMARY_ELEMENTS;default:returnnull;
if(filter!=null&&!Filter.INCLUDE.equals(filter)){Filterqualified=(Filter)filter.accept(NSS_QUALIFIER,null);Filterextended=(Filter)qualified.accept(PATH_EXTENDER,null);query.setFilter(extended);
if(sortBy!=null&&sortBy.length>0){CSWPropertyPathExtenderextender=newCSWPropertyPathExtender();for(inti=0;i<sortBy.length;i++){SortBysb=sortBy[i];
if(!SortBy.NATURAL_ORDER.equals(sb)&&!SortBy.REVERSE_ORDER.equals(sb)){PropertyNamename=sb.getPropertyName();PropertyNameextended=extender.extendProperty(name,FF,NAMESPACES);sortBy[i]=newSortByImpl(extended,sb.getSortOrder());
if(INSTANCE==null){//
ifthereisabeanavailable,usethebeanotherwisecreateotherINSTANCE=GeoServerExtensions.bean(CSWRecordDescriptor.class);
if(INSTANCE==null){INSTANCE=newCSWRecordDescriptor();
ifthenumberofnodesfoundcorrespondto*theexpectednumber,*/privatevoidcheckCount(XpathEnginexpathEngine,Documentdocument,intexpectedCount,Stringxpath){try{//evaluatethexpathandcomparethenumberofnodesfoundassertThat(xpathEngine.getMatchingNodes(xpath,document).getLength(),is(expectedCount));
ifclusteringisenabled.Thedelegateiscreatedlazily.**@authorKevinSmith,OpenGeo*/publicclassHzSessionShareFilterimplementsFilter{//NeedtouseadelegatorbecauseWebFilter#doFilterisfinalandassumesthataHazelcast//instancehasbeencreated.//TODOwhentheServletAPIdependencyisupdatedto3.0,thiscanallbemadealotsimpler.WebFilterdelegate;ServletContextsrvCtx;HzClustercluster;@Overridepublicvoidinit(FilterConfigfilterConfig)throwsServletException{srvCtx=filterConfig.getServletContext();WebApplicationContextUtils.getWebApplicationContext(filterConfig.getServletContext());
if(cluster==null){ApplicationContextac=WebApplicationContextUtils.getRequiredWebApplicationContext(srvCtx);cluster=ac.getBean("hzCluster",HzCluster.class);
ifclusteringisnotenabled
if(!getCluster().isSessionSharing())return;//Don'tbother
ifwealreadyhaveone
if(delegate!=null)return;//CreatethedelegateandoverrideitsgetInstancemethodtousethecluster'sinstancedelegate=newWebFilter(){@OverrideprotectedHazelcastInstancegetInstance(Propertiesproperties)throwsServletException{returngetCluster().getHz();
if(delegate!=null){delegate.doFilter(request,response,chain);
else{chain.doFilter(request,response);
if(delegate!=null)delegate.destroy();}}
if(granules.isEmpty()){thrownewResourceNotFoundException("Couldnotfindagranulewithid"+granuleId+"incoverage"+coverageName);
ifitwasthere,andforce//therightoutputformat...uglyashell,butwecouldnotfindabettersolution//regexeswithpositiveandnegativelookaheadsweretried
if(granuleId.endsWith(".json")){returnnewFormatCollectionWrapper.JSONCollectionWrapper(collection);
else{returnnewFormatCollectionWrapper.XMLCollectionWrapper(collection);
if(granuleId.endsWith(".xml")){granuleId=granuleId.substring(0,granuleId.length()-4);
else
if(granuleId.endsWith(".json")){granuleId=granuleId.substring(0,granuleId.length()-5);
if(reader.isReadOnly()){thrownewRestException("Coverage"+coverage.prefixedName()+"isreadony",HttpStatus.METHOD_NOT_ALLOWED);
if(nativeCoverageName==null){
if(reader.getGridCoverageNames().length>1){thrownewIllegalStateException("Thegridcoverageconfigurationfor"+coverage.getName()+"doesnotspecifyanativecoveragename,yetthereaderprovidesmorethanonecoverage."+"Pleaseassignanativecoveragename(theGUIdoessoautomatically)");
else{nativeCoverageName=reader.getGridCoverageNames()[0];
if(sourceSchema.getName().getNamespaceURI()==null){try{StringtargetNs="http://www.geoserver.org/rest/granules";AttributeDescriptor[]attributes=sourceSchema.getAttributeDescriptors().toArray(newAttributeDescriptor[sourceSchema.getAttributeDescriptors().size()]);SimpleFeatureTypetargetSchema=FeatureTypes.newFeatureType(attributes,sourceSchema.getName().getLocalPart(),newURI(targetNs));returnnewRetypingFeatureCollection(features,targetSchema);
else{returnfeatures;
if(ws==null){thrownewResourceNotFoundException("Nosuchworkspace:"+workspaceName);
if(store==null){thrownewResourceNotFoundException("Nosuchcoveragestore:"+storeName);
if(!optCoverage.isPresent()){thrownewResourceNotFoundException("Nosuchcoverageinstore:"+coverageName);
if(filter!=null){try{FilterogcFilter=ECQL.toFilter(filter);q.setFilter(ogcFilter);
if(offset!=null){
if(offset<0){thrownewRestException("Invalidoffsetvalue:"+offset,HttpStatus.BAD_REQUEST);
if(limit!=null){
if(limit<=0){thrownewRestException("Invalidlimitvalue:"+offset,HttpStatus.BAD_REQUEST);
if(interpolation.startsWith("nearest")){interpolation="nearestneighbor";
if(InterpolationMethodType.get(interpolation)==null)thrownewWcsException("CouldnotfindinterpolationMethod'"+interpolation+"'",InvalidParameterValue,"interpolationMethod");returnInterpolationMethodType.get(interpolation);}}
ifitdoesnothavetoomany*dependencies,thereisprobablyaproperobjectmodelforthis).**<p>Actually,foundthisafterimplementingtheclass,https://github*.com/swagger-api/swagger-core/tree/master/modules/swagger-models.Itmightbeusedfor*re-implementingthisclassinacleaner,lesserrorproneandmoregeneralway(although,think*aboutstreamingsupportforlargeAPIdocumentstoo)*/@JsonPropertyOrder({"openapi","info","paths","parameters"})publicclassAPIDocument{privatestaticfinalStringTYPE_STRING="string";privatestaticfinalStringTYPE_NUMBER="number";privatestaticfinalStringTYPE_INTEGER="integer";privatestaticfinalStringTYPE_BOOLEAN="boolean";privatestaticfinalStringTYPE_ARRAY="array";privatestaticfinalStringTYPE_OBJECT="object";publicstaticfinalStringIN_QUERY="query";publicstaticfinalStringIN_PATH="path";privatestaticfinalReferenceREF_FORMAT=newReference("#/components/parameters/f");privatestaticfinalReferenceREF_START_INDEX=newReference("#/components/parameters/startIndex");privatestaticfinalReferenceREF_LIMIT=newReference("#/components/parameters/limit");privatestaticfinalReferenceREF_BBOX=newReference("#/components/parameters/bbox");privatestaticfinalReferenceREF_RESULT_TYPE=newReference("#/components/parameters/resultType");privatestaticfinalReferenceREF_ID=newReference("#/components/parameters/id");privatestaticfinalReferenceREF_EXCEPTION=newReference("#/components/schemas/exception");privatestaticfinalStringTAG_CAPABILITIES="Capabilities";privatestaticfinalResponseERROR_RESPONSE;static{ERROR_RESPONSE=newResponse("Anerroroccurred");ERROR_RESPONSE.addFormat(BaseRequest.JSON_MIME,newFormatDescription().withReference(REF_EXCEPTION));//uncommentwhenHTMLformatissupported//ERROR_RESPONSE.addFormat(BaseRequest.HTML_MIME,new//FormatDescription().withType(TYPE_STRING));
if(tags==null){tags=newArrayList<>();
if(parameters==null){parameters=newArrayList<>();
if(responses==null){responses=newLinkedHashMap<>();
if(content==null){content=newHashMap<>();
if(required==null){required=newArrayList<>();
if(properties==null){properties=newLinkedHashMap<>();
if(example==null){example=newArrayList<>();
if(maxFeatures>0){countSchema.setMaximum(maxFeatures);countSchema.setDefault(maxFeatures);
if((formatName.contains("text")&&!formatName.contains("xml")&&!formatName.contains("gml"))||formatName.contains("csv")){descriptions.put(formatName,newFormatDescription().withType(TYPE_STRING));
else{descriptions.put(formatName,newFormatDescription().withType(TYPE_OBJECT));
if(type==null){returnnull;
if(nse!=null){Classcls=nse.getJavaClass();
if((cls!=null)&&cls.isAssignableFrom(type)&&!cls.equals(Object.class)){r.add(nse);
if(type==null){returnnull;
if(nse!=null){Stringname=nse.getTypeRefName();
if((name!=null)&&(name.indexOf(type)!=-1)){r.add(nse);
if((name!=null)&&(name.indexOf(type)!=-1)){r.add(nse);
ifthedefinitionprovidedisfoundinthelistofelementsforthis*namespace.**@paramdefinitionThedefinitionnametocheckfor,maybeeitherdefinitionor*prefix:definition.*@returntruewhenfound,falseotherwise.*/publicbooleanisValidDefinition(Stringdefinition){
if((definition==null)||(definition=="")){returnfalse;
if(nse==null){continue;
if((def!=null)&&def.equals(definition)){returntrue;
if((def!=null)&&def.equals(definition)){returntrue;
ifthereferenceprovidedisfoundinthelistofelementsforthis*namespace.**@paramdefinitionThereferencenametocheckfor,maybeeitherreferenceor*prefix:reference.*@returntruewhenfound,falseotherwise.*/publicbooleanisValidTypeRef(Stringtype){
if((type==null)||(type=="")){returnfalse;
if(nse==null){continue;
if((tp!=null)&&tp.equals(type)){returntrue;
if((tp!=null)&&tp.equals(type)){returntrue;
if(type==null){returnnull;
if((nse!=null)&&type.equals(nse.getJavaClass())){r.add(nse);
if(name==null){returnnull;
if(nse!=null){
if(name.equals(nse.getTypeRefName())){returnnse;
if(name.equals(nse.getTypeDefName())){returnnse;
if(name.equals(nse.getQualifiedTypeRefName())){returnnse;
if(name.equals(nse.getQualifiedTypeDefName())){returnnse;
if(posibilities.size()==0){returnnull;
if(nse!=null){
if(nse.isDefault()){returnnse;
if(type==null){returnnull;
if(posibilities.size()==0){returnnull;
if(posibilities.size()==1){return(NameSpaceElement)posibilities.toArray()[0];
if(name==null){return(NameSpaceElement)posibilities.toArray()[0];
if(nse!=null){
if(name.equals(nse.getTypeRefName())){returnnse;
if(name.equals(nse.getTypeDefName())){returnnse;
if(name.equals(nse.getQualifiedTypeRefName())){returnnse;
if(name.equals(nse.getQualifiedTypeDefName())){returnnse;
if(nse.isDefault()){returnnse;
ifitdoesnotexist*/publicfinalStringgetPrefix(){returnprefix;}}
if(!hasUserGroupStore(userGroupServiceName)){thrownewIllegalStateException("Newgroupnotpossibleforreadonlyservice");
if(hasRoleStore(getSecurityManager().getActiveRoleService().getName())){gaStore=getRoleStore(getSecurityManager().getActiveRoleService().getName());gaStore=newRoleStoreValidationWrapper(gaStore);for(GeoServerRolerole:rolePalette.getSelectedRoles()){gaStore.associateRoleToGroup(role,group.getGroupname());
ifnotexistsFileServicefileService=fileServices.get(FILE_SERVICE);
if(!fileService.checkFileExists(FILE_LOCATION)){fileService.create(FILE_LOCATION,TestData.class.getResource("world.tiff").openStream());
if(callableinstanceofJob){returnnewTask((Job)callable);
if(t!=null&&rinstanceofTask){((Task)r).started();
if(t!=null&&rinstanceofTask){((Task)r).setError(t);
if(e.getValue().isCancelled()||(e.getValue().isDone()/*AF:Thisconditionisneververified?!?&&e.getValue().isRecieved()*/)){try{ImportContextcontext=(ImportContext)e.getValue().get();
if(context.getState()==ImportContext.State.COMPLETE&&context.isEmpty()){context.unlockUploadFolder(context.getUploadDirectory());toremove.add(e.getKey());
if(f.isDirectory()&&!(newFile(f,".locking")).exists()){try{IOUtils.delete(f);
ifwecouldsyncthemupsomewhow....PropertyTypeproperty=wfsfactory.createPropertyType();//&lt;xsd:elementname="Name"type="xsd:QName"&gt;property.setName((QName)node.getChildValue(QName.class));//&lt;xsd:elementminOccurs="0"name="Value"&gt;
if(node.hasChild("Value")){Objectobject=node.getChildValue("Value");//checkforamap
if(objectinstanceofMap){Mapmap=(Map)object;//thismeansacomplexelementparsedbyxs:AnyTypebinding//trytopulloutsometext
if(!map.isEmpty()){//firstcheckforsometext
if(map.containsKey(null)){property.setValue(map.get(null));
else{//perhapssomeothervalueproperty.setValue(map.values().iterator().next());
else{property.setValue(object);
if(policy.level==AccessLevel.METADATA&&(request==null||!"GetCapabilities".equalsIgnoreCase(request.getRequest()))){throwSecureCatalogImpl.unauthorizedAccess(this.getName());
if(notification.getObject()instanceofNamespaceInfo){NamespaceInfoobj=(NamespaceInfo)notification.getObject();KombuNamespaceInfosource=newKombuNamespaceInfo();source.setId(obj.getId());source.setType("NamespaceInfo");source.setName(obj.getName());source.setNamespaceURI(obj.getURI());message.setSource(source);
if(notification.getObject()instanceofWorkspaceInfo){WorkspaceInfoobj=(WorkspaceInfo)notification.getObject();KombuWorkspaceInfosource=newKombuWorkspaceInfo();source.setId(obj.getId());source.setType("WorkspaceInfo");source.setName(obj.getName());source.setNamespaceURI("");message.setSource(source);
if(notification.getObject()instanceofLayerInfo){LayerInfoobj=(LayerInfo)notification.getObject();KombuLayerInfosource=newKombuLayerInfo();source.setId(obj.getId());source.setType("LayerInfo");source.setName(obj.getName());source.setResourceType(obj.getType()!=null?obj.getType().name():"");BeanToPropertyValueTransformertransformer=newBeanToPropertyValueTransformer("name");Collection<String>styleNames=CollectionUtils.collect(obj.getStyles(),transformer);source.setStyles(StringUtils.join(styleNames.toArray()));source.setDefaultStyle(obj.getDefaultStyle()!=null?obj.getDefaultStyle().getName():"");ResourceInfores=obj.getResource();source.setWorkspace(res.getStore()!=null?res.getStore().getWorkspace()!=null?res.getStore().getWorkspace().getName():"":"");
if(res.getNativeBoundingBox()!=null){source.setBounds(newBounds(res.getNativeBoundingBox()));
if(res.getLatLonBoundingBox()!=null){source.setGeographicBunds(newBounds(res.getLatLonBoundingBox()));
if(notification.getObject()instanceofLayerGroupInfo){LayerGroupInfoobj=(LayerGroupInfo)notification.getObject();KombuLayerGroupInfosource=newKombuLayerGroupInfo();source.setId(obj.getId());source.setType("LayerGroupInfo");source.setName(obj.getName());source.setWorkspace(obj.getWorkspace()!=null?obj.getWorkspace().getName():"");source.setMode(obj.getType().name());StringrootStyle=obj.getRootLayerStyle()!=null?obj.getRootLayerStyle().getName():"";source.setRootLayerStyle(rootStyle);source.setRootLayer(obj.getRootLayer()!=null?obj.getRootLayer().getPath():"");for(PublishedInfopl:obj.getLayers()){KombuLayerSimpleInfokl=newKombuLayerSimpleInfo();
if(plinstanceofLayerInfo){LayerInfoli=(LayerInfo)pl;kl.setName(li.getName());Stringlstyle=li.getDefaultStyle()!=null?li.getDefaultStyle().getName():"";
if(!lstyle.equals(rootStyle)){kl.setStyle(lstyle);
if(notification.getObject()instanceofResourceInfo){ResourceInfoobj=(ResourceInfo)notification.getObject();KombuResourceInfosource=null;
if(notification.getObject()instanceofFeatureTypeInfo){source=newKombuFeatureTypeInfo();source.setType("FeatureTypeInfo");
if(notification.getObject()instanceofCoverageInfo){source=newKombuCoverageInfo();source.setType("CoverageInfo");
if(notification.getObject()instanceofWMSLayerInfo){source=newKombuWMSLayerInfo();source.setType("WMSLayerInfo");
if(source!=null){source.setId(obj.getId());source.setName(obj.getName());source.setWorkspace(obj.getStore()!=null?obj.getStore().getWorkspace()!=null?obj.getStore().getWorkspace().getName():"":"");source.setNativeName(obj.getNativeName());source.setStore(obj.getStore()!=null?obj.getStore().getName():"");
if(obj.getNativeBoundingBox()!=null){source.setGeographicBunds(newBounds(obj.getNativeBoundingBox()));
if(obj.boundingBox()!=null){source.setBounds(newBounds(obj.boundingBox()));
if(notification.getObject()instanceofStoreInfo){StoreInfoobj=(StoreInfo)notification.getObject();KombuStoreInfosource=newKombuStoreInfo();source.setId(obj.getId());source.setType("StoreInfo");source.setName(obj.getName());source.setWorkspace(obj.getWorkspace()!=null?obj.getWorkspace().getName():"");message.setSource(source);
ifexiststostartcleanbuf.append("DROPSCHEMAIFEXISTS").append(ONLINE_DB_SCHEMA).append("CASCADE;\n");buf.append("CREATESCHEMA").append(ONLINE_DB_SCHEMA).append(";\n");for(StringfileName:propertyFiles.keySet()){Filefile=newFile(propertyFiles.get(fileName),fileName);try(PropertyFeatureReaderreader=newPropertyFeatureReader("test",file)){SimpleFeatureTypeschema=reader.getFeatureType();StringtableName=schema.getName().getLocalPart().toUpperCase();//createthetablebuf.append("CREATETABLE").append(ONLINE_DB_SCHEMA).append(".\"").append(tableName).append("\"(");List<GeometryDescriptor>geoms=newArrayList<GeometryDescriptor>();//+pkeyintsize=schema.getAttributeCount()+1;String[]fieldNames=newString[size];List<String>createParams=newArrayList<String>();intj=0;Stringfield;Stringtype;for(PropertyDescriptordesc:schema.getDescriptors()){
if(descinstanceofGeometryDescriptor){geoms.add((GeometryDescriptor)desc);
else{field="\""+desc.getName()+"\"";type=Classes.getShortName(desc.getType().getBinding());
if(type.equalsIgnoreCase("String")){type="TEXT";
else
if(type.equalsIgnoreCase("Double")){type="DOUBLEPRECISION";
ifthey'remorespecificbuf.append("'GEOMETRY'").append(",");//TODO:howtoworkthisoutproperly?buf.append(geom.getType().getCoordinateReferenceSystem()==null?2:geom.getType().getCoordinateReferenceSystem().getCoordinateSystem().getDimension());buf.append(");\n");
if(valueinstanceofGeometry){//usewktwritertoconvertgeometrytostring,sothirddimensioncan//besupported
ifpresent.Geometrygeom=(Geometry)value;value=newWKTWriter(geom.getCoordinate().z==Double.NaN?2:3).write(geom);
if(value==null||value.toString().equalsIgnoreCase("null")){values[valueIndex]="null";
else
if(prop.getType()instanceofGeometryType){intsrid=getSrid(((GeometryType)prop.getType()));
if(srid>-1){//attachsridvalues[valueIndex]="ST_GeomFromText('"+value+"',"+srid+")";
else{values[valueIndex]="ST_GeomFromText('"+value+"')";
else{values[valueIndex]="'"+value+"'";
if(buf.length()>0){this.sql=buf.toString();
if(signalArgs!=null&&signalArgs.get("topic")!=null)returnsignalArgs.get("topic").equals("error");returnfalse;
if(groupBy){xml+="<wps:Input>\n"+"<ows:Identifier>groupByAttributes</ows:Identifier>\n"+"<wps:Data>\n"+"<wps:LiteralData>name</wps:LiteralData>\n"+"</wps:Data>\n"+"</wps:Input>\n";
if(rawOutput){xml+="<wps:RawDataOutputmimeType=\""+mimeType+"\">\n"+"<ows:Identifier>result</ows:Identifier>\n"+"</wps:RawDataOutput>\n";
else{xml+="<wps:OutputmimeType=\""+mimeType+"\">\n"+"<ows:Identifier>result</ows:Identifier>\n"+"</wps:Output>\n";
ifwedonotexceedsthelimits,<code>false</code>otherwise.*@throwsExceptionincasesomethingbadhappens.*/publicbooleanexecute(FeatureTypeInforesourceInfo,Geometryroi,booleanclip,Filterfilter,CoordinateReferenceSystemtargetCRS,finalProgressListenerprogressListener)throwsException{////Doweneedtodoanything?//
if(downloadServiceConfiguration.getMaxFeatures()<=0){returntrue;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("NativeCRSis"+nativeCRS.toWKT());
if(roi!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"PushingROItonativeCRS");
if(filter!=null){ra=filter;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Usingfilter"+ra);
ifwehaveone
if(roi!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"AddingGeometryfilterwithROI");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Countingfeatures");
if(count<0){//avalueminorthan"0"meansthatthestoredoesnotprovideanycountingfeature...//letsproceedusingtheiteratorSimpleFeatureCollectionfeatures=featureSource.getFeatures(ra);count=features.size();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Featuresizeis"+count);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Maxfeatureslimitis"+maxFeatures);
if(maxFeatures>0&&count>maxFeatures){
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.log(Level.SEVERE,"MaxFeatureslimitexceeded."+count+">"+maxFeatures);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"MaxFeatureslimitnotexceeded.");
ifthis*propertytypeisa"self"property(i.e.doesnotrelatetoapropertyofanothertype)*@paramobjectTypeOidthetypeofobjectthispropertybelongsto*@parampropertyNamethenameoftheproperty(e.g.{@codename},{@code*resource.store.workspace.id},etc)*@paramcollectionProperty{@codetrue}
ifthisisamulti-valuedproperty*@paramisTextwhetherthispropertyissubjectforafulltextsearch*/publicPropertyType(finalIntegeroid,@NullablefinalIntegertargetPropertyOid,finalIntegerobjectTypeOid,finalStringpropertyName,booleancollectionProperty,finalbooleanisText){
if(targetPropertyOid!=null&&targetPropertyOid==0){thrownewIllegalArgumentException("oidcannotbezero");
if(comparison==0){comparison=targetPropertyOid==null&&o.targetPropertyOid!=null?-1:(o.targetPropertyOid==null?1:targetPropertyOid.compareTo(o.targetPropertyOid));
if(comparison==0){comparison=objectTypeOid.compareTo(o.objectTypeOid);
if(comparison==0){comparison=propertyName.compareTo(o.propertyName);
if(comparison==0){comparison=(collectionProperty==o.collectionProperty?0:(collectionProperty?1:-1));
if(!temp.canRead()||!temp.canWrite()){StringerrorMsg="Temporary-filepermissionproblemforlocation:"+temp.getPath();thrownewIOException(errorMsg);
ifflushiscalledbeforegetDestination*/publicvoidflush(HttpServletResponseresponse)throwsIOException{
if((temp==null)||(response==null)||(safe==null)||!temp.exists()){LOGGER.fine("tempis"+temp+",responseis"+response+"safeis"+safe+",tempexists"+temp.exists());thrownewIllegalStateException("flushshouldonlybecalledaftergetDestination");
if(copy!=null){try{copy.close();
if((temp!=null)&&temp.exists()){temp.delete();
if(safe!=null){try{safe.close();
if((temp!=null)&&temp.exists()){temp.delete();
if(p.type.isEnum()){returnnewEnumPPIO(p.type);
if(all.isEmpty()){returnnull;
if(mime!=null){for(ProcessParameterIOppio:all){
if(ppioinstanceofComplexPPIO&&((ComplexPPIO)ppio).getMimeType().equals(mime)){returnppio;
if(p.type.isEnum()){List<ProcessParameterIO>result=newArrayList<ProcessParameterIO>();result.add(newEnumPPIO(p.type));returnresult;
if(context!=null){l.addAll(GeoServerExtensions.extensions(ProcessParameterIO.class,context));
else{l.addAll(GeoServerExtensions.extensions(ProcessParameterIO.class));
if(context!=null){ppioFactories=GeoServerExtensions.extensions(PPIOFactory.class,context);
else{ppioFactories=GeoServerExtensions.extensions(PPIOFactory.class);
if(ppio.getIdentifer()!=null&&ppio.getIdentifer().equals(p.key)&&ppio.getType().isAssignableFrom(p.type)){matches.add(ppio);
ifnomatches,lookforjustthosewhichmatchbytype
if(matches.isEmpty()){for(ProcessParameterIOppio:l){
if(ppio.getType().isAssignableFrom(p.type)){matches.add(ppio);
if(ppio.getDirection()==PPIODirection.BOTH||ppio.getDirection()==direction){ppios.add(ppio);
ifthespecifiedparameterisacomplexone**@paramparam*@paramapplicationContext*/publicstaticbooleanisComplex(Parameter<?>param,ApplicationContextapplicationContext){List<ProcessParameterIO>ppios=findAll(param,applicationContext);
if(ppios.isEmpty()){returnfalse;
else{returnppios.get(0)instanceofComplexPPIO;
ifthePPIOcansupportencoding,decoding,orboth.BydefaultBOTHis*returned,subclasscanoverridewiththeirspecificabilities*/publicPPIODirectiongetDirection(){returnPPIODirection.BOTH;}}
if(listenerinstanceofINotificationCatalogListener){counter++;
if(listenerinstanceofINotificationTransactionListener){counter++;
if(settings==null){metadata.getMap().put(DirectDownloadSettings.DIRECTDOWNLOAD_KEY,newDirectDownloadSettings());
if("SAFE".equals(name.toUpperCase())){returnsafePalette;
if(entry!=null){
if(entry.isStale()){paletteCache.remove(name);
else{returnentry.icm;
ifthe//users//addsthepaletteInverterdirwitharunningGeoserver,wewon'tfindit//anymore...GeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);Resourcepalettes=loader.get("palettes");Set<String>names=newHashSet<String>();names.addAll(Arrays.asList(newString[]{name+".gif",name+".png",name+".pal",name+".tif"}));List<Resource>paletteFiles=newArrayList<Resource>();for(Resourceitem:palettes.list()){
if(names.contains(item.name().toLowerCase())){paletteFiles.add(item);
if(fileName.endsWith("pal")){finalIndexColorModelicm=newPALFileLoader(resource).getIndexColorModel();
if(icm!=null){paletteCache.put(name,newPaletteCacheEntry(resource,icm));returnicm;
else{ImageInputStreamiis=ImageIO.createImageInputStream(resource.in());finalIteratorit=ImageIO.getImageReaders(iis);
if(it.hasNext()){finalImageReaderreader=(ImageReader)it.next();reader.setInput(iis);finalColorModelcm=((ImageTypeSpecifier)reader.getImageTypes(0).next()).getColorModel();
if(cminstanceofIndexColorModel){finalIndexColorModelicm=(IndexColorModel)cm;paletteCache.put(name,newPaletteCacheEntry(resource,icm));returnicm;
if(op!=null){returnop;
else{op=newInverseColorMapOp(icm);opCache.put(key,op);returnop;
ifthebackingfiledoesnotexistanymore,orhasbeenmodified*/publicbooleanisStale(){return!Resources.exists(file)||(file.lastmodified()!=lastModified);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;IndexColorModelKeyother=(IndexColorModelKey)obj;returnicm==other.icm;
if(resultinstanceofGridCoverage){addCoverages((GridCoverage)result);
else
if(resultinstanceofGridCoverage[]){addCoverages((GridCoverage[])result);
if(list==null){list=newArrayList<GridCoverage>();COVERAGES.set(list);
if(coverageinstanceofGridCoverage2D){((GridCoverage2D)coverage).dispose(true);
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
if(coverages!=null){for(GridCoveragecoverage:coverages){try{disposeCoverage(coverage);
if(ImportContext.class.isAssignableFrom(clazz)){//returncontext(json);//
else
if(ImportTask.class.isAssignableFrom(clazz)){//returntask(json);//
else
if(ImportTransform.class.isAssignableFrom(clazz)||//TransformChain.class.isAssignableFrom(clazz)){//returntransform(json);//
if(json.has("import")){context=newImportContext();json=json.getJSONObject("import");
if(json.has("id")){context.setId(json.getLong("id"));
if(json.has("state")){context.setState(State.valueOf(json.getString("state")));
if(json.has("user")){context.setUser(json.getString("user"));
if(json.has("archive")){context.setArchive(json.getBoolean("archive"));
if(json.has("targetWorkspace")){context.setTargetWorkspace(fromJSON(json.getJSONObject("targetWorkspace"),WorkspaceInfo.class));
if(json.has("targetStore")){context.setTargetStore(fromJSON(json.getJSONObject("targetStore"),StoreInfo.class));
if(json.has("data")){context.setData(data(json.getJSONObject("data")));
if(json.has("transforms")){context.getDefaultTransforms().addAll(transforms(json.getJSONArray("transforms")));
if(json.has("layer")){json=json.getJSONObject("layer");
if(json.has("name")){r.setName(json.getString("name"));
if(json.has("nativeName")){r.setNativeName(json.getString("nativeName"));
if(json.has("srs")){r.setSRS(json.getString("srs"));try{r.setNativeCRS(CRS.decode(json.getString("srs")));
if(json.has("bbox")){r.setNativeBoundingBox(bbox(json.getJSONObject("bbox")));
if(json.has("title")){r.setTitle(json.getString("title"));
if(json.has("abstract")){r.setAbstract(json.getString("abstract"));
if(json.has("description")){r.setDescription(json.getString("description"));
if(json.has("style")){JSONObjectsobj=newJSONObject();sobj.put("defaultStyle",json.get("style"));JSONObjectlobj=newJSONObject();lobj.put("layer",sobj);LayerInfotmp=fromJSON(lobj,LayerInfo.class);
if(tmp.getDefaultStyle()!=null){l.setDefaultStyle(tmp.getDefaultStyle());
else{sobj=newJSONObject();sobj.put("style",json.get("style"));l.setDefaultStyle(fromJSON(sobj,StyleInfo.class));
if(json.has("task")){json=json.getJSONObject("task");
if(json.has("id")){task.setId(json.getInt("id"));
if(json.has("updateMode")){task.setUpdateMode(UpdateMode.valueOf(json.getString("updateMode").toUpperCase()));
else{//
ifithasn'tbeenspecifiedbytherequest,setthistonull//or
elseit'spossibletooverwriteanexistingsettingtask.setUpdateMode(null);
if(json.has("data")){data=json.getJSONObject("data");
else
if(json.has("source")){//backwardcompatiblecheckforsourcedata=json.getJSONObject("source");
if(data!=null){//weonlysupportupdatingthecharset
if(data.has("charset")){
if(task.getData()==null){task.setData(newImportData.TransferObject());
if(json.has("target")){task.setStore(fromJSON(json.getJSONObject("target"),StoreInfo.class));
if(json.has("layer")){layer=layer(json.getJSONObject("layer"));
else{layer=importer.getCatalog().getFactory().createLayer();
if(json.has("transformChain")){task.setTransform(transformChain(json.getJSONObject("transformChain")));
if("vector".equalsIgnoreCase(type)||"VectorTransformChain".equalsIgnoreCase(type)){chain=newVectorTransformChain();
else
if("raster".equalsIgnoreCase(type)||"RasterTransformChain".equalsIgnoreCase(type)){chain=newRasterTransformChain();
else{thrownewIOException("UnabletoparsetransformChainoftype"+type);
if("DateFormatTransform".equalsIgnoreCase(type)){transform=newDateFormatTransform(json.getString("field"),json.optString("format",null),json.optString("enddate",null),json.optString("presentation",null));
else
if("IntegerFieldToDateTransform".equalsIgnoreCase(type)){transform=newIntegerFieldToDateTransform(json.getString("field"));
else
if("CreateIndexTransform".equalsIgnoreCase(type)){transform=newCreateIndexTransform(json.getString("field"));
else
if("AttributeRemapTransform".equalsIgnoreCase(type)){Classclazz;try{clazz=Class.forName(json.getString("target"));
else
if("AttributeComputeTransform".equalsIgnoreCase(type)){Classclazz;try{clazz=Class.forName(json.getString("fieldType"));
else
if("AttributesToPointGeometryTransform".equalsIgnoreCase(type)){StringlatField=json.getString("latField");StringlngField=json.getString("lngField");transform=newAttributesToPointGeometryTransform(latField,lngField);
else
if("ReprojectTransform".equalsIgnoreCase(type)){CoordinateReferenceSystemsource=json.has("source")?crs(json.getString("source")):null;CoordinateReferenceSystemtarget=json.has("target")?crs(json.getString("target")):null;try{transform=newReprojectTransform(source,target);
else
if("GdalTranslateTransform".equalsIgnoreCase(type)){List<String>options=getOptions(json);transform=newGdalTranslateTransform(options);
else
if("GdalWarpTransform".equalsIgnoreCase(type)){List<String>options=getOptions(json);transform=newGdalWarpTransform(options);
else
if("GdalAddoTransform".equalsIgnoreCase(type)){List<String>options=getOptions(json);JSONArrayarray=json.getJSONArray("levels");List<Integer>levels=newArrayList<>();for(inti=0;i<array.size();i++){intlevel=array.getInt(i);levels.add(level);
else
if("PostScriptTransform".equalsIgnoreCase(type)){Stringname=json.getString("name");List<String>options=getOptions(json);transform=newPostScriptTransform(name,options);
else{thrownewValidationException("Invalidtransformtype'"+type+"'");
if(!json.containsKey("options")){returnnewArrayList<>();
if(type==null){thrownewIOException("Dataobjectmustspecify'type'property");
if("file".equalsIgnoreCase(type)){returnfile(json);
else
if("directory".equalsIgnoreCase(type)){returndirectory(json);
else
if("mosaic".equalsIgnoreCase(type)){returnmosaic(json);
else
if("archive".equalsIgnoreCase(type)){returnarchive(json);
else
if("database".equalsIgnoreCase(type)){returndatabase(json);
else
if("remote".equalsIgnoreCase(type)){returnremote(json);
else{thrownewIllegalArgumentException("Unknowndatatype:"+type);
if(json.has("file")){//TODO:findout
ifspatialornotStringfile=json.getString("file");returnFileData.createFromFile(newFile(file));//returnnewFileData(newFile(file));
else{thrownewIOException("Couldnotfind'file'entryindata,mandatoryforfiletypedata");
if(json.has("location")){Stringlocation=json.getString("location");RemoteDatadata=newRemoteData(location);
if(json.has("username")){data.setUsername(json.getString("username"));
if(json.has("password")){data.setPassword(json.getString("password"));
if(json.has("domain")){data.setDomain(json.getString("domain"));
else{thrownewIOException("Couldnotfind'location'entryindata,mandatoryforremotetypedata");
if(json.has("name")){m.setName(json.getString("name"));
if(json.containsKey("time")){JSONObjecttime=json.getJSONObject("time");
if(!time.containsKey("mode")){thrownewIllegalArgumentException("timeobjectmustspecificmodepropertyas"+"oneof"+TimeMode.values());
if(json.has("location")){returnnewDirectory(newFile(json.getString("location")));
else{returnDirectory.createNew(importer.getUploadRoot());
if(json.has("crs")){crs=(CoordinateReferenceSystem)newXStreamPersister.CRSConverter().fromString(json.getString("crs"));
if(json.containsKey("target")){result=fromJSON(json.getJSONObject("target"),DataStoreInfo.class);
ifweshouldusethehibernateBlobImplclasswhenwritingtothe*database,sinceitdoesnotworkwithoracle.**<p>http://opensource.atlassian.com/projects/hibernate/browse/EJB-24*/publicstaticStringUSE_HIBERNATE_BLOB="USE_HIBERNATE_BLOB";publicObjectassemble(Serializablecached,Objectowner)throwsHibernateException{returncached;
if(blob==null){returnnull;
if(bytes==null){//returnnull;//
if(in!=null){try{in.close();
if(value!=null){try{ByteArrayOutputStreambytes=newByteArrayOutputStream();ObjectOutputStreamout=newObjectOutputStream(bytes);out.writeObject(value);out.flush();
if(useHibernateBlob()){st.setBlob(index,Hibernate.createBlob(bytes.toByteArray()));
else{st.setBytes(index,bytes.toByteArray());
else{st.setNull(index,Types.BLOB);//st.setBytes(index,null);
if(objectinstanceofFeatureCollection){SimpleHashmap=(SimpleHash)super.wrap(object);map.put("request",Dispatcher.REQUEST.get().getKvp());map.put("environment",newEnvironmentVariablesTemplateModel());returnmap;
ifthereisonlyonefeaturetypeloaded,weallowforheader/footercustomization,//otherwisewestickwiththegenericonesTemplateheader=null;Templatefooter=null;List<FeatureCollection>collections=results.getFeature();
if(collections.size()==1){header=getTemplate(FeatureCollectionDecorator.getName(collections.get(0)),"header.ftl",charSet);footer=getTemplate(FeatureCollectionDecorator.getName(collections.get(0)),"footer.ftl",charSet);
else{//loadthedefaultonesheader=getTemplate(null,"header.ftl",charSet);footer=getTemplate(null,"footer.ftl",charSet);
if(fc!=null&&fc.size()>0){Templatecontent=null;
if(!(fc.getSchema()instanceofSimpleFeatureType)){//
ifthereisaspecifictemplateforcomplexfeatures,usethat.content=getTemplate(FeatureCollectionDecorator.getName(fc),"complex_content.ftl",charSet);
if(content==null){content=getTemplate(FeatureCollectionDecorator.getName(fc),"content.ftl",charSet);
ifatemplatefooterwasloaded(ie,therewereonlyonefeature//collection),processit
if(footer!=null){try{footer.process(null,osw);
ifthetemplatecan'tbeloaded*/TemplategetTemplate(Namename,StringtemplateFileName,Charsetcharset)throwsIOException{ResourceInfori=null;
if(name!=null){ri=wms.getResourceInfo(name);//ricanbenull
ifthetypeistheresultofarenderingtransformation
if(templateLoader==null){templateLoader=newGeoServerTemplateLoader(getClass());
if(ref.getMethod()==MethodType.POST_LITERAL){gft=(GetFeatureType)ref.getBody();
else{GetFeatureKvpRequestReaderreader=(GetFeatureKvpRequestReader)context.getBean("getFeatureKvpReader");gft=(GetFeatureType)kvpParse(ref.getHref(),reader);
if(null!=input.getData()){//Decodeinlinedatadecoded=this.decodeInputData(input);
if(null!=input.getReference()){//Fetchexternalresourcedecoded=this.decodeReferenceData(identifier,input.getReference());
if(inputMap.containsKey(identifier)){
if(inputMap.get(identifier)instanceofList){List<Object>list=(List<Object>)inputMap.get(identifier);list.add(decoded);
else{List<Object>list=newArrayList<Object>();list.add(inputMap.get(identifier));inputMap.put(identifier,list);
else{inputMap.put(identifier,decoded);
if(null!=data.getLiteralData()){output=this.decodeLiteralData(data.getLiteralData(),parameter.type);
if(null!=data.getComplexData()){output=this.decodeComplexData(data.getComplexData(),parameter.type);
if(null!=data.getBoundingBoxData()){//ParseboundingboxdatathrownewWPSException("NoApplicableCode","Unimplemented");
if(false==transmuterinstanceofComplexTransmuter){continue;
if(false==((ComplexTransmuter)transmuter).getSchema(this.urlBase).equalsIgnoreCase(schema)){continue;
if(type!=transmuter.getType()){continue;
if(null==transmuter){thrownewWPSException("NoApplicableCode","Nodefaulttransmuterregisteredfortype"+type.toString()+"'.");
ifallinputsandoutputsofaProcessaretransmutable**@parampf*/publicbooleanisTransmutable(ProcessFactorypf,Namename){for(Parameter<?>param:pf.getParameterInfo(name).values()){try{this.getDefaultTransmuter(param.type);
if(disabled){LOGGER.warning("--Foundenvironmentvariable"+GWC_DISKQUOTA_DISABLED+"settotrue.DiskQuotaMonitorisdisabled.");
if(!diskQuotaEnabled){store=null;return;
if(!config.isEnabled()){//itwouldbenicetojustreturnnull,buttheotherportionsofthe//diskquotasystemwillthrowexceptions
ifwedidwhilethequotastore//isnotdisableviasystemvariable.Let'sjustgiveitadummyquotastoreinstead.store=newDummyQuotaStore(calculator);
else{StringquotaStoreName=config.getQuotaStore();//incaseit'snullGeoServerdefaultstoH2store,wedon'thavethe//BDBstoreintheclasspath
if(quotaStoreName==null){quotaStoreName=JDBCQuotaStoreFactory.H2_STORE;
if(this.store==null){this.store=newConfigurableQuotaStore(store);
else{ConfigurableQuotaStoreconfigurable=(ConfigurableQuotaStore)this.store;QuotaStoreoldStore=configurable.getStore();configurable.setStore(store);//cleanupthequotainformationgatheredsofar,otherwisewhenre-enabling//we'llhaveinthedbstaleinformation
if(!(oldStoreinstanceofDummyQuotaStore)){try{for(TileLayertl:GWC.get().getTileLayers()){oldStore.deleteLayer(tl.getName());
ifany*/publicExceptiongetException(){returnexception;
if("JDBC".equals(quotaStoreName)){returnloadJDBCQuotaStore(applicationContext,quotaStoreName);
else{returnsuper.getQuotaStoreByName(quotaStoreName);
if(kmltitle==null){kmltitle=context.getMapContent().getTitle();
if(document==null){thrownewServiceException("Codingerrorindecorator"+decorator+",documentobjectscannotbesettonull");
ifrequestexplicitlyspecifiedtheviewareafinalbooleancomputeQueryBounds=lookAt==null;ReferencedEnvelopeaggregatedBounds;try{booleanlongitudeFirst=true;aggregatedBounds=newReferencedEnvelope(CRS.decode("EPSG:4326",longitudeFirst));
iflayerisgoingtobefiltered,theresultingboundsareobtainedinsteadof//thewholeboundsfinalFilterfilter=layerQuery.getFilter();
if(layerQuery.getFilter()==null||Filter.INCLUDE.equals(filter)){computeQueryBounds=false;
if(!computeQueryBounds&&!layerQuery.isMaxFeaturesUnlimited()){computeQueryBounds=true;
if(computeQueryBounds){FeatureSourcefeatureSource=layer.getFeatureSource();try{CoordinateReferenceSystemtargetCRS=CRS.decode("EPSG:4326");FeatureCollectionfeatures=featureSource.getFeatures(layerQuery);layerLatLongBbox=features.getBounds();layerLatLongBbox=layerLatLongBbox.transform(targetCRS,true);
if(layerLatLongBbox==null){try{layerLatLongBbox=layerInfo.getLatLongBoundingBox();
if(nss!=null){QNamename=resolver.parseQName(expression.getPropertyName(),nss);Stringuri=name.getNamespaceURI();
if(path.endsWith("AnyText")&&(uri==null||"".equals(uri)||CSW.NAMESPACE.equals(uri))){returnnewRecordTextFunction();
if(targetinstanceofCollection&&maxInstances>0){intsize=((Collection)target).size();
if(size>maxInstances){errors.reject(CODE,"Inputhasbeenprovidedintoomanyvalues,found"+size+"butthemaximumacceptedamountis"+maxInstances);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;MultiplicityValidatorother=(MultiplicityValidator)obj;
if(maxInstances!=other.maxInstances)returnfalse;returntrue;}}
if(ginstanceofLinearRing){g=g.getFactory().createLineString(((LinearRing)g).getCoordinateSequence());
if(modified!=lastModified){//calculateitssizelongsize;try{size=size();//firethemodifiedhookmodified(modified,size);//updatestatethis.lastModified=modified;this.lastSize=size;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofWorkspaceInfo))returnfalse;finalWorkspaceInfoother=(WorkspaceInfo)obj;
if(id==null){
if(other.getId()!=null)returnfalse;
else
if(!id.equals(other.getId()))returnfalse;
if(name==null){
if(other.getName()!=null)returnfalse;
else
if(!name.equals(other.getName()))returnfalse;returntrue;
if(metadata!=null&&!metadata.isEmpty()){Set<String>keys=metadata.keySet();//Setbboxinthelink
if(keys.contains(Utils.BBOX)){Objectbbox=metadata.get(Utils.BBOX);appendBBOXToLink((ReferencedEnvelope)bbox,builder);
if(keys.contains(Utils.TIME_DOMAIN)){Objecttime=metadata.get(Utils.TIME_DOMAIN);appendRangeToLink(Utils.TIME_DOMAIN,time,builder);
if(keys.contains(Utils.ELEVATION_DOMAIN)){Objectelevation=metadata.get(Utils.ELEVATION_DOMAIN);appendRangeToLink(Utils.ELEVATION_DOMAIN,elevation,builder);
if(!STANDARD_DOMAINS.contains(key)){Objectadditional=metadata.get(key);appendRangeToLink(key,additional,builder);
if(envelope==null){thrownewIllegalArgumentException("Envelopecan'tbenull");
if(domaininstanceofDateRange){//instantiateanewDateFormatinsteadofusingastaticonesince//it'snotthreadsafe
if(dateFormat==null){dateFormat=newSimpleDateFormat(DATE_FORMAT);dateFormat.setTimeZone(TimeZone.getTimeZone("UTC"));
else
if(domaininstanceofNumberRange){NumberRangenumberRange=(NumberRange)domain;builder.append(numberRange.getMinValue()).append("/").append(numberRange.getMaxValue());
else
if(domaininstanceofRange){//GenericrangeRangerange=(Range)domain;builder.append(range.getMinValue()).append("/").append(range.getMaxValue());
else{thrownewIllegalArgumentException("Domain"+domain+"isn'tsupported");
if(baseURL==null){baseURL=ResponseUtils.baseURL(request.getHttpRequest());
if(baseURL==null){thrownewIllegalArgumentException("baseURLisrequiredtocreatedownloadlinks");
if(infoinstanceofCoverageInfo){returnlinksFromCoverage(baseURL,(CoverageInfo)info);
else{
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.warning("Downloadlinkforvectorsisn'tsupported."+"Returningnull");
if(reader==null){thrownewIllegalArgumentException("Noreaderavailableforthespecifiedcoverage:"+name);
if(resourceInfoinstanceofFileResourceInfo){FileResourceInfofileResourceInfo=(FileResourceInfo)resourceInfo;//ReplacethetemplateURLwithpropervaluesStringbaseLink=baseURL.replace("${nameSpace}",coverageInfo.getNamespace().getName()).replace("${layerName}",coverageInfo.getName());CloseableIterator<org.geotools.data.FileGroupProvider.FileGroup>dataIterator=fileResourceInfo.getFiles(null);returnnewCloseableLinksIterator(baseLink,dataIterator);
else{thrownewRuntimeException("Donwloadlinkshandlerneedtoprovide"+"downloadlinkstofiles.TheResourceInfoassociatedwiththestoreshouldbeaFileResourceInfoinstance");
if(Strings.isEmpty(propertyName)){returnactionLink(id,itemModel.getObject().getName());
if(gridSet!=null){gridsets.add(gridSet);
if(null==selectedGridset){return;
if(params.length==0)returnnewEditDataAccessRulePage(newDataAccessRule("it.geosolutions","layer.dots",AccessMode.READ,Collections.singleton("ROLE_ABC")));
elsereturnnewEditDataAccessRulePage((DataAccessRule)params[0]);
if(MockData.CITE_PREFIX.equals(rule.getRoot())&&MockData.BRIDGES.getLocalPart().equals(rule.getLayer()))returnrule.getKey();
iftherearenorules,DataAccessRuleDAO.loadRulesaddstwobasicrulesassertEquals(2,DataAccessRuleDAO.get().getRules().size());
if(component.getId().equals("catalogMode")){((RadioChoice)component).onSelectionChanged();
ifnone*@paramexpectedNumberReturnedtheexpectednumberoffeaturesreturnedintheresponse*@paramexpectedSrsNametheexpectedpointPropertysrsNameofPrimitiveGeoFeature.f015inthe*responseornull
ifnofeaturesareexpected*@paramexpectedDatatheexpectedpointPropertydataofPrimitiveGeoFeature.f015inthe*responseornull
ifnofeaturesareexpected*/privatevoidrunTest(StringrequestSrsName,StringrequestBbox,intexpectedNumberReturned,StringexpectedSrsName,StringexpectedData)throwsException{StringBuilderrequestBuilder=newStringBuilder("wfs");requestBuilder.append("?version=2.0.0");requestBuilder.append("&request=GetFeature");requestBuilder.append("&typenames=");requestBuilder.append(TYPE_NAME);
if(requestSrsName!=null){requestBuilder.append("&srsname=");requestBuilder.append(encodeSrsName(requestSrsName));
if(requestBbox!=null){requestBuilder.append("&bbox=");requestBuilder.append(encodeSrsName(requestBbox));
if(expectedNumberReturned>0){XMLAssert.assertXpathEvaluatesTo(GML_ID,GML_ID_XPATH,response);XMLAssert.assertXpathEvaluatesTo(expectedSrsName,SRSNAME_XPATH,response);XMLAssert.assertXpathEvaluatesTo(expectedData,DATA_XPATH,response);
if(range!=null&&!range.isEmpty()&&!range.contains((Number)target)){errors.reject(CODE,"Value"+target+"isoutofthevalidrange"+range);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;NumberRangeValidatorother=(NumberRangeValidator)obj;
if(range==null){
if(other.range!=null)returnfalse;
else
if(!range.equals(other.range))returnfalse;returntrue;}}
iftheyhavethesame"prefix"and"uri".*/booleanequals(Objectobj);///**//*Theresourceswhichfallintothisnamespace.//*@uml.propertyname="resources"//*@uml.associationEndmultiplicity="(0-1)"//container="java.util.Iterator"aggregation="composite"//inverse="namespace:org.geoserver.catalog.ResourceInfo"//*///Iterator/*<ResourceInfo>*/resources();/////**//*Addsaresourcetothenamespace.//*///voidadd(ResourceInforesource);/////**//*Removesaresourcefromthenamespace.//*///voidremove(ResourceInforesource);defaultbooleanisIsolated(){returnfalse;
ifogr2ogrisinthepath**@paramogrExecutable*/@OverridepublicvoidsetExecutable(StringogrExecutable){this.ogrExecutable=ogrExecutable;
if(environment!=null){this.environment.clear();this.environment.putAll(environment);
if(format==null){thrownewWFSException("Unknownoutputformat"+outputFormat);
else
if(format.isSingleFile()&&request.getQueries().size()<=1){
if(format.getMimeType()!=null){mimeType=format.getMimeType();
else{//useadefaultbinaryblobmimeType="application/octet-stream";
else{mimeType="application/zip";
iftheogr2ogrconfigurationfailed
if(formats.size()==0){returnfalse;
else{returnsuper.canHandle(operation);
if(format==null){thrownewWFSException("Unknownoutputformat"+outputFormat);
else
if(format.getType()==OutputType.BINARY||queries.size()>1){returnDISPOSITION_ATTACH;
else{returnDISPOSITION_INLINE;
if(format==null){thrownewWFSException("Unknownoutputformat"+outputFormat);
else{StringoutputFileName=queries.get(0).getTypeNames().get(0).getLocalPart();
if(!format.isSingleFile()||queries.size()>1){returnoutputFileName+".zip";
else{returnoutputFileName+format.getFileExtension();
if(format==null)thrownewWFSException("Unknownoutputformat"+outputFormat);//createthefirsttempdirectory,usedfordumpinggsgenerated//contentFiletempGS=org.geoserver.data.util.IOUtils.createTempDirectory("ogrtmpin");FiletempOGR=org.geoserver.data.util.IOUtils.createTempDirectory("ogrtmpout");//buildtheogrwrapperusedtoruntheogr2ogrcommandsToolWrapperwrapper=newOGRWrapper(ogrExecutable,environment);//actuallyexporteachfeaturecollectiontry{IteratoroutputFeatureCollections=featureCollection.getFeature().iterator();SimpleFeatureCollectioncurCollection;FileoutputFile=null;while(outputFeatureCollections.hasNext()){curCollection=(SimpleFeatureCollection)outputFeatureCollections.next();//writeoutthegmlFileintermediate=writeToDisk(tempGS,curCollection);//convertwithogr2ogrfinalSimpleFeatureTypeschema=curCollection.getSchema();finalCoordinateReferenceSystemcrs=schema.getCoordinateReferenceSystem();outputFile=wrapper.convert(intermediate,tempOGR,schema.getTypeName(),format,crs);//wipeouttheinputdircontentsIOUtils.emptyDirectory(tempGS);
if(format.isSingleFile()&&featureCollection.getFeature().size()==1){FileInputStreamfis=null;try{fis=newFileInputStream(outputFile);org.apache.commons.io.IOUtils.copy(fis,output);
if(fis!=null){fis.close();
else{//scantheoutputdirectoryandzipitallZipOutputStreamzipOut=null;try{zipOut=newZipOutputStream(output);IOUtils.zipDirectory(tempOGR,zipOut,null);zipOut.finish();
ifthefeaturetypeallowsforit,GMLotherwise**@paramtempDir*@paramcurCollection*/privateFilewriteToDisk(FiletempDir,SimpleFeatureCollectioncurCollection)throwsException{//ogr2ogrcannothandleemptygmlcollections,butitcanhandleempty//shapefilesfinalSimpleFeatureTypeoriginalSchema=curCollection.getSchema();
if(curCollection.isEmpty()){
if(isShapefileCompatible(originalSchema)){returnwriteShapefile(tempDir,curCollection);
else{SimpleFeatureTypesimplifiedShema=buildShapefileCompatible(originalSchema);returnwriteShapefile(tempDir,newEmptyFeatureCollection(simplifiedShema));
if(!(atinstanceofGeometryDescriptor)){tb.add(at);
iftheschemahasjustonegeometryandthegeomtypeisknown**@paramschema*/privatebooleanisShapefileCompatible(SimpleFeatureTypeschema){GeometryTypegt=null;for(AttributeDescriptorat:schema.getAttributeDescriptors()){
if(atinstanceofGeometryDescriptor){
if(gt==null)gt=((GeometryDescriptor)at).getType();
else//morethanonegeometryreturnfalse;
if(dstore!=null){dstore.dispose();
if(objectinstanceofGeometryCollection){
if(objectinstanceofMultiPoint){newGML2(MultiPoint.class,GML.MultiPoint).encode(object,output);
else
if(objectinstanceofMultiLineString){newGML2(MultiLineString.class,GML.MultiLineString).encode(object,output);
else
if(objectinstanceofMultiPolygon){newGML2(MultiPolygon.class,GML.MultiPolygon).encode(object,output);
else{newGML2(GeometryCollection.class,GML._Geometry).encode(object,output);
else{
if(objectinstanceofPoint){newGML2(Point.class,GML.Point).encode(object,output);
else
if(objectinstanceofLineString){newGML2(LineString.class,GML.LineString).encode(object,output);
else
if(objectinstanceofPolygon){newGML2(Polygon.class,GML.Polygon).encode(object,output);
if(objectinstanceofGeometryCollection){
if(objectinstanceofMultiPoint){newGML3(MultiPoint.class,GML.MultiPoint).encode(object,output);
else
if(objectinstanceofMultiLineString){newGML3(MultiLineString.class,GML.MultiLineString).encode(object,output);
else
if(objectinstanceofMultiPolygon){newGML3(MultiPolygon.class,GML.MultiPolygon).encode(object,output);
else{newGML3(GeometryCollection.class,GML._Geometry).encode(object,output);
else{
if(objectinstanceofPoint){newGML3(Point.class,GML.Point).encode(object,output);
else
if(objectinstanceofLineString){newGML3(LineString.class,GML.LineString).encode(object,output);
else
if(objectinstanceofPolygon){newGML3(Polygon.class,GML.Polygon).encode(object,output);
if(gf.getAbstractQueryExpression().isEmpty()){thrownewWFSException(gpv,"Requestdidnotspecifyaquery");
if(location==null||!(location.getComponent().getDefaultModel().getObject()instanceofLayerGroupEntry)){return;
if(movedItem.equals(targetItem)){return;
if(idx<(items.size()-1)){items.add(idx,movedItem);
else{items.add(movedItem);
if(property==POSITION){ParamResourceModelupTitle=newParamResourceModel("moveToTop",this);ParamResourceModeldownTitle=newParamResourceModel("moveToBottom",this);component=newUpDownPanel<T>("component",(T)itemModel.getObject(),dataProvider.getItems(),ReorderableTablePanel.this,upTitle,downTitle);
else
if(property==RENDERING_ORDER){component=newLabel("component",newModel<String>());
else{component=getComponentForProperty("component",itemModel,property);
if(component==null){//showaplainlabel
ifthethesubclassdidnotcreateanycomponentcomponent=newLabel("component",property.getModel(itemModel));
else
if(!"component".equals(component.getId())){//addsomechecksfortheid,theerrormessage//thatwicketreturnsincaseofmismatchisnot//thathelpfulthrownewIllegalArgumentException("getComponentForPropertyasked"+"tobuildacomponent"+"withid='component'"+"forproperty'"+property.getName()+"',butgot'"+component.getId()+"'instead");
if(property==RENDERING_ORDER){Labellabel=(Label)item.get(0);@SuppressWarnings("unchecked")OddEvenItem<T>rowContainer=(OddEvenItem<T>)item.getParent().getParent();label.setDefaultModel(newModel<Integer>(rowContainer.getIndex()+1));item.add(newBehavior(){privatestaticfinallongserialVersionUID=8429550827543813897L;@OverridepublicvoidonComponentTag(Componentcomponent,ComponentTagtag){tag.put("style","width:1%");
if(elements==null){return;
if(e.getClass().getSimpleName().startsWith("Insert")){flag|=1;
else
if(e.getClass().getSimpleName().startsWith("Update")){flag|=2;
else
if(e.getClass().getSimpleName().startsWith("Delete")){flag|=4;
else{flag|=8;
if((flag&1)==1)sb.append("I");
if((flag&2)==2)sb.append("U");
if((flag&4)==4)sb.append("D");
if((flag&8)==8)sb.append("O");data.setSubOperation(sb.toString());
if(elements==null){returnnull;
if(EMFUtils.has((EObject)e,"typeName")){ObjecttypeName=EMFUtils.get((EObject)e,"typeName");
if(typeName!=null){layers.add(toString(typeName));
else{//thisismostlikelyaninsert,determinelayersfromfeaturecollection
if(isInsert(e)){List<Feature>features=(List<Feature>)EMFUtils.get((EObject)e,"feature");Set<String>set=newLinkedHashSet<String>();for(Featuref:features){
if(finstanceofSimpleFeature){set.add(((SimpleFeature)f).getType().getTypeName());
else{set.add(f.getType().getName().toString());
if(isInsert(element)){//checkforsrsNameoninsertelementReferencedEnvelopebbox=null;
if(OwsUtils.has(element,"srsName")){Objectsrs=OwsUtils.get(element,"srsName");CoordinateReferenceSystemcrs=crs(srs);
if(crs!=null){bbox=newReferencedEnvelope(crs);bbox.setToNull();
if(fbbox==null){continue;
if(bbox==null){bbox=newReferencedEnvelope(fbbox);
if(isInsert(element)&&OwsUtils.has(element,"srsName")){CoordinateReferenceSystemcrs=crs(OwsUtils.get(element,"srsName"));
if(crs!=null){returncrs;
ifthevaluehasalreadybeenparsed*/publicbooleanresolved();/***Returnsthenumberof"long"stepstobecarriedoutinordertogetthisinput.Alongstep*iseitherexecutingasub-process,orhavingtofetcharemotedataset*/intlongStepCount();}
if(dataSource!=null){DataSourcedataSource=this.dataSource;this.dataSource=null;this.LOGBACKLOGGER=null;this.configResource=null;LogStoreInitializer.dispose(dataSource);
if(enabled){dataSource=newDataSource(properties,configResource);booleanrunScript=Boolean.valueOf(properties.getProperty(PROP_RUN_SCRIPT));
if(runScript){StringscriptProp=properties.getProperty(PROP_SCRIPT);Resourcescript=resolveScript(scriptProp,configResource);runScript(dataSource,script);//allgood,letsdisablethescriptforthenextrunsproperties.setProperty(PROP_RUN_SCRIPT,"false");saveConfig(properties,configResource);
if(scriptResource.getType().equals(Resource.Type.UNDEFINED)){scriptResource=configResource.parent().get(scriptProp);checkArgument(scriptResource.getType().equals(Resource.Type.RESOURCE),"Scriptfile%sdoesnotexist",scriptResource.path());
if(enabled&&message!=null){Stringmsg=buildMessage(repoUrl,message);LOGBACKLOGGER.debug(msg);
if(enabled&&message!=null){Stringmsg=buildMessage(repoUrl,message);LOGBACKLOGGER.info(msg);
if(enabled&&message!=null){Stringmsg=buildMessage(repoUrl,message);LOGBACKLOGGER.error(msg,exception);
if(severity!=null){sql.append("WHERElevel_stringIN(");for(Iterator<Severity>it=Arrays.asList(severity).iterator();it.hasNext();){Severitys=it.next();sql.append('\'').append(s.toString()).append('\'');
if(it.hasNext()){sql.append(",");
if(name==null){name="anonymous";
if(configResource.getType().equals(Resource.Type.UNDEFINED)){createDefaultConfig(configResource);
if(params.get(KEY_ALIAS)!=null)writer.write("<alias>"+params.get(KEY_ALIAS)+"</alias>");writer.write("<SRS>"+params.get(KEY_SRS_NUMBER)+"</SRS>");//thismocktypemayhavewrongSRScomparedtotheactualoneinthepropertyfiles...//let'sconfigureSRShandlingnottoaltertheoriginalone,andhave4326usedonly//forcapabilitieswriter.write("<SRSHandling>"+params.get(KEY_SRS_HANDLINGS)+"</SRSHandling>");writer.write("<title>"+type+"</title>");writer.write("<abstract>abstractabout"+type+"</abstract>");writer.write("<numDecimalsvalue=\"8\"/>");writer.write("<keywords>"+type+"</keywords>");EnvelopellEnvelope=(Envelope)params.get(KEY_LL_ENVELOPE);
if(llEnvelope==null)llEnvelope=DEFAULT_ENVELOPE;writer.write("<latLonBoundingBoxdynamic=\"false\"minx=\""+llEnvelope.getMinX()+"\"miny=\""+llEnvelope.getMinY()+"\"maxx=\""+llEnvelope.getMaxX()+"\"maxy=\""+llEnvelope.getMaxY()+"\"/>");EnvelopenativeEnvelope=(Envelope)params.get(KEY_NATIVE_ENVELOPE);
if(nativeEnvelope!=null)writer.write("<nativeBBoxdynamic=\"false\"minx=\""+nativeEnvelope.getMinX()+"\"miny=\""+nativeEnvelope.getMinY()+"\"maxx=\""+nativeEnvelope.getMaxX()+"\"maxy=\""+nativeEnvelope.getMaxY()+"\"/>");Stringstyle=(String)params.get(KEY_STYLE);
if(style==null)style="Default";writer.write("<stylesdefault=\""+style+"\"/>");writer.write("</featureType>");writer.flush();writer.close();}}
if(null==metaWidthHeight){metaWidthHeight=newint[2];
ifitwasspecified.
if(autoCacheStyles!=null){
if(autoCacheStyles){
if(!isAutoCacheStyles()){addParameterFilter(newStyleParameterFilter());
else{
if(isAutoCacheStyles()){this.removeParameterFilter("STYLES");
if(styleQualifier!=null){List<String>styles=styleQualifier.getLegalValues();
if(styles!=null){returnImmutableSet.copyOf(styles);
if(autoCacheStyles){//AddadefaultStyleParameterFilter.ParameterFilternewFilter=newStyleParameterFilter();addParameterFilter(newFilter);
else{ParameterFilterfilter=getParameterFilter("STYLES");
if(filter!=null&&filterinstanceofStyleParameterFilter){parameterFilters.remove(filter);
ifthereisanexception(suchasatimeout)*thrownwhenrenderingaWMSrequest.*/publicclassWMSPartialMapExceptionextendsServiceException{WebMapmap;/***Constructstheexceptionfromamessage.**@parammessageThemessagedescribingtheexception.*@parammapWebMapassociatedwiththeWMSrequestthatthrewtheexception*/publicWMSPartialMapException(Stringmessage,WebMapmap){super(message);this.map=map;
if(tiffnames!=null){
if(tiffnames.length>0){input=newFile(targetDir,tiffnames[0]);output=newFile(targetDir,"DUMMY_watertemp_000_"+tsFormatter.format(newDate(justPast))+"T0000000_12.tiff");FileUtils.copyFile(input,output);output=newFile(targetDir,"DUMMY_watertemp_000_"+tsFormatter.format(newDate(oneMonthInFuture))+"T0000000_12.tiff");FileUtils.copyFile(input,output);output=newFile(targetDir,"DUMMY_watertemp_000_"+tsFormatter.format(newDate(oneYearInFuture))+"T0000000_12.tiff");FileUtils.copyFile(input,output);
if(!file.exists()){thrownewIllegalArgumentException("Thereisnofilewithname'"+prefix+File.separator+name+"'inthedatadirectory");
if(format==null){thrownewRuntimeException("Noformatfor"+file.getCanonicalPath());
if(reader==null){thrownewRuntimeException("Noreaderfor"+file.getCanonicalPath()+"withformat"+format.getName());
ifitdoesn'talreadyexist
if(catalog.getWorkspaceByName(prefix)==null){((SystemTestData)testData).addWorkspace(prefix,qName.getNamespaceURI(),catalog);
if(store==null){store=catalog.getFactory().createCoverageStore();
if(store.getId()==null){catalog.add(store);
else{catalog.save(store);
if(formatinstanceofImageMosaicFormat){//makesureweworkinimmediatemodecoverage.getParameters().put(AbstractGridFormat.USE_JAI_IMAGEREAD.getName().getCode(),Boolean.FALSE);
if(cov==null){catalog.add(coverage);
else{builder.updateCoverage(cov,coverage);catalog.save(cov);coverage=cov;
if(layer==null){layer=catalog.getFactory().createLayer();
if(layer.getId()==null){catalog.add(layer);
else{catalog.save(layer);
if(reader!=null){reader.dispose();
ifclosehasbeencalled,ornotFeatureTypeInfofti=getCatalog().getFeatureTypeByName(getLayerId(MockData.POLYGONS));FeatureSourcefs=fti.getFeatureSource(null,null);SimpleFeatureCollectionfc=(SimpleFeatureCollection)fs.getFeatures();finalAtomicIntegeropenIterators=newAtomicInteger(0);FeatureCollectiondecorated=neworg.geotools.feature.collection.DecoratingSimpleFeatureCollection(fc){@OverridepublicSimpleFeatureIteratorfeatures(){openIterators.incrementAndGet();finalSimpleFeaturef=DataUtilities.first(delegate);returnnewSimpleFeatureIterator(){@OverridepublicSimpleFeaturenext()throwsNoSuchElementException{returnf;
if(count>100){thrownewIOException("Simularingclientshuttingdownconnection");
if(l.getResource()instanceofFeatureTypeInfo){items.add(l);
if(l.getResource()instanceofCoverageInfo){items.add(l);
if(property==LayerProvider.name){returnnewFragment(id,"layer.link",LayerChooser.this){privatestaticfinallongserialVersionUID=-7619814477490657757L;{add(newGeoServerAjaxFormLink("link",parent.styleForm){{add(newLabel("layer.name",newModel<String>(text)));
else{returnnewLabel(id,text);
if(count==null){count=newInteger(1);
else{count=newInteger(count+1);
if(uri!=null)urlString+=uri;URLurl=newURL(urlString);HttpURLConnectioncon=(HttpURLConnection)url.openConnection();con.getInputStream().close();}}
ifitisrunning,andfreesupresources.**@taskREVISIT:whatweshouldconsiderishavinggeotoolsprovideanicerwaytocleanup*datastores'sresources,somethinglikeaclose,sothatwecouldjustiteratethroughall*thedatastorescallingclose.Oncethat'sdonewecancleanupthismethodabit.*/publicvoiddestroy(){super.destroy();//ConnectionPoolManager.getInstance().closeAll();/*HACK:wemustgetastandardAPIwayforreleasingresources...*/try{ClasssdepfClass=Class.forName("org.geotools.data.arcsde.ConnectionPoolFactory");LOGGER.fine("SDEdatasourcefound,releasingresources");java.lang.reflect.Methodm=sdepfClass.getMethod("getInstance",newClass[0]);ObjectpfInstance=m.invoke(sdepfClass,newObject[0]);LOGGER.fine("gotsdeconnectionpoolfactoryinstance:"+pfInstance);java.lang.reflect.MethodcloseMethod=pfInstance.getClass().getMethod("closeAll",newClass[0]);closeMethod.invoke(pfInstance,newObject[0]);LOGGER.info("justaskedSDEdatasourcetoreleaseconnections");
if(featureinstanceofGridCoverage2D){GridCoverage2Dcoverage=(GridCoverage2D)feature;Objectprop=coverage.getProperty(arg0);
if(prop!=null){Numbernumber=(Number)prop;returnnumber;
if(property==ServiceAccessRuleProvider.RULEKEY){returneditRuleLink(id,itemModel,property);
if(property==ServiceAccessRuleProvider.ROLES){returnnewLabel(id,property.getModel(itemModel));
if(res.equals(CalcResult.NULL_RESULT)){returnnull;
else{returnConverters.convert(min.getMin(),clz);
ifanioexceptionoccursopeningorloadingthefile*/privateStringgetFileContents(finalStringreqFileName)throwsIOException{finalResourcefile=demoDir.get(reqFileName);finalStringBuildersb=newStringBuilder();finalBufferedReaderreader=newBufferedReader(newInputStreamReader(file.in()));Stringline;try{while((line=reader.readLine())!=null){sb.append(line);sb.append("\n");
if(StringUtils.isEmpty(proxyBaseUrl)){GeoServergs=getGeoServer();proxyBaseUrl=gs.getGlobal().getSettings().getProxyBaseUrl();
if(StringUtils.isEmpty(proxyBaseUrl)){baseUrl=ResponseUtils.baseURL(httpServletRequest);
else{baseUrl=proxyBaseUrl;
else{baseUrl=proxyBaseUrl;
if(demoRequestIsHttpGet){Stringurl=ResponseUtils.appendPath(baseUrl,contents);urlTextField.setModelObject(url);body.setModelObject("");
else{StringserviceUrl=ResponseUtils.appendPath(baseUrl,service);urlTextField.setModelObject(serviceUrl);body.setModelObject(contents);
if(file.getType()!=Type.DIRECTORY){finalStringname=file.name();
if(name.endsWith(".url")||name.endsWith(".xml")){demoList.add(name);
else{LOGGER.warning("Ignoringfile"+name+"indemorequestsdirectory,only.urland.xmlfilesallowed");
if(offset!=null&&limit==null){limit=Integer.MAX_VALUE;//ensurewedon'twraparound
if(limit!=null&&offset==null){offset=0;limit+=1;//notzero-based
if(offset!=null&&limit!=null){sql.insert(0,"select*from(selectquery.*,rownumrnumfrom(\n");sql.append(")query\n");
if(limit!=Integer.MAX_VALUE){limit=offset+limit;
if(SecurityUtils.isSecurityException(e)){se=e;
if(e==null){fail("WeshouldhavegotsomesortofSpringSecurityException");
else{//somemumblingaboutnothavingenoughprivilegesassertTrue(se.getMessage().contains("World"));assertTrue(se.getMessage().contains("privileges"));
if(createDBSqlResource!=null){Connectionconnection=null;connection=getDataSource().getConnection();runSql(createDBSqlResource,connection);
if(is!=null){is.close();
if(request.getFormat().contains("8")){returnMIME_TYPE_8BIT;
else{returnMIME_TYPE;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Writingpngimage...");
ifwehavetoseeatranslucentorbitmaskquantizerimage=applyPalette(image,mapContent,"image/png8",true);floatquality=(100-wms.getPngCompression())/100.0f;JAIInfo.PngEncoderTypeencoder=wms.getPNGEncoderType();
if(encoder==JAIInfo.PngEncoderType.PNGJ){image=newPNGJWriter().writePNG(image,outStream,quality,mapContent);RasterCleaner.addImage(image);
else{BooleanPNGNativeAcc=(encoder==JAIInfo.PngEncoderType.NATIVE);SampleModelsm=image.getSampleModel();intnumBits=sm.getSampleSize(0);//pngaccelerationonlyworkson2bitand8bitimages,crasheson4bitsbooleannativeAcceleration=PNGNativeAcc.booleanValue()&&!(numBits>1&&numBits<8);ImageWorkeriw=newImageWorker(image);iw.writePNG(outStream,"FILTERED",quality,nativeAcceleration,false);RasterCleaner.addImage(iw.getRenderedImage());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Writingpngimage...done!");
if(REPOSITORY.sample!=null&&REPOSITORY.sample.equals(repoUriStr)){return;
if(repoUriStr!=null){try{RepositoryManagermanager=this.manager.get();URIrepoURI=newURI(repoUriStr);RepositoryResolverresolver=RepositoryResolver.lookup(repoURI);StringrepoName=resolver.getName(repoURI);RepositoryInforepoInfo=manager.getByRepoName(repoName);
if(repoInfo!=null){StringrepoId=repoInfo.getId();List<Ref>branchRefs=manager.listBranches(repoId);for(Refbranch:branchRefs){branchNames.add(branch.localName());
if(reportError){form.error("Couldnotlistbranches:"+e.getMessage());
if(current!=null&&!branchNames.contains(current)){branchNames.add(0,current);
if(providerNames!=null){for(StringproviderName:providerNames.split("\\s*,\\s*")){cacheProvider=(CacheProvider)(CacheProvider)GeoServerExtensions.bean(providerName);
if(cacheProvider!=null){LOGGER.log(Level.INFO,"UsingspecifiedCacheProvider",providerName);break;
if(cacheProvider==null){LOGGER.log(Level.INFO,"{0}wasspecifiedbutnobeansmatchedit.",BEAN_NAME_PROPERTY);
if(cacheProvider==null){try{cacheProvider=GeoServerExtensions.bean(CacheProvider.class);
if(LOGGER.isLoggable(Level.WARNING)){Stringavailable=StringUtils.join(ex.getAvailableBeans(),",");LOGGER.log(Level.WARNING,"MultipleCacheProvidersincontext:{0}\n\tUsing{1}.Overridebysettingsystemproperty{2}",newObject[]{available,providerName,BEAN_NAME_PROPERTY});
if(cacheProvider==null){cacheProvider=newDefaultCacheProvider();
ifwehavethecorrectcomponentsinstantiatedtester.assertComponent("form",Form.class);tester.assertComponent("form:name",TextField.class);tester.assertComponent("form:coverages",CoverageViewEditor.class);tester.assertComponent("form:coverages:coveragesChoice",ListMultipleChoice.class);tester.assertComponent("form:coverages:outputBandsChoice",ListMultipleChoice.class);tester.assertComponent("form:coverages:addBand",Button.class);//checktheavailablebandsnameswithoutanyselectedbandCoverageViewEditorcoverageViewEditor=(CoverageViewEditor)tester.getComponentFromLastRenderedPage("form:coverages");coverageViewEditor.setModelObject(null);ListMultipleChoiceavailableBands=(ListMultipleChoice)tester.getComponentFromLastRenderedPage("form:coverages:coveragesChoice");ListMultipleChoiceselectedBands=(ListMultipleChoice)tester.getComponentFromLastRenderedPage("form:coverages:outputBandsChoice");//selectthefirstbandFormTesterformTester=tester.newFormTester("form");formTester.selectMultiple("coverages:coveragesChoice",newint[]{0});tester.executeAjaxEvent("form:coverages:addBand","click");//checkthatthecoveragenamecontainsthebandindexassertThat(availableBands.getChoices().size(),is(1));assertThat(availableBands.getChoices().get(0),is("time_domainsRanges"));assertThat(selectedBands.getChoices().size(),is(1));CoverageView.CoverageBandselectedBand=(CoverageView.CoverageBand)selectedBands.getChoices().get(0);assertThat(selectedBand.getDefinition(),is("time_domainsRanges"));//setanameandsubmitformTester.setValue("name","bands_index_coverage_test");formTester.submit("save");
if(!file.delete()){//failearlyastestswillexpectit'sdeletedthrownewIOException("deletionfailedduringextraction");
if(SKIPPED==null){
if(!newSpatiaLiteDataStoreFactory().isAvailable()){SKIPPED=true;System.out.println("Skippingspatialitetests,nativelibrariesnotinstalled");
else{SKIPPED=false;
ifexistWFSError,checkingforMimeType.IfMimeTypeis"application/xml",thenan*errorhasoccurred*/@TestpublicvoidtestWFSError()throwsException{MockHttpServletResponseresp=getAsServletResponse("wfs?request=GetFeature&typeName=Points&outputFormat=spatialite");assertNotSame("application/xml",resp.getContentType());
if(aByte!=0){contentNull=false;break;
if(node.hasChild(Filter.class)){lock.setFilter((Filter)node.getChildValue(Filter.class));
if(node.hasAttribute("handle")){lock.setHandle((String)node.getAttributeValue("handle"));
iftheprocessisstillin-flightStringexecutionId=request.getExecutionId();ExecutionStatusstatus=tracker.getStatus(executionId);
if(status==null){thrownewUnknownExecutionIdException(executionId);
if(status.getPhase().isExecutionCompleted()){ResourcestoredResponse=resources.getStoredResponse(executionId);
if(storedResponse==null||storedResponse.getType()==Type.UNDEFINED){thrownewWPSException("Theexecutioniscompletedwithstatus"+status.getPhase()+"andyettheresponsecannotbelocatedondisk,thisisaninternalfailure");
else{returnstoredResponse;
else
if(status.getPhase()==ProcessState.DISMISSING){//incaseofdismissalwehavetopretendwedon'tknowtheexecutionidthrownewUnknownExecutionIdException(executionId);
else{returnnewStatusResponseBuilder(resources,ctx).buildStatusResponse(status);
if(baseUrl!=null){interpolationProperties.put("url.wfs",ResponseUtils.buildURL(baseUrl,"wfs",null,URLType.SERVICE));interpolationProperties.put("url.wms",ResponseUtils.buildURL(baseUrl,"wms",null,URLType.SERVICE));
if(q.getStartIndex()!=null){startIndex=q.getStartIndex();
if(q.getFilter()!=null&&q.getFilter()!=Filter.INCLUDE){Filterfilter=q.getFilter();unmapped=(Filter)filter.accept(unmapper,null);
if(q.getSortBy()!=null&&q.getSortBy().length>0){unmappedSortBy=newSortBy[q.getSortBy().length];for(inti=0;i<q.getSortBy().length;i++){SortBysortby=q.getSortBy()[i];Expressionexpr=(Expression)sortby.getPropertyName().accept(unmapper,null);
if(!(exprinstanceofPropertyName)){thrownewIOException("Sortingon"+sortby.getPropertyName()+"isnotsupported.");
if(q.getProperties()!=null&&q.getProperties().size()>0){outputMapping=outputMapping.subMapping(q.getProperties(),rd);
if(ExtensionFilter.class.isAssignableFrom(extensionPoint)){filters=Collections.emptyList();
else{filters=extensions(ExtensionFilter.class,context);
if(!excludeBean(name,bean,filters))result.add((T)bean);
if(!ExtensionProvider.class.isAssignableFrom(extensionPoint)&&!ExtensionFilter.class.isAssignableFrom(extensionPoint)){List<Object>secondary=newArrayList<Object>();for(ExtensionProviderxp:extensions(ExtensionProvider.class,context)){try{
if(extensionPoint.isAssignableFrom(xp.getExtensionPoint())){secondary.addAll(xp.getExtensions(extensionPoint));
if(spiExtensions==null){spiExtensions=newArrayList<Object>();ServiceLoader.load(extensionPoint).iterator().forEachRemaining(spiExtensions::add);spiCache.put(extensionPoint,spiExtensions);
if(o1instanceofExtensionPriority){p1=((ExtensionPriority)o1).getPriority();
if(o2instanceofExtensionPriority){p2=((ExtensionPriority)o2).getPriority();
if(GeoServerExtensions.context==context){names=extensionsCache.get(extensionPoint);
else{names=null;
if(names==null){checkContext(context,extensionPoint.getSimpleName());
if(context!=null){try{names=context.getBeanNamesForType(extensionPoint);
if(names==null){names=newString[0];
ifdealingwiththesamecontext
if(GeoServerExtensions.context==context){extensionsCache.put(extensionPoint,names);
iftheapplication//contexthasbeenclosedandanon-onetimesetuptestis//runthattriggersanextensionlookupLOGGER.log(Level.WARNING,"beanlookuperror",e);returnCollections.emptyList();
else{returnCollections.emptyList();
if(bean==null&&context!=null){bean=context.getBean(name);
if(bean!=null&&context.isSingleton(name)){singletonBeanCache.put(name,bean);
if(!excludeBean(null,bean,filters))result.add(bean);
ifanyofthe{@linkExtensionFilter}askstoexcludethebean*/privatestaticbooleanexcludeBean(StringbeanId,Objectbean,List<ExtensionFilter>filters){for(ExtensionFilterfilter:filters){
if(filter.exclude(beanId,bean))returntrue;
if(context!=null){returngetBean(context,name);
else{Objectbean=singletonBeanCache.get(name);returnbean;
ifthereisnosuchbean.Anexceptionisthrown
ifmultiple*beansofthespecifiedtypeexist.**@paramtypeTHetypeofthebeantolookup.*@throwsMultipleBeansExceptionIftherearemultiplebeansofthespecifiedtypeinthe*context.*/publicstaticfinal<T>Tbean(Class<T>type)throwsIllegalArgumentException{checkContext(context,type.getSimpleName());returnbean(type,context);
ifthereisnosuchbean.Anexceptionisthrown
ifmultiple*beansofthespecifiedtypeexist.**@paramtypeTHetypeofthebeantolookup.*@paramcontextTheapplicationcontext*@throwsMultipleBeansExceptionIftherearemultiplebeansofthespecifiedtypeinthe*context.*/publicstaticfinal<T>Tbean(Class<T>type,ApplicationContextcontext)throwsIllegalArgumentException{List<T>beans=extensions(type,context);
if(beans.isEmpty()){returnnull;
if(beans.size()>1){thrownewMultipleBeansException(type,extensionNames(type,context));
if(eventinstanceofContextRefreshedEvent){extensionsCache.clear();singletonBeanCache.clear();
ifnullwillissueawarning.*/staticvoidcheckContext(ApplicationContextcontext,Stringbean){
if(context==null&&isSpringContext){LOGGER.warning("Extensionlookup'"+bean+"',butApplicationContextisunset.");
ifnotfound*/publicstaticStringgetProperty(StringpropertyName){returngetProperty(propertyName,context);
ifthecontextisa{@linkWebApplicationContext}*<li>Environmentvariable*</ul>**andreturnsthefirstnonnull,nonemptyvaluefound.**@parampropertyNameThepropertynametobesearched*@paramcontextTheSpringcontext(maybenull)*@returnThepropertyvalue,ornull
ifnotfound*/publicstaticStringgetProperty(StringpropertyName,ApplicationContextcontext){
if(contextinstanceofWebApplicationContext){returngetProperty(propertyName,((WebApplicationContext)context).getServletContext());
else{returngetProperty(propertyName,(ServletContext)null);
ifnotfound*/publicstaticStringgetProperty(StringpropertyName,ServletContextcontext){//TODO:thiscodecomesfromthedatadirectorylookupandit'suseful//untilweprovideawayfortheusertomanuallyinspectthethreecontexts//(whentryingtodebugwhythevariabletheythinkthey'veset,andsoon,seealso//https://osgeo-org.atlassian.net/browse/GEOS-2343//Oncethatisfixed,wecanremovetheloggingcodethatmakesthismethodmorecomplex//thanstrictlynecessaryfinalString[]typeStrs={"Propertyoverride","Javaenvironmentvariable","Servletcontextparameter","Systemenvironmentvariable"};Stringresult=null;for(intj=0;j<typeStrs.length;j++){//Lookupsection
switch(j){case0:result=propertyCache.get(propertyName);break;case1:result=System.getProperty(propertyName);break;case2:
if(context!=null){result=context.getInitParameter(propertyName);
if(result==null||result.equalsIgnoreCase("")){LOGGER.finer("Found"+typeStrs[j]+":'"+propertyName+"'tobeunset");
else{break;
ifnotfound*/publicstaticFilefile(Stringpath){
if(fileCache.containsKey(path)){returnfileCache.get(path);//overrideprovidedbyGeoServerExtensionsHelper
if(contextinstanceofWebApplicationContext){ServletContextservletContext=((WebApplicationContext)context).getServletContext();Stringfilepath=servletContext.getRealPath(path);
if(filepath!=null){Filefile=newFile(filepath);
if(file.exists()){returnfile;
else{List<String>items=Paths.names(path);intindex=0;
if(index<items.size()){filepath=servletContext.getRealPath(items.get(index));index++;
if(filepath!=null){Filefile=newFile(filepath);while(index<items.size()){file=newFile(file,items.get(index));index++;
if(coverageAccess!=null){coverageAccess.dispose();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofGeoServerInfo)){returnfalse;
if(adminPassword==null){
if(other.getAdminPassword()!=null)returnfalse;
else
if(!adminPassword.equals(other.getAdminPassword()))returnfalse;
if(adminUsername==null){
if(other.getAdminUsername()!=null)returnfalse;
else
if(!adminUsername.equals(other.getAdminUsername()))returnfalse;
if(settings==null){
if(other.getSettings()!=null)returnfalse;
else
if(!settings.equals(other.getSettings()))returnfalse;
if(id==null){
if(other.getId()!=null)returnfalse;
else
if(!id.equals(other.getId()))returnfalse;
if(updateSequence!=other.getUpdateSequence())returnfalse;
if(!Objects.equals(globalServices,other.isGlobalServices()))returnfalse;
if(xmlPostRequestLogBufferSize==null){
if(other.getXmlPostRequestLogBufferSize()!=null){returnfalse;
else
if(!xmlPostRequestLogBufferSize.equals(other.getXmlPostRequestLogBufferSize())){returnfalse;
if(getResourceErrorHandling()==null){
if(other.getResourceErrorHandling()!=null)returnfalse;
else{
if(!getResourceErrorHandling().equals(other.getResourceErrorHandling()))returnfalse;
if(lockProviderName==null){
if(other.getLockProviderName()!=null)returnfalse;
else{
if(!lockProviderName.equals(other.getLockProviderName()))returnfalse;
if(this.globalServices==null){this.globalServices=true;
if(this.xmlPostRequestLogBufferSize==null){this.xmlPostRequestLogBufferSize=1024;
if(this.settings==null){this.settings=newSettingsInfoImpl();
if(contact!=null){setContact(contact);contact=null;
if(charset!=null){setCharset(charset);charset=null;
if(title!=null){setTitle(title);title=null;
if(numDecimals!=null){setNumDecimals(numDecimals);numDecimals=null;
if(onlineResource!=null){setOnlineResource(onlineResource);onlineResource=null;
if(schemaBaseUrl!=null){setSchemaBaseUrl(schemaBaseUrl);schemaBaseUrl=null;
if(proxyBaseUrl!=null){setProxyBaseUrl(proxyBaseUrl);proxyBaseUrl=null;
if(verbose!=null){setVerbose(verbose);verbose=null;
if(verboseExceptions!=null){setVerboseExceptions(verboseExceptions);verboseExceptions=null;
if(this.resourceErrorHandling==null){returnResourceErrorHandling.SKIP_MISCONFIGURED_LAYERS;
if(store==null){store=newMemoryProcessStatusStore();
if(store==null){return;
if(status!=null){status.setLastUpdated(newDate());store.save(status);
if(original.getPhase()==ProcessState.DISMISSING){event.getStatus().setPhase(ProcessState.FAILED);
if(original.getPhase()==ProcessState.DISMISSING){event.getStatus().setPhase(ProcessState.DISMISSING);
else{ExecutionStatusnewStatus=event.getStatus();newStatus.setLastUpdated(newDate());store.save(newStatus);
iffound,ornull,
if*notfound**@paramexecutionId*/publicExecutionStatusremove(StringexecutionId){returnstore.remove(executionId);
if(!Repository.class.equals(paramInfo.getBinding())&&!EntityResolver.class.equals(paramInfo.getBinding())){paramsMetadata.put(p.key,paramInfo);
if(isNew&&!p.isDeprecated()){applyParamDefault(paramInfo,info);
if(description!=null){inputComponent.add(AttributeModifier.replace("title",description));
if("namespace".equals(paramName)){IModelnamespaceModel=newNamespaceParamModel(paramsModel,paramName);IModelparamLabelModel=newResourceModel(paramLabel,paramLabel);parameterPanel=newNamespacePanel(componentId,namespaceModel,paramLabelModel,true);
else
if(options!=null&&options.size()>0){IModel<Serializable>valueModel=newMapModel(paramsModel,paramName);IModel<String>labelModel=newResourceModel(paramLabel,paramLabel);parameterPanel=newDropDownChoiceParamPanel(componentId,valueModel,labelModel,options,required);
else
if(Boolean.class==binding){//TODOAddprefixforbetteri18n?parameterPanel=newCheckBoxParamPanel(componentId,newMapModel(paramsModel,paramName),newResourceModel(paramLabel,paramLabel));
else
if(File.class==binding){parameterPanel=newFileParamPanel(componentId,newMapModel(paramsModel,paramName),newResourceModel(paramLabel,paramLabel),required);
else
if(String.class==binding&&paramMetadata.isPassword()){parameterPanel=newPasswordParamPanel(componentId,newMapModel(paramsModel,paramName),newResourceModel(paramLabel,paramLabel),required);
else{IModelmodel;
if("url".equalsIgnoreCase(paramName)){model=newURLModel(paramsModel,paramName);
else{model=newMapModel(paramsModel,paramName);
if(paramMetadata.isLargeText()){tp=newTextAreaParamPanel(componentId,model,newResourceModel(paramLabel,paramLabel),required);
else{tp=newTextParamPanel(componentId,model,newResourceModel(paramLabel,paramLabel),required);
ifitcanbeareferencetothelocalfilesystemmakesureit'svalidFormComponent<String>fc=((ParamPanel)tp).getFormComponent();//AF:DisableValidator
ifGeoServerEnvParametrizationisenabled!
if(paramName.equalsIgnoreCase("url")){
if(gsEnvironment==null||!GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){fc.add(newFileExistsValidator());
ifGeoServerEnvParametrizationisenabled!
if(gsEnvironment==null||!GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){
if(binding!=null&&!String.class.equals(binding)&&!File.class.equals(binding)&&!URL.class.equals(binding)&&!binding.isArray()){fc.setType(binding);
if(value==null){returntrue;
else
if(valueinstanceofString){return((String)value).isEmpty();
else{returnfalse;
if(!file.startsWith("file://")&&!file.startsWith("file:")&&!file.startsWith("http://"))file="file://"+file;super.setObject(file);
ifno{@linkGeoServerUserGroupService}is*needed.*/publicinterfaceSecurityAuthProviderConfigextendsSecurityNamedServiceConfig{publicStringgetUserGroupServiceName();publicvoidsetUserGroupServiceName(StringuserGroupServiceName);}
ifnotset//https://github.com/geotools/geotools/blob/bdcdaeca35f0cb1c465f2e11dd1b04bb7fff30df/modules/library/main/src/main/java/org/geotools/styling/StyleImpl.java#L45StyleImplstyle=(StyleImpl)catalog.getStyleByName(STYLE_NAME_WITHOUT_DESCRIPTION).getStyle();style.setDescription(null);//Forglobalset-upGeoServerInfoglobal=getGeoServer().getGlobal();global.getSettings().setProxyBaseUrl(BASE);getGeoServer().save(global);WMSInfowms=getGeoServer().getService(WMSInfo.class);wms.getSRS().add("EPSG:4326");getGeoServer().save(wms);Map<String,String>namespaces=newHashMap<String,String>();namespaces.put("xlink","http://www.w3.org/1999/xlink");namespaces.put("","http://www.opengis.net/wms");namespaces.put("wms","http://www.opengis.net/wms");getTestData().registerNamespaces(namespaces);XMLUnit.setXpathNamespaceContext(newSimpleNamespaceContext(namespaces));
if(i<LOOPS-1){sb.append("OR");
if(source!=null){return(TYPE)source;
else{thrownewIllegalArgumentException(this.getClass().getCanonicalName()+"isunabletodeserializetheobject:"+s);
if(fields!=null){returnfields.split(";");
else{List<String>props=OwsUtils.getClassProperties(RequestData.class).properties();props.remove("Class");props.remove("Body");props.remove("Error");returnprops.toArray(newString[props.size()]);
if(objectinstanceofRequestData){returnwrapObject((RequestData)object,RequestData.class);
else{finalList<RequestData>requests=newArrayList<>();BaseMonitorConverter.handleRequests(object,newRequestDataVisitor(){publicvoidvisit(RequestDatadata,Object...aggregates){requests.add(data);
if(oinstanceofRequestData){return"request.html";
else{return"requests.html";
if(req==null){Queryq=newQuery().between(from!=null?parseDate(from):null,to!=null?parseDate(to):null);//filter
if(filter!=null){try{parseFilter(filter,q);
if(order!=null){intsemi=order.indexOf(';');
if(semi!=-1){String[]split=order.split(";");sortBy=split[0];sortOrder=SortOrder.valueOf(split[1]);
else{sortBy=order;sortOrder=SortOrder.ASC;
if(live!=null){
if(live){q.filter("status",Arrays.asList(org.geoserver.monitor.RequestData.Status.RUNNING,org.geoserver.monitor.RequestData.Status.WAITING,org.geoserver.monitor.RequestData.Status.CANCELLING),Comparison.IN);
else{q.filter("status",Arrays.asList(org.geoserver.monitor.RequestData.Status.FINISHED,org.geoserver.monitor.RequestData.Status.FAILED),Comparison.IN);
else{//returntheindividualRequestDatadata=monitor.getDAO().getRequest(Long.parseLong(req));
if(data==null){thrownewResourceNotFoundException("Nosuchrequest"+req);
if("".equals(s.trim()))continue;String[]split=s.split(":");Stringleft=split[0];Objectright=split[2];
if(right.toString().contains(",")){Listlist=newArrayList();for(Stringt:right.toString().split(",")){list.add(parseProperty(left,t));
else{right=parseProperty(left,right.toString());
if("status".equals(property)){returnorg.geoserver.monitor.RequestData.Status.valueOf(value);
if(req==null){monitor.getDAO().clear();
else{thrownewRestException("Cannotdeleteaspecificrequest",HttpStatus.METHOD_NOT_ALLOWED);
ifcodenotset
if(!(einstanceofServiceException)||((ServiceException)e).getCode()==null){e=newWFSException("Requestparsingfailed",e,"OperationParsingFailed");
ifmaxFeaturesdoesn'taffecttotalFeatureCount;setFilterandmaxFeaturesStringout3=getAsString("wfs?request=GetFeature&version=1.0.0&typename=sf:PrimitiveGeoFeature&maxfeatures=1&outputformat="+JSONType.json+"&featureid=PrimitiveGeoFeature.f001,PrimitiveGeoFeature.f002");JSONObjectrootObject3=JSONObject.fromObject(out3);assertEquals(rootObject3.get("totalFeatures"),2);
ifmaxFeaturesdoesn'taffecttotalFeatureCount;setFilterandmaxFeaturesStringout3=getAsString("wfs?request=GetFeature&version=2.0.0&typename=sf:PrimitiveGeoFeature&count=1&outputformat="+JSONType.json+"&featureid=PrimitiveGeoFeature.f001,PrimitiveGeoFeature.f002");JSONObjectrootObject3=JSONObject.fromObject(out3);assertEquals(rootObject3.get("totalFeatures"),2);assertEquals(rootObject3.get("numberMatched"),2);assertNull(rootObject3.get("links"));//requestwithmultiplefeatureTypesandFilterStringout4=getAsString("wfs?request=GetFeature&version=2.0.0&typename=sf:PrimitiveGeoFeature,sf:AggregateGeoFeature&outputformat="+JSONType.json+"&featureid=PrimitiveGeoFeature.f001,PrimitiveGeoFeature.f002,AggregateGeoFeature.f009");JSONObjectrootObject4=JSONObject.fromObject(out4);assertEquals(rootObject4.get("totalFeatures"),3);assertEquals(rootObject4.get("numberMatched"),3);assertNull(rootObject4.get("links"));
ifeithermatchesagainst//theexpectedCRS.Sorry,thisisahorriblehack.KSCoordinateReferenceSystemdecodedDefault=decodeCRS((JSONObject)item,false);
if(CRS.equalsIgnoreMetadata(crs,decodedDefault))returntrue;CoordinateReferenceSystemdecodedXY=decodeCRS((JSONObject)item,true);
if(CRS.equalsIgnoreMetadata(crs,decodedXY))returntrue;Stringidentifier=((JSONObject)item).getJSONObject("properties").getString("name");Patternp=Pattern.compile("^urn:ogc:def:crs:EPSG:[^:]*:(\\d+)$");Matcherm=p.matcher(identifier);
if(m.matches()){Stringcode="EPSG:"+m.group(1);CoordinateReferenceSystemdecodedStripped;try{decodedStripped=CRS.decode(code,true);
if(CRS.equalsIgnoreMetadata(crs,decodedStripped))returntrue;
if(!json.getString("type").equals("name"))thrownewIllegalArgumentException();Stringidentifier=json.getJSONObject("properties").getString("name");try{returnCRS.decode(identifier,forceXY);
if(value==null){value=(Serializable)model.getObject().get(expression,target);
if(config.isJndi()){comp=newJDBCConnectFormComponent("jdbcConnectFormComponent",Mode.DYNAMIC,config.getJndiName());
else{comp=newJDBCConnectFormComponent("jdbcConnectFormComponent",Mode.DYNAMIC,config.getDriverClassName(),config.getConnectURL(),config.getUserName(),config.getPassword());
if(config.isJndi()){config.setJndiName(c.getJndiName());
else{config.setDriverClassName(c.getDriverName());config.setConnectURL(c.getConnectURL());config.setUserName(c.getUsername());config.setPassword(c.getPassword());
if("mode".equalsIgnoreCase(ruleKey)){try{catalogMode=CatalogMode.valueOf(ruleValue.toUpperCase());
else{DataAccessRulerule=parseDataAccessRule(ruleKey,ruleValue);
if(rule!=null){
if(result.contains(rule))LOGGER.warning("Rule"+ruleKey+"."+ruleValue+"overwritesanotherruleonthesamepath");result.add(rule);
ifthesetisempty
if(result.size()==0){result.add(newDataAccessRule(DataAccessRule.READ_ALL));result.add(newDataAccessRule(DataAccessRule.WRITE_ALL));
ifthe*ruleisnotvalid*/DataAccessRuleparseDataAccessRule(StringruleKey,StringruleValue){finalStringrule=ruleKey+"="+ruleValue;//parseString[]elements=parseElements(ruleKey);//performbasicchecksontheelements
if(elements.length!=3&&elements.length!=2){LOGGER.warning("Invalidrule"+rule+",theexpectedformatisworkspace.layer.mode=role1,role2,...orglobalGroup.mode=role1,role2,...");returnnull;
if(elements.length==3){layerName=elements[1];modeAlias=elements[2];
else{layerName=null;modeAlias=elements[1];
if(layerName!=null){
if(!ANY.equals(root)&&rawCatalog.getWorkspaceByName(root)==null)LOGGER.warning("Namespace/Workspace"+root+"isunknowninrule"+rule);
if(!ANY.equals(layerName)&&rawCatalog.getLayerByName(newNameImpl(root,layerName))==null&&rawCatalog.getLayerGroupByName(root,layerName)==null)LOGGER.warning("Layer"+root+"isunknowninrule+"+rule);
else{
if(!ANY.equals(root)&&rawCatalog.getLayerGroupByName(root)==null)LOGGER.warning("Globallayergroup"+root+"isunknowninrule"+rule);
if(mode==null){LOGGER.warning("Unknownaccessmode"+modeAlias+"in"+ruleKey+",skippingrule"+rule);returnnull;
if(ANY.equals(root)){
if(!ANY.equals(layerName)){LOGGER.warning("Invalidrule"+rule+",whennamespace"+"is*thenalsolayermustbe*.Skippingrule"+rule);returnnull;
if(mode==AccessMode.ADMIN&&!ANY.equals(layerName)){//TODO:shouldthisthrowanexceptioninsteadofignorerule?LOGGER.warning("Invalidrule"+rule+",admin(a)privilegesmayonlybeapplied"+"globallytoaworkspace,layermustbe*,skippingrule");returnnull;
if(!rule.isGlobalGroupRule()){sbKey.append(".").append(rule.getLayer().replaceAll("\\.","\\\\."));
if(prefix!=null)raw=prefix+"."+raw;//justassumetheescapeisinvalidcharbesides\.andcheckitonceonly
if(raw.endsWith("\\")){prefix=raw.substring(0,raw.length()-1);
else{result.add(raw);prefix=null;
if(mode.name().equals(alias)){returnmode;
if(rule.getRoles().contains(role))result.add(rule);returnresult;}}
if(infoinstanceofLayerInfo){returnloadOrCreate((LayerInfo)info,defaults);
if(infoinstanceofLayerGroupInfo){returnloadOrCreate((LayerGroupInfo)info,defaults);
if(info==null){info=create(defaults);checkAutomaticStyles(groupInfo,info);
if(info==null){info=create(defaults);finalResourceInforesource=layerInfo.getResource();
if(resourceinstanceofFeatureTypeInfo){info.getMimeFormats().clear();info.getMimeFormats().addAll(defaults.getDefaultVectorCacheFormats());
else
if(resourceinstanceofCoverageInfo){info.getMimeFormats().clear();info.getMimeFormats().addAll(defaults.getDefaultCoverageCacheFormats());
if(publishedinstanceofLayerInfo){checkAutomaticStyles((LayerInfo)published,layerInfo);
else
if(publishedinstanceofLayerGroupInfo){checkAutomaticStyles((LayerGroupInfo)published,layerInfo);
else{thrownewIllegalArgumentException("DonotknowhowtohandlethiskindofPublishedInfo:"+published);
ifit'sastylefilter
if(filter!=null&&filterinstanceofStyleParameterFilter){((StyleParameterFilter)filter).setLayer(layer);
if(filter!=null&&filterinstanceofStyleParameterFilter){layerInfo.removeParameterFilter("STYLES");
if(parameterFilters==null||parameterFilters.size()==0){returnnull;
if(paramName.equalsIgnoreCase(pf.getKey())){returnpf;
if(filter==null)filter=newStyleParameterFilter();filter.setDefaultValue(defaultStyle);filter.setStyles(cachedStyles);info.addParameterFilter(filter);
ifthereisnonetoreplaceforthespecifiedkey*@paramdefaultValuedefaultvalue*@paramallowedValueslegalvaluesfortheparameter*/publicstaticvoidupdateStringParameterFilter(finalGeoServerTileLayerInfotileLayerInfo,finalStringparamKey,booleancreateParam,finalStringdefaultValue,finalString...allowedValues){Set<String>validValues=newHashSet<String>();
if(allowedValues!=null){validValues.addAll(Arrays.asList(allowedValues));
ifthereisnonetoreplaceforthespecifiedkey*@paramdefaultValuedefaultvalue*@paramallowedValueslegalvaluesfortheparameter*/publicstaticvoidupdateStringParameterFilter(finalGeoServerTileLayerInfotileLayerInfo,finalStringparamKey,booleancreateParam,finalStringdefaultValue,finalSet<String>allowedValues){createParam|=tileLayerInfo.removeParameterFilter(paramKey);
if(createParam&&allowedValues!=null&&allowedValues.size()>0){//makesuredefaultvalueisamongthelistofallowedvaluesSet<String>values=newTreeSet<String>(allowedValues);StringParameterFilterstringListFilter=newStringParameterFilter();stringListFilter.setKey(paramKey);stringListFilter.setDefaultValue(defaultValue==null?"":defaultValue);values.addAll(stringListFilter.getValues());stringListFilter.setValues(newArrayList<String>(values));tileLayerInfo.addParameterFilter(stringListFilter);
ifaparametermatchedandwasremoved,falseotherwise*@deprecated*/publicstaticbooleanremoveParameterFilter(finalGeoServerTileLayerInfotileLayerInfo,finalStringparamKey){returntileLayerInfo.removeParameterFilter(paramKey);
ifthereisnonetoreplaceforthespecifiedkey*/publicstaticvoidupdateAcceptAllRegExParameterFilter(finalGeoServerTileLayerInfotileLayerInfo,finalStringparamKey,booleancreateParam){createParam|=tileLayerInfo.removeParameterFilter(paramKey);
if(createParam){RegexParameterFilterfilter=newRegexParameterFilter();filter.setKey(paramKey);filter.setDefaultValue("");filter.setRegex(".*");tileLayerInfo.addParameterFilter(filter);
ifthereisnonetoreplaceforthespecifiedkey*/publicstaticvoidupdateAcceptAllFloatParameterFilter(finalGeoServerTileLayerInfotileLayerInfo,finalStringparamKey,booleancreateParam){createParam|=tileLayerInfo.removeParameterFilter(paramKey);
if(createParam){FloatParameterFilterfilter=newFloatParameterFilter();filter.setKey(paramKey);filter.setDefaultValue("");tileLayerInfo.addParameterFilter(filter);
if(!config.isEnabled()){LOGGER.info("Hazelcastsynchronizationdisabled");return;
if("event".equalsIgnoreCase(method)){syncher=newEventHzSynchronizer(cluster,geoServer);
else{method="reload";syncher=newReloadHzSynchronizer(cluster,geoServer);
if(syncher==null){return;
if(eventinstanceofContextLoadedEvent){syncher.start();
else
if(eventinstanceofContextClosedEvent){syncher.stop();
if(property==RepositoryProvider.NAME){returnnameLink(id,itemModel);
else
if(property==RepositoryProvider.LOCATION){Stringlocation=RepositoryProvider.LOCATION.getModel(itemModel).getObject().toString();Labellabel=newLabel(id,location);//label.add(newSimpleAttributeModifier("style","word-wrap:break-word;"));returnlabel;
else
if(property==RepositoryProvider.REMOVELINK){returnremoveLink(id,itemModel);
ifanyremovedobjectisonthelist)WebMarkupContainerremoved=newWebMarkupContainer("removedObjects");List<CatalogInfo>cascaded=visitor.getObjects(CatalogInfo.class,DELETE);//removetheresources,theyarecascaded,butwon'tbeshowintheUIfor(Iterator<CatalogInfo>it=cascaded.iterator();it.hasNext();){CatalogInfocatalogInfo=it.next();
if(catalogInfoinstanceofResourceInfo){it.remove();
if(layers.isEmpty())lar.setVisible(false);lar.add(newLabel("layers",names(layers)));//modifiedobjectsroot(weshowit
ifanymodifiedobjectisonthelist)WebMarkupContainermodified=newWebMarkupContainer("modifiedObjects");modified.setVisible(visitor.getObjects(null,GROUP_CHANGED).size()>0);add(modified);//groupsmodifiedWebMarkupContainergrm=newWebMarkupContainer("groupsModified");modified.add(grm);List<LayerGroupInfo>groups=visitor.getObjects(LayerGroupInfo.class,GROUP_CHANGED);grm.setVisible(!groups.isEmpty());grm.add(newLabel("groups",names(groups)));
if(i<(objects.size()-1)){sb.append(",");
if(field==null){thrownewIllegalArgumentException("Failedtolocatefield"+field+"inclass"+theClass.getName());
else
if(!Modifier.isStatic(field.getModifiers())){thrownewIllegalArgumentException("Field"+field+"inclass"+theClass.getName()+"wasfound,butit'snotastaticvariable");
if(threadLocal!=null){Objectvalue=threadLocal.get();storage.put(key,value);
if(threadLocal!=null){threadLocal.set(value);
if(threadLocal!=null){threadLocal.remove();
if(kvp.containsKey("storedQuery_id")){EMFUtils.add(obj,"storedQueryId",kvp.get("storedQuery_id"));
if(obj==null){continue;
if(objinstanceofDate){cell.setCellValue((Date)obj);
else
if(objinstanceofNumber){cell.setCellValue(((Number)obj).doubleValue());
else{cell.setCellValue(newHSSFRichTextString(obj.toString()));
if(v.startsWith("1.0")){returnV_10;
if(v.startsWith("1.1")){returnV_11;
if(v.startsWith("2.0")){returnV_20;
if(ver==null){returnnull;
if(version.compareTo(V_10.version)<=0){returnV_10;
if(version.compareTo(V_11.version)<=0){returnV_11;
if(version==null){return(this==latest())?0:-1;
if(s.getCode()==code){returns;
ifgml:boundselementsshouldbeencodedatthefeaturelevelin*gmloutput.*/booleanisFeatureBounding();/***Setstheflagwhichdetermines
ifgml:boundselementsshouldbeencodedatthefeaturelevel*ingmloutput.*/voidsetFeatureBounding(booleanfeatureBounding);/***GettheflagthatdeterminestheencodingoftheWFSschemaLocation.True
iftheWFS*schemaLocationshouldrefertothecanonicallocation,false
iftheWFSschemaLocationshould*refertoacopyservedbyGeoServer.*/booleanisCanonicalSchemaLocation();/***SettheflagthatdeterminestheencodingoftheWFSschemaLocation.True
iftheWFS*schemaLocationshouldrefertothecanonicallocation,false
iftheWFSschemaLocationshould*refertoacopyservedbyGeoServer.*/voidsetCanonicalSchemaLocation(booleancanonicalSchemaLocation);/***GettheflagthatdeterminesencodingoffeatureMemberorfeatureMembersTrue
ifthe*featureMembershouldbeencodedFalse
ifthefeatureMembersshouldbeencoded**@returnencodingFeatureMember*/booleanisEncodeFeatureMember();/**settheresponseencodingoption,featureMembersorfeatureMember*/voidsetEncodeFeatureMember(booleanencodeFeatureMember);/***Gettheflagthatdetermines
ifWFShitrequests(counts)willignorethemaximumfeatures*limitforthisserver**@returnhitsIgnoreMaxFeatures*/booleanisHitsIgnoreMaxFeatures();/**SettheoptiontoignorethemaximumfeaturelimitforWFShitcounts*/voidsetHitsIgnoreMaxFeatures(booleanhitsIgnoreMaxFeatures);/***Getthemaximumnumberoffeaturestobedisplayedinalayerpreview.Canbedefinedbythe*user.Bydefault,50.**@returnmaxNumberOfFeaturesForPreview*/IntegergetMaxNumberOfFeaturesForPreview();/**Setthemaximumnumberoffeaturestobedisplayedinalayerpreview*/voidsetMaxNumberOfFeaturesForPreview(IntegermaxNumberOfFeaturesForPreview);/**Thesrs'sthattheWFSservicewilladvertiseinthecapabilitiesdocument*/List<String>getSRS();}
if(enumValue.toString().equalsIgnoreCase(value)){returnenumValue;
if(styleFile!=null&&Resources.exists(styleFile)){Resources.copy(styleFile.file(),BackupUtils.dir(base.parent(),"styles"));
if*unspecified.*/@TestpublicvoidtestQueryBboxLatLong(){Documentdoc=getAsDOM(WFS_GET_FEATURE+LATLONG);LOGGER.info(WFS_GET_FEATURE_LOG+LATLONG+prettyString(doc));assertXpathEvaluatesTo("2","/wfs:FeatureCollection/@numberOfFeatures",doc);assertXpathCount(2,"//ex:geomContainer",doc);
iftheaxis*orderingbehavessimilartoqueriestoSimplefeatures.*/@TestpublicvoidtestQueryBboxLatLongEPSGCode(){Documentdoc=getAsDOM(WFS_GET_FEATURE+LATLONG+",EPSG:4326");LOGGER.info(WFS_GET_FEATURE_LOG+LATLONG+prettyString(doc));assertXpathEvaluatesTo("0","/wfs:FeatureCollection/@numberOfFeatures",doc);assertXpathCount(0,"//ex:geomContainer",doc);
iftheaxisordering*behavessimilartoqueriestoSimplefeatures.*/@TestpublicvoidtestQueryBboxLatLongURN(){Documentdoc=getAsDOM(WFS_GET_FEATURE+LATLONG+",urn:x-ogc:def:crs:EPSG:4326");LOGGER.info(WFS_GET_FEATURE_LOG+LATLONG+prettyString(doc));assertXpathEvaluatesTo("2","/wfs:FeatureCollection/@numberOfFeatures",doc);assertXpathCount(2,"//ex:geomContainer",doc);
iftheaxisorderingbehavessimilartoqueriestoSimplefeatures.*/@TestpublicvoidtestQueryBboxLatLongPost(){Stringxml="<wfs:GetFeatureservice=\"WFS\"version=\"1.1.0\""//+"xmlns:ogc=\"http://www.opengis.net/ogc\""//+"xmlns:wfs=\"http://www.opengis.net/wfs\""//+"xmlns:gml=\"http://www.opengis.net/gml\""//+"xmlns:ex=\"http://example.com\""//+"xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\""//+"xsi:schemaLocation=\""//+"http://www.opengis.net/wfshttp://schemas.opengis.net/wfs/1.1.0/wfs.xsd\">"//+"<wfs:QuerytypeName=\"ex:geomContainer\">"//+"<ogc:Filter>"//+"<ogc:BBOX>"//+"<ogc:PropertyName>ex:geom</ogc:PropertyName>"//+"<gml:EnvelopesrsName=\"urn:x-ogc:def:crs:EPSG:4326\">"//+"<gml:lowerCorner>-29130</gml:lowerCorner>"//+"<gml:upperCorner>-24134</gml:upperCorner>"//+"</gml:Envelope>"//+"</ogc:BBOX>"//+"</ogc:Filter>"//+"</wfs:Query>"//+"</wfs:GetFeature>";//validate(xml);Documentdoc=postAsDOM("wfs",xml);LOGGER.info(WFS_GET_FEATURE_LOG+"withPOSTfilter"+prettyString(doc));assertXpathEvaluatesTo("2","/wfs:FeatureCollection/@numberOfFeatures",doc);assertXpathCount(2,"//ex:geomContainer",doc);
if(wpsOutputValue!=null){returnwpsOutputValue;
ifnullisanacceptablevaluefortheattribute.*/booleanisNillable();/**Setsflagindicating
ifnullisanacceptablevaluefortheattribute.*/voidsetNillable(booleannillable);/**Thefeaturetypethisattributeispartof.*/FeatureTypeInfogetFeatureType();/**Setsthefeaturetypethisattributeispartof.*/voidsetFeatureType(FeatureTypeInfofeatureType);/***Apersistentmapofmetadata.**<p>Datainthismapisintendedtobepersisted.Commoncaseofuseistohaveservices*associatevariousbitsofdatawithaparticularattribute.Anexamplemightbeits*associatedxmlorgmltype.*/Map<String,Serializable>getMetadata();/***Theunderlyingattributedescriptor.**<p>Notethatthisvalueisnotpersistedwithotherattributes,andcouldbe<code>null*</code>.*/AttributeDescriptorgetAttribute()throwsIOException;/**Setstheunderlyingattributedescriptor.*/voidsetAttribute(AttributeDescriptorattribute);/**Thejavaclassthatvaluesofthisattributeareboundto.*/ClassgetBinding();/***Setsthebindingforthisattribute**@paramtype*/voidsetBinding(Classtype);/***Returnsthelengthofthisattribute.It'susuallynonnullonlyforstringandnumerictypes*/IntegergetLength();/***Setstheattributelength**@paramlength*/voidsetLength(Integerlength);/***Thesameas{@link#equals(Object)},exceptdoesn'tcompare{@linkFeatureTypeInfo}s,to*avoidrecursion.*/booleanequalsIngnoreFeatureType(Objectobj);}
if(!points.isEmpty()){geomList.add(points);
if(left==null){addEnv(right);returnfalse;
else
if(right==null){addEnv(left);returnfalse;
if(left==null){addEnv(right);returnfalse;
else
if(right==null){addEnv(left);returnfalse;
if(node==null){return;
if(env==null||env.isNull()){return;
if(isPoint(env)){lock.lock();try{points.add(env.getMinX(),env.getMinY());
if(isOrthoLine(env)){//handlethecasewheretheenvelopeisgivenbyanorthogonallinesowedon'tadda//zeroareapolygondoublewidth=env.getWidth();GrowableCoordinateSequencecs=newGrowableCoordinateSequence();
if(width==0D){cs.add(env.getMinX(),env.getMinY());cs.add(env.getMinX(),env.getMaxY());
else{cs.add(env.getMinX(),env.getMinY());cs.add(env.getMaxX(),env.getMinY());
else{geom=JTS.toGeometry(env,GEOM_FACTORY);
if("GET".equals(method))returnGET;
if("POST".equals(method))returnPOST;
if("HEAD".equals(method))returnHEAD;
if("OPTIONS".equals(method))returnOPTIONS;
if("PUT".equals(method))returnPUT;
if("DELETE".equals(method))returnDELETE;
if("TRACE".equals(method))returnTRACE;thrownewRuntimeException("UnknownHTTPmethod:"+method);}}
if(metadata==null){metadata=newMetadataMap();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofStoreInfo)){returnfalse;
if(connectionParameters==null){
if(other.getConnectionParameters()!=null)returnfalse;
else
if(!connectionParameters.equals(other.getConnectionParameters()))returnfalse;
if(description==null){
if(other.getDescription()!=null)returnfalse;
else
if(!description.equals(other.getDescription()))returnfalse;
if(enabled!=other.isEnabled())returnfalse;
if(id==null){
if(other.getId()!=null)returnfalse;
else
if(!id.equals(other.getId()))returnfalse;
if(name==null){
if(other.getName()!=null)returnfalse;
else
if(!name.equals(other.getName()))returnfalse;
if(workspace==null){
if(other.getWorkspace()!=null)returnfalse;
else
if(!workspace.equals(other.getWorkspace()))returnfalse;returntrue;}}
ifthewritersupportstherequesteddxfversion.**@paramversion*/publicbooleansupportsVersion(Stringversion);/***Performstheactualwriting.**@paramfeatureList*@paramversion*@throwsIOException*/publicvoidwrite(ListfeatureList,Stringversion)throwsIOException;/***Configureawriteroption.**@paramoptionName*@paramoptionValue*/publicvoidsetOption(StringoptionName,ObjectoptionValue);/**Getsthewriterdescription.*/publicStringgetDescription();}
if(newPatternsRequestCondition("/resource","/resource/**").getMatchingCondition(request)!=null){returnCollections.singletonList(ResourceController.getFormat(request));
if(objectinstanceofResourceDirectoryInfo){return"resourceDirectoryInfo.ftl";
else
if(objectinstanceofResourceMetadataInfo){return"resourceMetadataInfo.ftl";
else{returnsuper.getTemplateName(object);
if(resource.getType()==Resource.Type.DIRECTORY){returngetFormat(request);
else
if(resource.getType()==Resource.Type.RESOURCE){StringmimeType=URLConnection.guessContentTypeFromName(resource.name());
if(mimeType==null||MediaType.APPLICATION_OCTET_STREAM.toString().equals(mimeType)){//tryguessingfromdatatry(InputStreamis=newBufferedInputStream(resource.in())){mimeType=URLConnection.guessContentTypeFromStream(is);
else{returnnull;
ifnotfound.*/protectedResourceresource(HttpServletRequestrequest){Stringpath=request.getPathInfo();//Stripoff"/resource"path=path.substring(9);//handlespecialcharacterstry{path=URLDecoder.decode(path,"UTF-8");
ifnotprovided.**@paramoperation*@returnoperationdefinedbyquerystring,or{@linkOperation#DEFAULT}
ifnotprovided*/protectedstaticOperationoperation(Stringoperation){
if(operation!=null){operation=operation.trim().toUpperCase();try{returnOperation.valueOf(operation);
else{returnOperation.DEFAULT;
if("xml".equals(format)){returnMediaType.APPLICATION_XML;
else
if("json".equals(format)){returnMediaType.APPLICATION_JSON;
else{returnMediaType.TEXT_HTML;
if(operation==Operation.METADATA){result=wrapObject(newResourceMetadataInfo(resource,request),ResourceMetadataInfo.class);
else{
if(resource.getType()==Resource.Type.UNDEFINED){thrownewResourceNotFoundException("Undefinedresourcepath.");
else{HttpHeadersresponseHeaders=newHttpHeaders();MediaTypemediaType=getMediaType(resource,request);responseHeaders.setContentType(mediaType);response.setContentType(mediaType.toString());
if(request.getMethod().equals("HEAD")){result=newResponseEntity("",responseHeaders,HttpStatus.OK);
else
if(resource.getType()==Resource.Type.DIRECTORY){result=wrapObject(newResourceDirectoryInfo(resource,request),ResourceDirectoryInfo.class);
else{result=newResponseEntity(resource.in(),responseHeaders,HttpStatus.OK);
if(!"".equals(resource.path())){response.setHeader("Resource-Parent",href(resource.parent().path()));
ifneeded).*<li>{@linkOperation#MOVE}:movesaresource,indicatedbyrequestbody,tothislocation.*<li>{@linkOperation#COPY}:duplicatesaresource,indicatedbyrequestbody,tothis*location*</ul>**@paarmrequest*@paramresponse{@linkHttpStatus#CREATED}foranewresource,or{@linkHttpStatus#OK}when*updatingexistingresource*/@PutMapping(consumes={MediaType.ALL_VALUE})@ResponseStatus(HttpStatus.CREATED)publicvoidresourcePut(HttpServletRequestrequest,HttpServletResponseresponse,@RequestParam(name="operation",required=false,defaultValue="default")StringoperationName){Resourceresource=resource(request);
if(resource.getType()==Type.DIRECTORY){thrownewRestException("Attemptingtowritedatatoadirectory.",HttpStatus.METHOD_NOT_ALLOWED);
if(operation==Operation.METADATA){thrownewRestException("Attemptingtowritedatatometadata.",HttpStatus.METHOD_NOT_ALLOWED);
if(operation==Operation.COPY||operation==Operation.MOVE){Stringpath;try{path=IOUtils.toString(request.getInputStream());
if(source.getType()==Type.UNDEFINED){thrownewRestException("Unabletolocate'"+path+"'.",HttpStatus.NOT_FOUND);
if(operation==Operation.MOVE){booleanmoved=source.renameTo(resource);
if(!moved){thrownewRestException("Renameoperationfailed.",HttpStatus.INTERNAL_SERVER_ERROR);
else{//COPY
if(source.getType()==Type.DIRECTORY){thrownewRestException("Cannotcopydirectory.",HttpStatus.METHOD_NOT_ALLOWED);
else
if(operation==Operation.DEFAULT){try{IOUtils.copy(request.getInputStream(),resource.out());
if(LOGGER.isLoggable(Level.INFO)){LOGGER.fine("PUTresource:"+resource.path());
else{thrownewIllegalStateException("Unexpectedoperation'"+operation+"'");
if(isNew){response.setStatus(HttpStatus.CREATED.value());
if(Type.UNDEFINED.equals(resource.getType())){thrownewResourceNotFoundException("Resource'"+resource.path()+"'notfound");
if(!removed){thrownewRestException("Resource'"+resource.path()+"'notremoved",HttpStatus.INTERNAL_SERVER_ERROR);
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("PUTfile:mimetype="+request.getContentType()+",path="+directory.path());
if(converterinstanceofXStreamXMLMessageConverter){AtomLink.configureXML(xstream);xstream.aliasField("atom:link",ResourceParentInfo.class,"link");xstream.aliasField("atom:link",ResourceChildInfo.class,"link");
else
if(converterinstanceofXStreamJSONMessageConverter){AtomLink.configureJSON(xstream);
if(!resource.path().isEmpty()){parent=newResourceParentInfo("/"+resource.parent().path(),newAtomLink(href(resource.parent().path()),"alternate",getFormat(request).toString()));
ifnolanguage.*/StringgetLanguage();/**Setsthelanguageofthekeyword.*/voidsetLanguage(Stringlanguage);/**Thevocabularyofthekeyword,<code>null</code>
ifnovocabulary.*/StringgetVocabulary();/**Setsthevocabularyofthekeyword.*/voidsetVocabulary(Stringvocabulary);}
if(!hasNext()){thrownewNoSuchElementException();
if(iteminstanceofDataStoreInfo)return"vector";
elsereturn"raster";
if(type!=null){returntype;
if(iteminstanceofDataStoreInfo){DataStoreInfodsInfo=(DataStoreInfo)item;DataAccessFactoryfactory=resourcePool.getDataStoreFactory(dsInfo);
if(factory!=null){returnfactory.getDisplayName();
else
if(iteminstanceofCoverageStoreInfo){Formatformat=resourcePool.getGridCoverageFormat((CoverageStoreInfo)item);
if(format!=null){returnformat.getName();
if(iteratorinstanceofCloseableIterator){//don'tknowhowtoforcewickettoclosetheiterator,letsreturn//acopy.Shouldn'tbemuchoverheadaswe'repagingtry{returnLists.newArrayList(iterator).iterator();
else{returniterator;
if(sort!=null){
if(propertyinstanceofBeanProperty){finalStringsortProperty=((BeanProperty<StoreInfo>)property).getPropertyPath();sortOrder=sortBy(sortProperty,sort.isAscending());
else
if(property==ENABLED){sortOrder=sortBy("enabled",sort.isAscending());
else
if(property==TYPE){sortOrder=sortBy("type",sort.isAscending());
else{sortOrder=sortBy("name",true);
ifpresent
if(workspace!=null){FilterFactory2ff=CommonFactoryFinder.getFilterFactory2();FilterworkspaceFilter=ff.equal(ff.property("workspace.id"),ff.literal(workspace.getId()));filter=ff.and(filter,workspaceFilter);
if(infoinstanceofWorkspaceInfo){return(T)checkAccess((WorkspaceInfo)info);
if(infoinstanceofNamespaceInfo){return(T)checkAccess((NamespaceInfo)info);
if(infoinstanceofStoreInfo){return(T)checkAccess((StoreInfo)info);
if(infoinstanceofResourceInfo){return(T)checkAccess((ResourceInfo)info);
if(infoinstanceofLayerInfo){return(T)checkAccess((LayerInfo)info);
if(infoinstanceofLayerGroupInfo){return(T)checkAccess((LayerGroupInfo)info);
iftheusercanaccessitinwritemode,*makesitreadonly
iftheusercanaccessitinreadonlymode,returnsnullotherwise*/protectedabstract<TextendsResourceInfo>TcheckAccess(Tinfo);/***Givena{@linkStyleInfo},returnsitback
iftheusercanaccessit.**@return<code>null</code>
iftheusercan'tacessthestyle,otherwisetheoriginalstyle.*/protectedabstractStyleInfocheckAccess(StyleInfostyle);/***Givenastore,returnsitback
iftheusercanaccessitsworkspaceinreadmode,null*otherwise*/protectedabstract<TextendsStoreInfo>TcheckAccess(Tstore);/**Givenalayer,returnsitback
iftheusercanaccessit,nullotherwise*/protectedabstractLayerInfocheckAccess(LayerInfolayer);/**Givenalayergroup,returnsitback
iftheusercanaccessit,nullotherwise*/protectedabstractLayerGroupInfocheckAccess(LayerGroupInfogroup);/**Givenanamespace,returnsitback
iftheusercanaccessit,nullotherwise*/protectedabstract<TextendsNamespaceInfo>TcheckAccess(Tns);/**Givenaworkspace,returnsitback
iftheusercanaccessit,nullotherwise*/protectedabstract<TextendsWorkspaceInfo>TcheckAccess(Tws);/***Givenalistofresources,returnsacopyofitcontainingonlytheresourcestheusercan*access**@paramresources*/protectedabstract<TextendsResourceInfo>List<T>filterResources(List<T>resources);/***Givenalistofstores,returnsacopyofitcontainingonlytheresourcestheusercan*access**@paramresources*/protectedabstract<TextendsStoreInfo>List<T>filterStores(List<T>resources);/***Givenalistoflayergroups,returnsacopyofitcontainingonlythegroupstheusercan*access**@paramgroups*/protectedabstractList<LayerGroupInfo>filterGroups(List<LayerGroupInfo>groups);/***Givenalistoflayers,returnsacopyofitcontainingonlythelayerstheusercanaccess**@paramlayers*/protectedabstractList<LayerInfo>filterLayers(List<LayerInfo>layers);/***Givenalistofstyles,returnsacopyofitcontainingonlythestylestheusercanaccess.*/protectedabstractList<StyleInfo>filterStyles(List<StyleInfo>styles);/***Givenalistofnamespaces,returnsacopyofitcontainingonlythenamespacestheusercan*access**@paramnamespaces*/protectedabstract<TextendsNamespaceInfo>List<T>filterNamespaces(List<T>namespaces);/***Givenalistofworkspaces,returnsacopyofitcontainingonlytheworkspacestheusercan*access**@paramnamespaces*/protectedabstract<TextendsWorkspaceInfo>List<T>filterWorkspaces(List<T>workspaces);//-------------------------------------------------------------------//PUREDELEGATINGMETHODS//(MapInfobeingheresinceitsroleinthegrandschemeofthings//isstillundefined)//-------------------------------------------------------------------publicMapInfogetMap(Stringid){returndelegate.getMap(id);
ifanobjectoftherequiredtypeisaccessible*/protectedabstract<TextendsCatalogInfo>FiltersecurityFilter(finalClass<T>infoType,finalFilterfilter);@SuppressWarnings("rawtypes")publicvoidremoveListeners(ClasslistenerClass){delegate.removeListeners(listenerClass);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("InspectingthehttprequestlookingfortheJSessionID.");
if(cookies!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Found"+cookies.length+"cookies!");
if(c.getName().toLowerCase().contains(SESSION_COOKIE_NAME)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("FoundJSessioncookie:"+c.getValue());
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Foundnocookies!");
iftheuserconfigurationfiledoesnotexistandcannotbe*created*@throwsIOException
ifanerroroccurswhileopeningtheuserconfigurationfile*/privateResourcegetUserFile()throwsConfigurationException,IOException{GeoServerResourceLoaderloader=geoServer.getCatalog().getResourceLoader();returnloader.get("security/users.properties");
if(myDetailStorage.isEmpty())createDefaultUser();
ifnosuchuserexists*/publicUserDetailsloadUserByUsername(Stringusername){update();return(UserDetails)myDetailStorage.get(username);
iftheuserconfigurationfiledoesnotexistandcannotbe*created*@throwsIOException
ifanerroroccurswhileopeningtheuserconfigurationfile*/publicvoidsetUserDetails(Stringusername,UserAttributedetails)throwsIOException,ConfigurationException{update();myDetailStorage.put(username,makeUser(username,details));syncChanges();
iftheuserconfigurationfiledoesnotexistandcannotbe*created*@throwsIOException
ifanerroroccurswhileopeningtheuserconfigurationfile*/publicvoiddeleteUser(Stringusername)throwsIOException,ConfigurationException{update();myDetailStorage.remove(username);syncChanges();
if(myWatcher==null){
else
if(myWatcher.isStale()){Propertiesprop=myWatcher.getProperties();UserAttributeEditoruae=newUserAttributeEditor();myDetailStorage.clear();Iterator<Object>it=prop.keySet().iterator();while(it.hasNext()){Stringusername=(String)it.next();uae.setAsText(prop.getProperty(username));UserAttributeattrs=(UserAttribute)uae.getValue();
if(attrs!=null){myDetailStorage.put(username,makeUser(username,attrs));
iftheuserconfigurationfiledoesnotexistandcannotbe*created*@throwsIOException
ifanerroroccurswhileopeningtheuserconfigurationfile*/privatevoidsyncChanges()throwsIOException,ConfigurationException{Propertiesprop=newProperties();for(UserDetailsdetails:myDetailStorage.values()){Stringkey=details.getUsername();Stringvalue=details.getPassword();for(GrantedAuthorityauth:details.getAuthorities()){value+=","+auth.getAuthority();
if(!details.isEnabled()){value+=",disabled";
if(form.findSubmittingButton()!=form.get("save")){//onlyvalidateonfinalsubmitreturn;
if(DataAccessRuleDAO.get().getRules().contains(rule)){form.error(newParamResourceModel("duplicateRule",getPage(),rule.getKey()).getString());
ifthecurrentjobisarestorejob.*/publicstaticbooleanisRestore(BackupRestoreItemcontext){returncontext.isNew();
ifthecurrentjobisabackupjob.*/publicstaticbooleanisBackup(BackupRestoreItemcontext){return!context.isNew();
ifthecurrentjobisarestorejobrunninginadrymode.*/publicstaticbooleanisDryRun(BackupRestoreItemcontext){returncontext.isDryRun();
if(inputDirectoryUrl==null){//thishappens
ifinvokedforabackupjobthrownewRuntimeException("Noinputdirectoryavailableforthisjobexecution.");
if(outputDirectoryUrl==null){//thishappens
ifinvokedforarestorejobthrownewRuntimeException("Nooutputdirectoryavailableforthisjobexecution.");
if(!Resources.exists(file)){error(newParamResourceModel("ScriptEditPage.notFound",this,script).getString());doReturn(ScriptPage.class);return;
if(initScript==null){returnnull;
if(is!=null){props.load(is);
if(resource.getType()==Type.RESOURCE){is=resource.in();props.load(is);
if(ae!=null){resourceAttributeExclusions=ae.split(",");
else{resourceAttributeExclusions=newString[0];
if(ai!=null){versionAttributeInclusions=ai.split(",");
else{//defaultsthrownewException("Includeattributearraycannotbenull");
ifargumentsarenull*/privatestaticAboutModelgetAboutModel(finalClassLoaderloader)throwsIllegalArgumentException{
if(loader==null){thrownewIllegalArgumentException("Unabletorunwithnullarguments");
if(loader==null){thrownewIllegalArgumentException("Unabletorunwithnullarguments");
if(LOGGER.isLoggable(Level.FINE))LOGGER.fine("Loadingresources:"+resource.getFile());is=resource.openStream();manifests.put(resource.getPath(),newManifest(is));
if(m.matches())returnm.group(1);
else{Stringname=path.substring(0,path.length()-22);returnname.substring(name.lastIndexOf('/')+1);
if(archivePath.endsWith("\\WEB-INF\\classes")||archivePath.endsWith("/WEB-INF/classes")){archivePath=archivePath.substring(0,archivePath.length()-"/WEB-INF/classes".length());//Requiredforwars
if(classLoader==null){thrownewIllegalArgumentException("UnabletorunwithnullclassLoader");
if(manifest!=null){model.add(ManifestModel.parseManifest("GeoServer",manifest,newManifestModel.IncludeAttributeFilter(versionAttributeInclusions)));
if(manifest!=null){model.add(ManifestModel.parseManifest("GeoTools",manifest,newManifestModel.IncludeAttributeFilter(versionAttributeInclusions)));
if(manifest!=null){model.add(ManifestModel.parseManifest("GeoWebCache",manifest,newManifestModel.IncludeAttributeFilter(versionAttributeInclusions)));
if(p!=null){//ManifestModelmanifest=newManifestModel("GeoWebCache");//manifest.putEntry("Version",//p.getSpecificationVersion()!=null?p.getSpecificationVersion():"");//manifest.putEntry("Git-Revision",//p.getImplementationVersion()!=null?p.getImplementationVersion():"");//model.add(manifest);//
if(am==null){thrownewIllegalArgumentException("Unabletoinitializemodelwithanullmodel");
if(manifests==null){thrownewIllegalArgumentException("Unabletoinitializemodelwithanullmanifeststree");
iffromortoarenull*/publicAboutModelfilterNameByRange(Stringfrom,Stringto)throwsIllegalArgumentException{
if(from==null||to==null){thrownewIllegalArgumentException("Unabletoparsefromortoarenull");
iftheregexisnull*/publicAboutModelfilterNameByRegex(Stringregex)throwsIllegalArgumentException{
if(regex==null){thrownewIllegalArgumentException("Unabletoparseregexisnull");
if(LOGGER.isLoggable(Level.FINE))LOGGER.fine(tModel.getName());
if(tModel.getName().matches(regex)){am.getManifests().add(tModel);
ifthekeyisnull*/publicAboutModelfilterPropertyByKey(Stringkey)throwsIllegalArgumentException{
if(key==null){thrownewIllegalArgumentException("Unabletoparsekeyisnull");
if(filterPropertyByKey(tModel,key)){am.getManifests().add(tModel);
ifthevalueisnull*/publicAboutModelfilterPropertyByValue(finalStringvalue)throwsIllegalArgumentException{
if(value==null){thrownewIllegalArgumentException("Unabletoparse:valueisnull");
if(filterByPropertyValue(tModel,value)){am.getManifests().add(tModel);
ifthekeyorthevaluearenull*/publicAboutModelfilterPropertyByKeyValue(finalStringvalue,finalStringkey)throwsIllegalArgumentException{
if(value==null&&key==null){thrownewIllegalArgumentException("Unabletoparse:propertyorkeyarenull");
if(filterPropertyByKeyValue(tModel,key,value)){am.getManifests().add(tModel);
if(e.getKey().matches(key)&&e.getValue().matches(value)){//propertymanematchesreturntrue;
if(e.getKey().matches(key)){//propertymanematchesreturntrue;
if(e.getValue().matches(value)){//propertymanematchesreturntrue;
ifthissetdidnotalreadycontainthespecifiedname*/publicbooleanadd(finalStringname,finalManifestmanifest){returnmanifests.add(ManifestModel.parseManifest(name,manifest,newManifestModel.ExcludeAttributeFilter(resourceAttributeExclusions)));
ifthissetdidnotalreadycontainthespecifiedname*/publicbooleanadd(finalManifestModelmanifest){returnmanifests.add(manifest);
ifthissetcontainedthespecifiedelement*/publicbooleanremove(finalStringname){
if(name!=null){returnmanifests.remove(newManifestModel(name));
if(at==null)thrownewIllegalArgumentException("Nullargument");Map<String,String>ret=newHashMap<String,String>();
if(include==null){
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"Noincludes:includingall");finalIterator<java.util.Map.Entry<Object,Object>>it=at.entrySet().iterator();while(it.hasNext()){java.util.Map.Entry<Object,Object>entry=it.next();StringattrName=((Attributes.Name)entry.getKey()).toString();ret.put(attrName,entry.getValue().toString());
else{//foreachattributefinalIterator<java.util.Map.Entry<Object,Object>>it=at.entrySet().iterator();while(it.hasNext()){java.util.Map.Entry<Object,Object>entry=it.next();StringattrName=((Attributes.Name)entry.getKey()).toString();//searchintoincludingarraytofilteroverattributesinti=0;while(i<include.length){//splitkeyinoriginal_key:replace_keyStringkey[]=include[i++].split(":");
if(attrName.matches(key[0])==true){ret.put(key.length>1?key[1]:key[0],entry.getValue().toString());break;
if(at==null)thrownewIllegalArgumentException("Nullarguments");
if(exclude==null){
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,"Noexceptions");exclude=newString[0];
if(attrName.matches(exclude[i++])==true){skip=true;break;
if(!skip)ret.put(attrName,at.getValue(attrName));
if(sourceinstanceofFile){this.dataDirectory=(File)source;initReaderFromFile(hints);
else{thrownewIllegalArgumentException("Invalidsourceobject");
if(p.getDescriptor().getName().toString().equalsIgnoreCase(CustomFormat.CUSTOM_DIMENSION_NAME)){haveDimension=true;finalList<?>value=extractValue(p);for(Objecto:value){finalStrings=Converters.convert(o,String.class);for(Stringfilename:this.dataDirectory.list()){
if(isDataFile(filename)){finalStringdimValue=getDimensionValue(filename);
if(dimValue.equalsIgnoreCase(s)){returnValues.add(createCoverage(filename));break;
if(!haveDimension){//Nodimensionvaluespecified;justreturnfirstimagefor(Stringfilename:this.dataDirectory.list()){
if(isDataFile(filename)){returncreateCoverage(filename);
else
if(size>0){//singlevalue
if(size==1){returnreturnValues.get(0);
else{//wereturnamultibandcoveragethatusestheoriginalonesassourcesfinalImageWorkerworker=newImageWorker(returnValues.get(0).getRenderedImage());for(inti=1;i<size;i++){worker.addBand(returnValues.get(i).getRenderedImage(),false);
if(HAS_MY_DIMENSION_DOMAIN.equalsIgnoreCase(name)){returnString.valueOf(true);
if(MY_DIMENSION_DOMAIN.equalsIgnoreCase(name)){returndimensionValueList();
if(MY_DIMENSION_DATATYPE.equalsIgnoreCase(name)&&clazz!=null){returnclazz;
if(isDataFile(filename)){elements.add(getDimensionValue(filename));
if(elements.size()<=0){returnnull;
if(!this.dataDirectory.isDirectory()){thrownewIOException(this.dataDirectory+"isnotadirectory");
if(isDataFile(filename)){dataFile=newFile(this.dataDirectory,filename);break;
if(dataFile==null){thrownewIOException("Nodatafilefound");
if(clazzFile.exists()){clazz=newString(Files.readAllBytes(clazzFile.toPath())).trim();
if(paraminstanceofParameterValue<?>){finalObjectparamVal=((ParameterValue<?>)param).getValue();
if(paramVal!=null){
if(paramValinstanceofList){finalList<?>list=(List<?>)paramVal;returnlist;
else{thrownewUnsupportedOperationException("Customdimensionvaluemustbealist");
if(theService!=null)theService.load();
ifthisobjectisregistered**@seeGeoServerRoleService#registerRoleLoadedListener(RoleLoadedListener)*/@OverridepublicvoidrolesChanged(RoleLoadedEventevent){//avoidreloadssetLastModified(resource.lastmodified());LOGGER.info("Adjustedlastmodifiedforfile:"+path);}}
if(!PATTERN.matcher(rule).matches()){LOGGER.severe("Ignoring'"+rule+"'notmatching"+PATTERN);continue;
if(!PATTERN.matcher(rule).matches()){LOGGER.severe("Invalid'"+rule+"'notmatching"+PATTERN);continue;
if(helper!=null){helper.tearDown();helper.repositoryTempFolder.delete();
if((params!=null)&&(params.values().size()>0)){Listlist=params.values();finalIteratorit=list.iterator();while(it.hasNext()){finalParameterValueval=(ParameterValue)it.next();
if(val!=null){finalParameterDescriptordescr=(ParameterDescriptor)val.getDescriptor();finalString_key=descr.getName().toString();
if("namespace".equals(_key)){//skipnamespaceasitis*magic*and//appearstobeanentryusedinalldataformats?//continue;
if(_key.equalsIgnoreCase(readGeometryKey)){continue;
else{returnnull;
if((params!=null)&&(params.values().size()>0)){finalList<GeneralParameterValue>elements=params.values();for(GeneralParameterValueelem:elements){finalParameterValue<?>val=(ParameterValue<?>)elem;
if(val!=null){finalParameterDescriptor<?>descr=val.getDescriptor();finalString_key=descr.getName().toString();
if("namespace".equals(_key)){//skipnamespaceasitis*magic*and//appearstobeanentryusedinalldataformats?//continue;
if(_key.equalsIgnoreCase(readGeometryKey)&&!readGeom){//IGNORINGREAD_GRIDGEOMETRY2Dparamcontinue;
else{returnnewGeneralParameterValue[0];
if((params!=null)&&(params.values().size()>0)){finalListlist=params.values();finalIteratorit=list.iterator();while(it.hasNext()){finalParameterValueval=(ParameterValue)it.next();
if(val!=null){finalParameterDescriptordescr=(ParameterDescriptor)val.getDescriptor();finalString_key=descr.getName().toString();
if("namespace".equals(_key)){//skipnamespaceasitis*magic*and//appearstobeanentryusedinalldataformats?//continue;
if(_key.equalsIgnoreCase(readGeometryKey)){//IGNORINGREAD_GRIDGEOMETRY2Dparamcontinue;
if(value==null){text=null;
else
if(valueinstanceofString){text=(String)value;
else{text=value.toString();
else{returnparameters;
if(key.equalsIgnoreCase("crs")){
if((getParamValue(paramValues,index)!=null)&&(((String)getParamValue(paramValues,index)).length()>0)){
if((paramValues.get(index)!=null)&&(((String)paramValues.get(index)).length()>0)){value=CRS.parseWKT((String)paramValues.get(index));
else{LOGGER.info("Unabletofindacrsforthecoverageparam,usingEPSG:4326");value=CRS.decode("EPSG:4326");
else
if(key.equalsIgnoreCase("envelope")){
if((getParamValue(paramValues,index)!=null)&&(((String)getParamValue(paramValues,index)).length()>0)){Stringtmp=(String)getParamValue(paramValues,index);
if((tmp.indexOf("[")>0)&&(tmp.indexOf("]")>tmp.indexOf("["))){tmp=tmp.substring(tmp.indexOf("[")+1,tmp.indexOf("]")).trim();tmp=tmp.replaceAll(",","");String[]strCoords=tmp.split("");double[]coords=newdouble[strCoords.length];
if(strCoords.length==4){for(intiT=0;iT<4;iT++){coords[iT]=Double.parseDouble(strCoords[iT].trim());
else{Class[]clArray={getParamValue(paramValues,index).getClass()};Object[]inArray={getParamValue(paramValues,index)};value=param.getValue().getClass().getConstructor(clArray).newInstance(inArray);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,e.getLocalizedMessage(),e);
if(key.equalsIgnoreCase("crs")){
if((params.get(key)!=null)&&(((String)params.get(key)).length()>0)){value=CRS.parseWKT((String)params.get(key));
else{LOGGER.info("Unabletofindacrsforthecoverageparam,usingEPSG:4326");value=CRS.decode("EPSG:4326");
else
if(key.equalsIgnoreCase("envelope")){
if((params.get(key)!=null)&&(((String)params.get(key)).length()>0)){Stringtmp=(String)params.get(key);
if((tmp.indexOf("[")>0)&&(tmp.indexOf("]")>tmp.indexOf("["))){tmp=tmp.substring(tmp.indexOf("[")+1,tmp.indexOf("]")).trim();tmp=tmp.replaceAll(",","");String[]strCoords=tmp.split("");double[]coords=newdouble[strCoords.length];
if(strCoords.length==4){for(intiT=0;iT<4;iT++){coords[iT]=Double.parseDouble(strCoords[iT].trim());
else
if(key.equalsIgnoreCase(AbstractGridFormat.READ_GRIDGEOMETRY2D.getName().toString())){
if((params.get(key)!=null)&&params.get(key)instanceofString&&(((String)params.get(key)).length()>0)){Stringtmp=(String)params.get(key);
if((tmp.indexOf("[")>0)&&(tmp.indexOf("]")>tmp.indexOf("["))){tmp=tmp.substring(tmp.indexOf("[")+1,tmp.indexOf("]")).trim();tmp=tmp.replaceAll(",","");String[]strCoords=tmp.split("");double[]coords=newdouble[strCoords.length];
if(strCoords.length==4){for(intiT=0;iT<4;iT++){coords[iT]=Double.parseDouble(strCoords[iT].trim());
else
if((params.get(key)!=null)&&params.get(key)instanceofGeneralGridGeometry){value=params.get(key);
else{finalClass<?extendsObject>target=param.getDescriptor().getValueClass();
if(key.equalsIgnoreCase("InputTransparentColor")||key.equalsIgnoreCase("OutputTransparentColor")){
if(params.get(key)!=null){value=Color.decode((String)params.get(key));
else{Class[]clArray={Color.class};Object[]inArray={params.get(key)};value=target.getConstructor(clArray).newInstance(inArray);
else
if(key.equalsIgnoreCase("BackgroundValues")){
if(params.get(key)!=null){Stringtemp=(String)params.get(key);String[]elements=temp.split(",");finaldouble[]backgroundValues=newdouble[elements.length];for(inti=0;i<elements.length;i++)backgroundValues[i]=Double.valueOf(elements[i]);value=backgroundValues;
else
if(key.equalsIgnoreCase("InputImageThresholdValue")){
if(params.get(key)!=null){Stringtemp=(String)params.get(key);value=Double.valueOf(temp);
else
if(key.equalsIgnoreCase("Filter")){Objectsfilter=params.get(key);
if(sfilter!=null){
if(sfilterinstanceofString){value=ECQL.toFilter((String)sfilter);
else
if(sfilterinstanceofFilter){value=(Filter)sfilter;
else{value=param.getValue();
else{value=params.get(key);
if(value!=null){Objectconverted=Converters.convert(value,target);
if(converted==null){thrownewRuntimeException("Failedtoconvert"+value+"to"+target.getName());
else{value=converted;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,e.getLocalizedMessage(),e);
if(aliases.contains(pd.getName().getCode())){finalParameterValuepv=(ParameterValue)pd.createValue();pv.setValue(value);//addtothelistGeneralParameterValue[]readParametersClone=newGeneralParameterValue[readParameters.length+1];System.arraycopy(readParameters,0,readParametersClone,0,readParameters.length);readParametersClone[readParameters.length]=pv;readParameters=readParametersClone;//leavebreak;
if(cinstanceofPage){printer.print((Page)c);
else{printer.print(c);
ifyouwanttoseethemodelvaluesinthedump**@paramvalueDumpEnabled*/publicvoidsetValueDumpEnabled(booleanvalueDumpEnabled){this.valueDumpEnabled=valueDumpEnabled;
ifyouwanttoseethecomponentclassesinthedump**@paramclassDumpEnabled*/publicvoidsetClassDumpEnabled(booleanclassDumpEnabled){this.classDumpEnabled=classDumpEnabled;
if(cinstanceofMarkupContainer){MarkupContainermc=(MarkupContainer)c;for(Iterator<?>it=mc.iterator();it.hasNext();){walkHierarchy((Component)it.next(),level+1);
if(cinstanceofPage)out.print(tab(level)+"PAGE_ROOT");
elseout.print(tab(level)+c.getId());
if(pathDumpEnabled){out.print(""+c.getPageRelativePath());
if(classDumpEnabled){StringclassName;
if(c.getClass().isAnonymousClass()){className=c.getClass().getSuperclass().getName();
else{className=c.getClass().getName();
if(valueDumpEnabled){try{Stringvalue=NEWLINE.matcher(c.getDefaultModelObjectAsString()).replaceAll("\\\\n");out.print("'"+value+"'");
if(url!=null){try{DataLinkInfoImpl.validate(url);
if(content==null){thrownewIllegalArgumentException("Contentofafilecannotbenull.");
if(filePath==null){thrownewIllegalArgumentException("Nameofafilecannotbenull.");
if(checkFileExists(filePath)){thrownewIllegalArgumentException("Thefilealreadyexists");
if(filePath==null){thrownewIllegalArgumentException("NameofafilePathcannotbenull.");
if(checkFileExists(filePath)){Filefile=newFile(getAbsolutePath(filePath).toUri());returnfile.delete();
else{returnfalse;
if(checkFileExists(filePath)){Filefile=newFile(getAbsolutePath(filePath).toUri());returnFileUtils.openInputStream(file);
else{thrownewIOException("Thefiledoesnotexit:"+filePath.toString());
if(folders!=null){for(Stringfolder:folders){paths.add(Paths.get(rootfolder).relativize(Paths.get(file.toString(),folder)).toString());paths.addAll(listFolders(rootfolder,newFile(Paths.get(file.toString(),folder).toUri())));
if(filePath.indexOf(FileService.PLACEHOLDER_VERSION)<0){returnnewFileReferenceImpl(this,filePath,filePath);
if(matcher.matches()){try{set.add(Integer.parseInt(matcher.group(1)));
else{LOGGER.log(Level.WARNING,"thisshouldn'thappen:couldn'tfindversioninversionedfile"+fileName);
if(dataDirectory==null){returngetAbsolutePath(filePath).toUri();
else{try{returnnewURI("file:"+dataDirectory.relativize(getAbsolutePath(filePath)));
if(rootFolder==null){thrownewIllegalStateException("NorootFolderisnotconfiguredinthisfileservice.");
if(dataDirectory!=null){this.dataDirectory=Paths.get(dataDirectory);
else{thrownewIllegalStateException("Unabletodeterminedatadirectory");
if(resourceId!=null&&resourceIdinstanceofList&&!((List)resourceId).isEmpty()){kvp.put(DownloadLinkHandler.RESOURCE_ID_PARAMETER,((List)resourceId).get(0));
if(fileParameter!=null&&fileParameterinstanceofList&&!((List)fileParameter).isEmpty()){kvp.put(DownloadLinkHandler.FILE_PARAMETER,((List)fileParameter).get(0));
if(request.getResourceId()==null){thrownewServiceException("resourceIdparameternotprovidedforDirectDownloadoperation",ServiceException.MISSING_PARAMETER_VALUE,"resourceId");
if(formatName.equals(reader.getFormat().getName())){returnmime;
if(buffer==null){Stringmessage="nullValue.BufferNull";Logging.logger().severe(message);thrownewIllegalArgumentException(message);
if(os==null){Stringmessage="nullValue.FileIsNull";Logging.logger().severe(message);thrownewIllegalArgumentException(message);
if(imginstanceofBufferedImage){return(BufferedImage)img;
if(keys!=null){for(inti=0;i<keys.length;i++){properties.put(keys[i],img.getProperty(keys[i]));
if(VERSION_RR_1_0.equals(version))returnRoleXMLXpath_1_0.Singleton;returnnull;
if(VERSION_RR_1_0.equals(version))returnUserGroupXMLXpath_1_0.Singleton;returnnull;}}
iftheconfigurationhasGHRSSTencodingenabled*/publicclassGHRSSTEncoderFactoryimplementsNetCDFEncoderFactory{@OverridepublicNetCDFEncodergetEncoderFor(GranuleStackgranuleStack,Filefile,Map<String,String>encodingParameters,StringoutputFormat)throwsIOException{NetCDFLayerSettingsContainersettings=NetCDFEncoder.getSettings(encodingParameters);
if(settings!=null&&Boolean.TRUE.equals(settings.getMetadata().get(GHRSSTEncoder.SETTINGS_KEY,Boolean.class))){returnnewGHRSSTEncoder(granuleStack,file,encodingParameters,outputFormat);
ifnoGHRSSTsettings,ordisabled,thenlookforsomeotherencoderreturnnull;
if(settings==null||!Boolean.TRUE.equals(metadata.get(GHRSSTEncoder.SETTINGS_KEY,Boolean.class))){//nope;returnnull;
if("time".equalsIgnoreCase(dimension.getName())){TreeSet<Object>values=(TreeSet<Object>)dimension.getDimensionValues().getValues();Objectfirst=values.first();
if(firstinstanceofDate){referenceDate=(Date)first;
else
if(firstinstanceofDateRange){referenceDate=((DateRange)first).getMinValue();
else{thrownewIllegalArgumentException("Unrecognizeddatatypeforreferencedate:"+first);
if(referenceDate==null){thrownewIllegalArgumentException("Couldnotlocateareferencedateintheinputdata,aGHRSSTfile"+"shouldhaveatimedimension");
if(coverage!=null){try{ImageIOUtilities.disposeImage(coverage.getRenderedImage());coverage.dispose(true);
if(reader!=null){try{reader.dispose();
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine("Incomingeventoftype"+event.getClass().getSimpleName()+"fromCatalog");
ifproducerisnotEnabled
if(!isEnabled()){
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine("skippingincomingevent:contextisnotinitted");
ifwemaypublishalsothefilefinalCatalogInfoinfo=event.getSource();
if(infoinstanceofStyleInfo){finalStyleInfosInfo=((StyleInfo)info);WorkspaceInfowInfo=sInfo.getWorkspace();ResourcestyleFile=null;//makesureweworkfinewithworkspacespecificstyles
if(wInfo!=null){styleFile=loader.get(File.separator+"workspaces"+File.separator+wInfo.getName()+File.separator+"styles"+File.separator+sInfo.getFilename());
else{styleFile=loader.get("styles/"+sInfo.getFilename());
if(!Resources.exists(styleFile)||!Resources.canRead(styleFile)||!(styleFile.getType()==Type.RESOURCE)){thrownewIllegalStateException("Unabletofindstyleforevent:"+sInfo.toString());
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE)){LOGGER.severe(e.getLocalizedMessage());
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine("Incomingmessageeventoftype"+event.getClass().getSimpleName()+"fromCatalog");
if(!isEnabled()){
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine("skippingincomingevent:contextisnotinitted");
if(LOGGER.isLoggable(java.util.logging.Level.SEVERE)){LOGGER.severe(e.getLocalizedMessage());
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine("Incomingmessageeventoftype"+event.getClass().getSimpleName()+"fromCatalog");
if(!isEnabled()){
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine("skippingincomingevent:contextisnotinitted");
ifwemaypublishalsothefileCatalogInfoinfo=event.getSource();//
ifthemodifiedobjectwasastyleweneedtosendthestylefiletoo
if(infoinstanceofStyleInfo){//weneedtogettheassociatedresourcefile,forthisweneedtolook//atthefinalobjectweuseaproxytopreservertheoriginalobjectStyleInfostyleInfo=ModificationProxy.create((StyleInfo)info,StyleInfo.class);//updatedtheproxyobjectwiththenewvaluestry{BeanUtils.smartUpdate(styleInfo,event.getPropertyNames(),event.getNewValues());
if(!resource.file().exists()){//thisshouldnothappenwethrowanexceptionthrownewRuntimeException(String.format("Stylefile'%s'forstyle'%s'couldnotbefound.",styleInfo.getFilename(),styleInfo.getName()));
else{//propagatethecatalogmodifiedeventtry{jmsPublisher.publish(getTopic(),getJmsTemplate(),options,event);
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine("Incomingmessageeventoftype"+event.getClass().getSimpleName()+"fromCatalog");
if(!isEnabled()){
if(LOGGER.isLoggable(java.util.logging.Level.FINE)){LOGGER.fine("skippingincomingevent:contextisnotinitted");
if(service.getKeywords()==null){((CSWInfoImpl)service).setKeywords(newArrayList());
if(service.getExceptionFormats()==null){((CSWInfoImpl)service).setExceptionFormats(newArrayList());
if(service.getMetadata()==null){((CSWInfoImpl)service).setMetadata(newMetadataMap());
if(service.getClientProperties()==null){((CSWInfoImpl)service).setClientProperties(newHashMap());
if(service.getVersions()==null){((CSWInfoImpl)service).setVersions(newArrayList());
if(service.getVersions().isEmpty()){service.getVersions().add(newVersion("2.0.2"));
if(v==null){returnOptional.empty();
if(!isAvailable()){message+="\njava.library.path:"+System.getProperty("java.library.path","");
else{message+=metaData();
if(isAvailable()){Versionv=GeoTools.getVersion(gdal.class);
if(v==null){returnOptional.empty();
else{returnOptional.ofNullable("unavailable");
if(s!=null){gs.remove(s);
ifnoerrorhasbeenfoundtester.assertNoErrorMessage();//GetGeoServerobjectforretrievingthesettingsassociatedtotheworkspaceGeoServergs=getGeoServer();assertNotNull(gs.getSettings(citeWorkspace));//Reloadthepagetester.startPage(newWorkspaceEditPage(citeWorkspace));tester.assertRenderedPage(WorkspaceEditPage.class);//SelectionoftherootdirectoryStringroot=getTestData().getDataDirectoryRoot().getAbsolutePath();//SettherootdirectoryFormTesterform2=tester.newFormTester("form");form2.setValue("settings:settingsContainer:otherSettings:extensions:0:content:rootdir",root);form2.submit();//Check
ifnoerrorhasbeenfoundtester.assertNoErrorMessage();//Control
ifthedefinedroothasbeencorrectlysetassertEquals(gs.getSettings(citeWorkspace).getMetadata().get(RESTUtils.ROOT_KEY,String.class),root);
ifnoerrorhasbeenfoundtester.assertNoErrorMessage();//Control
ifthedefinedroothasbeencorrectlysetassertEquals(gs.getGlobal().getSettings().getMetadata().get(RESTUtils.ROOT_KEY,String.class),root);
ifnoerrorhasbeenfoundtester.assertNoErrorMessage();//Control
ifthedefinedroothasbeencorrectlysetassertEquals(gs.getGlobal().getSettings().getMetadata().get(RESTUtils.QUIET_ON_NOT_FOUND_KEY,Boolean.class),false);//Openingtheselectedpagetester.startPage(newGlobalSettingsPage());tester.assertRenderedPage(GlobalSettingsPage.class);tester.assertNoErrorMessage();//GetGeoServerobjectforsearchingtheglobalsettingsgs=getGeoServer();//Settherootdirectoryform=tester.newFormTester("form");form.setValue("extensions:0:content:quiet",true);form.submit("submit");//Check
ifnoerrorhasbeenfoundtester.assertNoErrorMessage();//Control
ifthedefinedroothasbeencorrectlysetassertEquals(gs.getGlobal().getSettings().getMetadata().get(RESTUtils.QUIET_ON_NOT_FOUND_KEY,Boolean.class),true);}}
ifthemapisenabled.*/booleanisEnabled();/**Setsflagindicating
ifthemapisenabled.*/voidsetEnabled(booleanenabled);/**Thelayersthatcomposethemap.*/List<LayerInfo>getLayers();}
if(query.getPropertyNames()!=Query.ALL_NAMES){result=SimpleFeatureTypeBuilder.retype(featureType,query.getPropertyNames());
else{result=featureType;
if(!query.getJoins().isEmpty()){SimpleFeatureTypeBuildertb=newSimpleFeatureTypeBuilder();tb.init(result);for(Joinjoin:query.getJoins()){StringjoinedFeatureAttribute=join.getAlias();
if(joinedFeatureAttribute==null){joinedFeatureAttribute=join.getTypeName();
iftruethentheresourceisnotexpectedtoalreadyexistinthe*catalog.*@throwsRuntimeError
ifvalidationfails*/voidvalidate(ResourceInforesource,booleanisNew);/***Validateastore.**@paramstoretheStoreInfotobevalidated*@paramisNewaboolean;
iftruethenthestoreisnotexpectedtoalreadyexistinthe*catalog.*@throwsRuntimeError
ifvalidationfails*/voidvalidate(StoreInfostore,booleanisNew);/***Validateaworkspace.**@paramstoretheWorkspaceInfotobevalidated*@paramisNewaboolean;
iftruethentheworkspaceisnotexpectedtoalreadyexistinthe*catalog.*@throwsRuntimeError
ifvalidationfails*/voidvalidate(WorkspaceInfoworkspace,booleanisNew);/***Validatealayer.**@paramlayertheLayerInfotobevalidated*@paramisNewaboolean;
iftruethenthelayerisnotexpectedtoalreadyexistinthe*catalog.*@throwsRuntimeError
ifvalidationfails*/voidvalidate(LayerInfolayer,booleanisNew);/***Validateastyle.**@paramstyletheStyleInfotobevalidated*@paramisNewaboolean;
iftruethenthestyleisnotexpectedtoalreadyexistinthe*catalog.*@throwsRuntimeError
ifvalidationfails*/voidvalidate(StyleInfostyle,booleanisNew);/***Validatealayergroup.**@paramlayerGrouptheLayerGroupInfotobevalidated*@paramisNewaboolean;
iftruethenthelayergroupisnotexpectedtoalreadyexistinthe*catalog.*@throwsRuntimeError
ifvalidationfails*/voidvalidate(LayerGroupInfolayerGroup,booleanisNew);/***Validateanamespace.**@paramnamespacetheNamespaceInfotobevalidated*@paramisNewaboolean;
iftruethenthelayerisnotexpectedtoalreadyexistinthe*catalog*@throwsRuntimeError
ifvalidationfails*/voidvalidate(NamespaceInfonamespace,booleanisNew);}
if(mode==Cipher.ENCRYPT_MODE){returnenc.encrypt(input);
else{returnenc.decrypt(input);
ifnothingfound*usethisdefault.*/publicstaticICryptFactoryget(){
if(Factory!=null)returnFactory;Factory=GeoServerExtensions.bean(ICryptFactory.class);
if(Factory==null)Factory=newGeoserverWicketEncrypterFactory();returnFactory;
if(s!=null){returngetEncrypterFromSession(s);
else{LOGGER.warning("Nosessionavailabetogeturlparameterencrypter");returnNoCrypt;
if(result!=null)returnresult;GeoServerSecurityManagermanager=GeoServerApplication.get().getSecurityManager();char[]key=manager.getRandomPassworddProvider().getRandomPasswordWithDefaultLength();StandardPBEByteEncryptorenc=newStandardPBEByteEncryptor();enc.setPasswordCharArray(key);//sincethepasswordiscopied,wecanscrambleitmanager.disposePassword(key);
if(manager.isStrongEncryptionAvailable()){enc.setProvider(newBouncyCastleProvider());enc.setAlgorithm("PBEWITHSHA256AND128BITAES-CBC-BC");
else//USexportrestrictionsenc.setAlgorithm("PBEWITHMD5ANDDES");result=newCryptImpl(enc);s.setAttribute(ICRYPT_ATTR_NAME,result);returnresult;}}
ifthetempfileserializationwaserrorfree.*@paramobjTheobjecttoserialize.*@paramxpThepersister.*/publicstaticvoidxStreamPersist(Filef,Objectobj,XStreamPersisterxp)throwsIOException{//firstsavetoatempfilefinalFiletemp=File.createTempFile(f.getName(),null,f.getParentFile());BufferedOutputStreamout=null;try{out=newBufferedOutputStream(newFileOutputStream(temp));xp.save(obj,out);out.flush();
if(out!=null)org.apache.commons.io.IOUtils.closeQuietly(out);
if(temp.exists()){temp.delete();
ifthetempfileserializationwaserror*free.*@paramobjTheobjecttoserialize.*@paramxpThepersister.*/publicstaticvoidxStreamPersist(Resourcer,Objectobj,XStreamPersisterxp)throwsIOException{try(OutputStreamout=r.out()){xp.save(obj,out);out.flush();
if(showXML!=null){printDom((Document)item,showXML);
ifthereisanexceptionwhiledoingso,printthe*stacktrace.**@paramdom*@paramos*/publicstaticvoidprintDom(Nodedom,OutputStreamos){Transformertrans;PrintWriterw=newPrintWriter(os);try{TransformerFactoryfact=TransformerFactory.newInstance();trans=fact.newTransformer();trans.transform(newDOMSource(dom),newStreamResult(newOutputStreamWriter(os)));
if(i%100==0){longcurr=System.currentTimeMillis();LOGGER.info(i+"-"+(curr-start));start=curr;
if("dateProperty".equals(e.getAttribute("name"))){date="xsd:date".equals(e.getAttribute("type"));
if("dateTimeProperty".equals(e.getAttribute("name"))){dateTime="xsd:dateTime".equals(e.getAttribute("type"));
if(node.getNodeName().equals("xsd:complexType")){seenComplexType=true;
else
if(seenComplexType&&node.getNodeName().equals("xsd:import")){fail("Allxsd:importmustoccurbeforeallxsd:complexType");
iftherequestedtypeNameisnotqualifiedanditdoesexist*intheGeoServer'sdefaultnamespace,thelookupshouldfail,sincetherequestdoesnot*addressesthetypeNameeitherbyqualifyingitasdeclaredinthegetcapsdocument,or*providinganalternateprefixwithitscorrespondingprefixtonamespacemapping.*/@TestpublicvoidtestCiteCompliance()throwsException{finalQNametypeName=CiteTestData.STREAMS;//makesuretypeName_is_inthedefaultnamespaceCatalogcatalog=getCatalog();NamespaceInfodefaultNs=catalog.getDefaultNamespace();GeoServergeoServer=getGeoServer();WFSInfoservice=geoServer.getService(WFSInfo.class);try{//makesuretypeName_is_inthedefaultnamespacecatalog.setDefaultNamespace(catalog.getNamespaceByURI(typeName.getNamespaceURI()));FeatureTypeInfotypeInfo=catalog.getFeatureTypeByName(typeName.getNamespaceURI(),typeName.getLocalPart());typeInfo.setEnabled(true);catalog.save(typeInfo);DataStoreInfostore=typeInfo.getStore();store.setEnabled(true);catalog.save(store);//andrequesttypeNamewithoutprefixStringpath="ows?service=WFS&version=2.0.0&request=DescribeFeatureType&typeName="+typeName.getLocalPart();Documentdoc;//first,noncitecompliantmodeshouldfindthetypeeven
ifnamespaceisnot//specifiedservice.setCiteCompliant(false);geoServer.save(service);doc=getAsDOM(path);print(doc);assertSchema(doc,typeName);//then,incitecompliancemore,itshouldnotfindthetypenameservice.setCiteCompliant(true);geoServer.save(service);doc=getAsDOM(path,400);//print(doc);assertEquals("ows:ExceptionReport",doc.getDocumentElement().getNodeName());
if(count==null){count=newInteger(1);
else{count=newInteger(count.intValue()+1);
if(authConfig.isUseRememberMe()){//filter.setRememberMeServices(securityManager.getRememberMeService());//GeoServerWebAuthenticationDetailsSources=new//GeoServerWebAuthenticationDetailsSource();//filter.setAuthenticationDetailsSource(s);//
if(auth==null){//doAuth(request,response);//
else{//LOGGER.fine("FoundexistingAuthenticationincontext:"+auth);//
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;DbTableImplother=(DbTableImpl)obj;
if(dbSource==null){
if(other.dbSource!=null)returnfalse;
else
if(!dbSource.equals(other.dbSource))returnfalse;
if(tableName==null){
if(other.tableName!=null)returnfalse;
else
if(!tableName.equals(other.tableName))returnfalse;returntrue;}}
if(getRequestPath(request).startsWith(pathInfo))returntrue;
if(wml==null){wml=catalog.getFactory().createWMTSLayer();wml.setName(LAYER_NAME);wml.setNativeName("topp:"+LAYER_NAME);wml.setStore(catalog.getStoreByName("demo",WMTSStoreInfo.class));wml.setCatalog(catalog);wml.setNamespace(catalog.getNamespaceByPrefix("sf"));wml.setSRS("EPSG:4326");CoordinateReferenceSystemwgs84=CRS.decode("EPSG:4326");wml.setNativeCRS(wgs84);wml.setLatLonBoundingBox(newReferencedEnvelope(-110,0,-60,50,wgs84));wml.setProjectionPolicy(ProjectionPolicy.FORCE_DECLARED);catalog.add(wml);
if(l!=null){catalog.remove(l);
if(l!=null){catalog.remove(l);
if(r!=null){catalog.remove(r);
if(l==null){l=catalog.getFactory().createLayer();l.setResource(catalog.getResourceByName("sf",LAYER_NAME,WMTSLayerInfo.class));catalog.add(l);
if(type==null)thrownewIllegalArgumentException("Notsupportedmimetypefor:"+outputFormat);
switch(type){caseJSON:OutputStreamWriterosw=null;WriteroutWriter=null;try{osw=newOutputStreamWriter(output,wms.getGeoServer().getSettings().getCharset());outWriter=newBufferedWriter(osw);writeJSON(outWriter,layers);
if(request==null){returnJSONType.CALLBACK_FUNCTION;
else{returnJSONType.getCallbackFunction(request.getKvp());
if(targetCrs==null){//nothingtodoreturnfeatureCollections;
ifthesourceCRSisequaltothetargetCRS*nothingwillbedone.**@paramfeatureCollectionfeaturecollectiontobereprojected,shouldNOTbeNULL*@paramtargetCrsreprojectiontargetCRS,canbeNULL*@returnfeaturecollection,itmaybereprojectedornot*/@SuppressWarnings("unchecked")publicstaticFeatureCollectionreproject(FeatureCollectionfeatureCollection,CoordinateReferenceSystemtargetCrs){
if(targetCrs==null){//nothingtodoreturnfeatureCollection;
if(!(featureCollectioninstanceofSimpleFeatureCollection)){//notabletoreprojectcomplexfeaturescollectionLOGGER.warning("Complexfeaturecollectionwillnotbereprojected.");returnfeatureCollection;
if(sourceCrs==null){//reprojectorrequiresthesourceCRStobedefinedreturnfeatureCollection;
if(!CRS.equalsIgnoreMetadata(sourceCrs,targetCrs)){try{//reprojecttotothetargetCRSreturnnewReprojectFeatureResults(featureCollection,targetCrs);
ifnocommonCRScanbefound(i.e.wehavegeometrieswith*differentCRS)NULLwillbereturned.**@paramfeatureCollectionfeaturecollection,shouldNOTbeNULL*@returnthefoundCRS,maybeNULL*/publicstaticCoordinateReferenceSystemgetCrs(FeatureCollectionfeatureCollection){CoordinateReferenceSystemcrs=featureCollection.getSchema().getCoordinateReferenceSystem();
if(crs!=null||featureCollection.isEmpty()){//thefeaturecollectionhasadefinedCRSorthefeaturecollectionisemptyreturncrs;
if(crs!=null){//thegeometrydescriptorhasadefinedCRSreturncrs;
if(!(featureinstanceofSimpleFeature)){//notasimplefeature,wearedonereturnnull;
if(!(objectinstanceofGeometry)){//currentfeaturedoesn'thaveageometry,movetothenextonecontinue;
if(!(userDatainstanceofCoordinateReferenceSystem)){//nouserdataavailableordoesn'tcontainacoordinatereferencesystemreturnnull;
if(crs!=null&&!CRS.equalsIgnoreMetadata(crs,geometryCrs)){//thisgeometryCRSisdifferentfromtheotherones,wearedonereturnnull;
ifnogeometriesaredefinedreturncrs;}}
ifwehavethecorrectcomponentsinstantiatedtester.assertComponent("selector",Form.class);tester.assertComponent("selector:typeOfBlobStore",DropDownChoice.class);tester.assertComponent("blobConfigContainer",MarkupContainer.class);//theblobstoreformshouldnotbevisibletester.assertInvisible("blobConfigContainer:blobStoreForm");//weshouldhavetwotypesofblobstoresavailable(fileandmbtiles)DropDownChoicetypeOfBlobStore=(DropDownChoice)tester.getComponentFromLastRenderedPage("selector:typeOfBlobStore");assertEquals(2,typeOfBlobStore.getChoices().size());assertEquals("FileBlobStore",typeOfBlobStore.getChoices().get(0).toString());assertEquals("MBTilesBlobStore",typeOfBlobStore.getChoices().get(1).toString());//let'sselectthefilestoreexecuteAjaxEventBehavior("selector:typeOfBlobStore","change","0");//theblobstoreformshouldbevisiblenowtester.assertVisible("blobConfigContainer:blobStoreForm");//andtheformshouldbethefileblobstoreonetester.assertComponent("blobConfigContainer:blobStoreForm:blobSpecificPanel",FileBlobStorePanel.class);//let'sselectthembtilesstoreexecuteAjaxEventBehavior("selector:typeOfBlobStore","change","1");//theformshouldbethembtilesblobstoreonetester.assertComponent("blobConfigContainer:blobStoreForm:blobSpecificPanel",MbtilesBlobStorePanel.class);
ifastorewiththecorrectoptionswasinstantiatedMbtilesInfoconfiguration=findStore(storeId);assertThat(configuration,notNullValue());assertThat(configuration.getRootDirectory(),is("/tmp/gwc"));assertThat(configuration.getTemplatePath(),is("{grid}/{layer}/{params}/tiles-{z}.sqlite"));assertThat(configuration.getRowRangeCount(),is(1500L));assertThat(configuration.getColumnRangeCount(),is(500L));assertThat(configuration.getPoolSize(),is(2000L));assertThat(configuration.getPoolReaperIntervalMs(),is(1000L));assertThat(configuration.eagerDelete(),is(true));assertThat(configuration.useCreateTime(),is(true));assertThat(configuration.getMbtilesMetadataDirectory(),is("/tmp/gwc/mbtilesMetadata"));//removingthecreatedstoreGWC.get().removeBlobStores(Collections.singleton(storeId));
ifthestorewascorrectlyupdatedassertThat(findStore(storeId),nullValue());MbtilesInfoconfiguration=findStore(updatedStoreId);assertThat(configuration,notNullValue());assertThat(configuration.getTemplatePath(),is("{grid}/{layer}/{params}/{style}/tiles-{z}.sqlite"));//testthatthestoreidupdatedwascorrectlypropagatedlayer=GWC.get().getTileLayerByName("cite:Lakes");assertThat(layer.getBlobStoreId(),is(updatedStoreId));//removethecreatedstoreGWC.get().removeBlobStores(Collections.singleton(updatedStoreId));
if(candidateConfigurationinstanceofMbtilesInfo&&candidateConfiguration.getId().equals(storeId)){return(MbtilesInfo)candidateConfiguration;
if(policy.getLimits()instanceofWMSAccessLimits){WMSAccessLimitswl=(WMSAccessLimits)policy.getLimits();
if(!wl.isAllowFeatureInfo()){returnfalse;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;SecuredWMSLayerother=(SecuredWMSLayer)obj;
if(delegate==null){
if(other.delegate!=null)returnfalse;
else
if(!delegate.equals(other.delegate))returnfalse;
if(policy==null){
if(other.policy!=null)returnfalse;
else
if(!policy.equals(other.policy))returnfalse;returntrue;
if(tempPath==null){tempPath=IOUtils.createTempDirectory("backuputils").getAbsolutePath();LOGGER.warning("ItwasnotpossibletocreateatemporaryfolderintotheSystem'java.io.tmpdir'.FallingbacktodefaultTEMP["+tempPath+"].");
if(tempPath==null){LOGGER.log(Level.SEVERE,"Itwasnotpossibletocreateorfindasuitabletemporaryfolder.'tempPath'isNULL!Inordertofixtheproblem,pleasechecktheSystem'java.io.tmpdir'pointtoavalidfolder.");thrownewIOException("Itwasnotpossibletocreateorfindasuitabletemporaryfolder.'tempPath'isNULL!Inordertofixtheproblem,pleasechecktheSystem'java.io.tmpdir'pointtoavalidfolder.");
if(manager.canCreateFileSystem(source)){source=manager.createFileSystem(source);
if("zip".equalsIgnoreCase(FileUtils.getExtension(archiveFile.path()))){//apacheVFSdoesnotsupportZIPaswritableFileSystemOutputStreamfos=archiveFile.out();//Createaccesstozip.ZipOutputStreamzos=newZipOutputStream(fos);//addentry/-ies.for(FileObjectsourceFile:sourceDir.getChildren()){writeEntry(zos,sourceFile,null);
else{//Createaccesstoarchive.FileObjectzipFile=manager.resolveFile(resolveArchiveURI(archiveFile));zipFile.createFile();ZipOutputStreamzos=newZipOutputStream(zipFile.getContent().getOutputStream());//addentry/-ies.for(FileObjectsourceFile:sourceDir.getChildren()){writeEntry(zos,sourceFile,null);
if(sourceFile.getType()==FileType.FOLDER){//addentry/-ies.for(FileObjectfile:sourceFile.getChildren()){writeEntry(zos,file,Paths.path(baseDir,sourceFile.getName().getBaseName()));
else{StringfileName=(baseDir!=null?Paths.path(baseDir,sourceFile.getName().getBaseName()):sourceFile.getName().getBaseName());ZipEntryzipEntry=newZipEntry(fileName);InputStreamis=sourceFile.getContent().getInputStream();//Writetozip.byte[]buf=newbyte[1024];zos.putNextEntry(zipEntry);for(intreadNum;(readNum=is.read(buf))!=-1;){zos.write(buf,0,readNum);
if(file.getType()==Type.DIRECTORY){return"file://";
if(name.endsWith(".zip")||name.endsWith(".kmz")){return"zip://";
if(name.endsWith(".tar")){return"tar://";
if(name.endsWith(".tgz")||name.endsWith(".tar.gz")){return"tgz://";
if(name.endsWith(".tbz2")||name.endsWith(".tar.bzip2")||name.endsWith(".tar.bz2")){return"tbz2://";
if(name.endsWith(".gz")){return"gz://";
if(name.endsWith(".bz2")){return"bz2://";
if(name.endsWith(".jar")){return"jar://";
if(features==null){thrownewIllegalArgumentException("featuresparamcannotbenull");
if(fieldName==null||fieldName.isEmpty()){thrownewIllegalArgumentException("EmptyornullfieldNameprovided!");
if(visitor.getResult()==null||visitor.getResult().toList()==null){listSize=0;list=newArrayList<String>(0);
else{listSize=visitor.getResult().toList().size();
if(maxFeatures==null||maxFeatures>listSize){maxFeatures=listSize;
if(startIndex!=null){visitor.setStartIndex(startIndex);
if(maxFeatures!=null){visitor.setMaxFeatures(maxFeatures);
if(visitor.getResult()==null||visitor.getResult().toList()==null){list=newArrayList<String>(0);
else{list=visitor.getResult().toList();
if(httpClient==null){httpClient=newSimpleHttpClient();
if(StringUtils.hasLength(webServiceUrl)==false){thrownewIOException("Webserviceurlisunset");
if(StringUtils.hasLength(searchUser)){try{Pattern.compile(searchUser);
if(responseBody==null){LOGGER.log(Level.WARNING,"Couldnotfindanyuserassociatedtowebserviceurl["+webServiceUrl+"]withauthkey:"+key);RECORDED_RESPONSE.remove();returnnull;
else{RECORDED_RESPONSE.set(responseBody);
if(getUserGroupService()!=null){Stringusername=null;
if(searchUserRegex==null){username=responseBody;
else{Matchermatcher=searchUserRegex.matcher(responseBody);
if(matcher.find()){username=matcher.group(1);
else{LOGGER.log(Level.WARNING,"ErrorinWebServiceAuthenticationKeyMapper,cannotfinduserNameinresponse");
if(username!=null){return(GeoServerUser)getUserGroupService().loadUserByUsername(username);
if(mapperParams!=null){
if(mapperParams.containsKey("webServiceUrl")){setWebServiceUrl((String)mapperParams.get("webServiceUrl"));
if(mapperParams.containsKey("searchUser")){setSearchUser((String)mapperParams.get("searchUser"));
if(mapperParams.containsKey("connectTimeout")){try{connectTimeout=Integer.parseInt((String)mapperParams.get("connectTimeout"));
if(mapperParams.containsKey("readTimeout")){try{readTimeout=Integer.parseInt((String)mapperParams.get("readTimeout"));
if(paramName.equalsIgnoreCase("searchUser")){return"^\\s*(.*)\\s*$";
if(paramName.equalsIgnoreCase("connectTimeout")){return"5";
if(paramName.equalsIgnoreCase("readTimeout")){return"10";
if(paramName.equalsIgnoreCase("webServiceUrl")){return"http://host:port/service?authkey={key}";
if(value==null){value="";
if(paramName.equalsIgnoreCase("searchUser")&&!value.isEmpty()){try{Pattern.compile(value);
if(paramName.equalsIgnoreCase("connectTimeout")){try{Integer.parseInt(value);
if(paramName.equalsIgnoreCase("readTimeout")){try{Integer.parseInt(value);
if(paramName.equalsIgnoreCase("webServiceUrl")){
if(!value.contains("{key}")){throwcreateFilterException(AUTH_KEY_WEBSERVICE_PLACEHOLDER_REQUIRED,value);
if(pkg.getName().contains("marlin")){provider="Marlin";
else
if(pkg.getName().contains("sun.dc")){provider="OracleJDK";
else
if(pkg.getName().contains("sun.java2d")){provider="OpenJDK";
else{provider=pkg.getName();
if(config!=null){msg.append("Configuration:-Dsun.java2d.renderer=");msg.append(config);
if(provider.hasGeoGig(repositoryName)){thrownewCommandSpecException("Thespecifiedrepositorynameisalreadyinuse,pleasetryadifferentname",HttpStatus.CONFLICT);
if(!(providerinstanceofGeoServerRepositoryProvider)){thrownewCommandSpecException("Unexpectedrepositoryprovider");
if(newRepo==null){thrownewCommandSpecException("Repositorynotfound",HttpStatus.NOT_FOUND);
if(channel!=null){channel.exchangeDeclare(exchangeName,EXCHANGE_TYPE);channel.basicPublish(exchangeName,routingKey,null,payload);
if("cite".equals(layer.getResource().getStore().getWorkspace().getName())&&!"Geometryless".equals(layer.getName())){assertEquals("Didnotfind"+layer.getName(),1,xpath.getMatchingNodes("//wms:Layer[wms:Name='"+layer.getName()+"']",dom).getLength());
else{assertEquals("Foundunexpected"+layer.getName(),0,xpath.getMatchingNodes("//wms:Layer[wms:Name='"+layer.getName()+"']",dom).getLength());
if(req==null){String[]fields=getFields(fieldsSpec);returnnewMonitorQueryResults(monitor.getDAO().getOwsRequests(),fields,monitor);
else{returnhandleObjectGet(req,from,to,filter,order,offset,count,live,fieldsSpec);
if(username!=null&&!username.isEmpty()&&password!=null&&!password.isEmpty()){BROKER_URI="amqp://"+username+":"+password+"@localhost:4432";
if(channel!=null){try{channel.close();
if(connection!=null){try{connection.close();
ifanembeddedserverisalreadystarted.*@since1.3.2*/publicstaticvoidstartEmbeddedServer(intport,StringdefaultPartitionSuffix,StringdefaultPartitionName,booleanallowAnonymousAccess){
if(embeddedServer!=null){thrownewIllegalStateException("Anembeddedserverisalreadystarted");
ifthereisone.Ifnoserverwaspreviouslystartedinthis*JVMthisissilentlyignored.**@since1.3.2*/publicstaticvoidshutdownEmbeddedServer()throwsException{
if(embeddedServer!=null){embeddedServer.shutdown();embeddedServer=null;
if(!portIsBusy("127.0.0.1",LDAP_SERVER_PORT)){startEmbeddedServer(LDAP_SERVER_PORT,basePath,"test",allowAnonymous);//BindtothedirectoryLdapContextSourcecontextSource=newLdapContextSource();contextSource.setUrl(ldapServerUrl);contextSource.setUserDn(DEFAULT_PRINCIPAL);contextSource.setPassword(DEFAULT_PASSWORD);contextSource.setPooled(false);contextSource.afterPropertiesSet();//CreatetheSprintLDAPtemplateLdapTemplatetemplate=newLdapTemplate(contextSource);//Clearoutanyolddata-andloadthetestdatacleanAndSetup(template.getContextSource(),newDistinguishedName("dc=example,dc=com"),newClassPathResource(ldifPath));returntrue;
ifanetworkhost/portisalreadyoccupied.**@paramhost*@paramport*/privatestaticbooleanportIsBusy(Stringhost,intport){ServerSocketss=null;DatagramSocketds=null;try{ss=newServerSocket(port);ss.setReuseAddress(true);ds=newDatagramSocket(port);ds.setReuseAddress(true);returnfalse;
if(ds!=null){ds.close();
if(ss!=null){try{ss.close();
ifanythinggoeswrongremovingthesub-tree.*/publicstaticvoidclearSubContexts(ContextSourcecontextSource,Namename)throwsNamingException{DirContextctx=null;try{ctx=contextSource.getReadWriteContext();clearSubContexts(ctx,name);
ifanythinggoeswrongremovingthesub-tree.*/publicstaticvoidclearSubContexts(DirContextctx,Namename)throwsNamingException{NamingEnumerationenumeration=null;try{enumeration=ctx.listBindings(name);while(enumeration.hasMore()){Bindingelement=(Binding)enumeration.next();DistinguishedNamechildName=newDistinguishedName(element.getName());childName.prepend((DistinguishedName)name);try{ctx.destroySubcontext(childName);
iftheResourcecannotberead.*/publicstaticvoidloadLdif(ContextSourcecontextSource,ResourceldifFile)throwsIOException{DirContextcontext=contextSource.getReadWriteContext();try{loadLdif(context,ldifFile);
if(baseDn!=null){dn.removeFirst(baseDn);
if(sync!=Sync.SYNC){
if(tasks==null){tasks=newPipeliningTaskQueue<Thread>();tasks.start();
else{
if(tasks!=null){dispose();
if(mode!=Mode.HISTORY){
if(sync==Sync.ASYNC_UPDATE){//async_updatemeansdon'truntheinitialinsertasynchronouslynewInsert(data).run();
else{run(newInsert(data));
else{//don'tpersistyet,wepersistattheveryendofrequest
if(sync==Sync.ASYNC_UPDATE){//async_updatemeansdon'truntheinitialinsertasynchronouslynewInsert(data).run();
else{run(newInsert(data));
else{//run(newUpdate(data));//
if(tasks!=null){tasks.shutdown();tasks=null;
if(q.getOffset()!=null){count=Math.max(0,count-q.getOffset());
if(q.getCount()!=null){count=Math.min(count,q.getCount());
if(q.getProperties().isEmpty()){//selectedwholeobject,justreturnthelistdirectlyreturnlist;
if(q.getProperties().isEmpty()&&q.getAggregates().isEmpty()){while(it.hasNext()){visitor.visit((RequestData)it.next());
else{while(it.hasNext()){//TODO:avoidtheintenseobjectcreation,andreflection...weprobably//justwanttoexposethevaluesdirectlytothevisitorintnprops=q.getProperties().size()+q.getAggregates().size();Object[]values=nprops==1?newObject[]{it.next()}:(Object[])it.next();RequestDatadata=toRequest(values,q);//aggregatepropertiesObject[]aggregates=!q.getAggregates().isEmpty()?newObject[q.getAggregates().size()]:null;intoff=q.getProperties().size();for(inti=0;i<q.getAggregates().size();i++){aggregates[i]=values[off+i];
if(objinstanceofRequestData){return(RequestData)obj;
if(prop.equals("resource")){//thismeansajoinedqueryinwhichtheyselectedanindividual//accessesresourcefromtheRequestData.resourcescollectiondata.getResources().add((String)values[i]);
else{OwsUtils.set(data,prop,values[i]);
if(orderBy!=null){sb.append("ORDERBYx.").append(orderBy).append("DESC");
if(q.getOffset()!=null){query.setFirstResult(q.getOffset().intValue());
if(q.getCount()!=null){query.setMaxResults(q.getCount().intValue());
if(q.getProperties().isEmpty()&&q.getAggregates().isEmpty()){//selectthewholeobjectsb.append(prefix);
else{//onlyloadthespecifiedpropertiesfor(Stringprop:q.getProperties()){prefix(prop,prefix,sb).append(",");
if(prop.equals("resource")){join=true;
if(agg.equals("count()")){agg="count("+prefix+")";
if(!join&&q.getFilter()!=null){//wemayneedtojoindependingonwhatisfoundinthequeryJoinDeterminerjt=newJoinDeterminer();q.getFilter().accept(jt);join=jt.doJoin();
if(join){sb.append("LEFTJOIN").append(prefix).append(".resourcesASresource");
if(q.getFilter()!=null){sb.append("WHERE");q.getFilter().accept(newFilterEncoder(sb,prefix,objs));
if(q.getFromDate()!=null||q.getToDate()!=null){
if(q.getFilter()!=null){sb.append("AND");
else{sb.append("WHERE");
if(q.getFromDate()!=null&&q.getToDate()!=null){sb.append("BETWEEN?AND?");objs.add(q.getFromDate());objs.add(q.getToDate());
else
if(q.getFromDate()!=null){sb.append(">=?");objs.add(q.getFromDate());
else{sb.append("<=?");objs.add(q.getToDate());
if(!q.getGroupBy().isEmpty()){sb.append("GROUPBY");for(Stringprop:q.getGroupBy()){prefix(prop,prefix,sb).append(",");
if(q.getSortBy()!=null){sb.append("ORDERBY");StringsortBy=q.getSortBy();
if(sortBy.equals("count()")){sb.append("count("+prefix+")");
else{prefix(sortBy,prefix,sb);
else
if(q.getFromDate()!=null||q.getToDate()!=null){//onlysort
ifthisisnotanaggregatequery
if(q.getAggregates().isEmpty()){//bydefaultsortdatesdescendingsb.append("ORDERBY").append(prefix).append(".startTime").append("").append(SortOrder.DESC);
if(!"resource".equals(prop)){sb.append(prefix).append(".");
if("resource".equals(f.getLeft())){join=true;
if(isProperty(f.getLeft())){prefix((String)f.getLeft(),prefix,sb);
else{sb.append("?");objs.add(f.getLeft());
if(f.getRight()==null){sb.append("IS");
if(f.getType()!=Comparison.EQ){sb.append("NOT");
else{sb.append("").append(f.getType());
if(f.getType()==Comparison.IN){
if(isProperty(f.getRight())){sb.append("elements(").append(f.getRight()).append(")");
else{sb.append("(");for(Objecto:(List)f.getRight()){sb.append("?,");objs.add(o);
else{
if(isProperty(f.getRight())){prefix((String)f.getRight(),prefix,sb);
else{sb.append("?");objs.add(f.getRight());
if(objinstanceofString){Strings=(String)obj;return"resource".equals(s)||OwsUtils.has(newRequestData(),s);
if(tasks!=null){tasks.execute(Thread.currentThread(),newAsync(task),task.desc);
else{task.run();
if(data.getId()==-1){newInsert(data).run();
else{newUpdate(data).run();
if(tasks!=null)tasks.print();throwe;
if(aliases==null||aliases.isEmpty()){hadAliases=false;//assignprefixesaliases=newArrayList<String>();for(intj=0,i=0;i<featureTypes.size();i++){Stringalias;booleanconflictFound;do{conflictFound=false;alias=String.valueOf((char)('a'+(j++)));for(FeatureTypeInfoft:featureTypes){
if(alias.equals(ft.getName())||alias.equals(ft.prefixedName())){conflictFound=true;break;
else{hadAliases=true;
if(isJoinFilter(filter.getFilter(),extraData)){checkValidJoinFilter(filter);joinFilters.add(filter);
else{handleOther(filter,extraData);
if(prefixes.size()>2){thrownewWFSException("Notsubfilterjoinsagainstmorethanonetable"+prefixes+",thiskindoffilterisnotsupported:"+filter);
if(opinstanceofAnd){for(Filterf:op.getChildren()){f.accept(this,extraData);
else{booleanjoinFilter=false;for(Filterchild:op.getChildren()){
if(isJoinFilter(child,extraData)){joinFilter=true;break;
if(joinFilter){checkValidJoinFilter(op);joinFilters.add(op);
else{handleOther(op,extraData);
if(isJoinFilter(expressions)){joinFilters.add(f);
else{handleOther(f,extraData);
iftheexpressionswereallpropertynames//however,f(t1.x)=t2.yisalsoajoinfilter,andt1.x+2=t2.ytoo//So,generalizeditabit,it'sstillnotfullycorrectthough,//asitcanbefooledbya.x=a.y,whichisnotajoinfilter...butwe//canhavethefullname(noalias)twiceinaselfjoin,andthatwouldbeavalidjoin...//uff!Set<String>prefixes=newHashSet<>();for(Expressionex:expressions){FilterAttributeExtractorfae=newFilterAttributeExtractor();ex.accept(fae,null);Set<String>localAttributes=fae.getAttributeNameSet();Set<String>localPrefixes=getPrefixes(localAttributes);
if(!localPrefixes.isEmpty()){
if(prefixes.size()==0){//accumulatetheprefixes,toseehowmanytableswe'rejoiningprefixes.addAll(localPrefixes);
else
if(prefixes.size()>1){//e.g.f(a.x,b.y)=b.zreturntrue;
else{//isitacomparisonamongattributesofthesametable,ornot?//e.g.,a.x=a.yisnotajoinfilter(aselfjoinwouldusetwodifferent//aliases)localPrefixes.removeAll(prefixes);
if(!localPrefixes.isEmpty()){returntrue;
if(idx>0){Stringprefix=attribute.substring(0,idx);result.add(prefix);
if(aliases!=null){join.setAlias(aliases.get(i));
if(otherFilters.get(i+1)!=null){join.setFilter(otherFilters.get(i+1));
if(primaryFeatureType==null){returnfeatureTypes;
else{List<FeatureTypeInfo>result=newArrayList<>();result.add(primaryFeatureType);result.addAll(featureTypes);returnresult;
if(primaryFeatureType==null){intidx=getPrimaryFeatureTypeIndex(this.joinFilters);primaryFeatureType=featureTypes.get(idx);primaryAlias=aliases.get(idx);featureTypes.remove(idx);aliases.remove(idx);
if(prefixes.size()!=1){thrownewWFSException("Extractedinvalidjoinfilter"+filter+",itjoinsmorethan"+"onesecondaryfeaturetype+"+prefixes+"withthecentraljoinfeaturetype"+primaryAlias+"/"+primaryName);
if(idx==-1){thrownewWFSException("Extractedinvalidjoinfilter"+filter+",itusestheunkonwnalias/typename"+alias);
if(idx>0){Stringprefix=name.substring(0,idx);idx=prefix.indexOf(":");
if(idx>0){StringlocalNsPrefix=prefix.substring(0,idx);NamespaceSupportnamespaceSupport=attributeName.getNamespaceContext();
if(namespaceSupport!=null){Stringns=namespaceSupport.getURI(localNsPrefix);
if(ns!=null){Optional<String>wsName=featureTypes.stream().filter(ft->ns.equals(ft.getQualifiedName().getNamespaceURI())).map(ft->ft.getStore().getWorkspace().getName()).findFirst();
if(wsName.isPresent()){prefix=wsName.get()+":"+prefix.substring(idx+1);
if(prefixes.size()!=1){thrownewWFSException("Extractedinvalidjoinsub-filter"+filter+",itusersmorethanonefeaturetype+"+prefixes);
if(primaryFeatureType.equals(ft)){updateFilter(sorted,0,rewritten);
else{intidx=featureTypes.indexOf(ft);
if(idx==-1){thrownewWFSException("Extractedinvalidjoinfilter"+filter+",itusestheunkonwnalias/typename"+alias);
if(localTypeName!=null){typeMap.put(localTypeName,ft);
if(ft.getNamespace()!=null&&ft.getNamespace().getURI()!=null){Stringuri=ft.getNamespace().getURI();Stringname=ft.getName();
if(queriedTypes!=null){for(QNametype:queriedTypes){StringnamespaceURI=type.getNamespaceURI();Stringprefix=type.getPrefix();
if(prefix!=null&&namespaceURI!=null&&namespaceURI.equals(uri)&&type.getLocalPart().equals(name)){returnprefix+":"+type.getLocalPart();
if(localTypeName!=null){nameToAlias.put(localTypeName,primaryAlias);
if(localTypeName!=null){nameToAlias.put(localTypeName,alias);
if*wehaveonefeaturetypethatisactingasthecenterofthestar,orthrowanexception
if*wedon'thaveone.**@paramfilters2*/privateintgetPrimaryFeatureTypeIndex(List<Filter>filters){
if(featureTypes.size()==2){return0;
if(connecteds.isEmpty()){thrownewWFSException("Cannotrunthistypeofjoin,atthemomentGeoServeronlysupports"+"joinshavingasinglecentralfeaturetypejoinedtoallothers");
else{returnconnecteds.iterator().next();
if(aliasIdx>=0){nameTypes.add(aliasIdx);
else{for(inti=0;i<featureTypes.size();i++){FeatureTypeInfoft=featureTypes.get(i);
if(prefix.equals(ft.prefixedName())||prefix.equals(ft.getName())){nameTypes.add(i);break;
if(filters[i]==null){filters[i]=filter;
else{filters[i]=ff.and(filters[i],filter);
if(idx>0){prefix=n.substring(0,idx);
if(prefixes.contains(prefix)){
if(nameToAlias.get(prefix)!=null){prefix=nameToAlias.get(prefix);
else{n=null;
else{n=null;
if(n!=null){//removetheeventualnamespaceprefix,joinareonlysupportedforsimplefeatures//rightnowanyways,underlyingstoresdonotunderstandtheprefixesintcolonIdx=n.indexOf(':');
if(colonIdx>0){n=n.substring(colonIdx+1);
if(addPrefix){n=(prefix!=null?prefix:"")+"."+n;
switch(type){caseBACKUP:backupBeforeInvocations++;break;caseRESTORE:restoreBeforeInvocations++;break;
switch(type){caseBACKUP:backupAfterInvocations++;break;caseRESTORE:restoreAfterInvocations++;break;
if(featureType.getDescriptor(field)!=null){thrownewInvalidParameterException("Thecomputedattribute"+field+"isalreadypresentinthe"+"sourcefeaturetype");
if(thisinstanceofGML2){returnthis;
if(thisinstanceofGML3){returnthis;
ifpossible.*Avalueof"1"indicatesthatonelinkingelement*locatorattribute(href)XLinkwillbetraversed*andthereferencedelementreturned
ifpossible,but*nestedpropertyXLinklinkingelementlocatorattribute*(href)XLinksinthereturnedelementarenottraversed.*Avalueof"*"indicatesthatallnestedpropertyXLink*linkingelementlocatorattribute(href)XLinkswillbe*traversedandthereferencedelementsreturned
if*possible.Therangeofvalidvaluesforthisattribute*consistsofpositiveintegersplus"*".*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:attribute&gt;*&lt;xsd:attributename="traverseXlinkExpiry"*type="xsd:positiveInteger"use="optional"&gt;*&lt;xsd:annotation&gt;*&lt;xsd:documentation&gt;*ThetraverseXlinkExpiryattributevalueisspecified*inminutes.ItindicateshowlongaWebFeatureService*shouldwaittoreceivearesponsetoanestedGetGmlObject*request.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:attribute&gt;*&lt;/xsd:extension&gt;*&lt;/xsd:complexContent&gt;*&lt;/xsd:complexType&gt;**</code>*</pre>**@generated*/publicclassGetGmlObjectTypeBindingextendsAbstractComplexBinding{WfsFactorywfsfactory;publicGetGmlObjectTypeBinding(WfsFactorywfsfactory){this.wfsfactory=wfsfactory;
if(node.hasAttribute("outputFormat")){getGmlObject.setOutputFormat((String)node.getAttributeValue("outputFormat"));
if(node.hasAttribute("traverseXlinkExpiry")){getGmlObject.setTraverseXlinkExpiry((BigInteger)node.getAttributeValue("traverseXlinkExpiry"));
if(GeoServerUser.ROOT_USERNAME.equals(principal)){roles=Collections.singleton(GeoServerRole.ADMIN_ROLE);
else{try{roles=getRoles(principal);
if(roles.contains(GeoServerRole.AUTHENTICATED_ROLE)==false)roles.add(GeoServerRole.AUTHENTICATED_ROLE);
if(PreAuthenticatedUserNameRoleSource.RoleService.equals(roleSource))returngetRolesFromRoleService(principal);
if(PreAuthenticatedUserNameRoleSource.UserGroupService.equals(roleSource))returngetRolesFromUserGroupService(principal);
if(PreAuthenticatedUserNameRoleSource.Header.equals(roleSource))returngetRolesFromHttpAttribute(principal);thrownewRuntimeException("Nevershouldreachthispoint");
iftheprincipalisnotfound,an*emptycollectionisreturned**@paramprincipal*@throwsIOException*/protectedCollection<GeoServerRole>getRolesFromUserGroupService(Stringprincipal)throwsIOException{Collection<GeoServerRole>roles=newArrayList<GeoServerRole>();GeoServerUserGroupServiceservice=securityManager.loadUserGroupService(userGroupServiceName);UserDetailsdetails=null;try{details=service.loadUserByUsername(principal);
if(details!=null){for(GrantedAuthorityauth:details.getAuthorities())roles.add((GeoServerRole)auth);
ifnorolestringis*found,anemptycollectionisreturned**<p>Theresultcontainspersonalizedroles**@paramprincipal*@throwsIOException*/protectedCollection<GeoServerRole>getRolesFromHttpAttribute(Stringprincipal)throwsIOException{Collection<GeoServerRole>roles=newArrayList<GeoServerRole>();
if(request!=null){StringrolesString=request.getHeader(rolesHeaderAttribute);
if(rolesString==null||rolesString.trim().length()==0){LOGGER.log(Level.WARNING,"Norolesinheaderattribute:"+rolesHeaderAttribute);returnroles;
ifuserdidnot//provideadecentvalue.Thedefaultshouldfillupthe//tilewhenitshowsup.featuresPerTile=featureType.getMetadata().get("kml.regionateFeatureLimit",Integer.class);
if(featuresPerTile==null||featuresPerTile.intValue()<=1)featuresPerTile=64;//sanitycheck,thelayerisnotgeometryless
if(featureType.getFeatureType().getGeometryDescriptor()==null)thrownewServiceException(featureType.getName()+"isgeometryless,cannotgenerateKML!");//makesuretherequestiswithinthedatabounds,allowingfora//smallerrorReferencedEnveloperequestedEnvelope=context.getRenderingArea().transform(Tile.WGS84,true);LOGGER.log(Level.FINE,"Requestedtile:{0}",requestedEnvelope);dataEnvelope=featureType.getLatLonBoundingBox();//decidewhichtileweneedtoload/compute,andmakesure//it'savalidtilerequest,thatis,thatisdoesfitwith//thegeneraltilingscheme(minusaneventualsmallerror)Tiletile=newCachedTile(requestedEnvelope);ReferencedEnvelopetileEnvelope=tile.getEnvelope();
if(!envelopeMatch(tileEnvelope,requestedEnvelope))thrownewServiceException("Invalidboundingboxrequest,itdoesnotfit"+"thenearestregionatingtile.Requestedarea:"+requestedEnvelope+","+"nearesttile:"+tileEnvelope);//okidoki,let'scomputethefidsintherequestedtilefeaturesInTile=getFeaturesForTile(dataDir,tile);LOGGER.log(Level.FINE,"Found"+featuresInTile.size()+"featuresintile"+tile.toString());
if(featuresInTile.size()==0){thrownewHttpErrorCodeException(204);
else{FilterFactoryff=CommonFactoryFinder.getFilterFactory(null);Set<FeatureId>ids=newHashSet<FeatureId>();for(Stringfid:featuresInTile){ids.add(ff.featureId(fid));
if(geosearch.getType()==Type.DIRECTORY){Filedirectory=geosearch.dir();DeleteDbFiles.execute(directory.getCanonicalPath(),"h2cache_"+getDatabaseName(cfg),true);
ifthetwoenveloperoughlymatch,thatis,theyareaboutthesamesizeand*aboutthesamelocation.Themaxdifferenceallowedis{@link#MAX_ERROR},evaluatedasa*percentageofthewidthandheightoftheenvelope.Themethodassumesbothenvelopesarein*thesameCRS**@paramtileEnvelope*@paramexpectedEnvelope*/privatebooleanenvelopeMatch(ReferencedEnvelopetileEnvelope,ReferencedEnvelopeexpectedEnvelope){doublewidthRatio=Math.abs(1.0-tileEnvelope.getWidth()/expectedEnvelope.getWidth());doubleheightRatio=Math.abs(1.0-tileEnvelope.getHeight()/expectedEnvelope.getHeight());doublexRatio=Math.abs((tileEnvelope.getMinX()-expectedEnvelope.getMinX())/tileEnvelope.getWidth());doubleyRatio=Math.abs((tileEnvelope.getMinY()-expectedEnvelope.getMinY())/tileEnvelope.getHeight());returnwidthRatio<MAX_ERROR&&heightRatio<MAX_ERROR&&xRatio<MAX_ERROR&&yRatio<MAX_ERROR;
ifit'salreadytherethiswillfailst=conn.createStatement();st.execute("CREATETABLEIFNOTEXISTSTILECACHE("//+"xBIGINT,"//+"yBIGINT,"//+"zINT,"//+"fidvarchar(64))");st.execute("CREATEINDEXIFNOTEXISTSIDX_TILECACHEONTILECACHE(x,y,z)");
if(fids!=null){returnfids;
else{//buildthesynchronizationtokenStringtileKey=tableName+tile.x+"-"+tile.y+"-"+tile.z;canonicalizer.add(tileKey);tileKey=canonicalizer.get(tileKey);synchronized(tileKey){//mighthavebeenbuiltwhilewewerewaitingfids=readCachedTileFids(tile,conn);
if(fids!=null)returnfids;//stillmissing,weneedtocomputethemfids=computeFids(tile,conn);storeFids(tile,fids,conn);//optimization,
ifwedidnotmanagetofillupthistile,//theonesbelowitwillbeempty->markthemassuchright//away
if(fids.size()<featuresPerTile)for(Tilechild:tile.getChildren())storeFids(child,NO_FIDS,conn);
if(fids.size()==0){//wejusthavetomarkthetileasemptyps.setString(1,null);ps.execute();
else{//storeallthefidsconn.setAutoCommit(false);for(Stringfid:fids){ps.setString(1,fid);ps.execute();
if(!CRS.equalsIgnoreMetadata(Tile.WGS84,nativeCrs)){try{nativeTileEnvelope=tile.getEnvelope().transform(nativeCrs,true);
if(reduced.isNull()||reduced.getWidth()==0||reduced.getHeight()==0){//nooverlap,noparty,thetilewillbeemptyreturnCollections.emptySet();
ifeventhisfails,theuserhasevidentlysetupthe//geographicsboundsimproperlyReferencedEnveloperefRed=newReferencedEnvelope(reduced,tile.getEnvelope().getCoordinateReferenceSystem());nativeTileEnvelope=refRed.transform(nativeCrs,true);
else{nativeTileEnvelope=tile.getEnvelope();
ifthecrsisnotwgs84,we'llneedtotransformthepointMathTransformtx=null;double[]coords=newdouble[2];//scancountinghowmanyfidswe'vecollectedbooleanfirst=true;while(fi.hasNext()&&currFids.size()<featuresPerTile){//grabthefeature,skipit
ifit'salreadyinaparentelementSimpleFeaturef=(SimpleFeature)fi.next();
if(parentFids.contains(f.getID()))continue;//checktheneedforatransformation
if(first){first=false;CoordinateReferenceSystemnativeCRS=f.getType().getCoordinateReferenceSystem();featureType.getFeatureType().getCoordinateReferenceSystem();
if(nativeCRS!=null&&!CRS.equalsIgnoreMetadata(nativeCRS,Tile.WGS84)){tx=CRS.findMathTransform(nativeCRS,Tile.WGS84);
ifthefeaturesistobeincludedinthistilePointp=((Geometry)f.getDefaultGeometry()).getCentroid();coords[0]=p.getX();coords[1]=p.getY();
if(tx!=null)tx.transform(coords,0,coords,0,1);
if(tile.contains(coords[0],coords[1]))currFids.add(f.getID());
if(fi!=null)fi.close();
if(tile==null){returnCollections.emptySet();
if(parent!=null){fids.addAll(getUpwardFids(parent,conn));
ifthathappened,andinthiscasethereturnedsetwillbeempty*<li>thetilewasalreadycomputed,andwehavedata,thereturnedsestwillbenonempty*<li>thetileisnew,thedbcontainsnothing,inthiscasewereturn"null"*<ul>**@paramtileCoords*@paramconn*@throwsSQLException*/protectedSet<String>readCachedTileFids(Tiletile,Connectionconn)throwsSQLException{Set<String>fids=null;Statementst=null;ResultSetrs=null;try{st=conn.createStatement();rs=st.executeQuery("SELECTfidFROMTILECACHEwherex="+tile.x+"ANDy="+tile.y+"andz="+tile.z);//decidewhetherwehavetocollectthefidsorjustto//returnthatthetilewasempty
if(rs.next()){Stringfid=rs.getString(1);
if(fid==null){returnCollections.emptySet();
else{fids=newHashSet<String>();fids.add(fid);
if(super.contains(x,y)){returntrue;
elsecheck
ifweareonabordertileandthepoint//happenstositrightontheborderweusuallydon'tincludedoublemaxx=envelope.getMaxX();doublemaxy=envelope.getMaxY();
if(x==maxx&&x>=dataEnvelope.getMaxX()){returntrue;
if(y==maxy&&y>=dataEnvelope.getMaxY()){returntrue;
ifthistileis(oneof)therootofthecurrent*dataset*/publicTilegetParent(){
if(envelope.contains((BoundingBox)dataEnvelope)){returnnull;
else{Tileparent=super.getParent();
if(parent!=null){//wrapit,aswehavesomecustomlogicworkingagainstthedataenvelopehereparent=newCachedTile(super.getParent());
if(!(context.getService()instanceofWMSInfo)){returnnull;
if(Placemark.class.isAssignableFrom(featureClass)&&hasTimeTemplate(context)){returnnewPlacemarkTimeDecorator();
else{returnnull;
if(times!=null&&times.length>0){
if(times.length==1){TimeStampstamp=pm.createAndSetTimeStamp();stamp.setWhen(times[0]);
else{TimeSpanspan=pm.createAndSetTimeSpan();span.setBegin(times[0]);span.setEnd(times[1]);
if(output!=null){output=output.trim();
if(output==null||"".equals(output)){returnnewString[]{};
if(output.endsWith("||")){timespan=newString[]{timespan[0],null};
if(timespan.length>2){Stringmsg="Incorrecttimesyntax.Shouldbe:<date>||<date>";thrownewIllegalArgumentException(msg);
if(timespan.length>1){//caseofopenendedtimespan
if(timespan[0]==null||"".equals(timespan[0].trim())){timespan[0]=null;
if(timespan[1]==null||"".equals(timespan[1].trim())){timespan[1]=null;
if(timespan[i]!=null){Dated=parseDateTime(timespan[i]);timespan[i]=encodeDateTime(d);
if(date!=null){Calendarc=Calendar.getInstance();c.setTime(date);returnnewXSDateTimeBinding().encode(c,null);
else{returnnull;
if(d==null){//thentryasdated=parseDate(dformats,date);
if(d==null){//tryastimed=parseDate(tformats,date);
if(d==null){//lastditcheffort,trytoparseasxmldatestry{//tryasxmldatetimed=DateUtil.deserializeDateTime(date);
if(d!=null){returnd;
if(d!=null){returnd;
if(association.getValue()==null){//nonresolveed,returnthexlink:href
if(XLINK.HREF.equals(name)){Stringid=(String)association.getUserData().get("gml:id");return"#"+id;
if(association.getValue()!=null){//associatedvaluewasresolved,returnitObjectassociated=association.getValue();//checkforfeature
if(associatedinstanceofSimpleFeature){SimpleFeaturefeature=(SimpleFeature)associated;NametypeName=feature.getType().getName();QNamename=newQName(typeName.getNamespaceURI(),typeName.getLocalPart());Listproperties=newArrayList();//returnacommentwhichishtexlinkhrefproperties.add(newObject[]{Encoder.COMMENT,"#"+feature.getID()});//firstreturnthefeatureproperties.add(newObject[]{name,feature});returnproperties;
if(idxOpen==-1){throwInvalidSyntaxException(null);
if(idxClosed==-1||(idxNextOpen>0&&idxClosed>idxNextOpen)){throwInvalidSyntaxException(null);
if(idxSeparator==-1){
if(idxClosed==spec.length()-1){returnresults;
else{throwInvalidSyntaxException(null);
else{
if(idxSeparator>idxNextClosed){throwInvalidSyntaxException(null);
if(SecurityContextHolder.getContext().getAuthentication()==null){doAuthenticate((HttpServletRequest)request,(HttpServletResponse)response);AuthenticationpostAuthentication=SecurityContextHolder.getContext().getAuthentication();
if(postAuthentication!=null&&cacheKey!=null){
if(cacheAuthentication(postAuthentication,(HttpServletRequest)request)){getSecurityManager().getAuthenticationCache().put(getName(),cacheKey,postAuthentication);
if(m.find()&&m.groupCount()==1){Stringres=m.group(1);returnres;
else{returnnull;
if(usHeader==null||pwHeader==null){return;
if(us==null||pw==null){return;
if(decodeURI){us=java.net.URLDecoder.decode(us,"UTF-8");pw=java.net.URLDecoder.decode(pw,"UTF-8");
if(!roles.contains(GeoServerRole.AUTHENTICATED_ROLE)){roles.add(GeoServerRole.AUTHENTICATED_ROLE);
if(usHeader==null||pwHeader==null){returnnull;
if(username==null&&password==null){returnnull;
if(decodeURI){try{username=java.net.URLDecoder.decode(username,"UTF-8");
ifnoHTTPsessionisavailable
if(request.getSession(false)!=null)returnfalse;returntrue;}}
if(valueinstanceofPoint){encoder.encode(value,GML.Point,output);
else
if(valueinstanceofMultiPoint){encoder.encode(value,GML.MultiPoint,output);
else
if(valueinstanceofLineString){encoder.encode(value,GML.LineString,output);
else
if(valueinstanceofMultiLineString){encoder.encode(value,GML.MultiLineString,output);
else
if(valueinstanceofPolygon){encoder.encode(value,GML.Polygon,output);
else
if(valueinstanceofMultiPolygon){encoder.encode(value,GML.MultiPolygon,output);
else{thrownewWFSException("Cannotencodegeometryoftype:"+value.getClass());
if(id==null){returnsuper.getMessage();
if(colors==null)thrownewException("Classnumnotsetted,colorrampnull");returncolors;
if(isSeedingRequest){GeoServerTileLayer.WEB_MAP.set(map);//returningnullmakestheDispatcherignorefurtherprocessingtherequestreturnnull;
if(authKeyMapperName!=null){AuthenticationKeyMappermapper=(AuthenticationKeyMapper)GeoServerExtensions.bean(authKeyMapperName);
if(mapper!=null){returnmapper.getMapperConfiguration();
elsesimilarlyevil.*<p>*Anyway,thiscodeiscompletelyinJavaandwillrunonall*JDK1.1-compliantsystemswithoutmodificationoraneedforadditional*libraries.Allclassesthatarerequiredoncertainplatformstoallow*thistorunaredynamicallyloadedatruntimeviareflectionand,
ifnot*found,willnotcausethistodoanythingotherthanreturninganerror*whenopeningthebrowser.*<p>*Therearecertainsystemrequirementsforthisclass,asit'srunning*throughRuntime.exec(),whichisJava'swayofmakinganativesystemcall.*Currently,thisrequiresthataMacintoshhaveaFinderwhichsupportsthe*GURLevent,whichistrueforMacOS8.0and8.1systemsthathavethe*InternetScriptingAppleScriptdictionaryinstalledintheScripting*AdditionsfolderintheExtensionsfolder(whichisinstalledbydefault*asfarasIknowunderMacOS8.0and8.1),andforallMacOS8.5and*latersystems.OnWindows,itonlyrunsunderWin32systems(Windows95,*98,andNT4.0,aswellaslaterversionsofall).Onothersystems,this*dropsbackfromtheinherentlyplatform-sensitiveconceptofadefault*browserandsimplyattemptstolaunchNetscapeviaashellcommand.*<p>*ThiscodeisCopyright1999-2001byEricAlbert(ejalbert@cs.stanford.edu)*andmayberedistributedormodifiedinanyformwithoutrestrictionsas*longastheportionofthiscommentfromthisparagraphthroughtheendof*thecommentisnotremoved.Theauthorrequeststhathebenotifiedof*anyapplication,applet,orotherbinarythatmakesuseofthiscode,but*that'smoreoutofcuriositythananythingandisnotrequired.This*softwareincludesnowarranty.Theauthorisnotrepsonsibleforanyloss*ofdataorfunctionalityoranyadverseorunexpectedeffectsofusing*thissoftware.*<p>*Credits:*<br>StevenSpencer,JavaWorldmagazine*(<ahref="http://www.javaworld.com/javaworld/javatips/jw-javatip66.html">*JavaTip66</a>)*<br>ThanksalsotoRonB.Yeh,EricShapiro,BenEngber,PaulTeitlebaum,*AndreaCantatore,*LarryBarowski,TrevorBedzek,FrankMiedrich,andRonRabakukk**@authorEricAlbert(<ahref="mailto:ejalbert@cs.stanford.edu">*ejalbert@cs.stanford.edu</a>)*@version1.4b1(ReleasedJune20,2001)**@author<ahref="mailto:jacob.dreyer@geosoft.no">JacobDreyer</a>*AddedmethodstotheAPIandadjustedthelinuxversionslightly.*/publicclassBrowser{/***TheJavavirtualmachinethatwearerunningon.Actually,inmostcases*weonlycareabouttheoperatingsystem,butsomeoperatingsystems*requireusto
switchontheVM.*/privatestaticintjvm;/**Thebrowserforthesystem*/privatestaticObjectbrowser;/***Cacheswhetheranyclasses,methods,andfieldsthatarenotpartofthe*JDKandneedtobedynamicallyloadedatruntimeloadedsuccessfully.*<p>*Notethat
ifthisis<code>false</code>,<code>openURL()</code>will*alwaysreturnanIOException.*/privatestaticbooleanloadedWithoutErrors;/**Thecom.apple.mrj.MRJFileUtilsclass*/privatestaticClassmrjFileUtilsClass;/**Thecom.apple.mrj.MRJOSTypeclass*/privatestaticClassmrjOSTypeClass;/**Thecom.apple.MacOS.AEDescclass*/privatestaticClassaeDescClass;/**The<init>(int)methodofcom.apple.MacOS.AETarget*/privatestaticConstructoraeTargetConstructor;/**The<init>(int,int,int)methodofcom.apple.MacOS.AppleEvent*/privatestaticConstructorappleEventConstructor;/**The<init>(String)methodofcom.apple.MacOS.AEDesc*/privatestaticConstructoraeDescConstructor;/**ThefindFoldermethodofcom.apple.mrj.MRJFileUtils*/privatestaticMethodfindFolder;/**ThegetFileCreatormethodofcom.apple.mrj.MRJFileUtils*/privatestaticMethodgetFileCreator;/**ThegetFileTypemethodofcom.apple.mrj.MRJFileUtils*/privatestaticMethodgetFileType;/**TheopenURLmethodofcom.apple.mrj.MRJFileUtils*/privatestaticMethodopenURL;/**ThemakeOSTypemethodofcom.apple.MacOS.OSUtils*/privatestaticMethodmakeOSType;/**TheputParametermethodofcom.apple.MacOS.AppleEvent*/privatestaticMethodputParameter;/**ThesendNoReplymethodofcom.apple.MacOS.AppleEvent*/privatestaticMethodsendNoReply;/**ActuallyanMRJOSTypepointingtotheSystemFolderonaMacintosh*/privatestaticObjectkSystemFolderType;/**ThekeyDirectObjectAppleEventparametertype*/privatestaticIntegerkeyDirectObject;/**ThekAutoGenerateReturnIDAppleEventcode*/privatestaticIntegerkAutoGenerateReturnID;/**ThekAnyTransactionIDAppleEventcode*/privatestaticIntegerkAnyTransactionID;/**ThelinkageobjectrequiredforJDirect3onMacOSX.*/privatestaticObjectlinkage;/**TheframeworktoreferenceonMacOSX*/privatestaticfinalStringJDirect_MacOSX="/System/Library/Frameworks/Carbon.framework/Frameworks/HIToolbox.framework/HIToolbox";/**JVMconstantforMRJ2.0*/privatestaticfinalintMRJ_2_0=0;/**JVMconstantforMRJ2.1orlater*/privatestaticfinalintMRJ_2_1=1;/**JVMconstantforJavaonMacOSX10.0(MRJ3.0)*/privatestaticfinalintMRJ_3_0=3;/**JVMconstantforMRJ3.1*/privatestaticfinalintMRJ_3_1=4;/**JVMconstantforanyWindowsNTJVM*/privatestaticfinalintWINDOWS_NT=5;/**JVMconstantforanyWindows9xJVM*/privatestaticfinalintWINDOWS_9x=6;/**JVMconstantforanyotherplatform*/privatestaticfinalintOTHER=-1;/***ThefiletypeoftheFinderonaMacintosh.Hardcoding"Finder"would*keepnon-U.S.Englishsystemsfromworkingproperly.*/privatestaticfinalStringFINDER_TYPE="FNDR";/***ThecreatorcodeoftheFinderonaMacintosh,whichisneededtosend*AppleEventstotheapplication.*/privatestaticfinalStringFINDER_CREATOR="MACS";/**ThenamefortheAppleEventtypecorrespondingtoaGetURLevent.*/privatestaticfinalStringGURL_EVENT="GURL";/***ThefirstparameterthatneedstobepassedintoRuntime.exec()toopen*thedefaultwebbrowseronWindows.*/privatestaticfinalStringFIRST_WINDOWS_PARAMETER="/c";/**ThesecondparameterforRuntime.exec()onWindows.*/privatestaticfinalStringSECOND_WINDOWS_PARAMETER="start";/***ThethirdparameterforRuntime.exec()onWindows.Thisisa"title"*parameterthatthecommandlineexpects.Settingthisparameterallows*URLscontainingspacestowork.*/privatestaticfinalStringTHIRD_WINDOWS_PARAMETER="\"\"";/***TheshellparametersforNetscapethatopensagivenURLinan*already-opencopyofNetscapeonmanycommand-linesystems.*/privatestaticfinalStringNETSCAPE_REMOTE_PARAMETER="-remote";privatestaticfinalStringNETSCAPE_OPEN_PARAMETER_START="openURL(";privatestaticfinalStringNETSCAPE_OPEN_PARAMETER_END=")";/***Themessagefromanyexceptionthrownthroughouttheinitialization*process.*/privatestaticStringerrorMessage;/***Aninitializationblockthatdeterminestheoperatingsystemandloads*thenecessaryruntimedata.*/static{loadedWithoutErrors=true;StringosName=System.getProperty("os.name");
if(osName.startsWith("MacOS")){//JD:OracleJDK's>=7don'tseemtosetmrj.versionanymore,just//assuminglatestjvm=MRJ_3_1;//StringmrjVersion=System.getProperty("mrj.version");//StringmajorMRJVersion=mrjVersion.substring(0,3);//try{//doubleversion=Double.valueOf(majorMRJVersion).doubleValue();//
if(version==2){//jvm=MRJ_2_0;//
else
if(version>=2.1&&version<3){////Assumethatall2.xversionsofMRJworkthesame.////MRJ2.1actuallyworksviaRuntime.exec()and2.2supportsthat////buthasanopenURL()methodaswellthatwecurrentlyignore.//jvm=MRJ_2_1;//
else
if(version==3.0){//jvm=MRJ_3_0;//
else
if(version>=3.1){////Assumethatall3.1andlaterversionsofMRJworkthesame.//jvm=MRJ_3_1;//
else{//loadedWithoutErrors=false;//errorMessage="UnsupportedMRJversion:"+version;//
else
if(osName.startsWith("Windows")){
if(osName.indexOf("9")!=-1){jvm=WINDOWS_9x;
else{jvm=WINDOWS_NT;
else{jvm=OTHER;
if(loadedWithoutErrors){//
ifwehaven'thitanyerrorsyetloadedWithoutErrors=loadClasses();
ifallintializationsucceeded*<code>false</code>
ifanyportionoftheinitializationfailed*/privatestaticbooleanloadClasses(){
switch(jvm){caseMRJ_2_0:try{ClassaeTargetClass=Class.forName("com.apple.MacOS.AETarget");ClassosUtilsClass=Class.forName("com.apple.MacOS.OSUtils");ClassappleEventClass=Class.forName("com.apple.MacOS.AppleEvent");ClassaeClass=Class.forName("com.apple.MacOS.ae");aeDescClass=Class.forName("com.apple.MacOS.AEDesc");aeTargetConstructor=aeTargetClass.getDeclaredConstructor(newClass[]{int.class});appleEventConstructor=appleEventClass.getDeclaredConstructor(newClass[]{int.class,int.class,aeTargetClass,int.class,int.class});aeDescConstructor=aeDescClass.getDeclaredConstructor(newClass[]{String.class});makeOSType=osUtilsClass.getDeclaredMethod("makeOSType",newClass[]{String.class});putParameter=appleEventClass.getDeclaredMethod("putParameter",newClass[]{int.class,aeDescClass});sendNoReply=appleEventClass.getDeclaredMethod("sendNoReply",newClass[]{});FieldkeyDirectObjectField=aeClass.getDeclaredField("keyDirectObject");keyDirectObject=(Integer)keyDirectObjectField.get(null);FieldautoGenerateReturnIDField=appleEventClass.getDeclaredField("kAutoGenerateReturnID");kAutoGenerateReturnID=(Integer)autoGenerateReturnIDField.get(null);FieldanyTransactionIDField=appleEventClass.getDeclaredField("kAnyTransactionID");kAnyTransactionID=(Integer)anyTransactionIDField.get(null);
if(browser!=null){returnbrowser;
switch(jvm){caseMRJ_2_0:try{IntegerfinderCreatorCode=(Integer)makeOSType.invoke(null,newObject[]{FINDER_CREATOR});ObjectaeTarget=aeTargetConstructor.newInstance(newObject[]{finderCreatorCode});IntegergurlType=(Integer)makeOSType.invoke(null,newObject[]{GURL_EVENT});ObjectappleEvent=appleEventConstructor.newInstance(newObject[]{gurlType,gurlType,aeTarget,kAutoGenerateReturnID,kAnyTransactionID});//Don'tsetbrowser=appleEventbecausethenthenexttimewecall//locateBrowser(),we'llgetthesameAppleEvent,towhichwe'll//alreadyhaveaddedtherelevantparameter.Instead,regenerate//theAppleEventeverytime.There'sprobablyawaytodothis//better;
ifanyhasanyideas,pleaseletmeknow.returnappleEvent;
if(!file.isFile()){continue;
if(FINDER_TYPE.equals(fileType.toString())){ObjectfileCreator=getFileCreator.invoke(null,newObject[]{file});
if(FINDER_CREATOR.equals(fileCreator.toString())){//ActuallytheFinder,butthat'sOKbrowser=file.toString();returnbrowser;
if(!loadedWithoutErrors){thrownewIOException("Exceptioninfindingbrowser:"+errorMessage);
if(browser==null){thrownewIOException("Unabletolocatebrowser:"+errorMessage);
switch(jvm){caseMRJ_2_0:ObjectaeDesc=null;try{aeDesc=aeDescConstructor.newInstance(newObject[]{url});putParameter.invoke(browser,newObject[]{keyDirectObject,aeDesc});sendNoReply.invoke(browser,newObject[]{});
ifitwascreatedbrowser=null;//Ditto
if(result==0){int[]selectionStart=newint[]{0};byte[]urlBytes=url.getBytes();int[]selectionEnd=newint[]{urlBytes.length};result=ICLaunchURL(instance[0],newbyte[]{0},urlBytes,urlBytes.length,selectionStart,selectionEnd);
if(result==0){//Ignorethereturnvalue;theURLwaslaunchedsuccessfully//regardlessofwhathappenshere.ICStop(instance);
else{thrownewIOException("UnabletolaunchURL:"+result);
else{thrownewIOException("UnabletocreateanInternetConfiginstance:"+result);
if(exitCode!=0){//
ifNetscapewasnotopenRuntime.getRuntime().exec(newString[]{(String)browser,url});
ifitdoes,we'lltrythesimplest//thingpossibleRuntime.getRuntime().exec(newString[]{(String)browser,url});break;
if(encoder!=null){encoder.write();encoder.close();break;
if(!deleted){LOGGER.warning("Couldnotdeletetempfile:"+tempFile.getAbsolutePath());
if(sourceCoverage==null){thrownewIllegalStateException(newStringBuffer("Itseemsprepare()hasnotbeencalled").append("orhasnotsucceed").toString());
if(!(sourceCoverageinstanceofGranuleStack)){thrownewIllegalArgumentException("NetCDFencodingonlysupportsgranuleStackcoverages");
if(file.exists()){finalInputStreamin=newFileInputStream(file);intc;try{while(-1!=(c=in.read(buffer))){output.write(buffer,0,c);
if(fileName!=null){returnfileName;
if(pf!=null){result.add(pf);
if(pf==null){returnnull;
if(filters!=null){for(ProcessFilterfilter:filters){pf=filter.filterFactory(pf);
if(pf==null){break;
if(applyFilters){pf=applyFilters(pf);
if(pf!=null&&!pf.getNames().contains(name)){pf=null;
ifnotfound*/publicstaticProcesscreateProcess(Namename){ProcessFactoryfactory=createProcessFactory(name,false);
if(factory==null)returnnull;returnfactory.create(name);
if(factoryClass.equals(pf.getClass())){
if(!applyFilters){returnpf;
else{//scanfiltersandletthemwrapasnecessarypf=applyFilters(pf);returnpf;
if(instanceVal!=null&&instanceVal.trim().length()>0){urlb.append(instanceVal);
iftheStoreInfois*new,oranoneditabletextbox
ifwe'reeditinganexistingStoreInfo*/privateFormComponent<String>addTableNameComponent(finalIModel<Map<String,Object>>paramsModel,finalbooleanisNew){finalFormComponent<String>tableNameComponent;finalStringpanelId="tableNamePanel";
if(isNew){RasterTableSelectionPanelselectionPanel;selectionPanel=newRasterTableSelectionPanel(panelId,paramsModel,storeEditForm,server,port,instance,user,password);add(selectionPanel);DropDownChoice<String>tableDropDown=selectionPanel.getFormComponent();tableNameComponent=tableDropDown;
else{/**We'reeditinganexistingstore.Don'tallowtochangethetablename,itcouldbe*catastrophicfortheCatalog/ResourcePoolasabilitytogettothecoverageisreally*basedontheStore'sURLandtheCoverageInfoistiedtoit*/finalIModel<String>paramValue=newMapModel<String>(paramsModel,TABLE_NAME);finalStringresourceKey=RESOURCE_KEY_PREFIX+"."+TABLE_NAME;finalIModel<String>paramLabelModel=newResourceModel(resourceKey,TABLE_NAME);finalbooleanrequired=true;TextParamPanel<String>tableNamePanel;tableNamePanel=newTextParamPanel<String>(panelId,paramValue,paramLabelModel,required);add(tableNamePanel);tableNameComponent=tableNamePanel.getFormComponent();tableNameComponent.setEnabled(false);finalStringtitleKey=resourceKey+".title";ResourceModeltitleModel=newResourceModel(titleKey);Stringtitle=String.valueOf(titleModel.getObject());tableNamePanel.add(AttributeModifier.replace("title",title));
if(store.getId().equals(storeId)){Map<String,String>connParams=parseConnectionParameters(store);server.setModelObject(connParams.get(SERVER_NAME_PARAM_NAME));port.setModelObject(connParams.get(PORT_NUMBER_PARAM_NAME));instance.setModelObject(connParams.get(INSTANCE_NAME_PARAM_NAME));user.setModelObject(connParams.get(USER_NAME_PARAM_NAME));password.setModelObject(connParams.get(PASSWORD_PARAM_NAME));target.add(server);target.add(port);target.add(instance);target.add(user);target.add(password);break;
if(arcsdeCoverageType.equals(type)||arcsdeVectorType.equals(type)){continue;
else{it.remove();
if(o1.getWorkspace().equals(o2.getWorkspace())){returnString.CASE_INSENSITIVE_ORDER.compare(o1.getName(),o2.getName());
if(storeInfoinstanceofCoverageStoreInfo){Stringurl=((CoverageStoreInfo)storeInfo).getURL();
if(null!=url&&url.startsWith("sde:")){ArcSDEConnectionConfigconnectionConfig;connectionConfig=ArcSDERasterFormat.sdeURLToConnectionConfig(newStringBuffer(url));params.put(SERVER_NAME_PARAM_NAME,connectionConfig.getServerName());params.put(PORT_NUMBER_PARAM_NAME,connectionConfig.getPortNumber().toString());params.put(INSTANCE_NAME_PARAM_NAME,connectionConfig.getDatabaseName());params.put(USER_NAME_PARAM_NAME,connectionConfig.getUserName());params.put(PASSWORD_PARAM_NAME,connectionConfig.getPassword());//parsetablenameintidx=url.lastIndexOf('#');
if(idx>0){StringtableName=url.substring(idx+1);params.put(RasterTableSelectionPanel.TABLE_NAME,tableName);
else{params.put(PORT_NUMBER_PARAM_NAME,"5151");
else{Map<String,Serializable>storeParams=((DataStoreInfo)storeInfo).getConnectionParameters();params.put(SERVER_NAME_PARAM_NAME,(String)storeParams.get(SERVER_NAME_PARAM_NAME));params.put(PORT_NUMBER_PARAM_NAME,String.valueOf(storeParams.get(PORT_NUMBER_PARAM_NAME)));params.put(INSTANCE_NAME_PARAM_NAME,(String)storeParams.get(INSTANCE_NAME_PARAM_NAME));params.put(USER_NAME_PARAM_NAME,(String)storeParams.get(USER_NAME_PARAM_NAME));params.put(PASSWORD_PARAM_NAME,(String)storeParams.get(PASSWORD_PARAM_NAME));
if(filter.getExpression1()instanceofPropertyName){propertyName=((PropertyName)filter.getExpression1()).getPropertyName();
else
if(filter.getExpression2()instanceofPropertyName){propertyName=((PropertyName)filter.getExpression2()).getPropertyName();
if(propertyName!=null){PropertyNamepropertyAtt=ff.property(propertyName,nsContext);filter=ff.bbox(propertyAtt,filter.getBounds());
ifthefinallistexceedsmaxTimes**@parammaxTimesMaximumnumberoftimestoparse,oranonpositivenumbertohavenolimit*/publicTimeParser(intmaxTimes){this.maxTimes=maxTimes;
ifthestringcannotbeparsed.*/@SuppressWarnings({"unchecked","rawtypes"})publicCollectionparse(Stringvalue)throwsParseException{
if(value==null){returnCollections.emptyList();
if(value.length()==0){returnCollections.emptyList();
if(o1==o2){return0;
if(o1Date){finalDatedateLeft=(Date)o1;
if(o2Date){//o2datereturndateLeft.compareTo((Date)o2);
if(o2Date){//o2datereturnleft.getMinValue().compareTo(((Date)o2));
if(date.indexOf("/")<=0){Objecto=getFuzzyDate(date);
if(oinstanceofDate){addDate(result,(Date)o);
else{addPeriod(result,(DateRange)o);
else{//periodString[]period=date.split("/");////Periodlikeoneofthefollowing://yyyy-MM-ddTHH:mm:ssZ/yyyy-MM-ddTHH:mm:ssZ/P1D//MaybeoneofthefollowingpossibleISO8601TimeIntervalformatswithtrailing//periodfor//breakingtheintervalbygivenperiod://TIME/TIME/PERIOD//DURATION/TIME/PERIOD//TIME/DURATION/PERIOD//
if(period.length==3){Date[]range=parseTimeDuration(period);finallongmillisIncrement=parsePeriod(period[2]);finallongstartTime=range[0].getTime();finallongendTime=range[1].getTime();longtime;intj=0;while((time=j*millisIncrement+startTime)<=endTime){finalCalendarcalendar=newGregorianCalendar(UTC_TZ);calendar.setTimeInMillis(time);addDate(result,calendar.getTime());j++;checkMaxTimes(result,maxValues);
else
if(period.length==2){Date[]range=parseTimeDuration(period);addPeriod(result,newDateRange(range[0],range[1]));
else{thrownewParseException("Invalidtimeperiod:"+Arrays.toString(period),0);
if(maxTimes!=null){returnmaxTimes;
else{returnDEFAULT_MAX_ELEMENTS_TIMES_KVP;
if(maxValues>0&&result.size()>maxValues){thrownewServiceException("Morethan"+maxValues+"timesspecifiedintherequest,bailingout.",ServiceException.INVALID_PARAMETER_VALUE,"time");
if(period.length==2||period.length==3){Datebegin=null;Dateend=null;//Checkfirsttosee
ifwehaveanydurationvaluewithinTIMEparameter
if(period[0].toUpperCase().startsWith("P")||period[1].toUpperCase().startsWith("P")){longdurationOffset=Long.MIN_VALUE;//Attempttoparseatimeordurationfromthefirstportionofthe
if(period[0].toUpperCase().startsWith("P")){durationOffset=parsePeriod(period[0]);
else{begin=beginning(getFuzzyDate(period[0]));
if(period[1].toUpperCase().startsWith("P")&&!period[1].toUpperCase().startsWith("PRESENT")){//Invalidtimeperiodoftheformat://DURATION/DURATION[/PERIOD]
if(durationOffset!=Long.MIN_VALUE){thrownewParseException("Invalidtimeperiodcontainingdurationwithnopairedtimevalue:"+Arrays.toString(period),0);
else{durationOffset=parsePeriod(period[1]);finalCalendarcalendar=newGregorianCalendar();calendar.setTimeInMillis(begin.getTime()+durationOffset);end=calendar.getTime();
else{end=end(getFuzzyDate(period[1]));finalCalendarcalendar=newGregorianCalendar();calendar.setTimeInMillis(end.getTime()-durationOffset);begin=calendar.getTime();
else{begin=beginning(getFuzzyDate(period[0]));end=end(getFuzzyDate(period[1]));
if(dateOrDateRangeinstanceofDateRange){return((DateRange)dateOrDateRange).getMinValue();
else{return(Date)dateOrDateRange;
if(dateOrDateRangeinstanceofDateRange){return((DateRange)dateOrDateRange).getMaxValue();
else{return(Date)dateOrDateRange;
if(elementinstanceofDate){//convertfinalDatelocal=(Date)element;
if(newRange.contains(local)){it.remove();
else{//convertfinalDateRangelocal=(DateRange)element;
if(local.contains(newRange))return;
if(newRange.contains(local))it.remove();
if(elementinstanceofDate){
if(newDate.equals(element))return;
else
if(((DateRange)element).contains(newDate)){return;
ifthestringcannotbeparsed.*/staticObjectgetFuzzyDate(finalStringvalue)throwsParseException{StringcomputedValue=value;//specialhandlingforcurrentkeyword(weacceptbothwmsandwcsways)
if(computedValue.equalsIgnoreCase("current")||computedValue.equalsIgnoreCase("now")){returnnull;
if(computedValue.equalsIgnoreCase("present")){Calendarnow=Calendar.getInstance();now.set(Calendar.MILLISECOND,0);computedValue=FormatAndPrecision.MILLISECOND.getFormat().format(now.getTime());
if(pos.getIndex()==computedValue.length()){DateRangerange=f.expand(time);
if(range.getMinValue().equals(range.getMaxValue())){returnrange.getMinValue();
else{returnrange;
ifthestringcannotbeparsed.*/publicstaticlongparsePeriod(finalStringperiod)throwsParseException{finalintlength=period.length();
if(length!=0&&Character.toUpperCase(period.charAt(0))!='P'){thrownewParseException("Invalidperiodincrementgiven:"+period,0);
if(letter=='T'){time=true;
if(++lower>=length){break;
if(++upper>=length){thrownewParseException("Missingsymbolin\""+period+"\".",lower);
if(time){
switch(letter){case'S':factor=1000;break;case'M':factor=60*1000;break;case'H':factor=60*60*1000;break;default:thrownewParseException("Unknowntimesymbol:"+letter,upper);
else{
switch(letter){case'D':factor=MILLIS_IN_DAY;break;case'W':factor=7*MILLIS_IN_DAY;break;//TODO:handlemonthsinabetterwaythanjusttakingtheaveragelength.case'M':factor=30*MILLIS_IN_DAY;break;case'Y':factor=365.25*MILLIS_IN_DAY;break;default:thrownewParseException("Unknownperiodsymbol:"+letter,upper);
ifadminDropDownChoiceworkspace=(DropDownChoice)tester.getComponentFromLastRenderedPage("styleForm:context:panel:workspace");assertTrue(workspace.isEnabled());assertFalse(workspace.isNullValid());assertNotNull(workspace.getModelObject());
ifadminDropDownChoiceworkspace=(DropDownChoice)tester.getComponentFromLastRenderedPage("styleForm:context:panel:workspace");assertTrue(workspace.isEnabled());assertTrue(workspace.isNullValid());assertNull(workspace.getModelObject());
ifadminDropDownChoiceworkspace=(DropDownChoice)tester.getComponentFromLastRenderedPage("styleForm:context:panel:workspace");assertFalse(workspace.isEnabled());assertFalse(workspace.isNullValid());assertNotNull(workspace.getModelObject());
ifadminDropDownChoiceworkspace=(DropDownChoice)tester.getComponentFromLastRenderedPage("styleForm:context:panel:workspace");assertTrue(workspace.isEnabled());assertTrue(workspace.isNullValid());assertNotNull(workspace.getModelObject());}}
if(kvp.containsKey("storedQuery_id")){//wegetitbackasalistofuriList<URI>list=(List<URI>)kvp.get("storedQuery_id");EMFUtils.set(obj,"id",list.get(0).toString());
ifwecanrunthetestsAssume.assumeTrue(Ogr2OgrTestUtil.isOgrAvailable());//thedatasourcewe'lluseforthetestsdataStore=newPropertyDataStore(newFile("./src/test/java/org/geoserver/wfs/response"));//theoutputformat(andlet'saddafewoutputformatstoplaywithogr=newOgr2OgrOutputFormat(newGeoServerImpl(),newOGRWrapperFactory());ogr.addFormat(newOgrFormat("KML","OGR-KML",".kml",true,"application/vnd.google-earth.kml"));ogr.addFormat(newOgrFormat("KML","OGR-KML-ZIP",".kml",false,"application/vnd.google-earth.kml"));ogr.addFormat(newOgrFormat("CSV","OGR-CSV",".csv",true,"text/csv"));ogr.addFormat(newOgrFormat("SHP","OGR-SHP",".shp",false,null));ogr.addFormat(newOgrFormat("MapInfoFile","OGR-MIF",".mif",false,null,"-dsco","FORMAT=MIF"));ogr.setExecutable(Ogr2OgrTestUtil.getOgr2Ogr());ogr.setEnvironment(Collections.singletonMap("GDAL_DATA",Ogr2OgrTestUtil.getGdalData()));//theEMFobjectsusedtotalkwiththeoutputformatgft=WfsFactory.eINSTANCE.createGetFeatureType();fct=WfsFactory.eINSTANCE.createFeatureCollectionType();op=newOperation("GetFeature",newService("WFS",null,newVersion("1.0.0"),Arrays.asList("GetFeature")),null,newObject[]{gft});
ifoneoftheexpectedlinesisthereassertTrue(csv.contains("Alessia"));
if(!url.startsWith(MOCKSERVER)){thrownewIllegalArgumentException("TheURLmuststartwith"+MOCKSERVER);
if(!url.startsWith(MOCKSERVER)){thrownewIllegalArgumentException("Theurl"+url+"doesnotstartwith"+MOCKSERVER);
if(!TEST_MODE){thrownewIllegalArgumentException("Theproviderisnotintestmodenow");
if(httpClient==null){thrownewIllegalArgumentException("Themockurl"+url+"isnotbound"+"toanymockhttpclient,currentbindingsaretowards:"+CLIENTS.keySet());
ifanybindingisassociatedintothemockserver*/publicstaticbooleantestModeEnabled(){returnTEST_MODE;
if(ctx!=null){try{ctx.close();
if(map.containsKey(USERNAME_KEY)){returnnewUsernamePasswordAuthenticationToken(map.get(USERNAME_KEY),"N/A",null);
if*notprovided.LOOKATBBOXandLOOKATGEOMaremutuallyexclusive,andLOOKATBBOXtakesprecedence*overLOOKATGEOM.**<p>BothLOOKATBBOXandLOOKATGEOMallowtodefinetheareawheretheKMLlookAtshouldbe*pointingat.Ifnoneisprovided,GeoServerwillusetheaggregatedlatlonboundingboxofall*therequestedlayersasitnormallydoes.**@authorGabrielRoldan*/publicclassLookAtOptions{privatestaticfinalLoggerLOGGER=Logging.getLogger(LookAtOptions.class);privatestaticfinalGeometryFactorygfac=newGeometryFactory();privatestaticfinalStringKEY_BBOX="LOOKATBBOX";privatestaticfinalStringKEY_LOOKAT="LOOKATGEOM";privatestaticfinalStringKEY_ALTITUDE="ALTITUDE";privatestaticfinalStringKEY_HEADING="HEADING";privatestaticfinalStringKEY_TILT="TILT";privatestaticfinalStringKEY_RANGE="RANGE";privatestaticfinalStringKEY_ALTITUDEMODE="ALTITUDEMODE";privateGeometrylookAt;privateDoublealtitude;privateDoubleheading;privateDoubletilt;privateDoublerange;privateAltitudeModealtitudeMode;@SuppressWarnings("unchecked")publicLookAtOptions(){this(Collections.EMPTY_MAP);
if(this.lookAt==null){this.lookAt=parseLookAt(options.get(KEY_LOOKAT));
if(null!=object){Envelopeenv;try{BBoxKvpParserparser=newBBoxKvpParser();env=(Envelope)parser.parse(String.valueOf(object));bbox=JTS.toGeometry(env);
if(object!=null){StringgeomWKT=String.valueOf(object);try{WKTReader2reader=newWKTReader2(gfac);geom=reader.read(geomWKT);
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("Errorparsing"+KEY_LOOKAT+"KMLformatoption:"+e.getMessage()+".ArgumentWKT:'"+geomWKT+"'");
if(object!=null){try{parsed=Double.valueOf(String.valueOf(object));
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("NotanumberinKMLformatoptions:'"+object+"'");
if(object!=null){try{mode=AltitudeMode.fromValue(String.valueOf(object));
if(LOGGER.isLoggable(Level.INFO)){LOGGER.info("IllegalvalueforKMLformatoption'altitudeMode':'"+object+"'.Expectedoneof"+AltitudeMode.values());
if(behavior!=null)//rec.add(behavior);*///returnrec;//
if(choicesModelinstanceofRuleRolesModel)add(newLabel("roles",newStringResourceModel("roles",this)));
elseadd(newLabel("roles",newStringResourceModel("rolesFromActiveService",this).setParameters(roleServiceName)));add(newSubmitLink("addRole"){@OverridepublicvoidonSubmit(){setResponsePage(newNewRolePage(roleServiceName).setReturnPage(this.getPage()));
if(!orig.contains(role)){add.add(role);
else{remove.remove(role);
switchtowritingouttodisk,wewillhavetocleanup*ourtemporaryfileswithabort().WARNING:IFyouabusethesizeofthebuffer,youmayleak*memory
ifthisOutputStreamisnotterminated.TheByteArrayOutputStreamwillholdontoits*allocatedmemoryevenafteryoucallreset()onit.So
ifyouputin60MBofbufferspace,it*willstaythereuntiltheobjectisnolongerreferencedandthegarbagecollectordecidesto*pickitup.AsolutiontothiswouldbetouseaFileOutputStreaminsteadofthe*ByteArrayOutputStream.CONTRACT:-close()willNOTflushremainingbytestotheoutputstream,as*perthecontractwithOutputStream.ClosewillremoveanyreferencestoOutputStreamsandits*HttpServletResponse.-fush()willNOTflush
ifthebufferisnotfull.-abort()willsucceed
if*thebufferisnotfullyet.Ifthebufferhasbeenfilledandtheinformationhasbeenwritten*outtoresponse'sOutputStream,theabortreportsashavingfailed.Thepointofthis*PartialBufferedOutputStreamistoallowanabortbeforetheinformationhasbeenwrittenoutto*therealOutputStream.WhenabortiscalledthereferencestoanyOutputStreamsandthe*HttpServletResponseareremoved.**@authorBrentOwens(TheOpenPlanningProject)*@version*/publicclassPartialBufferedOutputStream2extendsOutputStream{publicstaticfinalintDEFAULT_BUFFER_SIZE=50;/**thenumberofbytesinakilobyte*/privatefinalintKILOBYTE=1024;/**Buffersizeforthetemporaryoutputstream*/privateintBUFFER_SIZE=KILOBYTE;/**Temporaryoutputstream,thebufferedone*/privateByteArrayOutputStreamout_buffer;/**Responseoutputstream,thenon-bufferedone,thisispassedinbytheresponse*/privateOutputStreamout_real;privateOutputStreamcurrentStream;/**ThiscontainstheOutputStreamthatwillbeputinout_realwhenthebufferisfull*/privateHttpServletResponseresponse;/**Settotruewhenclose()iscalledtopreventfurtherwriting*/privatebooleanclosed=false;/***ConstructorDefaultsbuffersizeto50KB**@paramresponse*/publicPartialBufferedOutputStream2(HttpServletResponseresponse)throwsIOException{this(response,DEFAULT_BUFFER_SIZE);//defaultto50KB
if(kilobytes<1){thrownewIllegalArgumentException("Buffersizenotgreaterthan0:"+kilobytes);
if(closed){return;
if(closed){return;
if(closed){return;
if((currentStream==out_buffer)&&((out_buffer.size()+extraBytes)>=BUFFER_SIZE)){flushBuffer();
if(closed){return;
if(currentStream==out_real){currentStream.flush();
if(currentStream==out_buffer){flushBuffer();
if(closed){return;
if(out_real!=null)	//removedsotheuserhastoclosetheirstream//	out_real.close();
ifthebufferisnotfullyet.*Ifthatistrue,thenthebufferisclearedandclosed.ItdoesNOTclosetheresponse's*OutputStream**@returnDOCUMENTME!*@throwsIOException*/publicbooleanabort()throwsIOException{
if((out_buffer!=null)&&(out_buffer.size()<BUFFER_SIZE)){out_buffer.close();out_buffer=null;out_real=null;//getridofourlocalpointerresponse=null;//getridofourlocalpointerreturntrue;//success
if("results".equals(value)){returnResultTypeType.RESULTS_LITERAL;
if("hits".equals(value)){returnResultTypeType.HITS_LITERAL;
if(!opened){Filefile=setResourceToDelegate();//createonly
ifwriteiscalledfile.createNewFile();Assert.state(file.canWrite(),"Outputresource"+file.getAbsolutePath()+"mustbewritable");delegate.open(newExecutionContext());opened=true;
if(currentResourceItemCount>=itemCountLimitPerResource){delegate.close();resourceIndex++;currentResourceItemCount=0;setResourceToDelegate();opened=false;
if(opened){delegate.close();
if(executionContext.containsKey(getExecutionContextKey(CURRENT_RESOURCE_ITEM_COUNT))){//It'sarestartdelegate.open(executionContext);
else{opened=false;
if(saveState){
if(opened){delegate.update(executionContext);
if(!fileToDelete.exists())return;synchronized(FILES_PATH){synchronized(FILE_ATTEMPTS_COUNTS){///////////////////////////////////////////////////////////////////////Weaddthefiletoourlistsforlatercheck./////////////////////////////////////////////////////////////////////
if(!FILES_PATH.contains(fileToDelete.getAbsolutePath())){FILES_PATH.add(fileToDelete.getAbsolutePath());FILE_ATTEMPTS_COUNTS.put(fileToDelete.getAbsolutePath(),0);
if(LOGGER.isLoggable(Level.INFO))LOGGER.info("Tryingtoremovefile"+sFile);intattempts=FILE_ATTEMPTS_COUNTS.get(sFile);
if(!newFile(sFile).exists()){it.remove();FILE_ATTEMPTS_COUNTS.remove(sFile);
else{//trytodeleteit
if(newFile(sFile).delete()){
if(LOGGER.isLoggable(Level.INFO))LOGGER.info("Successfullyremovedfile"+sFile);it.remove();FILE_ATTEMPTS_COUNTS.remove(sFile);
else{
if(LOGGER.isLoggable(Level.INFO))LOGGER.info("Unabletoremovefile"+sFile);attempts++;
if(maxAttempts<attempts){
if(LOGGER.isLoggable(Level.INFO))LOGGER.info("Droppingfile"+sFile);it.remove();FILE_ATTEMPTS_COUNTS.remove(sFile);
if(LOGGER.isLoggable(Level.WARNING))LOGGER.warning("Unabletodeletefile"+sFile);
else{FILE_ATTEMPTS_COUNTS.remove(sFile);FILE_ATTEMPTS_COUNTS.put(sFile,attempts);//mighthelp,see//http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4715154Runtime.getRuntime().gc();Runtime.getRuntime().gc();Runtime.getRuntime().gc();Runtime.getRuntime().gc();Runtime.getRuntime().gc();Runtime.getRuntime().gc();System.runFinalization();System.runFinalization();System.runFinalization();System.runFinalization();System.runFinalization();System.runFinalization();
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,t.getLocalizedMessage(),t);
if(!source.isOpen()||!destination.isOpen())thrownewIllegalStateException("Sourceanddestinationchannelsmustbeopen.");finaljava.nio.ByteBufferbuffer=java.nio.ByteBuffer.allocateDirect(bufferSize);while(source.read(buffer)!=-1){//preparethebufferfordrainingbuffer.flip();//writetodestinationwhile(buffer.hasRemaining())destination.write(buffer);//clearbuffer.clear();
if(!source.isOpen()||!destination.isOpen())thrownewIllegalStateException("Sourceanddestinationchannelsmustbeopen.");FileLocklock=null;try{lock=destination.lock();finallongsourceSize=source.size();longpos=0;while(pos<sourceSize){//readandflipfinallongremaining=(sourceSize-pos);finalintmappedZoneSize=remaining>=bufferSize?bufferSize:(int)remaining;destination.transferFrom(source,pos,mappedZoneSize);//updatezonepos+=mappedZoneSize;
if(lock!=null){try{lock.release();
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,t.getLocalizedMessage(),t);
if(channel.isOpen())channel.close();
iftheinputisnotnull.**@paramoListlistofelementstocheckfornull.*/privatestaticvoidinputNotNull(Object...oList){for(Objecto:oList)
if(o==null)thrownewNullPointerException("Inputobjectscannotbenull");
if(!source.isOpen()||!destination.isOpen())thrownewIllegalStateException("Sourceanddestinationchannelsmustbeopen.");finaljava.nio.ByteBufferbuffer=java.nio.ByteBuffer.allocateDirect(bufferSize);FileLocklock=null;try{lock=destination.lock();//Movedestinationtopositiondestination.position(initialWritePosition);while(source.read(buffer)!=-1){//preparethebufferfordrainingbuffer.flip();//writetodestinationwhile(buffer.hasRemaining())writedByte=writedByte+destination.write(buffer);//clearbuffer.clear();
if(lock!=null){try{lock.release();
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,t.getLocalizedMessage(),t);
if(!sourceFile.exists()||!sourceFile.canRead()||!sourceFile.isFile())thrownewIllegalStateException("Sourceisnotinalegalstate.");
if(!destinationFile.exists()){destinationFile.createNewFile();
if(destinationFile.getAbsolutePath().equalsIgnoreCase(sourceFile.getAbsolutePath()))thrownewIllegalArgumentException("Cannotcopyafileonitself");FileChannelsource;FileChanneldestination;source=newRandomAccessFile(sourceFile,"r").getChannel();destination=newRandomAccessFile(destinationFile,"rw").getChannel();try{copyFileChannel(size,source,destination);
if(source!=null){try{source.close();
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,t.getLocalizedMessage(),t);
if(destination!=null){try{destination.close();
if(LOGGER.isLoggable(Level.INFO))LOGGER.log(Level.INFO,t.getLocalizedMessage(),t);
ifwewanttodeletefilesrecursivelyornot.*/publicstaticbooleandeleteDirectory(FilesourceDirectory,FilenameFilterfilter,booleanrecursive,booleandeleteItself){inputNotNull(sourceDirectory,filter);
if(!sourceDirectory.exists()||!sourceDirectory.canRead()||!sourceDirectory.isDirectory())thrownewIllegalStateException("Sourceisnotinalegalstate.");finalFile[]files=(filter!=null?sourceDirectory.listFiles(filter):sourceDirectory.listFiles());for(Filefile:files){
if(file.isDirectory()){
if(recursive){deleteDirectory(file,filter,recursive,deleteItself);
else{
if(!file.delete())returnfalse;
if(!file.exists()||!file.canRead()||!file.isFile())thrownewIllegalStateException("Sourceisnotinalegalstate.");
if(file.delete())return;IOUtils.FILE_CLEANER.addFile(file);
if(!source.exists()||!source.canRead()||!source.isDirectory())thrownewIllegalStateException("Sourceisnotinalegalstate.");FileChannelchannel=null;while(channel==null){try{channel=newFileInputStream(source).getChannel();
if(!source.exists()||!source.canRead()||source.isDirectory())thrownewIllegalStateException("Sourceisnotinalegalstate.");
if(!destDir.exists()||!destDir.canWrite()||!destDir.isDirectory())thrownewIllegalStateException("Sourceisnotinalegalstate.");
if(destDir.getAbsolutePath().equalsIgnoreCase(source.getParentFile().getAbsolutePath()))return;/////////////////////////////////////////////////////////////////////CopytheinputFileinthespecifieddestinationdirectory///////////////////////////////////////////////////////////////////copyFile(source,newFile(destDir,source.getName()));/////////////////////////////////////////////////////////////////////Deletethesourcefile./////////////////////////////////////////////////////////////////////weneedtocallthegc,see//http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4715154
if(removeInputFile)FILE_CLEANER.addFile(source);
ifsomethingbadhappens**@paramfileURL{@linkURL}tobeconvertedintoa{@linkFile}.*@return{@linkFile}forthis{@linkURL}ornull.*/publicstaticFileURLToFile(URLfileURL){inputNotNull(fileURL);try{returnURLs.urlToFile(fileURL);
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,t.getLocalizedMessage(),t);
if(closeOutput)destinationStream.close();
if(closeInput)sourceStream.close();
if(inputStream!=null){returngetStringFromStream(inputStream);
else{finalReaderr=src.getReader();returngetStringFromReader(r);
ifpresent.*@throwsIOExceptionincasesomethingbadhappens.*/publicstaticvoidinflate(ZipFilearchive,ResourceoutputDirectory,StringfileName)throwsIOException{inflate(archive,outputDirectory,fileName,null,null,null,false,false);
ifpresent.*@paramexternal*@throwsIOExceptionincasesomethingbadhappens.*/publicstaticvoidinflate(ZipFilearchive,ResourceoutputDirectory,StringfileName,booleanexternal)throwsIOException{inflate(archive,outputDirectory,fileName,null,null,null,external,false);
ifpresent.*@paramexternal*@paramfilesemptylistoftheextractedfiles(ornull
ifthereisnodesiretocollectthe*list)*@throwsIOExceptionincasesomethingbadhappens.*/publicstaticvoidinflate(ZipFilearchive,ResourceoutputDirectory,StringfileName,Stringworkspace,Stringstore,List<Resource>files,booleanexternal)throwsIOException{inflate(archive,outputDirectory,fileName,null,null,files,external,true);
ifpresent.*@paramexternal*@paramsaveFilebooleantospecifytosaveornotthelistoftheextractedfiles*@paramfilesemptylistoftheextractedfiles(ornull
ifthereisnodesiretocollectthe*list)*@throwsIOExceptionincasesomethingbadhappens.*/publicstaticvoidinflate(ZipFilearchive,ResourceoutputDirectory,StringfileName,Stringworkspace,Stringstore,List<Resource>files,booleanexternal,booleansaveFile)throwsIOException{finalEnumeration<?extendsZipEntry>entries=archive.entries();try{FiledestDir=outputDirectory.dir();while(entries.hasMoreElements()){ZipEntryentry=entries.nextElement();//Verifythatthefilewillnotbewrittenoutsideofthetargetdirectoryorg.geoserver.util.IOUtils.getZipOutputFile(destDir,entry);
if(!entry.isDirectory()){finalStringname=entry.getName();finalStringext=FilenameUtils.getExtension(name);finalInputStreamin=newBufferedInputStream(archive.getInputStream(entry));//BuilderassociatedtothepathfortheitemStringBuilderitemPath=fileName!=null?newStringBuilder(fileName).append(".").append(ext):newStringBuilder(name);//StringassociatedtothefilenameStringinitialFileName=fileName!=null?fileName+"."+ext:FilenameUtils.getName(name);//IftheRESTUploadPathMapperarepresentthentheoutputfilepositionis//changed
if(!external){Map<String,String>storeParams=newHashMap<>();RESTUtils.remapping(workspace,store,itemPath,initialFileName,storeParams);
if(saveFile&&files!=null){files.add(outFile);
if(LOGGER.isLoggable(Level.FINE))LOGGER.isLoggable(Level.FINE);
if(!parser.getValidationErrors().isEmpty()){ServiceExceptionexception=newServiceException("Invalidrequest","InvalidParameterValue");for(Exceptionerror:(List<Exception>)parser.getValidationErrors()){LOGGER.warning(error.getLocalizedMessage());exception.getExceptionText().add(error.getLocalizedMessage());
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;AttributeTypeInfoImplother=(AttributeTypeInfoImpl)obj;
if(attribute==null){
if(other.attribute!=null)returnfalse;
else
if(!attribute.equals(other.attribute))returnfalse;
if(binding==null){
if(other.binding!=null)returnfalse;
else
if(!binding.equals(other.binding))returnfalse;
if(featureType==null){
if(other.featureType!=null)returnfalse;
else
if(!featureType.equals(other.featureType))returnfalse;
if(id==null){
if(other.id!=null)returnfalse;
else
if(!id.equals(other.id))returnfalse;
if(length==null){
if(other.length!=null)returnfalse;
else
if(!length.equals(other.length))returnfalse;
if(maxOccurs!=other.maxOccurs)returnfalse;
if(metadata==null){
if(other.metadata!=null)returnfalse;
else
if(!metadata.equals(other.metadata))returnfalse;
if(minOccurs!=other.minOccurs)returnfalse;
if(name==null){
if(other.name!=null)returnfalse;
else
if(!name.equals(other.name))returnfalse;
if(nillable!=other.nillable)returnfalse;returntrue;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;AttributeTypeInfoImplother=(AttributeTypeInfoImpl)obj;
if(attribute==null){
if(other.attribute!=null)returnfalse;
else
if(!attribute.equals(other.attribute))returnfalse;
if(binding==null){
if(other.binding!=null)returnfalse;
else
if(!binding.equals(other.binding))returnfalse;
if(id==null){
if(other.id!=null)returnfalse;
else
if(!id.equals(other.id))returnfalse;
if(length==null){
if(other.length!=null)returnfalse;
else
if(!length.equals(other.length))returnfalse;
if(maxOccurs!=other.maxOccurs)returnfalse;
if(metadata==null){
if(other.metadata!=null)returnfalse;
else
if(!metadata.equals(other.metadata))returnfalse;
if(minOccurs!=other.minOccurs)returnfalse;
if(name==null){
if(other.name!=null)returnfalse;
else
if(!name.equals(other.name))returnfalse;
if(nillable!=other.nillable)returnfalse;returntrue;}}
if(chaininstanceofRasterTransformChain&&txinstanceofRasterTransform){chain.add(tx);
else
if(chaininstanceofVectorTransformChain&&txinstanceofVectorTransform){chain.add(tx);
if(t.getId()==id){returnt;
if(tasks.isEmpty()){
if(state==State.INIT){newState=State.INIT;
else{newState=State.PENDING;
else{newState=State.COMPLETE;
switch(task.getState()){caseCOMPLETE:continue;caseRUNNING:newState=State.RUNNING;breakO;default:newState=State.PENDING;breakO;
if(state==ImportContext.State.COMPLETE){
if(!isDirect()){//ItseemslikewecansafelymarkImportdataastemporarydata//Let'sremove".locking"fileunlockUploadFolder(directory);
else{lockUploadFolder(directory);
ifany"isDirect".**<p>"isDirect"meansthattheImporterwillrelyonuploadeddatapositiontocreatethe*Store.Theuploadeddatashouldbepreserved,otherwisetheLayerwillbebroken.**@returnboolean*/publicbooleanisDirect(){booleanisDirect=Iterables.any(getTasks(),newPredicate<ImportTask>(){@Overridepublicbooleanapply(ImportTaskinput){returninput.isDirect();
ifallofthemdonot*haveaconfiguredLayerontheCatalog.**<p>ThatmeansthattheuserhasremovedtheLayersfromtheCatalogandthereforewearesafe*towipeouttheuploadeddata.**@returnboolean*/publicbooleanisEmpty(){booleannoLayersAvailable=Iterables.all(getTasks(),newPredicate<ImportTask>(){@Overridepublicbooleanapply(ImportTaskinput){finalStoreInfostore=input!=null?input.getStore():null;finalCatalogcatalog=store!=null?store.getCatalog():null;finalLayerInfolayer=catalog!=null?catalog.getLayer(input.getLayer().getId()):null;return(layer==null);
if(directory!=null){Filelocking=newFile(directory.getFile(),".locking");
if(!locking.exists()){locking.createNewFile();
if(directory!=null){Filelocking=newFile(directory.getFile(),".locking");
if(locking.exists()){locking.delete();
if(getData()instanceofDirectory){directory=(Directory)getData();
else
if(getData()instanceofSpatialFile){directory=newDirectory(((SpatialFile)getData()).getFile().getParentFile());
if(directory==null){for(ImportTasktask:tasks){
if(task.getData()instanceofDirectory){directory=(Directory)task.getData();
else
if(task.getData()instanceofSpatialFile){directory=newDirectory(((SpatialFile)task.getData()).getFile().getParentFile());
if(task.getData()!=null){task.getData().cleanup();
if(data!=null){data.reattach();
if(targetWorkspace!=null){targetWorkspace=resolve(targetWorkspace,catalog,lookupByName);
if(targetStore!=null){targetStore.setWorkspace(targetWorkspace);
if(progress==null){progress=newProgressMonitor();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;ImportContextother=(ImportContext)obj;
if(id==null){
if(other.id!=null)returnfalse;
else
if(!id.equals(other.id))returnfalse;returntrue;
if(tasks==null){tasks=newArrayList<>();
if(defaultTransforms==null){defaultTransforms=newArrayList<>();
ifany**@returnthemessage*/publicStringgetMessage(){returnmessage;
if(e!=null){this.minX=e.getMinX();this.minY=e.getMinY();this.maxX=e.getMaxX();this.maxY=e.getMaxY();this.crs=e.getCoordinateReferenceSystem();
if(is3D()){
if(einstanceofReferencedEnvelope3D){this.minZ=((ReferencedEnvelope3D)e).getMinZ();this.maxZ=((ReferencedEnvelope3D)e).getMaxZ();
else{this.minZ=Double.NaN;this.maxZ=Double.NaN;
else{this.minZ=Double.NaN;this.maxZ=Double.NaN;
if(isCRSFieldVisible()){crsPanel.processInput();
if(minX!=null&&maxX!=null&&minY!=null&&maxY!=null){
if(crsRequired&&crs==null){setConvertedInput(null);
else{
if(is3D()){doubleminZsafe=minZ==null?Double.NaN:minZ;doublemaxZsafe=maxZ==null?Double.NaN:maxZ;setConvertedInput(newReferencedEnvelope3D(minX,maxX,minY,maxY,minZsafe,maxZsafe,crs));
else{setConvertedInput(newReferencedEnvelope(minX,maxX,minY,maxY,crs));
else{setConvertedInput(null);
ifanyandvalid*/publicCoordinateReferenceSystemgetCoordinateReferenceSystem(){returncrs;}}
if(this==FILENAME){returnnewFilenameTimeHandler();
switch(TimeMode.this){caseAUTO:returnDates.matchAndParse(g.getFile().getName());caseMANUAL:returng.getTimestamp();
if(roles==null)roles=newTreeSet<GeoServerRole>();returnCollections.unmodifiableSortedSet(roles);
if(roles==null)roles=newTreeSet<GeoServerRole>();returnCollections.unmodifiableSortedSet(roles);
if(entry.getValue().contains(role))result.add(entry.getKey());
if(entry.getValue().contains(role))result.add(entry.getKey());
if(request.getTypeName()==null){//allcollectionsreturnnewCollectionsDocument(request,getService(),getCatalog());
else{//singlecollectionQNametypeName=request.getTypeName();NamespaceInfons=getCatalog().getNamespaceByURI(typeName.getNamespaceURI());FeatureTypeInfofeatureType=getCatalog().getFeatureTypeByName(ns,typeName.getLocalPart());
if(featureType==null){thrownewServiceException("Unknowncollection"+typeName,ServiceException.INVALID_PARAMETER_VALUE,"typeName");
else{returnnewCollectionsDocument(request,getService(),getCatalog(),featureType);
if(request.getStartIndex()==null&&request.getCount()!=null){request.setStartIndex(BigInteger.ZERO);
if(!responseType.isAssignableFrom(format.getBinding())){continue;
if(formats.isEmpty()){continue;
if*thelockisnotacquired*/publicvoidacquireReadLock(){booleanacquired=false;try{acquired=lock.readLock().tryLock(timeoutMs,TimeUnit.MILLISECONDS);
if(!acquired){thrownewServiceException("Failedtoacquirereadlockon'"+name+"'inlessthan"+timeoutMs+"ms");
if*thelockisnotacquired*/publicvoidacquireWriteLock(){booleanacquired=false;try{acquired=lock.writeLock().tryLock(timeoutMs,TimeUnit.MILLISECONDS);
if(!acquired){thrownewServiceException("Failedtoacquirewritelockon'"+name+"'inlessthan"+timeoutMs+"ms");
if(helper.roleMap.containsKey(role.getAuthority()))thrownewIllegalArgumentException("Therole"+role.getAuthority()+"alreadyexists");
else{helper.roleMap.put(role.getAuthority(),role);setModified(true);
if(helper.roleMap.containsKey(role.getAuthority())){helper.roleMap.put(role.getAuthority(),role);setModified(true);
elsethrownewIllegalArgumentException("Therole"+role.getAuthority()+"doesnotexist");
if(helper.roleMap.containsKey(role.getAuthority())==false)//nothingtodoreturnfalse;for(SortedSet<GeoServerRole>set:helper.user_roleMap.values()){set.remove(role);
if(role.equals(entry.getValue()))toBeRemoved.add(entry.getKey());
if(isModified()){LOGGER.info("Startstoringrolesforservicenamed"+getName());//preventconcurrentwritefromstoreand//readfromservicesynchronized(service){serialize();
else{LOGGER.info("Storingunnecessary,nochangeforroles");
if(roles!=null&&roles.contains(role)){roles.remove(role);setModified(true);
if(roles==null){roles=newTreeSet<GeoServerRole>();helper.group_roleMap.put(groupname,roles);
if(roles.contains(role)==false){//somethingchanged?roles.add(role);setModified(true);
if(roles==null){roles=newTreeSet<GeoServerRole>();helper.user_roleMap.put(username,roles);
if(roles.contains(role)==false){//somethingchangedroles.add(role);setModified(true);
if(roles!=null&&roles.contains(role)){roles.remove(role);setModified(true);
if(hhelper.isValidParent(role.getAuthority(),parentRole==null?null:parentRole.getAuthority())==false)thrownewIOException(parentRole.getAuthority()+"isnotavalidparentfor"+role.getAuthority());checkRole(role);
if(parentRole==null){helper.role_parentMap.remove(role);
else{checkRole(parentRole);helper.role_parentMap.put(role,parentRole);
if(helper.roleMap.containsKey(role.getAuthority())==false)thrownewIllegalArgumentException("Role:"+role.getAuthority()+"doesnotexist");
if(ws!=null){WorkspaceInforesolved=null;
if(ws.getId()!=null){resolved=cat.getWorkspace(ws.getId());
if(resolved==null&&lookupByName){//trylookingupbynameresolved=cat.getWorkspaceByName(ws.getName());
if(resolved!=null){ws=resolved;
if(s!=null){StoreInforesolved=null;
if(s.getId()!=null){resolved=cat.getStore(s.getId(),StoreInfo.class);
if(resolved==null&&lookupByName){resolved=cat.getStoreByName(s.getWorkspace(),s.getName(),StoreInfo.class);
if(resolved!=null){s=resolved;
if(s!=null&&s.getCatalog()==null&&sinstanceofStoreInfoImpl){((StoreInfoImpl)s).setCatalog(cat);
if(l!=null&&l.getId()!=null){LayerInforesolved=cat.getLayer(l.getId());
if(resolved!=null){l=resolved;
if(l!=null&&l.getId()==null&&lookupByName){LayerInforesolved=cat.getLayerByName(l.prefixedName());
if(resolved!=null){l=resolved;
if(l!=null){
if(l.getResource()!=null){resolveCollections(l.getResource());l.getResource().setStore(resolve(l.getResource().getStore(),cat,lookupByName));
if(object!=null){OwsUtils.resolveCollections(object);
if(symbolizerinstanceofPointSymbolizer){pointSymbolizers.add((PointSymbolizer)symbolizer);
if(!pointSymbolizers.isEmpty())rules.add(newMiniRule(rule.getFilter(),rule.isElseFilter(),pointSymbolizers));
if(!rules.isEmpty()){ftStyles.add(rules);
if(!miniRule.symbolizers.isEmpty()){RulerealRule=factory.createRule();for(Symbolizersym:miniRule.symbolizers){realRule.symbolizers().add(sym);
if(f!=null){LegacyCatalogImportercatalogImporter=newLegacyCatalogImporter();catalogImporter.setResourceLoader(resourceLoader);catalogImporter.setCatalog(catalog);catalogImporter.imprt(resourceLoader.getBaseDirectory());
else{LOGGER.warning("Nocatalogfilefound.");
if(f!=null){//loadconfigurationLegacyConfigurationImporterimporter=newLegacyConfigurationImporter();importer.setConfiguration(geoServer);importer.imprt(resourceLoader.getBaseDirectory());
else{LOGGER.warning("Noconfigurationfilefound.");
if(finstanceofAnd){handleComposite((And)f,"AND");
else
if(finstanceofOr){handleComposite((Or)f,"OR");
else{handleFilter(f);
if(form.findSubmittingButton()!=form.get("save")){return;
if(ServiceAccessRuleDAO.get().getRules().contains(rule)){form.error(newParamResourceModel("duplicateRule",getPage(),rule.getKey()).getString());
if(count>=maxLockAttempts){thrownewIllegalStateException("Failedtogetalockonkey"+lockKey+"after"+count+"attempts");
if(LOGGER.isDebugEnabled()){LOGGER.debug("Lock"+lockKey+"acquiredbythread"+Thread.currentThread().getId()+"onfile"+file);
if(released){return;
if(!lock.isValid()){//donotcrapout,locksusageisonlytheretopreventduplication//ofwork
if(LOGGER.isDebugEnabled()){LOGGER.debug("Lockkey"+lockKey+"forreleasinglockisunkonwn,itmeans"+"thislockwasneveracquired,orwasreleasedtwice."+"Currentthreadis:"+Thread.currentThread().getId()+"."+"AreyourunningtwoinstancesinthesameJVMusingNIOlocks?"+"Thiscaseisnotsupportedandwillgenerateexactlythiserrormessage");return;
if(LOGGER.isDebugEnabled()){LOGGER.debug("Lock"+lockKey+"releasedbythread"+Thread.currentThread().getId());
if(currLock!=null){currLock.release();memoryLock.release();
if(data!=null){root=newFile(data);
else{thrownewIllegalStateException("Unabletodeterminedatadirectory");
iftheCSWschemaLocationshouldrefertothecanonicallocation,false
iftheCSW*schemaLocationshouldrefertoacopyservedbyGeoServer.*/booleanisCanonicalSchemaLocation();/***SettheflagthatdeterminestheencodingoftheCSWschemaLocation.True
iftheCSW*schemaLocationshouldrefertothecanonicallocation,false
iftheCSWschemaLocationshould*refertoacopyservedbyGeoServer.*/voidsetCanonicalSchemaLocation(booleancanonicalSchemaLocation);}
if(rule.getId()==null){shiftIfNecessary(rule.getPriority(),rule);inti=0;while(i<rules.size()&&rules.get(i).getPriority()<rule.getPriority()){i++;
else{AdminRulebigRule=adminService().get(rule.getId());
if(bigRule.getPriority()!=rule.getPriority()){shiftIfNecessary(rule.getPriority(),rule);
if(index>0){swap(rule,rules.get(index-1));rules.remove(index);rules.add(index-1,rule);
if(index<rules.size()-1){swap(rule,rules.get(index+1));rules.remove(index);rules.add(index+1,rule);
if(rule.getPriority()==priority){necessary=true;continue;
if(necessary){for(ShortAdminRulerule:rules){
if(rule.getPriority()>=priority&&rule!=keep){rule.setPriority(rule.getPriority()+1);
iftheDownloadProcessclassbehavescorrectly.**@author"AlessioFabiani-alessio.fabiani@geo-solutions.it"*/publicclassDownloadProcessTestextendsWPSTestSupport{privatestaticfinalFilterFactory2FF=FeatureUtilities.DEFAULT_FILTER_FACTORY;privatestaticQNameMIXED_RES=newQName(WCS_URI,"mixedres",WCS_PREFIX);privatestaticSet<String>GTIFF_EXTENSIONS=newHashSet<String>();privatestaticSet<String>PNG_EXTENSIONS=newHashSet<String>();privatestaticSet<String>JPEG_EXTENSIONS=newHashSet<String>();privatestaticSet<String>XML_EXTENSIONS=newHashSet<String>();privatestaticSet<String>JSON_EXTENSIONS=newHashSet<String>();privatestaticMap<String,Set<String>>FORMAT_TO_EXTENSIONS=newHashMap<>();static{GTIFF_EXTENSIONS.add("tif");GTIFF_EXTENSIONS.add("tiff");GTIFF_EXTENSIONS.add("geotiff");FORMAT_TO_EXTENSIONS.put("GTIFF",GTIFF_EXTENSIONS);PNG_EXTENSIONS.add("png");FORMAT_TO_EXTENSIONS.put("PNG",PNG_EXTENSIONS);JPEG_EXTENSIONS.add("jpg");JPEG_EXTENSIONS.add("jpeg");FORMAT_TO_EXTENSIONS.put("JPEG",JPEG_EXTENSIONS);XML_EXTENSIONS.add("xml");FORMAT_TO_EXTENSIONS.put("XML",XML_EXTENSIONS);JSON_EXTENSIONS.add("json");FORMAT_TO_EXTENSIONS.put("JSON",JSON_EXTENSIONS);
if(entry.isDirectory()){file.mkdir();
else{intcount;bytedata[]=newbyte[4096];//writethefilestothediskFileOutputStreamfos=null;try{fos=newFileOutputStream(file);while((count=zis.read(data))!=-1){fos.write(data,0,count);
if(fos!=null){org.apache.commons.io.IOUtils.closeQuietly(fos);
if(zis!=null){org.apache.commons.io.IOUtils.closeQuietly(zis);
if(ext.equalsIgnoreCase(extension)){returntrue;
if(gc!=null){CoverageCleanerCallback.disposeCoverage(gc);
if(reader!=null){reader.dispose();
if(gc!=null){CoverageCleanerCallback.disposeCoverage(gc);
if(reader!=null){reader.dispose();
if(gcResampled!=null){CoverageCleanerCallback.disposeCoverage(gcResampled);
if(reader!=null)reader.dispose();//cleanupprocessresourceManager.finished(resourceManager.getExecutionId(true));
if(child!=null){Set<String>expectedTiffTagKeys=expectedTiffTagValues.keySet();while(child!=null){NamedNodeMapmap=child.getAttributes();
if(map!=null){//printattributevaluesintlength=map.getLength();//LoopovertheTIFFTagsfor(inti=0;i<length;i++){Nodeattr=map.item(i);StringnodeValue=attr.getNodeValue();
if(expectedTiffTagKeys.contains(nodeValue)){//WehavefoundarequiredTIFFTagNodechildNode=child.getFirstChild().getFirstChild();NamedNodeMapattributesMap=childNode.getAttributes();intattributesMapLength=attributesMap.getLength();for(intk=0;k<attributesMapLength;k++){Nodeattrib=attributesMap.item(k);//ChecktheTIFFTagValueismatchingtheexpectedone
if(expectedTiffTagValues.get(nodeValue).equals(attrib.getNodeValue())){matchingStillRequired--;
if(reader!=null){reader.dispose();
if(gc!=null){CoverageCleanerCallback.disposeCoverage(gc);
if(reader!=null){reader.dispose();
if(gc!=null){CoverageCleanerCallback.disposeCoverage(gc);
if(reader!=null){reader.dispose();
if(gc!=null){CoverageCleanerCallback.disposeCoverage(gc);
if(reader!=null){reader.dispose();
if(gc!=null){CoverageCleanerCallback.disposeCoverage(gc);
if(reader!=null){reader.dispose();
if(gc!=null){CoverageCleanerCallback.disposeCoverage(gc);
if(reader!=null){reader.dispose();
if(gc!=null){CoverageCleanerCallback.disposeCoverage(gc);
if(reader!=null){reader.dispose();
if(gc!=null){CoverageCleanerCallback.disposeCoverage(gc);
if(reader!=null){reader.dispose();
if(gc!=null){CoverageCleanerCallback.disposeCoverage(gc);
if(reader!=null){reader.dispose();
ifiscanceled.**@returntrue,
ifiscanceled*/publicbooleanisCanceled(){returnstatus.getPhase()==ProcessState.DISMISSING;
if(cancel==true){status.setPhase(ProcessState.DISMISSING);
if(entry.isDirectory()){file.mkdir();
else{
if(file.getName().toLowerCase().endsWith(".shp")){shapeFile=file;
else
if(file.getName().toLowerCase().endsWith(".zip")){zipFile=file;
if(fos!=null){fos.close();
if(zis!=null){zis.close();
if(shapeFile==null){
if(zipFile!=null)returndecodeShape(newFileInputStream(zipFile));
else{FileUtils.deleteDirectory(tempDir);thrownewIOException("Couldnotfindanyfilewith.shpextensioninthezipfile");
else{ShapefileDataStorestore=newShapefileDataStore(URLs.fileToUrl(shapeFile));returnstore.getFeatureSource().getFeatures();
if(imageReader!=null){imageReader.dispose();
if(constructor==null){ClassproxyClass=Proxy.getProxyClass(clazz.getClassLoader(),clazz);constructor=proxyClass.getConstructor(newClass[]{InvocationHandler.class});
if(objectinstanceofProxy){InvocationHandlerh=Proxy.getInvocationHandler(object);
if(hinstanceofResolvingProxy){Stringref=((ResolvingProxy)h).getRef();Stringpre=((ResolvingProxy)h).getPrefix();
if(objectinstanceofWorkspaceInfo){Objectws=catalog.getWorkspace(ref);
if(ws==null){ws=catalog.getWorkspaceByName(ref);
if(objectinstanceofNamespaceInfo){Objectns=catalog.getNamespace(ref);
if(ns==null){ns=catalog.getNamespaceByPrefix(ref);
if(objectinstanceofStoreInfo){
if(objectinstanceofDataStoreInfo){return(T)catalog.getDataStore(ref);
if(objectinstanceofCoverageStoreInfo){return(T)catalog.getCoverageStore(ref);
if(resolved==null){
if(ref.indexOf(":")>0){String[]qualifiedName=ref.split(":");resolved=(T)catalog.getStoreByName(qualifiedName[0],qualifiedName[1],StoreInfo.class);
else{resolved=(T)catalog.getStoreByName(ref,StoreInfo.class);
if(objectinstanceofResourceInfo){
if(objectinstanceofFeatureTypeInfo){Objectr=catalog.getFeatureType(ref);
if(r==null){r=catalog.getFeatureTypeByName(ref);
if(objectinstanceofCoverageInfo){Objectr=catalog.getCoverage(ref);
if(r==null){r=catalog.getCoverageByName(ref);
if(r==null){r=catalog.getResourceByName(ref,ResourceInfo.class);
if(objectinstanceofLayerInfo){Objectl=catalog.getLayer(ref);
if(l==null){l=catalog.getLayerByName(ref);
if(objectinstanceofLayerGroupInfo){Objectg=catalog.getLayerGroup(ref);
if(g==null){g=catalog.getLayerGroupByName(ref);
if(objectinstanceofPublishedInfo){//Thiscanhappen
ifyouhavealayergroupwithanulllayer(stylegroup)
if(null==ref||"".equals(ref)){returnnull;
if(objectinstanceofStyleInfo){Objects=catalog.getStyle(ref);
if(s==null){
if(pre!=null){//lookupinworkspaces=catalog.getStyleByName(pre,ref);
if(s==null){//stillnolucks=catalog.getStyleByName(ref);
if("id".equalsIgnoreCase(property)){returnref;
ifwegetherethereferenceisdangling,haveitusetheproxyhashcodeandequals//toallowcomparingthereferenceswithnocrypticexceptionsthatwouldnot//helpdebuggingthebrokenreferencefinalStringmethodName=method.getName();
if(methodName.equals("hashCode")){returnhashCode();
else
if(methodName.equals("equals")){//allowsanobjectwithdanglingreferencetobecomparedwithitselfbyequalityreturnargs[0]==null||equals(args[0]);
if(code==null){code=CRS.lookupEpsgCode(crs,true);
if(code==null){cache.put(crs,FAILED_LOOKUP);
else{cache.put(crs,code);
if(FAILED_LOOKUP.equals(code)){code=null;
if(!(operation.getParameters()[0]instanceofGetCoverageType))returnfalse;GetCoverageTypegetCoverage=(GetCoverageType)operation.getParameters()[0];return!getCoverage.getOutput().isStore();
if(delegate==null)thrownewWcsException("Couldnotfindencoderforoutputformat"+outputFormat);//grabthecoverageinfoforCoveragesdocumentencodingfinalGridCoverage2Dcoverage=(GridCoverage2D)coverages[0];CoverageInfocoverageInfo=catalog.getCoverageByName(request.getIdentifier().getValue());//usejavamailclassestoactuallyencodethedocumenttry{//coveragesxmlstructure(alwayssettheheadersafterthedata//handlers,setting//thedatahandlerskillssomeofthem)BodyPartcoveragesPart=newMimeBodyPart();finalCoveragesDatacoveragesData=newCoveragesData(coverageInfo,request);coveragesPart.setDataHandler(newDataHandler(coveragesData,"geoserver/coverages11"));coveragesPart.setHeader("Content-ID","<urn:ogc:wcs:1.1:coverages>");coveragesPart.setHeader("Content-Type","text/xml");multipart.addBodyPart(coveragesPart);//theactualcoverageBodyPartcoveragePart=newMimeBodyPart();CoverageEncoderencoder=newCoverageEncoder(delegate,coverage,outputFormat,newHashMap<String,String>());coveragePart.setDataHandler(newDataHandler(encoder,"geoserver/coverageDelegate"));coveragePart.setHeader("Content-ID","<theCoverage>");coveragePart.setHeader("Content-Type",delegate.getMimeType(outputFormat));coveragePart.setHeader("Content-Transfer-Encoding","base64");multipart.addBodyPart(coveragePart);//writeoutthemultipart(weneedtousemimemessagetryingto//encodedirectlywithmultipartorBodyPartdoesnotsetproperly//theencodingsandbinaryfilesgetsruinedMimeMessagemessage=newGeoServerMimeMessage();message.setContent(multipart);message.writeTo(output);output.flush();
if(crs==null){//usethenativeonecrs=info.getCRS();
iftheGMLmimetypeissupported
if(!layer.isQueryable()){returnnull;
if(!infoFormats.contains("application/vnd.ogc.gml")){returnnull;
if(resultinstanceofFeatureCollectionType){FeatureCollectionTypefcList=(FeatureCollectionType)result;List<SimpleFeatureCollection>rawResults=fcList.getFeature();//retypingfeaturecollectionstoreplacenameandnamespace//fromcascadingserverwithourlocalWMSLayerInfofor(SimpleFeatureCollectionfc:rawResults){SimpleFeatureTypeft=fc.getSchema();SimpleFeatureTypeBuilderbuilder=newSimpleFeatureTypeBuilder();builder.init(ft);builder.setName(info.getName());builder.setNamespaceURI(info.getNamespace().getURI());SimpleFeatureTypetargetFeatureType=builder.buildFeatureType();FeatureCollectionrfc=newReTypingFeatureCollection(fc,targetFeatureType);//
ifpossibleforceaCRStobedefinedresults.add(forceCrs(rfc));
ifweneedtoreproject
if(!getWms().isFeaturesReprojectionDisabled()){//trytoreprojecttotargetCRSreturnLayerIdentifierUtils.reproject(results,params.getRequestedCRS());
ifallthe*featurecollectiongeometriesusethesameCRSthatCRSwillbeforced.Thisonlyworkfor*simplefeatures.*/privateFeatureCollectionforceCrs(FeatureCollectionfeatureCollection){
if(featureCollection.getSchema().getCoordinateReferenceSystem()!=null){//aCRSisalreadydefinedreturnfeatureCollection;
if(crs==null){//thereisnothingmorewecandoreturnfeatureCollection;
ifneeded.**@returnWMSserviceconfigurationfacade*/privateWMSgetWms(){
if(wms==null){//noneedforsynchronizationherewms=GeoServerExtensions.bean(WMS.class);
iftheprocesshasinputsornot**@authorAndreaAime-GeoSolutions*/publicclassProcessStartupFilterimplementsProcessFilter,ExtensionPriority{publicclassProcessStartupWrapperimplementsProcess{Processdelegate;publicProcessStartupWrapper(Processdelegate){super();this.delegate=delegate;
if(monitor!=null){monitor.started();monitor=newDelegateProgressListener(monitor){@Overridepublicvoidstarted(){//donotpassover,wealreadycalled"started"
if(!(operation.getParameters()[0]instanceofGetCoverageType))thrownewWcsException("Cannothandleobjectoftype:"+operation.getParameters()[0].getClass());GetCoverageTypegetCoverage=(GetCoverageType)operation.getParameters()[0];StringoutputFormat=getCoverage.getOutput().getFormat().getValue();CoverageResponseDelegatedelegate=getResponseDelegate(outputFormat);returngetCoverage.getSourceCoverage()+"."+delegate.getFileExtension(outputFormat);
if(!(operation.getParameters()[0]instanceofGetCoverageType))thrownewWcsException("Cannothandleobjectoftype:"+operation.getParameters()[0].getClass());GetCoverageTypegetCoverage=(GetCoverageType)operation.getParameters()[0];StringoutputFormat=getCoverage.getOutput().getFormat().getValue();CoverageResponseDelegatedelegate=getResponseDelegate(outputFormat);returndelegate.getMimeType(outputFormat);
if(delegate==null){thrownewWcsException("Couldnotfindencoderforoutputformat"+outputFormat);
if(!(operation.getParameters()[0]instanceofGetCoverageType))returnfalse;GetCoverageTypegetCoverage=(GetCoverageType)operation.getParameters()[0];StringoutputFormat=getCoverage.getOutput().getFormat().getValue();CoverageResponseDelegatedelegate=getResponseDelegate(outputFormat);returndelegate.canProduce(outputFormat);
if(target!=null){
if(allowEnvParametrization&&gsEnvironment!=null&&GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){target.setProviderName((String)gsEnvironment.resolveValue(providerName));
if(service.getKeywords()==null){((WPSInfoImpl)service).setKeywords(newArrayList());
if(service.getExceptionFormats()==null){((WPSInfoImpl)service).setExceptionFormats(newArrayList());
if(service.getMetadata()==null){((WPSInfoImpl)service).setMetadata(newMetadataMap());
if(service.getClientProperties()==null){((WPSInfoImpl)service).setClientProperties(newHashMap());
if(service.getVersions()==null){((WPSInfoImpl)service).setVersions(newArrayList());
if(service.getVersions().isEmpty()){service.getVersions().add(newVersion("1.0.0"));
if(service.getConnectionTimeout()==0){//timeouthasnotyetbeenspecified.Usedefaultservice.setConnectionTimeout(WPSInfoImpl.DEFAULT_CONNECTION_TIMEOUT);
if(service.getProcessGroups()==null){((WPSInfoImpl)service).setProcessGroups(newArrayList());
else{for(ProcessGroupInfopg:service.getProcessGroups()){
if(pg.getRoles()==null){pg.setRoles(newArrayList<String>());
if(pg.getMetadata()==null){((ProcessGroupInfoImpl)pg).setMetadata(newMetadataMap());
if(pg.getFilteredProcesses()==null){((ProcessGroupInfoImpl)pg).setFilteredProcesses(newArrayList<ProcessInfo>());
else{for(ProcessInfopi:pg.getFilteredProcesses()){
if(pi.getRoles()==null){((ProcessInfoImpl)pi).setRoles(newArrayList<String>());
if(pi.getValidators()==null){Multimap<String,WPSInputValidator>validators=ArrayListMultimap.create();((ProcessInfoImpl)pi).setValidators(validators);
if(pi.getMetadata()==null){((ProcessInfoImpl)pi).setMetadata(newMetadataMap());
if(service.getName()==null){service.setName("WPS");
if(idx==-1){returnnewNameImpl(str);
else{Stringprefix=str.substring(0,idx);Stringlocal=str.substring(idx+1);returnnewNameImpl(prefix,local);
if(converted.getFilteredProcesses()!=null){List<ProcessInfo>newFilteredProcesses=newArrayList<ProcessInfo>();for(Objectfp:converted.getFilteredProcesses()){
if(fpinstanceofNameImpl){NameImplni=(NameImpl)fp;ProcessInfopi=newProcessInfoImpl();pi.setName(ni);pi.setEnabled(false);newFilteredProcesses.add(pi);
else{break;
if(!newFilteredProcesses.isEmpty()){converted.getFilteredProcesses().clear();converted.getFilteredProcesses().addAll(newFilteredProcesses);
if(!range.isMinIncluded()){writer.startNode("isMinIncluded");writer.setValue("false");writer.endNode();
if(!range.isMaxIncluded()){writer.startNode("isMaxIncluded");writer.setValue("false");writer.endNode();
if//theenvironmentdoesnotcontaintheclassestheyarelookingfor,sowe//guardtheirinitializationandjustskipthemtry{extractors.add(newCommonsDbcpNativeJdbcExtractor());
if(unwrapped!=null)returnunwrapped;
elsethrownewIllegalArgumentException("Thisconnectionisnotunwrappable,"+"checkcanUnwrapbeforecallingunwrap");
ifunwrappingwasnotpossibleConnectionunwrapped=extractor.getNativeConnection(conn);
if(conn!=unwrapped){
if(i!=0){//movetheextractortothetop,sothatwedon'tdo//manyuselessattemptsatunwrappingwiththeothers//(thiscodeistypicallyexecutedforeachfeature)EXTRACTORS.add(0,extractor);EXTRACTORS.remove(i);
if(unwrapped!=null)returnunwrapped;
elsethrownewIllegalArgumentException("Thisstatementisnotunwrappable,"+"checkcanUnwrapbeforecallingunwrap");
ifunwrappingwasnotpossibleStatementunwrapped=extractor.getNativeStatement(st);
if(st!=unwrapped){
if(i!=0){//movetheextractortothebeginning,sothatwedon'tdo//manyuselessattemptsatunwrappingwiththeothers//(thiscodeistypicallyexecutedforeachfeature)EXTRACTORS.add(0,extractor);EXTRACTORS.remove(i);
if(updateinstanceofWFS11){return(UpdateElementType)update.getAdaptee();
if(identifiedCollections!=null){for(FeatureCollectionidentifierCollection:identifiedCollections){FeatureCollectionfc=selectProperties(requestParams,identifierCollection);maxFeatures=addToResults(fc,results,layer,request,maxFeatures);
if(maxFeatures<=0){break;
if(identifier.canHandle(layer)){returnidentifier;
if(collection!=null){
if(!(collection.getSchema()instanceofSimpleFeatureType)){//putwrapperarounditwithlayernameNamename=newNameImpl(layer.getFeature().getNamespace().getName(),layer.getFeature().getName());collection=newFeatureCollectionDecorator(name,collection);
if(size!=0){//HACKHACKHACK//Forcomplexfeatures,weneedthetargetCrsandversioninscenariowherewehave//atoplevelfeaturethatdoesnotcontainageometry(thereforenocrs)andhasa//nestedfeaturethatcontainsgeometryasitsproperty.Furthermoreitispossible//foreachnestedfeaturetohavedifferentcrshenceweneedtoreprojectoneach//featureaccordingly.//ThisisaHack,thisinformationshouldnotbepassedthroughfeaturetype//appschemawillneedtoremovethisinformationfromthefeaturetypeagain
if(!(collectioninstanceofSimpleFeatureCollection)){collection.getSchema().getUserData().put("targetCrs",request.getGetMapRequest().getCrs());collection.getSchema().getUserData().put("targetVersion","wms:getfeatureinfo");
if(maxFeatures<=0){return0;
if(names!=Query.ALL_NAMES){Queryq=newQuery(collection.getSchema().getName().getLocalPart(),Filter.INCLUDE,names);returnDataUtilities.source(collection).getFeatures(q);
else{returncollection;
if(GeoServerUser.ROOT_USERNAME.equals(username))returnprepareForRootUser();GeoServerUseruser=(GeoServerUser)service.loadUserByUsername(username);returnprepareForUser(user);
if(mpw!=null)manager.disposePassword(mpw);
if(array!=null)manager.disposePassword(array);
if(sortAttributes!=null&&sortAttributes.length==1){
if(sortAttributes[0].getPropertyName().getPropertyName().equals("timestamp")){//sortbytimestamphappenstobewhatwedoby//default//TODOdoesthePDFsupportasortorder?returntrue;
if(query.getFilter()==Filter.INCLUDE){//filteringnotimplementedintcount=0;try(FeatureReader<SimpleFeatureType,SimpleFeature>featureReader=getReaderInternal(query)){while(featureReader.hasNext()){featureReader.next();count++;
if(query.getPropertyNames()!=null&&query.getPropertyNames().length==1){
if(query.getPropertyNames()[0].equals(TIME_ATTRIBUTE)){//geoserverisdeterminingthetimedomainList<Date>availableTimes=Collections.singletonList(THE_DATE);List<SimpleFeature>features=newArrayList<>(availableTimes.size());intidCounter=0;for(Datedate:availableTimes){SimpleFeatureBuilderfeatureBuilder=newSimpleFeatureBuilder(FEATURE_TYPE);featureBuilder.set(TIME_ATTRIBUTE,date);features.add(featureBuilder.buildFeature("dummyID"+idCounter++));
if(query.getPropertyNames()[0].equals(BAND_DIMENSION)){List<SimpleFeature>features=newArrayList<>(BAND_LIST.size());intidCounter=0;for(Stringband:BAND_LIST){SimpleFeatureBuilderfeatureBuilder=newSimpleFeatureBuilder(FEATURE_TYPE);featureBuilder.set(BAND_DIMENSION,band);features.add(featureBuilder.buildFeature("dummyID"+idCounter++));
if(filter.getExpression1()instanceofPropertyName&&filter.getExpression2()instanceofLiteral){prop=(PropertyName)filter.getExpression1();lit=(Literal)filter.getExpression2();
else
if(filter.getExpression2()instanceofPropertyName&&filter.getExpression1()instanceofLiteral){prop=(PropertyName)filter.getExpression1();lit=(Literal)filter.getExpression2();
else{returnsuper.visit(filter,data);
if(prop.getPropertyName().equals(TIME_ATTRIBUTE)){
if(lit.getValue()!=null){beginDate.setTime(((Date)lit.getValue()).getTime());
if(filter.getExpression1()instanceofPropertyName&&filter.getExpression2()instanceofLiteral){prop=(PropertyName)filter.getExpression1();lit=(Literal)filter.getExpression2();
else
if(filter.getExpression2()instanceofPropertyName&&filter.getExpression1()instanceofLiteral){prop=(PropertyName)filter.getExpression1();lit=(Literal)filter.getExpression2();
else{returnsuper.visit(filter,data);
if(prop.getPropertyName().equals(TIME_ATTRIBUTE)){
if(lit.getValue()!=null){endDate.setTime(((Date)lit.getValue()).getTime());
if(filter.getExpression1()instanceofPropertyName&&filter.getExpression2()instanceofLiteral){prop=(PropertyName)filter.getExpression1();lit=(Literal)filter.getExpression2();
else
if(filter.getExpression2()instanceofPropertyName&&filter.getExpression1()instanceofLiteral){prop=(PropertyName)filter.getExpression1();lit=(Literal)filter.getExpression2();
else{returnsuper.visit(filter,data);
if(prop.getPropertyName().equals(TIME_ATTRIBUTE)){date.setTime(((Date)lit.getValue()).getTime());
if(prop.getPropertyName().equals(BAND_DIMENSION)){band.add((String)lit.getValue());
if(prop.getPropertyName().equals(TIME_ATTRIBUTE)){beginDate.setTime(((Date)((Literal)filter.getLowerBoundary()).getValue()).getTime());endDate.setTime(((Date)((Literal)filter.getUpperBoundary()).getValue()).getTime());
if(prop.getPropertyName().equals(BAND_DIMENSION)){Stringbands=(String)((Literal)filter.getLowerBoundary()).getValue();String[]singleBands=bands.split(",");band.addAll(Arrays.asList(singleBands));
if(bbox.getMaxX()<=35.){returnwrapAndCache(Collections.singletonList(feature1));
else{returnwrapAndCache(Arrays.asList(feature1,feature2));
ifthispropertyisnull,GeoServerAbstractTestSupport.oneTimeSetUp()//willblowawayourchangesSystem.setProperty("org.geotools.referencing.forceXY","false");//yes,weneedthistooHints.putSystemDefault(Hints.FORCE_LONGITUDE_FIRST_AXIS_ORDER,false);//
ifthisissettoanythingbut"http",GeoServerAbstractTestSupport.oneTimeSetUp()//willblowawayourchangesHints.putSystemDefault(Hints.FORCE_AXIS_ORDER_HONORING,"http");//applychangesCRS.reset("all");doSetup();
if(username!=null){Stringtoken=username+":";
if(password!=null){token+=password;
if(valueinstanceofString){request.addParameter(key,(String)value);
else{String[]values=(String[])value;request.addParameter(key,values);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("settingup"+width+"x"+height+"image");
if(!mapContent.isTransparent()){graphic.setColor(mapContent.getBgColor());graphic.fillRect(0,0,width,height);
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("settingtotransparent");
if(ENCODE_TILING_PATTERNS){renderer=newPDFStreamingRenderer();
else{renderer=newStreamingRenderer();
ifwesetittotruethenitdoesitalltwice...java.util.MaprendererParams=newHashMap();rendererParams.put("optimizedDataLoadingEnabled",newBoolean(true));rendererParams.put("renderingBuffer",newInteger(mapContent.getBuffer()));//weneedtherenderertodraweverythingonthebatikprovidedgraphicsobjectrendererParams.put(StreamingRenderer.OPTIMIZE_FTS_RENDERING_KEY,Boolean.FALSE);//rendereverythinginvectorform
ifpossiblerendererParams.put(StreamingRenderer.VECTOR_RENDERING_KEY,Boolean.TRUE);
if(DefaultWebMapService.isLineWidthOptimizationEnabled()){rendererParams.put(StreamingRenderer.LINE_WIDTH_OPTIMIZATION_KEY,true);
if(watermark!=null){MapDecorationLayoutlayout=newMapDecorationLayout();layout.paint(graphic,paintArea,mapContent);
ifanonignorableerroroccurred
if(nonIgnorableExceptionListener.exceptionOccurred()){ExceptionrenderError=nonIgnorableExceptionListener.getException();thrownewServiceException("Renderingprocessfailed",renderError,"internalError");
iftoomanyerrorsoccurred
if(errorChecker.exceedsMaxErrors()){thrownewServiceException("Morethan"+maxErrors+"renderingerrorsoccurred,bailingout",errorChecker.getLastException(),"internalError");
if(memoryChecker.exceedsMaxSize()){longkbMax=maxMemory/KB;thrownewServiceException("Renderingrequestusedmorememorythanthemaximumallowed:"+kbMax+"KB");
if(graphicsinstanceofPdfGraphics2D&&(graphicFillinstanceofIconStyle2D||isMarkNonHatchFill(graphicFill))){fillShapeAsPattern((PdfGraphics2D)graphics,shape,graphicFill,scale);
else{super.paintGraphicFill(graphics,shape,graphicFill,scale);
if(!(graphicFillinstanceofMarkStyle2D)){returnfalse;
if(OPTIMIZE_VECTOR_HATCH_FILLS){MarkStyle2Dms=(MarkStyle2D)graphicFill;ParallelLinesFillerfiller=ParallelLinesFiller.fromStipple(ms.getShape());
if(filler!=null){returnfalse;
if(!pathIterator.isDone()){//walkthepathwhile(!pathIterator.isDone()){intsegtype=pathIterator.currentSegment(coords);
switch(segtype){casePathIterator.SEG_MOVETO:cb.moveTo(coords[0],coords[1]);break;casePathIterator.SEG_LINETO:cb.lineTo(coords[0],coords[1]);break;casePathIterator.SEG_QUADTO:cb.curveTo(coords[0],coords[1],coords[2],coords[3]);break;casePathIterator.SEG_CUBICTO:cb.curveTo(coords[0],coords[1],coords[2],coords[3],coords[4],coords[5]);break;casePathIterator.SEG_CLOSE:cb.closePath();break;
if(pathIterator.getWindingRule()==PathIterator.WIND_EVEN_ODD){cb.eoFill();
else{cb.fill();
if(pattern==null){pattern=buildPattern(graphicFill,content,scale);patternCache.put(graphicFill,pattern);
if(graphicFillinstanceofIconStyle2D){finalIconicon=((IconStyle2D)graphicFill).getIcon();intwidth=icon.getIconWidth();intheight=icon.getIconHeight();pattern=content.createPattern(width,height);Graphics2DpatternGraphic=pattern.createGraphics(width,height);icon.paintIcon(null,patternGraphic,0,0);patternGraphic.dispose();
else
if(graphicFillinstanceofMarkStyle2D){MarkStyle2Dmark=(MarkStyle2D)graphicFill;intsize=(int)Math.round(mark.getSize());pattern=content.createPattern(size,size);Graphics2DpatternGraphic=pattern.createGraphics(size,size);GeometryFactorygeomFactory=newGeometryFactory();CoordinatestippleCoord=newCoordinate(size/2d,size/2d);GeometrystipplePoint=geomFactory.createPoint(stippleCoord);DecimatornullDecimator=newDecimator(-1,-1);AffineTransform2DidentityTransf=newAffineTransform2D(newAffineTransform());try{paint(patternGraphic,newLiteShape2(stipplePoint,identityTransf,nullDecimator,false),mark,scale);
else{thrownewIllegalArgumentException("Unsupportedstyle"+graphicFill);
ifnoforcingisneeded)*/protectedCoordinateReferenceSystemdeclaredCRS;/**HowtohandleSRS*/protectedProjectionPolicysrsHandling;/**FeatureTypeInfometadatatopasstoextensionswithintheQuery**/protectedMetadataMapmetadata;/***Distanceusedforcurvelinearizationtolerance,asanabsolutevalueexpressedinthedata*nativeCRS*/protectedDoublelinearizationTolerance;/***CreatesanewGeoServerFeatureSourceobject.**@paramsourceGeoTools2FeatureSource*@paramschemaSimpleFeatureTypereturnedbythisFeatureSource*@paramdefinitionQueryFilterusedtolimitresults*@paramdeclaredCRSGeometrieswillbeforcedorprojectedtothisCRS*@paramlinearizationToleranceDistanceusedforcurvelinearizationtolerance,asanabsolute*valueexpressedinthedatanativeCRS*/GeoServerFeatureSource(FeatureSource<SimpleFeatureType,SimpleFeature>source,SimpleFeatureTypeschema,FilterdefinitionQuery,CoordinateReferenceSystemdeclaredCRS,intsrsHandling,DoublelinearizationTolerance,MetadataMapmetadata){this(source,newSettings(schema,definitionQuery,declaredCRS,srsHandling,linearizationTolerance,metadata));
if(this.definitionQuery==null){this.definitionQuery=Filter.INCLUDE;
if(featureSourceinstanceofFeatureLocking){returnnewGeoServerFeatureLocking((FeatureLocking<SimpleFeatureType,SimpleFeature>)featureSource,settings);
else
if(featureSourceinstanceofFeatureStore){returnnewGeoServerFeatureStore((FeatureStore<SimpleFeatureType,SimpleFeature>)featureSource,settings);
if((query==Query.ALL)||query.equals(Query.ALL)){returnquery;
if(query.getSortBy()!=null){defQuery.setSortBy(query.getSortBy());
if(linearizationTolerance!=null){query.getHints().put(Hints.LINEARIZATION_TOLERANCE,linearizationTolerance);
if(query.retrieveAllProperties()){List<String>props=newArrayList();for(inti=0;i<schema.getAttributeCount();i++){AttributeDescriptoratt=schema.getDescriptor(i);//
ifthisisajoinedattribute,don'tincludeit//TODO:makethisabettercheck,actuallyverifyitvsthequeryobject
if(Feature.class.isAssignableFrom(att.getType().getBinding())&&!query.getJoins().isEmpty()){continue;
else{String[]queriedAtts=query.getPropertyNames();intqueriedAttCount=queriedAtts.length;ListallowedAtts=newLinkedList();for(inti=0;i<queriedAttCount;i++){
if(schema.getDescriptor(queriedAtts[i])!=null){allowedAtts.add(queriedAtts[i]);
else{LOGGER.info("queriedanotallowedproperty:"+queriedAtts[i]+".Ommittingitfromquery");
if(definitionQuery!=Filter.INCLUDE){newFilter=ff.and(definitionQuery,filter);
iftheunderlyingstoredoesnotdosorting//thenweneedtoapplyitafterthefactSortBy[]sortBy=query.getSortBy();Integeroffset=null,maxFeatures=null;
if(sortBy!=null&&sortBy!=SortBy.UNSORTED){
if(!source.getQueryCapabilities().supportsSorting(sortBy)){query.setSortBy(null);//
ifpagingisinandwecannotdosortingnatively//weshouldnotletthedatastorehandleit:weneedtosortfirst,then//pageonitoffset=query.getStartIndex();maxFeatures=query.getMaxFeatures()==Integer.MAX_VALUE?null:query.getMaxFeatures();query.setStartIndex(null);query.setMaxFeatures(Query.DEFAULT_MAX);
else{sortBy=null;
iftheunderlyingstoredoesnotdooffsetsthen//weneedtoapplyitafterthefactalongwithmaxfeatures
if(query.getStartIndex()!=null){
if(!source.getQueryCapabilities().isOffsetSupported()){offset=query.getStartIndex();maxFeatures=query.getMaxFeatures()==Integer.MAX_VALUE?null:query.getMaxFeatures();query.setStartIndex(null);query.setMaxFeatures(Query.DEFAULT_MAX);
ifnecessary
if(sortBy!=null&&sortBy!=SortBy.UNSORTED){fc=newSortedSimpleFeatureCollection(fc,sortBy);
ifnecessary
if(offset!=null||maxFeatures!=null){fc=newMaxSimpleFeatureCollection(fc,offset==null?0:offset,maxFeatures==null?Integer.MAX_VALUE:maxFeatures);
ifnogeometryinvolved,noreprojectionneeded
if(geom==null)returnquery;try{//defaultCRS:theCRSwecanassumegeometryandbboxelementsinfilterare//thatis,usuallythedeclaredone,butthenativeoneintheleavecaseCoordinateReferenceSystemdefaultCRS=null;//weneedtoreprojectallbboxandgeometriestoatargetcrs,whichis//thenativeoneusually,butit'sthedeclaredonintheforcecase(sincein//thatcasewecompletelyignorethenativeone)CoordinateReferenceSystemtargetCRS=null;CoordinateReferenceSystemnativeCRS=geom.getCoordinateReferenceSystem();
if(srsHandling==ProjectionPolicy.FORCE_DECLARED){defaultCRS=declaredCRS;targetCRS=declaredCRS;nativeFeatureType=FeatureTypes.transform(nativeFeatureType,declaredCRS);
else
if(srsHandling==ProjectionPolicy.REPROJECT_TO_DECLARED){defaultCRS=declaredCRS;targetCRS=nativeCRS;
else{//FeatureTypeInfo.LEAVEdefaultCRS=nativeCRS;targetCRS=nativeCRS;
ifany(canbenull,inthatcaseonlytheprojectionpolicyisapplied)*/protectedSimpleFeatureCollectionapplyProjectionPolicies(CoordinateReferenceSystemtargetCRS,SimpleFeatureCollectionfc)throwsIOException,SchemaException,TransformException,OperationNotFoundException,FactoryException{
if(fc.getSchema().getGeometryDescriptor()==null){//reprojectionandcrsforcingdonotmakesense,bailoutreturnfc;
if(nativeCRS==null){
if(declaredCRS!=null){fc=newForceCoordinateSystemFeatureResults(fc,declaredCRS);nativeCRS=declaredCRS;
else
if(srsHandling==ProjectionPolicy.FORCE_DECLARED&&!nativeCRS.equals(declaredCRS)){fc=newForceCoordinateSystemFeatureResults(fc,declaredCRS);nativeCRS=declaredCRS;
else
if(srsHandling==ProjectionPolicy.REPROJECT_TO_DECLARED&&targetCRS==null&&!nativeCRS.equals(declaredCRS)){fc=newReprojectFeatureResults(fc,declaredCRS);
if(targetCRS!=null){//reprojectionisoccuring
if(nativeCRS==null){//wedonotknowwhatthenativecrswhichmeanswecan//notbesure
ifweshouldreprojectornot...sowego//aheadandreprojectregardlessfc=newReprojectFeatureResults(fc,targetCRS);
else{//onlyreproject
ifnative!=target
if(!CRS.equalsIgnoreMetadata(nativeCRS,targetCRS)){fc=newReprojectFeatureResults(fc,targetCRS);
ifneeded,reprojectthefiltertothenativesrsQuerynewQuery=makeDefinitionQuery(query,schema);////see
iftheCRSgotxferedover////a.oldhadaCRS,newdoesnt//booleanrequireXferCRS=(newQuery.getCoordinateSystem()==null)//&&(query.getCoordinateSystem()!=null);////
if((newQuery.getCoordinateSystem()!=null)&&(query.getCoordinateSystem()!=//null)){////b.bothhaveCRS,butthey'redifferent//requireXferCRS=//!(newQuery.getCoordinateSystem().equals(query.getCoordinateSystem()));//
if(requireXferCRS){////carryalongtheCRS//
if(!(newQueryinstanceofQuery)){//newQuery=newQuery(newQuery);//
iftheywill//reprojectornot.//AA:addedforcecoordinatesystemresetaswell,sincewecannot//trustGT2datastoresthereneither.
if(newQuery.getCoordinateSystemReproject()!=null){newQuery.setCoordinateSystemReproject(null);
if(newQuery.getCoordinateSystem()!=null){newQuery.setCoordinateSystem(null);
ifnooptimizationsexist.*@throwsIOExceptionIfboundsofdefinitionQuery*/publicReferencedEnvelopegetBounds()throwsIOException{//sinceCRSisatmostforced,wedon'tneedtochangethiscode
if(definitionQuery==Filter.INCLUDE){returnsource.getBounds();
else{Queryquery=newQuery(getSchema().getTypeName(),definitionQuery);returnsource.getBounds(query);
ifithastoitteratethroughalltheresultstodoso.**@paramqueryUser'squery*@returnExtendofQueryor<code>null</code>
ifnooptimizationisavailable*@throwsIOExceptionIfaproblemisencounteredwithsource*/publicReferencedEnvelopegetBounds(Queryquery)throwsIOException{//sinceCRSisatmostforced,wedon'tneedtochangethiscodetry{query=makeDefinitionQuery(query,schema);
ifithastoitteratethroughalltheresultstodoso).**@paramqueryUser'squery.*@returnNumberofFeaturesforQuery,or-1
ifnooptimizationisavailable.*/publicintgetCount(Queryquery){try{query=makeDefinitionQuery(query,schema);
ifnecessaryreturnnewQueryCapabilitiesDecorator(source.getQueryCapabilities()){@OverridepublicbooleanisOffsetSupported(){returntrue;
if(property==LAYER_TYPE){returntypeLink(id,itemModel);
if(property==LAYER){returnlayerLink(id,itemModel);
if(property==DEFAULT_STYLE){returndefaultStyleCheckbox(id,itemModel);
if(property==STYLE){returnstyleLink(id,itemModel);
if(property==REMOVE){returnremoveLink(id,itemModel);
ifthestyleisthedefaultandthecurrentstylenameLayerGroupEntryentry=itemModel.getObject();StringstyleName=null;booleandefaultStyle=true;
if(entry.getStyle()!=null){styleName=entry.getStyle().getName();defaultStyle=false;
else
if(entry.getLayer()instanceofLayerInfo){LayerInfolayer=(LayerInfo)entry.getLayer();
if(layer.getDefaultStyle()!=null){styleName=layer.getDefaultStyle().getName();
ifthestyleisthedefaultSimpleAjaxLink<String>link=newSimpleAjaxLink<String>(id,newModel<String>(styleName)){privatestaticfinallongserialVersionUID=4677068931971673637L;@OverridepublicvoidonClick(AjaxRequestTargettarget){popupWindow.setInitialHeight(375);popupWindow.setInitialWidth(525);popupWindow.setTitle(newParamResourceModel("chooseStyle",this));popupWindow.setContent(newStyleListPanel(popupWindow.getContentId()){privatestaticfinallongserialVersionUID=-8463999379475701401L;@OverrideprotectedvoidhandleStyle(StyleInfostyle,AjaxRequestTargettarget){popupWindow.close(target);LayerGroupEntryentry=(LayerGroupEntry)itemModel.getObject();entry.setStyle(style);//redrawtarget.add(layerTable);
if(String.class.isAssignableFrom(scopeAsObject.getClass())){StringscopeAsString=(String)scopeAsObject;Collections.addAll(scope,scopeAsString.split(""));
else
if(Collection.class.isAssignableFrom(scopeAsObject.getClass())){Collection<String>scopes=(Collection<String>)scopeAsObject;scope.addAll(scopes);
if(exceptions==null){//usedefaulthandleXmlException(exception,request);return;
if(JSONType.isJsonMimeType(exceptions)){//useJsonformatJSONType.handleJsonException(LOGGER,exception,request,charset,verbose,false);return;
else
if(JSONType.useJsonp(exceptions)){//useJsonPformatJSONType.handleJsonException(LOGGER,exception,request,charset,verbose,true);return;
else
if(isImageExceptionType(exceptions)){//ok,it'simage,thenwehavetobuildatextrepresentingthe//exceptionandlayitoutintheimagetry{width=(Integer)request.getKvp().get("WIDTH");height=(Integer)request.getKvp().get("HEIGHT");format=(String)request.getKvp().get("FORMAT");bgcolor=(Color)request.getKvp().get("BGCOLOR");transparent=(Boolean)request.getKvp().get("TRANSPARENT");
if(width>0&&height>0&&FORMATS.contains(format)){handleImageException(exception,request,width,height,format,exceptions,bgcolor,transparent);return;
else{//usedefaulthandleXmlException(exception,request);
else
if(isPartialMapExceptionType(exceptions)){try{format=(String)request.getKvp().get("FORMAT");
if(exceptioninstanceofWMSPartialMapException&&FORMATS.contains(format)){handlePartialMapException(exception,request,format);
else{handleXmlException(exception,request);
else{//usedefaulthandleXmlException(exception,request);
if(("BLANK".equals(exceptionFormat)||"application/vnd.ogc.se_blank".equals(exceptionFormat))&&bgcolor==null&&Boolean.TRUE.equals(transparent)){bgcolor=newColor(0,0,0,0);
if(bgcolor==null){bgcolor=Color.WHITE;
if(!("BLANK".equals(exceptionFormat)||"application/vnd.ogc.se_blank".equals(exceptionFormat))){//wms1.3onlyg.setColor(Color.BLACK);//drawtheexceptiontext(giveitagoodoffsetsothatitcanberead//properlyintheOLpreviewaswell)paintLines(g,buildImageExceptionText(exception),width-2,35,5);
if("image/png8".equals(format)){response.setContentType("image/png");
else{response.setContentType(format);
if("image/png8".equals(format)){response.setContentType("image/png");
else{response.setContentType(format);
if(version==WMS.VERSION_1_1_1){//usedtdstyledtdLocation="wms/1.1.1/WMS_exception_1_1_1.dtd";contentType="application/vnd.ogc.se_xml";
else{//usexmlschemaschemaLocation="wms/1.3.0/exceptions_1_3_0.xsd";contentType="text/xml";
if(dtdLocation!=null){sb.append("standalone=\"no\"");
if(dtdLocation!=null){StringfullDtdLocation=buildSchemaURL(baseURL(request.getHttpRequest()),dtdLocation);sb.append("<!DOCTYPEServiceExceptionReportSYSTEM\""+fullDtdLocation+"\">");
if((schemaLocation!=null)&&(dtdLocation==null)){StringfullSchemaLocation=buildSchemaURL(baseURL(request.getHttpRequest()),schemaLocation);sb.append("xmlns=\"http://www.opengis.net/ogc\"");sb.append("xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"");sb.append("xsi:schemaLocation=\"http://www.opengis.net/ogc"+fullSchemaLocation+"\"");
if((exception.getCode()!=null)&&!exception.getCode().equals("")){sb.append("code=\""+exception.getCode()+"\"");
if((exception.getLocator()!=null)&&!exception.getLocator().equals("")){sb.append("locator=\""+ResponseUtils.encodeXML(exception.getLocator())+"\"");
if((exception.getMessage()!=null)){sb.append("\n"+tab+tab);OwsUtils.dumpExceptionMessages(exception,sb,true);
if(geoServer.getSettings().isVerboseExceptions()){ByteArrayOutputStreamstackTrace=newByteArrayOutputStream();exception.printStackTrace(newPrintStream(stackTrace));sb.append("\nDetails:\n");sb.append(ResponseUtils.encodeXML(newString(stackTrace.toByteArray())));
if((exception.getCode()!=null)&&!exception.getCode().equals("")){sb.append("code=\""+exception.getCode()+"\"");
if((exception.getLocator()!=null)&&!exception.getLocator().equals("")){sb.append("locator=\""+exception.getLocator()+"\"");
if((exception.getMessage()!=null)){OwsUtils.dumpExceptionMessages(exception,sb,false);
if(geoServer.getSettings().isVerboseExceptions()){ByteArrayOutputStreamstackTrace=newByteArrayOutputStream();exception.printStackTrace(newPrintStream(stackTrace));sb.append("\nDetails:\n");sb.append(newString(stackTrace.toByteArray()));
if("".equals(line)){cursor.y+=lineHeight;
else{AttributedStringstyledText=newAttributedString(line);LineBreakMeasurermeasurer=newLineBreakMeasurer(styledText.getIterator(),frc);while(measurer.getPosition()<line.length()){TextLayoutlayout=measurer.nextLayout(lineWidth-startX);cursor.y+=(layout.getAscent());floatdx=layout.isLeftToRight()?0:(lineWidth-layout.getAdvance());layout.draw(g,cursor.x+dx,cursor.y);cursor.y+=layout.getDescent()+layout.getLeading();
if(signalArgs!=null&&signalArgs.get("topic")!=null)returnsignalArgs.get("topic").equals("log");returnfalse;
if(coverage!=null){ImageUtilities.disposeImage(coverage.getRenderedImage());
if(reader!=null){reader.dispose();
if(groupInfo==null){LayerInfolayerInfo=wms.getLayerByName(layerName);
if(layerInfo==null){thrownewServiceException("Unknownlayer:"+layerName);
if(slinstanceofNamedLayer){NamedLayernamedLayer=((NamedLayer)sl);currLayer.setLayerFeatureConstraints(namedLayer.getLayerFeatureConstraints());
if(request.getFilter()==null){request.setFilter(newArrayList());
if(filter==null){filter=Filter.INCLUDE;
if(s==null){StringfailMessage="couldn'tfindstylenamed'"+namedStyle.getName()+"'";
if(currLayer.getType()==MapLayerInfo.TYPE_RASTER){//hmm,well,thestyletheyspecifiedinthewmsrequestwasn'tfound.//Let'strythedefaultrasterstylenamed'raster's=catalog.getStyleByName("raster");
if(s==null){//nope,nodefaultrasterstyleeither.Giveup.thrownewServiceException(failMessage+"Alsotriedtouse"+"thegenericrasterstyle'raster',butitwasn'tavailable.");
else{thrownewServiceException(failMessage);
if(currLayer!=null){try{layers.add(currLayer);styles.add(s.getStyle());
if(currLayer!=null){layers.add(currLayer);styles.add(userStyle);
else
if(info!=null&&infoinstanceofLayerInfo){layers.add(newMapLayerInfo((LayerInfo)info));styles.add(userStyle);
if(request.getUpdateSequence()!=null){try{reqUS=Long.parseLong(request.getUpdateSequence());
if(reqUS>geoUS){thrownewServiceException("ClientsuppliedanupdateSequencethatisgreaterthanthecurrentseverupdateSequence","InvalidUpdateSequence");
if(reqUS==geoUS){thrownewServiceException("WFScapabilitiesdocumentiscurrent(updateSequence="+geoUS+")","CurrentUpdateSequence");
if(oflist.contains(first)){oflist.remove(first);oflist.add(0,first);
if("xml".equals(prefix)){continue;
if(sectionNames==null||sectionNames.isEmpty()){returnALL_SECTIONS;
if(sections.contains(Sections.All)){returnALL_SECTIONS;
if("xml".equals(prefix)){continue;
if(kwlist==null){handleKeywords((List)null);
else{handleKeywords(Arrays.asList(kwlist));
if(i!=(kwlist.size()-1)){kwds.append(",");
if(wfs.getServiceLevel().contains(WFSInfo.ServiceLevel.TRANSACTIONAL)){handleTransaction();
if(wfs.getServiceLevel().contains(WFSInfo.ServiceLevel.COMPLETE)){handleLock();handleFeatureWithLock();
if(wfs.isCiteCompliant()){element("GML2",null);
else{//FULLMONTYCollectionfeatureProducers=GeoServerExtensions.extensions(WFSGetFeatureOutputFormat.class);Mapdupes=newHashMap();for(Iteratori=featureProducers.iterator();i.hasNext();){WFSGetFeatureOutputFormatformat=(WFSGetFeatureOutputFormat)i.next();for(Stringname:format.getCapabilitiesElementNames()){
if(!dupes.containsKey(name)){element(name,null);dupes.put(name,newObject());
if(HTTP_GET.equals(httpMethod)){onlineResource=buildURL(request.getBaseUrl(),"wfs",params("request",capabilityName),URLType.SERVICE);
else{//makesureitendswith?onlineResource=buildURL(request.getBaseUrl(),"wfs",null,URLType.SERVICE);appendQueryString(onlineResource,"");
if(!wfs.isEnabled()){//shouldwereturnanything
ifwearedisabled?
if((wfs.getServiceLevel().contains(WFSInfo.ServiceLevel.BASIC))){element("Query",null);
if((wfs.getServiceLevel().getOps().contains(WFSInfo.Operation.TRANSACTION_INSERT))){element("Insert",null);
if((wfs.getServiceLevel().getOps().contains(WFSInfo.Operation.TRANSACTION_UPDATE))){element("Update",null);
if((wfs.getServiceLevel().getOps().contains(WFSInfo.Operation.TRANSACTION_DELETE))){element("Delete",null);
if((wfs.getServiceLevel().getOps().contains(WFSInfo.Operation.LOCKFEATURE))){element("Lock",null);
if(!ft.enabled())it.remove();
ifanamespacefilterhasbeenset
if(request.getNamespace()!=null){Stringnamespace=request.getNamespace();for(Iteratorit=featureTypes.iterator();it.hasNext();){FeatureTypeInfoft=(FeatureTypeInfo)it.next();
if(!namespace.equals(ft.getNamespace().getPrefix()))it.remove();
if(skipMisconfigured){reset();LOGGER.log(Level.WARNING,"Couldn'tencodeWFSCapabilitiesentryforFeatureType:"+ftype.getPrefixedName(),e);
else{throwe;
ifwe'regoingtobeproducingcapabilities//documentsthataren'tqualified,andIdon'tseeanyreasonto//dothat.start(ogc+"Filter_Capabilities");start(ogc+"Spatial_Capabilities");start(ogc+"Spatial_Operators");element(ogc+"Disjoint",null);element(ogc+"Equals",null);element(ogc+"DWithin",null);element(ogc+"Beyond",null);element(ogc+"Intersect",null);element(ogc+"Touches",null);element(ogc+"Crosses",null);element(ogc+"Within",null);element(ogc+"Contains",null);element(ogc+"Overlaps",null);element(ogc+"BBOX",null);end(ogc+"Spatial_Operators");end(ogc+"Spatial_Capabilities");start(ogc+"Scalar_Capabilities");element(ogc+"Logical_Operators",null);start(ogc+"Comparison_Operators");element(ogc+"Simple_Comparisons",null);element(ogc+"Between",null);element(ogc+"Like",null);element(ogc+"NullCheck",null);end(ogc+"Comparison_Operators");start(ogc+"Arithmetic_Operators");element(ogc+"Simple_Arithmetic",null);handleFunctions(ogc);//djb:listfunctionsend(ogc+"Arithmetic_Operators");end(ogc+"Scalar_Capabilities");end(ogc+"Filter_Capabilities");
if(wfs.isCanonicalSchemaLocation()){schemaLocation.append(org.geoserver.wfs.xml.v1_1_0.WFS.CANONICAL_SCHEMA_LOCATION);
else{schemaLocation.append(buildSchemaURL(request.getBaseUrl(),"wfs/1.1.0/wfs.xsd"));
if("xml".equals(prefix))continue;attributes.addAttribute(null,null,"xmlns:"+prefix,null,getNamespaceSupport().getURI(prefix));
if(sections.contains(Sections.ServiceIdentification)){serviceIdentification();
if(sections.contains(Sections.ServiceProvider)){serviceProvider(wfs.getGeoServer());
if(sections.contains(Sections.OperationsMetadata)){operationsMetadata();
if(sections.contains(Sections.FeatureTypeList)){featureTypeList();
if(sections.contains(Sections.Filter_Capabilities)){filterCapabilities();
if(gtVersion.compareTo(newVersion("2"))>=0){LinkedHashSet<String>profiles=newLinkedHashSet<>();for(WFSExtendedCapabilitiesProviderprovider:extCapsProviders){List<String>providerProfiles=provider.getProfiles(gtVersion);profiles.addAll(providerProfiles);
if(wfs.getServiceLevel().contains(WFSInfo.ServiceLevel.COMPLETE)){operations.add(lockFeature());operations.add(getFeatureWithLock());
if(wfs.getServiceLevel().contains(WFSInfo.ServiceLevel.TRANSACTIONAL)){operations.add(transaction());
if((wfs.getServiceLevel().contains(WFSInfo.ServiceLevel.BASIC))){element("Operation","Query");
if((wfs.getServiceLevel().getOps().contains(WFSInfo.Operation.TRANSACTION_INSERT))){element("Operation","Insert");
if((wfs.getServiceLevel().getOps().contains(WFSInfo.Operation.TRANSACTION_UPDATE))){element("Operation","Update");
if((wfs.getServiceLevel().getOps().contains(WFSInfo.Operation.TRANSACTION_DELETE))){element("Operation","Delete");
if((wfs.getServiceLevel().getOps().contains(WFSInfo.Operation.LOCKFEATURE))){element("Operation","Lock");
if(!ft.enabled())it.remove();
ifanamespacefilterhasbeenset
if(namespace!=null){for(Iteratorit=featureTypes.iterator();it.hasNext();){FeatureTypeInfoft=(FeatureTypeInfo)it.next();
if(!namespace.equals(ft.getNamespace().getPrefix()))it.remove();
if(featureType.enabled()){try{mark();featureType(featureType,crs);commit();
if(skipMisconfigured){reset();LOGGER.log(Level.WARNING,"Couldn'tencodeWFScapabilitiesentryforfeaturetype:"+featureType.getPrefixedName(),ex);
else{throwex;
ifnot*otherwiseexplicitlyidentifiedwithinaquery*ortransactionrequest.TheSRSmaybeindicated*usingeithertheEPSGform(EPSG:posccode)or*theURLformdefinedinsubclause4.3.2of*refernce[2].*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:element&gt;*&lt;xsd:elementname="OtherSRS"*type="xsd:anyURI"*minOccurs="0"maxOccurs="unbounded"&gt;*&lt;xsd:annotation&gt;*&lt;xsd:documentation&gt;*TheOtherSRSelementisusedtoindicateother*supportedSRSswithinqueryandtransaction*operations.AsupportedSRSmeansthatthe*WFSsupportsthetransformationofspatial*propertiesbetweentheOtherSRSandtheinternal*storageSRS.Theeffectsofsuchtransformations*mustbeconsideredwhendetermininganddeclaring*theguaranteeddataaccuracy.*&lt;/xsd:documentation&gt;*&lt;/xsd:annotation&gt;*&lt;/xsd:element&gt;*&lt;/xsd:sequence&gt;*&lt;xsd:elementname="NoSRS"&gt;*&lt;xsd:complexType/&gt;*&lt;/xsd:element&gt;*&lt;/xsd:choice&gt;*&lt;xsd:elementname="Operations"*type="wfs:OperationsType"*minOccurs="0"/&gt;*&lt;xsd:elementname="OutputFormats"*type="wfs:OutputFormatListType"*minOccurs="0"/&gt;*&lt;xsd:elementref="ows:WGS84BoundingBox"*minOccurs="1"maxOccurs="unbounded"/&gt;*&lt;xsd:elementname="MetadataURL"*type="wfs:MetadataURLType"*minOccurs="0"maxOccurs="unbounded"/&gt;*&lt;/xsd:sequence&gt;*&lt;/xsd:complexType&gt;*</pre>**@paramfeatureType*/protectedvoidfeatureType(FeatureTypeInfofeatureType,booleancrs){GMLInfogml=wfs.getGML().get(version);Stringprefix=featureType.getNamespace().getPrefix();Stringuri=featureType.getNamespace().getURI();start("FeatureType",attributes(newString[]{"xmlns:"+prefix,uri}));element("Name",featureType.getPrefixedName());element("Title",featureType.getTitle());element("Abstract",featureType.getAbstract());keywords(featureType.getKeywords());Stringsrs=featureType.getSRS();srs=applySRSNameStyle(gml,srs);//defaultsrs
if(crs){//wfs2.0element("DefaultCRS",srs);
else{element("DefaultSRS",srs);
if(otherSRS!=null){otherSRS=applySRSNameStyle(gml,otherSRS);
if(!otherSRS.equals(srs)){
if(crs){element("OtherCRS",otherSRS);
else{element("OtherSRS",otherSRS);
if(mlinks!=null&&!mlinks.isEmpty()){for(MetadataLinkInfolink:mlinks){metadataLink(link);
if(srs!=null){Stringprefix=gml.getSrsNameStyle().getPrefix();
if(srs.matches("(?ui)EPSG:[0-9]+")){srs=prefix+srs.substring(5);
else{srs=prefix+srs;
if(featureType.isOverridingServiceSRS()){extraSRS=featureType.getResponseSRS();
else{extraSRS=wfs.getSRS();
if("ISO19115:2003".equals(metadataType)){metadataType="19115";
if(!VALID_LINKS_FORMATS.contains(format)){LOGGER.log(Level.FINE,"Skippingmetadatalink"+link.getContent()+",format"+format+"isnotvalidinWFS1.1,supportedtypesare:"+VALID_LINKS_FORMATS);return;
if(!VALID_LINKS_METADATATYPES.contains(metadataType)){LOGGER.log(Level.FINE,"Skippingmetadatalink"+link.getContent()+",metadatatype"+metadataType+"isnotvalidinWFS1.1,supportedtypesare:"+VALID_LINKS_METADATATYPES);return;
if((link.getContent()==null)||link.getContent().isEmpty()){return;
if(!functions.isEmpty()){start("ogc:FunctionNames");for(FunctionNamefe:functions){element("ogc:FunctionName",fe.getName(),attributes(newString[]{"nArgs",""+fe.getArgumentCount()}));
if((keywords==null)||(keywords.length==0)){return;
if(keywords!=null){keywords((KeywordInfo[])keywords.toArray(newKeywordInfo[keywords.size()]));
if(get){element("ows:Get",null,attributes(newString[]{"xlink:href",serviceURL}));
if(post){element("ows:Post",null,attributes(newString[]{"xlink:href",serviceURL}));
if(domainType.getDefaultValue()!=null){element("ows:Value",domainType.getDefaultValue());
if(!domainType.getAllowedValues().isEmpty()){for(Stringv:domainType.getAllowedValues()){element("ows:Value",v);
if((link.getContent()==null)||link.getContent().isEmpty()){return;
if(wfs.isCanonicalSchemaLocation()){schemaLocation.append(org.geotools.wfs.v2_0.WFS.CANONICAL_SCHEMA_LOCATION);
else{schemaLocation.append(buildSchemaURL(request.getBaseUrl(),"wfs/2.0/wfs.xsd"));
if(sections.isEmpty()||sections.contains(Sections.ServiceIdentification)){delegate.serviceIdentification("2.0.0");
if(sections.isEmpty()||sections.contains(Sections.ServiceProvider)){delegate.serviceProvider(wfs.getGeoServer());
if(sections.isEmpty()||sections.contains(Sections.OperationsMetadata)){operationsMetadata();
if(sections.isEmpty()||sections.contains(Sections.FeatureTypeList)){featureTypeList();
if(sections.isEmpty()||sections.contains(Sections.Filter_Capabilities)){filterCapabilities();
if(wfs.getServiceLevel().contains(WFSInfo.ServiceLevel.COMPLETE)){operations.add(lockFeature());operations.add(getFeatureWithLock());
if(wfs.getServiceLevel().contains(WFSInfo.ServiceLevel.TRANSACTIONAL)){operations.add(transaction());
if(catalog.getFeatureTypes().isEmpty()){return;
if(prefix!=null){element("fes:Returns",prefix+":"+returnType.getLocalPart());
else{LOGGER.warning(String.format("UnabletomapfunctionreturntypetoQNamefor"+"function%s.Nonamespacemappingfor%s.",fn.getName(),returnType.getNamespaceURI()));
if(!fn.getArgumentNames().isEmpty()){start("fes:Arguments");for(Parameter<?>arg:fn.getArguments()){start("fes:Argument",attributes(newString[]{"name",arg.getName()}));NameargType=lookupTypeName(typeMappingProfiles,arg);prefix=getNamespaceSupport().getPrefix(argType.getNamespaceURI());
if(prefix!=null){element("fes:Type",prefix+":"+argType.getLocalPart());
else{LOGGER.warning(String.format("UnabletomapfunctionargumenttypetoQNamefor"+"function%s.Nonamespacemappingfor%s.",arg.getName(),argType.getNamespaceURI()));
if(!wfsExtOpsFactory.getFunctionNames().isEmpty()){//start("fes:ExtendedCapabilities");//////declarethenecessarynamespaces//NamespaceSupportextOpNamespaces=//wfsExtOpsFactory.getNamespaces();//Enumerationprefixes=extOpNamespaces.getDeclaredPrefixes();////List<String>xmlns=newArrayList();//while(prefixes.hasMoreElements()){//Stringprefix=(String)prefixes.nextElement();//
if("".equals(prefix)||"xml".equals(prefix)){//continue;//
if(domainType.isNoValues()){element("ows:NoValues",null);
if(domainType.getDefaultValue()!=null){element("ows:DefaultValue",domainType.getDefaultValue());
if(!domainType.getAllowedValues().isEmpty()){start("ows:AllowedValues");for(Stringv:domainType.getAllowedValues()){element("ows:Value",v);
if("geometry".equals(arg.getName())){returnnewNameImpl(org.geotools.gml3.v3_2.GML.AbstractGeometryType);
if(clazz==null||clazz==Object.class){returnnewNameImpl(XS.STRING);
if(at.getBinding()!=null&&at.getBinding().equals(clazz)){returnat.getName();
if(clazz.isAssignableFrom(at.getBinding())){returnat.getName();
switchforgeographiccrsfinalbooleanaxesSwitch=crsinstanceofGeographicCRS&&swapAxes;//additionalfieldsforCRSfinalCoordinateSystemcs=crs.getCoordinateSystem();finalintdimension=cs.getDimension();//loopthroughdimensionsfinalArrayList<String>retValue=newArrayList<String>();
if(!axesSwitch){for(inti=0;i<dimension;i++){CoordinateSystemAxisaxis=cs.getAxis(i);retValue.add(getAxisLabel(axis));//useaxisabbreviation
else{intnorthing=-1,easting=-1;for(inti=0;i<dimension;i++){finalCoordinateSystemAxisaxis=cs.getAxis(i);
if(Math.abs(DefaultCoordinateSystemAxis.getAngle(axis.getDirection(),DefaultCoordinateSystemAxis.LONGITUDE.getDirection()))<1E-6){easting=i;
else
if(Math.abs(DefaultCoordinateSystemAxis.getAngle(axis.getDirection(),DefaultCoordinateSystemAxis.LATITUDE.getDirection()))<1E-6){northing=i;
switchthemretValue.add(northing,retValue.remove(easting));
if(label.equals(DefaultCoordinateSystemAxis.LONGITUDE.getAbbreviation())){return"Long";
else
if(label.equals(DefaultCoordinateSystemAxis.LATITUDE.getAbbreviation())){return"Lat";
else{returnlabel;
if(getAxisLabel(axis).equals(axisAbbreviation)){pos=j;//FOUND!!!break;
if(pos<0){//NOTFOUNDreturnnull;
ifgothere,allisfinereturnreturnCreatedCollectionReference(request,eoId);
if(collectionPayload==null){thrownewRestException("collection.jsonfileismissingfromthezip",HttpStatus.BAD_REQUEST);
if(rawLinks!=null){OgcLinkslinks=parseJSON(OgcLinks.class,rawLinks);linksCollection=beansToLinksCollection(links);
else{linksCollection=null;
if(description!=null){StringdescriptionString=newString(description);fs.modifyFeatures(newNameImpl(nsURI,OpenSearchAccess.DESCRIPTION),descriptionString,filter);
if(metadata!=null){StringdescriptionString=newString(metadata);fs.modifyFeatures(OpenSearchAccess.METADATA_PROPERTY_NAME,descriptionString,filter);
if(linksCollection!=null){fs.modifyFeatures(OpenSearchAccess.OGC_LINKS_PROPERTY_NAME,linksCollection,filter);
iftheclient//istryingtochangecheckCollectionIdentifier(feature);//preparetheupdate,needtoconverteachfieldintoaName/ValuecoupleFeaturecollectionFeature=simpleToComplex(feature,getCollectionSchema(),COLLECTION_HREFS);List<Name>names=newArrayList<>();List<Object>values=newArrayList<>();for(Propertyp:collectionFeature.getProperties()){//skipoverthelarge/complexattributesthatarebeingmodifiedviaseparatecallsfinalNamepropertyName=p.getName();
if(OpenSearchAccess.METADATA_PROPERTY_NAME.equals(propertyName)||OpenSearchAccess.OGC_LINKS_PROPERTY_NAME.equals(propertyName)||OpenSearchAccess.DESCRIPTION.equals(propertyName.getLocalPart())){continue;
ifthelayerwasthereCollectionLayerpreviousLayer=getCollectionLayer(collection);//preparetheupdateSimpleFeaturelayerCollectionFeature=beanToLayerCollectionFeature(layer);Filterfilter=FF.equal(FF.property(COLLECTION_ID),FF.literal(collection),true);finalNamelayerPropertyName=getCollectionLayerPropertyName();runTransactionOnCollectionStore(fs->{fs.modifyFeatures(layerPropertyName,layerCollectionFeature,filter);});//thisisdoneafterthechangesintheDBtomakesureit'sreadingthesamedata//weareinserting(featuresourcesdonotacceptatransaction...)CollectionLayerManagerlayerManager=newCollectionLayerManager(catalog,accessProvider);
if(previousLayer!=null){layerManager.removeMosaicAndLayer(previousLayer);
ifwehavetoreturnacreationornot
if(previousLayer!=null){returnnewResponseEntity<>(HttpStatus.OK);
else{returnnewResponseEntity<>(HttpStatus.CREATED);
if(layer==null&&notFoundOnEmpty){thrownewResourceNotFoundException();
if(layer.getWorkspace()==null){thrownewRestException("Invalidlayerconfiguration,workspacenameismissingornull",HttpStatus.BAD_REQUEST);
if(catalog.getWorkspaceByName(layer.getWorkspace())==null){thrownewRestException("Invalidlayerconfiguration,workspace'"+layer.getWorkspace()+"'doesnotexist",HttpStatus.BAD_REQUEST);
if(layer.getLayer()==null){thrownewRestException("Invalidlayerconfiguration,layernameismissingornull",HttpStatus.BAD_REQUEST);
if(layer.isSeparateBands()){
if(layer.getBands()==null||layer.getBands().length==0){thrownewRestException("Invalidlayerconfiguration,claimstohaveseparatebandsbutdoes"+"notlistthebandnames",HttpStatus.BAD_REQUEST);
if(layer.getBrowseBands()==null||layer.getBrowseBands().length==0){thrownewRestException("Invalidlayerconfiguration,claimstohaveseparatebandsbutdoesnot"+"listthebrowsebandnames(hencecannotsetupastyleforit)",HttpStatus.BAD_REQUEST);
else
if((layer.getBrowseBands().length!=3&&layer.getBrowseBands().length!=1)){thrownewRestException("Invalidlayerconfiguration,browsebandsmustbeeither"+"one(gray)orthree(RGB)",HttpStatus.BAD_REQUEST);
else
if(layer.getBands().length>0&&layer.getBrowseBands().length>0&&!containedFully(layer.getBrowseBands(),layer.getBands())){thrownewRestException("Invalidlayerconfiguration,browsebandscontainsentries"+"thatarenotpartofthebandsdeclaration",HttpStatus.BAD_REQUEST);
if(layer.isHeterogeneousCRS()){
if(layer.getMosaicCRS()==null){thrownewRestException("Invalidlayerconfiguration,mosaicisheterogeneousbutthemosaicCRSismissing",HttpStatus.BAD_REQUEST);
if(layer.getMosaicCRS()!=null){try{CRS.decode(layer.getMosaicCRS());
if(bands[j].equals(bb)){found=true;break;
if(!found){returnfalse;
ifneeded
if(previousLayer!=null){newCollectionLayerManager(catalog,accessProvider).removeMosaicAndLayer(previousLayer);
if(metadataProperty!=null&&metadataProperty.getValue()instanceofString){Stringvalue=(String)metadataProperty.getValue();response.setContentType("text/xml");StreamUtils.copy(value,Charset.forName("UTF-8"),response.getOutputStream());
else{thrownewResourceNotFoundException("Metadataforcollection'"+collection+"'couldnotbefound");
if(descriptionProperty!=null&&descriptionProperty.getValue()instanceofString){Stringvalue=(String)descriptionProperty.getValue();response.setContentType("text/html");StreamUtils.copy(value,Charset.forName("UTF-8"),response.getOutputStream());
else{thrownewResourceNotFoundException("Descriptionforcollection'"+collection+"'couldnotbefound");
if(name==null){thrownewRestException("Missingmandatoryproperty'name'",HttpStatus.BAD_REQUEST);
if(eoId==null){thrownewRestException("Missingmandatory'eo:identifier'",HttpStatus.BAD_REQUEST);
if(!eoId.equals(name)){thrownewRestException("Inconsistent,collection'name'and'eo:identifier'shouldhavethesamevalue(eventuallynamewillberemoved)",HttpStatus.BAD_REQUEST);
if(queryLayers==null){returnnull;
if(connection==null)connection=super.getConnection();returnconnection;
if(connection!=null){connection.close();connection=null;
if(role.getProperties().size()==0)return;//nothingtodoPreparedStatementps=getDMLStatement("roleprops.insert",con);try{for(Objectkey:role.getProperties().keySet()){ObjectpropertyVal=role.getProperties().get(key);ps.setString(1,role.getAuthority());ps.setString(2,key.toString());ps.setObject(3,propertyVal);ps.execute();
iftherewasanupdate
if(helper.isValidParent(role.getAuthority(),parentRole==null?null:parentRole.getAuthority())==false)thrownewIOException(parentRole.getAuthority()+"isnotavalidparentfor"+role.getAuthority());Connectioncon=null;PreparedStatementps=null;try{con=getConnection();ps=getDMLStatement("roles.parentUpdate",con);
if(parentRole==null)ps.setNull(1,Types.VARCHAR);
elseps.setString(1,parentRole.getAuthority());ps.setString(2,role.getAuthority());ps.execute();
if(String.class.isAssignableFrom(source)&&UniqueResourceIdentifiers.class.isAssignableFrom(target)){returnnewSpatialDatasetIdentifiersConverter();
else
if(String.class.isAssignableFrom(target)&&UniqueResourceIdentifiers.class.isAssignableFrom(source)){returnnewSpatialDatasetIdentifiersConverter();
if(sourceinstanceofString&&UniqueResourceIdentifiers.class.equals(target)){UniqueResourceIdentifiersidentifiers=newUniqueResourceIdentifiers();String[]values=((String)source).split("\\s*;\\s*");for(inti=0;i<values.length;i++){Stringvalue=values[i];String[]elements=value.split("\\s*,\\s*");
if(elements.length==0){continue;
if("".equals(code)){LOGGER.warning("SkippingInspireDatasetIdentifierbecausecodeisempty:"+value);continue;
if(elements.length>1){namespace=elements[1];try{newURI(namespace);
if(namespace.trim().equals("")){namespace=null;
if(elements.length>2){metadataURL=elements[2];try{newURI(metadataURL);
else
if(sourceinstanceofUniqueResourceIdentifiers&&String.class.equals(target)){UniqueResourceIdentifiersids=(UniqueResourceIdentifiers)source;
if(ids.size()>0){StringBuildersb=newStringBuilder();for(UniqueResourceIdentifierid:ids){Stringns=id.getNamespace();Stringmetadata=id.getMetadataURL();Stringcode=id.getCode();sb.append(code).append(",");
if(ns!=null){sb.append(ns);
if(metadata!=null){sb.append(metadata);
else{return(T)"";
if(selection.size()==0)return;dialog.setTitle(newParamResourceModel("confirmRemoval",this));//
ifthereissomethingtocancel,let'swarntheuseraboutwhat//couldgowrong,and
iftheuseraccepts,let'sdeletewhat'sneededdialog.showOkCancel(target,delegate=newGeoServerDialog.DialogDelegate(){privatestaticfinallongserialVersionUID=1L;protectedComponentgetContents(Stringid){//showaconfirmationpanelforalltheobjectswehavetoremovereturnremovePanel=newConfirmRemovalRolePanel(id,selection){privatestaticfinallongserialVersionUID=1L;@OverrideprotectedIModel<String>canRemove(GeoServerRolerole){returnSelectionRoleRemovalLink.this.canRemove(role);
iftheselectionhasbeenclearedoutit'ssignadeletion//occurred,sorefreshthetable
if(roles.getSelection().size()==0){setEnabled(false);target.add(SelectionRoleRemovalLink.this);target.add(roles);
if(e.getCause()instanceofAbstractSecurityException){returnnewModel(e.getCause().getMessage());
else{thrownewRuntimeException(e);
if(getProperty("enabled",Boolean.class,false)){//preparetheconfigrollLimit=getProperty("roll_limit",Integer.class,DEFAULT_ROLLING_LIMIT);path=System.getProperty("GEOSERVER_AUDIT_PATH");
if(path==null||"".equals(path.trim())){path=config.getProperty(AUDIT,"path",String.class);
if(value==null){returndefaultValue;
else{returnvalue;
if(rd==null){return;
if(dumper==null){//firstrequesteh?initDumper();
else{//notfirst,checktheconfigdidnotchange,
ifso,reinstantiatethedumperbooleanenabled=getProperty("enabled",Boolean.class,false);
if(!enabled){closeDumper(dumper);dumper=null;
else{intnewLimit=getProperty("roll_limit",Integer.class,DEFAULT_ROLLING_LIMIT);StringnewPath=getProperty("path",String.class,null);StringnewHeaderTemplate=getProperty("ftl.header",String.class,null);StringnewContentTemplate=getProperty("ftl.content",String.class,null);StringnewFooterTemplate=getProperty("ftl.footer",String.class,null);//thecomparisonofnewTemplateNameusing!=isintended,worksfinewithnulls//andthestringswegetdonotchangeunlessthepropertyfilehasbeen//reloaded.Wealsorework
ifthedumperdiedforsomereason(e.g.,improper//config,invalidtemplates)
if(newLimit!=rollLimit||newPath!=path||newHeaderTemplate!=headerTemplate||newContentTemplate!=contentTemplate||newFooterTemplate!=footerTemplate||!dumper.isAlive()){//configchanged,closethecurrentdumperandcreateanewonecloseDumper(dumper);dumper=null;initDumper();
ifwehaveadumper,addintheloggingqueue
if(dumper!=null){
if(!dumper.queue.offer(rd)){LOGGER.log(Level.WARNING,"Auditingsubsystemoverload,theloggingqueueisfull,stoppingtheworldonit");dumper.queue.put(rd);
if(eventinstanceofContextClosedEvent){closeDumper(dumper);
if(dumper!=null){dumper.exit();try{dumper.join(5000);
if(queue.size()>0){queue.drainTo(rds);
else{rds.add(queue.take());
ifnecessarywriter=rollWriter(writer);//getthetemplateTemplatetemplate=templateConfig.getTemplate(contentTemplate);//writeouteachoftherequestdatafor(RequestDatard:rds){
if(rd==END_MARKER){return;
if(writer!=null){writer.flush();
if(LOGGER.isLoggable(Level.WARNING))LOGGER.log(Level.WARNING,"RequestDumperexitingdueto:"+e.getLocalizedMessage(),e);
ifnecessary**@paramwriter*@throwsIOException*/BufferedWriterrollWriter(BufferedWriterwriter)throwsException{//getdatefinalGregorianCalendarcurrent=newGregorianCalendar(TimeZone.getTimeZone("GMT"));//check
ifwehavetoclosethefileandreopenitforrolling
if(this.lineCounter>=lineRollingLimit||(day>0&&day!=current.get(GregorianCalendar.DAY_OF_YEAR))||(logFile!=null&&!logFile.exists())){closeWriter(writer);//playwithcountersthis.fileRollCounter++;this.lineCounter=0;//cleanwriter=null;
if(writer==null){//createproperfiletowritetofinalSimpleDateFormatdateFormat=newSimpleDateFormat("yyyyMMdd");dateFormat.setTimeZone(TimeZone.getTimeZone("GMT"));finalStringauditFileName="geoserver_audit_"+dateFormat.format(current.getTime())+"_";//lookforsimilarfilestopickupnumbering
if(fileRollCounter==0){finalString[]files=path.list(makeFileOnly(andFileFilter(prefixFileFilter("geoserver_audit_"),suffixFileFilter(".log"))));
if(files!=null&&files.length>0){Arrays.sort(files,newComparator<String>(){@Overridepublicintcompare(Stringo1,Stringo2){//extractdatesandcomparefinalString[]o1s=o1.substring(0,o1.length()-4).split("_");finalString[]o2s=o2.substring(0,o2.length()-4).split("_");intdateCompare;try{dateCompare=dateFormat.parse(o1s[2]).compareTo(dateFormat.parse(o2s[2]));
if(dateCompare==0){//comparecounterreturnInteger.valueOf(o1s[3]).compareTo(Integer.valueOf(o2s[3]));
elsereturndateCompare;
if(!logFile.exists()&&!this.logFile.createNewFile()){thrownewIllegalStateException("Unabletocreatemonitoringfile:"+logFile.getCanonicalPath());
if(writer!=null){Templatetemplate=templateConfig.getTemplate(footerTemplate);template.process(null,writer);writer.flush();
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,e.getLocalizedMessage(),e);
if(writer!=null){writer.close();
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,e.getLocalizedMessage(),e);
if(queue!=null&&isAlive()){//trytostopitgracefullytry{queue.put(END_MARKER);this.join(1000);
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,e.getLocalizedMessage(),e);
if(LOGGER.isLoggable(Level.FINE))LOGGER.log(Level.FINE,e.getLocalizedMessage(),e);
if(this.isAlive())this.stop();
iftheintegratedGWCconfigurationissetto{@link*GWCConfig#isCacheLayersByDefault()cachelayersbydefault}.*<li><b>Layerremoved</b>:a{@codeLayerInfo}or{@codeLayerGroupInfo}hasbeenremoved.GWC*isinstructedtoremovethelayer,deletingit'scacheandanyotherassociatedinformation*completely(forexample,thediskquotainformationforthelayerisalsodeletedandthe*globalusageupdatedaccordingly).*<li><b>Layerrenamed</b>:a{@linkLayerInfo}or{@linkLayerGroupInfo}hasbeenrenamed.GWC*is{@linkStorageBroker#renameinstructedtorename}thecorrespondingtilelayer*preservingthecacheandanyotherinformation(usagestatistics,diskquotausage,etc).*<li><b>Workspacerenamed</b>:a{@linkWorkspaceInfo}asbeenrenamed.GWCis{@link*StorageBroker#renameinstructedtorename}allthecorrespondingtilelayerassociatedto*theworkspace,preservingthecacheandanyotherinformation(usagestatistics,diskquota*usage,etc).*<li><b>Namespacechanged</b>:a{@linkResourceInfo}hasbeenassignedtoadifferent{@link*NamespaceInfonamespace}.AstheGWCtilelayersarenamedaftertheresource's{@link*ResourceInfo#prefixedName()prefixedname}andnotonlyafterthe{@link*LayerInfo#getName()}(atleastuntilGeoServerseparatesoutdatafrompublication-the*famousdata/publishsplit),GWCisinstructedtorenamethelayerpreservingthecacheand*anyotherinformationforthelayer.*<li><b>LayerGroupInfomodified</b>:eitherthe{@linkLayerGroupInfo#layers()layers}or{@link*LayerGroupInfo#styles()styles}changedfora{@codeLayerGroupInfo}.It'scacheis*truncated.*<li><b>LayerInfodefaultstylereplaced</b>:a{@codeLayerInfo}hasbeenassignedadifferent*{@linkLayerInfo#getDefaultStyle()defaultstyle}.Thecorrespondingtilelayer'scacheis*truncatedforthedefaultstyle.*<li><b>LayerInfoalternatestyleschanged</b>thesetofa{@codeLayerInfo}'s{@link*LayerInfo#getStyles()alternatestyles}hasbeenmodified.Foranyaddedstyle,
ifthe*{@linkGeoServerTileLayer}isconfiguredto{@link*GeoServerTileLayerInfo#isAutoCacheStyles()automaticallycacheallstyles},thestylename*isaddedtothesetof{@linkGeoServerTileLayerInfo#cachedStyles()cachedstyles}.Forany*<b>removed</b>style,
ifitwasoneofthe{@linkGeoServerTileLayerInfo#cachedStyles()*cachedstyles},thelayer'scacheforthatstyleistruncated,andit'sremovedfromthe*tilelayer'ssetofcachedstyles.Subsequently,the{@linkGeoServerTileLayer}willcreate*a{@linkStringParameterFilter"STYLES"parameterfilter}forallthecachedstyleson*demand*</ul>**@authorArneKepp*@authorGabrielRoldan*/publicclassCatalogLayerEventListenerimplementsCatalogListener{privatestaticLoggerlog=Logging.getLogger(CatalogLayerEventListener.class);privatefinalGWCmediator;privatefinalCatalogcatalog;/***HoldstheCatalogModifyEventfrom{@link#handleModifyEvent}tobetakenafterthechangewas*appliedtothe{@linkCatalog}at{@link#handlePostModifyEvent}andcheckwhetheritis*necessarytoperformanyactiononthecachebasedonthechangedproperties*/privatestaticThreadLocal<CatalogModifyEvent>PRE_MODIFY_EVENT=newThreadLocal<CatalogModifyEvent>();privatestaticThreadLocal<GeoServerTileLayerInfo>PRE_MODIFY_TILELAYER=newThreadLocal<GeoServerTileLayerInfo>();publicCatalogLayerEventListener(finalGWCmediator,Catalogcatalog){this.mediator=mediator;this.catalog=catalog;
if(!cacheLayersByDefault){return;
if(!sane){log.info("Ignoringauto-creationoftilelayerfor"+event.getSource()+":globalgwcsettingsarenotsane");
if(objinstanceofLayerInfo){log.finer("Handlingaddevent:"+obj);LayerInfolayerInfo=(LayerInfo)obj;createTileLayer(layerInfo);
else
if(objinstanceofLayerGroupInfo){LayerGroupInfolgi=(LayerGroupInfo)obj;createTileLayer(lgi);
if(defaults.isSane()&&defaults.isCacheLayersByDefault()){GridSetBrokergridSetBroker=mediator.getGridSetBroker();GeoServerTileLayertileLayer=newGeoServerTileLayer(layerInfo,defaults,gridSetBroker);mediator.add(tileLayer);
if(sourceinstanceofLayerInfo||sourceinstanceofLayerGroupInfo||sourceinstanceofFeatureTypeInfo||sourceinstanceofCoverageInfo||sourceinstanceofWMSLayerInfo||sourceinstanceofWorkspaceInfo){PRE_MODIFY_EVENT.set(event);
if(mediator.hasTileLayer(source)){try{GeoServerTileLayertileLayer=mediator.getTileLayer(source);GeoServerTileLayerInfotileLayerInfo=tileLayer.getInfo();PRE_MODIFY_TILELAYER.set(tileLayerInfo);
if(!(sourceinstanceofLayerInfo||sourceinstanceofLayerGroupInfo||sourceinstanceofFeatureTypeInfo||sourceinstanceofCoverageInfo||sourceinstanceofWMSLayerInfo||sourceinstanceofWorkspaceInfo)){return;
if(tileLayerInfo==null&&!(sourceinstanceofWorkspaceInfo)){return;//notilelayerassociated,noneedtocontinue
if(preModifyEvent==null){thrownewIllegalStateException("PostModifyEventcalledwithouthavingcalledhandlePreModifyfirst?");
if(sourceinstanceofFeatureTypeInfo||sourceinstanceofCoverageInfo||sourceinstanceofWMSLayerInfo||sourceinstanceofLayerGroupInfo){/**Handlechangingthefilterdefinition,thisisthekindofchangethataffectsthe*fulloutputcontents*/
if(changedProperties.contains("cqlFilter")&&sourceinstanceofFeatureTypeInfo){mediator.truncate(((FeatureTypeInfo)source).prefixedName());
if(changedProperties.contains("name")||changedProperties.contains("namespace")||changedProperties.contains("workspace")){handleRename(tileLayerInfo,source,changedProperties,oldValues,newValues);
else
if(sourceinstanceofWorkspaceInfo){
if(changedProperties.contains("name")){handleWorkspaceRename(source,changedProperties,oldValues,newValues);
if(sourceinstanceofLayerInfo){finalLayerInfoli=(LayerInfo)source;handleLayerInfoChange(changedProperties,oldValues,newValues,li,tileLayerInfo);
else
if(sourceinstanceofLayerGroupInfo){LayerGroupInfolgInfo=(LayerGroupInfo)source;handleLayerGroupInfoChange(changedProperties,oldValues,newValues,lgInfo,tileLayerInfo);
if(changedProperties.contains("layers")){finalintlayersIndex=changedProperties.indexOf("layers");ObjectoldLayers=oldValues.get(layersIndex);ObjectnewLayers=newValues.get(layersIndex);truncate=!oldLayers.equals(newLayers);
if(!truncate&&changedProperties.contains("styles")){finalintstylesIndex=changedProperties.indexOf("styles");ObjectoldStyles=oldValues.get(stylesIndex);ObjectnewStyles=newValues.get(stylesIndex);truncate=!oldStyles.equals(newStyles);
if(truncate){log.info("TruncatingTileLayerforlayergroup'"+layerName+"'duetoachangeinitslayersorstyles");mediator.truncate(layerName);
ifthecontentsofthestylesareequal.That*ishandledby{@linkCatalogStyleChangeListener}wheneverastyleismodified.*<li>Ifthetilelayeris{@linkGeoServerTileLayerInfo#isAutoCacheStyles()autocaching*styles}andthelayerinfo's"styles"listchanged,thetilelayer'sSTYLEparameter*filterisupdatedtomatchtheactuallistoflayerstylesandanyremovedstyleis*truncated.*</ul>**@paramchangedProperties*@paramoldValues*@paramnewValues*@paramli*@paramtileLayerInfo*/privatevoidhandleLayerInfoChange(finalList<String>changedProperties,finalList<Object>oldValues,finalList<Object>newValues,finalLayerInfoli,finalGeoServerTileLayerInfotileLayerInfo){checkNotNull(tileLayerInfo);finalStringlayerName=tileLayerName(li);booleansave=false;booleandefaultStyleChanged=false;finalStringdefaultStyle;/**Ifdefaultstylenamechanged*/
if(changedProperties.contains("defaultStyle")){finalintpropIndex=changedProperties.indexOf("defaultStyle");finalStyleInfooldStyle=(StyleInfo)oldValues.get(propIndex);finalStyleInfonewStyle=(StyleInfo)newValues.get(propIndex);finalStringoldStyleName=oldStyle.prefixedName();defaultStyle=newStyle.prefixedName();
if(!Objects.equal(oldStyleName,defaultStyle)){save=true;defaultStyleChanged=true;log.info("Truncatingdefaultstyleforlayer"+layerName+",asitchangedfrom"+oldStyleName+"to"+defaultStyle);mediator.truncateByLayerDefaultStyle(layerName);
else{StyleInfostyleInfo=li.getDefaultStyle();defaultStyle=styleInfo==null?null:styleInfo.prefixedName();
if(tileLayerInfo.isAutoCacheStyles()){Set<String>styles=newHashSet<String>();for(StyleInfos:li.getStyles()){styles.add(s.prefixedName());
if(!styles.equals(cachedStyles)){//truncatenolongerexistingcachedstylesSet<String>notCachedAnyMore=Sets.difference(cachedStyles,styles);for(StringoldCachedStyle:notCachedAnyMore){log.info("Truncatingcachedstyle"+oldCachedStyle+"oflayer"+layerName+"asit'snolongeroneofthelayer'sstyles");mediator.truncateByLayerAndStyle(layerName,oldCachedStyle);
if(metadataIdx>=0){MetadataMapoldMetadata=(MetadataMap)oldValues.get(metadataIdx);MetadataMapnewMetadata=(MetadataMap)newValues.get(metadataIdx);booleancachingEnabledChanged=LangUtils.equals(oldMetadata.get(ResourceInfo.CACHING_ENABLED,Boolean.class),newMetadata.get(ResourceInfo.CACHING_ENABLED,Boolean.class));booleancachingMaxAgeChanged=LangUtils.equals(oldMetadata.get(ResourceInfo.CACHE_AGE_MAX,Boolean.class),newMetadata.get(ResourceInfo.CACHE_AGE_MAX,Boolean.class));//wedowedon'tneedtotruncatethelayer,butweneedtoupdate//itsLayerInfosothattheresultingcachingheadersgetupdated
if(cachingEnabledChanged||cachingMaxAgeChanged){cachingInfoChanged=true;save=true;
if(save){GridSetBrokergridSetBroker=mediator.getGridSetBroker();GeoServerTileLayertileLayer=newGeoServerTileLayer(li,gridSetBroker,tileLayerInfo);mediator.save(tileLayer);
if(cachingInfoChanged||defaultStyleChanged){List<LayerGroupInfo>groups=catalog.getLayerGroups();for(LayerGroupInfolg:groups){GeoServerTileLayertileLayer=mediator.getTileLayer(lg);
if(tileLayer!=null){LayerGroupHelperhelper=newLayerGroupHelper(lg);intidx=helper.allLayers().indexOf(li);
if(idx>=0){//weneedtosaveincasesomethingchangedinoneofthelayerGridSetBrokergridSetBroker=mediator.getGridSetBroker();GeoServerTileLayerInfogroupTileLayerInfo=tileLayer.getInfo();GeoServerTileLayernewTileLayer=newGeoServerTileLayer(lg,gridSetBroker,groupTileLayerInfo);mediator.save(newTileLayer);//wealsoneedtotruncatethegroup
ifthelayerdefaultstylechanged,//andthelayergroupwasusing
if(defaultStyleChanged&&lg.getStyles().get(idx)==null){mediator.truncate(groupTileLayerInfo.getName());
ifthetilelayerexistedanditisonethatwecanrename(admin//couldhaveoverwrittenitwithadirectlayeringeowebcache.xml)TileLayertl;try{tl=mediator.getTileLayerByName(oldName);
if(!(tlinstanceofGeoServerTileLayer)){continue;
ifthelayerisnotthere,moveoncontinue;
if(layer.getType()==PublishedType.VECTOR&&((FeatureTypeInfo)layer.getResource()).getFeatureType().getGeometryDescriptor()==null){//skipgeometrylesslayerscontinue;
iflayer"+layer+"isgeometrylesswhilerenamingtilelayersforworkspacenamechange"+oldName+"->"+newName,e);
if(tlinstanceofGeoServerTileLayer){GeoServerTileLayergstl=(GeoServerTileLayer)tl;renameTileLayer(gstl.getInfo(),oldName,newName);
ifthetilelayerexistedanditisonethatwecanrename(admin//couldhaveoverwrittenitwithadirectlayeringeowebcache.xml)TileLayertl;try{tl=mediator.getTileLayerByName(oldName);
if(!(tlinstanceofGeoServerTileLayer)){continue;
ifthelayerisnotthere,moveoncontinue;
if(tlinstanceofGeoServerTileLayer){GeoServerTileLayergstl=(GeoServerTileLayer)tl;renameTileLayer(gstl.getInfo(),oldName,newName);
if(sourceinstanceofResourceInfo){//coversLayerInfo,CoverageInfo,andWMSLayerInfo//mustcoverprefix:namefinalResourceInforesourceInfo=(ResourceInfo)source;finalNamespaceInfocurrNamespace=resourceInfo.getNamespace();finalNamespaceInfooldNamespace;
if(namespaceIndex>-1){//namespacechangedoldNamespace=(NamespaceInfo)oldValues.get(namespaceIndex);
else{oldNamespace=currNamespace;
if(nameIndex>-1){oldLayerName=(String)oldValues.get(nameIndex);
else{oldLayerName=resourceInfo.getName();
else{//it'salayergroup,noneedtoworryaboutnamespaceoldLayerName=tileLayerInfo.getName();newLayerName=tileLayerName((LayerGroupInfo)source);
if(!oldLayerName.equals(newLayerName)){renameTileLayer(tileLayerInfo,oldLayerName,newLayerName);
if(!(objinstanceofLayerInfo||objinstanceofLayerGroupInfo)){return;
if(!mediator.hasTileLayer(obj)){return;
if(objinstanceofLayerGroupInfo){LayerGroupInfolgInfo=(LayerGroupInfo)obj;prefixedName=tileLayerName(lgInfo);
else
if(objinstanceofLayerInfo){LayerInfolayerInfo=(LayerInfo)obj;prefixedName=tileLayerName(layerInfo);
if(null!=prefixedName){//notifythelayerhasbeenremovedmediator.removeTileLayers(Arrays.asList(prefixedName));
ifwehavethehazelcastconfigurationready,otherwisecreateonefromtheclasspathResourceresource=store.get(HAZELCAST_NAME);
if(resource.getType()==Type.UNDEFINED){try(OutputStreamos=resource.out();InputStreamis=HazelcastLoader.class.getResourceAsStream(HAZELCAST_NAME)){IOUtils.copy(is,os);
ifpresentornull*/publicHazelcastInstancegetInstance(){returninstance;
if(config==null){thrownewIllegalArgumentException("Hazelcastconfigurationshouldnotbenull");
ifthecachemapispresent
if(!config.getMapConfigs().containsKey(EXECUTION_STATUS_MAP)){thrownewIllegalArgumentException("Hazelcastconfigurationismissingthestatusmap,shouldbecalled:"+EXECUTION_STATUS_MAP);
if(mapConfig.getMaxSizeConfig().getSize()>0){LOGGER.warning("TheWPSstatusmap"+EXECUTION_STATUS_MAP+"hasamaxsizeset,itshouldbeunboundedsothatnostatusislost"+"beforetheconfiguredtimeout");
if(mapConfig.getEvictionPolicy()!=MapConfig.DEFAULT_EVICTION_POLICY){LOGGER.warning("TheWPSstatusmap"+EXECUTION_STATUS_MAP+"hasaevictionpolicyset,itshouldnotautomaticallyevictentriessothat"+"nostatusislostbeforetheconfiguredtimeout");
if(adinstanceofGeometryDescriptor){GeometryDescriptorgd=(GeometryDescriptor)ad;Class<?>binding=ad.getType().getBinding();
if(Point.class.isAssignableFrom(binding)){tb.add(ad);
else{tb.minOccurs(ad.getMinOccurs());tb.maxOccurs(ad.getMaxOccurs());tb.nillable(ad.isNillable());tb.add(ad.getLocalName(),Point.class,gd.getCoordinateReferenceSystem());
else{tb.add(ad);
if((attributeinstanceofGeometry)&&!(attributeinstanceofPoint)){Geometrygeom=(Geometry)attribute;Coordinatepoint=centroids.geometryCentroid(geom,context.getRequest().getBbox(),centroidOpts);attribute=geom.getFactory().createPoint(point);
if(image.getSampleModel().getNumBands()==2&&image.getColorModel().hasAlpha()){LOGGER.fine("Expandingimagefromgray/alphatorgba");ImageWorkeriw=newImageWorker(image);iw.retainBands(1).forceColorSpaceRGB();RenderedImagealphaBand=newImageWorker(image).retainLastBand().getRenderedImage();iw.addBand(alphaBand,false);RenderedImageconverted=iw.getRenderedImage();GridCoverage2Dadapted=CoverageFactoryFinder.getGridCoverageFactory(null).create(input.getName(),converted,input.getGridGeometry(),null,newGridCoverage2D[]{input},input.getProperties());returnadapted;
if(!value.contains(":")){value="file:"+value;
if(value.contains(";")){returnnull;
ifcustom*valueisalsoallowed.**@paramdependsOnRawValuesrawvaluesofdependingparameters.*@returnlistofpossiblevalues,null
ifnotapplicable.*/publicList<String>getDomain(List<String>dependsOnRawValues);/***Validateandparseaparametervalueforthisparameter(atruntime).**@paramvaluetherawvalue.*@paramdependsOnRawValuesrawvaluesofdependingparameters.*@returntheparsedvalue,NULL
ifthevalueisinvalid.*/publicObjectparse(Stringvalue,List<String>dependsOnRawValues);/***Validateaparametervalue(atconfigurationtime).**@paramvaluetherawvalue.*@paramdependsOnRawValuesrawvaluesofdependingparameters.*@returntrue
ifthevalueisconsideredvalidatconfigurationtime(maystillbeconsidered*invalidatparsetime)*/publicdefaultbooleanvalidate(Stringvalue,List<String>dependsOnRawValues){returnparse(value,dependsOnRawValues)!=null;
if(jobExecution.getStatus()!=BatchStatus.STOPPED){try{JobParametersjobParameters=backupExecution.getJobParameters();ResourcesourceFolder=Resources.fromURL(jobParameters.getString(Backup.PARAM_OUTPUT_FILE_PATH));BackupUtils.compressTo(sourceFolder,backupExecution.getArchiveFile());
if(!bestEffort){backupExecution.addFailureExceptions(Arrays.asList(e));thrownewRuntimeException(e);
else{backupExecution.addWarningExceptions(Arrays.asList(e));
if("".equals(pre)){attribute("xmlns"+pre,uri);
else{attribute("xmlns:"+pre,uri);
if(!schemaLocations.isEmpty()){StringBufferbuffer=newStringBuffer();for(Iteratore=schemaLocations.entrySet().iterator();e.hasNext();){Map.Entryentry=(Entry)e.next();Stringuri=(String)entry.getKey();Stringlocation=(String)entry.getValue();buffer.append(uri+""+location);
if(e.hasNext()){buffer.append("");
if(root){writer=newBufferedWriter(newOutputStreamWriter(output,wfs.getGeoServer().getSettings().getCharset()));//writetheprocessinginstructionwriter.write("<?xmlversion=\"1.0\"encoding=\""+charSetEncoding+"\"?>");
if(prefix!=null){writer.write("<"+prefix+":"+name);
else{writer.write("<"+name);
if(root){init();
if(attributes!=null){for(inti=0;i<attributes.length;i+=2){attribute(attributes[i],attributes[i+1]);
if(prefix!=null){writer.write("</"+prefix+":"+name+">");
else{writer.write("</"+name+">");
if(wrappedinstanceofCloseable){this.whatToClose=(Closeable)wrapped;
else{this.whatToClose=null;
if(!hasNext){//autocloseclose();
ifitsaninstanceof{@codeCloseableIterator},doesnothing*otherwise;override
ifneeded.**@seejava.io.Closeable#close()*/@Overridepublicvoidclose(){try{Closeables.close(whatToClose,false);
if(whatToClose!=null){try{close();
if(iteratorinstanceofCloseable){try{Closeables.close((Closeable)iterator,false);
ifnotfound.**<p>Ifafixtureconfigurationfileisnotfound,anoticeisprintedtostandardoutput*statingthattestsforthisfixtureidareskipped.**<p>Thismethodallowsteststhatcannotextend{@linkOnlineTestCase}or{@link*OnlineTestSupport}becausetheyalreadyextendanotherclass(forexample,anon-onlinetest*framework)toaccessfixtureconfigurationfilesinthesamewaythatthoseclassesdo.Only*basicfixtureconfigurationloadingissupported.Thismethoddoesnotsupporttheextra*servicessuchasfixturecachingandconnectiontestingprovidedby{@linkOnlineTestCase}*and{@linkOnlineTestSupport}.**<p>AJUnit4testfixturecanreadilybedisabledintheabsenceofafixtureconfiguration*filebyplacing<code>Assume.assumeNotNull(FixtureUtilities.loadFixture(fixtureId))</code>or*similarinits<code>@BeforeClass</code>method.JUnit3testsmustprovidetheirownlogic,*typicallyoverriding{@linkTestCase#run()}or{@linkTestCase#runTest()},orprovidinga*suite.**@paramfixtureIdthefixtureid,wheredots"."areconvertedtosubdirectories.*@returnthefixturePropertiesornull*@seeOnlineTestCase*@seeOnlineTestSupport*/publicstaticPropertiesloadFixture(StringfixtureId){FilefixtureFile=getFixtureFile(getFixtureDirectory(),fixtureId);
if(fixtureFile.exists()){returnloadProperties(fixtureFile);
else{printSkipNotice(fixtureId,fixtureFile);returnnull;
if(notAllowedPrefixes!=null)returnnotAllowedPrefixes;synchronized(lock){
if(notAllowedPrefixes!=null)returnnotAllowedPrefixes;notAllowedPrefixes=newHashSet<String>();for(GeoServerPasswordEncoderenc:GeoServerExtensions.extensions(GeoServerPasswordEncoder.class)){notAllowedPrefixes.add(enc.getPrefix()+GeoServerPasswordEncoder.PREFIX_DELIMTER);
ifthepasswordstartswithanencoderprefix,
iftruereturntheprefix,
iffalse*return<code>null</code>**@parampassword*/publicstaticStringpasswordStartsWithEncoderPrefix(char[]password){
if(password==null)returnnull;O:for(Stringprefix:getNotAllowedPrefixes()){
if(prefix.length()>password.length)continue;for(inti=0;i<prefix.length();i++){
if(prefix.charAt(i)!=password[i])continueO;
if(password==null)//throwcreateSecurityException(PW_IS_NULL);
if(password==null){//treatas"empty"password=newchar[]{};
if(password.length<config.getMinLength())throwcreateSecurityException(MIN_LENGTH_$1,config.getMinLength());
if(config.getMaxLength()>=0&&password.length>config.getMaxLength())throwcreateSecurityException(MAX_LENGTH_$1,config.getMaxLength());
if(config.isDigitRequired()){
if(checkUsingMethod("isDigit",password)==false)throwcreateSecurityException(NO_DIGIT);
if(config.isUppercaseRequired()){
if(checkUsingMethod("isUpperCase",password)==false)throwcreateSecurityException(NO_UPPERCASE);
if(config.isLowercaseRequired()){
if(checkUsingMethod("isLowerCase",password)==false)throwcreateSecurityException(NO_LOWERCASE);
if(prefix!=null)throwcreateSecurityException(RESERVED_PREFIX_$1,prefix);
if(result)returntrue;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;InputCoverageBandother=(InputCoverageBand)obj;
if(band==null){
if(other.band!=null)returnfalse;
else
if(!band.equals(other.band))returnfalse;
if(coverageName==null){
if(other.coverageName!=null)returnfalse;
else
if(!coverageName.equals(other.coverageName))returnfalse;returntrue;
ifthiscanberemoved)*</ul>*/publicstaticclassCoverageBandimplementsSerializable{/**serialVersionUID*/privatestaticfinallongserialVersionUID=-7223081117287911988L;publicCoverageBand(){}publicCoverageBand(List<InputCoverageBand>inputCoverageBands,Stringdefinition,intindex,CompositionTypecompositionType){this.inputCoverageBands=inputCoverageBands;this.definition=definition;this.index=index;this.compositionType=compositionType;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;CoverageBandother=(CoverageBand)obj;
if(compositionType!=other.compositionType)returnfalse;
if(definition==null){
if(other.definition!=null)returnfalse;
else
if(!definition.equals(other.definition))returnfalse;returntrue;
if(inputBand.getCoverageName().equalsIgnoreCase(coverageName)){bands.add(coverageBand);
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;CoverageViewother=(CoverageView)obj;
if(coverageBands==null){
if(other.coverageBands!=null)returnfalse;
else
if(!coverageBands.equals(other.coverageBands))returnfalse;
if(envelopeCompositionType!=other.envelopeCompositionType)returnfalse;
if(name==null){
if(other.name!=null)returnfalse;
else
if(!name.equals(other.name))returnfalse;
if(selectedResolution!=other.selectedResolution)returnfalse;
if(selectedResolutionIndex!=other.selectedResolutionIndex)returnfalse;returntrue;}}
if(catalogIterator.hasNext()){Titem=(T)catalogIterator.next();returnitem;
ifnonefoundwillfallbackon{@linkDefaultGeoServerLoader}.**@authorJustinDeoliveira,OpenGeo*/publicclassGeoServerLoaderProxyimplementsBeanPostProcessor,DisposableBean,ApplicationContextAware{/**resourceloader*/protectedGeoServerResourceLoaderresourceLoader;/**theactualloader*/GeoServerLoaderloader;publicGeoServerLoaderProxy(GeoServerResourceLoaderresourceLoader){this.resourceLoader=resourceLoader;
if(loader!=null){returnloader.postProcessAfterInitialization(bean,beanName);
if(loader!=null){returnloader.postProcessBeforeInitialization(bean,beanName);
if(loader!=null){loader.reload();
if(loader!=null){loader.destroy();
if(loader==null){loader=newDefaultGeoServerLoader(resourceLoader);
iftheoperationwassuccessful*/Map<String,Object>params=Scripting.getParamMap(command);StringrefName=(String)params.get("name");command.getClientData().put("name",refName);//ignore
ifstillinsideatransactionorupdatingaknownsymrefbooleanignore=command.context()instanceofGeogigTransaction;ignore|=(Ref.WORK_HEAD.equals(refName)||Ref.STAGE_HEAD.equals(refName));
if(ignore){command.getClientData().put("ignore",Boolean.TRUE);//ignoreupdatestowork/stageheads,weonlycareofupdatestobranchesreturncommand;
if(Boolean.TRUE.equals(cmd.getClientData().get("ignore"))){LOGGER.debug("GWCgeogigtruncatepost-hookreturning,ref'{}'isignored.",refName);return(T)retVal;
if(!success){LOGGER.info("GWCgeogigtruncatepost-hookreturning,UpdateRefoperationfailedonref'{}'.",refName);return(T)retVal;
if(mediator==null){LOGGER.debug("GWCgeogigtruncatepost-hookreturning,GWCmediatornotinstalled?.");return(T)retVal;
iftherefwasdeletedcheckState(oldValue!=null,"oldValuenotcapturedinpre-hook");
if(oldValue.equals(newValue)){LOGGER.debug("GWCgeogigtruncatepost-hookreturning,ref'{}'didn'tchange({}).",refName,oldValue);return(T)retVal;
if(tileLayer==null){return;
ifGWCwasn'tinstalleditshouldhavereturnedearlierTruncateHelper.issueTruncateTasks(geogigContext,oldValue,newValue,tileLayer,breeder);
if(!layerInfo.enabled()){continue;
ifthere'snotilelayerforit
if(!mediator.hasTileLayer(layerInfo)){continue;
if(affectedLayers.containsKey(store)){affectedLayers.put(store,layerInfo);
else{@NullablefinalStringdataStoreHead=findDataStoreHeadRefName(store,context);
if(newRefName.equals(dataStoreHead)){affectedLayers.put(store,layerInfo);
if(dataStoreHead==null){Optional<Ref>currHead=context.command(RefParse.class).setName(Ref.HEAD).call();
if(!currHead.isPresent()||!(currHead.get()instanceofSymRef)){//can'tfigureoutthecurrentbranch,ignore?returnnull;
else{Optional<Ref>storeRef=context.command(RefParse.class).setName(dataStoreHead).call();
if(storeRef.isPresent()){Refref=storeRef.get();
if(refinstanceofSymRef){dataStoreHead=((SymRef)ref).getTarget();
else{dataStoreHead=ref.getName();
else{LOGGER.info("HEAD'{}'configuredforstore'{}'doesnotresolvetoaref",dataStoreHead,store.getName());dataStoreHead=null;
if(!GridCS.GCSGrid2dSquare.getXmlConstant().equalsIgnoreCase(value))thrownewWcsException("UnrecognizedGridCS"+value,WcsExceptionCode.InvalidParameterValue,"GridCS");returnGridCS.GCSGrid2dSquare.getXmlConstant();}}
if(keys!=null&&!keys.isEmpty()&&keys.contains(WCS20GetCoverageResponse.COVERAGE_ID_PARAM)){StringcoverageId=encodingParameters.get(WCS20GetCoverageResponse.COVERAGE_ID_PARAM);
if(coverageId!=null){returngetSettings(coverageId);
if(geoserver!=null){CataloggsCatalog=geoserver.getCatalog();LayerInfoinfo=NCNameResourceCodec.getCoverage(gsCatalog,coverageId);
if(info!=null){map=info.getResource().getMetadata();
if(map!=null&&!map.isEmpty()&&map.containsKey(NetCDFSettingsContainer.NETCDFOUT_KEY)){NetCDFLayerSettingsContainersettings=(NetCDFLayerSettingsContainer)map.get(NetCDFSettingsContainer.NETCDFOUT_KEY,NetCDFLayerSettingsContainer.class);returnsettings;
if(!isQuietTests()){System.out.println(response.getContentAsString());
if(delegate!=null){returndelegate.resolveEntity(publicId,systemId);
else{returnnull;
if(resolverProvider!=null){resolver=resolverProvider.getEntityResolver();
if(configinstanceofAuthenticationKeyFilterConfig)validateFilterConfig((AuthenticationKeyFilterConfig)config);
elsesuper.validateFilterConfig(config);
if(isNotEmpty(config.getAuthKeyParamName())==false){throwcreateFilterException(AuthenticationKeyFilterConfigException.AUTH_KEY_PARAM_NAME_REQUIRED);
if(isNotEmpty(config.getAuthKeyMapperName())==false){throwcreateFilterException(AuthenticationKeyFilterConfigException.AUTH_KEY_MAPPER_NAME_REQUIRED);
if(!mapper.getAvailableParameters().contains(paramName)){throwcreateFilterException(AuthenticationKeyFilterConfigException.INVALID_AUTH_KEY_MAPPER_PARAMETER_$3,paramName);
if(mapper.supportsReadOnlyUserGroupService()==false&&service.canCreateStore()==false){throwcreateFilterException(AuthenticationKeyFilterConfigException.INVALID_AUTH_KEY_MAPPER_$2,config.getAuthKeyMapperName(),config.getUserGroupServiceName());
iftheconfigcanberemovedtry{validateRemoveConfig(config);
if(ok){//proceedwiththeremoval,confirmingfirstdialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){@OverrideprotectedComponentgetContents(Stringid){returnnewConfirmRemovalNamedServicePanel(id,tablePanel.getSelection());
if(isAdmin){target.add(removeLink.setEnabled(!getSelection().isEmpty()));
if(pageInfo.getServiceClass().isAssignableFrom(serviceClass)){pageInfos.add(pageInfo);
if(pageInfos.isEmpty()){thrownewRuntimeException("Unabletofindpageinfoforserviceconfig:"+config+",serviceclass:"+serviceClass);
if(pageInfos.size()>1){//filterbystrictequalsList<SecurityNamedServicePanelInfo>l=newArrayList(pageInfos);for(Iterator<SecurityNamedServicePanelInfo>it=l.iterator();it.hasNext();){
if(!it.next().getServiceClass().equals(serviceClass)){it.remove();
if(l.size()==1){//filterdowntoonematchreturnl.get(0);
if(property==NAME){returncreateEditLink(id,itemModel,property);
if(propertyinstanceofResourceBeanProperty){Objectval=property.getModel(itemModel).getObject();
if(val!=null){returnnewLabel(id,newResourceModel(val.toString(),val.toString()));
if(property==ScriptProvider.NAME){returnscriptLink(id,itemModel);
else
if(property==ScriptProvider.TYPE){returnnewLabel(id,ScriptProvider.TYPE.getModel(itemModel));
else
if(property==ScriptProvider.EXTENSION){returnnewLabel(id,ScriptProvider.EXTENSION.getModel(itemModel));
else
if(property==ScriptProvider.FILE){returnnewLabel(id,ScriptProvider.FILE.getModel(itemModel));
if(at!=null){this.scaleX=at.getScaleX();this.shearX=at.getShearX();this.originX=at.getTranslateX();this.scaleY=at.getScaleY();this.shearY=at.getShearY();this.originY=at.getTranslateY();
if(isResolutionModeEnabled()&&scaleX!=null&&scaleY!=null){setConvertedInput(AffineTransform.getScaleInstance(scaleX,scaleY));
else
if(scaleX!=null&&shearX!=null&&originX!=null&&scaleY!=null&&shearY!=null&&originY!=null){setConvertedInput(newAffineTransform(scaleX,shearX,shearY,scaleY,originX,originY));
else{setConvertedInput(null);
if(workspace==null||workspace==ANY_WORKSPACE){returndb.getByIdentity(clazz,"name",name);
else{returndb.getByIdentity(clazz,"workspace.id",workspace.getId(),"name",name);
if(null!=workspace&&ANY_WORKSPACE!=workspace){filter=equal("workspace.id",workspace.getId());
if(!Utilities.equals(old,workspace)){Catalogcatalog=getCatalog();catalog.fireModified(catalog,Arrays.asList("defaultDataStore"),Arrays.asList(old),Arrays.asList(store));
if(!Utilities.equals(old,workspace)){Catalogcatalog=getCatalog();catalog.firePostModified(catalog,Arrays.asList("defaultDataStore"),Arrays.asList(old),Arrays.asList(store));
if(namespace==null||namespace==ANY_NAMESPACE){returndb.getByIdentity(clazz,"name",name);
else{returndb.getByIdentity(clazz,"namespace.id",namespace.getId(),"name",name);
if(null!=namespace&&ANY_NAMESPACE!=namespace){filter=equal("namespace.id",namespace.getId());
if(resourceId==null){returnnull;
else{returndb.getByIdentity(LayerInfo.class,"resource.id",resourceId);
if(!Utilities.equals(old,defaultNamespace)){//firemodifyeventbeforechangeCatalogcatalog=getCatalog();catalog.fireModified(catalog,Arrays.asList("defaultNamespace"),Arrays.asList(old),Arrays.asList(defaultNamespace));
if(!Utilities.equals(old,defaultNamespace)){//firepostmodifyeventafterchangeCatalogcatalog=getCatalog();catalog.firePostModified(catalog,Arrays.asList("defaultNamespace"),Arrays.asList(old),Arrays.asList(defaultNamespace));
if(!Utilities.equals(old,workspace)){//firemodifyeventbeforechangeCatalogcatalog=getCatalog();catalog.fireModified(catalog,Arrays.asList("defaultWorkspace"),Arrays.asList(old),Arrays.asList(workspace));
if(!Utilities.equals(old,workspace)){//firepostmodifyeventafterchangeCatalogcatalog=getCatalog();catalog.firePostModified(catalog,Arrays.asList("defaultWorkspace"),Arrays.asList(old),Arrays.asList(workspace));
if(NO_WORKSPACE==workspace){FilterwsFilter=isNull("workspace.id");filter=and(filter,wsFilter);
else
if(workspace!=null&&ANY_WORKSPACE!=workspace){FilterwsFilter=equal("workspace.id",workspace.getId());filter=and(filter,wsFilter);
if(workspace==null){workspace=getDefaultWorkspace();
if(workspace==null){returnCollections.emptyList();
if(NO_WORKSPACE==workspace){filter=isNull("workspace.id");
else{filter=equal("workspace.id",workspace.getId());
if(workspace==ANY_WORKSPACE){returndb.getByIdentity(StyleInfo.class,"name",name);
else{returndb.getByIdentity(StyleInfo.class,"workspace.id",workspace.getId(),"name",name);
if(workspace==null){workspace=getDefaultWorkspace();
if(workspace==null){returnCollections.emptyList();
if(NO_WORKSPACE==workspace){filter=isNull("workspace.id");
else{filter=equal("workspace.id",workspace.getId());
if(defaultDataStore!=null){other.setDefaultDataStore(ws,defaultDataStore);
if(it.hasNext()){result=it.next();
if(it.hasNext()){thrownewIllegalArgumentException("Specifiedquerypredicateresultedinmorethanoneobject");
if(sortBy!=null){for(SortBysortOrder:sortBy){Preconditions.checkArgument(null==sortOrder||canSort(of,sortOrder.getPropertyName().getPropertyName()),"Can'tsortobjectsoftype%sby%s",of,sortOrder);
if(null!=curId){//HACK:isitimportedfromtheDefaultCatalogFacade?//finalStringmatch="Impl-";//intindex=curId.indexOf(match);//
if(index==-1){//thrownewIllegalArgumentException(//"Attemptingtosetidonanobjectalreadyidentified("+curId+"):"//+info);//
else{StringnewId=UUID.randomUUID().toString();id=type.getSimpleName()+"."+newId;
if(params.length==0)returnnewNewGroupPage(getUserGroupServiceName()).setReturnPage(page);
elsereturnnewNewGroupPage((String)params[0]).setReturnPage(page);
if(params.length==0){returnnewEditGroupPage(getUserGroupServiceName(),newGeoServerUserGroup("dummygroup")).setReturnPage(page);
if(params.length==1)returnnewEditGroupPage(getUserGroupServiceName(),(GeoServerUserGroup)params[0]).setReturnPage(page);
elsereturnnewEditGroupPage((String)params[0],(GeoServerUserGroup)params[1]).setReturnPage(page);
if(withRoles)assertTrue(gaService.getRolesForGroup("group1").size()==0);
elseassertTrue(gaService.getRolesForGroup("group1").size()==2);
if(bandIndices!=null){bandIndicesParam=(Parameter<int[]>)AbstractGridFormat.BANDS.createValue();bandIndicesParam.setValue(bandIndices);
if(bandIndices!=null){bandIndicesParam=(Parameter<int[]>)AbstractGridFormat.BANDS.createValue();bandIndicesParam.setValue(bandIndices);
if(request.getSldVer()!=null&&"".equals(request.getSldVer())&&!"1.0.0".equals(request.getSldVer()))thrownewServiceException("SLDversion"+request.getSldVer()+"notsupported");try{StyleFactoryfactory=CommonFactoryFinder.getStyleFactory(null);List<StyledLayer>layers=newArrayList<StyledLayer>();for(StringlayerName:request.getLayers()){NamedLayernamedLayer=factory.createNamedLayer();layers.add(namedLayer);namedLayer.setName(layerName);LayerGroupInfogroup=wms.getLayerGroupByName(layerName);LayerInfolayer=wms.getLayerByName(layerName);
if(group!=null){//nothingtodo,groupshavenostyle
else
if(layer!=null){Stylestyle=layer.getDefaultStyle().getStyle();//addthedefaultstylefirststyle=cloneStyle(style);style.setDefault(true);style.setName(layer.getDefaultStyle().getName());namedLayer.styles().add(style);//addalternatestylesfor(StyleInfosi:layer.getStyles()){style=cloneStyle(si.getStyle());style.setName(si.getName());namedLayer.styles().add(style);
else{//weshouldreallyaddacodeandalocator...thrownewServiceException("Unknownlayer"+layerName);
if(Strings.isEmpty(input)){List<String>emptyList=Collections.emptyList();returnemptyList.iterator();
if(name.toLowerCase().startsWith(input.toLowerCase())){choices.add(name);
ifnotdefinedStringstartUOM=uom.getModelObject();
if((startUOM==null||startUOM.isEmpty())&&cinfo!=null){//AddthenewvaluefromtheCoverageBandDetailsList<CoverageDimensionInfo>infos=cinfo.getObject().getDimensions();
if(infos!=null&&infos.size()>0){CoverageDimensionInfoinfo=infos.get(0);uom.setModelObject(info.getUnit());
if(bean!=null&&bean.getParser()!=null){NetCDFCFParserparser=bean.getParser();names.addAll(parser.getEntryIds());
if(name!=null&&!name.isEmpty()){NetCDFParserBeanbean=GeoServerExtensions.bean(NetCDFParserBean.class);
if(bean!=null&&bean.getParser()!=null){NetCDFCFParserparser=bean.getParser();Entrye=null;
if(parser.hasEntryId(name)){e=parser.getEntry(name);
else
if(parser.hasAliasId(name)){e=parser.getEntryFromAlias(name);
if(e!=null){uom.setModelObject(e.getCanonicalUnits());target.add(container);
if(componentinstanceofFormComponent){FormComponent<?>formComponent=(FormComponent<?>)component;formComponent.processInput();
if(componentinstanceofNetCDFExtensionPanel){NetCDFExtensionPanelextension=(NetCDFExtensionPanel)component;extension.convertInput(convertedInput);
if(config!=null&&request!=null&&("GetMap".equalsIgnoreCase(request.getRequest())||"GetFeatureInfo".equalsIgnoreCase(request.getRequest()))){GetMapRequestgetMap=getGetMap(request);try{Map<String,Object>defaults=getDefaultValues(resource,getMap,config);Stringkey=dimensionName;
if(dimensionName.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){key=dimensionName.substring(ResourceInfo.CUSTOM_DIMENSION_PREFIX.length());
if(defaults.containsKey(key)){ObjectdefaultValue=defaults.get(key);Objectsimple=getSimpleValue(defaultValue);
if(simple!=null){returnnewDefaultFixedValueStrategyFactory().createFixedValueStrategy(simple);
ifpresent,notempty,andhasatleastadynamic*dimensiontocompute**@paramresource*/privateDefaultValueConfigurationsgetConfigurations(ResourceInforesource){DefaultValueConfigurationsconfigurations=resource.getMetadata().get(DefaultValueConfigurations.KEY,DefaultValueConfigurations.class);
if(configurations==null){returnnull;
if(list==null||list.isEmpty()){LOGGER.fine("Skippingdynamicdimensionconfigurationasitisempty");returnnull;
if(config.getPolicy()!=null&&config.getPolicy()!=DefaultValuePolicy.STANDARD){returnconfigurations;
if(parsedRequestinstanceofGetMapRequest){getMap=(GetMapRequest)parsedRequest;
else
if(parsedRequestinstanceofGetFeatureInfoRequest){getMap=((GetFeatureInfoRequest)parsedRequest).getGetMapRequest();
else{thrownewIllegalArgumentException("CouldnotgetaGetMapRequestoutoftheparsedrequest,theparsedrequestobjectwas:_"+parsedRequest);
if(result==null){result=buildDynamicDefaults(resource,getMap,configurations);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Computedthefollowingdynamicdimensiondefaultvaluesforlayer"+resource.prefixedName()+":\n"+result+"\nbasedonconfiguration:\n"+configurations);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Buildingdynamicdefaultsforresource"+resource.prefixedName());
if(metadatainstanceofDimensionInfo){//skipdisableddimensionsDimensionInfodi=(DimensionInfo)metadata;
if(!di.isEnabled()){continue;
if(key.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){dimensionName=key.substring(ResourceInfo.CUSTOM_DIMENSION_PREFIX.length());
else{dimensionName=key;
ifthevalueswereprovidedalreadyintherequest,weare//goingtousethemfordomainrestrictionbooleanfoundExplicitDefault=false;
if(ResourceInfo.TIME.equals(dimensionName)&&getMap.getRawKvp().get("time")!=null){List<Object>times=getMap.getTime();addExplicitValues(dimensionName,times,result,incompleteSpecs);foundExplicitDefault=true;
else
if(ResourceInfo.ELEVATION.equals(dimensionName)&&getMap.getRawKvp().get("elevation")!=null){List<Object>elevations=getMap.getElevation();addExplicitValues(dimensionName,elevations,result,incompleteSpecs);foundExplicitDefault=true;
else
if(getMap.getRawKvp().get("dim_"+dimensionName)!=null){List<String>customDimensions=getMap.getCustomDimension(dimensionName);addExplicitValues(dimensionName,customDimensions,result,incompleteSpecs);foundExplicitDefault=true;
if(!foundExplicitDefault){
if(!hasDynamicConfiguration(configurations,dimensionName)){DimensionDefaultValueSelectionStrategystrategy=delegate.getStrategy(resource,key,di);
if(strategy==null){LOGGER.warning("Skippingstaticsettingofdefaultdimensionvaluefordimension"+dimensionName+"inlayer"+resource.prefixedName()+"asthedefaultvaluestrategycouldnotbefound");
else{ObjectstaticDefault=strategy.getDefaultValue(resource,dimensionName,di,getDimensionClass(dimensionName));
if(staticDefault!=null){result.put(dimensionName,wrapIntoList(staticDefault));
else{LOGGER.warning("Skippingstaticsettingofdefaultdimensionvaluefordimension"+dimensionName+"inlayer"+resource.prefixedName()+"asthedefaultvaluestrategy"+strategy+"returnedanullvalue");
ifthereareincompleteuservaluespecifications,resolvetheminthesameorderasthe//dynamicdefaults
if(!incompleteSpecs.isEmpty()){for(DefaultValueConfigurationconfig:configurations){StringdimensionName=config.getDimension();
if(!incompleteSpecs.containsKey(dimensionName)){continue;
if(v!=null){defaulted.add(v);
else{ObjectdynamicValue=getDynamicDefault(resource,result,config,dimensionName);
if(dynamicValue!=null){defaulted.add(dynamicValue);
if(result.containsKey(dimensionName)){continue;
else{//computethedynamicdefaultObjectvalue=getDynamicDefault(resource,result,config,dimensionName);
if(value!=null){result.put(dimensionName,value);
if(dimensionName.equals(config.getDimension())){returntrue;
if(di==null){LOGGER.warning("Skippingdynamicdefaultconfigurationfordimension"+config.getDimension()+"asthebasedimensionconfigurationismissing");
else
if(!di.isEnabled()){LOGGER.warning("Skippingdynamicdefaultconfigurationfordimension"+config.getDimension()+"asthedimensionisnotenabled");
else{result.add(config);
if(values.contains(null)){incompleteSpecs.put(dimensionName,values);
else{completeSpecs.put(dimensionName,values);
if(config.policy==DefaultValuePolicy.STANDARD){
if(di==null){returnnull;
else{//wefetchthevalueanywayssothatwecanrundomainrestrictionslaterDimensionDefaultValueSelectionStrategystrategy=delegate.getStrategy(resource,config.dimension,di);Objectvalue=strategy.getDefaultValue(resource,dimensionName,di,dimensionClass);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Computeddefaultvaluefordimension"+dimensionName+"usingstandardpolicy"+strategy+"whichresultedin:"+value);
else
if(config.policy==DefaultValuePolicy.EXPRESSION){returnapplyExpression(result,config,dimensionName,dimensionClass);
else
if(config.policy==DefaultValuePolicy.LIMIT_DOMAIN){
if(resourceinstanceofFeatureTypeInfo){Objectvalue=getVectorDefaultValue((FeatureTypeInfo)resource,config,result);returnvalue;
else
if(resourceinstanceofCoverageInfo){DimensionDefaultValueSelectionStrategydelegateStrategy=delegate.getStrategy(resource,getDimensionMetadataKey(config.getDimension()),di);Objectvalue=getRasterDefaultValue((CoverageInfo)resource,config,result,delegateStrategy);returnvalue;
else{thrownewIllegalArgumentException("Don'tknowhowtohandledomainrestrictionforlayersoftype"+resource.getClass());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Computeddefaultvaluefordimension"+dimensionName+"usingexpression"+expression+"returnedvalue"+strValue);
if(strValue==null){value=null;
else
if(Date.class.isAssignableFrom(dimensionClass)){value=newTimeKvpParser("whatever").parse(strValue);
else
if(Double.class.isAssignableFrom(dimensionClass)){value=newElevationKvpParser("whatever").parse(strValue);
else{value=strValue;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Computedvalue"+strValue+"gotparsedto"+value);
if(valueinstanceofList){Listlist=(List)value;
if(list.isEmpty()){value=null;
else{value=list.get(0);
if(valueinstanceofDateRange){value=((DateRange)value).getMinValue();
else
if(valueinstanceofNumberRange){value=((NumberRange)value).getMinimum();
ifit'safixedstrategy,simplecase,nodomainrestrictionneeded
if(delegateStrategyinstanceofFixedValueStrategyImpl){Class<?>dimensionClass=getDimensionClass(config.getDimension());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Dynamicdomainrestrictionondimension"+dimensionName+"inlayer"+resource.prefixedName()+"notpossible,thedefaultvaluestrategyisafixedvalueone");
if(!(genericReaderinstanceofStructuredGridCoverage2DReader)){thrownewIllegalStateException("Cannotperformdynamincdomainrestrictionunlessthereaderisastructuredone");
if(coverageName==null){coverageName=reader.getGridCoverageNames()[0];
if(descriptor==null){thrownewServiceException("Couldnotfinddimension"+name+"incoveragereaderbacking"+resource.prefixedName());
if(dd==null){thrownewServiceException("Couldnotfinddimension"+dimensionName+"incoveragereaderbacking"+resource.prefixedName());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Computeddefaultvaluefor"+dimensionName+"inlayer"+resource.prefixedName()+"using"+domainRestriction+"tolimitthedomainresultedinvalue:"+result);
if(delegateStrategyinstanceofCoverageMaximumValueSelectionStrategyImpl){
if(ea!=null){returnnewMaxVisitor(ea);
else{returnnewMaxVisitor(sa);
else
if(delegateStrategyinstanceofCoverageMinimumValueSelectionStrategyImpl){returnnewMinVisitor(sa);
else
if(delegateStrategyinstanceofCoverageNearestValueSelectionStrategyImpl){CoverageNearestValueSelectionStrategyImplimpl=(CoverageNearestValueSelectionStrategyImpl)delegateStrategy;ObjecttargetValue=impl.getTargetValue();returnnewNearestVisitor(ff.property(sa),targetValue);
else{thrownewServiceException("Don'tkonwhowtorestrictthedomainforstrategy"+delegateStrategy);
if(filter!=null&&!Filter.INCLUDE.equals(filter)){restrictedResource=newDecoratingFeatureTypeInfo(resource){@OverridepublicFeatureSourcegetFeatureSource(ProgressListenerlistener,Hintshints)throwsIOException{FeatureSourcefs=super.getFeatureSource(listener,hints);
if(!(fsinstanceofSimpleFeatureSource)){thrownewIllegalStateException("Cannotapplydynamicdimensionrestrictionstocomplexfeatures");
else{restrictedResource=resource;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Computingdefaultvaluefor"+config.getDimension()+"inlayer"+resource.prefixedName()+"usingthefollowingfiltertorestrictthedomain:"+filter);
if(value==null){returnnull;
else
if(valueinstanceofList){values=(List<Object>)value;
else{values=newArrayList<Object>();values.add(value);
if(ResourceInfo.TIME.equals(dimension)||ResourceInfo.ELEVATION.equals(dimension)){returndimension;
else{returnResourceInfo.CUSTOM_DIMENSION_PREFIX+dimension;
if(ResourceInfo.TIME.equals(dimension)){returnDate.class;
else
if(ResourceInfo.ELEVATION.equals(dimension)){returnDouble.class;
else{returnString.class;
ifneedsbereturn(ExtensionPriority.HIGHEST+ExtensionPriority.LOWEST)/2;}}
iftheclippinggeometrymustbeexactlythatoftheROIorsimplyits*envelope*@paramfilterthe{@linkFilter}toloadthedata*@paraminterpolationinterpolationmethodtousewhenreprojecting/scaling*@paramtargetSizeXthesizeofthetargetimagealongtheXaxis*@paramtargetSizeYthesizeofthetargetimagealongtheYaxis*@parambandIndicestheindicesofthebandsusedforthefinalresult*@paramwriteParamsoptionalwritingparams*/publicResourceexecute(StringmimeType,finalProgressListenerprogressListener,CoverageInfocoverageInfo,Geometryroi,CoordinateReferenceSystemtargetCRS,booleanclip,Filterfilter,Interpolationinterpolation,IntegertargetSizeX,IntegertargetSizeY,int[]bandIndices,ParameterswriteParams)throwsException{List<GridCoverage2D>disposableSources=newArrayList<GridCoverage2D>();GridCoverage2DgridCoverage=null;try{CoordinateReferenceSystemnativeCRS=DownloadUtilities.getNativeCRS(coverageInfo);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("NativeCRSis"+nativeCRS.toWKT());
if(targetCRS!=null&&!CRS.equalsIgnoreMetadata(nativeCRS,targetCRS)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Checking
ifreprojectionisneeded");
if(!reprojectionTrasform.isIdentity()){//avoiddoingthetransform
ifthisistheidentityreproject=true;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Reprojectionneeded");
else{targetCRS=nativeCRS;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Gettingreaderforthecoverage");
ifneededGridGeometry2DrequestedGridGeometry=null;ReferencedEnvelopetargetEnvelope=null;booleanisImposedTargetSize=targetSizeX!=null||targetSizeY!=null;ROIManagerroiManager=null;
if(roi!=null){roiManager=newROIManager(roi,(CoordinateReferenceSystem)roi.getUserData());//setcrsinroimanagerroiManager.useNativeCRS(reader.getCoordinateReferenceSystem());roiManager.useTargetCRS(targetCRS);targetEnvelope=newReferencedEnvelope(roiManager.getRoiInTargetCRS().getEnvelopeInternal(),targetCRS);
else{targetEnvelope=newReferencedEnvelope(reader.getOriginalEnvelope());
if(reproject){targetEnvelope=targetEnvelope.transform(targetCRS,true);
if(targetSizeX==null&&targetSizeY==null){//Nosizeisspecified.Justdoareadandreproject(ifneeded)+afinalcrop
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"NoTargetsizehasbeenspecified.RequestedGridGeometry"+"willbeautomaticallycomputed");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"ComputedrequestedGridGeometry:"+requestedGridGeometry.toString());
else{
if(targetSizeX==null||targetSizeY==null){//oneofthe2sizesisnotspecified.Delegate//scaleToTargettocomputethesecondone.ScaleToTargetscaling=newScaleToTarget(reader);scaling.setTargetSize(targetSizeX,targetSizeY);Integer[]computedSizes=scaling.getTargetSize();targetSizeX=computedSizes[0];targetSizeY=computedSizes[1];
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Targetsizehasbeenspecified.SettinguprequestedGridGeometry:"+requestedGridGeometry.toString());
ifthereaderdoesn'tsupportbandsgridCoverage=bandSelect(reader,readParameters,bandIndices,gridCoverage,disposableSources);////Handleclip/crop/extendtoregion//
if(roi!=null){//ROIrequiresacrop/clipbooleancrop=true;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"HandlingROI");
if(isImposedTargetSize){crop=false;//TheremightbethecasethatGridCoverageRendereralready//providedwhatrequestedfinalRenderedImagerasterData=gridCoverage.getRenderedImage();finalGridEnveloperequestedRange=(GridEnvelope)requestedGridGeometry.getGridRange();//PreliminarcheckbetweenrequestedimageLayoutandcoverageimageLayoutfinalintrequestedW=requestedRange.getSpan(0);finalintrequestedH=requestedRange.getSpan(1);finalintimageW=rasterData.getWidth();finalintimageH=rasterData.getHeight();
if((imageW==requestedW)&&(imageH==requestedH)&&!clip){//Norefiningisneeded.Writeitasis
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"NoCropisneeded."+"WritingthecoverageasprovidedbyGridCoverageRenderer");
else{//Check
ifanactualcropisneededcrop=cropIsNeeded(rasterData,requestedRange);
if(!crop&&!clip){//Theextentofthereturnedimageissmallerthantherequested//extent.//Let'sdoamosaictoreturntherequestedextentinstead.
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Expandingtheresulttotherequestedarea");
if(crop||clip){//CroporClipfinalCropCoveragecropCoverage=newCropCoverage();//GettheproperROI(dependingonclipparameterandCRS)GeometrycroppingRoi=roiManager.getTargetRoi(clip);disposableSources.add(gridCoverage);gridCoverage=cropCoverage.execute(gridCoverage,croppingRoi,progressListener);
if(gridCoverage==null){thrownewWPSException("NodataleftafterapplyingtheROI.Thismeansthere"+"issourcedata,butnonematchingtherequestedROI");
if(isImposedTargetSize){//DelegatetheGridCoverageRenderertodoalltheworkofreprojection/interpolation
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"TargetSizehasbeenimposed.DelegatingtoGridCoverageRenderer");
if(ri==null){thrownewWPSException("Thereaderdidnotreturnanything"+"Itnormallymeansthereisnothingthere,orthedatagotfilteredoutbytheROIorfilter");
else{//Ifnot,proceedwithstandardreadandreproject
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Readingthecoverage");
if(gridCoverage==null){thrownewWPSException("Thereaderdidnotreturnanydataforcurrentinput"+"parameters.Itnormallymeansthereisnothingthere,orthedatagotfilteredoutbytheROIorfilter");
ifneeded
if(reproject){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Reprojectingthecoverage");
if(coverageParameters!=null&&coverageParameters.containsKey("BackgroundValues")){for(GeneralParameterValuereadParameter:readParameters){
if("BackgroundValues".equalsIgnoreCase(readParameter.getDescriptor().getName().toString())){ObjectbgValue=((ParameterValue)readParameter).getValue();
if(bgValue!=null&&bgValueinstanceofdouble[]){backgroundValues=((double[])bgValue);
ifacropoperationisneeded(meaningthattheextentofthereturnedimagecontains*therequestedextent).**@paramrasterData*@paramrequestedRange*@return*/privatebooleancropIsNeeded(RenderedImagerasterData,GridEnveloperequestedRange){finalintrequestedW=requestedRange.getSpan(0);finalintrequestedH=requestedRange.getSpan(1);finalintrequestedMinX=requestedRange.getLow(0);finalintrequestedMinY=requestedRange.getLow(1);finalintrequestedMaxX=requestedRange.getHigh(0);finalintrequestedMaxY=requestedRange.getHigh(1);finalintimageW=rasterData.getWidth();finalintimageH=rasterData.getHeight();finalintminX=rasterData.getMinX();finalintminY=rasterData.getMinY();finalintmaxX=minX+imageW-1;finalintmaxY=minY+imageH-1;
if(((imageW+((minX>=0)?0:minX))>=requestedW)&&((imageH+((minY>=0)?0:minY))>=requestedH)&&((requestedMinX>=minX)&&(requestedMinY>=minY)&&(requestedMaxX<=maxX)&&(requestedMaxY<=maxY))){//Theextentofthereturnedimagecontainstherequestedextent.//Let'sdoacropreturntrue;
if(bandIndices!=null&&bandIndices.length>0){//DothereadersupportsBANDSparam?for(GeneralParameterValuereadParameter:readParameters){
if(AbstractGridFormat.BANDS.getName().equals(readParameter.getDescriptor().getName())){Objectbands=((ParameterValue)readParameter).getValue();
if(bands!=null&&reader.getFormat()!=null&&reader.getFormat().getReadParameters().getDescriptor().descriptors().contains(AbstractGridFormat.BANDS)){//Bandselectionhasbeenmadeatreader'slevel.//NoneedtodoabandSelectprocess.returnbandFilteredCoverage;
if(i<0||i>=sampleDimensionsNumber){thrownewWPSException("Bandindex"+i+"isinvalidforthecurrentinputraster."+"Thisrastercontains"+sampleDimensionsNumber+"band"+(sampleDimensionsNumber>1?"s":""));
ifremappingisnotpossibledisposableSources.add(originalGridCoverage);bandFilteredCoverage=bandSelectProcess.execute(originalGridCoverage,bandIndices,null);
if(filter!=null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Addthefilter");
if(AbstractGridFormat.USE_JAI_IMAGEREAD.getName().getCode().equals(pdCode)){replacedJai=true;ParameterValuepvalue=(ParameterValue)pv;pvalue.setValue(Boolean.TRUE);break;
if(!replacedJai){readParameters=CoverageUtils.mergeParameter(parameterDescriptors,readParameters,Boolean.TRUE,AbstractGridFormat.USE_JAI_IMAGEREAD.getName().getCode());
if(AbstractGridFormat.BANDS.getName().getCode().equals(pdCode)){replacedBands=true;ParameterValuepvalue=(ParameterValue)pv;pvalue.setValue(bandIndices);break;
if(!replacedBands){readParameters=CoverageUtils.mergeParameter(parameterDescriptors,readParameters,bandIndices,AbstractGridFormat.BANDS.getName().getCode());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Writingraster");
if(limits.getHardOutputLimit()>0){limit=limits.getHardOutputLimit();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Hardoutputlimitssetto"+limit);
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Hardoutputlimitunset");
if(ppio_==null){thrownewProcessException("Don'tknowhowtoencodeinmimetype"+mimeType);
else
if(!(ppio_instanceofComplexPPIO)){thrownewProcessException("InvalidPPIOfound"+ppio_.getIdentifer());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Writingfileinatemporaryfolder");
iftheprocessistryingtowritermore//thanthemaxallowedbytesfinalImageOutputStreamfileImageOutputStreamExtImpl=newImageOutputStreamAdapter(output.out());ImageOutputStreamos=null;//writetry{//Iflimitisdefined,LimitedImageOutputStreamisused
if(limit>DownloadServiceConfiguration.NO_LIMIT){os=newLimitedImageOutputStream(fileImageOutputStreamExtImpl,limit){@OverrideprotectedvoidraiseError(longpSizeMax,longpCount)throwsIOException{IOExceptione=newIOException("DownloadExceededthemaximumHARDallowedsize!");throwe;
else{os=fileImageOutputStreamExtImpl;
if(os!=null){os.close();
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,e.getLocalizedMessage(),e);
if(count==0){returnnull;
else
if(count==1){returnxpath.evaluate("//"+typeName+"/@fid",doc);
else{fail("Foundmorethanonefeature:"+count);returnnull;//justtomakethecompilerhappy,failthrowsanuncheckedexception
if((c.isAssignableFrom(String.class))||(c.isAssignableFrom(Boolean.class))||(c.isAssignableFrom(Integer.class))||(c.isAssignableFrom(Float.class))||(c.isAssignableFrom(Double.class))||(c.isAssignableFrom(Geometry.class))){ftype.put(p.getName(),c);
if(oldftype==null){oldftype=ftype;type=getType(ftype);featureBuilder=newSimpleFeatureBuilder(type);features=newListFeatureCollection(type);
else{
if(!oldftype.equals(ftype)){break;
if(crs!=null&&!CRS.equalsIgnoreMetadata(crs,DefaultGeographicCRS.WGS84)){fcObj=newReprojectingFeatureCollection(fcObj,DefaultGeographicCRS.WGS84);
if(document==null){thrownewServiceException("Codingerrorindecorator"+decorator+",documentobjectscannotbesettonull");
if(folder==null){break;
if(folder==null){continue;
ifnotpresent
if(info.getMetadata()==null){info.setMetadata(newMetadataMap());
ifthecoveragehasbeenplacedinsidethedefineddirectory**@paramroot*@paramworkspace*@paramcoverageStore*@paramfileName*@throwsIOException*@throwsParserConfigurationException*@throwsSAXException*/privatevoidtestExpression(Stringworkspace,StringcoverageStore,Stringexpression,List<String>fileNames)throwsIOException,Exception,ParserConfigurationException,SAXException{//InitialSettingsinitialSetup(expression);//SelectionofazipfileURLzip=MockData.class.getResource("watertemp.zip");//byte[]bytes=FileUtils.readFileToByteArray(URLs.urlToFile(zip));InputStreamis=null;byte[]bytes;try{is=zip.openStream();bytes=IOUtils.toByteArray(is);
ifnotalreadypresentcreateWorkSpace(workspace);//UploadingthefileviarestMockHttpServletResponseresponse=putAsServletResponse("/rest/workspaces/"+workspace+"/coveragestores/"+coverageStore+"/file.imagemosaic",bytes,"application/zip");assertEquals(201,response.getStatus());//Check
ifthecoverageispresentStringcontent=response.getContentAsString();Documentd=dom(newByteArrayInputStream(content.getBytes()));assertEquals("coverageStore",d.getDocumentElement().getNodeName());//FinalchecksCoverageStoreInfocs=getCatalog().getCoverageStoreByName(workspace,coverageStore);assertNotNull(cs);CoverageInfoci=getCatalog().getCoverageByName(workspace,coverageStore);assertNotNull(ci);//Check
ifthefinalpathiscorrectforeachinputfilefor(StringfileName:fileNames){//FilerelatedtothefilenameeFilefinalFile=extractFile(expression,cs,fileName,fileName);//Check
ifthefilereallyexistsassertTrue(finalFile.exists());
iftheworkspaceisalreadypresent
if(getCatalog().getWorkspaceByName(workspace)!=null){return;
if(buildId<32){querySequenceString="selectnamefrominformation_schema.sequences";
if(e.getSQLState().startsWith("23")){Stringmessage=e.getMessage();intidx=message.indexOf("violation:");
if(idx>0){constraintName=message.substring(idx+"violation:".length());
ifnotexists";
if(CapabilitiesSectionType.get(value)==null)thrownewWcsException("Couldnotfindsection'"+value+"'",InvalidParameterValue,"section");returnCapabilitiesSectionType.get(value);}}
if(coverageAccess==null){coverageAccess=newCoverageAccessInfoImpl();geoserverInfo.setCoverageAccess(coverageAccess);
if(propertyNames.contains("coverageAccess")){//MakesuretoproceedwithcoverageAccessinit//onlyincasetheglobalchangeinvolvedthatsectioninitCoverage(global.getCoverageAccess());
if(coverageAccess!=null){ThreadPoolExecutorexecutor=coverageAccess.getThreadPoolExecutor();//Firstinitialization
if(executor==null){finalHintsdefHints=GeoTools.getDefaultHints();//LookingforexecutorfromdefaultHints
if(defHints!=null&&defHints.containsKey(Hints.EXECUTOR_SERVICE)){executor=(ThreadPoolExecutor)defHints.get(Hints.EXECUTOR_SERVICE);
if(executor==null){//NoExecutorfound:Createanewoneexecutor=newThreadPoolExecutor(coverageAccess.getCorePoolSize(),coverageAccess.getMaxPoolSize(),coverageAccess.getKeepAliveTime(),TimeUnit.MILLISECONDS,coverageAccess.getQueueType()==QueueType.UNBOUNDED?newLinkedBlockingQueue<Runnable>():newSynchronousQueue<Runnable>());coverageAccess.setThreadPoolExecutor(executor);
else{////////Overridingvalues//////finalBlockingQueue<Runnable>queue=executor.getQueue();finalQueueTypequeueType=coverageAccess.getQueueType();//Ifthequeuetypeisthesame,Icansimplyoverridetheparametersettings.
if((queueinstanceofLinkedBlockingQueue&&queueType==QueueType.UNBOUNDED)||(queueinstanceofSynchronousQueue&&queueType==QueueType.DIRECT)){executor.setCorePoolSize(coverageAccess.getCorePoolSize());executor.setMaximumPoolSize(coverageAccess.getMaxPoolSize());executor.setKeepAliveTime(coverageAccess.getKeepAliveTime(),TimeUnit.MILLISECONDS);coverageAccess.setThreadPoolExecutor(executor);
else{//Thequeuetypehasbeenchanged.InitializinganewThreadPoolExecutorby//previouslyshuttingdownthecurrentoneexecutor.shutdown();
if(!executor.isTerminated()){executor.shutdownNow();
ifthisresourceisfromamulti-coveragereader*/booleanmultiCoverageReader;publicvoidsetPublished(booleanpublished){this.published=published;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;Resourceother=(Resource)obj;
if(name==null){
if(other.name!=null)returnfalse;
else
if(!name.equals(other.name))returnfalse;returntrue;
if(published&&!o.published)return-1;
else
if(!published&&o.published)return1;//thecomparebylocalname,asit'sunlikelytheuserswillseethe//namespaceURI(andtheprefixisnotavailableinName)returnname.compareTo(o.name);
if(service==null&&(method!=null||outputFormat!=null))thrownewIllegalArgumentException("InvalidOWSdefinition,servicecannotbenonnullwhenmethod"+"oroutputformatareprovided");
else
if(method==null&&outputFormat!=null)thrownewIllegalArgumentException("InvalidOWSdefinition,outputformatcannotbevalued
if"+"methodisnotprovided");
if(service==null){return"AnyOGCrequest";
else{StringBuildersb=newStringBuilder();sb.append(service);
if(method!=null){sb.append(".").append(method);
if(outputFormat!=null){sb.append(".=").append(outputFormat);
if(service==null){returntrue;
else
if(!service.equalsIgnoreCase(request.getService())){returnfalse;
if(method==null){returntrue;
else
if(!method.equalsIgnoreCase(request.getRequest())){returnfalse;
if(outputFormat==null){returntrue;
else
if(!outputFormat.equalsIgnoreCase(request.getOutputFormat())){returnfalse;
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;OWSRequestMatcherother=(OWSRequestMatcher)obj;
if(method==null){
if(other.method!=null)returnfalse;
else
if(!method.equals(other.method))returnfalse;
if(outputFormat==null){
if(other.outputFormat!=null)returnfalse;
else
if(!outputFormat.equals(other.outputFormat))returnfalse;
if(service==null){
if(other.service!=null)returnfalse;
else
if(!service.equals(other.service))returnfalse;returntrue;}}
ifmodeldatahaschanged*/booleandirty=false;protectedGeoServerDialogdialog;publicAbstractSecurityPage(){add(dialog=newGeoServerDialog("dialog"));
if(returnPageinstanceofAbstractSecurityPage){((AbstractSecurityPage)returnPage).setDirty(dirty);
if(object==null)returnnull;//wrappingcheckClassclazz=object.getClass();
if(!canSecure(clazz))thrownewIllegalArgumentException("Don'tknowhowtowrapobjectsofclass"+object.getClass());//returnasis,implementationsofOpenSearchAccessarereadonlyreturnobject;
ifthecacheditemisuptodate,*andavoidsfloodingthefilesystemwithexcessiveIOrequestsbypreventingtheup-to-datecheck*tobehittingthefilesystemtoooften(atmostoncepersecond)**@authorAndreaAime-GeoSolutions*@param<T>*/classCacheItem<TextendsObject>{staticfinallongMIN_INTERVALS_CHECK=1000;Titem;longlastModified;longlastChecked;publicCacheItem(Titem,ResourcesourceFile){this.item=item;this.lastModified=sourceFile.lastmodified();
if(now-lastChecked<MIN_INTERVALS_CHECK){returntrue;
else{lastChecked=now;longactualLastModified=file.lastmodified();returnactualLastModified==lastModified;
if(csw.exists()){csw.delete();
ifwehavedefaultmappingFilerecord=newFile(csw,"Record.properties");assertTrue(record.exists());assertNotNull(store.getMapping("MD_Metadata").getElement("fileIdentifier.CharacterString"));assertNotNull(store.getMapping("Record").getElement("identifier.value"));assertNull(store.getMapping("Record").getElement("format.value"));//modifymappingfile//waitonesecond,sothemodificationtimewillchangeandchangeisdetected(onlinux//theresolutionis1sinsteadof1ms)Thread.sleep(1001);PrintWriterout=newPrintWriter(newBufferedWriter(newFileWriter(record,true)));out.println("\nformat.value='img/jpeg'");out.close();//waitonesecond,thatisexactlywhatittakesFileWatchertoupdateThread.sleep(1001);//mappingshouldbeautomaticallyreloadedassertEquals("img/jpeg",store.getMapping("Record").getElement("format.value").getContent().toString());}}
if(SKIP_TESTS){LOGGER.warning(ERROR_LIB_MESSAGE);return;
if(SKIP_TESTS){LOGGER.warning(ERROR_LIB_MESSAGE);return;
if(SKIP_TESTS){LOGGER.warning(ERROR_LIB_MESSAGE);return;
if(attributes!=null){start(elementName,attributes);
else{start(elementName);
if(contentsEncoder!=null){contentsEncoder.run();
switchtotheeditpagetester.assertRenderedPage(LayerGroupEditPage.class);tester.assertErrorMessages((Serializable[])newString[]{"Field'Bounds'isrequired."});
if(matcher.apply(element)){//elementfoundfound=true;break;
ifthexformisanaffineXform,youcanbeabitmoreaggressiveinthedecimation.*Ifitsnotanaffinexform(ie.itsactuallydoingaCRSxform),youmayfindthisisabit*tooaggressiveduetoanynumberofmathematicalissues.**<p>Thisisjustasimplemethodthatusesthecentreofthegivenrectangleinsteadof(0,0).**<p>NOTE:thiscouldneedmoreworkbasedonCRS,buttherectangleisinpixelssoitshould*befairlyimmunetoallbutcrazyprojections.**@paramscreenToWorld*@parampaintArea*/publicDecimator(MathTransformscreenToWorld,RectanglepaintArea){
if(screenToWorld!=null){double[]original=newdouble[]{paintArea.x+paintArea.width/2.0,paintArea.y+paintArea.height/2.0,paintArea.x+paintArea.width/2.0+1,paintArea.y+paintArea.height/2.0+1,};double[]coords=newdouble[4];try{screenToWorld.transform(original,0,coords,0,2);
else{this.spanx=1;this.spany=1;
ifyou'realsodoingCRSxforms.*/publicDecimator(MathTransformscreenToWorld){this(screenToWorld,newRectangle());//doat(0,0)
if(geometryinstanceofGeometryCollection){GeometryCollectioncollection=(GeometryCollection)geometry;finalintlength=collection.getNumGeometries();for(inti=0;i<length;i++){decimateTransformGeneralize(collection.getGeometryN(i),transform);
else
if(geometryinstanceofPoint){LiteCoordinateSequenceseq=(LiteCoordinateSequence)((Point)geometry).getCoordinateSequence();decimateTransformGeneralize(seq,transform);
else
if(geometryinstanceofPolygon){Polygonpolygon=(Polygon)geometry;decimateTransformGeneralize(polygon.getExteriorRing(),transform);finalintlength=polygon.getNumInteriorRing();for(inti=0;i<length;i++){decimateTransformGeneralize(polygon.getInteriorRingN(i),transform);
else
if(geometryinstanceofLineString){LiteCoordinateSequenceseq=(LiteCoordinateSequence)((LineString)geometry).getCoordinateSequence();decimateTransformGeneralize(seq,transform);
if(!coords[0].equals2D(coords[coords.length-1]))coords[coords.length-1]=coords[0];
if(spanx==-1)returngeom;
if(geominstanceofMultiPoint){//TODOcheckgeometryand
ifitsbboxistoosmallturnitintoa1//pointgeomreturngeom;
if(geominstanceofGeometryCollection){//TODOcheckgeometryand
ifitsbboxistoosmallturnitintoa//1-2pointgeom//takesabitofworkbecausethegeometrywillneedtobe//recreated.GeometryCollectioncollection=(GeometryCollection)geom;Geometry[]result=newGeometry[collection.getDimension()];finalintnumGeometries=collection.getNumGeometries();for(inti=0;i<numGeometries;i++){result[i]=decimate(collection.getGeometryN(i));
else
if(geominstanceofLineString){LineStringline=(LineString)geom;CoordinateSequenceseq=(CoordinateSequence)line.getCoordinateSequence();LiteCoordinateSequencelseq=newLiteCoordinateSequence(seq.toCoordinateArray());
if(decimateOnEnvelope(line,lseq)){
if(lseq.size()>=2)returngFac.createLineString(lseq);
if(lseq.size()>=2)returngFac.createLineString(decimate(lseq));returnnull;
else
if(geominstanceofPolygon){Polygonline=(Polygon)geom;Coordinate[]exterior=decimate(line.getExteriorRing()).getCoordinates();forceClosed(exterior);
if(exterior.length>3){LinearRingring=gFac.createLinearRing(exterior);finalintnumRings=line.getNumInteriorRing();List<LinearRing>rings=newArrayList<LinearRing>();for(inti=0;i<numRings;i++){Coordinate[]interior=decimate(line.getInteriorRingN(i)).getCoordinates();forceClosed(interior);
if(interior.length>3)rings.add(gFac.createLinearRing(interior));
if(env.getWidth()<=spanx&&env.getHeight()<=spany){double[]coords=seq.getArray();intdim=seq.getDimension();double[]newcoords=newdouble[dim*2];for(inti=0;i<dim;i++){newcoords[i]=coords[i];newcoords[dim+i]=coords[coords.length-dim+i];
if(ncoords<2){
if(ncoords==1)//1coordinate--justxformit{double[]newCoordsXformed2=newdouble[2];transform.transform(originalOrds,0,newCoordsXformed2,0,1);seq.setArray(newCoordsXformed2);return;
elsereturn;//ncoords=0
ifthisoneshouldbeaddeddoublex=originalOrds[t*2];doubley=originalOrds[t*2+1];
if((Math.abs(x-lastX)>spanx)||(Math.abs(y-lastY))>spany){allCoords[actualCoords*2]=x;allCoords[actualCoords*2+1]=y;lastX=x;lastY=y;actualCoords++;
if((transform==null)||(transform.isIdentity()))//noactual//xform{newCoordsXformed=allCoords;
else{newCoordsXformed=newdouble[actualCoords*2];transform.transform(allCoords,0,newCoordsXformed,0,actualCoords);
ifthisoneshouldbeaddeddoublex=newCoordsXformed[t*2];doubley=newCoordsXformed[t*2+1];
if((Math.abs(x-lastX)>0.75)||(Math.abs(y-lastY))>0.75)//0.75//insteadof1justbecauseittendstolooknicerforslightly//morework.magicnumber.{finalCoords[actualCoordsGen*2]=x;finalCoords[actualCoordsGen*2+1]=y;lastX=x;lastY=y;actualCoordsGen++;
if(currentDoubles>=dim&&currentDoubles<numDoubles-1){prevx=coords[readDoubles-dim];currx=coords[currentDoubles];diffx=Math.abs(prevx-currx);prevy=coords[readDoubles-dim+1];curry=coords[currentDoubles+1];diffy=Math.abs(prevy-curry);
if(diffx>spanx||diffy>spany){readDoubles=copyCoordinate(coords,dim,readDoubles,currentDoubles);
else{readDoubles=copyCoordinate(coords,dim,readDoubles,currentDoubles);
ifaprocessisdefinedinboththeGeoServerwps-core*applicationContext.xmlandinaGeoToolsfactory.(Thisisn'tafunctionalproblem,butis*confusingwhendisplayedintheUIandlistedinGetCapabilities).**@authorMartinDavis,OpenGeo*/publicclassUniqueProcessNamesTestextendsWPSTestSupport{@TestpublicvoidtestNamesUnique()throwsException{List<String>procs=newArrayList<String>();Set<String>uniqueProcs=newHashSet<String>();for(ProcessFactorypf:GeoServerProcessors.getProcessFactories()){for(Namename:pf.getNames()){StringprocName=name.getURI();procs.add(procName);uniqueProcs.add(procName);
if(procs.size()>0){System.out.println("Duplicateprocessnames:"+procs);
if(name.equals(pd.getName().getLocalPart())){returnpd;
if(pd==null){returnnull;
else{return(String)pd.getUserData().get(JDBCOpenSearchAccess.SOURCE_ATTRIBUTE);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Incomingmessageeventforsession:"+session.toString());
if(!isEnabled()){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Incomingmessageisswallowedsincethiscomponentisdisabled");
if(!message.propertyExists(JMSConfiguration.INSTANCE_NAME_KEY)){thrownewJMSException("Unabletohandleincomingmessage,property\'"+JMSConfiguration.INSTANCE_NAME_KEY+"\'notset.");
if(!message.propertyExists(JMSConfiguration.GROUP_KEY)){thrownewJMSException("Unabletohandleincomingmessage,property\'"+JMSConfiguration.GROUP_KEY+"\'notset.");
ifmessagecomesfromamasterwiththesamenameofthisslave
if(message.getStringProperty(JMSConfiguration.INSTANCE_NAME_KEY).equals(config.getConfiguration(JMSConfiguration.INSTANCE_NAME_KEY))){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Incomingmessagediscarded:sourceisequaltodestination");
ifsodiscardthemessagereturn;
ifmessagecomesfromadifferentgroupfinalStringgroup=message.getStringProperty(JMSConfiguration.GROUP_KEY);finalStringlocalGroup=config.getConfiguration(JMSConfiguration.GROUP_KEY);
if(!group.equals(localGroup)){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Incomingmessagediscarded:incominggroup-->"+group+"isdifferentfromthelocalone-->"+localGroup);
ifsodiscardthemessagereturn;
if(!message.propertyExists(JMSEventHandlerSPI.getKeyName()))thrownewJMSException("Unabletohandleincomingmessage,property\'"+JMSEventHandlerSPI.getKeyName()+"\'notset.");//END->FILTERINGINCOMINGMESSAGE//getthenameoftheSPIusedtoserializethemessagefinalStringgeneratorClass=message.getStringProperty(JMSEventHandlerSPI.getKeyName());
if(generatorClass==null||generatorClass.isEmpty()){thrownewIllegalArgumentException("Unabletohandleamessagewithoutageneratorclassname");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine("Incomingmessagewasserializedusinganhandlergeneratedby:\'"+generatorClass+"\'");
if(messageinstanceofObjectMessage){finalObjectMessageobjMessage=(ObjectMessage)(message);finalSerializableobj=objMessage.getObject();try{//lookuptheSPIhandler,searchisperformedusingthe//namefinalJMSEventHandler<Serializable,Object>handler=jmsManager.getHandlerByClassName(generatorClass);
if(handler==null){thrownewJMSException("UnabletofindSPInamed\'"+generatorClass+"\',beshuretoloadthatSPIintoyourcontext.");
if(!handler.synchronize(handler.deserialize(obj))){thrownewJMSException("Unabletosynchronizemessagelocally.\nSPI:"+generatorClass);
elsethrownewJMSException("Unrecognizedmessagetypeforcatalogincomingevent");
if(messageinstanceofStreamMessage){//StreamMessagestreamMessage=StreamMessage.class.cast(message);////Filefile;////FILTERINGincomingmessage////
if(!message.propertyExists(JMSEventType.FILENAME_KEY))////thrownewJMSException(////"Unabletohandleincomingmessage,property\'"////+JMSEventType.FILENAME_KEY+"\'notset.");////FileOutputStreamfos=null;//try{//file=newFile(GeoserverDataDirectory//.getGeoserverDataDirectory().getCanonicalPath(),"");////TODOgetfilename////message.getStringProperty(JMSEventType.FILENAME_KEY));//fos=newFileOutputStream(file);//finalintsize=1024;//finalbyte[]buf=newbyte[size];//intread=0;//streamMessage.reset();//while((read=streamMessage.readBytes(buf))!=-1){//fos.write(buf,0,read);//fos.flush();//
if(LOGGER.isErrorEnabled()){//LOGGER.error(e.getLocalizedMessage(),e);//
if(LOGGER.isErrorEnabled()){//LOGGER.error(e.getLocalizedMessage(),e);//
else//thrownewJMSException(//"Unrecognizedmessagetypeforcatalogincomingevent");//
if(resourceModel.getObject()instanceofCoverageInfo){CoverageInfocinfo=(CoverageInfo)resourceModel.getObject();cmodel=newModel<CoverageInfo>(cinfo);
if(!RemoteOWSTestSupport.isRemoteWFSStatesAvailable(LOGGER))return;HashMapraw=newHashMap();raw.put("layers","topp:states");raw.put("styles",MockData.BASIC_POLYGONS.getLocalPart());raw.put("format","image/png");raw.put("srs","epsg:4326");raw.put("bbox","-100,20,-60,50");raw.put("height","300");raw.put("width","300");raw.put("remote_ows_type","WFS");raw.put("remote_ows_url",RemoteOWSTestSupport.WFS_SERVER_URL);GetMapRequestrequest=(GetMapRequest)reader.createRequest();request=(GetMapRequest)reader.read(request,parseKvp(raw),caseInsensitiveKvp(raw));assertEquals("WFS",request.getRemoteOwsType());//TODO:handlecase?assertEquals(newURL(RemoteOWSTestSupport.WFS_SERVER_URL),request.getRemoteOwsURL());assertEquals(1,request.getLayers().size());assertEquals(PublishedType.REMOTE.getCode().intValue(),request.getLayers().get(0).getType());assertEquals("topp:states",request.getLayers().get(0).getName());
if(!RemoteOWSTestSupport.isRemoteWFSStatesAvailable(LOGGER))return;HashMapraw=newHashMap();raw.put("layers","topp:states");raw.put("format","image/png");raw.put("srs","epsg:4326");raw.put("bbox","-100,20,-60,50");raw.put("height","300");raw.put("width","300");raw.put("remote_ows_type","WFS");raw.put("remote_ows_url",RemoteOWSTestSupport.WFS_SERVER_URL);GetMapRequestrequest=(GetMapRequest)reader.createRequest();try{request=(GetMapRequest)reader.read(request,parseKvp(raw),caseInsensitiveKvp(raw));fail("Thisshouldhavethrownanexceptionbecauseofthemissingstyle");
if(!RemoteOWSTestSupport.isRemoteWFSStatesAvailable(LOGGER))return;HashMapraw=newHashMap();raw.put("layers","topp:states");raw.put("format","image/png");raw.put("srs","epsg:4326");raw.put("bbox","-100,20,-60,50");raw.put("height","300");raw.put("width","300");raw.put("remote_ows_type","WFS");raw.put("remote_ows_url","http://phantom.openplans.org:8080/crapserver/wfs?");GetMapRequestrequest=(GetMapRequest)reader.createRequest();try{request=(GetMapRequest)reader.read(request,parseKvp(raw),caseInsensitiveKvp(raw));fail("Thisshouldhavethrownanexceptionbecauseofthenonexistentlayer");
if(allowRemoteUrl){this.delegate=newUrlValidator();
if(uri.getScheme()!=null&&!"file".equals(uri.getScheme())){
if(delegate!=null){delegate.validate(validatable);InputStreamis=null;try{URLConnectionconnection=uri.toURL().openConnection();connection.setConnectTimeout(10000);is=connection.getInputStream();
else{//ok,stripawaytheschemeandjustgettothepathStringpath=uri.getPath();
if(path!=null&&newFile(path).exists()){return;
if(baseDirectory!=null){//localtoprovidedbaseDirectoryrelFile=Files.url(baseDirectory,uriSpec);
else
if(loader!=null){//localtodatadirectory?relFile=loader.url(uriSpec);
if(relFile==null||!relFile.exists()){IValidationErrorerr=newValidationError("FileExistsValidator.fileNotFoundError").addKey("FileExistsValidator.fileNotFoundError").setVariable("file",uriSpec);validatable.error(err);
ifnosuch*objectsareavailable.*/List<T>getExtensions(Class<T>extensionPoint);}
if(attName!=null){taskAttNames.add(attName);
if(att==null){att=TaskManagerBeans.get().getFac().createAttribute();att.setConfiguration(InitConfigUtil.unwrap(configurationModel.getObject()));att.setName(attName);attributes.put(attName,att);
if(att.getValue()!=null&&!"".equals(att.getValue())){attList.add(att);
if(!removeEmpty||att.getValue()!=null&&!"".equals(att.getValue())){configurationModel.getObject().getAttributes().put(att.getName(),att);
else{configurationModel.getObject().getAttributes().remove(att.getName());
if(csscontrib.appliesTo(this)){PackageResourceReferenceref=csscontrib.getFavicon();
if(ref!=null){faviconReference=ref;
if(faviconReference==null){faviconReference=newPackageResourceReference(GeoServerBasePage.class,"favicon.ico");
if(path.isEmpty()){//homepageloginPath.append("../"+info.getLoginPath());
else{//boomarkablepageofsortsString[]pathElements=path.split("/");for(StringpathElement:pathElements){
if(!pathElement.isEmpty()){loginPath.append("../");
if(info.getIcon()!=null){image=newImage("link.icon",newPackageResourceReference(info.getComponentClass(),info.getIcon()));
else{image=newImage("link.icon",newPackageResourceReference(GeoServerBasePage.class,"img/icons/silk/door-in.png"));
if(info.getTitleKey()!=null&&!info.getTitleKey().isEmpty()){loginForm.add(newLabel("link.label",newStringResourceModel(info.getTitleKey(),(Component)null,null)));image.add(AttributeModifier.replace("alt",newParamResourceModel(info.getTitleKey(),null)));
else{loginForm.add(newLabel("link.label",""));
if(info.getInclude()!=null){include=newLoginFormHTMLInclude("login.include",newPackageResourceReference(info.getComponentClass(),info.getInclude()));
else{include=newLoginFormHTMLInclude("login.include",newPackageResourceReference(GeoServerBasePage.class,""));
if(filterName.toLowerCase().contains(info.getName())){filterInChain=true;break;
if(path.isEmpty()){//homepagelogoutPath.append("../"+info.getLogoutPath());
else{//boomarkablepageofsortsString[]pathElements=path.split("/");for(StringpathElement:pathElements){
if(!pathElement.isEmpty()){logoutPath.append("../");
if(info.getIcon()!=null){image=newImage("link.icon",newPackageResourceReference(info.getComponentClass(),info.getIcon()));
else{image=newImage("link.icon",newPackageResourceReference(GeoServerBasePage.class,"img/icons/silk/door-out.png"));
if(info.getTitleKey()!=null&&!info.getTitleKey().isEmpty()){logoutForm.add(newLabel("link.label",newStringResourceModel(info.getTitleKey(),(Component)null,null)));image.add(AttributeModifier.replace("alt",newParamResourceModel(info.getTitleKey(),null)));
else{logoutForm.add(newLabel("link.label",""));
if(filterName.toLowerCase().contains(info.getName())){filterInChain=true;break;
if(info.getIcon()!=null){image=newImage("link.icon",newPackageResourceReference(info.getComponentClass(),info.getIcon()));
else{image=newImage("link.icon",newPackageResourceReference(GeoServerBasePage.class,"img/icons/silk/wrench.png"));
if(id==null){container.setVisible(false);
ifhe//needit)response.render(newPriorityHeaderItem(JavaScriptHeaderItem.forReference(getApplication().getJavaScriptLibrarySettings().getJQueryReference())));List<HeaderContribution>cssContribs=getGeoServerApplication().getBeansOfType(HeaderContribution.class);for(HeaderContributioncsscontrib:cssContribs){try{
if(csscontrib.appliesTo(this)){PackageResourceReferenceref=csscontrib.getCSS();
if(ref!=null){response.render(CssReferenceHeaderItem.forReference(ref));
if(ref!=null){response.render(JavaScriptHeaderItem.forReference(ref));
if(NODE_INFO==null){//see
ifsomeonepluggedacustomnodeinfobean,otherwiseusethedefaultoneGeoServerNodeInfoinfo=GeoServerExtensions.bean(GeoServerNodeInfo.class);
if(info==null){info=newDefaultGeoServerNodeInfo();
ifnot*found*/StringgetPageTitle(){try{return"GeoServer:"+getTitle();
if(!HEADER_PANEL.equals(component.getId()))thrownewIllegalArgumentException("Theheaderpanelcomponentmusthave'headerPanel'id");remove(HEADER_PANEL);add(component);
if(!map.containsKey(cat))map.put(cat,newArrayList<MenuPageInfo>());map.get(cat).add(page);
if(component.getAuthorizer()==null){continue;
if(!component.getAuthorizer().isAccessAllowed(clazz,user))continue;result.add(component);
if(returnPage!=null){setResponsePage(returnPage);return;
if(returnPageClass!=null){setResponsePage(returnPageClass);return;
if(cluster==null){cluster=HzCluster.getInstanceIfAvailable().orNull();
if(cluster!=null){topic().addMessageListener(this);
if(topic!=null){topic.publish(event);
else{LOGGER.warning("Failedtopublishresourcenotification,clusternotinitialized(yet).");super.changed(event);
if(config.getId().equals(c.getId())){returntrue;
if(i==0){assertEquals("",key);
else{assertEquals(""+i,key);assertTrue(data.has(key));
if(code==''){continue;
if(code>=93){code--;
if(code>=35){code--;
if(resultSet!=null){JdbcUtils.closeResultSet(resultSet);resultSet=null;JdbcUtils.closeConnection(connection);connection=null;
if(resultSet!=null){try{close();
if(store!=null){visitor.visit(store);
if(style!=null){visitor.visit(style);
if(data!=null&&Resources.exists(data)){data.delete();
if(!isQuietTests()){System.out.println(response.getContentAsString());
if("rocksdb".equals(provider.getName())){//wehaveaRocksDBprovideravailable,useitasthedefaultstorageProvider=provider;break;
if(null==DEFAULT_PROVIDER&&LOGGER.isLoggable(Level.INFO)){LOGGER.log(Level.INFO,"NoDefaultStorageProvideravailable");
if(null!=DEFAULT_PROVIDER){//setaPluginDefaultsusingthedefaultproviderPluginDefaultspluginDefaults=newPluginDefaults(DEFAULT_PROVIDER);bind(PluginDefaults.class).toInstance(pluginDefaults);
if(objectDatabaseFormat!=null){GeoServerContextBuilder.bind(objectPlugins,objectDatabaseFormat);
if(indexDatabaseFormat!=null){GeoServerContextBuilder.bind(indexPlugins,indexDatabaseFormat);
if(conflictsDatabaseFormat!=null){GeoServerContextBuilder.bind(graphPlugins,conflictsDatabaseFormat);
if(refsDatabaseFormat!=null){GeoServerContextBuilder.bind(refPlugins,refsDatabaseFormat);
if(repoProvider==null){repoProvider=newGeoServerRepositoryProvider();
if(List.class.isAssignableFrom(type)){return(IConverter<C>)decimalListConverter;
if(get("editor")!=null){remove("editor");
if(pt==ParameterType.TEXT){//aninternalvectorlayer
if(!(valueModel.getObject()instanceofString)){valueModel.setObject("");
else
if(pt==ParameterType.VECTOR_LAYER){//aninternalvectorlayer
if(!(valueModel.getObject()instanceofVectorLayerConfiguration)){valueModel.setObject(newVectorLayerConfiguration());
else
if(pt==ParameterType.RASTER_LAYER){//aninternalrasterlayer
if(!(valueModel.getObject()instanceofRasterLayerConfiguration)){valueModel.setObject(newRasterLayerConfiguration());
else
if(pt==ParameterType.REFERENCE){//anexternalreference
if(!(valueModel.getObject()instanceofReferenceConfiguration)){valueModel.setObject(newReferenceConfiguration());
else
if(pt==ParameterType.SUBPROCESS){
if(!(valueModel.getObject()instanceofExecuteRequest)){valueModel.setObject(newExecuteRequest());
if(((ExecuteRequest)valueModel.getObject()).processName!=null){try{xml.setModelObject(getExecuteXML());
else{xml.setModel(newModel(""));
else{error("Unsupportedparametertype");
if(li.getResource()instanceofFeatureTypeInfo){result.add(li.getResource().getPrefixedName());
if(li.getResource()instanceofCoverageInfo){result.add(li.getResource().getPrefixedName());
if(fail)fail("NoruntimeexceptionforreadonlyUserGroupService");
if(extended){data.add(data(11,"/foo","2010-08-23T15:26:44","2010-08-23T15:26:59","RUNNING","foo","x","widgets"));data.add(data(12,"/bar","2010-08-23T15:36:44","2010-08-23T15:36:47","WAITING","bar","y","things"));;data.add(data(13,"/baz","2010-08-23T15:46:44","2010-08-23T15:46:52","FINISHED","baz","x","stuff"));data.add(data(14,"/bam","2010-08-23T15:56:44","2010-08-23T15:56:48","FAILED","bam","x","widgets","things"));data.add(data(15,"/foo","2010-08-23T16:06:44","2010-08-23T16:06:45","RUNNING","foo","x","things","stuff"));data.add(data(16,"/foo","2010-08-23T16:16:44","2010-08-23T16:16:53","WAITING","foo","x","stuff"));data.add(data(17,"/bar","2010-08-23T16:26:44","2010-08-23T16:26:47","FINISHED","bar","z","things","stuff"));data.add(data(18,"/bam","2010-08-23T16:36:44","2010-08-23T16:36:46","FAILED","bam","y","widgets"));data.add(data(19,"/bam","2010-08-23T16:46:44","2010-08-23T16:46:53","CANCELLING","bam","y","stuff"));data.add(data(20,"/foo","2010-08-23T16:56:44","2010-08-23T16:56:47","RUNNING","foo","x","things"));
switch(type){case"metric":returnMETRIC;case"imperial":returnIMPERIAL;case"both":returnBOTH;default:thrownewException("Wronginputparameter");
if(options.get("fontsize")!=null){try{this.fontSize=Float.parseFloat(options.get("fontsize"));
if(options.get("dpi")!=null){try{this.dpi=Float.parseFloat(options.get("dpi"));
if(options.get("strokewidth")!=null){try{this.strokeWidth=Float.parseFloat(options.get("strokeWidth"));
if(tmp!=null)bgcolor=tmp;tmp=MapDecorationLayout.parseColor(options.get("fgcolor"));
if(tmp!=null)fgcolor=tmp;//Createsarectangleonly
ifisdefined,
ifnotis"transparent"likeGoogleMaps
if(options.get("transparent")!=null){try{this.transparent=Boolean.parseBoolean(options.get("transparent"));
if(options.get("measurement-system")!=null){try{LOGGER.log(Level.INFO,options.get("measurement-system"));this.measurementSystem=MeasurementSystem.mapToEnum(options.get("measurement-system"));
if(firstCharacter>5){barLength=5;
else
if(firstCharacter>2){barLength=2;
else{barLength=1;
if(maxWidth>paintArea.getWidth()){maxWidth=(int)paintArea.getWidth();
if(maxSizeData>100000){topUnits=topOutUnits;bottomUnits=bottomOutUnits;
else{topUnits=topInUnits;bottomUnits=bottomInUnits;
ifisdefined,
ifnotis"transparent"likeGoogleMaps
if(!this.transparent){Rectangleframe=newRectangle(leftX-4,centerY-prongHeight-4,Math.max(topPx,bottomPx)+8,8+prongHeight*2);//filltherectangleg2d.setColor(bgcolor);g2d.fill(frame);//drawtheborderframe.height-=1;frame.width-=1;g2d.setColor(fgcolor);g2d.setStroke(newBasicStroke(1));g2d.draw(frame);
else{g2d.setColor(fgcolor);
if(measurementSystem==METRIC||measurementSystem==BOTH){//Leftverticaltopbarg2d.drawLine(leftX,centerY,leftX,centerY-prongHeight);//Rightverticaltopbarg2d.drawLine(leftX+topPx,centerY,leftX+topPx,centerY-prongHeight);//Drawhorizontallineformetricg2d.drawLine(leftX,centerY,leftX+topPx,centerY);//Antialiastext
ifenabledg2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING,oldAntialias);//DrawtextmetricStringtopText=topRounded+""+topUnits;g2d.drawString(topText,leftX+(int)((topPx-metrics.stringWidth(topText))/2),centerY-prongHeight+metrics.getAscent());
if(measurementSystem==IMPERIAL||measurementSystem==BOTH){//Donotantialiasscalelinelinesg2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING,RenderingHints.VALUE_ANTIALIAS_OFF);//Leftverticalbottombarg2d.drawLine(leftX,centerY+prongHeight,leftX,centerY);//Rightverticalbottombarg2d.drawLine(leftX+bottomPx,centerY,leftX+bottomPx,centerY+prongHeight);//Drawhorizontalforimperialg2d.drawLine(leftX,centerY,leftX+bottomPx,centerY);//Antialiastext
ifenabledg2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING,oldAntialias);//DrawtextimperialStringbottomText=bottomRounded+""+bottomUnits;g2d.drawString(bottomText,leftX+(int)((bottomPx-metrics.stringWidth(bottomText))/2),centerY+metrics.getHeight());
if(its!=null){for(TemplateFeatureIteratorit:its){try{it.close();
if(open==null){open=newLinkedList();ITERATORS.set(open);
if(currentIndex>index){//wehavegonebackwards,closeiteratorandcleanupaswewillneedtostartover
if(indexIterator!=null){ITERATORS.get().remove(indexIterator);try{indexIterator.close();
if(indexIterator==null){indexIterator=(TemplateFeatureIterator)iterator();
ifitwheretheresultofa*GetFeatureWFSrequest.**@authorGabrielRoldan*/publicclassGML2FeatureInfoOutputFormatextendsGetFeatureInfoOutputFormat{/***TheMIMEtypeoftheformatthisresponseproduces:<code>"application/vnd.ogc.gml"</code>*/publicstaticfinalStringFORMAT="application/vnd.ogc.gml";privateWMSwms;/**Defaultconstructor,setsupthesupportedoutputformatstring.*/publicGML2FeatureInfoOutputFormat(finalWMSwms){super(FORMAT);this.wms=wms;
if(crs!=null){finalStringsrsName="EPSG:"+crs;try{qt.setSrsName(newURI(srsName));
if(lm1==lm2){return0;
else{returnlm1<lm2?-1:1;
if(l1==l2){return0;
else{returnl1<l2?-1:1;
if(comparator!=null)Collections.sort(files,comparator);//paginglonglast=first+count;
if(last>files.size()){last=files.size();
if(d.isFile())d=d.getParentFile();//returnafilteredviewofthecontentsFile[]files;
if(fileFilter!=null)files=d.listFiles(newHiddenFileFilter((FileFilter)fileFilter.getObject()));
elsefiles=d.listFiles(newHiddenFileFilter());
if(files!=null)returnArrays.asList(files);
elsereturnCollections.emptyList();
if(sort==null)returnFILE_NAME_COMPARATOR;//buildbasecomparatorComparator<File>comparator=null;
if(NAME.equals(sort.getProperty())){comparator=FILE_NAME_COMPARATOR;
else
if(LAST_MODIFIED.equals(sort.getProperty())){comparator=FILE_LM_COMPARATOR;
else
if(SIZE.equals(sort.getProperty())){comparator=FILE_SIZE_COMPARATOR;
else{thrownewIllegalArgumentException("Uknownsortingproperty"+sort.getProperty());
ifneeded
if(sort.isAscending())returncomparator;
elsereturnnewReverseComparator(comparator);
if(o1.isDirectory())
if(!o2.isDirectory())return-1;
if(o2.isDirectory())
if(!o1.isDirectory())return1;returncompareProperty(o1,o2);
if(pathname.isHidden()){returnfalse;
if(delegate!=null){returndelegate.accept(pathname);
else{returntrue;
if(ogr2ogrLocation!=null){returnogr2ogrLocation;
else{returnexecutable;
if(gdalData!=null){returnjava.util.Collections.singletonMap("GDAL_DATA",gdalData);
else{returnenvironment;
if(fc.getSchema()instanceofSimpleFeatureType){//Flattenthecollection
ifnecessary(therequestwasaWFS2.0joiningGetFeature//one,thefeaturescontainotherSimpleFeatureasattributes)fc=FlatteningFeatureCollection.flatten((SimpleFeatureCollection)fc);//writeouttheheaderSimpleFeatureTypeft=(SimpleFeatureType)fc.getSchema();w.write("FID,");for(inti=0;i<ft.getAttributeCount();i++){AttributeDescriptorad=ft.getDescriptor(i);w.write(prepCSVField(ad.getLocalName()));
if(i<ft.getAttributeCount()-1){w.write(",");
else{//complexfeaturesw.write("gml:id,");inti=0;for(PropertyDescriptoratt:fc.getSchema().getDescriptors()){//excludetemporaryattributes
if(!att.getName().getLocalPart().startsWith("FEATURE_LINK")){
if(i>0){w.write(",");
if(xsd!=null&&xsdinstanceofXSDElementDeclarationImpl){//gettheprefixedname
ifpossible//otherwisedefaultstothefullnamewithnamespaceURIXSDElementDeclarationImplxsdEl=(XSDElementDeclarationImpl)xsd;elName=xsdEl.getQName();
if(finstanceofSimpleFeature){//dumpattributesfor(intj=0;j<((SimpleFeature)f).getAttributeCount();j++){Objectatt=((SimpleFeature)f).getAttribute(j);
if(att!=null){Stringvalue=formatters[j].format(att);w.write(value);
if(j<((SimpleFeature)f).getAttributeCount()-1){w.write(",");
else{//complexfeatureIterator<PropertyDescriptor>descriptors=fc.getSchema().getDescriptors().iterator();//dumpattributesintj=0;while(descriptors.hasNext()){PropertyDescriptordesc=descriptors.next();
if(desc.getName().getLocalPart().startsWith("FEATURE_LINK")){//skiptemporaryattributescontinue;
if(j>0){w.write(",");
if(values.size()>1){thrownewUnsupportedOperationException("Multivaluedpropertiesaren'tsupportedwithCSVformat!");
if(!values.isEmpty()){att=values.iterator().next().getValue();
if(att!=null){Stringvalue=formatToString(att,coordFormatter);w.write(prepCSVField(value));
if(schemainstanceofSimpleFeatureType){//preparetheformatterfornumbersNumberFormatcoordFormatter=NumberFormat.getInstance(Locale.US);coordFormatter.setMaximumFractionDigits(getInfo().getGeoServer().getSettings().getNumDecimals());coordFormatter.setGroupingUsed(false);SimpleFeatureTypesft=(SimpleFeatureType)schema;AttrFormatter[]formatters=newAttrFormatter[sft.getAttributeCount()];inti=0;for(AttributeDescriptorattributeDescriptor:sft.getAttributeDescriptors()){Class<?>binding=attributeDescriptor.getType().getBinding();
if(Number.class.isAssignableFrom(binding)){formatters[i]=newNumberFormatter(coordFormatter);
else
if(java.sql.Date.class.isAssignableFrom(binding)){formatters[i]=sqlDateFormatter;
else
if(java.sql.Time.class.isAssignableFrom(binding)){formatters[i]=sqlTimeFormatter;
else
if(java.util.Date.class.isAssignableFrom(binding)){formatters[i]=juDateFormatter;
else{formatters[i]=defaultFormatter;
else{returnnull;
if(attinstanceofNumber){//don'tallowscientificnotationintheoutput,asOpenOfficewon't//recognizethatasanumbervalue=coordFormatter.format(att);
else
if(attinstanceofDate){//serializedatesinISOformat
if(attinstanceofjava.sql.Date)value=DateUtil.serializeSqlDate((java.sql.Date)att);
else
if(attinstanceofjava.sql.Time)value=DateUtil.serializeSqlTime((java.sql.Time)att);
elsevalue=DateUtil.serializeDateTime((Date)att);
else{//everything
elsewejust"toString"value=att.toString();
ifitcontainsdoublequotes,commas,ornewlines*/
if(CSV_ESCAPES.matcher(mod).find()){mod="\""+mod+"\"";
if(coverageinstanceofGridCoverage2D){((GridCoverage2D)coverage).dispose(true);
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
if(coverageinstanceofGridCoverage2D){((GridCoverage2D)coverage).dispose(true);
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
if(coverageinstanceofGridCoverage2D){((GridCoverage2D)coverage).dispose(true);
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
ifanexpressionisused*forthesymbolSize.*/@org.junit.TestpublicvoidtestSymbolContainedInIconUsingExpression()throwsException{GetLegendGraphicRequestreq=newGetLegendGraphicRequest();FeatureTypeInfoftInfo=getCatalog().getFeatureTypeByName(MockData.MPOINTS.getNamespaceURI(),MockData.MPOINTS.getLocalPart());req.setLayer(ftInfo.getFeatureType());req.setStyle(readSLD("SymbolExpression.sld"));BufferedImageimage=this.legendProducer.buildLegendGraphic(req);assertNotBlank("testSymbolContainedInIconUsingExpression",image,LegendUtils.DEFAULT_BG_COLOR);//backgroundatbordersassertPixel(image,1,20,newColor(255,255,255));//symbolinthecenter(secondsymbol,thefirstoneisattributedependentandwouldnot//bedrawnnormally)assertPixel(image,10,30,newColor(255,0,0));
ifusinguoms.*/@org.junit.TestpublicvoidtestProportionalSymbolSizeUOM()throwsException{GetLegendGraphicRequestreq=newGetLegendGraphicRequest();FeatureTypeInfoftInfo=getCatalog().getFeatureTypeByName(MockData.MPOINTS.getNamespaceURI(),MockData.MPOINTS.getLocalPart());req.setLayer(ftInfo.getFeatureType());req.setStyle(readSLD("ProportionalSymbolsUOM.sld"));BufferedImageimage=this.legendProducer.buildLegendGraphic(req);assertNotBlank("testProportionalSymbolSize",image,LegendUtils.DEFAULT_BG_COLOR);//biggestsymbolassertPixel(image,1,1,newColor(255,255,255));assertPixel(image,5,5,newColor(255,0,0));assertPixel(image,10,10,newColor(255,0,0));//secondsymbolassertPixel(image,1,21,newColor(255,255,255));assertPixel(image,5,25,newColor(255,255,255));assertPixel(image,7,27,newColor(255,0,0));assertPixel(image,10,30,newColor(255,0,0));//thirdsymbolassertPixel(image,1,41,newColor(255,255,255));assertPixel(image,5,45,newColor(255,255,255));assertPixel(image,6,46,newColor(255,255,255));assertPixel(image,10,50,newColor(255,0,0));//smallestsymbolassertPixel(image,1,61,newColor(255,255,255));assertPixel(image,6,68,newColor(255,255,255));assertPixel(image,10,70,newColor(255,0,0));
ifusinguomsinsomeSymbolizerand*notusingtheminothers.*/@org.junit.TestpublicvoidtestProportionalSymbolSizePartialUOM()throwsException{GetLegendGraphicRequestreq=newGetLegendGraphicRequest();req.setScale(RendererUtilities.calculatePixelsPerMeterRatio(10,Collections.EMPTY_MAP));FeatureTypeInfoftInfo=getCatalog().getFeatureTypeByName(MockData.MPOINTS.getNamespaceURI(),MockData.MPOINTS.getLocalPart());req.setLayer(ftInfo.getFeatureType());req.setStyle(readSLD("ProportionalSymbolsPartialUOM.sld"));BufferedImageimage=this.legendProducer.buildLegendGraphic(req);assertNotBlank("testProportionalSymbolSize",image,LegendUtils.DEFAULT_BG_COLOR);//UOMsymbolassertPixel(image,1,1,newColor(255,255,255));assertPixel(image,5,5,newColor(255,0,0));assertPixel(image,10,10,newColor(255,0,0));//nonUOMsymbolassertPixel(image,1,1,newColor(255,255,255));assertPixel(image,5,5,newColor(255,0,0));assertPixel(image,10,10,newColor(255,0,0));
ifthereisarenderingtransformationthatconvertsthe*renderedlayerfromrastertovector*/@org.junit.TestpublicvoidtestRenderingTransformationRasterVector()throwsException{StyletransformStyle=readSLD("RenderingTransformRasterVector.sld");GetLegendGraphicRequestreq=newGetLegendGraphicRequest();CoverageInfocInfo=getCatalog().getCoverageByName(MockData.TASMANIA_DEM.getNamespaceURI(),MockData.TASMANIA_DEM.getLocalPart());assertNotNull(cInfo);GridCoveragecoverage=cInfo.getGridCoverage(null,null);try{SimpleFeatureCollectionfeature;feature=FeatureUtilities.wrapGridCoverage((GridCoverage2D)coverage);req.setLayer(feature.getSchema());req.setStyle(transformStyle);req.setLegendOptions(newHashMap());this.legendProducer.buildLegendGraphic(req);BufferedImageimage=this.legendProducer.buildLegendGraphic(req);//ImageIO.write(image,"PNG",newFile("/tmp/rv.png"));assertNotBlank("testRenderingTransform",image,LegendUtils.DEFAULT_BG_COLOR);assertPixel(image,1,1,newColor(255,255,255));assertPixel(image,10,10,newColor(0,0,0));assertPixel(image,19,19,newColor(255,255,255));
if(coverageinstanceofGridCoverage2D){((GridCoverage2D)coverage).dispose(true);
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
ifthereisarenderingtransformationthatconvertsthe*renderedlayerfromrastertovector*/@org.junit.TestpublicvoidtestColorMapWithCql()throwsException{Stylestyle=readSLD("ColorMapWithCql.sld");assertNotNull(style.featureTypeStyles());assertEquals(1,style.featureTypeStyles().size());FeatureTypeStylefts=style.featureTypeStyles().get(0);assertNotNull(fts.rules());assertEquals(1,fts.rules().size());Rulerule=fts.rules().get(0);assertNotNull(rule.symbolizers());assertEquals(1,rule.symbolizers().size());assertTrue(rule.symbolizers().get(0)instanceofRasterSymbolizer);RasterSymbolizersymbolizer=(RasterSymbolizer)rule.symbolizers().get(0);assertNotNull(symbolizer.getColorMap());assertEquals(3,symbolizer.getColorMap().getColorMapEntries().length);ColorMapEntry[]entries=symbolizer.getColorMap().getColorMapEntries();Colorcolor=LegendUtils.color(entries[0]);intred=color.getRed();assertEquals(255,red);intgreen=color.getGreen();assertEquals(0,green);intblue=color.getBlue();assertEquals(0,blue);doublequantity=LegendUtils.getQuantity(entries[1]);assertEquals(20.0,quantity,0.0);doubleopacity=LegendUtils.getOpacity(entries[2]);assertEquals(0.5,opacity,0.0);GetLegendGraphicRequestreq=newGetLegendGraphicRequest();CoverageInfocInfo=getCatalog().getCoverageByName("world");assertNotNull(cInfo);GridCoveragecoverage=cInfo.getGridCoverage(null,null);try{SimpleFeatureCollectionfeature;feature=FeatureUtilities.wrapGridCoverage((GridCoverage2D)coverage);req.setLayer(feature.getSchema());req.setStyle(style);req.setLegendOptions(newHashMap());finalintHEIGHT_HINT=30;req.setHeight(HEIGHT_HINT);//usedefaultvaluesfortherestofparametersthis.legendProducer.buildLegendGraphic(req);BufferedImageimage=this.legendProducer.buildLegendGraphic(req);//wasthelegendpainted?assertNotBlank("testColorMapWithCql",image,LegendUtils.DEFAULT_BG_COLOR);//wasthelegendpainted?assertNotBlank("testColorMapWithCql",image,LegendUtils.DEFAULT_BG_COLOR);
if(coverageinstanceofGridCoverage2D){((GridCoverage2D)coverage).dispose(true);
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
ifthereisarenderingtransformationthatconvertsthe*renderedlayerfromvectortoraster*/@org.junit.TestpublicvoidtestRenderingTransformationVectorRaster()throwsException{StyletransformStyle=readSLD("RenderingTransformVectorRaster.sld");GetLegendGraphicRequestreq=newGetLegendGraphicRequest();FeatureTypeInfoftInfo=getCatalog().getFeatureTypeByName(MockData.NAMED_PLACES.getNamespaceURI(),MockData.NAMED_PLACES.getLocalPart());assertNotNull(ftInfo);req.setLayer(ftInfo.getFeatureType());req.setStyle(transformStyle);req.setLegendOptions(newHashMap());this.legendProducer.buildLegendGraphic(req);BufferedImageimage=this.legendProducer.buildLegendGraphic(req);//ImageIO.write(image,"PNG",newFile("/tmp/vr.png"));assertNotBlank("testRenderingTransform",image,LegendUtils.DEFAULT_BG_COLOR);assertPixel(image,10,70,newColor(188,188,255));assertPixel(image,10,80,newColor(68,68,255));assertPixel(image,10,130,newColor(255,152,0));
if(coverageinstanceofGridCoverage2D){((GridCoverage2D)coverage).dispose(true);
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
if(coverageinstanceofGridCoverage2D){((GridCoverage2D)coverage).dispose(true);
if(riinstanceofPlanarImage){ImageUtilities.disposePlanarImageChain((PlanarImage)ri);
if(listenerinstanceofINotificationCatalogListener){counter++;
if(listenerinstanceofINotificationTransactionListener){counter++;
if(!isComplex())returnParameterType.LITERAL;
if(FeatureCollection.class.isAssignableFrom(getParameter().type)){returnParameterType.VECTOR_LAYER;
else
if(GridCoverage2D.class.isAssignableFrom(getParameter().type)){returnParameterType.RASTER_LAYER;
else{returnParameterType.TEXT;
if(!isComplex()){returnCollections.singletonList(ParameterType.LITERAL);
else{Set<ParameterType>result=newLinkedHashSet<ParameterType>();result.add(ParameterType.TEXT);result.add(ParameterType.REFERENCE);result.add(ParameterType.SUBPROCESS);for(ProcessParameterIOppio:getProcessParameterIO()){
if(FeatureCollection.class.isAssignableFrom(ppio.getType())){result.add(ParameterType.VECTOR_LAYER);
else
if(GridCoverage.class.isAssignableFrom(ppio.getType())){result.add(ParameterType.RASTER_LAYER);
if(!isComplex()){returnnull;
else{return((ComplexPPIO)getProcessParameterIO().get(0)).getMimeType();
if(attribute!=null&&attribute.getValue()!=null){Stringvalue=attribute.getValue();Objecto=ctx.getBatchContext().get(value,dependency);
if(o==value){//check
ifitisatableinthebatchcontextfinalDbSourcedb=(DbSource)ctx.getParameterValues().get(PARAM_DB_NAME);finalDbTabletable=newDbTableImpl(db,value);Objectt=ctx.getBatchContext().get(table,dependency);
if(t!=table){o=t;
else{//TODO:shouldalreadyhappeninvalidationthrownewTaskException("Attributenotfoundforplaceholder:"+m.group(1));
ifinputcomesfirst,<code>false</code>otherwise*/publicbooleanisInputFirst();/**Returnsalistofthetoolsupportedformats*/publicSet<String>getSupportedFormats();/**Returnstrue
ifthespecifiedexecutablecommandisavailableandcanberun.*/publicbooleanisAvailable();/***Performstheconversion,returnsthe(main)outputfile**@paraminputDatatheinputfile*@paramoutputDirectorytheoutputdirectory*@paramtypeNamethetypename*@paramformattheformatdescriptor*@paramcrsthecoordinatereferencesystemoftheoutput*@returntheoutputfile*@throwsIOException*@throwsInterruptedException*/publicFileconvert(FileinputData,FileoutputDirectory,StringtypeName,Formatformat,CoordinateReferenceSystemcrs)throwsIOException,InterruptedException;}
if(ws==null){thrownewResourceNotFoundException("Nosuchworkspace:"+workspaceName);
if(dataStore.getWorkspace()!=null){//ensurethespecifriedworkspacematchestheonedictatedbytheuriWorkspaceInfows=dataStore.getWorkspace();
if(!workspaceName.equals(ws.getName())){thrownewRestException("Expectedworkspace"+workspaceName+"butclientspecified"+ws.getName(),HttpStatus.FORBIDDEN);
else{dataStore.setWorkspace(catalog.getWorkspaceByName(workspaceName));
ifnonamespaceparameterset,setit//TODO:weshouldreallymovethissortofthingtobesomethingcentral
if(!dataStore.getConnectionParameters().containsKey("namespace")){WorkspaceInfows=dataStore.getWorkspace();NamespaceInfons=catalog.getNamespaceByPrefix(ws.getName());
if(ns==null){ns=catalog.getDefaultNamespace();
if(ns!=null){dataStore.getConnectionParameters().put("namespace",ns.getURI());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"",e);
if(!original.getName().equalsIgnoreCase(info.getName())){thrownewRestException("cannotchangenameofadatastore",HttpStatus.FORBIDDEN);
if(!original.getWorkspace().getName().equalsIgnoreCase(info.getWorkspace().getName())){thrownewRestException("cannotchangenameofaworkspace",HttpStatus.FORBIDDEN);
if(!recurse){
if(!catalog.getStoresByWorkspace(workspaceName,DataStoreInfo.class).isEmpty()){for(DataStoreInfodataStoreInfo:catalog.getStoresByWorkspace(workspaceName,DataStoreInfo.class)){
if(dataStoreInfo.getName().equalsIgnoreCase(storeName)){break;
else{newCascadeDeleteVisitor(catalog).visit(ds);
if(original==null){thrownewResourceNotFoundException("Nosuchdatastore:"+workspaceName+","+storeName);
if(workspace==null||datastore==null){returnnull;
if(objinstanceofWorkspaceInfo){converter.encodeLink("/workspaces/"+converter.encode(ref),writer);
if(objectinstanceofDataStoreInfo){return"DataStoreInfo";
if(properties==null){try{properties=model.toMap();
if(!dsProps.isEmpty())properties.putIfAbsent("featureTypes",dsProps);
if(transform.exists()){deleteDirectory(transform);
ifitdoesn'texist.*/protected<T>Tlookup(ScriptEngineengine,Stringname,Class<T>type,booleanmandatory)throwsScriptException{Objectobj=engine.get(name);
if(obj==null){
if(mandatory){thrownewScriptException("Nosuchobject:"+name);
else{returnnull;
if(!type.isInstance(obj)){thrownewIllegalArgumentException("Object"+obj+"isnotoftype"+type.getName());
if(engineinstanceofInvocable){try{return((Invocable)engine).invokeFunction(name,args);
if(mandatory){thrownewScriptException(e);
else{thrownewScriptException("EnginedoesnotimplementInvocable,pluginmustimplement"+"customscripthook");
if(!queryDef.getTitle().isEmpty()){returnqueryDef.getTitle().get(0).getValue();
if(queries.getLength()==0){queries=doc.getElementsByTagName("Query");
if(queries.getLength()==0){thrownewWFSException("StoredQuerydoesnotspecifyanyQueryelements");
if(!returnTypes.contains(qName)&&!allowAnyReturnType&&!isParameter(qName.getLocalPart(),queryDef.getParameter())){thrownewWFSException(String.format("StoredQueryreferencestypeName%s:%s"+"notlistedinreturnFeatureTypes:%s",qName.getPrefix(),qName.getLocalPart(),toString(qe.getReturnFeatureTypes())));
if(returnTypes.contains(qName)){returnTypes.remove(qName);
if(!returnTypes.isEmpty()&&!allowAnyReturnType){thrownewWFSException(String.format("StoredQuerydeclaresreturnfeaturetype(s)not"+"notreferencedinquerydefinition:%s",toString(returnTypes)));
if(split.length!=2){returntypeName;
if(nodeName.startsWith("xmlns:")){xmlnsPrefix=nodeName.substring(6);
else
if(nodeName.equalsIgnoreCase("xmlns")){xmlnsPrefix="";
if(prefix.equalsIgnoreCase(xmlnsPrefix)){Stringuri=attribute.getNodeValue();NamespaceInfons=catalog.getNamespaceByURI(uri);prefix=ns.getName();
if(catalog!=null){p.getNamespaces().add(newCatalogNamespaceSupport(catalog));
if(!wcsTestFile.exists()){wcsTestFile=newFile("wcs1_1/schemas/wcs/1.1.1/wcsAll.xsd");
iftheurlisreadonlyandmaynotbewrittenbackto.*/publicbooleanisReadOnly(){returnreadOnly;
iftheurlisreadonlyandmaynotbewrittenbackto.*/publicvoidsetReadOnly(booleanreadOnly){this.readOnly=readOnly;}}
if(!legacy){//addthelistenerwhichwillpersistchangescatalog.addListener(newGeoServerConfigPersister(resourceLoader,xp));catalog.addListener(newGeoServerResourcePersister(catalog.getResourceLoader()));
if(listener==null){//addeventlistenerwhichpersistschangesfinalList<XStreamServiceLoader>loaders=GeoServerExtensions.extensions(XStreamServiceLoader.class);listener=newServicePersister(loaders,geoServer);
else{//avoidre-dumpingallserviceconfigfilesduringload,//we'llattachitbackoncedonegeoserver.removeListener(listener);
if(this.configPersister!=null){//avoidhavingthepersisterwritedownnewconfigfileswhilewereadtheconfig,//otherwiseit'lldumpitbackinxmlfilesgeoserver.removeListener(configPersister);
else{//lazycreationofthepersistersatthefirstneedthis.configPersister=newGeoServerConfigPersister(resourceLoader,xp);
if("serial".equalsIgnoreCase(System.getProperty("org.geoserver.importer.bdb.binding"))){bindingType=BindingType.SERIAL;LOGGER.info("Usingserialbinding");
if(re.getCause()instanceofjava.io.ObjectStreamException){LOGGER.warning("Unabletoreadimportdatabase,attemptingrecovery");//wipeoutthecatalogdbBinding.closeDb(env);dbBinding.destroyDb(env);//andtheimportdbdb.close();env.removeDatabase(null,"imports");//reopeninitDb(dbConfig,env);
ifnotanadvance,errorlongcurrent=importIdSeq.getStats(StatsConfig.DEFAULT).getCurrent();
if(id.longValue()<current){id=newLong(current);
if(get(current)!=null){thrownewIllegalStateException("proposedinexists!");
if(op==OperationStatus.NOTFOUND){returnnull;
if(store!=null&&store.getId()!=null){task.setStore(catalog.detach(store));
if(context.getId()==null){add(context);
else{put(context);
if(sortBy==null){returniterator();
ifthisbecomestooslowasecondarydatabasecouldbeusedforindexingreturnnewFilterIterator(iterator(),newPredicate(){publicbooleanevaluate(Objecto){return((ImportContext)o).getState()!=ImportContext.State.COMPLETE;
ifthisbecomestooslowasecondarydatabasecouldbeusedforindexingreturnnewFilterIterator(allNonCompleteImports(),newPredicate(){publicbooleanevaluate(Objecto){returnuser.equals(((ImportContext)o).getUser());
ifthefeaturecollectionneedstoberetyped
if(!store.getSchema().equals(fc.getSchema())){fc=newRetypingFeatureCollection(DataUtilities.simple(fc),store.getSchema());
ifthefeaturereaderneedstoberetyped
if(!store.getSchema().equals(reader.getFeatureType())){reader=newRetypingFeatureCollection.RetypingFeatureReader(reader,store.getSchema());
if(size==layers.size()){
if(!layerGroups.contains(info)){layerGroups.add(info);
else{changedLayerGroups.add(info);
if(linstanceofLayerInfo){
if(stores.contains(((LayerInfo)l).getResource().getStore())){size++;
else
if(linstanceofLayerGroupInfo){
if(countStores((LayerGroupInfo)l,stores)==((LayerGroupInfo)l).getLayers().size()){size++;
if(defaultServiceName!=null){returndefaultServiceName;
if(defaultSecurityService!=null){returndefaultSecurityService;
if(serviceName.equals(getDefaultServiceName())){finalGeoServerUserGroupServiceuserGroupService=securityManager.loadUserGroupService(serviceName);defaultSecurityService=userGroupService;returnuserGroupService;
if(roleServiceName.equals(getDefaultServiceName())){finalGeoServerRoleServiceroleService=securityManager.loadRoleService(roleServiceName);defaultSecurityService=roleService;returnroleService;
if(logger.isLoggable(Level.FINE)){logger.log(Level.FINE,"GettingRolesforUser["+username+"]");
if(logger.isLoggable(Level.FINE)){logger.log(Level.FINE,"CheckingUserGroupService["+serviceName+"]");
if(userGroupService.getUserByUsername(username)!=null){
if(logger.isLoggable(Level.FINE)){logger.log(Level.FINE,"UserGroupService["+serviceName+"]matchingforUser["+username+"]");
if(logger.isLoggable(Level.FINE)){logger.log(Level.FINE,"CheckingRoleService["+roleServiceName+"]");
if(roleService.getRolesForUser(username)!=null&&!roleService.getRolesForUser(username).isEmpty()){
if(logger.isLoggable(Level.FINE)){logger.log(Level.FINE,"RoleService["+roleServiceName+"]matchingforUser["+username+"]");
if(userRoles!=null&&!userRoles.isEmpty()){returntrue;
if(logger.isLoggable(Level.FINE)){logger.log(Level.FINE,"CheckingRole["+rolename+"]onActiveRoleService["+getDefaultSecurityService()+"]");
if(getDefaultSecurityService()instanceofGeoServerRoleService){
if(((GeoServerRoleService)getDefaultSecurityService()).getRoleByName(rolename)!=null){returntrue;
if(getDefaultSecurityService()instanceofGeoServerRoleService){roleSet=((GeoServerRoleService)getDefaultSecurityService()).getRolesForUser(username);
if(logger.isLoggable(Level.FINE)){logger.log(Level.FINE,"CheckingRole["+role+"]onActiveRoleService["+getDefaultSecurityService()+"]");
if(logger.isLoggable(Level.FINE)){logger.log(Level.FINE,"CheckingRole["+role+"]onActiveRoleService["+securityManager.getActiveRoleService()+"]");
if(logger.isLoggable(Level.FINE)){logger.log(Level.FINE,"CheckingUserGroupService["+serviceName+"]");
if(userGroupService.getUserByUsername(username)!=null){RoleCalculatorcalc=null;
if(getDefaultSecurityService()instanceofGeoServerRoleService){calc=newRoleCalculator(userGroupService,(GeoServerRoleService)getDefaultSecurityService());
if(logger.isLoggable(Level.FINE)){logger.log(Level.FINE,"UserGroupService["+serviceName+"]matchingforUser["+username+"]");
if(calc!=null){for(GeoServerUserGroupgroup:userGroupService.getGroupsForUser(user)){
if(group.isEnabled()){for(GeoServerRolerole:calc.calculateRoles(group)){stringSet.add(role.getAuthority());
if(calc!=null){for(GeoServerUserGroupgroup:userGroupService.getGroupsForUser(user)){
if(group.isEnabled()){for(GeoServerRolerole:calc.calculateRoles(group)){stringSet.add(role.getAuthority());
if(logger.isLoggable(Level.FINE)){logger.log(Level.FINE,"MatchingRoles["+stringSet+"]forUser["+username+"]");
if(StringUtils.hasLength(fileName)==false){error(newStringResourceModel("fileNameEmpty",this,null).getString());return;
if(dumpMasterPassword()){info(newStringResourceModel("dumpInfo",this).setParameters(newFile(fileName).getCanonicalFile()).getString());
elseerror(newStringResourceModel("unauthorized",this).getString());
if(item.getType()!=null){returnitem.getType().getSimpleName();
ifthefieldisPK*/protectedstaticfinalProperty<SolrAttribute>PK=newBeanProperty<SolrAttribute>("pk","pk");/**Store
ifthefieldisinuseindatastore*/protectedstaticfinalProperty<SolrAttribute>USE=newBeanProperty<SolrAttribute>("use","use");/**Store
ifthefieldhasnodataonSOLRdocument*/protectedstaticfinalProperty<SolrAttribute>EMPTY=newBeanProperty<SolrAttribute>("empty","empty");/***Buildattributeprovider**@paramattributeslisttouseassourceforprovider*/publicSolrAttributeProvider(List<SolrAttribute>attributes){this.attributes=attributes;
if(hideEmpty){BeanPropertyValueEqualsPredicatepredicate=newBeanPropertyValueEqualsPredicate("empty",Boolean.FALSE);//filtertheCollectionArrayList<SolrAttribute>att=newArrayList<SolrAttribute>(CollectionUtils.select(attributes,predicate));returnatt;
else{returnattributes;
iftruetheproviderreloadsbuthidesemptySOLRattributes*/protectedvoidreload(BooleanhideEmpty){this.hideEmpty=hideEmpty;}}
if(!file.exists()){thrownewException("Filedoesnotexist:"+file);
if(isDir&&!file.isDirectory()){thrownewException("Fileisnotadirectory:"+file);
if(!isDir&&!file.isFile()){thrownewException("Fileisnotvalid:"+file);
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer(newStringBuffer("Fileisvalid:").append(file).toString());
ifnotfound.*@see#getChildElement(Element,String,boolean)*/publicstaticElement[]getChildElements(Elementroot,Stringname){try{returngetChildElements(root,name,false);
ifthechildelementdoesnotexist.*@returnThechildelementfound,null
ifnotfound.*@throwsExceptionWhenachildelementisrequiredandnotfound.*/publicstaticElement[]getChildElements(Elementroot,Stringname,booleanmandatory)throwsException{ArrayListelements=newArrayList();Nodechild=root.getFirstChild();while(child!=null){
if(child.getNodeType()==Node.ELEMENT_NODE){
if(name.equals(child.getNodeName())){elements.add((Element)child);
if(mandatory&&(elements.isEmpty())){thrownewException(root.getNodeName()+"doesnotcontainsachildelementnamed"+name);
ifthechildelementdoesnotexist.*@returnThechildelementfound,null
ifnotfound.*@throwsExceptionWhenachildelementisrequiredandnotfound.*/publicstaticElementgetChildElement(Elementroot,Stringname,booleanmandatory)throwsException{Nodechild=root.getFirstChild();while(child!=null){
if(child.getNodeType()==Node.ELEMENT_NODE){
if(name.equals(child.getNodeName())){return(Element)child;
if(mandatory&&(child==null)){thrownewException(root.getNodeName()+"doesnotcontainsachildelementnamed"+name);
ifnotfound.*@see#getChildElement(Element,String,boolean)*/publicstaticElementgetChildElement(Elementroot,Stringname){try{returngetChildElement(root,name,false);
iftheattributeelementdoesnot*exist.*@paramdefaultValueadefaultvaluetoreturnincasetheattributewasnotfound.mutually*exclusivewiththeExceptionthrown.*@returnTheintvalue
iftheattributewasfound,thedefaultotherwise.*@throwsExceptionWhenaattributeelementisrequiredandnotfound.*/publicstaticintgetIntAttribute(Elementelem,StringattName,booleanmandatory,intdefaultValue)throwsException{StringattValue=getAttribute(elem,attName,mandatory);
if(!mandatory&&(attValue==null)){returndefaultValue;
if(mandatory){thrownewException(attName+"attributeofelement"+elem.getNodeName()+"mustbeaninteger,butit's'"+attValue+"'");
else{returndefaultValue;
iftheattributeelementdoesnot*exist.*@returnThevalue
iftheattributewasfound,thenullotherwise.*@throwsExceptionWhenachildattributeisrequiredandnotfound.*@throwsNullPointerExceptionDOCUMENTME!*/publicstaticStringgetAttribute(Elementelem,StringattName,booleanmandatory)throwsException{
if(elem==null){
if(mandatory){thrownewNullPointerException();
if(att!=null){value=att.getValue();
if(mandatory){
if(att==null){thrownewException("element"+elem.getNodeName()+"doesnotcontainsanattributenamed"+attName);
else
if("".equals(value)){thrownewException("attribute"+attName+"inelement"+elem.getNodeName()+"isempty");
iftheattributeelementdoesnot*exist.*@paramdefaultValuewhattoreturnforanon-mandatorythatisnotfound.*@returnThevalue
iftheattributewasfound,thefalseotherwise.*@throwsExceptionWhenachildattributeisrequiredandnotfound.*/publicstaticbooleangetBooleanAttribute(Elementelem,StringattName,booleanmandatory,booleandefaultValue)throwsException{Stringvalue=getAttribute(elem,attName,mandatory);
if((value==null)||(value=="")){returndefaultValue;
ifthechildwasfound,thenullotherwise.*/publicstaticStringgetChildText(Elementroot,StringchildName){try{returngetChildText(root,childName,false);
ifthetextdoesnotexist.*@returnThevalue
ifthechildwasfound,thenullotherwise.*@throwsExceptionWhenachildattributeisrequiredandnotfound.*/publicstaticStringgetChildText(Elementroot,StringchildName,booleanmandatory)throwsException{Elementelem=getChildElement(root,childName,mandatory);
if(elem!=null){returngetElementText(elem,mandatory);
else{
if(mandatory){Stringmsg="Mandatorychild"+childName+"notfoundin"+"element:"+root;thrownewException(msg);
ifitdoesnotexist.*/publicstaticStringgetChildAttribute(Elementroot,StringchildName,StringattName){try{returngetChildAttribute(root,childName,attName,false);
if(elem==null){
if(mandatory){thrownewException("Nosuchchild:"+childName);
if(mandatory&&!elem.hasAttribute(attName)){thrownewException("Nosuchattribute:"+attName);
ifthetextwasfound,thenullotherwise.*/publicstaticStringgetElementText(Elementelem){try{returngetElementText(elem,false);
ifthetextdoesnotexist.*@returnThevalue
ifthetextwasfound,thenullotherwise.*@throwsExceptionWhentextisrequiredandnotfound.*/publicstaticStringgetElementText(Elementelem,booleanmandatory)throwsException{Stringvalue=null;
if(LOGGER.isLoggable(Level.FINER)){LOGGER.finer(newStringBuffer("gettingelementtextfor").append(elem).toString());
if(elem!=null){Nodechild;NodeListchilds=elem.getChildNodes();intnChilds=childs.getLength();for(inti=0;i<nChilds;i++){child=childs.item(i);
if(child.getNodeType()==Node.TEXT_NODE){value=child.getNodeValue();
if(mandatory&&"".equals(value.trim())){thrownewException(elem.getNodeName()+"textisempty");
if(mandatory&&(value==null)){thrownewException(elem.getNodeName()+"elementdoesnotcontainstext");
else{thrownewException("Argumentelementcan'tbenull");
if(kword!=null){keywords.add(kword);
if(s==null){returnnewArrayList();
ifachildwasfound,thenullotherwise.*/publicstaticElementgetFirstChildElement(Elementroot){Nodechild=root.getFirstChild();while(child!=null){
if(child.getNodeType()==Node.ELEMENT_NODE){return(Element)child;
iftheattributeelementdoesnot*exist.*@returnThedoublevalue
iftheattributewasfound,theNaNotherwise.*@throwsExceptionWhenaattributeelementisrequiredandnotfound.*/publicstaticdoublegetDoubleAttribute(Elementelem,StringattName,booleanmandatory)throwsException{Stringvalue=getAttribute(elem,attName,mandatory);
if((value==null)||(value=="")){return0.0;
if(value!=null){try{d=Double.parseDouble(value);
if(meta==null)thrownewWFSException(gft,"Couldnotfindfeaturetype"+namespaceURI+":"+featureType.getTypeName()+"intheGeoServercatalog");NamespaceInfons=catalog.getNamespaceByURI(namespaceURI);ns2metas.put(ns,meta);
if(m.hasNext()){typeNames.append(",");
if(type.equals(ToggleType.MASTER))config.putConfiguration(ToggleConfiguration.TOGGLE_MASTER_KEY,switchToValue);
elseconfig.putConfiguration(ToggleConfiguration.TOGGLE_MASTER_KEY,switchToValue);//
if(switchTo){////LOGGER.info("The"+type+"toggleisnowENABLED");//
else{////LOGGER.warn("The"+type////+//////"toggleisnowDISABLEDnoeventwillbeposted/receivedto/fromthebroker");////fp.info("Notethatthe"+type////+"isstillregisteredtothetopicdestination");//
if(connect){
if(!container.isRunning()){//.info("Connecting...");
if(container.connect()){//.info("NowGeoServerisregisteredwiththedestination");config.putConfiguration(ConnectionConfiguration.CONNECTION_KEY,Boolean.TRUE.toString());
else{config.putConfiguration(ConnectionConfiguration.CONNECTION_KEY,Boolean.FALSE.toString());thrownewIOException("Connectionerror:Registrationabortedduetoaconnectionproblem");
else{
if(container.isRunning()){//LOGGER.info("Disconnecting...");
if(container.disconnect()){config.putConfiguration(ConnectionConfiguration.CONNECTION_KEY,Boolean.FALSE.toString());
else{config.putConfiguration(ConnectionConfiguration.CONNECTION_KEY,Boolean.TRUE.toString());thrownewIOException("Disconnectionerror");
ifnolayershasbeenrequested,oroneoftherequestedlayersdoes*notexistsonthisserverinstance,ortheversionparameterwasnotprovided.*@seeorg.geoserver.ows.KvpRequestReader#read(java.lang.Object,java.util.Map,java.util.Map)*/@SuppressWarnings({"rawtypes","unchecked"})@OverridepublicObjectread(Objectreq,Mapkvp,MaprawKvp)throwsException{DescribeLayerRequestrequest=(DescribeLayerRequest)super.read(req,kvp,rawKvp);request.setRawKvp(rawKvp);finalStringversion=request.getVersion();
if(null==version){Stringcode="NoVersionInfo";StringsimpleName=getClass().getSimpleName();thrownewServiceException("VersionparameternotprovidedforDescribeLayeroperation",code,simpleName);
if(!wms.getVersion().equals(version)){thrownewServiceException("Wrongvalueforversionparameter:"+version+".Thisserveraccetpsversion"+wms.getVersion(),"InvalidVersion",getClass().getSimpleName());
if(layers==null||layers.size()==0){thrownewServiceException("NoLAYERShasbeenrequested","NoLayerRequested",getClass().getName());
if(user==null)thrownewUsernameNotFoundException("Couldnotfinduser:"+username);returnuser;
ifithasbeen*modifiedsincelastaccess.**@throwsDataAccessResourceFailureException*/voidcheckUserMap()throwsDataAccessResourceFailureException{try{
if((userMap==null)||userDefinitionsFile==null||userDefinitionsFile.isStale()){
if(userDefinitionsFile==null){ResourcepropFile=findUserProperties();userDefinitionsFile=newPropertyFileWatcher(propFile);
if(propFile.getType()==Type.RESOURCE){//we'reprobablydealingwithanolddatadir,create//thefilewithout//changingtheusernameandpassword
ifpossiblePropertiesp=newProperties();GeoServerInfoglobal=GeoServerExtensions.bean(GeoServer.class).getGlobal();
if((global!=null)&&(global.getAdminUsername()!=null)&&!global.getAdminUsername().trim().equals("")){p.put(global.getAdminUsername(),global.getAdminPassword()+",ROLE_ADMINISTRATOR");
else{p.put("admin","geoserver,ROLE_ADMINISTRATOR");
else{thrownewFileNotFoundException("Unabletofindsecurity/users.properties");
if(is!=null){try{is.close();
if(os!=null){try{os.close();
if(userMap.containsKey(user.getUsername()))thrownewIllegalArgumentException("Theuser"+user.getUsername()+"alreadyexists");
elseuserMap.put(user.getUsername(),user);
if(userMap.containsKey(user.getUsername()))userMap.put(user.getUsername(),user);
elsethrownewIllegalArgumentException("Theuser"+user.getUsername()+"alreadyexists");
if(einstanceofIOException)throw(IOException)e;
elsethrow(IOException)newIOException("Couldnotwriteupdateduserslisttofilesystem").initCause(e);
if(os!=null)os.close();
iftheparsingsucceededturnthatintoauserobjectUserAttributeattr=(UserAttribute)configAttribEd.getValue();
if(attr!=null){Useruser=createUserObject(username,attr.getPassword(),attr.isEnabled(),attr.getAuthorities());users.put(username,user);
ifanyoftheoperatorsareusedinstringeg'the$quickbrown'Wehave*cateredtoscenariosformultiple$quotingonsingle/multiline.**@paraminputStreamsqlstatements*@returnlistofSQLstatements*/publicList<String>splitPostgisSQLScript(InputStreaminputStream)throwsException{StringBuildercontents=newStringBuilder();ArrayList<String>statements=newArrayList<String>();try{//usebuffering,readingonelineatatime//FileReaderalwaysassumesdefaultencodingisOK!BufferedReaderinput=newBufferedReader(newInputStreamReader(newDataInputStream(inputStream)));try{Stringline=null;PostgisIgnoreOperatorpio=newPostgisIgnoreOperator();while((line=input.readLine())!=null){StringtrimedLine=line.trim();
if(trimedLine.startsWith("--")||trimedLine.equals("")){continue;
if(countMatches(trimedLine,opr)%2==1){pio.setReverseStatus(opr);
if(trimedLine.endsWith(";")&&pio.isAllClosed()){statements.add(contents.toString());pio.reset();contents.setLength(0);
if(str.length()==0||sub.length()==0){return0;
ifwefound$$*andnocorresponding$$tocloseit,thestatusisopen*/publicbooleangetOperatorStatus(Stringkey){returnopen.get(key).booleanValue();
ifalloperatorsarecurrentlyclosed**@return-trueonly
ifthecurrentstatusofalloperatorsareclosed.Thisdetermines*theendofthestatementsinthesqlscript.*/publicbooleanisAllClosed(){for(booleanopn:open.values()){
if(opn){returnfalse;
if(trimedLine.startsWith("--")||trimedLine.equals("")){continue;
if(start){booleanmatch=false;for(OracleScriptRuleps:OracleScriptRule.values()){
if(trimedLine.startsWith(ps.getPrefix())){match=true;suffix=ps.getSuffix();start=trimedLine.endsWith(suffix)?true:false;contents.append(trimedLine+NEWLINE);
if(start){statements.add((contents.toString().trim()).substring(0,contents.toString().trim().length()-1));contents.setLength(0);suffix=null;
if(!match){thrownewException("Can'tmatch"+trimedLine);
else{
if(trimedLine.endsWith(suffix)){trimedLine=trimedLine.trim().substring(0,trimedLine.length()-1);contents.append(trimedLine);statements.add(contents.toString());contents.setLength(0);start=true;suffix=null;
else{contents.append(trimedLine+NEWLINE);
if(line.indexOf(searchString)!=-1){bf.close();returntrue;
if(GeoServerEnvironment.ALLOW_ENV_PARAMETRIZATION){System.setProperty("TEST_SYS_PROPERTY",oldRoleServiceName);config.setRoleServiceName("${TEST_SYS_PROPERTY}");secMgr.saveSecurityConfig(config);SecurityManagerConfigconfig1=secMgr.loadSecurityConfig();assertEquals(config1.getRoleServiceName(),oldRoleServiceName);
if(newline==null){//hitEOFsource=null;break;
if(cx.stringIsCompilableUnit(source)){break;
if(input==null){hitEOF=true;break;
if(!input.isEmpty()){Stringresult=eval(input);System.err.println(result);
if(link==null){link=newArrayList<LinkType>();
if(rtept==null){rtept=newArrayList<WptType>();
if(layer==null||layer.getType()!=PublishedType.RASTER)thrownewWcsException("Couldnotfindcoverage'"+value+"'",InvalidParameterValue,"identifier");returnsuper.parse(value);}}
ifneeded.Returntheupdated{@link*GridCoverageRequest}**@paramsubsettingRequest*@throwsIOException*/publicvoidsetDefaults(GridCoverageRequestsubsettingRequest)throwsIOException{//DealwithdefaultvaluesfinalStringformat=request.getFormat();
if(format!=null&&!GetCoverage.formatSupportMDOutput(format)){//TODO:RevisitthiscodeandchangethatFormatString.//Formatssupportingmultidimensionaloutputformatdon'tneedetosetupdefaultvalues//Therefore,noneedtosetdefaultvalues//For2Doutputformat,wecansetupdefaultvaluestoreducethenumberofresults
if(!(readerinstanceofStructuredGridCoverage2DReader)){//usestandardcodewhichgetsdefaultvaluefromeachdomainwhichhasn'tbe//subsetsetStandardReaderDefaults(subsettingRequest);
else{//UseoptimizedcodeforstructuredgridcoveragereaderwhichusesgranuleSource//queries//todeterminevaliddefaultvaluessetDefaultsFromStructuredReader(subsettingRequest);
if(dimensionDescriptor.getName().equalsIgnoreCase(ResourceInfo.TIME)){timeDimension=dimensionDescriptor;
else
if(dimensionDescriptor.getName().equalsIgnoreCase(ResourceInfo.ELEVATION)){elevationDimension=dimensionDescriptor;
else{customDimensions.add(dimensionDescriptor);dimensions++;
if(defaultTimeNeeded||defaultElevationNeeded||defaultCustomDimensionsNeeded){//GetgranulessourceGranuleSourcesource=structuredReader.getGranules(coverageName,true);//Setfilteringquerymatchingthespecifiedsubsets.FilterfinalFilter=setFilters(originalFilter,temporalSubset,elevationSubset,envelopeSubset,dimensionsSubset,structuredReader,timeDimension,elevationDimension,customDimensions);Queryquery=newQuery();//Setsortingorder(defaultPolicyisusingMax...thereforeDescendingorder)finalList<SortBy>requestedSort=subsettingRequest.getSortBy();
if(requestedSort==null){sortBy(query,timeDimension,elevationDimension);
else{query.setSortBy(requestedSort.toArray(newSortBy[requestedSort.size()]));
if(features.hasNext()){finalSimpleFeaturefeature=features.next();//Defaulttime
if(defaultTimeNeeded&&timeDimension!=null){temporalSubset=setDefaultTemporalSubset(timeDimension,feature);subsettingRequest.setTemporalSubset(temporalSubset);
if(defaultElevationNeeded&&elevationDimension!=null){elevationSubset=setDefaultElevationSubset(elevationDimension,feature);subsettingRequest.setElevationSubset(elevationSubset);
if(defaultCustomDimensionsNeeded&&!customDimensions.isEmpty()){dimensionsSubset=setDefaultDimensionsSubset(customDimensions,feature);subsettingRequest.setDimensionsSubset(dimensionsSubset);
if(features!=null){features.close();
if(end!=null){endTime=(Number)f.getAttribute(end);
if(end!=null){endTime=(Date)f.getAttribute(end);
if(timeDimension!=null){clauses.add(newSortByImpl(FeatureUtilities.DEFAULT_FILTER_FACTORY.property(timeDimension.getStartAttribute()),SortOrder.DESCENDING));
if(elevationDimension!=null){clauses.add(newSortByImpl(FeatureUtilities.DEFAULT_FILTER_FACTORY.property(elevationDimension.getStartAttribute()),SortOrder.ASCENDING));
if(originalFilter!=null){filters.add(originalFilter);
if(elevationFilter!=null){filters.add(elevationFilter);
if(timeFilter!=null){filters.add(timeFilter);
if(envelopeFilter!=null){filters.add(envelopeFilter);
if(additionalDimensionsFilter!=null){filters.add(additionalDimensionsFilter);
if(envelopeSubset!=null){Polygonpolygon=JTS.toGeometry(newReferencedEnvelope(envelopeSubset));GeometryDescriptorgeom=reader.getGranules(coverageName,true).getSchema().getGeometryDescriptor();PropertyNamegeometryProperty=FF.property(geom.getLocalName());GeometrynativeCRSPolygon;try{nativeCRSPolygon=JTS.transform(polygon,CRS.findMathTransform(DefaultGeographicCRS.WGS84,reader.getCoordinateReferenceSystem()));LiteralpolygonLiteral=FF.literal(nativeCRSPolygon);//TODO:Checkthatgeomoperation.ShouldIdointersectionorcontainmentcheck?envelopeFilter=FF.intersects(geometryProperty,polygonLiteral);//envelopeFilter=FF.within(geometryProperty,polygonLiteral);
if(additionalDimensions!=null&&dimensionSubset!=null&&additionalDimensions.size()!=dimensionSubset.size()&&dimensionSubset.size()>0){List<Filter>additionalDimensionFilterList=newArrayList<Filter>();Set<String>dimensionKeys=dimensionSubset.keySet();for(Stringdimension:dimensionKeys){//LookforthespecifieddimensionFilterdimensionFilter=createCustomDimensionFilter(dimension,dimensionSubset,additionalDimensions);
if(dimensionFilter!=null){additionalDimensionFilterList.add(dimensionFilter);
if(!additionalDimensionFilterList.isEmpty()){additionalDimensionsFilter=FF.and(additionalDimensionFilterList);
if(dimensionDescriptor.getName().equalsIgnoreCase(dimension)){Stringattribute=dimensionDescriptor.getStartAttribute();returnFF.equals(FF.property(attribute),FF.literal(dimensionValue));
ifmissing.**@paramtimeRange*@paramstart*@paramend*/privateFiltersetTimeFilter(DateRangetimeRange,Stringstart,Stringend){
if(timeRange!=null){
if(end==null){//singlevaluetimereturnbetweenFilter(start,timeRange.getMinValue(),timeRange.getMaxValue());
else{returnrangeFilter(start,end,timeRange.getMinValue(),timeRange.getMaxValue());
ifmissing.**@paramelevationSubset*@paramstart*@paramend*/privateFiltersetElevationFilter(NumberRangeelevationSubset,Stringstart,Stringend){
if(elevationSubset!=null){
if(end==null){//singlevalueelevationreturnbetweenFilter(start,elevationSubset.getMinValue(),elevationSubset.getMaxValue());
else{returnrangeFilter(start,end,elevationSubset.getMinValue(),elevationSubset.getMaxValue());
if(temporalSubset==null){//use"max"asthedefaultDatemaxTime=accessor.getMaxTime();
if(maxTime!=null){temporalSubset=newDateRange(maxTime,maxTime);
if(elevationSubset==null){//use"min"asthedefaultNumberminElevation=accessor.getMinElevation();
if(minElevation!=null){elevationSubset=newNumberRange(minElevation.getClass(),minElevation,minElevation);
if(customDomains!=null&&!customDomains.isEmpty()){availableCustomDimensions=customDomains.size();specifiedCustomDimensions=dimensionSubset!=null?dimensionSubset.size():0;
if(dimensionSubset==null){dimensionSubset=newHashMap<String,List<Object>>();
if(availableCustomDimensions!=specifiedCustomDimensions){setDefaultCustomDimensions(customDomains,dimensionSubset);
if(!dimensionSubset.containsKey(customDomain)){List<Object>dimensionValue=newArrayList<Object>();//setdefaultoftheproperdatatype(incaseofknownDomaindatatype)StringdefaultValue=accessor.getCustomDomainDefaultValue(customDomain);StringdataType=reader.getMetadataValue(customDomain+"_DOMAIN_DATATYPE");
if(dataType!=null){PARSER.setValues(defaultValue,dimensionValue,dataType);
else{dimensionValue.add(defaultValue);
ifnosucherrorexists.**<p>Thisisatransientpropertyofthestore.*/ThrowablegetError();/***Associatesanerrorwiththestore.**@see#getError()*/voidsetError(Throwablet);/***Createsanadapterforthestore.**<p>**@paramadapterClassTheclassoftheadapter.*@paramhintsHintstousewhencreatingtheadapter.*@returnTheadapter,anintsanceofadapterClass,or<code>null</code>.*/<TextendsObject>TgetAdapter(Class<T>adapterClass,Map<?,?>hints);/***@returnReturnsaresourcewiththespecifiednamethatisprovidedbythestore,or<code>*null</code>
ifnosuchresourceexists.*<p>Themonitorisusedtoreporttheprogressofloadingresouresandreportanywarnings*/errorsthatoccurindoingso.Monitormayalsobenull.*///<TextendsResource>TgetResource(Stringname,ProgressListenermonitor)//throwsIOException;/***@returnReturnstheresourcesprovidedbythisstore.*<p>Themonitorisusedtoreporttheprogressofloadingresouresandreportanywarnings*/errorsthatoccurindoingso.Monitormayalsobenull.*@uml.propertyname="resources"*@uml.associationEndmultiplicity="(0-1)"inverse="storeInfo:org.geoserver.catalog.Resource"*///<TextendsResource>Iterator<T>getResources(ProgressListenermonitor)throwsIOException;}
if(lookup!=null){
if(lookupinstanceofRestoreExecutionAdapter){returnwrapObject((RestoreExecutionAdapter)lookup,RestoreExecutionAdapter.class);
else{returnwrapList((List<RestoreExecutionAdapter>)lookup,RestoreExecutionAdapter.class);
if(lookup!=null){
if(lookupinstanceofRestoreExecutionAdapter){
if(restoreId.endsWith(".zip")){try{//getyourfileasInputStreamFilefile=((RestoreExecutionAdapter)lookup).getArchiveFile().file();InputStreamis=newFileInputStream(file);//copyittoresponse'sOutputStreamorg.apache.commons.io.IOUtils.copy(is,response.getOutputStream());response.flushBuffer();
else{returnwrapObject((RestoreExecutionAdapter)lookup,RestoreExecutionAdapter.class);
else{returnwrapList((List<RestoreExecutionAdapter>)lookup,RestoreExecutionAdapter.class);
if(lookup!=null){
if(lookupinstanceofRestoreExecutionAdapter){try{getBackupFacade().abandonExecution(Long.valueOf(executionId));
else{returnwrapList((List<RestoreExecutionAdapter>)lookup,RestoreExecutionAdapter.class);
if(restore.getId()!=null){Objectlookup=lookupBackupExecutionsContext(String.valueOf(restore.getId()),false,false);
if(lookup!=null){//Restoreinstancealreadyexists...tryingtorestartit.try{getBackupFacade().restartExecution(restore.getId());LOGGER.log(Level.INFO,"Restorerestarted:"+restore.getArchiveFile());returnwrapObject((RestoreExecutionAdapter)lookup,RestoreExecutionAdapter.class);
else{//Startanewexecutionasynchronously.Youwillneedtoqueryforthestatusinorder//tofollowtheprogress.execution=getBackupFacade().runRestoreAsync(restore.getArchiveFile(),restore.getFilter(),asParams(restore.getOptions()));LOGGER.log(Level.INFO,"Restorefile:"+restore.getArchiveFile());returnwrapObject((RestoreExecutionAdapter)execution,RestoreExecutionAdapter.class);
if(callBack!=null){//let'ssee
ifwecanaccessthisrequestcontexttry{HttpServletRequestrequest=((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest();callBack.invoked(request,user,resource);
iftherequestcontextwasproperlyobtained
if(callBack!=null){//let'ssee
ifwecanaccessthisrequestcontexttry{HttpServletRequestrequest=((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest();callBack.invoked(request,user,workspace);
iftherequestcontextwasproperlyobtained
ifset*/privateGrantedAuthoritydefaultRole;privatefinalSpringSecurityLdapTemplateldapTemplate;/***Controlsusedtodeterminewhethergroupsearchesshouldbeperformedoverthefullsub-tree*fromthebaseDN.ModifiedbysearchSubTreeproperty*/privatefinalSearchControlssearchControls=newSearchControls();/**TheIDoftheattributewhichcontainstherolenameforagroup*/privateStringgroupRoleAttribute="cn";/**ThebaseDNfromwhichthesearchforgroupmembershipshouldbeperformed*/privateStringgroupSearchBase;/**Thepatterntobeusedfortheusersearch.{0}istheuser'sDN*/privateStringgroupSearchFilter="(member={0})";privateStringrolePrefix="ROLE_";privatebooleanconvertToUpperCase=true;//~Constructors//===================================================================================================/***Constructorforgroupsearchscenarios.<tt>userRoleAttributes</tt>maystillbesetasa*property.**@paramcontextSourcesuppliesthecontextsusedtosearchforuserroles.*@paramgroupSearchBase
ifthisisanemptystringthesearchwillbeperformedfromtheroot*DNofthecontextfactory.Ifnull,nosearchwillbeperformed.*/publicBindingLdapAuthoritiesPopulator(ContextSourcecontextSource,StringgroupSearchBase){Assert.notNull(contextSource,"contextSourcemustnotbenull");//useabindingLdapTemplate,thatdoesn'tmakesearcheswithout//authenticationldapTemplate=newBindingLdapTemplate(contextSource);ldapTemplate.setSearchControls(searchControls);this.groupSearchBase=groupSearchBase;
if(groupSearchBase==null){logger.info("groupSearchBaseisnull.Nogroupsearchwillbeperformed.");
else
if(groupSearchBase.length()==0){logger.info("groupSearchBaseisempty.Searcheswillbeperformedfromthecontextsourcebase");
ifrequiredtoobtainanyadditionalrolesforthegiven*user(ontopofthoseobtainedfromthestandardsearchimplementedbythisclass).**@paramuserthecontextrepresentingtheuserwho'srolesarerequired*@returntheextraroleswhichwillbemergedwiththosereturnedbythegroupsearch*/protectedSet<GrantedAuthority>getAdditionalRoles(DirContextctx,DirContextOperationsuser,Stringusername){returnnull;
if(logger.isDebugEnabled()){logger.debug("Gettingauthoritiesforuser"+userDn);
if(password!=null){//authenticateandexecuteroleextractionintheauthenticated//contextldapTemplate.authenticate(DistinguishedName.EMPTY_PATH,userDn,password,newAuthenticatedLdapEntryContextCallback(){@OverridepublicvoidexecuteWithContext(DirContextctx,LdapEntryIdentificationldapEntryIdentification){getAllRoles(user,userDn,result,username,ctx);
else{getAllRoles(user,userDn,result,username,null);
if(getGroupSearchBase()==null){returnnewHashSet<GrantedAuthority>();
if(logger.isDebugEnabled()){logger.debug("Searchingforrolesforuser'"+username+"',DN="+"'"+userDn+"',withfilter"+groupSearchFilter+"insearchbase'"+getGroupSearchBase()+"'");
if(logger.isDebugEnabled()){logger.debug("Rolesfromsearch:"+userRoles);
if(convertToUpperCase){role=role.toUpperCase();
if(extraRoles!=null){roles.addAll(extraRoles);
if(defaultRole!=null){roles.add(defaultRole);
ifthepasswordisneededinamodifiedform(plaintextasanexample)**@authormcr*/publicclassUserDetailsPasswordWrapperextendsUserDetailsWrapper{privatestaticfinallongserialVersionUID=1L;publicUserDetailsPasswordWrapper(UserDetailsdetails,Stringpassword){super(details);this.password=password;
if(infoinstanceofLayerInfo){createTileLayerLabelModel=newResourceModel("createTileLayerForLayer");ResourceInforesource=((LayerInfo)info).getResource();//weneedthe_current_name,regardlessofit'snameisbeingchangedresource=ModificationProxy.unwrap(resource);originalLayerName=resource.getPrefixedName();
else
if(infoinstanceofLayerGroupInfo){createTileLayerLabelModel=newResourceModel("createTileLayerForLayerGroup");//weneedthe_current_name,regardlessof
ifit'snameisbeingchangedLayerGroupInfolgi=ModificationProxy.unwrap((LayerGroupInfo)info);originalLayerName=tileLayerName(lgi);
else{thrownewIllegalArgumentException("ProvidedmodeldoesnottargetaLayerInfonoraLayerGroupInfo:"+info);
if(originalLayerName!=null){try{tileLayer=mediator.getTileLayerByName(originalLayerName);
iftheEnabledparameterhasbeendefinedGeoServerTileLayerInfoModelmodel=((GeoServerTileLayerInfoModel)tileLayerModel);booleanundefined=model.getEnabled()==null;booleandoCreateTileLayer;
if(tileLayerInfo.getId()!=null){doCreateTileLayer=true;
else
if(isNew()&&mediator.getConfig().isCacheLayersByDefault()){doCreateTileLayer=true;
else{doCreateTileLayer=false;
ifnot//alreadyset
if(undefined){model.setEnabled(doCreateTileLayer);
if(object.equals(defaultStore)){value+="(*)";
if(createVal&&enabledVal&&!isBlobStoreEnabled(blobStoreIdVal)){error(newParamResourceModel("enabledError",GeoServerTileLayerEditor.this).getString());
if(store!=null&&store.getCache()!=null){enableInMemoryCaching.setEnabled(mediator.getConfig().isInnerCachingEnabled()&&!store.getCache().isImmutable());
if(!createTileLayer&&cachedLayerExistedInitially){confirmRemovalOfExistingTileLayer(target);
else{updateConfigsVisibility(target);
if(blobStoreId==null){returntrue;
if(blobStore.getId().equals(blobStoreId)){returnblobStore.isEnabled();
if(!createLayer){
if(tileLayerExists){StringtileLayerName=tileLayerInfo.getName();gwc.removeTileLayers(Arrays.asList(tileLayerName));
ifwe'recreatinganewlayer,atthispointthelayerhasalreadybeencreatedandhence//hasanidPreconditions.checkState(layer.getId()!=null);tileLayerInfo.setId(layer.getId());finalStringname;finalGridSetBrokergridsets=gwc.getGridSetBroker();GeoServerTileLayertileLayer;
if(layerinstanceofLayerGroupInfo){LayerGroupInfogroupInfo=(LayerGroupInfo)layer;name=tileLayerName(groupInfo);tileLayer=newGeoServerTileLayer(groupInfo,gridsets,tileLayerInfo);
else{LayerInfolayerInfo=(LayerInfo)layer;name=tileLayerName(layerInfo);tileLayer=newGeoServerTileLayer(layerInfo,gridsets,tileLayerInfo);
ifitispresentConfigurableBlobStorestore=GeoServerExtensions.bean(ConfigurableBlobStore.class);
if(store!=null){CacheProvidercache=store.getCache();
if(cache!=null){
if(enableInMemoryCaching.getModelObject()){cache.removeUncachedLayer(name);
else{cache.addUncachedLayer(name);
if(tileLayerExists){gwc.save(tileLayer);
else{gwc.add(tileLayer);
ifthereissomethingtocancel,let'swarntheuseraboutwhat//couldgowrong,and
iftheuseraccepts,let'sdeletewhat'sneededconfirmRemovalDialog.showOkCancel(origTarget,newGeoServerDialog.DialogDelegate(){privatestaticfinallongserialVersionUID=1L;@OverrideprotectedComponentgetContents(finalStringid){//showaconfirmationpanelforalltheobjectswehavetoremoveGWCgwc=GWC.get();QuotausedQuota=gwc.getUsedQuota(originalLayerName);
if(usedQuota==null){usedQuota=newQuota();
if(createTileLayer){enabled.processInput();expireCache.processInput();expireClients.processInput();metaTilingX.processInput();metaTilingY.processInput();gutter.processInput();cacheFormats.processInput();parameterFilters.processInput();gridSubsets.processInput();////RemoveaddtheLayertothecache
ifitispresent//ConfigurableBlobStorestore=//GeoServerExtensions.bean(ConfigurableBlobStore.class);//if(store!=null){//CacheProvidercache=store.getCache();//
if(cache!=null){//
if(enableInMemoryCaching.getModelObject()){//cache.removeUncachedLayer(getModel().getObject().getName());//
else{//cache.addUncachedLayer(getModel().getObject().getName());//
else{tileLayerInfo.setId(null);setConvertedInput(tileLayerInfo);
if(GeoServerApplication.get().getCatalog().getWorkspaceByName(value)!=null){iv.error(newValidationError("NewWorkspacePanel.duplicateWorkspace").setVariable("workspace",value));
if(ugConfig==null){ugConfig=createConfigObject(serviceName);ugConfig.setName(serviceName);
if(fail)Assert.fail(failMessage);//releaselockstore1.load();//getlockstore2.addUser(user);fail=true;try{store1.clear();
if(fail)Assert.fail(failMessage);//releaselockstore2.store();store1.clear();store1.store();////endofpartone,nowcheckallmodifyingmethods//obtainalockstore1.addUser(user);fail=true;try{store2.associateUserToGroup(user,group);
if(fail)Assert.fail(failMessage);fail=true;try{store2.updateUser(user);
if(fail)Assert.fail(failMessage);fail=true;try{store2.updateGroup(group);
if(fail)Assert.fail(failMessage);fail=true;try{store2.clear();
if(fail)Assert.fail(failMessage);
ifselectionisactive)WebMarkupContainercnt=newWebMarkupContainer("selectItemContainer");cnt.add(selectOneCheckbox(item));cnt.setVisible(selectable);item.add(cnt);buildRowListView(dataProvider,item,itemModel);
ifthepropertyissortable,alabelotherwiseIModel<String>titleModel=getPropertyTitle(property);
if(sortable&&property.getComparator()!=null){Fragmentf=newFragment("header","sortableHeader",GeoServerTablePanel.this);AjaxLink<Property<T>>link=sortLink(dataProvider,item);link.add(newLabel("label",titleModel));f.add(link);item.add(f);
else{item.add(newLabel("header",titleModel));
if(component==null){//showaplainlabel
ifthethesubclassdidnotcreateanycomponentcomponent=newLabel("component",property.getModel(itemModel));
else
if(!"component".equals(component.getId())){//addsomechecksfortheid,theerrormessage//thatwicketreturnsincaseofmismatchisnot//thathelpfulthrownewIllegalArgumentException("getComponentForPropertyasked"+"tobuildacomponent"+"withid='component'"+"forproperty'"+property.getName()+"',butgot'"+component.getId()+"'instead");
if*you'rebuildinganeditabletable,{@linkDefaultItemReuseStrategy}otherwise*/publicvoidsetItemReuseStrategy(IItemReuseStrategystrategy){dataView.setItemReuseStrategy(strategy);
if(itemSelected){selected++;
if(selection[i]){result.add((T)item.getDefaultModelObject());
if(Boolean.FALSE.equals(getComponent().getDefaultModelObject())){selectAllValue=false;target.add(selectAll);
if(object.equals(item.getModelObject())){selection[i]=true;return;
if(selection.length<=i){
if(dataProvider.size()<=i){thrownewArrayIndexOutOfBoundsException(i);
else{//expandselectionarray,thedataproviderlikelyresizedandthetwogot//misalignedboolean[]newSelection=newboolean[(int)dataProvider.size()];System.arraycopy(selection,0,newSelection,0,selection.length);this.selection=newSelection;
if(currSort==null||!property.getName().equals(currSort.getProperty())){dataProvider.setSort(newSortParam<Object>(property.getName(),true));
else{dataProvider.setSort(newSortParam<Object>(property.getName(),!currSort.isAscending()));
if("".equals(flatKeywords)){dataProvider.setKeywords(null);filter.setModelObject("");dataView.setCurrentPage(0);
else{String[]keywords=flatKeywords.split("\\s+");dataProvider.setKeywords(keywords);dataView.setCurrentPage(0);
if(dataProvider.getKeywords()==null){returnshowingAllRecords(first,last,fullSize);
else{returnmatchedXOutOfY(first,last,size,fullSize);
if(dataProvider.getKeywords()!=null){size=dataView.getDataProvider().size();
if(size>0)returndataView.getItemsPerPage()*dataView.getCurrentPage()+1;
elsereturn0;
if(page<(count-1))returndataView.getItemsPerPage()*(page+1);
else{returndataProvider.getKeywords()!=null?dataView.getDataProvider().size():size;
if(page*count<total){count++;
if(!pageable){navigatorTop.setVisible(false);navigatorBottom.setVisible(false);dataView.setItemsPerPage(Integer.MAX_VALUE);selection=newboolean[getDataProvider().getItems().size()];
else{navigatorTop.setVisible(true);navigatorBottom.setVisible(true);dataView.setItemsPerPage(DEFAULT_ITEMS_PER_PAGE);selection=newboolean[DEFAULT_ITEMS_PER_PAGE];
ifthismethodiscalledbefore{@linkplain*#produceLegendGraphic(GetLegendGraphicRequest)}.*/StringgetContentType();}
if(isBlackListed(httpRequest)){
if(responseinstanceofHttpServletResponse){HttpServletResponsehttpResponse=(HttpServletResponse)response;httpResponse.sendError(HttpServletResponse.SC_FORBIDDEN,"ThisIPhasbeenblocked.Pleasecontacttheserveradministrator");return;
if(configFile!=null&&configFile.isStale()){synchronized(configFile){
if(configFile.isStale()){this.blackListedAddresses=reloadConfiguration(BLPROPERTY);this.whiteListedAddresses=reloadConfiguration(WLPROPERTY);
if(blackListedAddresses.isEmpty()){returnfalse;
if(incomingIp.matches(blackListRole)){blocked=true;break;
if(blocked&&!whiteListedAddresses.isEmpty()){for(StringwhiteListRole:whiteListedAddresses){
if(incomingIp.matches(whiteListRole)){blocked=false;break;
if(props==null){//filedoesn'texistreturnCollections.emptySet();
if(null==rawList){returnCollections.emptySet();
if(log.isDebugEnabled()){log.debug("AddedAntpath:"+antPath+";attributes:"+attrs+",httpMethods:"+Arrays.toString(httpMethods));
if((object==null)||!this.supports(object.getClass())){thrownewIllegalArgumentException("ObjectmustbeaFilterInvocation");
if(firstQuestionMarkIndex!=-1){url=url.substring(0,firstQuestionMarkIndex);
if(isConvertUrlToLowercaseBeforeComparison()){url=url.toLowerCase();
if(log.isDebugEnabled()){log.debug("ConvertedURLtolowercase,from:'"+url+"';to:'"+url+"'andhttpMethod="+httpMethod);
if(log.isDebugEnabled()){log.debug("~~~~~~~~~~antPath="+antPath+"methodList="+Arrays.toString(methodList));
if(methodList!=null){matchedMethods=false;for(intii=0;ii<methodList.length;ii++){
if(methodList[ii].equals(httpMethod)){matchedMethods=true;break;
if(log.isDebugEnabled())log.debug("Candidateis:'"+url+"';antPathis"+antPath+";matchedPath="+matchedPath+";matchedMethods="+matchedMethods);
if(matchedPath&&matchedMethods){log.debug("returning"+StringUtils.collectionToCommaDelimitedString(entryHolder.getConfigAttributes()));returnentryHolder.getConfigAttributes();
if(type.getLabel().equalsIgnoreCase(label)||type.name().equalsIgnoreCase(label)){returntype;
if(!isAnonymous){cfg=INITIAL_CONFIG_PATH;brokerOptions.setConfigProperty("qpid.pass_file",PWD_PATH);
ifwechangethesrswhenthere'snoreprojectpolicy,shouldstillbethesamebounding//boxfti.setSRS("EPSG:4326");fti.setProjectionPolicy(ProjectionPolicy.NONE);crsBounds=cb.getBoundsFromCRS(fti);assertEquals(newReferencedEnvelope(CRS.getEnvelope(exptectedCRS)),crsBounds);//
ifweusereprojectpolicy,boundsshouldnowbedifferentfti.setProjectionPolicy(ProjectionPolicy.FORCE_DECLARED);crsBounds=cb.getBoundsFromCRS(fti);assertNotEquals(newReferencedEnvelope(CRS.getEnvelope(exptectedCRS)),crsBounds);//shouldnowbe4326boundsCoordinateReferenceSystemcrs4326=CRS.decode("EPSG:4326");assertEquals(newReferencedEnvelope(CRS.getEnvelope(crs4326)),crsBounds);fti.setProjectionPolicy(ProjectionPolicy.REPROJECT_TO_DECLARED);assertEquals(newReferencedEnvelope(CRS.getEnvelope(crs4326)),crsBounds);
if(!RemoteOWSTestSupport.isRemoteWMSStatesAvailable(LOGGER)){LOGGER.warning("RemoteOWStestsdisabled,skippingcatalogbuilderwmstests");return;
if(rawKvp.containsKey("acceptVersions")){AcceptVersionsKvpParseravp=newAcceptVersionsKvpParser();AcceptVersionsTypeavt=(AcceptVersionsType)avp.parse((String)rawKvp.get("acceptVersions"));kvp.put("acceptVersions",avt);
if(rawKvp.containsKey("sections")){SectionsKvpParserparser=newSectionsKvpParser();Stringvalue=(String)rawKvp.get("sections");EObjectsections=(EObject)parser.parse(value);kvp.put("sections",sections);
ifnullwillissueawarning.*/staticvoidcheckContext(ApplicationContextcontext){
if(context==null){LOGGER.severe("Extensionlookupoccured,butApplicationContextisunset.");
ifnotfound*/publicstaticStringgetProperty(StringpropertyName){returngetProperty(propertyName,context);
ifthecontextisa{@linkWebApplicationContext}*<li>Environmentvariable*</ul>**andreturnsthefirstnonnull,nonemptyvaluefound.**@parampropertyNameThepropertynametobesearched*@paramcontextTheSpringcontext(maybenull)*@returnThepropertyvalue,ornull
ifnotfound*/publicstaticStringgetProperty(StringpropertyName,ApplicationContextcontext){
if(contextinstanceofWebApplicationContext){returngetProperty(propertyName,((WebApplicationContext)context).getServletContext());
else{returngetProperty(propertyName,(ServletContext)null);
ifnotfound*/publicstaticStringgetProperty(StringpropertyName,ServletContextcontext){//TODO:thiscodecomesfromthedatadirectorylookupandit'suseful//untilweprovideawayfortheusertomanuallyinspectthethreecontexts//(whentryingtodebugwhythevariabletheythingthey'veset,andsoon,seealso//https://osgeo-org.atlassian.net/browse/GEOS-2343//Oncethatisfixed,wecanremovetheloggingcodethatmakesthismethodmorecomplex//thanstrictlynecessaryfinalString[]typeStrs={"Javaenvironmentvariable","Servletcontextparameter","Systemenvironmentvariable"};Stringresult=null;for(intj=0;j<typeStrs.length;j++){//Lookupsection
switch(j){case0:result=System.getProperty(propertyName);break;case1:
if(context!=null){result=context.getInitParameter(propertyName);
if(result==null||result.equalsIgnoreCase("")){LOGGER.finer("Found"+typeStrs[j]+":'"+propertyName+"'tobeunset");
else{break;
if(authenticationinstanceofKeyAuthenticationToken){KeyAuthenticationTokenkat=(KeyAuthenticationToken)authentication;Stringkey=(String)kat.getCredentials();kvp.put(kat.getAuthKeyParamName(),key);
if(roles==null)this.roles=newHashSet<String>();
elsethis.roles=newHashSet<String>(roles);
if(roles.isEmpty()){returnServiceAccessRule.ANY;
else{StringBuffersb=newStringBuffer();for(Stringrole:roles){sb.append(role);sb.append(",");
if(compareService!=0)returncompareService;returncompareServiceItems(method,other.method);
if(!(objinstanceofServiceAccessRule))returnfalse;return0==compareTo((ServiceAccessRule)obj);
if(item.equals(otherItem))return0;
else
if(ANY.equals(item))return-1;
else
if(ANY.equals(otherItem))return1;
elsereturnitem.compareTo(otherItem);
if(f.exists())f.delete();ctx=newClassPathXmlApplicationContext("GeoServerPropertyConfigurerTest-applicationContext.xml",getClass());ctx.refresh();
if(model.getObject()==null){typeModel.setObject(Type.NEVER);
else{typeModel.setObject(Type.CUSTOM);Matchermatcher=FrequencyUtil.DAILY_PATTERN.matcher(model.getObject());
if(matcher.matches()){intminutes=Integer.parseInt(matcher.group(1));inthour=Integer.parseInt(matcher.group(2));
if(minutes<=60&&hour<24){typeModel.setObject(Type.DAILY);timeModel.setObject(String.format("%02d",hour)+":"+String.format("%02d",minutes));
else{matcher=FrequencyUtil.WEEKLY_PATTERN.matcher(model.getObject());
if(matcher.matches()){intminutes=Integer.parseInt(matcher.group(1));inthour=Integer.parseInt(matcher.group(2));DayOfWeekday=FrequencyUtil.findDayOfWeek(matcher.group(3));
if(minutes<=60&&hour<24&&day!=null){typeModel.setObject(Type.WEEKLY);timeModel.setObject(String.format("%02d",hour)+":"+String.format("%02d",minutes));dayOfWeekModel.setObject(day);
else{matcher=FrequencyUtil.MONTHLY_PATTERN.matcher(model.getObject());
if(matcher.matches()){intminutes=Integer.parseInt(matcher.group(1));inthour=Integer.parseInt(matcher.group(2));intday=Integer.parseInt(matcher.group(3));
if(minutes<=60&&hour<24&&day>0&&day<=28){typeModel.setObject(Type.MONTHLY);timeModel.setObject(String.format("%02d",hour)+":"+String.format("%02d",minutes));dayOfMonthModel.setObject(day);
if(findParent(Form.class).findSubmittingButton()!=null){Matchermatcher=TIME_PATTERN.matcher(validatable.getValue());
if(!(matcher.matches()&&Integer.parseInt(matcher.group(1))<24&&Integer.parseInt(matcher.group(2))<60)){error(newParamResourceModel("timeFormatError",FrequencyPanel.this).getString());
if(findParent(Form.class).findSubmittingButton()!=null){try{CronExpression.validateExpression(validatable.getValue());
if(findParent(Form.class).findSubmittingButton()!=null&&typeModel.getObject()!=Type.CUSTOM&&timeModel.getObject()!=null){
if(typeModel.getObject()==Type.NEVER){((IModel<String>)getDefaultModel()).setObject(null);
else{Matchermatcher=TIME_PATTERN.matcher(timeModel.getObject());
if(matcher.matches()){Stringhour=matcher.group(1);Stringminute=matcher.group(2);
if(typeModel.getObject()==Type.DAILY){((IModel<String>)getDefaultModel()).setObject("0"+minute+""+hour+"**?");
else
if(typeModel.getObject()==Type.WEEKLY){((IModel<String>)getDefaultModel()).setObject("0"+minute+""+hour+"?*"+dayOfWeekModel.getObject().getDisplayName(TextStyle.SHORT,Locale.ENGLISH));
else
if(typeModel.getObject()==Type.MONTHLY){((IModel<String>)getDefaultModel()).setObject("0"+minute+""+hour+""+dayOfMonthModel.getObject()+"*?");
else{thrownewIllegalStateException(newParamResourceModel("timeFormatError",this).getString());
iftheexceptionisnotforaparticularservice.*/publicOWS10ServiceExceptionHandler(){super(Collections.EMPTY_LIST);
iftheexceptionisforaparticularservice.**@paramservicesListofservicesthishandlerhandlesexceptionsfor.*/publicOWS10ServiceExceptionHandler(Listservices){super(services);
if(exception.getCode()!=null){e.setExceptionCode(exception.getCode());
else{//setadefaulte.setExceptionCode("NoApplicableCode");
if(verboseExceptions){//addtheentirestacktrace//exception.e.getExceptionText().add("Details:");ByteArrayOutputStreamtrace=newByteArrayOutputStream();exception.printStackTrace(newPrintStream(trace));e.getExceptionText().add(newString(trace.toByteArray()));
if(!request.isSOAP()){//therewillalreadybeaSOAPmimetyperequest.getHttpResponse().setContentType("application/xml");
if(bytes<unit)returnbytes+"B";intexp=(int)(Math.log(bytes)/Math.log(unit));Stringpre=(si?"kMGTPE":"KMGTPE").charAt(exp-1)+(si?"":"i");returnString.format("%.1f%sB",bytes/Math.pow(unit,exp),pre);}}
if(writeFilter.evaluate(current)){delegate.remove();
else{throwunsupportedOperation();
if(policy.response==Response.CHALLENGE){returnSecureCatalogImpl.unauthorizedAccess();
elsereturnnewUnsupportedOperationException("Thisiteratorisreadonly");
if(delegateinstanceofFeatureIterator){((FeatureIterator)delegate).close();
if(reader.hasNext()){try{returnnewRecordImpl(reader.readEntry());
if(root.exists())FileUtils.deleteDirectory(root);root.mkdirs();one=newFile(root,"one.txt");one.createNewFile();two=newFile(root,"two.sld");two.createNewFile();fileProvider=newFileProvider(root);tester.startPage(newFormTestPage(newComponentBuilder(){publicComponentbuildComponent(Stringid){returnnewFileDataView(id,fileProvider){@OverrideprotectedvoidlinkNameClicked(Filefile,AjaxRequestTargettarget){lastClicked=file;
if(run.getMessage()!=null){reportContent.append("\tmessage:"+run.getMessage()+"(checklogsformoredetails)\n");
switch(batchRun.getRuns().get(batchRun.getRuns().size()-1).getStatus()){caseFAILED:caseNOT_COMMITTED:case/*shouldn'thappen*/READY_TO_COMMIT:case/*shouldn'thappen*/RUNNING:case/*shouldn'thappen*/COMMITTING:case/*shouldn'thappen*/ROLLING_BACK:reportTitle.append("hasfailed");type=Type.FAILED;break;caseROLLED_BACK:caseNOT_ROLLED_BACK:reportTitle.append("wascancelled");type=Type.CANCELLED;break;default:reportTitle.append("wassuccessful");type=Type.SUCCESS;
if(CONNECTION_JNDI.equals(connectionType)){factory=newSQLServerJNDIDataStoreFactory();fillInJndiParams(params,jndiParamPanel);
else{factory=newSQLServerDataStoreFactory();//basicparamsparams.put(HOST.key,basicParamPanel.host);params.put(PORT.key,basicParamPanel.port);params.put(USER.key,basicParamPanel.username);params.put(PASSWD.key,basicParamPanel.password);params.put(DATABASE.key,basicParamPanel.database);
if(!CONNECTION_JNDI.equals(connectionType)){//connectionpoolparamscommontoOCIanddefaultconnectionsfillInConnPoolParams(params,basicParamPanel);
else{params.put(JDBCDataStoreFactory.SCHEMA.key,otherParamsPanel.schema);
if(basicParamPanel.schema!=null){params.put(JDBCDataStoreFactory.SCHEMA.key,basicParamPanel.schema);
if(resourceInfo.getCatalog()==null)newCatalogBuilder(GeoServerApplication.get().getCatalog()).attach(resourceInfo);returnresourceInfo;
iftheuserselectedanythingfinalList<ExecutionStatus>selection=table.getSelection();
if(selection.size()==0)return;dialog.setTitle(newParamResourceModel("confirmDismissal",this));//
ifthereissomethingtocancel,let'swarntheuseraboutwhat//couldgowrong,and
iftheuseraccepts,let'sdeletewhat'sneededdialog.showOkCancel(target,newGeoServerDialog.DialogDelegate(){protectedComponentgetContents(Stringid){//showaconfirmationpanelforalltheobjectswehavetoremovereturnnewLabel(id,newParamResourceModel("confirmDismissProcesses",ProcessStatusPage.this));
iftheselectionhasbeenclearedoutit'ssignadeletion//occurred,sorefreshthetable
if(table.getSelection().size()==0){setEnabled(false);
ifwewentbeyondthemaximumtimeallowedwhile(!(listenerinstanceofMaxExecutionTimeListener)&&(listenerinstanceofDelegateProgressListener)){DelegateProgressListenerd=(DelegateProgressListener)listener;listener=d.getDelegate();
if(listenerinstanceofMaxExecutionTimeListener){MaxExecutionTimeListenermax=(MaxExecutionTimeListener)listener;
if(max.isExpired()){return"Theprocessexecutedgotinterruptedbecauseitwent"+"beyondtheconfiguredlimitsof"+"maxExecutionTime"+(max.getMaxExecutionTime()/1000)+"seconds,"+"maxTotalTime"+(max.getMaxTotalTime()/1000)+"seconds";
if(ReadOnlyDataStoreTest.isSpringSecurityException(e)==false)fail("Shouldhavefailedwithasecurityexception");
if(buildingsStyle==null){//undotherenameperformedinoneofthetestmethodsStyleInfosi=catalog.getStyleByName("BuildingsNew");
if(si!=null){si.setName(MockData.BUILDINGS.getLocalPart());catalog.save(si);
elsegoingMonkeyProcess.clearCommands();
if(i<coordinateCount-1){sb.append(",");
ifsettoFilter.EXCLUDEitmakes*theentirelayernonreadable(hides,challenges),otherwiseit'saddedtothereader*parametershouldthereaderhaveafilteramongitsparams(mosaicdoesforexample)*@paramrasterFilterUsedasaROIonthereturnedcoverage*@paramparamsReadparametersoverrides*/publicCoverageAccessLimits(CatalogModemode,FilterreadFilter,MultiPolygonrasterFilter,GeneralParameterValue[]params){super(mode,readFilter);this.rasterFilter=rasterFilter;this.params=params;
if(this==obj)returntrue;
if(!super.equals(obj))returnfalse;
if(getClass()!=obj.getClass())returnfalse;CoverageAccessLimitsother=(CoverageAccessLimits)obj;
if(!Arrays.equals(params,other.params))returnfalse;
if(rasterFilter==null){
if(other.rasterFilter!=null)returnfalse;
else
if(!rasterFilter.equals(other.rasterFilter))returnfalse;returntrue;}}
ifwecanusethestylecache,someconversionsareexpensive.
if(inputinstanceofFile){//converttoresource,toavoidcodeduplicationFilejsonFile=(File)input;input=newFileSystemResourceStore(jsonFile.getParentFile()).get(jsonFile.getName());
if(inputinstanceofResource){ResourcejsonResource=(Resource)input;ResourcesldResource=jsonResource.parent().get(FilenameUtils.getBaseName(jsonResource.name())+".sld");
if(sldResource.getType()!=Resource.Type.UNDEFINED&&sldResource.lastmodified()>jsonResource.lastmodified()){//
ifsldresourceexists,useitreturnsldHandler.parse(sldResource,SLDHandler.VERSION_10,resourceLocator,entityResolver);
else{//otherwiseconvertandwritethecachetry(Readerreader=toReader(input)){StyledLayerDescriptorsld=convertToSLD(reader);try(OutputStreamfos=sldResource.out()){sldHandler.encode(sld,SLDHandler.VERSION_10,true,fos);
if(substitutionGroup!=null){for(Iterator<AttributeDescriptor>it=substitutionGroup.iterator();it.hasNext();){substitutionMap.put(it.next().getName(),descriptor.getName());
if(descriptor==null){thrownewIllegalArgumentException("Cannotfinddescriptorforattribute"+path[index]+"intype"+type.getName().toString());
if(treenodes==null){treenodes=newArrayList<TreeNode>();branch.children.put(path[index],treenodes);
if(index==path.length-1){//canonlyhappen
ifthereisapathwithsize1for(Objectitem:value){SimpleTreeLeafleaf=newSimpleTreeLeaf();leaf.userData=userData;leaf.descriptor=descriptor;leaf.value=item;leaf.userData=userData;treenodes.add(leaf);
else
if(index==path.length-2){
if(treenodes.isEmpty()){for(inti=0;i<value.size();i++){ComplexTreeLeafleaf=newComplexTreeLeaf();treenodes.add(leaf);leaf.descriptor=descriptor;
else
if(treenodes.size()==1){for(inti=1;i<value.size();i++){treenodes.add(treenodes.get(0).clone());
else
if(value.size()!=1&&treenodes.size()!=value.size()){thrownewIllegalArgumentException("Errorinmapping:Numberofvaluesnotmatching.");
else{
if(index!=splitIndex){
if(treenodes.isEmpty()){TreeNodechild=newTreeBranch();child.descriptor=descriptor;treenodes.add(child);
else{
if(treenodes.isEmpty()){for(inti=0;i<value.size();i++){TreeNodechild=newTreeBranch();child.descriptor=descriptor;treenodes.add(child);
else
if(treenodes.size()==1){for(inti=1;i<value.size();i++){treenodes.add(treenodes.get(0).clone());
else
if(treenodes.size()!=value.size()){thrownewIllegalArgumentException("Errorinmapping:Numberofvaluesnotmatching.");
if(geom==null){geom=poly;
else{geom=geom.union(poly);
if(geominstanceofPolygon){geom=geom.getFactory().createMultiPolygon(newPolygon[]{(Polygon)geom});
if(nodeinstanceofTreeLeaf){
if(nodeinstanceofComplexTreeLeaf){ComplexTreeLeafleaf=(ComplexTreeLeaf)node;ComplexTypetype=(ComplexType)node.descriptor.getType();ab.setDescriptor(node.descriptor);for(Entry<String,Object>entry:leaf.value.entrySet()){PropertyDescriptordescriptor=Types.findDescriptor(type,entry.getKey());
if(descriptor==null){thrownewIllegalArgumentException("Cannotfinddescriptorforattribute"+entry.getKey()+"intype"+type.getName().toString());
if(leaf.userData!=null){for(Entry<String,Object>entry:leaf.value.entrySet()){((ComplexAttribute)att).getProperty(entry.getKey()).getUserData().putAll(leaf.userData);
else{SimpleTreeLeafleaf=(SimpleTreeLeaf)node;ab.setDescriptor(node.descriptor);Attributeatt=ab.buildSimple(null,leaf.value);
if(leaf.userData!=null){att.getUserData().putAll(leaf.userData);
else
if(nodeinstanceofTreeBranch){List<Attribute>list=newArrayList<Attribute>();for(List<TreeNode>nodes:((TreeBranch)node).children.values()){for(TreeNodechild:nodes){list.add(buildNode(child));
iftheprovidedclasspackagematchestheGeoGigDTOpackages
if(clazz!=null){PackageaPackage=clazz.getPackage();
if(aPackage==null){//Classloaderofthisclasscan'tfindthepackagefortheprovidedclassLOGGER.log(Level.FINE,"Classloadercannotobtainpackageinfoforclass:{0}",clazz.getName());returnfalse;
if(dataSource!=null)returndataSource;dataSource=newBasicDataSource(){@Overridepublicsynchronizedvoidclose()throwsSQLException{//donothing
if(parameterizedDBConfigs==null){parameterizedDBConfigs=newArrayList<Object[]>();for(DBConfigconf:getDBConfigurations()){parameterizedDBConfigs.add(newObject[]{conf});
if("true".equals(System.getProperty("jdbcconfig."+name+".skip"))){System.err.println("skipping"+name+"tests,enableviamavenprofile");return;
if(connectionUrl!=null){conf.connectionUrl=connectionUrl;
if(dbUser!=null){conf.dbUser=dbUser;
if(dbPass!=null){conf.dbPasswd=dbPass;
if(configDb!=null){configDb.dispose();
if(dataSource!=null){dataSource.close();
if(!dbConfig.initialized){runScript(dbConfig.getInitScript(),null,true);dbConfig.initialized=true;
if(url!=null&&dbConfig.initialized){runScript(dbConfig.getResetScript(),null,true);
else{//dropscriptcannotberuninatransaction-
ifastatementfails//thewholethingabortsrunScript(dbConfig.getDropScript(),null,false);dbConfig.initialized=false;
if(script==null){thrownewIllegalArgumentException("Scriptnotfound:"+JDBCConfigProperties.class.getName()+"/"+dbScriptName);
if(!tx){NamedParameterJdbcTemplatetemplate=newNamedParameterJdbcTemplate(dataSource);Util.runScript(script,template.getJdbcOperations(),null);
else{DataSourceTransactionManagertransactionManager=newDataSourceTransactionManager(dataSource);NamedParameterJdbcTemplatetemplate=newNamedParameterJdbcTemplate(transactionManager.getDataSource());TransactionTemplatetransactionTemplate=newTransactionTemplate(transactionManager);finalJdbcOperationsjdbcOperations=template.getJdbcOperations();transactionTemplate.execute(newTransactionCallback<Object>(){@OverridepublicObjectdoInTransaction(TransactionStatusts){try{Util.runScript(script,jdbcOperations,null);
if(caps!=null){return;
if(dcov!=null){qualifyLayerNames(dcov.getCoverage(),ws);return;
if(gcov!=null){qualifyName(gcov.getSourceCoverage(),ws);
if(remoteWFSStatesAvailable==null){//let'ssee
iftheremoteowstestsareenabledtostartwithStringvalue=System.getProperty("remoteOwsTests");
if(value==null||!"TRUE".equalsIgnoreCase(value)){logger.log(Level.WARNING,"SkippingremoteWFStestbecausetheywerenotenabledvia-DremoteOwsTests=true");remoteWFSStatesAvailable=Boolean.FALSE;
else{//let'scheck
iftheremoteWFStestsarerunnabletry{WFSDataStoreFactoryfactory=newWFSDataStoreFactory();Map<String,Serializable>params=newHashMap(factory.getImplementationHints());URLurl=newURL(WFS_SERVER_URL+"service=WFS&request=GetCapabilities&version=1.1.0");params.put(WFSDataStoreFactory.URL.key,url);params.put(WFSDataStoreFactory.TRY_GZIP.key,Boolean.TRUE);//giveitfivesecondstorespond...params.put(WFSDataStoreFactory.TIMEOUT.key,Integer.valueOf(5000));DataStoreremoteStore=factory.createDataStore(params);FeatureSourcefs=remoteStore.getFeatureSource(TOPP_STATES);remoteWFSStatesAvailable=Boolean.TRUE;//checkabasicresponsecanbeansweredcorrectlyQuerydq=newQuery(TOPP_STATES);FilterFactoryff=CommonFactoryFinder.getFilterFactory(null);dq.setFilter(ff.greater(ff.property("PERSONS"),ff.literal(20000000)));FeatureCollectionfc=fs.getFeatures(dq);
if(fc.size()!=1){logger.log(Level.WARNING,"Remotedatabasestatusinvalid,thereshouldbeoneandonlyone"+"featurewithmorethan20Mpersonsintopp:states");remoteWFSStatesAvailable=Boolean.FALSE;
if(remoteWMSStatesAvailable==null){//let'ssee
iftheremoteowstestsareenabledtostartwithStringvalue=System.getProperty("remoteOwsTests");
if(value==null||!"TRUE".equalsIgnoreCase(value)){logger.log(Level.WARNING,"SkippingremoteOWStestbecausetheywerenotenabledvia-DremoteOwsTests=true");remoteWMSStatesAvailable=Boolean.FALSE;
else{//let'scheck
iftheremoteWFStestsarerunnabletry{remoteWMSStatesAvailable=Boolean.FALSE;WebMapServerserver=newWebMapServer(newURL(WMS_SERVER_URL+"service=WMS&request=GetCapabilities"),5000);for(Layerl:server.getCapabilities().getLayerList()){
if("topp:states".equals(l.getName())){remoteWMSStatesAvailable=Boolean.TRUE;break;
if(document==null){thrownewServiceException("Codingerrorindecorator"+decorator+",documentobjectscannotbesettonull");
if(layerInfo!=null){ResourceInforesource=layerInfo.getResource();ReferencedEnvelopebbox=resource.boundingBox();//if(bbox==null){//bbox=resource.getLatLonBoundingBox();//
else
if(this.type==TYPE_REMOTE_VECTOR){returnremoteFeatureSource.getBounds();
if(layerInfo!=null){ResourceInforesource=layerInfo.getResource();returnresource.getLatLonBoundingBox();
if(layerInfo!=null){try{returnlayerInfo.getDefaultStyle().getStyle();
iftheunderlyingresourceisnotaregistered*one*/publicStringgetSRS(){
if(layerInfo!=null){returnlayerInfo.getResource().getSRS();
if(layerInfo==null){returnCollections.emptyList();
ifweshould,false
ifweshouldomittheheader*/publicbooleanisCachingEnabled(){
if(layerInfo==null){returnfalse;
if(type==TYPE_REMOTE_VECTOR){//wejustassumeremoteWFSisnotcacheablesinceit'sjustused//infeatureportrayalrequests(whichareoneoffanddon'thaveawayto//tellushowoftentheremoteWFSchanges)returnfalse;
if(metadata!=null){cachingEnabled=metadata.get(ResourceInfo.CACHING_ENABLED,Boolean.class);
ifnotset*/publicintgetCacheMaxAge(){
if(layerInfo==null){return0;
if(type!=TYPE_VECTOR){thrownewIllegalArgumentException("Layertypeisnotvector");
if(!layerInfo.enabled()){thrownewIOException("featureType:"+getName()+"doesnothaveaproperlyconfigured"+"datastore");
if(resource.getStore()==null||resource.getStore().getDataStore(null)==null){thrownewIOException("featureType:"+getName()+"doesnothaveaproperlyconfigured"+"datastore");
if(type!=TYPE_RASTER){thrownewIllegalArgumentException("Layertypeisnotraster");
if(layerInfo!=null){returnlayerInfo.getResource().getCRS();
if(remoteFeatureSource!=null){SimpleFeatureTypeschema=remoteFeatureSource.getSchema();returnschema.getCoordinateReferenceSystem();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(getClass()!=obj.getClass())returnfalse;MapLayerInfoother=(MapLayerInfo)obj;
if(name==null){
if(other.name!=null)returnfalse;
else
if(!name.equals(other.name))returnfalse;
if(type!=other.type)returnfalse;returntrue;}}
if(rwl.isWriteLockedByCurrentThread())//writeUnLock();//
else//readUnLock();fireUserGroupLoadedEvent();
if(url.getPath().substring(1).equals(authkey)){returnnewByteArrayInputStream(newString(response).getBytes());
if(testUserName.equals(entry.getValue())){authKey=(String)entry.getKey();break;
if("user1".equals(entry.getValue()))user1KeyA=(String)entry.getKey();
if("user2".equals(entry.getValue()))user2KeyA=(String)entry.getKey();
if("user2".equals(entry.getValue()))assertEquals(user2KeyA,(String)entry.getKey());
if("user3".equals(entry.getValue()))user3KeyA=(String)entry.getKey();
if(this==obj)returntrue;
if(obj==null)returnfalse;
if(!(objinstanceofSettingsInfo)){returnfalse;
if(charset==null){
if(other.getCharset()!=null)returnfalse;
else
if(!charset.equals(other.getCharset()))returnfalse;
if(contact==null){
if(other.getContact()!=null)returnfalse;
else
if(!contact.equals(other.getContact()))returnfalse;
if(id==null){
if(other.getId()!=null)returnfalse;
else
if(!id.equals(other.getId()))returnfalse;
if(numDecimals!=other.getNumDecimals())returnfalse;
if(onlineResource==null){
if(other.getOnlineResource()!=null)returnfalse;
else
if(!onlineResource.equals(other.getOnlineResource()))returnfalse;
if(proxyBaseUrl==null){
if(other.getProxyBaseUrl()!=null)returnfalse;
else
if(!proxyBaseUrl.equals(other.getProxyBaseUrl()))returnfalse;
if(schemaBaseUrl==null){
if(other.getSchemaBaseUrl()!=null)returnfalse;
else
if(!schemaBaseUrl.equals(other.getSchemaBaseUrl()))returnfalse;
if(title==null){
if(other.getTitle()!=null)returnfalse;
else
if(!title.equals(other.getTitle()))returnfalse;
if(verbose!=other.isVerbose())returnfalse;
if(verboseExceptions!=other.isVerboseExceptions())returnfalse;returntrue;
if(Placemark.class.isAssignableFrom(featureClass)){booleanhasHeightTemplate=hasHeightTemplate(context);booleanisExtrudeEnabled=isExtrudeEnabled(context);KmlCentroidOptionscentroidOpts=KmlCentroidOptions.create(context);returnnewPlacemarkGeometryDecorator(hasHeightTemplate,isExtrudeEnabled,centroidOpts);
else{returnnull;
if(!(context.getService()instanceofWMSInfo)){returnfalse;
if(!(context.getService()instanceofWMSInfo)){returnfalse;
if(foExtrude==null){//truebydefaultreturntrue;
if(hasHeightTemplate){try{Stringoutput=context.getTemplate().template(sf,"height.ftl",FeatureTemplate.class);height=Double.valueOf(output);
if(geometry!=null){pm.setGeometry(encodeGeometry(geometry,context,height));
if(!Double.isNaN(height)&&height!=0){geom.apply(newCoordinateFilter(){publicvoidfilter(Coordinatec){c.setCoordinate(newCoordinate(c.x,c.y,height));
ifisnotasinglepointandisdescriptionenabled,we//addandextrudeacentroidtogetherwiththegeometry
if(!isSinglePoint&&context.isDescriptionEnabled()){MultiGeometrymg=newMultiGeometry();//centroid+fullgeometryCoordinatec=CENTROIDS.geometryCentroid(geometry,context.getRequest().getBbox(),centroidOpts);
if(!Double.isNaN(height)){c.setOrdinate(2,height);
if(hasHeightTemplate){applyExtrusion(kmlGeometry);
if(Double.isNaN(c.z)){result.addToCoordinates(c.x,c.y);
else{result.addToCoordinates(c.x,c.y,c.z);
if(geometry==null){returnnull;
if(geometryinstanceofGeometryCollection){MultiGeometrymg=newMultiGeometry();GeometryCollectiongc=(GeometryCollection)geometry;
if(gc.getNumGeometries()==1){returntoKmlGeometry(gc.getGeometryN(0));
else{for(inti=0;i<gc.getNumGeometries();i++){Geometrychild=gc.getGeometryN(i);mg.addToGeometry(toKmlGeometry(child));
else
if(geometryinstanceofPoint){returntoKmlPoint(geometry.getCoordinate());
else
if(geometryinstanceofLinearRing){returnconvertLinearRing((LinearRing)geometry);
else
if(geometryinstanceofLineString){de.micromata.opengis.kml.v_2_2_0.LineStringkmlLine=newde.micromata.opengis.kml.v_2_2_0.LineString();List<de.micromata.opengis.kml.v_2_2_0.Coordinate>kmlCoordinates=dumpCoordinateSequence(((LineString)geometry).getCoordinateSequence());kmlLine.setCoordinates(kmlCoordinates);returnkmlLine;
else
if(geometryinstanceofPolygon){Polygonpolygon=(Polygon)geometry;de.micromata.opengis.kml.v_2_2_0.PolygonkmlPolygon=newde.micromata.opengis.kml.v_2_2_0.Polygon();de.micromata.opengis.kml.v_2_2_0.LinearRingkmlOuterRing=convertLinearRing((LinearRing)polygon.getExteriorRing());kmlPolygon.createAndSetOuterBoundaryIs().setLinearRing(kmlOuterRing);for(inti=0;i<polygon.getNumInteriorRing();i++){LinearRinginterior=(LinearRing)polygon.getInteriorRingN(i);de.micromata.opengis.kml.v_2_2_0.LinearRingkmlInterior=convertLinearRing(interior);kmlPolygon.createAndAddInnerBoundaryIs().setLinearRing(kmlInterior);
else{thrownewIllegalArgumentException("Unrecognizedgeometrytype:"+geometry);
if(!hasHeightTemplate){//allowthepolygontofollowtheground,otherwisesomepolygonswithlong//edgeswilldisappearinmountainareaskmlLine.setTessellate(true);
if(cs.getDimension()>=3||hasHeightTemplate){z=cs.getOrdinate(i,2);
if(Double.isNaN(z)){c=newde.micromata.opengis.kml.v_2_2_0.Coordinate(x,y);
else{c=newde.micromata.opengis.kml.v_2_2_0.Coordinate(x,y,z);
if(kmlGeometryinstanceofde.micromata.opengis.kml.v_2_2_0.Polygon){de.micromata.opengis.kml.v_2_2_0.Polygonpolygon=(de.micromata.opengis.kml.v_2_2_0.Polygon)kmlGeometry;polygon.setExtrude(extrudeEnabled);polygon.setAltitudeMode(AltitudeMode.RELATIVE_TO_GROUND);
else
if(kmlGeometryinstanceofde.micromata.opengis.kml.v_2_2_0.LinearRing){de.micromata.opengis.kml.v_2_2_0.LinearRingring=(de.micromata.opengis.kml.v_2_2_0.LinearRing)kmlGeometry;ring.setExtrude(extrudeEnabled);ring.setTessellate(true);ring.setAltitudeMode(AltitudeMode.RELATIVE_TO_GROUND);
else
if(kmlGeometryinstanceofde.micromata.opengis.kml.v_2_2_0.LineString){de.micromata.opengis.kml.v_2_2_0.LineStringls=(de.micromata.opengis.kml.v_2_2_0.LineString)kmlGeometry;ls.setExtrude(extrudeEnabled);ls.setTessellate(true);ls.setAltitudeMode(AltitudeMode.RELATIVE_TO_GROUND);
else
if(kmlGeometryinstanceofde.micromata.opengis.kml.v_2_2_0.Point){de.micromata.opengis.kml.v_2_2_0.Pointpoint=(de.micromata.opengis.kml.v_2_2_0.Point)kmlGeometry;point.setExtrude(extrudeEnabled);point.setAltitudeMode(AltitudeMode.RELATIVE_TO_GROUND);
else
if(kmlGeometryinstanceofMultiGeometry){de.micromata.opengis.kml.v_2_2_0.MultiGeometrymg=(de.micromata.opengis.kml.v_2_2_0.MultiGeometry)kmlGeometry;for(de.micromata.opengis.kml.v_2_2_0.Geometryg:mg.getGeometry()){applyExtrusion(g);
ifthecomponent*isapage,thetitlecouldbetheusedforalinktothepage.Ifthecomponentisapanelin*atabbedpanel,thetitlemightbethelabelonthetab.*/publicStringgetTitleKey(){returntitle;
ifthe*incomingrequestdoesn'thavethesamemethod.*/publicIncludeQueryStringAntPathRequestMatcher(Stringpattern,StringhttpMethod){Assert.hasText(pattern,"Patterncannotbenullorempty");StringqueryStringPattern="";StringoriginalPattern=pattern;//checkforquerystringpatternexistance
if(pattern.contains(QUERYSTRING_SEPARATOR)){queryStringPattern=pattern.substring(pattern.indexOf(QUERYSTRING_SEPARATOR)+1);pattern=pattern.substring(0,pattern.indexOf(QUERYSTRING_SEPARATOR));
if(pattern.equals(MATCH_ALL)||pattern.equals("**")){pattern=MATCH_ALL;matcher=null;
else{pattern=pattern.toLowerCase();//Ifthepatternendswith{@code/**}andhasnootherwildcards,thenoptimizetoa//sub-pathmatch
if(pattern.endsWith(MATCH_ALL)&&pattern.indexOf('?')==-1&&pattern.indexOf("*")==pattern.length()-2){matcher=newSubpathMatcher(pattern.substring(0,pattern.length()-3));
else{matcher=newSpringAntMatcher(pattern);
ifneeded
if(StringUtils.hasLength(queryStringPattern)){queryStringMatcher=newQueryStringMatcher(queryStringPattern);
else{queryStringMatcher=null;
iftheconfiguredpattern(s)(andHTTP-Method)matchthoseofthesupplied*request.**@paramrequesttherequesttomatchagainst.Theantpatternwillbematchedagainstthe*{@codeservletPath}+{@codepathInfo}oftherequest.*/publicbooleanmatches(HttpServletRequestrequest){
if(httpMethod!=null&&httpMethod!=HttpMethod.valueOf(request.getMethod())){
if(logger.isDebugEnabled()){logger.debug("Request'"+request.getMethod()+""+getRequestPath(request)+"'"+"doesn'tmatch'"+httpMethod+""+pattern);
if(logger.isDebugEnabled()){logger.debug("Checkingmatchofrequest:'"+url+"';against'"+pattern+"'");
if(matched){logger.debug("Matched"+url+"with"+pattern);
if(queryStringMatcher!=null){returnqueryStringMatcher.matches(url.getQueryString());
if(pattern.equals(MATCH_ALL)){
if(logger.isDebugEnabled()){logger.debug("Requestmatchedbyuniversalpattern'/**'");
if(request.getPathInfo()!=null){url+=request.getPathInfo();
if(!(objinstanceofIncludeQueryStringAntPathRequestMatcher)){returnfalse;
if(httpMethod!=null){code^=httpMethod.hashCode();
if(httpMethod!=null){sb.append(",").append(httpMethod);
if(!unparsed.startsWith("^")){unparsed="^"+unparsed;
if(!unparsed.endsWith("$")){unparsed=unparsed+"$";
if(pattern!=null&&path!=null){returnpattern.matcher(path).matches();
if(par.getName().equals("SAMLRequest")){samlRequest=par.getValue();break;
if(a.getAuthority().equals(rootRole)){hasRootRole=true;break;
ifSAMLlogutURLwillbecalled*/assertThat(redirectURL,CoreMatchers.containsString(SAMLLogoutFilter.FILTER_URL));
if(config==null){config=newOneloginAuthenticationFilterConfig();config.setWantAssertionSigned(false);config.setClassName(OneloginAuthenticationFilter.class.getName());config.setName(oneloginFilterName);config.setEntityId("geoserver");config.setMetadataURL("https://localhost:"+idpSamlService.httpsPort()+METADATA_URL);
iftherearen'tanystylestorender,wedon'tneedtogetanydata....
if(styleList.isEmpty()){Queryquery=newQuery(schema.getName().getLocalPart());query.setProperties(Query.NO_PROPERTIES);query.setFilter(Filter.EXCLUDE);returnquery;
if(requestBufferScreen<=0){MetaBufferEstimatorbufferEstimator=newMetaBufferEstimator();styleList.stream().flatMap(fts->Stream.concat(Arrays.stream(fts.elseRules),Arrays.stream(fts.ruleList))).forEach(bufferEstimator::visit);bufferScreen=bufferEstimator.getBuffer();
else{bufferScreen=requestBufferScreen;
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,"Errorwhilecomputingpixelsize",ex);
if(filter==null){returnnull;
if(!sfv.hasSpatialFilter()){returnfilter;
iftheprovidedsoruceCRSisnot2Dweare*goingtomanuallypost-processtheGeomtriesinto{@linkDefaultGeographicCRS#WGS84}-and*the{@linkMathTransform2D}returnedherewilltransitionfromWGS84totherequested*destCRS.**@paramsourceCRS*@paramdestCRS*@returnthetransformfrom{@codesourceCRS}to{@codedestCRS},willbeanidentity*transform
ifthethetwocrsareequal*@throwsFactoryExceptionIfnotransformisavailabletothedestCRS*/publicstaticMathTransformbuildTransform(CoordinateReferenceSystemsourceCRS,CoordinateReferenceSystemdestCRS)throwsFactoryException{Preconditions.checkNotNull(sourceCRS,"sourceCRS");Preconditions.checkNotNull(destCRS,"destCRS");MathTransformtransform=null;
if(sourceCRS.getCoordinateSystem().getDimension()>=3){//WearegoingtotransformovertoDefaultGeographic.WGS84onthefly//sowewillsetupourmathtransformtotakeitfromthereMathTransformtoWgs84_3d=CRS.findMathTransform(sourceCRS,DefaultGeographicCRS.WGS84_3D);MathTransformtoWgs84_2d=CRS.findMathTransform(DefaultGeographicCRS.WGS84_3D,DefaultGeographicCRS.WGS84);transform=ConcatenatedTransform.create(toWgs84_3d,toWgs84_2d);sourceCRS=DefaultGeographicCRS.WGS84;
ifanyMathTransform2DsourceToTarget;sourceToTarget=(MathTransform2D)CRS.findMathTransform(sourceCRS,destCRS,true);
if(transform==null){returnsourceToTarget;
if(sourceToTarget.isIdentity()){returntransform;
ifDataStoreisadatabase.Problemisthatworstcaseeachfilterisrantwice.Next*wewillmodifyittofinda"Common"filterbetweenallrulesandsendthattothedatastore.**<p>DJB:tryingtobesmarter.Ifthereareno"elseRules"andnorulesw/oafilter,thenit*makessensetosendthemofftotheDatastoreWelimitthenumberofFilterssentofftothe*datastore,justbecauseitcouldgetabitrediculous.Ingeneral,foradatabase,
ifyoucan*limit10%oftherowsbeingreturnedyou'reprobablydoingquitewell.Themainproblemis*whenyourfiltersreallymeanyou'resecretlyaskingforallthedatainwhichcasesending*thefilterstotheDatastoreactuallycostsyou.But,databasesare*much*fasterat*processingtheFiltersthanJAVAisandcanusestatisticalanalysistodoit.**@paramstyles*@paramquery*/privatestaticvoidprocessRuleForQuery(LiteFeatureTypeStyle[]styles,Queryquery){try{//firstwechecktosee
ifthereare>//"getMaxFiltersToSendToDatastore"rules//
ifso,thenwedontdoanythingsincenomatterwhatthere'stoo//manytosenddown.//nextwecheckforany
elserules.Ifwefindany-->dontsend//anythingtoDatastore//nextwecheckforrulesw/ofilters.Ifwefindany-->dontsend//anythingtoDatastore////otherwise,we'regoldandcan"or"togetherallthefiltersthen//ANDitwiththeoriginalfilter.//ie.SELECT*FROM...WHERE(the_geom&&BBOX)AND(filter1OR//filter2ORfilter3);finalintmaxFilters=5;finalList<Filter>filtersToDS=newArrayList<Filter>();//lookateachfeaturetypestylefor(LiteFeatureTypeStylestyle:styles){
if(style.elseRules.length>0)//uh-ohhaselseRulereturn;//lookateachruleinthefeaturetypestylefor(Ruler:style.ruleList){
if(r.getFilter()==null)return;//uh-ohhasnofilter(wantallrows)filtersToDS.add(r.getFilter());
iftoomanybailout
if(filtersToDS.size()>maxFilters)return;//ortogetherallthefiltersorg.opengis.filter.FilterruleFiltersCombined;
if(filtersToDS.size()==1){ruleFiltersCombined=filtersToDS.get(0);
else{ruleFiltersCombined=FF.or(filtersToDS);
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.SEVERE,"Couldnotsendrulestodatastoredueto:"+e.getMessage(),e);
if(isFeatureTypeStyleActive(ftype,fts)){//DJB:thisFTSiscompatiblewiththisFT.//getapplicablerulesatthecurrentscaleList<Rule>[]splittedRules=splitRules(fts,scaleDenominator);List<Rule>ruleList=splittedRules[0];List<Rule>elseRuleList=splittedRules[1];//
ifnone,skipit
if((ruleList.isEmpty())&&(elseRuleList.isEmpty()))continue;//wecanoptimizethisoneanddrawdirectlyonthegraphics,assuming//thereisnocompositionGraphics2Dgraphics=null;lfts=newLiteFeatureTypeStyle(layer,graphics,ruleList,elseRuleList,fts.getTransformation());result.add(lfts);
if(isWithInScale(r,scaleDenominator)){
if(r.isElseFilter()){elseRuleList.add(r);
else{ruleList.add(r);
ifarulecanbetriggeredatthecurrentscalelevel**@returntrue
ifthescaleiscompatiblewiththerulesettings*/privatestaticbooleanisWithInScale(Ruler,doublescaleDenominator){/**Toleranceusedtocomparedoublesforequality*/finaldoubleTOLERANCE=1e-6;return((r.getMinScaleDenominator()-TOLERANCE)<=scaleDenominator)&&((r.getMaxScaleDenominator()+TOLERANCE)>scaleDenominator);
if(createGeoServer){SettingsInfosettings=createNiceMock(SettingsInfo.class);expect(settings.isLocalWorkspaceIncludesPrefix()).andReturn(includePrefix).anyTimes();replay(settings);GeoServergeoServer=createNiceMock(GeoServer.class);expect(geoServer.getSettings()).andReturn(settings).anyTimes();replay(geoServer);catalog.setGeoServer(geoServer);
if(setLocalWorkspace){WorkspaceInfoworkspaceByName=catalog.getWorkspaceByName("ws1");LocalWorkspace.set(workspaceByName);
if(layerInfo==null){continue;
if(includePrefix){message=layerInfo.getName()+"shouldcontaina:becausetheprefixshouldhavebeenkept";
else{message=layerInfo.getName()+"shouldcontainnota:becausetheprefixshouldhavebeenremoved";
if(f.exists()){url=f.toURI().toURL();
else{url=newURL(location);
if(info!=null){try{return(DataStore)info.getDataStore(null);
if(StringUtils.hasLength(webServiceBodyConfig.getSearchRoles())){try{searchRolesRegex=Pattern.compile(webServiceBodyConfig.getSearchRoles());
if(StringUtils.hasLength(webServiceBodyConfig.getAvailableGroups())){for(Stringrole:webServiceBodyConfig.getAvailableGroups().split(",")){availableGroups.add(newGeoServerUserGroup((convertToUpperCase?role.trim().toUpperCase():role.trim())));
if(StringUtils.hasLength(webServiceBodyConfig.getRoleServiceName())){roleServiceName=webServiceBodyConfig.getRoleServiceName();
else{roleServiceName=null;
if(username==null){thrownewUsernameNotFoundException(userNotFoundMessage(username));
if(matcher.find()){for(inti=1;i<=matcher.groupCount();i++){for(StringroleName:matcher.group(i).split(",")){authorities.add(createAuthorityObject(roleName.trim()));
else{LOGGER.log(Level.WARNING,"ErrorinWebServiceAuthenticationKeyMapper,cannotfindanyRoleinresponse");authorities.add(GeoServerRole.ADMIN_ROLE);
if(calc!=null){finalSortedSet<GeoServerUserGroup>groups=newTreeSet<GeoServerUserGroup>();for(GrantedAuthorityauthority:authorities){groups.add(createGroupObject(authority.getAuthority(),true));
if(group.isEnabled()){for(GeoServerRolerole:calc.calculateRoles(group)){
if(!authorities.contains(role)){authorities.add(role);
ifRoleAdminandAnonymousarepresentotherthanotherroles
if(authorities.size()>0){for(GrantedAuthorityauthority:authorities){
if(authority.equals(GeoServerRole.ADMIN_ROLE)||authority.equals(GeoServerRole.GROUP_ADMIN_ROLE)||authority.getAuthority().equals(DEFAULT_LOCAL_ADMIN_ROLE)||authority.getAuthority().equals(DEFAULT_LOCAL_GROUP_ADMIN_ROLE)){authorities.clear();authorities.add(GeoServerRole.ADMIN_ROLE);break;
if(authorities.size()>1&&authority.equals(GeoServerRole.ANONYMOUS_ROLE)){authorities.remove(authority);break;
if(group.getGroupname().equalsIgnoreCase(groupname)){returngroup;
if(!theGroupName.contains(groupPrefix)){
if(theGroupName.equals(GeoServerRole.ADMIN_ROLE.getAuthority())){theGroupName=GeoServerRole.GROUP_ADMIN_ROLE.getAuthority().substring(rolePrefix.length());
else{//removestandardroleprefixtheGroupName=theGroupName.substring(rolePrefix.length());theGroupName=groupPrefix+theGroupName;
if(user.getAuthorities()!=null){for(GrantedAuthorityauthority:user.getAuthorities()){groups.add(createGroupObject(authority.getAuthority(),true));
if(defaultSecurityService==null){
if(StringUtils.hasLength(roleServiceName)){try{for(StringroleService:securityManager.listRoleServices()){
if(roleService.equals(roleServiceName)){defaultSecurityService=securityManager.loadRoleService(roleServiceName);break;
if(defaultSecurityService==null){defaultSecurityService=securityManager.getActiveRoleService();
if(getConfiguration().get("xmpp_packet_reply_timeout")!=null){packetReplyTimeout=Integer.parseInt(getConfiguration().get("xmpp_packet_reply_timeout"));
if(this.certificateFile!=null&&this.certificatePassword!=null){KeyStoretrustStore=KeyStore.getInstance(KeyStore.getDefaultType());FileInputStreaminstream=newFileInputStream(this.certificateFile);try{trustStore.load(instream,this.certificatePassword.toCharArray());
if(sslcontext!=null){//config.setSASLAuthenticationEnabled(false);config.setSecurityMode(SecurityMode.enabled);config.setCustomSSLContext(sslcontext);
else{config.setSecurityMode(SecurityMode.disabled);
if(testConn>=5){LOGGER.warning("NoXMPPTCPEndpointavailableorcouldnotgetanyresponsefromtheServer.FallingbacktoBOSHEndpoint.");
else{LOGGER.log(Level.WARNING,"Tentative#"+(testConn+1)+"-ErrorwhiletryingtoconnecttoXMPPTCPEndpoint.",e);Thread.sleep(500);
if(connection==null||!connection.isConnected()){for(inttestConn=0;testConn<5;testConn++){try{//FallingbacktoBOSHEndpointBOSHConfigurationboshConfig=newBOSHConfiguration((sslcontext!=null),server,port,null,getConfiguration().get("xmpp_domain"));
if(sslcontext!=null){//boshConfig.setSASLAuthenticationEnabled(false);boshConfig.setSecurityMode(SecurityMode.enabled);boshConfig.setCustomSSLContext(sslcontext);
else{boshConfig.setSecurityMode(SecurityMode.disabled);
if(testConn>=5){LOGGER.warning("NoXMPPBOSHEndpointavailableorcouldnotgetanyresponsefromtheServer.TheXMPPClientwon'tbeavailable.");
else{LOGGER.log(Level.WARNING,"Tentative#"+(testConn+1)+"-ErrorwhiletryingtoconnecttoXMPPBOSHEndpoint.",e);Thread.sleep(500);
iftheconnectiontotheXMPPserverissuccessful;thelogin//andregistrationisnotyetperformedatthistime
if(connection.isConnected()){chatManager=ChatManager.getInstanceFor(connection);discoStu=ServiceDiscoveryManager.getInstanceFor(connection);//AddfeaturestoourXMPPclientdiscoProperties();//Performsloginwith"admin"usercredentialsperformLogin(getConfiguration().get("xmpp_manager_username"),getConfiguration().get("xmpp_manager_password"));//Start"ping"taskinordertomaintainalivetheconnectionstartPingTask();//SendinvitationtotheregisteredendpointssendInvitations();//getEndpointsLoadAverages();//checkPendingRequests();
else{setEnabled(false);LOGGER.warning("Notconnected!TheXMPPclienthasbeendisabled.");
if(xmppServerEmbeddedSecure!=null&&Boolean.valueOf(xmppServerEmbeddedSecure.trim())){//OverrideXMLproperties
if(xmppServerEmbeddedCertFile!=null&&xmppServerEmbeddedCertPwd!=null){finalorg.geoserver.platform.resource.ResourcecertFileResource=Resources.fromURL(xmppServerEmbeddedCertFile.trim());
if(certFileResource!=null){this.certificateFile=certFileResource.file();this.certificatePassword=xmppServerEmbeddedCertPwd.trim();
else{//GettheResourceloaderGeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);try{//Copythedefaultpropertyfileintothedatadirectory//URLurl=//RemoteProcessFactoryConfigurationWatcher.class.getResource(xmppServerEmbeddedCertFile.trim());//
if(url!=null){this.certificateFile=loader.createFile(xmppServerEmbeddedCertFile.trim());loader.copyFromClassPath(xmppServerEmbeddedCertFile.trim(),this.certificateFile/*,RemoteProcessFactoryConfigurationWatcher.class*/);//
if(LOGGER.isLoggable(Level.WARNING)){LOGGER.log(Level.WARNING,e.getMessage(),e);
if(metadata==null){thrownewException("CouldnotsendaRequestMessagetotheRemoteXMPPClient!");
if(baseURL==null){baseURL=RequestUtils.baseURL(request.getHttpRequest());
if(serviceJID!=null){/**WehaveaJIDtoanavailableprocessingnode;sendtherequestmessagetoit...*///UpdateMetadatametadata.put("serviceJID",serviceJID);LOGGER.info("XMPPClient::execute-extractingthePIDfortheserviceJID["+serviceJID+"]withinputs["+fixedInputs+"]");sendMessage(serviceJID,msg);
else{/***Wecouldnotfindasuitableprocessingnodetoservetherequest;queueitforlater*checks...*/pendingRequests.add(newRemoteRequestDescriptor(serviceName,input,metadata,pid,baseURL));
if(valueinstanceofRawData){fixedValue=IOUtils.toString(((RawData)value).getInputStream(),"UTF-8");
else
if(valueinstanceofList){List<Object>values=(List<Object>)value;
if(values!=null&&values.size()>0&&values.get(0)instanceofRawData){fixedValue=newArrayList<String>();for(Objecto:values){((List<String>)fixedValue).add(IOUtils.toString(((RawData)o).getInputStream(),"UTF-8"));
if(connection!=null&&connection.isConnected()){connection.login(username,password,getResource(username));//CreateaMultiUserChatusingaXMPPConnectionforaroom//Userjoinsthenewroomusingapasswordandspecifying//theamountofhistorytoreceive.Inthisexampleweare//requestingthelast5messages.DiscussionHistoryhistory=newDiscussionHistory();history.setMaxStanzas(5);mucManagementChannel=newMultiUserChat(connection,managementChannel+"@"+bus+"."+domain);try{mucManagementChannel.join(getJID(username),managementChannelPassword);/**,history,connection.getPacketReplyTimeout());*/
if(connection!=null&&connection.isConnected()){stopPingTask();connection.disconnect();
if(openChat.get(origin)!=null){returnopenChat.get(origin);
if(chat==null)chat=setupChat(person);try{chat.sendMessage(message);
if(person.lastIndexOf("@")<person.indexOf("/")){occupantFlatName=person.substring(person.indexOf("/")+1);
else{occupantFlatName=person.substring(person.indexOf("/")+1);occupantFlatName=occupantFlatName.substring(0,occupantFlatName.indexOf("@"));
if(occupantFlatName.indexOf(".")>0){finalStringserviceName[]=occupantFlatName.split("\\.");returnnewNameImpl(serviceName[0],serviceName[1]);
else{finalStringchannel=person.substring(0,person.indexOf("@"));returnnewNameImpl(channel,occupantFlatName);
if(serviceJIDParts.length==3&&(serviceJIDParts[2].startsWith("master")||serviceJIDParts[2].indexOf("@")<0)){sendMessage(occupant,"topic=invite");
if(!registeredServices.contains(serviceName)){registeredServices.add(serviceName);
if(!nodeJIDs.contains(occupant)){registeredProcessingMachines.add(newRemoteMachineDescriptor(occupant,extractServiceName(occupant),false,0.0,0.0));
if(serviceJIDParts.length==3&&(serviceJIDParts[2].startsWith("master")||serviceJIDParts[2].indexOf("@")<0)){sendMessage(occupant,"topic=getloadavg");
ifexpired.**@throwsException*/protectedvoidcheckPendingRequests()throwsException{synchronized(pendingRequests){for(RemoteRequestDescriptorrequest:pendingRequests){//Check
iftherequestisstillvalidfinalStringpid=request.getPid();booleanisRequestValid=false;for(RemoteProcessClientListenerprocess:getRemoteClientListeners()){
if(process.getPID().equals(pid)){isRequestValid=true;break;
if(!isRequestValid){//RemovetherequestfromthequeuependingRequests.remove(request);continue;
iftherequestcanbeexecutedbyaremoteprocessingnodefinalNameserviceName=request.getServicename();finalStringserviceJID=getFlattestMachine(serviceName);
if(serviceJID!=null){//ExtracttheprocessinputsfinalObjectfixedInputs=getFixedInputs(request.getInput());//BuildandsendtheREUQESTmessage/***topic=requestid=pidbaseURL=geoserverurlmessage=<pickledWPS*inputs>*/finalStringmsg="topic=request&id="+pid+"&baseURL="+request.getBaseURL()+"&message="+byteArrayToURLString(pickle(fixedInputs));/***WehaveaJIDtoanavailableprocessingnode;sendtherequestmessageto*it...*///UpdateMetadatarequest.getMetadata().put("serviceJID",serviceJID);LOGGER.info("XMPPClient::execute-extractingthePIDfortheserviceJID["+serviceJID+"]withinputs["+fixedInputs+"]");sendMessage(serviceJID,msg);//RemovetherequestfromthequeuependingRequests.remove(request);continue;
ifitisa*remoteservice.Ifso,registerit**@paramp*/protectedvoidhandleMemberJoin(Presencep)throwsException{synchronized(registeredServices){LOGGER.finer("Member"+p.getFrom()+"joinedthechat.");finalNameserviceName=extractServiceName(p.getFrom());//sendinvitationandregistersourceJIDString[]serviceJIDParts=p.getFrom().split("/");
if(serviceJIDParts.length==3&&(serviceJIDParts[2].startsWith("master")||serviceJIDParts[2].indexOf("@")<0)){sendMessage(p.getFrom(),"topic=invite");
if(!registeredServices.contains(serviceName)){registeredServices.add(serviceName);
if(registeredServices.contains(serviceName)){registeredServices.remove(serviceName);
if(getConfiguration().get("xmpp_cpu_perc_threshold")!=null){cpuLoadPercThreshold=Double.valueOf(getConfiguration().get("xmpp_cpu_perc_threshold"));
if(getConfiguration().get("xmpp_mem_perc_threshold")!=null){vmemPercThreshold=Double.valueOf(getConfiguration().get("xmpp_mem_perc_threshold"));
if(getConfiguration().get("xmpp_force_execution")!=null){forceExecutionIfNoCandidate=Boolean.valueOf(getConfiguration().get("xmpp_force_execution"));
if(node.getAvailable()&&node.getServiceName().equals(serviceName)){
if(node.getLoadAverage()>=cpuLoadPercThreshold||node.getMemPercUsed()>=vmemPercThreshold){continue;
if(candidateNode==null||(node.getLoadAverage()<=candidateNode.getLoadAverage()&&(node.getLoadAverage()<candidateNode.getLoadAverage()||node.getMemPercUsed()<candidateNode.getMemPercUsed()))){candidateNode=node;
if(candidateNode!=null){LOGGER.info("XMPPClient::getFlattestMachine-...foundnewcandidate:"+candidateNode.getNodeJID());returncandidateNode.getNodeJID();
if(forceExecutionIfNoCandidate){
if(registeredProcessingMachines.size()>0){LOGGER.info("XMPPClient::getFlattestMachine-ForcedExecution:fallingbacktofirstmachine!");candidateNode=registeredProcessingMachines.get(0);returncandidateNode.getNodeJID();
else{LOGGER.info("XMPPClient::getFlattestMachine-ForcedExecution:nomachineavailableSTALLED!");
if(getConfiguration().get("xmpp_connection_ping_interval")!=null){this.delay=Long.parseLong(getConfiguration().get("xmpp_connection_ping_interval"));
if(getConfiguration().get("xmpp_connection_ping_timeout")!=null){this.timeout=Long.parseLong(getConfiguration().get("xmpp_connection_ping_timeout"));
if(getConfiguration().get("xmpp_connection_ping_initial_delay")!=null){this.start_delay=Long.parseLong(getConfiguration().get("xmpp_connection_ping_initial_delay"));
if(result==null){LOGGER.warning("pingtimeout");returnfalse;
if(connection.isConnected()&&connection.isAuthenticated()){LOGGER.log(Level.FINER,"ping");try{
if(!sendPing()){LOGGER.severe("pingfailed-closeconnection");try{connection.disconnect();
else{//getEndpointsLoadAverages();//checkPendingRequests();
else{//Trytoreconnect...LOGGER.log(Level.FINER,"Trytoreconnect...");try{connection.connect();LOGGER.info("Connected:"+connection.isConnected());//check
iftheconnectiontotheXMPPserveris//successful;theloginandregistrationisnotyet//performedatthistime
if(connection.isConnected()){chatManager=ChatManager.getInstanceFor(connection);discoStu=ServiceDiscoveryManager.getInstanceFor(connection);//discoProperties();//performLogin(getConfiguration().get("xmpp_manager_username"),getConfiguration().get("xmpp_manager_password"));//startPingTask();//sendInvitations();//getEndpointsLoadAverages();//checkPendingRequests();
else{setEnabled(false);
if(in==null||in.length<=0)returnnull;Stringpseudo[]={"0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"};StringBufferout=newStringBuffer(in.length*2);while(i<in.length){//Firstchecktosee
ifweneedASCIIorHEX
if((in[i]>='0'&&in[i]<='9')||(in[i]>='a'&&in[i]<='z')||(in[i]>='A'&&in[i]<='Z')||in[i]=='$'||in[i]=='-'||in[i]=='_'||in[i]=='.'||in[i]=='!'){out.append((char)in[i]);i++;
else{out.append('%');ch=(byte)(in[i]&0xF0);//Stripoffhighnibblech=(byte)(ch>>>4);//shiftthebitsdownch=(byte)(ch&0x0F);//mustdothisishighorderbitis//on!out.append(pseudo[(int)ch]);//convertthenibbletoa//StringCharacterch=(byte)(in[i]&0x0F);//Stripofflownibbleout.append(pseudo[(int)ch]);//convertthenibbletoa//StringCharacteri++;
if(name.equalsIgnoreCase("complex")||name.equalsIgnoreCase("complex")){//Isitacomplex/rawdatatype?c=RawData.class;
else
if(PRIMITIVE_NAME_TYPE_MAP.get(name)!=null){//Checkforaprimitivetypec=(Class)((Object[])PRIMITIVE_NAME_TYPE_MAP.get(name))[0];
if(c==null){//Noprimitive,trytoloaditfromthegivenClassLoadertry{c=cl.loadClass(name);
ifwehaveanarraygetthearrayclass
if(arraySize>0){int[]dims=newint[arraySize];for(inti=0;i<arraySize;i++){dims[i]=1;
if(defaultValue!=null&&CType.SIMPLE.equals(((Object[])PRIMITIVE_NAME_TYPE_MAP.get(name))[1])){sample=defaultValue;
else
if(CType.COMPLEX.equals(((Object[])PRIMITIVE_NAME_TYPE_MAP.get(name))[1])&&((Object[])PRIMITIVE_NAME_TYPE_MAP.get(name)).length>2){sample=((Object[])PRIMITIVE_NAME_TYPE_MAP.get(name))[2];
else{sample=null;
if(PRIMITIVE_NAME_TYPE_MAP.get(name)!=null)mimeTypes=(String)((Object[])PRIMITIVE_NAME_TYPE_MAP.get(name))[3];returnnewParameterTemplate(c,sample,mimeTypes);}}/***Actualimplementationofa"PacketListener".**<p>Listentotheservicechannelsandhandlesthe"registration"and"de-registration"ofthe*availableservices(aliasavailableWPSProcesses)**@authorAlessioFabiani,GeoSolutions*/classXMPPPacketListenerimplementsPacketListener{/**TheLOGGER*/publicstaticfinalLoggerLOGGER=Logging.getLogger(XMPPPacketListener.class.getPackage().getName());privateXMPPClientxmppClient;publicXMPPPacketListener(XMPPClientxmppClient){this.xmppClient=xmppClient;
if(packetinstanceofPresence){Presencep=(Presence)packet;try{
if(p.isAvailable()){
if(p.getFrom().indexOf("@")>0){/**Managethechanneloccupantslist*/finalStringchannel=p.getFrom().substring(0,p.getFrom().indexOf("@"));/**
if(xmppClient.occupantsList.get(channel)==null){xmppClient.occupantsList.put(channel,newArrayList<String>());
if*(xmppClient.occupantsList.get(channel)!=null){
if(!xmppClient.occupantsList.get(channel).contains(p.getFrom()))*xmppClient.occupantsList.get(channel).add(p.getFrom());
if(xmppClient.serviceChannels.contains(channel))xmppClient.handleMemberJoin(p);
else
if(!p.isAvailable()){
if(p.getFrom().indexOf("@")>0&&p.getFrom().indexOf("/master")>0){booleanmustDeregisterService=true;finalStringchannel=p.getFrom().substring(0,p.getFrom().indexOf("@"));finalNameImplserviceName=xmppClient.extractServiceName(p.getFrom());for(MultiUserChatmucServiceChannel:xmppClient.mucServiceChannels){
if(mucServiceChannel.getRoom().startsWith(channel)){for(Stringoccupant:mucServiceChannel.getOccupants()){
if(!occupant.equals(p.getFrom())){finalNameoccupantServiceName=xmppClient.extractServiceName(occupant);//sendinvitationandregistersource//JIDString[]serviceJIDParts=occupant.split("/");
if(serviceJIDParts.length==3&&(serviceJIDParts[2].startsWith("master")||serviceJIDParts[2].indexOf("@")<0)){
if(serviceName.equals(occupantServiceName)){mustDeregisterService=false;break;
if(mustDeregisterService&&xmppClient.serviceChannels.contains(channel))xmppClient.handleMemberLeave(p);
else
if(packetinstanceofMessage){Messagemessage=(Message)packet;Stringorigin=message.getFrom().split("/")[0];Chatchat=xmppClient.setupChat(origin);
if(message.getBody()!=null){LOGGER.fine("ReceivedMessage('"+message.getBody()+"','"+origin+"','"+message.getPacketID()+"');");Map<String,String>signalArgs=newHashMap<String,String>();try{String[]messageParts=message.getBody().split("&");for(Stringmp:messageParts){String[]signalArg=mp.split("=");signalArgs.put(signalArg[0],signalArg[1]);
if(!signalArgs.isEmpty()&&signalArgs.containsKey("topic")){for(XMPPMessagexmppMessage:GeoServerExtensions.extensions(XMPPMessage.class)){
if(xmppMessage.canHandle(signalArgs)){xmppMessage.handleSignal(xmppClient,packet,message,signalArgs);
if(mimeTypes!=null&&mimeTypes.split(",").length>0){this.meta.put("chosenMimeType",mimeTypes.split(",")[0]);
if(maxRenderingTime>0){this.end=System.currentTimeMillis()+maxRenderingTime;
if(maxRenderingTime>0&&System.currentTimeMillis()>end){thrownewServiceException("Thisrequestusedmoretimethanallowedandhasbeenforcefullystopped."+"Maxrenderingtimeis"+(maxRenderingTime/1000.0)+"s");
if(identifier.canHandle(layer)){returnidentifier;
ifwehaveatimerange
if(request.getGetMapRequest().getTime()==null||request.getGetMapRequest().getTime().size()!=1){thrownewServiceException("TheTIMEparameterwasnotavalidWMStimerangeorwasmissing");
if(queryRangePlain==null||!(queryRangePlaininstanceofDateRange)){thrownewServiceException("TheTIMEparameterwasnotavalidWMStimerange");
ifwehavesinglelayer
if(requestedLayers.size()!=1){thrownewServiceException("TheQUERY_LAYERSparametermustspecifyasinglecoveragelayerfortheGetTimeSeriesoperation");
if(request.getPropertyNames()==null||request.getPropertyNames().size()==0||request.getPropertyNames().get(0).isEmpty()){StringfirstBand=coverage.getDimensions().get(0).getName();request.setPropertyNames(Arrays.asList(Arrays.asList(firstBand)));
if(identifiedCollections!=null){for(FeatureCollectionc:identifiedCollections){try(FeatureIteratorfeatIter=c.features()){
if(featIter.hasNext()){//noneedtoloop,wejustwantonevalueFeatureinFeat=featIter.next();Iterator<Property>propIter=inFeat.getProperties().iterator();
if(propIter.hasNext()){Propertyprop=propIter.next();featureBuilder.add(date);featureBuilder.add(prop.getValue());SimpleFeaturenewFeat=featureBuilder.buildFeature(null);features.add(newFeat);
if(layer.getCoverage()!=null&&layer.getCoverage().getDimensions().size()==1&&layer.getCoverage().getDimensions().get(0).getName()!=null&&layer.getCoverage().getDimensions().get(0).getUnit()!=null){name=layer.getCoverage().getDimensions().get(0).getName()+"("+layer.getCoverage().getDimensions().get(0).getUnit()+")";
if(ecql!=null){FilterAttributeExtractorfilter=newFilterAttributeExtractor();ecql.accept(filter,null);//ExtractionoftheattributesList<String>attributes=Arrays.asList(filter.getAttributeNames());//InvalidAttributesList<String>invalid=newArrayList<String>();//Checkontheattributesfor(Stringattribute:attributes){
if(!(attribute.equalsIgnoreCase(RESTUploadECQLPathMapper.PATH)||attribute.equalsIgnoreCase(RESTUploadECQLPathMapper.NAME))){invalid.add(attribute);
ifaninvalidattributeispresent
if(!invalid.isEmpty()){StringBuilderstring=newStringBuilder("InvalidAttributes:");for(Stringattribute:invalid){string.append(attribute);string.append(",");
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Savingstatus"+status);
if(oldStatus!=null){ProcessStatepreviousPhase=oldStatus.getPhase();ProcessStatecurrPhase=status.getPhase();
if(!currPhase.isValidSuccessor(previousPhase)){thrownewWPSException("Cannot
switchprocessstatusfrom"+previousPhase+"to"+currPhase);
else{ExecutionStatusprevious=statuses.put(status.getExecutionId(),newStatus);succeded=previous==null;
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Removingstatusesmatching"+filter);
if(filter.evaluate(status)){count++;statuses.remove(status.getExecutionId());
if(filter.evaluate(status)){result.add(status);
if(sorts!=null){List<Comparator<ExecutionStatus>>comparators=newArrayList<>();for(SortBysort:sorts){
if(sort==SortBy.NATURAL_ORDER){comparators.add(newBeanComparator("creationTime"));
else
if(sort==SortBy.REVERSE_ORDER){comparators.add(Collections.reverseOrder(newBeanComparator("creationTime")));
else{Stringproperty=sort.getPropertyName().getPropertyName();//mappropertytoExecutionStatusvalues
if("node".equalsIgnoreCase(property)){property="nodeId";
else
if("user".equalsIgnoreCase(property)){property="userName";
else
if("task".equalsIgnoreCase(property)){property="task";
if(sort.getSortOrder()==SortOrder.DESCENDING){comparator=Collections.reverseOrder(comparator);
if(comparators.size()>1){Comparator<ExecutionStatus>comparator=newCompositeComparator<>(comparators);Collections.sort(result,comparator);
else
if(comparators.size()==1){Collections.sort(result,comparators.get(0));
if(startIndex!=null&&startIndex>0){
if(startIndex>result.size()){result.clear();
else{result=result.subList(startIndex,result.size());
if(result.size()>query.getMaxFeatures()){result=result.subList(0,query.getMaxFeatures());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"Removingstatusforexecutionid:"+executionId);
ifithasbeeninvalidatedistocheckthattheattributesaregone...assertNull(session.getAttribute("test"));}}
if(identifiers==null||identifiers.size()==0){thrownewWcsException("Requiredparamer,coverage,missing",WcsExceptionCode.MissingParameterValue,"coverage");
if(layer==null||layer.getType()!=PublishedType.RASTER)thrownewWcsException("Couldnotfindcoverage'"+coverage+"'",InvalidParameterValue,"coverage");coverages.add(coverage);
if(value){maxLengthPanel.setUnlimited();
if("metaDataProperty".equalsIgnoreCase(name)){fail("thisshouldbedeleted");
if(JDBCUserGroupService.class.getName().equals(className))returnnewJDBCUserGroupConfigDetailsPanel(id,model);
if(JDBCRoleService.class.getName().equals(className))returnnewJDBCRoleConfigDetailsPanel(id,model);
if(JDBCConnectAuthProvider.class.getName().equals(className))returnnewJDBCAuthProviderConfigDetailsPanel(id,model);returnnull;}}
if("gml".equals(geometryEncoding)){tx.setGeometryEncoding(GeoRSSTransformerBase.GeometryEncoding.GML);
else
if("latlong".equals(geometryEncoding)){tx.setGeometryEncoding(GeoRSSTransformerBase.GeometryEncoding.LATLONG);
else{tx.setGeometryEncoding(GeoRSSTransformerBase.GeometryEncoding.SIMPLE);
iftheinspiregridsethasbeencorrectlyregisteredassertThat(gwc.getGridSetBroker().get(INSPIRE_GRID_SET_NAME),notNullValue());assertThat(gwc.isInternalGridSet(INSPIRE_GRID_SET_NAME),is(true));}}
if(first){first=false;
else{buff.append("&");
if(mr.getParentId()==null){assertHttpAccept(mr,MetadataRequest.ISO_METADATA);
else{assertHttpAccept(mr,MetadataRequest.OM_METADATA);
if(request.getHttpAccept()==null){request.setHttpAccept(expectedMime);
else
if(!expectedMime.equals(request.getHttpAccept())){thrownewOWS20Exception("UnexpectedvalueforhttpAccept'"+request.getHttpAccept()+"',inthiscontextitmustbe"+expectedMime,OWS20Exception.OWSExceptionCode.InvalidParameterValue,"httpAccept");
if(i!=-1){//TODO:sharecodewithGeoServerPersisterWorkspaceInfoold=(WorkspaceInfo)oldValues.get(i);
if(old!=null){WorkspaceInfows=(WorkspaceInfo)newValues.get(i);Resourcef;try{f=dir(ws).get(loader.getFilename());f.renameTo(dir(ws).get(loader.getFilename()));
if(l.getServiceClass().isInstance(service)){loader=l;break;
if(loader==null){thrownewIllegalArgumentException("Noloaderfor"+service.getName());
ifthesaveactioncan't*besuccessfullyperformed*/protectedabstractvoidonSave(WMSStoreInfoinfo,AjaxRequestTargettarget)throwsIllegalArgumentException;@OverrideprotectedComponentAuthorizergetPageAuthorizer(){returnComponentAuthorizer.WORKSPACE_ADMIN;}}
if(!actionCountByDataStore.containsKey(store)){actionCountByDataStore.put(store,newActionCount());
ifnodelay
ifconfigured**@authorAndreaAime-GeoSolutions*/publicclassRateFlowControllerimplementsFlowController{/**Thenextepocatwhichthecounterwillreset*/publicstaticfinalStringX_RATE_LIMIT_RESET="X-Rate-Limit-Reset";/**Howmanyrequestremaininthistimeslotbeforetheratelimitingoccurs*/publicstaticfinalStringX_RATE_LIMIT_REMAINING="X-Rate-Limit-Remaining";/**Howmanyrequestspertimeslotbeforetheratelimitingkicksin*/publicstaticfinalStringX_RATE_LIMIT_LIMIT="X-Rate-Limit-Limit";/**Thecontextinwhichtheratelimitingoccurs*/publicstaticfinalStringX_RATE_LIMIT_CONTEXT="X-Rate-Limit-Context";staticfinalLoggerLOGGER=Logging.getLogger(ControlFlowCallback.class);/**Theminimumnumberofcounterswehaveneedtohavearoundbeforeacleanupisinitiated*/staticintCOUNTERS_CLEANUP_THRESHOLD=Integer.parseInt(System.getProperty("org.geoserver.flow.countersCleanupThreshold","200"));/**Thecleanupintervalbeforeacleanupisinitiated*/staticintCOUNTERS_CLEANUP_INTERVAL=Integer.parseInt(System.getProperty("org.geoserver.flow.countersCleanupInterval","10000"));finalclassCounter{volatilelongtimePeriodId;AtomicIntegerrequests=newAtomicInteger(0);publicintaddRequest(longcurrPeriodId){
if(currPeriodId!=timePeriodId){synchronized(this){
if(currPeriodId!=timePeriodId){timePeriodId=currPeriodId;requests.set(0);
ifwehavegoneabovethelimitreturnrequests.incrementAndGet();
ifweshouldapplythisrequestratelimittotherequest*/Predicate<Request>matcher;intmaxRequests;longtimeInterval;longdelay;Stringaction;/**Lasttimewe'veperformedaqueuecleanup*/volatilelonglastCleanup=System.currentTimeMillis();/***BuildsaUserFlowControllerthatwilltriggerstalequeueexpirationonce100queueshave*beenaccumulatedand*/publicRateFlowController(Predicate<Request>matcher,intmaxRequests,longtimeInterval,longdelay,KeyGeneratorkeyGenerator){this.matcher=matcher;this.maxRequests=maxRequests;this.timeInterval=timeInterval;this.delay=delay;this.keyGenerator=keyGenerator;
if(delay>0){this.action="Delayexcessrequests"+delay+"ms";
else{this.action="Rejectexcessrequests";
if(!matcher.apply(request)){returntrue;
if(counter==null){userKey=canonicalizer.unique(userKey);synchronized(userKey){counter=counters.get(userKey);
if(counter==null){counter=newCounter();counters.put(userKey,counter);
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(this+",residualincurrenttimeperiod"+residual);
if(residual<0){
if(delay<=0){thrownewHttpErrorCodeException(429,"Toomanyrequestsrequestsinthecurrenttimeperiod,checkX-Rate-LimitHTTPresponseheaders");
else
if(delay>timeout){//nopointinwaitingreturnfalse;
else{
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(this+",delayingcurrentrequest");
ifnecessarylongelapsed=now-lastCleanup;
if(counters.size()>COUNTERS_CLEANUP_THRESHOLD&&(elapsed>(timeInterval)||(elapsed>10000))){intcleanupCount=0;synchronized(counters){for(Map.Entry<String,Counter>entry:counters.entrySet()){Counterc=entry.getValue();longtimePeriodId=c.getTimePeriodId();longage=(currPeriodId-timePeriodId)*timeInterval;
if(age>COUNTERS_CLEANUP_THRESHOLD){counters.remove(entry.getKey());
if(LOGGER.isLoggable(Level.FINE)){LOGGER.fine(this+",purged"+cleanupCount+"stalecounters");
ifsubclassingworks**@authorchristian*/publicclassXMLGeoserverUserextendsGeoServerUser{privatestaticfinallongserialVersionUID=1L;publicXMLGeoserverUser(Stringusername){super(username);
ifmodifiedsincethelastcalltoread.*Otherwisereturntheexistingengine.**@throwsIOException*/publicScriptEnginereadIfModified()throwsIOException{
if(isModified()){returnread();
else{returnengine;
if<code>null</code>,the*default"WFS"isused.**@paramobjectAnobjectwhichcontainsafeaturenamed"service"*@paramnodeTheparsenode.*/publicstaticvoidservice(EObjectobject,Nodenode){Stringservice=(String)node.getAttributeValue("service");
if(service==null){service="WFS";
if<code>null</code>,the*default"1.0.0"isused.**@paramobjectAnobjectwhichcontainsafeaturenamed"version"*@paramnodeTheparsenode.*/publicstaticvoidversion(EObjectobject,Nodenode){Stringversion=(String)node.getAttributeValue("version");
if(version==null){version="1.0.0";
if<code>null</code>,*thedefault<code>default</code>isused.**@paramobjectAnobjectwhichcontainsafeaturenamed"version"*@paramnodeTheparsenode.*/publicstaticvoidoutputFormat(EObjectobject,Nodenode,Stringdefalt){StringoutputFormat=(String)node.getAttributeValue("outputFormat");
if(outputFormat==null){outputFormat=defalt;
if(feature!=null){object.eSet(feature,value);
if(number==null){returnnull;
if(numberinstanceofBigInteger){return(BigInteger)number;
if(crs!=null&&!CRS.equalsIgnoreMetadata(crs,DefaultGeographicCRS.WGS84)){fc=newReprojectingFeatureCollection(fc,DefaultGeographicCRS.WGS84);
ifnone.*/protectedURLgetDefinitionsURL(){Stringcust_proj_file=System.getProperty(SYSTEM_DEFAULT_USER_PROJ_FILE);
if(cust_proj_file==null){GeoServerResourceLoaderloader=GeoServerExtensions.bean(GeoServerResourceLoader.class);
if(loader!=null){//notavailableduringconstructionSystemTestData-callCRSreset//tofixResourcecustom_proj=loader.get("user_projections/epsg.properties");
if(custom_proj.getType()==Type.RESOURCE){cust_proj_file=custom_proj.file().getAbsolutePath();
if(cust_proj_file!=null){//Attempttoloaduser-definedprojectionsFileproj_file=newFile(cust_proj_file);
if(proj_file.exists()){URLurl=URLs.fileToUrl(proj_file);
if(url!=null){returnurl;
else{LOGGER.log(Level.SEVERE,"HadtroublesconvertingfilenametoURL");
if(iteminstanceofResource){return((Resource)item).getType()!=Type.UNDEFINED;
if(GeoServerSecuredPage.class.isAssignableFrom(componentClass)){returnsuper.isAccessAllowed(componentClass,authentication);
if(jsonp){returnJSONType.JSONP.getMimeType();
else{returnJSONType.JSON.getMimeType();
iftheresultsfeaturecollectionscontaincomplexfeatures.*/protectedstaticbooleanisComplexFeature(FeatureCollectionResponseresults){for(FeatureCollectionfeatureCollection:results.getFeatures()){
if(!(featureCollection.getSchema()instanceofSimpleFeatureType)){//thisfeaturecollectioncontainscomplexfeaturesreturntrue;
if(LOGGER.isLoggable(Level.INFO))LOGGER.info("abouttoencodeJSON");//preparetowriteoutOutputStreamWriterosw=null;WriteroutWriter=null;//getfeaturecountforrequestBigIntegertotalNumberOfFeatures=featureCollection.getTotalNumberOfFeatures();BigIntegerfeatureCount=(totalNumberOfFeatures!=null&&totalNumberOfFeatures.longValue()<0)?null:totalNumberOfFeatures;try{osw=newOutputStreamWriter(output,gs.getGlobal().getSettings().getCharset());outWriter=newBufferedWriter(osw);
if(jsonp){outWriter.write(getCallbackFunction()+"(");
if(featureCount!=null&&isComplex&&featureCount.equals(BigInteger.ZERO)){//azerocountwhendealingwithcomplexfeaturesmeansthatfeaturescountisnot//supportedfeatureCount=null;
ifgeometryexistsfinalGeoJSONBuilderjsonWriter=getGeoJSONBuilder(featureCollection,outWriter);jsonWriter.object().key("type").value("FeatureCollection");jsonWriter.key("features");jsonWriter.array();List<FeatureCollection>resultsList=featureCollection.getFeature();FeaturesInfofeaturesInfo=writeFeatures(resultsList,operation,isComplex,jsonWriter);jsonWriter.endArray();//endfeaturesbooleanhasGeom=featuresInfo.hasGeometry;CoordinateReferenceSystemcrs=featuresInfo.crs;longnumberReturned=featuresInfo.featureCount;//writethesetofcollectionwideinformationswriteCollectionCounts(featureCount,numberReturned,jsonWriter);writeCollectionTimeStamp(jsonWriter);writePagingLinks(featureCollection,operation,jsonWriter);writeCollectionCRS(jsonWriter,crs);writeCollectionBounds(isFeatureBounding(),jsonWriter,resultsList,hasGeom);writeExtraCollectionProperties(featureCollection,operation,jsonWriter);jsonWriter.endObject();//endfeaturecollection
if(jsonp){outWriter.write(")");
if(!isComplex){featuresInfo=encodeSimpleFeatures(jsonWriter,resultsList,isFeatureBounding(),operation);
else{//encodecollectionwithcomplexfeaturesComplexGeoJsonWritercomplexWriter=newComplexGeoJsonWriter(jsonWriter){@OverrideprotectedvoidencodeFeature(Featurefeature){super.encodeFeature(feature);writeExtraFeatureProperties(feature,operation,jsonWriter);
if(featureCount!=null){jsonWriter.key("totalFeatures").value(featureCount);//WFS3suggestednameforthesameconceptastotalFeaturesjsonWriter.key("numberMatched").value(featureCount);
else{jsonWriter.key("totalFeatures").value("unknown");//inWFS3thesuggestionisnottoincludetheelement
if(hasGeom&&featureBounding){ReferencedEnvelopee=null;for(inti=0;i<resultsList.size();i++){FeatureCollectioncollection=resultsList.get(i);
if(e==null){e=collection.getBounds();
else{e.expandToInclude(collection.getBounds());
if(e!=null){jsonWriter.setAxisOrder(CRS.getAxisOrder(e.getCoordinateReferenceSystem()));jsonWriter.writeBoundingBox(e);
if("true".equals(GeoServerExtensions.getProperty("GEOSERVER_GEOJSON_LEGACY_CRS"))){//Thisiswrong,butGeoServerusedtodoitthisway.writeCrsLegacy(jsonWriter,crs);
else{writeCrs(jsonWriter,crs);
if(response.getPrevious()!=null||response.getNext()!=null){jw.key("links");jw.array();StringmimeType=getMimeType(response,operation);writeLink(jw,"previouspage",mimeType,"previous",response.getPrevious());writeLink(jw,"nextpage",mimeType,"next",response.getNext());jw.endArray();
if(href!=null){jw.object();jw.key("title").value(title);jw.key("type").value(mimeType);jw.key("rel").value(rel);jw.key("href").value(href);jw.endObject();
if(id_option==null){//nospecificattributenominated,usethesimplefeatureidjsonWriter.key("id").value(simpleFeature.getID());
else
if(id_option.length()!=0){//aspecificattributewasnominatedtobeusedasidObjectvalue=simpleFeature.getAttribute(id_option);jsonWriter.key("id").value(value);
if(defaultGeomType!=null){CoordinateReferenceSystemfeatureCrs=defaultGeomType.getCoordinateReferenceSystem();jsonWriter.setAxisOrder(CRS.getAxisOrder(featureCrs));
if(crs==null){crs=featureCrs;
else{//Ifwedon'tknow,assumeEAST_NORTHsothatnoswappingoccursjsonWriter.setAxisOrder(CRS.AxisOrder.EAST_NORTH);
if(aGeom!=null){jsonWriter.writeGeom(aGeom);hasGeom=true;
else{jsonWriter.value(null);
if(defaultGeomType!=null){jsonWriter.key("geometry_name").value(defaultGeomType.getLocalName());
if(id_option!=null&&id_option.equals(ad.getLocalName())){continue;//skipthisvalueasitisusedastheid
if(adinstanceofGeometryDescriptor){//Thisisanareaofthespecwherethey//decidedto'letconventionevolve',//thatishowtohandlemultiple//geometries.Mytakeistoprintthe//geometryhere
ifit'snotthedefault.//Ifit'sthedefaultthatyoualready//printedabove,soyoudon'tneedithere.
if(ad.equals(defaultGeomType)){//Donothing,wewroteitabove//jsonWriter.value("geometry_name");
else
if(value==null){jsonWriter.key(ad.getLocalName());jsonWriter.value(null);
else{jsonWriter.key(ad.getLocalName());jsonWriter.writeGeom((Geometry)value);
else{jsonWriter.key(ad.getLocalName());jsonWriter.value(value);
if(featureBounding&&!refenv.isEmpty()){jsonWriter.writeBoundingBox(refenv);
if(request!=null){id_option=JSONType.getIdPolicy(request.getKvp());
if(crs!=null){Stringidentifier=null;Integercode=CRS.lookupEpsgCode(crs,true);
if(code!=null){
if(code!=null){identifier=SrsSyntax.OGC_URN.getPrefix()+code;
else{identifier=CRS.lookupIdentifier(crs,true);
else{jsonWriter.key("crs");jsonWriter.value(null);
ifthenamespaceis//EPSG
if(crs!=null){Set<ReferenceIdentifier>ids=crs.getIdentifiers();//WKTdefinedcrsmightnothaveidentifiersatall
if(ids!=null&&ids.size()>0){NamedIdentifiernamedIdent=(NamedIdentifier)ids.iterator().next();StringcsStr=namedIdent.getCodeSpace().toUpperCase();
if(csStr.equals("EPSG")){jsonWriter.key("crs");jsonWriter.object();jsonWriter.key("type").value(csStr);jsonWriter.key("properties");jsonWriter.object();jsonWriter.key("code");jsonWriter.value(namedIdent.getCode());jsonWriter.endObject();//endpropertiesjsonWriter.endObject();//endcrs
if(request==null){returnJSONType.CALLBACK_FUNCTION;
iftheEOextensionisenabled*/privateGeoServergeoserver;publicGranuleCoverageExtension(GeoServergeoServer,EOCoverageResourceCodeccodec){this.codec=codec;this.geoserver=geoServer;
if(isEOEnabled()){CoverageInfogranuleCoverage=codec.getGranuleCoverage(coverageId);
if(granuleCoverage!=null&&codec.isValidDataset(granuleCoverage)){returngetCoverageId(coverageId);
if(isEOEnabled()){CoverageInfogranuleCoverage=codec.getGranuleCoverage(coverageId);
if(granuleCoverage!=null&&codec.isValidDataset(granuleCoverage)){returncodec.getGranuleId(granuleCoverage,getGranuleId(coverageId));
if(isEOEnabled()){
if(codec.getGranuleCoverage(coverageId)!=null&&codec.isValidDataset(ci)){SimpleFeatureIteratorit=null;try{//GettingthestructuredcoveragereaderStructuredGridCoverage2DReaderreader=(StructuredGridCoverage2DReader)ci.getGridCoverageReader(null,GeoTools.getDefaultHints());Stringname;//Gettingthecoveragenamename=codec.getCoverageName(ci);//QuerythereaderGranuleSourcesource=reader.getGranules(name,true);Queryq=newQuery();SimpleFeatureCollectioncollection=source.getGranules(q);//createaGranuleCoverageInfoobjectforthesinglegranule
if(!collection.isEmpty()){List<DimensionDescriptor>descriptors=getActiveDimensionDescriptor(ci,reader,name);it=collection.features();
if(it.hasNext()){SimpleFeaturefeature=it.next();info=newGranuleCoverageInfo(ci,feature,descriptors);
if(info==null){
if(LOGGER.isLoggable(Level.FINE)){LOGGER.log(Level.FINE,"NogranulefoundforthegranuleId:"+getGranuleId(coverageId));
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.log(Level.SEVERE,e.getMessage(),e);
if(it!=null){try{it.close();
if(LOGGER.isLoggable(Level.SEVERE)){LOGGER.log(Level.SEVERE,e.getMessage(),e);
if(info==null){info=ci;
iftheEOextensionisenabledglobally**@returntrue
iftheEOextensionisenabled*/publicbooleanisEOEnabled(){WCSInfowcs=geoserver.getService(WCSInfo.class);Booleanenabled=wcs.getMetadata().get(WCSEOMetadata.ENABLED.key,Boolean.class);returnBoolean.TRUE.equals(enabled);
ifthesyntaxis*incorrect**@returnthecoverageIdrelatedtothefollowingcoverageIdparameter(withthe_granule_*extension)*/publicStringgetCoverageId(StringcoverageId){//doesithavetheexpectedlexicalstructure?
if(!coverageId.contains(GRANULE_SEPARATOR)){returnnull;
if(splitted.length!=2){returnnull;
else{returnsplitted[0];
ifthesyntaxis*incorrect**@returnthecoverageIdrelatedtothefollowingcoverageIdparameter(withthe_granule_*extension)*/publicStringgetGranuleId(StringcoverageId){//doesithavetheexpectedlexicalstructure?
if(!coverageId.contains(GRANULE_SEPARATOR)){returnnull;
if(splitted.length!=2){returnnull;
else{returnsplitted[1];
if(entry.getValue()instanceofDimensionInfo){DimensionInfodi=(DimensionInfo)entry.getValue();
if(di.isEnabled()){StringdimensionName=entry.getKey();
if(dimensionName.startsWith(ResourceInfo.CUSTOM_DIMENSION_PREFIX)){dimensionName=dimensionName.substring(ResourceInfo.CUSTOM_DIMENSION_PREFIX.length());
if(selected!=null){enabledDescriptors.add(selected);
ifyou//don'thandleuom,youdon'tgettoknowthatStringurl="wms?REQUEST=GetFeatureInfo"+"&BBOX=0.000196%2C0.000696%2C0.000204%2C0.000704&SERVICE=WMS"+"&INFO_FORMAT=application/json&QUERY_LAYERS=cite%3ABridges&FEATURE_COUNT=50"+"&Layers=cite%3ABridges&WIDTH=100&HEIGHT=100&format=image%2Fpng"+"&styles=symbol-uom&srs=EPSG%3A4326&version=1.1.1&x=49&y=60&feature_count=50";VectorRenderingLayerIdentifier.RENDERING_FEATUREINFO_ENABLED=true;JSONObjectresult=(JSONObject)getAsJSON(url);//print(result2);assertEquals(1,result.getJSONArray("features").size());
ifthestringrepresentedcoordinatescorrespondtotheexpected*ones.Theprovidedprecisionwillbeusedtocomparethenumericvalues.*/privatevoidcheckCoordinates(StringrawCoordinates,doubleprecision,double...expected){assertThat(rawCoordinates,notNullValue());rawCoordinates=rawCoordinates.trim();String[]coordinates=rawCoordinates.split("\\s");assertThat(coordinates.length,is(expected.length));for(inti=0;i<coordinates.length;i++){checkNumberSimilar(coordinates[i],expected[i],precision);
if(manager==null){DataAccessManagerdaManager=lookupDataAccessManager();
if(daManager==null){manager=buildDefaultResourceAccessManager();
else{manager=newDataAccessManagerAdapter(daManager);
if(manager!=null&&managerinstanceofDataAccessManagerWrapper){((DataAccessManagerWrapper)manager).setDelegate(buildDefaultResourceAccessManager());
if(infoinstanceofWorkspaceInfo){return(T)checkAccess(user,(WorkspaceInfo)info,mixedModeBehavior);
if(infoinstanceofNamespaceInfo){return(T)checkAccess(user,(NamespaceInfo)info,mixedModeBehavior);
if(infoinstanceofStoreInfo){return(T)checkAccess(user,(StoreInfo)info,mixedModeBehavior);
if(infoinstanceofResourceInfo){return(T)checkAccess(user,(ResourceInfo)info,mixedModeBehavior);
if(infoinstanceofLayerInfo){return(T)checkAccess(user,(LayerInfo)info,mixedModeBehavior,Collections.emptyList());
if(infoinstanceofLayerGroupInfo){return(T)checkAccess(user,(LayerGroupInfo)info,mixedModeBehavior,Collections.emptyList());
if(infoinstanceofLayerInfo){return(T)checkAccess(user,(LayerInfo)info,mixedModeBehavior,containers);
if(infoinstanceofLayerGroupInfo){return(T)checkAccess(user,(LayerGroupInfo)info,mixedModeBehavior,containers);
iftheusercanaccessitin*writemode,makesitreadonly
iftheusercanaccessitinreadonlymode,returnsnull*otherwise*/protected<TextendsResourceInfo>TcheckAccess(Authenticationuser,Tinfo,MixedModeBehaviormixedModeBehavior){//handlenullcase
if(info==null)returnnull;//firstoff,handlethecasewheretheusercannotevenreadthedataWrapperPolicypolicy=buildWrapperPolicy(user,info,info.getName(),mixedModeBehavior);//handlethemodesthatdonotrequirewrapping
if(policy.level==AccessLevel.HIDDEN)returnnull;
else
if(policy.level==AccessLevel.READ_WRITE&&policy.getLimits()==null)returninfo;//otherwiseweareinamixedcasewheretheusercanreadbutnotwrite,or//cannotreadbutisallowedbytheoperationmodetoaccessthemetadatareturn(T)SecuredObjects.secure(info,policy);
iftheusercanaccessit.**@return<code>null</code>
iftheusercan'tacessthestyle,otherwisetheoriginalstyle.*/protectedStyleInfocheckAccess(Authenticationuser,StyleInfostyle,MixedModeBehaviormixedModeBehavior){
if(style==null)returnnull;WrapperPolicypolicy=buildWrapperPolicy(user,style,style.getName(),mixedModeBehavior);//
ifwedon'tneedtohideit,thenwecanreturnitasissinceit//canonlyprovidemetadata.
if(policy.level==AccessLevel.HIDDEN)returnnull;
elsereturnstyle;
iftheusercanaccessitsworkspaceinreadmode,*nullotherwise*/protected<TextendsStoreInfo>TcheckAccess(Authenticationuser,Tstore,MixedModeBehaviormixedModeBehavior){
if(store==null)returnnull;WrapperPolicypolicy=buildWrapperPolicy(user,store.getWorkspace(),store.getName(),mixedModeBehavior);//handlethemodesthatdonotrequirewrapping
if(policy.level==AccessLevel.HIDDEN)returnnull;
else
if(policy.level==AccessLevel.READ_WRITE||(policy.level==AccessLevel.READ_ONLY&&storeinstanceofCoverageStoreInfo))returnstore;//otherwiseweareinamixedcasewheretheusercanreadbutnot//write,or//cannotreadbutisallowedbytheoperationmodetoaccessthe//metadata
if(storeinstanceofDataStoreInfo||storeinstanceofCoverageStoreInfo||storeinstanceofWMSStoreInfo||storeinstanceofWMTSStoreInfo){return(T)SecuredObjects.secure(store,policy);
else{thrownewRuntimeException("Unknownstoretype"+store.getClass());
iftheusercanaccessit,nullotherwise*/protectedLayerInfocheckAccess(Authenticationuser,LayerInfolayer,MixedModeBehaviormixedModeBehavior,List<LayerGroupInfo>containers){
if(layer==null)returnnull;//firstoff,handlethecasewheretheusercannotevenreadthedataWrapperPolicypolicy=buildWrapperPolicy(user,layer,layer.getName(),mixedModeBehavior,containers);//handlethemodesthatdonotrequirewrapping
if(policy.level==AccessLevel.HIDDEN)returnnull;
else
if(policy.level==AccessLevel.READ_WRITE&&policy.getLimits()==null)returnlayer;//otherwiseweareinamixedcasewheretheusercanreadbutnotwrite,or//cannotreadbutisallowedbytheoperationmodetoaccessthemetadatareturn(LayerInfo)SecuredObjects.secure(layer,policy);
iftheusercanaccessit,nullotherwise*/protectedLayerGroupInfocheckAccess(Authenticationuser,LayerGroupInfogroup,MixedModeBehaviormixedModeBehavior,List<LayerGroupInfo>containers){
if(group==null)returnnull;//firstcheckthelayergroupitselfWrapperPolicypolicy=buildWrapperPolicy(user,group,group.getName(),mixedModeBehavior,containers);
if(policy.level==AccessLevel.HIDDEN){returnnull;
if(LayerGroupInfo.Mode.EO.equals(group.getMode())){//
iftherootcannotbeused,blowupwithanerrorinmixedmoderootLayer=checkAccess(user,rootLayer,MixedModeBehavior.CHALLENGE);
if(rootLayer==null){returnnull;
if(checked!=null){wrapped.add(checked);selectedStyles.add(style);
else
if(layer==null){StyleInfostyleGroup=checkAccess(user,style,MixedModeBehavior.HIDE);
if(styleGroup!=null){wrapped.add(null);selectedStyles.add(styleGroup);
iftheusercanaccessit,nullotherwise*/protected<TextendsNamespaceInfo>TcheckAccess(Authenticationuser,Tns,MixedModeBehaviormixedModeBehavior){
if(ns==null)returnnull;//routethesecuritycheckthrutheassociatedworkspaceinfoWorkspaceInfows=delegate.getWorkspaceByName(ns.getPrefix());
if(ws==null){//temporaryworkaround,buildafakeworkspace,aswe'reprobably//inbetweenachangeofworkspace/namespacenamews=delegate.getFactory().createWorkspace();ws.setName(ns.getPrefix());
if(info==null)returnnull;
elsereturnns;
iftheusercanaccessit,nullotherwise*/protected<TextendsWorkspaceInfo>TcheckAccess(Authenticationuser,Tws,MixedModeBehaviormixedModeBehavior){
if(ws==null)returnnull;WrapperPolicypolicy=buildWrapperPolicy(user,ws,ws.getName(),mixedModeBehavior);//
ifwedon'tneedtohideit,thenwecanreturnitasissinceit//canonlyprovidemetadata.
if(policy.level==AccessLevel.HIDDEN)returnnull;
elsereturnws;
if(infoinstanceofNamespaceInfo){//routethesecuritycheckthrutheassociatedworkspaceinfoWorkspaceInfows=delegate.getWorkspaceByName(((NamespaceInfo)info).getPrefix());
if(ws==null){//temporaryworkaround,buildafakeworkspace,aswe're//probably//inbetweenachangeofworkspace/namespacenamews=delegate.getFactory().createWorkspace();ws.setName(((NamespaceInfo)info).getPrefix());
if(infoinstanceofWorkspaceInfo){returnbuildWrapperPolicy(accessManager,user,info,((WorkspaceInfo)info).getName(),mixedModeBehavior);
if(infoinstanceofStoreInfo){returnbuildWrapperPolicy(accessManager,user,((StoreInfo)info).getWorkspace(),((StoreInfo)info).getName(),mixedModeBehavior);
if(infoinstanceofResourceInfo){returnbuildWrapperPolicy(accessManager,user,info,((ResourceInfo)info).getName(),mixedModeBehavior);
if(infoinstanceofLayerInfo){returnbuildWrapperPolicy(accessManager,user,info,((LayerInfo)info).getName(),mixedModeBehavior);
if(infoinstanceofLayerGroupInfo){//returnthemostrestrictivepolicythat'snotHIDDEN,orthe//firstHIDDENoneWrapperPolicymostRestrictive=WrapperPolicy.readWrite(null);for(PublishedInfolayer:((LayerGroupInfo)info).getLayers()){WrapperPolicypolicy=buildWrapperPolicy(accessManager,user,layer,layer.getName(),mixedModeBehavior);
if(AccessLevel.HIDDEN.equals(policy.getAccessLevel())){returnpolicy;
if(thisOneIsMoreRestrictive){mostRestrictive=policy;
else
if(infoinstanceofStyleInfo){returnbuildWrapperPolicy(accessManager,user,info,((StyleInfo)info).getName(),mixedModeBehavior);
if(infoinstanceofWorkspaceInfo){//unsurehere...shallwedisallowwriting?Onlycatalogandconfig//relatedcodeshouldbeplayingwithstoresdirectly,soit'smoreofa//matter
ifyoucanadminaworkspaceornotlimits=accessManager.getAccessLimits(user,(WorkspaceInfo)info);WorkspaceAccessLimitswl=(WorkspaceAccessLimits)limits;
if(wl!=null){
if(wl.isAdminable()){canRead=canWrite=true;
else{canRead=wl.isReadable();canWrite=wl.isWritable();
if(AdminRequest.get()!=null){//adminrequest
if(wl==null||!wl.isAdminable()){canRead=canWrite=false;
else
if(infoinstanceofLayerInfo||infoinstanceofResourceInfo){DataAccessLimitsdl;WorkspaceAccessLimitswl;
if(infoinstanceofLayerInfo){dl=accessManager.getAccessLimits(user,(LayerInfo)info,containers);wl=accessManager.getAccessLimits(user,((LayerInfo)info).getResource().getStore().getWorkspace());
else{dl=accessManager.getAccessLimits(user,(ResourceInfo)info);wl=accessManager.getAccessLimits(user,((ResourceInfo)info).getStore().getWorkspace());
if(dl!=null){canRead=dl.getReadFilter()!=Filter.EXCLUDE;
if(dlinstanceofVectorAccessLimits){canWrite=((VectorAccessLimits)dl).getWriteFilter()!=Filter.EXCLUDE;
else{canWrite=false;
if(AdminRequest.get()!=null){
if(wl!=null&&!wl.isAdminable()){canRead=false;
else
if(infoinstanceofStyleInfo||infoinstanceofLayerGroupInfo){WorkspaceInfows=null;
if(infoinstanceofStyleInfo){limits=accessManager.getAccessLimits(user,(StyleInfo)info);ws=((StyleInfo)info).getWorkspace();
else{limits=accessManager.getAccessLimits(user,(LayerGroupInfo)info,containers);ws=((LayerGroupInfo)info).getWorkspace();
if(limits!=null){canRead=false;
if(ws!=null&&AdminRequest.get()!=null){WorkspaceAccessLimitswl=accessManager.getAccessLimits(user,ws);
if(wl!=null){
if(!wl.isAdminable()){canRead=false;
else{thrownewIllegalArgumentException("Can'tbuildthewrapperpolicyforobjects"+"otherthanworkspace,layerorresource:"+info);
if(!canRead){//
ifinhidemode,wejusthidetheresource
if(mode==CatalogMode.HIDE){returnWrapperPolicy.hide(limits);
else
if(mode==CatalogMode.MIXED){//
ifrequestisagetcapabilitiesandmixed,wehideagain
if(mixedModeBehavior==MixedModeBehavior.HIDE){returnWrapperPolicy.hide(limits);
else{//otherwisechallengetheuserforcredentialsthrowunauthorizedAccess(resourceName);
else{//forchallengemodeweagreetoshowfreelyonlythemetadata,every//otheraccesswilltriggerasecurityexceptionreturnWrapperPolicy.metadata(limits);
else
if(!canWrite){
if(mode==CatalogMode.HIDE){returnWrapperPolicy.readOnlyHide(limits);
else{returnWrapperPolicy.readOnlyChallenge(limits);
if(user==null||user.getAuthorities().size()==0)returnnewInsufficientAuthenticationException("Cannotaccess"+resourceName+"asanonymous");
elsereturnnewAccessDeniedException("Cannotaccess"+resourceName+"withthecurrentprivileges");
if(user==null||user.getAuthorities().size()==0)returnnewInsufficientAuthenticationException("Operationunallowedwiththecurrentprivileges");
elsereturnnewAccessDeniedException("Operationunallowedwiththecurrentprivileges");
if(secured!=null)result.add(secured);
if(secured!=null)result.add(secured);
if(secured!=null)result.add(secured);
if(secured!=null)result.add(secured);
if(secured!=null)result.add(secured);
if(secured!=null)result.add(secured);
if(secured!=null)result.add(secured);
if(layerGroupinstanceofSecuredLayerGroupInfo)return((SecuredLayerGroupInfo)layerGroup).unwrap(LayerGroupInfo.class);returnlayerGroup;
if(layerinstanceofSecuredLayerInfo)return((SecuredLayerInfo)layer).unwrap(LayerInfo.class);returnlayer;
if(infoinstanceofSecuredFeatureTypeInfo)return((SecuredFeatureTypeInfo)info).unwrap(ResourceInfo.class);
if(infoinstanceofSecuredCoverageInfo)return((SecuredCoverageInfo)info).unwrap(ResourceInfo.class);
if(infoinstanceofSecuredWMSLayerInfo)return((SecuredWMSLayerInfo)info).unwrap(ResourceInfo.class);
if(infoinstanceofSecuredWMTSLayerInfo)return((SecuredWMTSLayerInfo)info).unwrap(ResourceInfo.class);returninfo;
if(infoinstanceofSecuredDataStoreInfo)return((SecuredDataStoreInfo)info).unwrap(StoreInfo.class);
if(infoinstanceofSecuredCoverageStoreInfo)return((SecuredCoverageStoreInfo)info).unwrap(StoreInfo.class);
if(infoinstanceofSecuredWMSStoreInfo)return((SecuredWMSStoreInfo)info).unwrap(StoreInfo.class);
if(infoinstanceofSecuredWMTSStoreInfo)return((SecuredWMTSStoreInfo)info).unwrap(StoreInfo.class);returninfo;
if(objinstanceofLayerGroupInfo){returnunwrap((LayerGroupInfo)obj);
if(objinstanceofLayerInfo){returnunwrap((LayerInfo)obj);
if(objinstanceofResourceInfo){returnunwrap((ResourceInfo)obj);
if(objinstanceofStoreInfo){returnunwrap((StoreInfo)obj);
if(objinstanceofSecureCatalogImpl){return((SecureCatalogImpl)obj).delegate;
ifany.Itcalls{@link*#buildWrapperPolicy(Authentication,CatalogInfo)}tocheck
ifthereturnedaccesslevelis*not"hidden"onacasebycasebasis.Perhaps,thecheckforwhetheragivenresourceis*accessibletothecurrentusercanbeencodedasa"wellknown"predicatethatusesoneora*combinationofthepropertyequals/isnull/contains/existsverbsinthe{@linkPredicates}*utility.I(GR),atthetimeofwriting,don'tknowhowtodothat,soanyhelpwouldbemuch*appreciated.Nonetheless,thispredicateismeanttobe"and'ed"withanyotherpredicate*thiscatalogwrapperiscalledwith,givingtheCatalogbackendachancetoatleastencode*the"wellknown"partoftheresultingfilter,andseparateoutthein-processevaluationof*accesscredentialsfromtheconstructionofthesecuritywrapperforeachobject.**@returnacatalogPredicatethatevaluates
ifanobjectoftherequiredtypeisaccessibleto*thegivenuser*/private<TextendsCatalogInfo>FiltersecurityFilter(finalClass<T>infoType,finalFilterfilter){finalAuthenticationuser=user();
if(isAdmin(user)){//noneedtocheckforcredentials
ifuseris_the_administratorreturnfilter;
if(MapInfo.class.isAssignableFrom(infoType)){//thesekindofobjectsarenotsecuredreturnfilter;
ifthecurrentuserisauthenticatedandistheadministrator.Protectedtoallow*overridingintests.*/protectedbooleanisAdmin(Authenticationauthentication){returnGeoServerExtensions.bean(GeoServerSecurityManager.class).checkAuthenticationForAdminRole(authentication);
if(tile.getZ()>=0&&tile.getEnvelope().contains(request.getBbox())){normalizedEnvelope=tile.getEnvelope();
else{normalizedEnvelope=KmlEncodingContext.WORLD_BOUNDS_WGS84;
if(cachedMode&&isRequestGWCCompatible(request,i,wms)){encodeGWCLink(container,request,layer);
else{encodeLayerSuperOverlay(container,layer,i,normalizedEnvelope,zoomLevel);
if(layerInfo.getDescription()!=null&&layerInfo.getDescription().length()>0){folder.setDescription(layerInfo.getDescription());
if(formatOptions.get(VISIBLE_KEY)!=null){booleanvisible=Boolean.parseBoolean(formatOptions.get(VISIBLE_KEY).toString());folder.setVisibility(visible);
else{folder.setVisibility(true);
if(bounds!=null){LookAtDecoratorFactorylookAtFactory=newLookAtDecoratorFactory();ReferencedEnvelopelayerBounds=layer.getBounds();CoordinateReferenceSystemlayerCRS=layerBounds.getCoordinateReferenceSystem();
if(layerCRS!=null&&!CRS.equalsIgnoreMetadata(layerCRS,DefaultGeographicCRS.WGS84)){try{layerBounds=layerBounds.transform(DefaultGeographicCRS.WGS84,true);
if(top!=KmlEncodingContext.WORLD_BOUNDS_WGS84){//topleftEnvelopee00=newEnvelope(top.getMinX(),top.getMinX()+(top.getWidth()/2d),top.getMaxY()-(top.getHeight()/2d),top.getMaxY());//toprightEnvelopee01=newEnvelope(e00.getMaxX(),top.getMaxX(),e00.getMinY(),e00.getMaxY());//bottomleftEnvelopee10=newEnvelope(e00.getMinX(),e00.getMaxX(),top.getMinY(),e00.getMinY());//bottomrightEnvelopee11=newEnvelope(e01.getMinX(),e01.getMaxX(),e10.getMinY(),e10.getMaxY());addNetworkLink(folder,e00,"00",layer);addNetworkLink(folder,e01,"01",layer);addNetworkLink(folder,e10,"10",layer);addNetworkLink(folder,e11,"11",layer);
else{//divideuphorizontallybytwoEnvelopee0=newEnvelope(top.getMinX(),top.getMinX()+(top.getWidth()/2d),top.getMinY(),top.getMaxY());Envelopee1=newEnvelope(e0.getMaxX(),top.getMaxX(),top.getMinY(),top.getMaxY());addNetworkLink(folder,e0,"0",layer);addNetworkLink(folder,e1,"1",layer);
if(top==KmlEncodingContext.WORLD_BOUNDS_WGS84){//specialcasefortopsinceitdoesnotlineupasaproper//tile->splititintwoencodeTileContents(folder,layer,"contents-0",zoomLevel,newEnvelope(-180,0,-90,90));encodeTileContents(folder,layer,"contents-1",zoomLevel,newEnvelope(0,180,-90,90));
else{//encodestraightupencodeTileContents(folder,layer,"contents",zoomLevel,top);
ifwearegoingtogetanyfeaturefromthislayerStringoverlayMode=context.getSuperOverlayMode();
if(!"raster".equals(overlayMode)&&layerinstanceofFeatureLayer&&!shouldDrawVectorLayer(layer,box)){return;
if(shouldDrawVectorLayer(layer,box))encodeKMLLink(container,layer,name,drawOrder,box);
if(shouldDrawWMSOverlay(layer,box))encodeGroundOverlay(container,layer,drawOrder,box);
ifthelayerisavectorlayer,andbasedonmode//full:yes,
ifanyregionatedvectorsarepresentatthiszoomlevel//hybrid:yes,
ifanyregionatedvectorsarepresentatthiszoomlevel//overview:isthenon-regionatedfeaturecountforthistilebelowthecutoff?//raster:no
if(!isVectorLayer(layer))returnfalse;StringoverlayMode=context.getSuperOverlayMode();
if("raster".equals(overlayMode))returnfalse;
if("overview".equals(overlayMode)){intfeatureCount=featuresInTile(layer,box,false);returnfeatureCount<=getRegionateFeatureLimit(getFeatureTypeInfo(layer));
if(!isVectorLayer(layer))returntrue;StringoverlayMode=context.getSuperOverlayMode();
if("hybrid".equals(overlayMode)||"raster".equals(overlayMode))returntrue;
if("overview".equals(overlayMode))returnfeaturesInTile(layer,box,false)>getRegionateFeatureLimit(getFeatureTypeInfo(layer));returnfalse;
if("overview".equalsIgnoreCase(overlayMode)){//overviewmode,turnoffregionationfo.remove("regionateBy");
else{//specifyregionateBy=auto
ifnotspecified
if(!fo.containsKey("regionateBy")){fo.put("regionateBy","auto");
if(info.getName().equals(layer.getTitle()))returninfo.getFeature();returnnull;
if(!isVectorLayer(layer))return1;//forcoverages,wewantrastertileseverywhereEnvelopeoriginalBounds=mapContent.getRequest().getBbox();mapContent.getRequest().setBbox(bounds);mapContent.getViewport().setBounds(newReferencedEnvelope(bounds,DefaultGeographicCRS.WGS84));StringoriginalRegionateBy=null;
if(regionate){originalRegionateBy=(String)mapContent.getRequest().getFormatOptions().get("regionateby");
if(originalRegionateBy==null)mapContent.getRequest().getFormatOptions().put("regionateby","auto");
if(e.getErrorCode()==204){throwe;
else{LOGGER.log(Level.WARNING,"Failurewhilecheckingwhetheraregionatedchildtile"+"containedfeatures!",e);
if(regionate&&originalRegionateBy==null){mapContent.getRequest().getFormatOptions().remove("regionateby");
iftherequestisGWCcompatible**@parammapContent*/@SuppressWarnings("unchecked")privatebooleanisRequestGWCCompatible(GetMapRequestrequest,intlayerIndex,WMSwms){//checkthekmlparamsarethesameasthedefaults(GWCusesalwaysthedefaults)booleanrequestKmAttr=context.isDescriptionEnabled();
if(requestKmAttr!=wms.getKmlKmAttr()){returnfalse;
if(requestKmplacemark!=wms.getKmlPlacemark()){returnfalse;
if(requestKmscore!=wms.getKmScore()){returnfalse;
if(request.getLayers().get(layerIndex).getType()==MapLayerInfo.TYPE_REMOTE_VECTOR){returnfalse;
if(!defaultStyle.equals(requestedStyle)){returnfalse;
if(filters!=null&&filters.size()>0&&filters.get(layerIndex)!=Filter.INCLUDE){returnfalse;
if(sortBy!=null&&sortBy.size()>0){returnfalse;
if(antialias!=null&&!"FULL".equalsIgnoreCase(antialias)){returnfalse;
if(request.getPalette()!=null){returnfalse;
if(request.getStartIndex()!=null&&request.getStartIndex()!=0){returnfalse;
if(request.getMaxFeatures()!=null){returnfalse;
if(request.getViewParams()!=null&&request.getViewParams().size()>0){returnfalse;
if(appDir==null){thrownewRestException(format("Nosuchapp%s",app),HttpStatus.NOT_FOUND);
if(script==null){thrownewRestException(format("Nomainfileforapp%s",app),HttpStatus.NOT_FOUND);
if(eng==null){thrownewRestException(format("Scriptenginefor%snotfound",script.name()),HttpStatus.BAD_REQUEST);
if(hook==null){//TODO:fallbackondefaultthrownewRestException(format("Nohookfoundfor%s",script.path()),HttpStatus.INTERNAL_SERVER_ERROR);
if"Selected"isnotillustrativeenough*/protectedStringgetSelectedHeaderPropertyKey(){return"PaletteFormComponent.selectedHeader";
if"Available"isnotillustrativeenough*/protectedStringgetAvaliableHeaderPropertyKey(){return"PaletteFormComponent.availableHeader";
if(palette.getRecorderComponent()==null){//stageforthemforlatertoAdd.addAll(Arrays.asList(behaviors));
else{//addthemnowpalette.getRecorderComponent().add(behaviors);
if(GeogigLayerIntegrationListener.AUTHORITY_URL_NAME.equals(auth.getName())){expected=auth;break;
if(GeogigLayerIntegrationListener.AUTHORITY_URL_NAME.equals(idinfo.getAuthority())){expected=idinfo;
if(params.containsKey(GeoGigDataStoreFactory.BRANCH.key)){Stringbranch=(String)params.get(GeoGigDataStoreFactory.BRANCH.key);expectedId+=":"+branch;
else
if(params.containsKey(GeoGigDataStoreFactory.HEAD.key)){Stringhead=(String)params.get(GeoGigDataStoreFactory.HEAD.key);expectedId+=":"+head;
if(value.getClass().isAssignableFrom(super.getBinding())){returnmime;
if(str==null){returnnull;
if(len==0){returnEMPTY_STRING_ARRAY;
if(str.charAt(i)=='"'){i++;while(i<len){
if(str.charAt(i)=='"'){i++;break;
if(str.charAt(i)==separatorChar){
if(match){list.add(str.substring(start,i));match=false;
if(match){list.add(str.substring(start,i));
ifthepasswordargumentisalreadyencodedinthecorrect*format.False
ifitisplaintext.*@paramusernametheuser'sloginname.*@paramrealmthenameoftherealm.*@parampasswordtheuser'spasswordinplaintextorready-encoded.*@paramhttpMethodtheHTTPrequestmethod(GET,POSTetc.)*@paramuritherequestURI.*@paramqoptheqopdirective,ornull
ifnotset.*@paramnoncethenoncesuppliedbytheserver*@paramncthe"nonce-count"asdefinedinRFC2617.*@paramcnonceopaquestringsuppliedbytheclientwhenqopisset.*@returntheMD5ofthedigestauthenticationresponse,encodedinhex*@throwsIllegalArgumentException
ifthesuppliedqopvalueisunsupported.*/publicstaticStringgenerateDigest(booleanpasswordAlreadyEncoded,Stringusername,Stringrealm,Stringpassword,StringhttpMethod,Stringuri,Stringqop,Stringnonce,Stringnc,Stringcnonce)throwsIllegalArgumentException{Stringa1Md5=null;Stringa2=httpMethod+":"+uri;Stringa2Md5=md5Hex(a2);
if(passwordAlreadyEncoded){a1Md5=password;
else{a1Md5=DigestAuthUtils.encodePasswordInA1Format(username,realm,password);
if(qop==null){//asperRFC2069compliantclients(alsoreaffirmedbyRFC2617)digest=a1Md5+":"+nonce+":"+a2Md5;
else
if("auth".equals(qop)){//AsperRFC2617compliantclientsdigest=a1Md5+":"+nonce+":"+nc+":"+cnonce+":"+qop+":"+a2Md5;
else{thrownewIllegalArgumentException("Thismethoddoesnotsupportaqop:'"+qop+"'");
ifnoremovalshouldoccur*@returna<code>Map</code>representingthearraycontents,or<code>null</code>
ifthearray*toprocesswasnullorempty*/publicstaticMap<String,String>splitEachArrayElementAndCreateMap(String[]array,Stringdelimiter,StringremoveCharacters){
if((array==null)||(array.length==0)){returnnull;
if(removeCharacters==null){postRemove=array[i];
else{postRemove=StringUtils.replace(array[i],removeCharacters,"");
if(splitThisArrayElement==null){continue;
ifanargumentwasinvalid*/publicstaticString[]split(StringtoSplit,Stringdelimiter){Assert.hasLength(toSplit,"Cannotsplitanulloremptystring");Assert.hasLength(delimiter,"Cannotuseanulloremptydelimitertosplitastring");
if(delimiter.length()!=1){thrownewIllegalArgumentException("Delimitercanonlybeonecharacterinlength");
if(offset<0){returnnull;
if(s!=null){geoServer.remove(s);
if(serviceFile!=null){serviceFile.delete();
if(logger!=null){logger.log(level,e.getLocalizedMessage());
if(mediaType!=null){translator.start("inspire_common:MediaType");translator.chars(mediaType);translator.end("inspire_common:MediaType");
if(image.getSampleModel().getNumBands()==1&&image.getColorModel()instanceofIndexColorModel){LOGGER.fine("Expandingimagefromindexedtorgb(a)");ImageWorkeriw=newImageWorker(image);iw.forceComponentColorModel();RenderedImageconverted=iw.getRenderedImage();GridCoverage2Dadapted=CoverageFactoryFinder.getGridCoverageFactory(null).create(input.getName(),converted,input.getGridGeometry(),null,newGridCoverage2D[]{input},input.getProperties());returnadapted;
if(isAdmin(auth)){Stopwatchsw=Stopwatch.createStarted();Fragmentf=newFragment("catalogLinks","catalogLinksFragment",this);Catalogcatalog=getCatalog();NumberFormatnumberFormat=NumberFormat.getIntegerInstance(getLocale());numberFormat.setGroupingUsed(true);finalFilterallLayers=acceptAll();finalFilterallStores=acceptAll();finalFilterallWorkspaces=acceptAll();finalintlayerCount=catalog.count(LayerInfo.class,allLayers);finalintstoresCount=catalog.count(StoreInfo.class,allStores);finalintwsCount=catalog.count(WorkspaceInfo.class,allWorkspaces);f.add(newBookmarkablePageLink("layersLink",LayerPage.class).add(newLabel("nlayers",numberFormat.format(layerCount))));f.add(newBookmarkablePageLink("addLayerLink",NewLayerPage.class));f.add(newBookmarkablePageLink("storesLink",StorePage.class).add(newLabel("nstores",numberFormat.format(storesCount))));f.add(newBookmarkablePageLink("addStoreLink",NewDataPage.class));f.add(newBookmarkablePageLink("workspacesLink",WorkspacePage.class).add(newLabel("nworkspaces",numberFormat.format(wsCount))));f.add(newBookmarkablePageLink("addWorkspaceLink",WorkspaceNewPage.class));add(f);sw.stop();
else{LabelplaceHolder=newLabel("catalogLinks");placeHolder.setVisible(false);add(placeHolder);
if(null==extraContent){LabelplaceHolder=newLabel("contentList");placeHolder.setVisible(false);extraContent=placeHolder;
ifthecurrentuserisauthenticatedandistheadministrator*/privatebooleanisAdmin(Authenticationauthentication){returnGeoServerExtensions.bean(GeoServerSecurityManager.class).checkAuthenticationForAdminRole(authentication);}}
ifthisfileexists.**@paramfilePaththepathofthefile,relativetothisservice*@returnwhetherthefileexists*@throwsIOException*/booleancheckFileExists(StringfilePath)throwsIOException;/***Getcurrentandnextversionofaversionedfile**@paramfilePaththeoriginalfilepath*@returntheversionedfileinfo*/FileReferencegetVersioned(StringfilePath);/***Deletethisfile.**@paramfilePaththepathofthefile,relativetothisservice*@returnwhetheranythingwasactuallydeleted.*@throwsIOException*/booleandelete(StringfilePath)throwsIOException;/***Readthisfile.**@paramfilePaththepathofthefile,relativetothisservice*@returninputstreamwithdata*@throwsIOException*/InputStreamread(StringfilePath)throwsIOException;/***ReturnstherootFolder.AllactionsontheservicearerelativetotherootFolder.**@returntherootFolder.*/StringgetRootFolder();/***ReturnstheURIforthepath**@paramfilePaththefilepath*@returntheURI*/URIgetURI(StringfilePath);}
if("wms".equals(rule.getService())&&"GetMap".equals(rule.getMethod()))returnrule;
if(ExecutionStatus.class.isAssignableFrom(type)){returnINSTANCE;
ifthespecifiedresponsecanbehandledbythistransformer(itshouldcheck*therequestedschemaandthefeature'stype)*/publicabstractbooleancanHandleRespose(CSWRecordsResultresponse);protectedabstractclassAbstractRecordTranslatorextendsAbstractCSWTranslator{publicAbstractRecordTranslator(ContentHandlerhandler){super(handler);
if(!"xml".equalsIgnoreCase(prefix)){Stringuri=ns.getURI(prefix);addAttribute(attributes,prefix==""?"xmlns":"xmlns:"+prefix,uri);
if(requestinstanceofGetRecordByIdType){StringlocationAtt="xsi:schemaLocation";StringBuilderlocationDef=newStringBuilder();locationDef.append(CSW.NAMESPACE).append("");locationDef.append(cswSchemaLocation("CSW-discovery.xsd"));addAttribute(attributes,locationAtt,locationDef.toString());start("csw:GetRecordByIdResponse",attributes);encodeRecords(response);end("csw:GetRecordByIdResponse");
else{addAttribute(attributes,"version","2.0.2");StringlocationAtt="xsi:schemaLocation";StringBuilderlocationDef=newStringBuilder();locationDef.append(CSW.NAMESPACE).append("");locationDef.append(cswSchemaLocation("record.xsd"));addAttribute(attributes,locationAtt,locationDef.toString());start("csw:GetRecordsResponse",attributes);attributes=newAttributesImpl();addAttribute(attributes,"timestamp",Converters.convert(response.getTimestamp(),String.class));element("csw:SearchStatus",null,attributes);
if(response.getElementSet()==null){response.setElementSet(ElementSetType.FULL);
if(response.getRecords()!=null){try{response.getRecords().accepts(newFeatureVisitor(){@Overridepublicvoidvisit(Featurefeature){encode(response,feature);